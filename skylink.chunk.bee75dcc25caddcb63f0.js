(window.webpackJsonpVClerkWidget=window.webpackJsonpVClerkWidget||[]).push([[1],{37:function(e,t,n){"use strict";n.d(t,"b",(function(){return Hi})),n.d(t,"a",(function(){return s}));var r={};n.r(r),n.d(r,"ON_INCOMING_STREAM",(function(){return l})),n.d(r,"ON_INCOMING_SCREEN_STREAM",(function(){return S})),n.d(r,"STREAM_ENDED",(function(){return E})),n.d(r,"PEER_UPDATED",(function(){return u})),n.d(r,"PEER_JOINED",(function(){return p})),n.d(r,"PEER_LEFT",(function(){return g})),n.d(r,"PEER_CONNECTION_STATE",(function(){return R})),n.d(r,"DATA_CHANNEL_STATE",(function(){return m})),n.d(r,"ON_INCOMING_MESSAGE",(function(){return I})),n.d(r,"HANDSHAKE_PROGRESS",(function(){return h})),n.d(r,"SERVER_PEER_JOINED",(function(){return T})),n.d(r,"SERVER_PEER_LEFT",(function(){return A})),n.d(r,"CANDIDATE_PROCESSING_STATE",(function(){return O})),n.d(r,"CANDIDATE_GENERATION_STATE",(function(){return f})),n.d(r,"CANDIDATES_GATHERED",(function(){return C})),n.d(r,"DATA_STREAM_STATE",(function(){return _})),n.d(r,"DATA_TRANSFER_STATE",(function(){return D})),n.d(r,"ON_INCOMING_DATA",(function(){return N})),n.d(r,"ON_INCOMING_DATA_REQUEST",(function(){return M})),n.d(r,"ON_INCOMING_DATA_STREAM",(function(){return P})),n.d(r,"ON_INCOMING_DATA_STREAM_STARTED",(function(){return v})),n.d(r,"ON_INCOMING_DATA_STREAM_STOPPED",(function(){return y})),n.d(r,"GET_PEERS_STATE_CHANGE",(function(){return w})),n.d(r,"SESSION_DISCONNECT",(function(){return b})),n.d(r,"STREAM_MUTED",(function(){return k})),n.d(r,"CHANNEL_OPEN",(function(){return L})),n.d(r,"CHANNEL_REOPEN",(function(){return U})),n.d(r,"CHANNEL_CLOSE",(function(){return G})),n.d(r,"CHANNEL_MESSAGE",(function(){return F})),n.d(r,"CHANNEL_ERROR",(function(){return B})),n.d(r,"CHANNEL_RETRY",(function(){return V})),n.d(r,"SOCKET_ERROR",(function(){return x})),n.d(r,"SYSTEM_ACTION",(function(){return H})),n.d(r,"MEDIA_ACCESS_FALLBACK",(function(){return W})),n.d(r,"MEDIA_ACCESS_REQUIRED",(function(){return j})),n.d(r,"MEDIA_ACCESS_STOPPED",(function(){return K})),n.d(r,"MEDIA_ACCESS_SUCCESS",(function(){return $})),n.d(r,"RECORDING_STATE",(function(){return Y})),n.d(r,"LOCAL_MEDIA_MUTED",(function(){return J})),n.d(r,"MEDIA_ACCESS_ERROR",(function(){return X})),n.d(r,"GET_CONNECTION_STATUS_STATE_CHANGE",(function(){return Q})),n.d(r,"READY_STATE_CHANGE",(function(){return q})),n.d(r,"ROOM_LOCK",(function(){return z})),n.d(r,"INTRODUCE_STATE_CHANGE",(function(){return Z})),n.d(r,"ICE_CONNECTION_STATE",(function(){return ee})),n.d(r,"BYE",(function(){return te})),n.d(r,"RTMP_STATE",(function(){return ne})),n.d(r,"LOGGED_ON_CONSOLE",(function(){return re})),n.d(r,"MEDIA_INFO_DELETED",(function(){return se})),n.d(r,"STORED_MESSAGES",(function(){return ie})),n.d(r,"ENCRYPT_SECRETS_UPDATED",(function(){return oe})),n.d(r,"PERSISTENT_MESSAGE_STATE",(function(){return ae}));var s={};n.r(s),n.d(s,"DATA_CHANNEL_STATE",(function(){return ye})),n.d(s,"DATA_CHANNEL_TYPE",(function(){return we})),n.d(s,"DATA_CHANNEL_MESSAGE_ERROR",(function(){return be})),n.d(s,"DATA_TRANSFER_DATA_TYPE",(function(){return ke})),n.d(s,"DT_PROTOCOL_VERSION",(function(){return Le})),n.d(s,"DATA_TRANSFER_TYPE",(function(){return Ue})),n.d(s,"DATA_TRANSFER_SESSION_TYPE",(function(){return Ge})),n.d(s,"DATA_TRANSFER_STATE",(function(){return Fe})),n.d(s,"DATA_STREAM_STATE",(function(){return Be})),n.d(s,"CANDIDATE_GENERATION_STATE",(function(){return Ve})),n.d(s,"CANDIDATE_PROCESSING_STATE",(function(){return xe})),n.d(s,"ICE_CONNECTION_STATE",(function(){return He})),n.d(s,"TURN_TRANSPORT",(function(){return We})),n.d(s,"PEER_CONNECTION_STATE",(function(){return je})),n.d(s,"GET_CONNECTION_STATUS_STATE",(function(){return Ke})),n.d(s,"SERVER_PEER_TYPE",(function(){return $e})),n.d(s,"BUNDLE_POLICY",(function(){return Ye})),n.d(s,"RTCP_MUX_POLICY",(function(){return Je})),n.d(s,"PEER_CERTIFICATE",(function(){return Xe})),n.d(s,"HANDSHAKE_PROGRESS",(function(){return Qe})),n.d(s,"GET_PEERS_STATE",(function(){return qe})),n.d(s,"INTRODUCE_STATE",(function(){return ze})),n.d(s,"SYSTEM_ACTION",(function(){return Ze})),n.d(s,"SYSTEM_ACTION_REASON",(function(){return et})),n.d(s,"READY_STATE_CHANGE",(function(){return tt})),n.d(s,"READY_STATE_CHANGE_ERROR",(function(){return nt})),n.d(s,"REGIONAL_SERVER",(function(){return rt})),n.d(s,"PRIORITY_WEIGHT_SCHEME",(function(){return st})),n.d(s,"LOG_LEVEL",(function(){return it})),n.d(s,"SOCKET_ERROR",(function(){return ot})),n.d(s,"SOCKET_FALLBACK",(function(){return at})),n.d(s,"SM_PROTOCOL_VERSION",(function(){return dt})),n.d(s,"VIDEO_CODEC",(function(){return ct})),n.d(s,"AUDIO_CODEC",(function(){return lt})),n.d(s,"MEDIA_SOURCE",(function(){return St})),n.d(s,"VIDEO_RESOLUTION",(function(){return Et})),n.d(s,"MEDIA_ACCESS_FALLBACK_STATE",(function(){return ut})),n.d(s,"RECORDING_STATE",(function(){return pt})),n.d(s,"CHUNK_FILE_SIZE",(function(){return gt})),n.d(s,"MOZ_CHUNK_FILE_SIZE",(function(){return Rt})),n.d(s,"BINARY_FILE_SIZE",(function(){return mt})),n.d(s,"MOZ_BINARY_FILE_SIZE",(function(){return It})),n.d(s,"CHUNK_DATAURL_SIZE",(function(){return ht})),n.d(s,"DC_PROTOCOL_TYPE",(function(){return Tt})),n.d(s,"SIG_MESSAGE_TYPE",(function(){return At})),n.d(s,"STREAM_STATUS",(function(){return Ot})),n.d(s,"GROUP_MESSAGE_LIST",(function(){return ft})),n.d(s,"VIDEO_QUALITY",(function(){return Ct})),n.d(s,"SDP_SEMANTICS",(function(){return _t})),n.d(s,"RTMP_STATE",(function(){return Dt})),n.d(s,"MEDIA_STATUS",(function(){return Nt})),n.d(s,"TAGS",(function(){return Mt})),n.d(s,"MEDIA_TYPE",(function(){return Pt})),n.d(s,"TRACK_READY_STATE",(function(){return vt})),n.d(s,"TRACK_KIND",(function(){return yt})),n.d(s,"MEDIA_STATE",(function(){return wt})),n.d(s,"MEDIA_INFO",(function(){return bt})),n.d(s,"SDK_VERSION",(function(){return kt})),n.d(s,"SDK_NAME",(function(){return Lt})),n.d(s,"API_VERSION",(function(){return Ut})),n.d(s,"SIGNALING_VERSION",(function(){return Gt})),n.d(s,"BROWSER_AGENT",(function(){return Ft})),n.d(s,"PEER_TYPE",(function(){return Bt})),n.d(s,"SOCKET_EVENTS",(function(){return Vt})),n.d(s,"SOCKET_TYPE",(function(){return xt})),n.d(s,"STATES",(function(){return Ht})),n.d(s,"EVENTS",(function(){return Wt}));var i=n(64),o=n.n(i),a=n(145);a.a.options=a.a.options||{},a.a.onwebrtcreadyDone=!1,a.a.WebRTCPlugin={plugin:null},a.a._onwebrtcreadies=[],a.a.webRTCReady=function(e){if("function"!=typeof e)throw new Error("Callback provided is not a function");var t=function(){"function"==typeof window.require&&"function"==typeof a.a._defineMediaSourcePolyfill&&a.a._defineMediaSourcePolyfill(),e(null!==a.a.WebRTCPlugin.plugin)};!0===a.a.onwebrtcreadyDone?t():a.a._onwebrtcreadies.push(t)},a.a.maybeThroughWebRTCReady=function(){a.a.onwebrtcreadyDone||(a.a.onwebrtcreadyDone=!0,a.a._onwebrtcreadies.length?a.a._onwebrtcreadies.forEach((function(e){"function"==typeof e&&e(null!==a.a.WebRTCPlugin.plugin)})):"function"==typeof a.a.onwebrtcready&&a.a.onwebrtcready(null!==a.a.WebRTCPlugin.plugin))},window.webrtcDetectedBrowser=null,window.webrtcDetectedVersion=null,window.webrtcMinimumVersion=null,window.webrtcDetectedDCSupport=null,a.a.parseWebrtcDetectedBrowser=function(){var e=null;if(window.opr&&opr.addons||window.opera||navigator.userAgent.indexOf(" OPR/")>=0)e=navigator.userAgent.match(/OPR\/(\d+)/i)||[],window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=26,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport="SCTP";else if(navigator.userAgent.match(/Bowser\/[0-9.]*/g)){e=navigator.userAgent.match(/Bowser\/[0-9.]*/g)||[];var t=parseInt((navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[])[2]||"0",10);window.webrtcDetectedBrowser="bowser",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=0,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=t>30?"SCTP":"RTP"}else if(navigator.userAgent.indexOf("OPiOS")>0)e=navigator.userAgent.match(/OPiOS\/([0-9]+)\./),window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("CriOS")>0)e=navigator.userAgent.match(/CriOS\/([0-9]+)\./)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedBrowser="chrome",window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("FxiOS")>0)e=navigator.userAgent.match(/FxiOS\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(document.documentMode)e=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedBrowser="IE",window.webrtcDetectedVersion=parseInt(e[1],10),window.webrtcMinimumVersion=9,window.webrtcDetectedType="plugin",window.webrtcDetectedDCSupport="SCTP",webrtcDetectedVersion||(e=/\bMSIE[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10));else if(window.StyleMedia||navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e=navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)||[],window.webrtcDetectedBrowser="edge",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=13.10547,window.webrtcDetectedType="ms",window.webrtcDetectedDCSupport=null;else if("undefined"!=typeof InstallTrigger||navigator.userAgent.indexOf("irefox")>0)e=navigator.userAgent.match(/Firefox\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=33,window.webrtcDetectedType="moz",window.webrtcDetectedDCSupport="SCTP";else if(window.chrome&&window.chrome.webstore||navigator.userAgent.indexOf("Chrom")>0)e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[],window.webrtcDetectedBrowser="chrome",window.webrtcDetectedVersion=parseInt(e[2]||"0",10),window.webrtcMinimumVersion=38,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=window.webrtcDetectedVersion>30?"SCTP":"RTP";else if(/constructor/i.test(window.HTMLElement)||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString()||navigator.userAgent.match(/AppleWebKit\/(\d+)\./)||navigator.userAgent.match(/Version\/(\d+).(\d+)/)){e=navigator.userAgent.match(/version\/(\d+)\.(\d+)/i)||[];var n=navigator.userAgent.match(/AppleWebKit\/(\d+)/i)||[],r=navigator.userAgent.match(/(iPhone|iPad)/gi),s=n.length>=1&&n[1]>=604;if(window.webrtcDetectedBrowser="safari",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=7,r)window.webrtcDetectedType=s?"AppleWebKit":null;else{var i=window.webrtcDetectedVersion,o=parseInt(e[2]||"0",10),d=11==i&&o<2;window.webrtcDetectedType=!s||a.a.options.forceSafariPlugin&&d?"plugin":"AppleWebKit"}window.webrtcDetectedDCSupport="SCTP"}a.a.webrtcDetectedBrowser=window.webrtcDetectedBrowser,a.a.webrtcDetectedVersion=window.webrtcDetectedVersion,a.a.webrtcMinimumVersion=window.webrtcMinimumVersion,a.a.webrtcDetectedType=window.webrtcDetectedType,a.a.webrtcDetectedDCSupport=window.webrtcDetectedDCSupport},a.a.addExtensions=function(){var e=null,t=null;navigator.mozGetUserMedia?(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}):navigator.webkitGetUserMedia?(e=function(e,t){return a.a.webrtcDetectedVersion>=43?e.srcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):console.error("Error attaching stream to element."),e},t=function(e,t){return a.a.webrtcDetectedVersion>=43?e.srcObject=t.srcObject:e.src=t.src,e}):"AppleWebKit"===a.a.webrtcDetectedType&&(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}),window.attachMediaStream=e,window.reattachMediaStream=t,a.a.attachMediaStream=e,a.a.reattachMediaStream=t},a.a.parseWebrtcDetectedBrowser(),a.a.addExtensions(),a.a.maybeThroughWebRTCReady();var d=a.a;var c=(e,t=null,n)=>{const r=jo.getSkylinkState(n),s={audio:!1,video:!1},{AdapterJS:i}=window,{currentCodecSupport:o,peerInformations:a}=r,{beSilentOnParseLogs:d}=jo.getInitOptions();if(!e||!t||!t.sdp){if(s.video=!(!o.video.h264&&!o.video.vp8),s.audio=!!o.audio.opus,e){const t=((a[e]||{}).agent||{}).name||"";i.webrtcDetectedBrowser===t&&(s.video=Object.keys(o.video).length>0,s.audio=Object.keys(o.audio).length>0)}return s}const c=zi.getSDPCodecsSupport(e,t,d),l=o;for(const e in l.audio)if(l.audio.hasOwnProperty(e)&&l.audio[e]&&c.audio[e]){s.audio=!0;break}for(const e in l.video)if(l.video.hasOwnProperty(e)&&l.video[e]&&c.video[e]){s.video=!0;break}return s};const l="onIncomingStream",S="onIncomingScreenStream",E="streamEnded",u="peerUpdated",p="peerJoined",g="peerLeft",R="peerConnectionState",m="dataChannelState",I="onIncomingMessage",h="handshakeProgress",T="serverPeerJoined",A="serverPeerLeft",O="candidateProcessingState",f="candidateGenerationState",C="candidatesGathered",_="dataStreamState",D="dataTransferState",N="onIncomingData",M="onIncomingDataRequest",P="onIncomingDataStream",v="onIncomingDataStreamStarted",y="onIncomingDataStreamStopped",w="getPeersStateChange",b="sessionDisconnect",k="streamMuted",L="channelOpen",U="channelReopen",G="channelClose",F="channelMessage",B="channelError",V="channelRetry",x="socketError",H="systemAction",W="mediaAccessFallback",j="mediaAccessRequired",K="mediaAccessStopped",$="mediaAccessSuccess",Y="recordingState",J="localMediaMuted",X="mediaAccessError",Q="getConnectionStatusStateChange",q="readyStateChange",z="roomLock",Z="introduceStateChange",ee="iceConnectionState",te="bye",ne="rtmpState",re="loggedOnConsole",se="mediaInfoDeleted",ie="storedMessages",oe="encryptSecretsUpdated",ae="persistentMessageState";var de=class{constructor(e,t){this.name=e,this.detail=t}};const ce=(e={})=>new de(l,{detail:e}),le=(e={})=>new de(S,{detail:e}),Se=(e={})=>new de(E,{detail:e}),Ee=(e={})=>new de(k,{detail:e}),ue=(e={})=>new de(m,{detail:e}),pe=(e={})=>new de(I,{detail:e}),ge=(e={})=>new de(h,{detail:e}),Re=(e={})=>new de(q,{detail:e}),me=e=>new de(O,{detail:e}),Ie=e=>new de(f,{detail:e}),he=e=>new de(ee,{detail:e}),Te=(e={})=>new de(u,{detail:e}),Ae=(e={})=>new de(p,{detail:e}),Oe=(e={})=>new de(g,{detail:e}),fe=(e={})=>new de(A,{detail:e}),Ce=(e={})=>new de(w,{detail:e}),_e=(e={})=>new de(R,{detail:e}),De=(e={})=>new de(Q,{detail:e}),Ne=e=>new de(x,{detail:e}),Me=(e={})=>new de(W,{detail:e}),Pe=(e={})=>new de(ne,{detail:e}),ve=(e={})=>new de(X,{detail:e}),ye={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error",CREATE_ERROR:"createError",BUFFERED_AMOUNT_LOW:"bufferedAmountLow",SEND_MESSAGE_ERROR:"sendMessageError"},we={MESSAGING:"messaging",DATA:"data"},be={MESSAGE:"message",TRANSFER:"transfer"},ke={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob",STRING:"string"},Le="0.1.3",Ue={UPLOAD:"upload",DOWNLOAD:"download"},Ge={BLOB:"blob",DATA_URL:"dataURL"},Fe={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted",USER_REJECTED:"userRejected",USER_UPLOAD_REQUEST:"userRequest",START_ERROR:"startError"},Be={SENDING_STARTED:"sendStart",SENDING_STOPPED:"sendStop",RECEIVING_STARTED:"receiveStart",RECEIVING_STOPPED:"receiveStop",RECEIVED:"received",SENT:"sent",ERROR:"error",START_ERROR:"startError"},Ve={NEW:"new",GATHERING:"gathering",COMPLETED:"complete"},xe={RECEIVED:"received",DROPPED:"dropped",BUFFERED:"buffered",PROCESSING:"processing",PROCESS_SUCCESS:"processSuccess",PROCESS_ERROR:"processError"},He={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",TRICKLE_FAILED:"trickleFailed",DISCONNECTED:"disconnected"},We={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none",ALL:"all"},je={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",CLOSED:"closed"},Ke={RETRIEVING:0,RETRIEVE_SUCCESS:1,RETRIEVE_ERROR:-1},$e={MCU:"mcu"},Ye={MAX_COMPAT:"max-compat",BALANCED:"balanced",MAX_BUNDLE:"max-bundle",NONE:"none"},Je={REQUIRE:"require",NEGOTIATE:"negotiate"},Xe={RSA:"RSA",ECDSA:"ECDSA",AUTO:"AUTO"},Qe={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",ERROR:"error"},qe={ENQUIRED:"enquired",DISPATCHED:"dispatched",RECEIVED:"received"},ze={INTRODUCING:"introducing",ERROR:"error"},Ze={WARNING:"warning",REJECT:"reject",LOCKED:"locked"},et={CREDENTIALS_EXPIRED:"oldTimeStamp",CREDENTIALS_ERROR:"credentialError",DUPLICATED_LOGIN:"duplicatedLogin",ROOM_NOT_STARTED:"notStart",EXPIRED:"expired",ROOM_LOCKED:"locked",FAST_MESSAGE:"fastmsg",ROOM_CLOSING:"toclose",ROOM_CLOSED:"roomclose",SERVER_ERROR:"serverError",KEY_ERROR:"keyFailed"},tt={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},nt={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NO_MEETING_RECORD_FOUND:4010,API_OVER_SEAT_LIMIT:4020,API_RETRIEVAL_FAILED:4021,API_WRONG_ACCESS_DOMAIN:5005,XML_HTTP_REQUEST_ERROR:-1,XML_HTTP_NO_REPONSE_ERROR:-2,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,ADAPTER_NO_LOADED:7,PARSE_CODECS:8},rt={APAC1:"",US1:""},st={ENFORCE_OFFERER:"enforceOfferer",ENFORCE_ANSWERER:"enforceAnswerer",AUTO:"auto"},it={DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0,NONE:-1},ot={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},at={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},dt="2.1.0",ct={AUTO:"auto",VP8:"VP8",H264:"H264",VP9:"VP9"},lt={AUTO:"auto",ISAC:"ISAC",OPUS:"opus",ILBC:"ILBC",G722:"G722",PCMU:"PCMU",PCMA:"PCMA"},St={SCREEN:"screen",WINDOW:"window",TAB:"tab",TAB_AUDIO:"audio",APPLICATION:"application",BROWSER:"browser",CAMERA:"camera"},Et={QQVGA:{width:160,height:120},HQVGA:{width:240,height:160},QVGA:{width:320,height:240},WQVGA:{width:384,height:240},HVGA:{width:480,height:320},VGA:{width:640,height:480},WVGA:{width:768,height:480},FWVGA:{width:854,height:480},SVGA:{width:800,height:600},DVGA:{width:960,height:640},WSVGA:{width:1024,height:576},HD:{width:1280,height:720},HDPLUS:{width:1600,height:900},FHD:{width:1920,height:1080},QHD:{width:2560,height:1440},WQXGAPLUS:{width:3200,height:1800},UHD:{width:3840,height:2160},UHDPLUS:{width:5120,height:2880},FUHD:{width:7680,height:4320},QUHD:{width:15360,height:8640}},ut={FALLBACKING:0,FALLBACKED:1,ERROR:-1},pt={START:0,STOP:1,LINK:2,ERROR:-1},gt=49152,Rt=12288,mt=65456,It=16384,ht=1212,Tt={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},At={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",CANDIDATE:"candidate",BYE:"bye",REDIRECT:"redirect",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",PUBLIC_MESSAGE:"public",PRIVATE_MESSAGE:"private",STREAM:"stream",GROUP:"group",GET_PEERS:"getPeers",PEER_LIST:"peerList",INTRODUCE:"introduce",INTRODUCE_ERROR:"introduceError",APPROACH:"approach",START_RECORDING:"startRecordingRoom",STOP_RECORDING:"stopRecordingRoom",RECORDING:"recordingEvent",END_OF_CANDIDATES:"endOfCandidates",START_SCREENSHARE:"startScreenshare",START_RTMP:"startRTMP",STOP_RTMP:"stopRTMP",RTMP:"rtmpEvent",MEDIA_INFO_EVENT:"mediaInfoEvent",MUTE_VIDEO_EVENT:"muteVideoEvent",MUTE_AUDIO_EVENT:"muteAudioEvent",MESSAGE:"message",GET_STORED_MESSAGES:"getStoredMessages",STORED_MESSAGES:"storedMessages"},Ot={ENDED:"ended",REPLACED_STREAM_ENDED:"replacedStreamEnded",SCREENSHARE_REPLACE_START:"screenshareStart",USER_MEDIA_REPLACE_START:"userMediaReplaceStart"},ft=[At.STREAM,At.UPDATE_USER,At.MUTE_AUDIO_EVENT,At.MUTE_VIDEO_EVENT,At.PUBLIC_MESSAGE],Ct={HD:{video:3200,audio:150},HQ:{video:1200,audio:80},SQ:{video:800,audio:30},LQ:{video:400,audio:20}},_t={PLAN_B:"plan-b",UNIFIED:"unified-plan"},Dt={START:0,STOP:1,ERROR:-1},Nt={MUTED:0,ACTIVE:1,UNAVAILABLE:-1},Mt={SKYLINK_EVENT:"SKYLINK EVENT",SKYLINK_ERROR:"SKYLINK ERROR",STATS_MODULE:"RTCStatsReport",SESSION_DESCRIPTION:"RTCSessionDescription",PEER_CONNECTION:"RTCPeerConnection",CANDIDATE_HANDLER:"RTCIceCandidate",DATA_CHANNEL:"RTCDataChannel",SIG_SERVER:"SIG SERVER",PEER_MEDIA:"PEER MEDIA",PEER_INFORMATION:"PEER INFORMATION",ROOM:"ROOM",RECORDING:"RECORDING",MEDIA_STREAM:"MEDIA STREAM",MESSAGING:"MESSAGING",ASYNC_MESSAGING:"ASYNC MESSAGING",ENCRYPTED_MESSAGING:"ENCRYPTED MESSAGING"},Pt={AUDIO_MIC:"audioMic",VIDEO_CAMERA:"videoCamera",VIDEO_SCREEN:"videoScreen",VIDEO_OTHER:"videoOther",AUDIO:"audio",VIDEO:"video"},vt={LIVE:"live",ENDED:"ended"},yt={AUDIO:"audio",VIDEO:"video"},wt={MUTED:"muted",ACTIVE:"active",STOPPED:"stopped",UNAVAILABLE:"unavailable"},bt={PUBLISHER_ID:"publisherId",MEDIA_ID:"mediaId",MEDIA_TYPE:"mediaType",MEDIA_STATE:"mediaState",TRANSCEIVER_MID:"transceiverMid",MEDIA_META_DATA:"mediaMetaData",SIMULCAST:"simulcast",STREAM_ID:"streamId"},kt="2.0.0",Lt={WEB:"Web SDK",ANDROID:"Android SDK",IOS:"iOS SDK",CPP:"C++ SDK"},Ut="9.0.0",Gt="sig-v2",Ft={CHROME:"chrome",FIREFOX:"firefox",SAFARI:"safari",REACT_NATIVE:"react-native"},Bt={MCU:"MCU"},Vt={CONNECT:"connect",DISCONNECT:"disconnect",RECONNECT_ATTEMPT:"reconnect_attempt",RECONNECT_SUCCESS:"reconnect_success",RECONNECT_FAILED:"reconnect_failed",RECONNECT_ERROR:"reconnect_error",MESSAGE:"message",ERROR:"error"},xt={POLLING:"Polling",WEBSOCKET:"WebSocket",XHR_POLLING:"xhr-polling",JSONP_POLLING:"jsonp-polling"},Ht={SIGNALING:Vt},Wt=r;var jt={INIT:{ERRORS:{NO_ADAPTER:"AdapterJS dependency is not loaded or incorrect AdapterJS dependency is used",NO_SOCKET_IO:"Socket.io not loaded - Please load socket.io",NO_FETCH_SUPPORT:"Fetch API is not supported in your browser. Please make sure you are using a modern browser: https://caniuse.com/#search=fetch",NO_APP_KEY:"Please provide an App Key - Get one at console.temasys.io!",AUTH_CORS:"Promise rejected due to CORS forbidden request - Please visit: http://support.temasys.com.sg/support/solutions/articles/12000006761-i-get-a-403-forbidden-access-is-denied-when-i-load-the-application-why-",AUTH_GENERAL:"Promise rejected due to network issue",SOCKET_CREATE_FAILED:"Failed creating socket connection object ->",SOCKET_ERROR_ABORT:"Reconnection aborted as the connection timed out or there no more available ports, transports and final attempts left"},INFO:{API_SUCCESS:"Promise resolved: APP Authenticated Successfully!"}},JOIN_ROOM:{ERRORS:{CODEC_SUPPORT:"No audio/video codecs available to start connection"}},ROOM:{ERRORS:{STOP:{SCREEN_SHARE:"Error stopping screenshare"},NOT_IN_ROOM:"User is not in room",NO_PEERS:"No peers in room"},LEAVE_ROOM:{ERROR:"Leave room error --\x3e",NO_PEERS:"No peers in room",DROPPING_HANGUP:"Dropping hang-up from remote peer",LEAVE_ALL_ROOMS:{SUCCESS:"Successfully left all rooms",ERROR:"Leave all rooms error --\x3e"},PEER_LEFT:{START:"Initiating peer left process",SUCCESS:"Successfully completed peer left process",ERROR:"Failed peer left process"},SENDING_BYE:"Sending bye message to all peers",DISCONNECT_SOCKET:{SUCCESS:"Successfully disconnected socket"},REMOVE_STATE:{SUCCESS:"Successfully removed room state"}}},ROOM_STATE:{NOT_FOUND:"Could not retrieve room state for room name/key",LEFT:"Peer left room",NO_ROOM_NAME:"No room name specified"},PEER_INFORMATIONS:{NO_PEER_INFO:"Not able to retrieve Peer Information for peerId:",UPDATE_USER_DATA:"Peer updated userData: ",OUTDATED_MSG:"Dropping outdated status ->",USER_DATA_NOT_JSON:"UserData is not JSON"},PEER_CONNECTION:{NO_PEER_CONNECTION:"No Peer Connection detected",ERRORS:{REMOVE_TRACK:"Error removing track from peer connection",REPLACE_TRACK:"Error replacing track in peer connection",REFRESH:"Error refreshing peer connection"},end_of_candidates:"Signaling of end-of-candidates remote ICE gathering",end_of_candidate_failure:"Failed signaling end-of-candidates ->",not_initialised:"Peer connection is not initialised",getstats_api_not_available:"getStats() API is not available",connection_status_no_pc:"There is currently no peer connections to retrieve connection status",ice_connection_state:"Ice connection state changed ->",peer_connection_state:"Peer connection state changed ->",ice_gathering_state:"Ice gathering state changed ->",refresh_start:"START: Refreshing peer connections",refresh_failed:"FAILED: Refreshing peer connections",refresh_completed:"All peer connections refreshed with resolve or errors",refresh_peer_failed:"Peer connection failed to refresh: ",refresh_peer_success:"Peer connection refreshed successfully: ",refresh_no_peer_connection:"There is currently no peer connections to restart",refresh_peerId_no_match:"PeerId does not match existing peer connections",refresh_no_edge_support:"Edge browser currently does not support renegotiation",refresh_not_supported:"Failed restarting with other agents connecting from other SDKs as re-negotiation is not supported by other SDKs",peerId_does_not_exist:"Peer Id does not exist ->"},PEER_PRIVILEGED:{not_privileged:"Please upgrade your key to privileged to use this function",no_appkey:"App key is not defined - Please authenticate again",getPeerListFromServer:"Enquired server for peers within the App space"},ICE_CANDIDATE:{CANDIDATE_HANDLER:{DROPPING_CANDIDATE:"Dropping ICE candidate",INVALID_CANDIDATE:"Received invalid ICE candidate message ->",VALID_CANDIDATE:"Received ICE candidate ->",FILTERED_CANDIDATE:"Dropping received ICE candidate as it matches ICE candidate filtering flag ->",FILTERING_FLAG_NOT_HONOURED:"Not dropping received ICE candidate as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured ->",CANDIDATE_ADDED:"Added ICE candidate successfully",ADDING_CANDIDATE:"Adding ICE Candidate",FAILED_ADDING_CANDIDATE:"Failed adding ICE candidate ->",ADD_BUFFERED_CANDIDATE:"Adding buffered ICE candidate",ADD_CANDIDATE_TO_BUFFER:"Adding ICE candidate to buffer",END_OF_CANDIDATES_SUCCESS:"Signaling of end-of-candidates remote ICE gathering",END_OF_CANDIDATES_FAILURE:"Failed signaling of end-of-candidates remote ICE gathering",ICE_GATHERING_STARTED:"ICE gathering has started",ICE_GATHERING_COMPLETED:"ICE gathering has completed",CANDIDATE_GENERATED:"Generated ICE candidate ->",DROP_EOC:"Dropping of sending ICE candidate end-of-candidates signal or unused ICE candidates ->",ICE_TRICKLE_DISABLED:"Dropping of sending ICE candidate as trickle ICE is disabled ->",SENDING_CANDIDATE:"Sending ICE candidate ->",NO_SDP:"Not sending any session description after ICE gathering completed as it is not present"}},SESSION_DESCRIPTION:{parsing_media_ssrc:"Parsing session description media SSRCs ->"},DATA_CHANNEL:{reviving_dataChannel:"Reviving Datachannel connection",refresh_error:"Not a valid Datachannel connection",CLOSING:"Closing DataChannel",closed:"Datachannel has closed",onclose_error:"Error in data-channel onclose callback",NO_REMOTE_DATA_CHANNEL:"Remote peer does not have data channel",ERRORS:{FAILED_CLOSING:"Failed closing DataChannels --\x3e ",NO_SESSIONS:"Peer Connection does not have DataChannel sessions"}},NEGOTIATION_PROGRESS:{SET_LOCAL_DESCRIPTION:"Successfully set local description --\x3e",SET_REMOTE_DESCRIPTION:"Successfully set remote description --\x3e",APPLYING_BUFFERED_REMOTE_OFFER:"Applying buffered remote offer",ERRORS:{FAILED_SET_LOCAL_DESCRIPTION:"Failed setting local description --\x3e",FAILED_SET_REMOTE_DESCRIPTION:"Failed setting remote description --\x3e",FAILED_SET_REMOTE_ANSWER:"Peer failed to set remote answer.",FAILED_RENEGOTIATION:"Failed renegotiation after answerAck",NOT_STABLE:"Dropping of message as signaling state is not stable",PROCESSING_EXISTING_SDP:"Dropping message as there is another sessionDescription being processed --\x3e",OFFER_TIEBREAKER:"Dropping the received offer: self weight is greater than incoming offer weight --\x3e",NO_LOCAL_BUFFERED_OFFER:"FATAL: No buffered local offer found - Unable to setLocalDescription",ADDING_REMOTE_OFFER_TO_BUFFER:"Adding remote offer received to buffer as current negotiation has not completed"}},SIGNALING:{MESSAGE_ADDED_TO_BUFFER:"Message buffered as enter message has not been sent",ENTER_LISTENER:"Enter listener initialized",BUFFERED_MESSAGES_SENT:"Buffered messages sent",BUFFERED_MESSAGES_DROPPED:"Buffered messages dropped - no mid",OUTDATED_MSG:"Dropping outdated status ->",DROPPING_MUTE_EVENT:"Dropping mute audio / video event message as it is processed by mediaInfoEvent",BUFFER_NOT_NEEDED:"Enter message sent. Messages do not need to be buffered",ABORTING_OFFER:"Aborting offer as current negotiation has not completed"},MESSAGING:{PRIVATE_MESSAGE:"Sending private message to Peer",BROADCAST_MESSAGE:"Broadcasting message to Peers",RECEIVED_MESSAGE:"Received message from Peer",PERSISTENCE:{SEND_MESSAGE:"Sending persisted message",NOT_PERSISTED:"Message will not be persisted as persistent flag is set to false",STORED_MESSAGES:"Received stored messages for room",IS_PERSISTENT_CONFIG:"Persistent message flag is set to",ERRORS:{FAILED_SETTING_PERSISTENCE:"Failed setting persistent message flag",INVALID_TYPE:"Persistent message flag must be of type boolean",PRIVATE_MESSAGE:"Cannot persist private messages",PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED:"Persistent Message feature is not enabled. Enable this feature on the key under 'Advanced Settings' in the Temasys Console"}},ENCRYPTION:{SEND_MESSAGE:"Sending encrypted message",DELETE_ALL:"Deleting all stored secrets",ERRORS:{FAILED_DECRYPTING_MESSAGE:"Failed decrypting message",ENCRYPT_SECRET:"Incorrect secret provided",INVALID_SECRETS:"No or invalid secret and secret id provided",SET_SELECTED_SECRET:"Failed setting selected secret",DELETE_ENCRYPT_SECRETS:"Failed deleting secret",SET_ENCRYPT_SECRET:"Failed setting secret",SECRET_ID_NOT_FOUND:"Secret id not found",NO_SECRET_OR_SECRET_ID:"Secret and / or secret id not provided",INVALID_TYPE:"Secret and secret id must be of type string and not empty",SECRET_ID_NOT_UNIQUE:"Secret id provided is not unique",SECRET_ID_NOT_SELECTED:"Secret id not selected",SECRET_ID_NOT_PROVIDED:"Secret id not provided",SECRETS_NOT_PROVIDED:"Secrets not provided"}},ERRORS:{DROPPING_MESSAGE:"Dropping message",FAILED_SENDING_MESSAGE:"Failed to send user message"}},MEDIA_INFO:{UPDATE_SUCCESS:"Successfully updated media info",ERRORS:{NO_ASSOCIATED_STREAM_ID:"There is no streamId associated with the mediaId and transceiverMid pair",FAILED_PROCESSING_MEDIA_INFO_EVENT:"Failed to process mediaInfoEvent message",FAILED_UPDATING:"Failed to update media info",FAILED_PROCESSING_PEER_MEDIA:"Failed to process media info",FAILED_UPDATING_TRANSCEIVER_MID:"Failed updating media info transceiverMid after setLocalDescription",FAILED_SETTING_PEER_MEDIA_INFO:"Failed setting peer media at offer / answer"},WARN:{READ_ONLY_VALUE:"Attempting to change media info read only value: ",INVALID_MEDIA_TYPE:"Invalid media info media type: "},VIDEO_STATE_CHANGE:"Peers's video state changed to ->",AUDIO_STATE_CHANGE:"Peers's audio state changed to ->",VIDEO_SCREEN_STATE_CHANGE:"Peers's video screen state changed to ->"},MEDIA_STREAM:{STOP_SETTINGS:"Stopped streams with settings:",STOP_SUCCESS:"Successfully stopped and removed stream from state",REMOTE_TRACK_REMOVED:"Remote MediaStreamTrack removed",START_FALLBACK:"Fall back to retrieve audio only stream",NO_OPTIONS:"No user media options provided",DEFAULT_OPTIONS:"Using default options",FALLBACK_SUCCESS:"Successfully retrieved audio fallback stream",START_SCREEN_SUCCESS:"Successfully retrieved screen share stream",STOP_SCREEN_SUCCESS:"Successfully stopped screen share stream",UPDATE_MUTED_SETTINGS:"Updated stream muted setting",UPDATE_MEDIA_STATUS:"Updated stream media status",AUDIO_MUTED:"Peers's audio muted: ",VIDEO_MUTED:"Peers's video muted: ",ERRORS:{STOP_SCREEN:"Error stopping screen share stream",START_SCREEN:"Error starting screen share stream",STOP_ADDED_STREAM:"Error stopping added stream",STOP_REPLACED_STREAM:"Error stopping replaced stream",STOP_USER_MEDIA:"Error stopping user media",STOP_AUDIO_TRACK:"Error stopping audio tracks in stream",STOP_VIDEO_TRACK:"Error stopping video tracks in stream",STOP_MEDIA_TRACK:"Error stopping MediaTrack",STOP_SCREEN_TRACK:"Error stopping screen track in stream",DROPPING_ONREMOVETRACK:"Dropping onremovetrack",NO_STREAM:"No stream to process",INVALID_STREAM_ID:"No stream detected with stream id",NO_USER_MEDIA_STREAMS:"No user media streams detected",INVALID_STREAM_ID_TYPE:"Stream id is not a string",NO_STREAM_ID:"No stream id provided",PEER_SCREEN_ACTIVE:"Peer has existing screen share",REPLACE_SCREEN:"Error replacing user media stream with screenshare stream",FALLBACK:"Error retrieving fallback audio stream",INVALID_GUM_OPTIONS:"Invalid user media options",GET_USER_MEDIA:"Error retrieving stream from 'getUserMedia' method",INVALID_MUTE_OPTIONS:"Invalid muteStreams options provided",NO_STREAMS_MUTED:"No streams to mute",SEND_STREAM:"Error sending stream",INVALID_MEDIA_STREAM_ARRAY:"Array is not of type MediaStream",ACTIVE_STREAMS:"There are currently active streams being sent to remote peers. Please stop streams."}},STATS_MODULE:{NOT_INITIATED:"Stats Module is not initiated",STATS_DISCARDED:"Stats report discarded as peer has left the room",ERRORS:{RETRIEVE_STATS_FAILED:"Failed retrieving stats",POST_FAILED:"Failed posting to stats api",PARSE_FAILED:"Failed parsing stats report",STATS_IS_NULL:"Stats object is null",INVALID_TRACK_KIND:"Media kind is not audio or video"},HANDLE_ICE_GATHERING_STATS:{PROCESS_FAILED:"process_failed",PROCESS_SUCCESS:"process_success",PROCESSING:"processing",DROPPED:"dropped",BUFFERED:"buffered"},HANDLE_NEGOTIATION_STATS:{OFFER:{create:"create_offer",create_error:"error_create_offer",set:"set_offer",set_error:"error_set_offer",offer:"offer",dropped:"dropped_offer"},ANSWER:{create:"create_answer",create_error:"error_create_answer",set:"set_answer",set_error:"error_set_ANSWER",answer:"answer",dropped:"dropped_answer"}},HANDLE_DATA_CHANNEL_STATS:{open:"open",closed:"closed",reconnecting:"reconnecting"},HANDLE_CONNECTION_STATS:{},HANDLE_BANDWIDTH_STATS:{RETRIEVE_FAILED:"Failed posting bandwidth stats: ",NO_STATE:"No room state"},HANDLE_ICE_CONNECTION_STATS:{RETRIEVE_FAILED:"Failed retrieving stats: ",SEND_FAILED:"Failed sending ice connection stats: "},HANDLE_RECORDING_STATS:{START:"start",STOP:"stop",REQUEST_START:"request-start",REQUEST_STOP:"request-stop",ERROR_NO_MCU_START:"error-no-mcu-start",ERROR_NO_MCU_STOP:"error-no-mcu-stop",ERROR_START_ACTIVE:"error-start-when-active",ERROR_STOP_ACTIVE:"error-stop-when-active",ERROR_MIN_STOP:"error-min-stop",MCU_RECORDING_ERROR:"mcu-recording-error"}},RECORDING:{START_SUCCESS:"Started recording",STOP_SUCCESS:"Stopped recording",START_FAILED:"Failed to start recording",STOP_FAILED:"Failed to stop recording",MIN_RECORDING_TIME_REACHED:"4 seconds has been recorded - Recording can be stopped now",ERRORS:{MCU_NOT_CONNECTED:"MCU is not connected",EXISTING_RECORDING_IN_PROGRESS:"There is an existing recording in-progress",NO_RECORDING_IN_PROGRESS:"There is no existing recording in-progress",MIN_RECORDING_TIME:"4 seconds has not been recorded yet",STOP_ABRUPT:"Recording stopped abruptly before 4 seconds",SESSION_EMPTY:'Received request of "off" but the session is empty',MCU_RECORDING_ERROR:"Recording error received from MCU"}},RTMP:{start_no_mcu:"Unable to start RTMP session as MCU is not connected",stop_no_mcu:"Unable to stop RTMP as MCU is not connected",start_no_stream_id:"Unable to start RTMP Session stream id is missing",start_no_endpoint:"Unable to start RTMP Session as Endpoint is missing",starting_rtmp:"Starting RTMP Session",stopping_rtmp:"Stopping RTMP Session",message_received_from_sig:"Received RTMP Session message ->",stop_session_empty:'Received request of "off" but the session is empty',stopped_success:"Stopped RTMP Session",started_success:"Started RTMP Session",error_session_empty:"Received error but the session is empty ->",error_session:"RTMP session failure ->",error_Session_abrupt:"Stopped RTMP session abruptly"},PERSISTENT_MESSAGE:{ERRORS:{NO_DEPENDENCY:"CryptoJS is not available"}},UTILS:{INVALID_BROWSER_AGENT:"Invalid browser agent"},LOGGER:{EVENT_DISPATCHED:"Event dispatched",EVENT_REGISTERED:"Event successfully registered",EVENT_UNREGISTERED:"Event successfully unregistered",EVENT_DISPATCH_ERROR:"Error dispatching event",EVENT_REGISTER_ERROR:"Error registering event",EVENT_UNREGISTER_ERROR:"Error unregistering event",LOGS_NOT_STORED:"Store logs feature is not enabled. Enable it via SkylinkLogger.setLevel(logLevel, storeLogs)",LOGS_CLEARED:"Stored logs cleared",INVALID_CB:"Dropping listener as it is not a function"},BROWSER_AGENT:{REACT_NATIVE:{ERRORS:{DROPPING_ONREMOVETRACK:"Dropping onremovetrack as trackInfo is malformed"}}}};var Kt=(e,t)=>{const n=jo.getSkylinkState(t.room.id),r=e||{};if(n.userData=r.userData||n.userData||"",n.streamsBandwidthSettings={googleX:{},bAS:{}},n.publishOnly=!1,n.sdpSettings={connection:{audio:!0,video:!0,data:!0},direction:{audio:{send:!0,receive:!0},video:{send:!0,receive:!0}}},n.voiceActivityDetection="boolean"!=typeof r.voiceActivityDetection||r.voiceActivityDetection,n.peerConnectionConfig={bundlePolicy:Ye.BALANCED,rtcpMuxPolicy:Je.REQUIRE,iceCandidatePoolSize:0,certificate:Xe.AUTO,disableBundle:!1},n.bandwidthAdjuster=null,r.bandwidth&&("number"==typeof r.bandwidth.audio&&(n.streamsBandwidthSettings.bAS.audio=r.bandwidth.audio),"number"==typeof r.bandwidth.video&&(n.streamsBandwidthSettings.bAS.video=r.bandwidth.video),"number"==typeof r.bandwidth.data&&(n.streamsBandwidthSettings.bAS.data=r.bandwidth.data)),r.googleXBandwidth&&("number"==typeof r.googleXBandwidth.min&&(n.streamsBandwidthSettings.googleX.min=r.googleXBandwidth.min),"number"==typeof r.googleXBandwidth.max&&(n.streamsBandwidthSettings.googleX.max=r.googleXBandwidth.max)),r.sdpSettings&&(r.sdpSettings.direction&&(r.sdpSettings.direction.audio&&(n.sdpSettings.direction.audio.receive="boolean"!=typeof r.sdpSettings.direction.audio.receive||r.sdpSettings.direction.audio.receive,n.sdpSettings.direction.audio.send="boolean"!=typeof r.sdpSettings.direction.audio.send||r.sdpSettings.direction.audio.send),r.sdpSettings.direction.video&&(n.sdpSettings.direction.video.receive="boolean"!=typeof r.sdpSettings.direction.video.receive||r.sdpSettings.direction.video.receive,n.sdpSettings.direction.video.send="boolean"!=typeof r.sdpSettings.direction.video.send||r.sdpSettings.direction.video.send)),r.sdpSettings.connection&&(n.sdpSettings.connection.audio="boolean"!=typeof r.sdpSettings.connection.audio||r.sdpSettings.connection.audio,n.sdpSettings.connection.video="boolean"!=typeof r.sdpSettings.connection.video||r.sdpSettings.connection.video,n.sdpSettings.connection.data="boolean"!=typeof r.sdpSettings.connection.data||r.sdpSettings.connection.data)),r.publishOnly&&(n.sdpSettings.direction.audio.send=!0,n.sdpSettings.direction.audio.receive=!1,n.sdpSettings.direction.video.send=!0,n.sdpSettings.direction.video.receive=!1,n.publishOnly=!0),r.peerConnection&&"object"==typeof r.peerConnection){if("string"==typeof r.peerConnection.bundlePolicy)for(const e in Ye)Ye.hasOwnProperty(e)&&Ye[e]===r.peerConnection.bundlePolicy&&(n.peerConnectionConfig.bundlePolicy=r.peerConnection.bundlePolicy);if("string"==typeof r.peerConnection.rtcpMuxPolicy)for(const e in Je)Je.hasOwnProperty(e)&&Je[e]===r.peerConnection.rtcpMuxPolicy&&(n.peerConnectionConfig.rtcpMuxPolicy=r.peerConnection.rtcpMuxPolicy);if("number"==typeof r.peerConnection.iceCandidatePoolSize&&r.peerConnection.iceCandidatePoolSize>0&&(n.peerConnectionConfig.iceCandidatePoolSize=r.peerConnection.iceCandidatePoolSize),"string"==typeof r.peerConnection.certificate)for(const e in Xe)Xe.hasOwnProperty(e)&&Xe[e]===r.peerConnection.certificate&&(n.peerConnectionConfig.certificate=r.peerConnection.certificate);n.peerConnectionConfig.disableBundle=!0===r.peerConnection.disableBundle}return r.autoBandwidthAdjustment&&(n.bandwidthAdjuster={interval:10,limitAtPercentage:100,useUploadBwOnly:!1},"object"==typeof r.autoBandwidthAdjustment&&("number"==typeof r.autoBandwidthAdjustment.interval&&r.autoBandwidthAdjustment.interval>=10&&(n.bandwidthAdjuster.interval=r.autoBandwidthAdjustment.interval),"number"==typeof r.autoBandwidthAdjustment.limitAtPercentage&&r.autoBandwidthAdjustment.limitAtPercentage>=0&&r.autoBandwidthAdjustment.limitAtPercentage<=100&&(n.bandwidthAdjuster.limitAtPercentage=r.autoBandwidthAdjustment.limitAtPercentage),"boolean"==typeof r.autoBandwidthAdjustment.useUploadBwOnly&&(n.bandwidthAdjuster.useUploadBwOnly=r.autoBandwidthAdjustment.useUploadBwOnly))),n},$t=n(10),Yt=n.n($t);var Jt=(e,t)=>{const n=jo.getSkylinkState(e.id),{peerConnections:r}=n,s=Object.values(r);let i=null;for(let e=0;e<s.length;e+=1){const n=s[e].getTransceivers();for(let e=0;e<n.length;e+=1)if(n[e].sender.track&&n[e].sender.track.id===t.id){i=n[e].mid;break}}return i};var Xt=e=>e.readyState===vt.ENDED?wt.UNAVAILABLE:e.muted?wt.MUTED:wt.ACTIVE;var Qt=(e,t)=>`${e===yt.AUDIO?"AUDIO":"VIDEO"}_${t}`;var qt=(e,t,n,r,s)=>({publisherId:t,mediaId:Xs.retrieveMediaId(n.kind,r),mediaType:s,mediaState:Xs.retrieveMediaState(n),transceiverMid:Xs.retrieveTransceiverMid(e,n),streamId:r,trackId:n.id,mediaMetaData:"",simulcast:""});const zt=(e,t)=>e.id===t.id;var Zt=(e,t)=>{const n=jo.getSkylinkState(e.id),{streams:r}=n,s=Object.values(r.userMedia);let i=null;for(let e=0;e<s.length;e+=1){const n=s[e].stream.getTracks();for(let r=0;r<n.length;r+=1)if(zt(n[r],t)){i=s[e].id;break}}return i};var en=e=>{const t=jo.getSkylinkState(e.id),{streams:n}=t,r=[];return Object.values(n.userMedia).map(e=>e.stream).forEach(e=>{e.getTracks().forEach(e=>{r.push(e)})}),r};var tn=(e,t,n,r,s=!1,i=!1,o=!1)=>{try{((e,t,n,r,s=!1,i=!1,o=!1)=>{const a=jo.getSkylinkState(e.id);!o&&s&&i?(a.peerMedias[t][r][s]=i,Ji.log.INFO([t,Mt.PEER_MEDIA,null,`${jt.MEDIA_INFO.UPDATE_SUCCESS} -- ${r} - ${s}: ${i}`])):!o||s||i||(a.peerMedias[t]=a.peerMedias[t]||{},a.peerMedias[t][r]=o),jo.setSkylinkState(a,e.id)})(e,t,0,r,s,i,o),((e,t,n,r)=>{const s=jo.getSkylinkState(e.id);s.user.sid===t&&n&&Xs.sendMediaInfoMsg(e,s.peerMedias[t][r])})(e,t,n,r)}catch(e){const n=o?JSON.stringify(o):`${r} - ${s}: ${i}`;Ji.log.ERROR([t,Mt.PEER_MEDIA,null,`${jt.MEDIA_INFO.ERRORS.FAILED_UPDATING} -- ${n}`],e)}};const nn={RECONNECTION_ATTEMPTS:{WEBSOCKET:5,POLLING:4},RECONNECTION_DELAY_MAX:5e3,RECONNECTION_DELAY:1e3,RECONNECTION_FINAL_ATTEMPTS:10};const rn={SOCKET:e=>({forceNew:!0,reconnection:!0,timeout:e.socketTimeout,path:e.socketServerPath,reconnectionAttempts:nn.RECONNECTION_ATTEMPTS.WEBSOCKET,reconnectionDelayMax:nn.RECONNECTION_DELAY_MAX,reconnectionDelay:nn.RECONNECTION_DELAY,transports:[xt.WEBSOCKET.toLowerCase()],query:{Skylink_SDK_type:Lt.WEB,Skylink_SDK_version:kt,Skylink_API_version:Ut,"X-Server-Select":Gt},extraHeaders:{Skylink_SDK_type:Lt.WEB,Skylink_SDK_version:kt,Skylink_API_version:Ut,"X-Server-Select":Gt}})},sn=nn;var on=(e,t)=>rn[e](t);var an=e=>{const t=jo.getSkylinkState(e.roomKey),n=jo.getInitOptions(),{config:r}=e,{socketServer:s,socketTimeout:i,socketServerPath:o}=n,{socketPorts:a}=t,d=on("SOCKET",{socketTimeout:i,socketServerPath:o});let c=[];s&&Ri(s)&&Array.isArray(s.ports)&&s.ports.length?({ports:c}=s):c=a[r.signalingServerProtocol],(e=>!e.signalingServerPort)(r)?(r.signalingServerPort=c[0],r.fallbackType=at.NON_FALLBACK):((e,t)=>e.indexOf(t.signalingServerPort)===e.length-1)(c,r)||Ai(n.socketServer)?r.socketType===xt.WEBSOCKET?(r.socketType=xt.POLLING,r.signalingServerPort=c[0]):(r.socketSession.finalAttempts+=1,r.signalingServerPort=c[0]):r.signalingServerPort=c[c.indexOf(r.signalingServerPort)+1],r.socketType===xt.POLLING&&(d.reconnectionDelayMax=sn.RECONNECTION_DELAY_MAX,d.reconnectionAttempts=sn.RECONNECTION_ATTEMPTS.POLLING,d.transports=[xt.XHR_POLLING,xt.JSONP_POLLING,xt.POLLING.toLowerCase()]);const l=(e=>{const{signalingServerProtocol:t,signalingServer:n,signalingServerPort:r,socketServer:s}=e;let i="";return i=Ai(n)?`${t}//${n}`:n&&Ri(n)&&n.protocol?`${n.protocol}//${s.url}:${r}?rand=${Date.now()}`:`${t}//${n}:${r}?rand=${Date.now()}`,i})({signalingServerProtocol:r.signalingServerProtocol,signalingServer:t.socketServer,signalingServerPort:r.signalingServerPort,socketServer:s});return r.socketServer=s,r.socketServerPath=o,t.socketSession=r,jo.setSkylinkState(t,e.roomKey),window.io(l,d)};var dn=(e,t)=>{const{type:n}=t;switch(Ji.log.INFO(["SIG SERVER",null,n,"received"]),n){case At.IN_ROOM:e.inRoomHandler(t);break;case At.ENTER:e.enterRoomHandler(t);break;case At.OFFER:e.offerHandler(t);break;case At.WELCOME:e.welcomeHandler(t);break;case At.ANSWER:e.answerHandler(t);break;case At.ANSWER_ACK:e.answerAckHandler(t);break;case At.CANDIDATE:e.candidateHandler(t);break;case At.PEER_LIST:e.getPeerListHandler(t);break;case At.INTRODUCE_ERROR:e.introduceError(t);break;case At.BYE:e.byeHandler(t);break;case At.STREAM:e.streamHandler(t);break;case At.RECORDING:e.recordingHandler(t);break;case At.REDIRECT:e.redirectHandler(t);break;case At.RTMP:e.rtmpHandler(t);break;case At.UPDATE_USER:e.setUserDataHandler(t);break;case At.MEDIA_INFO_EVENT:e.mediaInfoEventHandler(t);break;case At.MESSAGE:e.userMessageHandler(t,null);break;case At.STORED_MESSAGES:e.storedMessagesHandler(t);break;case At.MUTE_AUDIO_EVENT:e.muteAudioEventHandler(t);break;case At.MUTE_VIDEO_EVENT:e.muteVideoEventHandler(t);break;case At.PUBLIC_MESSAGE:e.userMessageHandler(t,!0);break;case At.PRIVATE_MESSAGE:e.userMessageHandler(t,!1)}};var cn=(e,t)=>{let n=null;if(!e)return null;const r=jo.getSkylinkState(t.id);return r?((e,t)=>{const{user:n}=t;return e===n.sid})(e,r)?fn.getCurrentSessionInfo(t):(n=Yt()(r.peerInformations[e]),n?(n.room=Yt()(t.roomName),n.settings.data=!!(r.dataChannels[e]&&r.dataChannels[e].main&&r.dataChannels[e].main.channel&&r.dataChannels[e].main.channel.readyState===ye.OPEN),n.connected=r.peerConnStatus[e]&&!!r.peerConnStatus[e].connected,n.init=r.peerConnStatus[e]&&!!r.peerConnStatus[e].init,e===Bt.MCU?(n.config.receiveOnly=!0,n.config.publishOnly=!1):r.hasMCU&&(n.config.receiveOnly=!1,n.config.publishOnly=!0),n.settings.audio||n.settings.video||(n.config.receiveOnly=!0,n.config.publishOnly=!1),n):(Ji.log.ERROR(`${jt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`),n)):(jo.logNoRoomState(t.id),n)};var ln=e=>{const t=jo.getSkylinkState(e.id),n=jo.getInitOptions(),{AdapterJS:r}=window,{enableDataChannel:s,codecParams:i}=n,{roomName:o}=e,{streamsMediaStatus:a,userData:d,peerPriorityWeight:c,enableIceRestart:l,publishOnly:S,SMProtocolVersion:E,DTProtocolVersion:u,streams:p,streamsBandwidthSettings:g,sdpSettings:R,user:m}=t,I={userData:d,settings:{audio:!1,video:!1},mediaStatus:{},agent:{name:r.webrtcDetectedBrowser,version:r.webrtcDetectedVersion,os:window.navigator.platform,pluginVersion:r.WebRTCPlugin.plugin?r.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:E,DTProtocolVersion:u,SDKVersion:kt},room:o,config:{enableDataChannel:s,enableIceRestart:l,priorityWeight:c,receiveOnly:!1,publishOnly:S},sid:m.sid,screenshare:!1};if(p&&p.userMedia){const e=Object.keys(p.userMedia);p.userMedia[e[0]]&&(I.settings=Yt()(p.userMedia[e[0]].settings))}return I.mediaStatus=a,I.userData=d||null,I.config.receiveOnly=!I.settings.video&&!I.settings.audio,p.screenshare&&(I.screenshare=!0),I.settings.maxBandwidth=Yt()(g.bAS),I.settings.googleXBandwidth=Yt()(g.googleX),I.settings.bandwidth&&(I.settings.maxBandwidth=Yt()(I.settings.bandwidth),delete I.settings.bandwidth),I.settings.data=s&&R.connection.data,I.settings.audio&&Ri(I.settings.audio)&&(Ti(typeof i.audio.opus.stereo)&&(I.settings.audio.stereo=i.audio.opus.stereo),Ti(i.audio.opus.usedtx)&&(I.settings.audio.usedtx=i.audio.opus.usedtx),Ii(i.audio.opus.maxplaybackrate)&&(I.settings.audio.maxplaybackrate=i.audio.opus.maxplaybackrate),Ti(i.audio.opus.useinbandfec)&&(I.settings.audio.useinbandfec=i.audio.opus.useinbandfec)),I.settings.video&&Ri(I.settings.video)&&(I.settings.video.customSettings={},I.settings.video.frameRate&&Ri(I.settings.video.frameRate)&&(I.settings.video.customSettings.frameRate=Yt()(I.settings.video.frameRate),I.settings.video.frameRate=-1),I.settings.video.facingMode&&Ri(I.settings.video.facingMode)&&(I.settings.video.customSettings.facingMode=Yt()(I.settings.video.facingMode),I.settings.video.facingMode="-1"),I.settings.video.resolution&&Ri(I.settings.video.resolution)&&(I.settings.video.resolution.width&&Ri(I.settings.video.resolution.width)&&(I.settings.video.customSettings.width=Yt()(I.settings.video.width),I.settings.video.resolution.width=-1),I.settings.video.resolution.height&&Ri(I.settings.video.resolution.height)&&(I.settings.video.customSettings.height=Yt()(I.settings.video.height),I.settings.video.resolution.height=-1))),I.settings.audio||I.settings.video||(I.config.receiveOnly=!0,I.config.publishOnly=!1),Yt()(I)};var Sn=e=>{const t=On.getCurrentSessionInfo(e);return delete t.room,t};var En=(e,t)=>{if(t&&e.peerInformations[t]){let n=e.peerInformations[t].userData;return n||(n=""),n}return e.userData};var un=(e,t)=>{const n=jo.getSkylinkState(e.id),{PEER_INFORMATIONS:{UPDATE_USER_DATA:r}}=jt,s=t||"";n.userData=s,jo.setSkylinkState(n,n.room.id),(new Js).setUserData(n),xi(Te({peerId:n.user.sid,peerInfo:On.getCurrentSessionInfo(e),isSelf:!0})),Ji.log.INFO(r,s)};const pn=(e,t)=>{const{streams:n}=e;return!!n.userMedia&&Object.values(n.userMedia).some(e=>e.isReplaced&&e.id===t.id)};const gn=(e,t)=>!(!e||!e[0])&&(e.forEach(e=>{try{e.stop()}catch(n){Ji.log.ERROR([t,Mt.MEDIA_STREAM,null,`${jt.MEDIA_STREAM.ERRORS.STOP_MEDIA_TRACK} - track id: ${e.id}`],n)}}),!0);var Rn=(e,t,n)=>{const{room:r}=e,s=e;let i=-1;if(!s.currentRTCRTPSenders[t])return;const o=s.currentRTCRTPSenders[t];for(let e=0;e<o.length;e+=1)if(n===o[e]){i=e;break}-1!==i?(o.splice(i,1),s.currentRTCRTPSenders[t]=o,jo.setSkylinkState(s,r.id)):Ji.log.WARN([t,null,null,"No matching sender was found for the peer."],n)};var mn={prepStopStreams:(e,t,n=!1,r=!1)=>new Promise((s,i)=>{const o=jo.getSkylinkState(e),{streams:a}=o;o&&a||i(new Error(`${jt.ROOM_STATE.NOT_FOUND} - ${e}`)),(!a||!r&&!a.userMedia||r&&!a.screenshare||r&&a.screenshare&&a.screenshare.id!==t)&&i(new Error(`${jt.MEDIA_STREAM.ERRORS.NO_STREAM} - ${t}`)),r?mn.prepStopScreenStream(o.room,t,n).then(()=>s()).catch(e=>i(e)):mn.prepStopUserMediaStreams(o,t,n).then(()=>s()).catch(e=>i(e))}),prepStopUserMediaStreams:(e,t,n)=>new Promise((r,s)=>{const{user:i}=e,o=(e=>{const{streams:t}=e,n={replacedStreams:[],addedStreams:[]};return Object.keys(t.userMedia).forEach(r=>{pn(e,t.userMedia[r].stream)?n.replacedStreams.push(t.userMedia[r].stream):n.addedStreams.push(t.userMedia[r].stream)}),n})(e);try{if(t){const{stream:r}=e.streams.userMedia[t];pn(e,r)?mn.stopReplacedStream(e,r,n):mn.stopAddedStream(e,r,!1,n)}else mn.stopAddedStreams(e,o.addedStreams,!1,n),mn.stopReplacedStreams(e,o.replacedStreams,!1,n);return mn.initRefreshConnectionAndResolve(e.room,n,r,s)}catch(e){Ji.log.DEBUG([i.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA],e),s(jt.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA)}}),stopAddedStream:(e,t,n=!1,r=!1)=>{const{room:s,user:i}=e;try{mn.tryStopStream(t,i.sid),r||(mn.removeTracks(s,t),mn.updateMediaInfoMediaState(s,t),mn.deleteStreamFromState(s,t,n),mn.listenForEventAndDeleteMediaInfo(s,t),mn.dispatchOnLocalStreamEnded(s,t,n),n&&new co(e).deleteScreensharingInstance(s))}catch(e){Ji.log.ERROR([i.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.ERRORS.STOP_ADDED_STREAM],e)}},tryStopStream:(e,t)=>{if(e){try{gn(e.getAudioTracks())}catch(n){Ji.log.ERROR([t,Mt.MEDIA_STREAM,null,`${jt.MEDIA_STREAM.ERRORS.STOP_AUDIO_TRACK} - stream id: ${e.id}`],n)}try{gn(e.getVideoTracks())}catch(n){Ji.log.ERROR([t,Mt.MEDIA_STREAM,null,`${jt.MEDIA_STREAM.ERRORS.STOP_VIDEO_TRACK} - stream id: ${e.id}`],n)}}},removeTracks:(e,t)=>{const n=jo.getSkylinkState(e.id),{peerConnections:r,user:s}=n,i=t.getTracks();try{i.forEach(e=>{((e,t,n)=>{const r=n.id,s=Object.keys(t);for(let n=0;n<s.length;n+=1)try{const i=s[n],o=t[i];if(o.connectionState===je.CLOSED)break;const a=o.getSenders();let d=null;for(let t=0;t<a.length;t+=1)a[t].track&&a[t].track.id===r&&(d=a[t],o.removeTrack(d),Rn(e,i,d))}catch(e){Ji.log.ERROR([s[n],Mt.PEER_CONNECTION,null,jt.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e)}})(n,r,e)})}catch(e){Ji.log.ERROR([s.sid,Mt.PEER_CONNECTION,null,jt.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e)}},listenForEventAndDeleteMediaInfo:(e,t)=>{const n=jo.getSkylinkState(e.id),r=r=>{const s=t,{user:i}=n,{detail:o}=r;if(o.state===Qe.OFFER){const t=Qs.retrieveMediaId(wi(s)?yt.AUDIO:yt.VIDEO,s.id);Qs.deleteUnavailableMedia(e,i.sid,t)}},s=()=>{Vi(Wt.HANDSHAKE_PROGRESS,r),Vi(Wt.MEDIA_INFO_DELETED,s)};Bi(Wt.HANDSHAKE_PROGRESS,r),Bi(Wt.MEDIA_INFO_DELETED,s)},stopAddedStreams:(e,t,n,r)=>{t.forEach(t=>{mn.stopAddedStream(e,t,n,r)})},updateMediaInfoMediaState:(e,t)=>{const n=jo.getSkylinkState(e.id),{user:r}=n,s=t.id,i=Qs.retrieveMediaId(t.getTracks()[0].kind,s);Qs.setMediaStateToUnavailable(e,r.sid,i)},deleteStreamFromState:(e,t,n=null)=>{const r=jo.getSkylinkState(e.id),{user:s}=r,i=t.id;n?(delete r.streams.screenshare,delete r.streamsMediaStatus[t.id],delete r.streamsMutedSettings[t.id],r.streams.screenshare=null,Ji.log.INFO([s.sid,Mt.MEDIA_STREAM,null,`${jt.MEDIA_STREAM.STOP_SUCCESS} - stream id: ${t.id} (screenshare)`])):(delete r.streams.userMedia[i],delete r.streamsMediaStatus[t.id],delete r.streamsMutedSettings[t.id],ui(r.streams.userMedia)&&(r.streams.userMedia=null),Ji.log.INFO([s.sid,Mt.MEDIA_STREAM,null,`${jt.MEDIA_STREAM.STOP_SUCCESS} - stream id: ${t.id}`])),jo.setSkylinkState(r,r.room.id)},dispatchOnLocalStreamEnded:(e,t,n=!1)=>{const r=jo.getSkylinkState(e.id),{MEDIA_STREAM:s}=jt,{user:i}=r;Ji.log.INFO([i.sid,Mt.MEDIA_STREAM,null,s.STOP_SETTINGS],{peerId:i.sid,isSelf:!0,isScreensharing:n,stream:t}),xi(Se({room:e,peerId:i.sid,peerInfo:fn.getCurrentSessionInfo(e),isSelf:!0,isScreensharing:n,streamId:t.id,isVideo:bi(t),isAudio:wi(t)})),xi(((e={})=>new de(K,{detail:e}))({isScreensharing:n,streamId:t.id})),xi(Te({peerId:i.sid,peerInfo:On.getCurrentSessionInfo(e),isSelf:!0}))},prepStopScreenStream:(e,t,n=!1)=>new Promise((t,r)=>{const s=jo.getSkylinkState(e.id),{user:i,streams:o}=s,a=o.screenshare.stream;try{((e,t)=>{const{streams:n}=e;return!!n.userMedia&&Object.values(n.userMedia).some(e=>e.isReplaced&&e.id===t.id)})(s,a)?mn.stopReplacedStream(s,a,!0,n):mn.stopAddedStream(s,a,!0,n),mn.initRefreshConnectionAndResolve(s.room,n,t,r)}catch(e){Ji.log.DEBUG([i.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.ERRORS.STOP_SCREEN],e),r(new Error(jt.MEDIA_STREAM.ERRORS.STOP_SCREEN))}}),initRefreshConnectionAndResolve:(e,t,n,r)=>{const s=jo.getSkylinkState(e.id),{peerConnections:i}=s;try{if(!t){if(pi(Object.keys(i)))return(e=>{const{room:t,user:n}=e;xi(Te({peerId:n.sid,isSelf:!0,peerInfo:fn.getCurrentSessionInfo(t)}))})(s),Qs.deleteUnavailableMedia(s.room,s.user.sid),n();{const e=e=>{const{detail:t}=e;if(t.state===Qe.ANSWER_ACK)return n()};Bi(Wt.HANDSHAKE_PROGRESS,e),oo.refreshConnection(s)}}}catch(e){r(e)}},stopReplacedStream:(e,t,n,r)=>{const{user:s,room:i}=e;try{mn.tryStopStream(t),r||(((e,t)=>{const{room:n,user:r}=e;(new Js).stream(n.id,r,t,Ot.REPLACED_STREAM_ENDED,null)})(e,t),mn.deleteStreamFromState(i,t,n),mn.dispatchOnLocalStreamEnded(i,t))}catch(e){Ji.log.ERROR([s.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.ERRORS.STOP_REPLACED_STREAM],e)}},stopReplacedStreams:(e,t,n,r)=>{t.forEach(t=>{mn.stopReplacedStream(e,t,n,r)})}};class In{static getUserMedia(e,t={}){const{room:n}=e,r=Ei.parseMediaOptions(t,e),{audio:s,video:i}=t,o=!!t.useExactConstraints;return jo.setSkylinkState(r,n.id),Ei.prepMediaAccessRequest({useExactConstraints:o,audio:s,video:i,roomKey:n.id})}static getUserMediaLayer(e,t=null){return new Promise((n,r)=>{let s={audio:!0,video:!0};t||Ji.log.WARN([e.user.sid,Mt.MEDIA_STREAM,null,`${jt.MEDIA_STREAM.NO_OPTIONS} - ${jt.MEDIA_STREAM.DEFAULT_OPTIONS}`],s),Ri(t)||(Ji.log.ERROR([e.user.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS],t),r(new Error(jt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),null)),s=t,In.getUserMedia(e,s).then(e=>{n(e)}).catch(e=>{r(e)})})}static stopStreams(e,t){return mn.prepStopStreams(e.room.id,t)}static addLocalMediaStreams(e,t){Ei.addLocalMediaStreams(e,t)}static onRemoteTrackAdded(e,t,n,r,s,i){Ei.onRemoteTrackAdded(e,t,n,r,s,i)}static muteStreams(e,t,n){return Ei.muteStreams(e,t,n)}static sendStream(e,t){return Ei.sendStream(e,t)}static getStreamSources(){return Ei.getStreamSources()}static getScreenSources(){return Ei.getScreenSources()}static updateRemoteStreams(e,t,n){return Ei.updateRemoteStreams(e,t,n)}static getStreams(e){return Ei.getStreams(e)}static usePrefetchedStream(e,t,n=null){return new Promise(r=>{!t&&n.id&&n.active&&(t=n);const s={audio:0!==t.getAudioTracks().length,video:0!==t.getVideoTracks().length},i=Ei.parseStreamSettings(s,yt.AUDIO),o=Ei.parseStreamSettings(s,yt.VIDEO);return Ei.onStreamAccessSuccess(e,t,i,o,!1,r)})}}var hn=In;const Tn=e=>!ui(e);const An=(e,t)=>{const{streams:n}=e,r={};r.settings={audio:!1,video:!1,data:!1,bandwidth:Yt()(e.streamsBandwidthSettings.bAS),googleXBandwidth:Yt()(e.streamsBandwidthSettings.googleX)};const s=e.hasMCU?Bt.MCU:t;if(e.peerConnections[s].signalingState!==je.CLOSED){const t=jo.getInitOptions(),i=fn.getPeerInfo(s,e.room);r.settings=Yt()(i.settings),r.settings.data=t.enableDataChannel&&e.peerInformations[s].config.enableDataChannel,n.userMedia||n.screenshare}if(e.peerCustomConfigs[s]){if(Object.hasOwnProperty.call(e.peerCustomConfigs[s],"bandwidth")){const t=e.peerCustomConfigs[s].bandwidth;Ri(t)&&(Ii(t.audio)&&(r.settings.bandwidth.audio=t.audio),Ii(t.video)&&(r.settings.bandwidth.video=t.video),Ii(t.data)&&(r.settings.bandwidth.data=t.data))}if(Object.hasOwnProperty.call(e.peerCustomConfigs[s],"googleXBandwidth")){const t=e.peerCustomConfigs[s].googleXBandwidth;Ri(t)&&(Ii(t.min)&&(r.settings.googleXBandwidth.min=t.min),Ii(t.max)&&(r.settings.googleXBandwidth.max=t.max))}}return r};var On={getPeerInfo:cn,getCurrentSessionInfo:ln,getUserInfo:Sn,getUserData:En,setUserData:un,getPeersStreams:(e,t=!0)=>{const n={},{peerConnections:r,user:s,streams:i,hasMCU:o}=e;if(s&&s.sid&&t){const e=(e=>e.userMedia?e.userMedia:null)(i),t=(e=>e.screenshare?e.screenshare:null)(i);n[s.sid]=e||t?{}:null,e&&Object.keys(e).forEach(t=>{n[s.sid].isSelf=!0,n[s.sid][t]=e[t].stream}),t&&(n[s.sid].isSelf=!0,n[s.sid][t.id]=t)}if(((e,t)=>t?!!e.MCU.maps:!ui(e))(r,o)){const t=o?Object.keys(r.MCU.maps):Object.keys(r);for(let r=0;r<t.length;r+=1){n[t[r]]={},hn.retrieveRemoteStreams(e,t[r]).forEach(e=>{n[t[r]][e.id]=e})}}return ui(n)?null:n},getPeersDataChannels:e=>{const{dataChannels:t}=e,n={},r=Object.keys(t);for(let e=0;e<r.length;e+=1){const i=r[e];if(n[i]={},Tn(t)){const e=Object.keys(t[i]);for(let r=0;r<e.length;r+=1){const o=t[i][e[r]],{channelName:a,channelType:d,transferId:c,streamId:l}=o;let S=null;S=oo.getDataChannelBuffer(o),S.channelProp=e[r],S.channelName=a,S.channelType=d,S.currentTransferId=c,S.currentStreamId=l,S.readyState=o.channel?o.channel.readyState:s.DATA_CHANNEL_STATE.CREATE_ERROR,n[i][a]=S}}}return n},getPeersCustomSettings:e=>{const{peerInformations:t}=e,n={};if((e=>!ui(e))(t)){const r=Object.keys(t);for(let t=0;t<r.length;t+=1)n[r[t]]=An(e,r[t]);return n}return n},setGreatestPeerPriorityWeight:e=>{const t=jo.getSkylinkState(e.room.id),{peerInformations:n}=t,r=Object.entries(n);let s=t.peerPriorityWeight;for(let e=0;e<r.length;e+=1){const n=r[e][1],{config:{priorityWeight:i}}=n;i>s&&(s=i,t.peerPriorityWeight=s+1)}jo.setSkylinkState(t,t.room.id),Ji.log.DEBUG("User's priorityWeight is set to "+s)}};var fn=class{static getPeerInfo(e,t){return On.getPeerInfo(e,t)}static getCurrentSessionInfo(e){return On.getCurrentSessionInfo(e)}static getUserInfo(e){return On.getUserInfo(e)}static getUserData(e,t){return On.getUserData(e,t)}static setUserData(e,t){On.setUserData(e,t)}static getPeersStreams(e,t){return On.getPeersStreams(e,t)}static getPeersDataChannels(e){return On.getPeersDataChannels(e)}static getPeersCustomSettings(e){return On.getPeersCustomSettings(e)}static setGreatestPeerPriorityWeight(e){return On.setGreatestPeerPriorityWeight(e)}};var Cn=(e,t)=>{const n=jo.getSkylinkState(e)||Object.values(jo.getSkylinkState())[0],{socketSession:r,inRoom:s,room:i,user:o}=n;var a;Ji.log.INFO([null,"Socket",null,"Channel closed. Reason - "+t]),n.channelOpen=!1,jo.setSkylinkState(n,e),xi((a={socketSession:Yt()(r)},new de(G,{detail:a}))),s&&o&&o.sid&&xi(((e={})=>new de(b,{detail:e}))({peerId:o.sid,peerInfo:fn.getCurrentSessionInfo(i)}))};const _n={apiBase:"https://api.temasys.io",stats:{endPoints:{client:"/client",session:"/session",auth:"/auth",signaling:"/signaling",iceConnection:"/client/iceconnection",iceCandidate:"/client/icecandidate",iceGathering:"/client/icegathering",negotiation:"/client/negotiation",bandwidth:"/client/bandwidth",recording:"/client/recording",dataChannel:"/client/datachannel"}}};_n.stats.statsBase=_n.apiBase+"/rest/stats";var Dn=_n;var Nn=class{constructor(){this.endpoints=Dn.stats.endPoints,this.stats_buffer={},this.bufferTimeout=!1}postStats(e,t){const{STATS_MODULE:n}=jt,{fetch:r}=window;try{if(!t.client_id)return;const n=jo.getInitOptions(),{enableStatsGathering:s}=n;s&&r(`${Dn.stats.statsBase}${e}`,{method:"POST",mode:"cors",headers:{"Content-type":"application/json"},body:JSON.stringify(t)})}catch(e){Ji.log.WARN(n.ERRORS.POST_FAILED,e)}}addToStatsBuffer(e,t,n){this.stats_buffer[e]||(this.stats_buffer[e]={},this.stats_buffer[e].url=n,this.stats_buffer[e].data=[]);const r=Object.assign({},t);this.stats_buffer[e].data.push(r)}manageStatsBuffer(){this.bufferTimeout||(this.bufferTimeout=!0,setInterval(()=>{const e=Object.keys(this.stats_buffer);for(let t=0;t<e.length;t+=1)this.stats_buffer[e[t]].data.length>0&&(this.postStats(this.stats_buffer[e[t]].url,this.stats_buffer[e[t]].data),this.stats_buffer[e[t]].data=[])},5e3))}};var Mn=class extends Nn{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,state:null,signaling_url:null,signaling_transport:null,attempts:null,error:null}}send(e,t,n){const r=jo.getSkylinkState(e),{socketSession:s}=r;this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.client_id=r.clientId,this.model.state=t,this.model.signaling_url=r.socketSession.socketServer,this.model.signaling_transport=r.socketSession.socketType.toLowerCase(),this.model.attempts=0===s.socketSession.finalAttempts?s.socketSession.attempts:2*s.socketSession.finalAttempts+s.socketSession.attempts,this.model.appKey=jo.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.attempts="number"==typeof n?n:null,this.model.error=("string"==typeof n?n:n&&n.message)||null,this.postStats(this.endpoints.signaling,this.model)}};var Pn={onConnection:(e,t)=>{const n=jo.getSkylinkState(t),{socketSession:r}=n;var s;(new Mn).send(t,Ht.SIGNALING.CONNECT,null),n.channelOpen||(n.channelOpen=!0,jo.setSkylinkState(n,t)),0!==r.socketSession.finalAttempts||0!==r.socketSession.attempts?(xi((s={socketSession:Yt()(r)},new de(U,{detail:s}))),(new Mn).send(t,Ht.SIGNALING.RECONNECT_SUCCESS)):xi((e=>new de(L,{detail:e}))({socketSession:Yt()(r)})),e()},onDisconnect:(e,t)=>{const n=jo.getSkylinkState(e)||Object.values(jo.getSkylinkState())[0],r=n.channelOpen,{room:s}=n;(new Mn).send(s.id,Ht.SIGNALING.DISCONNECT,null),(r||!r&&e!==s.roomName)&&kn(s.id,t)},onError:(e,t)=>{const n=jo.getSkylinkState(e),{socketSession:r}=n;var s;(new Mn).send(e,Ht.SIGNALING.ERROR,t),Ji.log.ERROR([null,"Socket",null,"Exception occurred ->"],t),xi((s={error:t,socketSession:Yt()(r)},new de(B,{detail:s})))},onReconnectAttempt:(e,t)=>{const n=jo.getSkylinkState(e),{socketSession:r}=n;let s=0;var i;(new Js).updateAttempts(e,"attempts",t),s=0===r.socketSession.finalAttempts?t:2*r.socketSession.finalAttempts+r.socketSession.attempts,(new Mn).send(e,Ht.SIGNALING.RECONNECT_ATTEMPT,s),xi((i={fallbackType:r.fallbackType,currentAttempt:s,session:Yt()(jo.getSkylinkState(e).socketSession)},new de(V,{detail:i})))},onReconnectFailed:(e,t,n)=>{const r=jo.getSkylinkState(n),{socketSession:s}=r,i=new Js;s.socketSession.attempts===sn.RECONNECTION_ATTEMPTS.WEBSOCKET&&s.socketSession.finalAttempts<sn.RECONNECTION_FINAL_ATTEMPTS&&!s.socketTimeout?(i.socket.connect(),i.updateAttempts(n,"attempts",s.socketSession.attempts===sn.RECONNECTION_ATTEMPTS.WEBSOCKET?0:s.socketSession.attempts+=1),i.updateAttempts(n,"finalAttempts",s.socketSession.finalAttempts+=1)):((new Mn).send(n,Ht.SIGNALING.RECONNECT_FAILED,jt.INIT.ERRORS.SOCKET_ERROR_ABORT),xi(Ne({session:Yt()(s),errorCode:ot.RECONNECTION_ABORTED,type:s.fallbackType,error:new Error(jt.INIT.ERRORS.SOCKET_ERROR_ABORT)})),t(new Error(jt.INIT.ERRORS.SOCKET_ERROR_ABORT)))},onReconnectError:(e,t)=>{const n=jo.getSkylinkState(e),{socketSession:r}=n;(new Mn).send(e,Ht.SIGNALING.RECONNECT_ERROR,t),!r.socketTimeout&&t&&"timeout"===t&&(Ji.log.ERROR([null,"Socket",null,r.socketType+" connection timed out."]),r.socketTimeout=!0,jo.setSkylinkState(n,e))}};var vn=(e,t,n,r)=>{t.socket.on(Vt.CONNECT,Pn.onConnection.bind(t,n,e)),t.socket.on(Vt.MESSAGE,t.onMessage.bind(t)),t.socket.on(Vt.DISCONNECT,Pn.onDisconnect.bind(t,e)),t.socket.on(Vt.ERROR,Pn.onError.bind(t,e)),t.socket.on(Vt.RECONNECT_ATTEMPT,Pn.onReconnectAttempt.bind(t,e)),t.socket.on(Vt.RECONNECT_ERROR,Pn.onReconnectError.bind(t,e)),t.socket.on(Vt.RECONNECT_FAILED,Pn.onReconnectFailed.bind(t,n,r,e))};const yn=e=>Ti(e)&&e,wn=(e,t)=>{const n=jo.getSkylinkState(e),{detail:r}=t;if(r.state===Qe.ENTER){const e=Yt()(n.socketMessageQueue);n.user.bufferMessage=!1,n.socketMessageQueue=[],jo.setSkylinkState(n,n.room.id),Ji.log.DEBUG([n.user.sid,Mt.SIG_SERVER,null,`${jt.SIGNALING.BUFFERED_MESSAGES_SENT}: ${e.length}`]),((e,t)=>{const n=new Js;for(let r=t.length-1;r>=0;r-=1){const s=t[r];if(!s.mid){if(!e.user.sid)return void Ji.log.DEBUG([e.user.sid,Mt.SIG_SERVER,null,""+jt.SIGNALING.BUFFERED_MESSAGES_DROPPED]);s.mid=e.user.sid}n.sendMessage(s),t.splice(r,1)}})(n,e),Hi.removeEventListener(Wt.HANDSHAKE_PROGRESS,wn)}};var bn=e=>{const{rid:t}=e,n=jo.getSkylinkState(t),{user:r,room:s}=n;return!mi(r.bufferMessage)&&!yn(r.bufferMessage)||(e=>{const{JOIN_ROOM:t,ENTER:n,WELCOME:r,OFFER:s,ANSWER:i,ANSWER_ACK:o,CANDIDATE:a,END_OF_CANDIDATES:d}=At;return[t,n,r,s,i,o,a,d].indexOf(e.type)>-1})(e)?(e.type===Qe.ENTER&&mi(r.bufferMessage)&&(Ji.log.DEBUG([r.sid,Mt.SIG_SERVER,null,jt.SIGNALING.BUFFER_NOT_NEEDED]),n.user.bufferMessage=!1,n.socketMessageQueue=[],jo.setSkylinkState(n,n.room.id)),!1):(Ji.log.DEBUG([r.sid,Mt.SIG_SERVER,null,jt.SIGNALING.MESSAGE_ADDED_TO_BUFFER]),n.socketMessageQueue.unshift(e),yn(r.bufferMessage)||(n.user.bufferMessage=!0,Ji.log.DEBUG([r.sid,Mt.SIG_SERVER,null,jt.SIGNALING.ENTER_LISTENER]),Hi.addEventListener(Wt.HANDSHAKE_PROGRESS,wn.bind(void 0,t))),jo.setSkylinkState(n,s.id),!0)};const kn=(...e)=>{Cn(...e)};var Ln=(e,t,n)=>{const r={encryptSecrets:e,selectedSecretId:t};if(n){if(!r.encryptSecrets[n])throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);r.selectedSecretId===n&&(r.selectedSecretId=$n.setSelectedSecretId()),delete r.encryptSecrets[n]}else Ji.log.DEBUG([null,Mt.ENCRYPTED_MESSAGING,null,""+jt.MESSAGING.ENCRYPTION.DELETE_ALL]),r.selectedSecretId=$n.setSelectedSecretId(),r.encryptSecrets={};return r};var Un=(e,t,n)=>{const r=e;if((e=>{if(!e)throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!$n.utils.isValidString(e))throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return!0})(t)&&((e,t)=>{if(!e)throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!$n.utils.isValidString(e))throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);if($n.utils.isExisting(e,t))throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_UNIQUE);return!0})(n,r))return r[n]=t,r},Gn=n(51),Fn=n.n(Gn);var Bn={isExisting:(e,t)=>Object.keys(t).filter(t=>t===e).length>0,isValidString:e=>{if(!Ai(e)||!Ai(e)||gi(e))throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return!0},hasCrypto:()=>Fn.a?Fn.a:(Ji.log.ERROR([null,Mt.ASYNC_MESSAGING,null,jt.PERSISTENT_MESSAGE.ERRORS.NO_DEPENDENCY]),!1),canEncrypt:(e,t)=>{if(ui(t)&&gi(e))throw new Error(`${jt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED}, ${jt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_PROVIDED}`);if(gi(e))throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_SELECTED);if(ui(t))throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return!0},canDecrypt:e=>{if(ui(e))throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return!0}};var Vn=(e,t)=>{if(!t)return"";if(!$n.utils.isValidString(t))throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);if(!e[t])throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return t};var xn=(e,t)=>{const{peerInformations:n,inRoom:r,user:s}=e;let i,o=!1;if(!r||!s)throw Error(jt.ROOM.ERRORS.NOT_IN_ROOM);return Array.isArray(t)&&!pi(t)?(i=t,o=!0):t&&Ai(t)?(i=[t],o=!0):i=Object.keys(n),i.forEach((e,t)=>{n[e]?e===Bt.MCU&&i.splice(t,1):(Ji.log.WARN([e,Mt.MESSAGING,null,`${jt.MESSAGING.ERRORS.DROPPING_MESSAGE} - ${jt.PEER_CONNECTION.NO_PEER_CONNECTION}`]),i.splice(t,1))}),0===i.length&&Ji.log.WARN([null,Mt.MESSAGING,null,jt.PEER_CONNECTION.NO_PEER_CONNECTION]),{listOfPeers:i,isPrivate:o}};var Hn=(e,t,n,r="",s)=>{(new Js).sendUserMessage(e,t,r||n),Kn.dispatchOnIncomingMessage(e,t,n,!0,s)};var Wn=(e,t,n,r,s)=>{const{room:i,user:o}=e;Ji.log.DEBUG([r?null:s,Mt.MESSAGING,null,`${jt.MESSAGING.RECEIVED_MESSAGE} - isPrivate: ${t.isPrivate}`]);const a={targetPeerId:r?t.isPrivate?s:null:o.sid,content:n,senderPeerId:r?o.sid:s,isDataChannel:!1,isPrivate:t.isPrivate,timeStamp:Gi()};r&&(a.listOfPeers=t.listOfPeers),xi(pe({room:i,message:a,isSelf:r,peerId:r?o.sid:s,peerInfo:r?fn.getCurrentSessionInfo(i):fn.getPeerInfo(s,i)}))};var jn=class{static throwError(e="",t=""){throw Ji.log.ERROR([null,Mt.SKYLINK_ERROR,null,`${e}${t?" - "+t:""}`]),new Error(`${e}${t?" - "+t:""}`)}};var Kn={getMessageConfig:xn,sendMessageToSig:Hn,dispatchOnIncomingMessage:Wn,trySendMessage:(e,t,n)=>{try{const r=Kn.getMessageConfig(e,n);Kn.sendMessageToSig(e,r,t,null,n)}catch(e){jn.throwError(jt.MESSAGING.ERRORS.FAILED_SENDING_MESSAGE)}}};var $n={deleteEncryptSecrets:Ln,setEncryptSecret:Un,setSelectedSecretId:Vn,utils:Bn,getMessageConfig:(e,t,n,r,s)=>{const i=Kn.getMessageConfig(e,t);return $n.utils.hasCrypto()&&$n.utils.canEncrypt(r,n)&&(i.secretId=r),s&&(i.isPersistent=s),i},encryptMessage:(e,t,n=!1)=>{if(n)try{return Fn.a.AES.decrypt(e,t).toString(Fn.a.enc.Utf8)}catch(e){throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET)}return Fn.a.AES.encrypt(e,t).toString()},tryDecryptMessage:(e,t,n)=>{const r=$n.encryptMessage(e,n[t],!0);if(gi(r))throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET);return r}};const Yn={};var Jn=class{constructor(e){const{room:t,user:n}=e;return Yn[t.id]||(Yn[t.id]=this),this.room=t,this.peerId=n.sid,this.encryptSecrets={},this.selectedSecretId="",Yn[t.id]}setEncryptSecret(e,t){try{this.encryptSecrets=$n.setEncryptSecret(this.encryptSecrets,e,t),this.dispatchEncryptSecretEvent()}catch(e){jn.throwError(jt.MESSAGING.ENCRYPTION.ERRORS.SET_ENCRYPT_SECRET,e.message)}}getEncryptSecrets(){return this.encryptSecrets}deleteEncryptSecrets(e){try{const t=$n.deleteEncryptSecrets(this.encryptSecrets,this.selectedSecretId,e);this.encryptSecrets=t.encryptSecrets,this.selectedSecretId=t.selectedSecretId,this.dispatchEncryptSecretEvent()}catch(e){jn.throwError(jt.MESSAGING.ENCRYPTION.ERRORS.DELETE_ENCRYPT_SECRETS,e.message)}}setSelectedSecretId(e){try{this.selectedSecretId=$n.setSelectedSecretId(this.encryptSecrets,e),this.dispatchEncryptSecretEvent()}catch(e){jn.throwError(jt.MESSAGING.ENCRYPTION.ERRORS.SET_SELECTED_SECRET,e.message)}}getSelectedSecretId(){return this.selectedSecretId}dispatchEncryptSecretEvent(){xi(((e={})=>new de(oe,{detail:e}))({room:this.room,encryptSecrets:this.encryptSecrets,selectedSecretId:this.selectedSecretId,peerInfo:Sn(this.room),peerId:this.peerId}))}canEncrypt(e){try{return!!$n.utils.canEncrypt(this.selectedSecretId,this.encryptSecrets)&&($n.utils.isValidString(this.selectedSecretId)&&$n.utils.isValidString(this.encryptSecrets[this.selectedSecretId]))}catch(t){if(e)throw new Error(t.message);return!1}}decryptStoredMessages(e,t){if($n.utils.canEncrypt(t,this.encryptSecrets)&&!Object.keys(this.encryptSecrets).filter(e=>e===t).length)throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return this.decryptMessage(e,t)}decryptMessage(e,t=""){if(t&&$n.utils.canDecrypt(this.encryptSecrets))return $n.tryDecryptMessage(e,t,this.encryptSecrets);throw new Error(jt.MESSAGING.ENCRYPTION.ERRORS.INVALID_SECRETS)}sendMessage(e,t,n,r=!1){const s=_i(e);if(Oi(t,"message","sendMessage")&&s)try{Ji.log.DEBUG([null,Mt.ASYNC_MESSAGING,null,jt.MESSAGING.ENCRYPTION.SEND_MESSAGE]);const e=$n.getMessageConfig(s,n,this.encryptSecrets,this.selectedSecretId,r),i=$n.encryptMessage(t,this.encryptSecrets[this.selectedSecretId]);Kn.sendMessageToSig(s,e,t,i,n)}catch(e){jn.throwError(jt.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message)}}static deleteEncryptedInstance(e){delete Yn[e.id]}};var Xn={getMessageConfig:(e,t)=>{const n=$n.getMessageConfig(e,t);return n.isPersistent=!0,n},parseDecryptedMessageData:(e,t)=>({targetPeerId:t,senderPeerId:e.mid,content:e.data,timeStamp:Ui(e.timeStamp),isPrivate:!1,isDataChannel:!1})};const Qn={};var qn=class{constructor(e){const{user:t,room:n,hasPersistentMessage:r}=e;return Qn[n.id]||(Qn[n.id]=this),this.room=n,this.peerId=t.sid,this.isPersistent=r,this.hasPersistentMessage=r,Qn[n.id]}setMessagePersistence(e){if(!Ti(e))throw jn.throwError(jt.MESSAGING.PERSISTENCE.ERRORS.FAILED_SETTING_PERSISTENCE,jt.MESSAGING.PERSISTENCE.ERRORS.INVALID_TYPE);if(!this.hasPersistentMessage)throw this.isPersistent=e,jn.throwError(jt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);this.isPersistent=e,xi(((e={})=>new de(ae,{detail:e}))({room:this.room,isPersistent:this.isPersistent,peerInfo:Sn(this.room),peerId:this.peerId}))}getMessagePersistence(){return this.isPersistent}sendMessage(e,t,n){const r=_i(e),s=!n||Array.isArray(n)&&pi(n);if(Oi(t,"message","sendMessage")&&r)try{Ji.log.DEBUG([null,Mt.ASYNC_MESSAGING,null,jt.MESSAGING.PERSISTENCE.SEND_MESSAGE]);const i=new Jn(r);if(!s)throw new Error(jt.MESSAGING.PERSISTENCE.ERRORS.PRIVATE_MESSAGE);i.canEncrypt(!0)&&i.sendMessage(e,t,n,this.isPersistent)}catch(e){jn.throwError(jt.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message)}}getStoredMessages(){const e=jo.getSkylinkState(this.room.id);this.hasPersistentMessage?(new Js).getStoredMessages(e):Ji.log.WARN([this.peerId,Mt.ASYNC_MESSAGING,null,""+jt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED])}canPersist(){if(this.hasPersistentMessage)return!!this.isPersistent||(Ji.log.DEBUG([null,Mt.ASYNC_MESSAGING,null,jt.MESSAGING.PERSISTENCE.NOT_PERSISTED]),!1);if(this.isPersistent)throw Ji.log.DEBUG([null,Mt.ASYNC_MESSAGING,null,`${jt.MESSAGING.PERSISTENCE.IS_PERSISTENT_CONFIG} ${this.isPersistent}`]),new Error(jt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);return!1}static processStoredMessages(e){const t=jo.getSkylinkState(e.rid),{room:n}=t,r=e.mid,s=JSON.parse(e.data),i=new Jn(t),o=[];Ji.log.DEBUG([r,Mt.ASYNC_MESSAGING,null,jt.MESSAGING.PERSISTENCE.STORED_MESSAGES],s);try{for(let e=0;e<s.length;e+=1)s[e].data=i.decryptStoredMessages(s[e].data,s[e].secretId),o.push(Xn.parseDecryptedMessageData(s[e],r))}catch(e){throw jn.throwError(jt.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message)}xi(((e={})=>new de(ie,{detail:e}))({room:n,storedMessages:o,isSelf:!1,peerId:r,peerInfo:fn.getPeerInfo(r,n)}))}static deleteAsyncInstance(e){delete Qn[e.id]}};var zn=class{static sendMessage(e,t,n){const r=_i(e);if(Oi(t,"message","sendMessage")&&r){const s=new Jn(r),i=new qn(r);i.canPersist()?i.sendMessage(e,t,n):s.canEncrypt()?s.sendMessage(e,t,n):Kn.trySendMessage(r,t,n)}}static sendP2PMessage(e,t,n){const r=_i(e);Oi(t,"message","sendP2PMessage")&&r&&oo.sendP2PMessage(e,t,n)}static processMessage(e,t){const{mid:n,target:r,rid:s,secretId:i,data:o}=e,a=jo.getSkylinkState(s),d=n;let c=o;if(i)try{c=new Jn(a).decryptMessage(o,i)}catch(e){jn.throwError(jt.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message)}Kn.dispatchOnIncomingMessage(a,{isPrivate:Ti(t)?!t:!!r},c,!1,d)}};var Zn=(e,t)=>{zn.processMessage(e,t)};var er=()=>{const e={fulfilled:!0,message:""},{AdapterJS:t,io:n,fetch:r}=window;return"function"!=typeof(t||window.AdapterJS||window.AdapterJS||{}).webRTCReady?(e.message=jt.INIT.ERRORS.NO_ADAPTER,e.fulfilled=!1,e.readyStateChangeErrorCode=nt.ADAPTER_NO_LOADED):n||window.io?r&&window.fetch||(e.message=jt.INIT.ERRORS.NO_FETCH_SUPPORT,e.fulfilled=!1,e.readyStateChangeErrorCode=nt.NO_XMLHTTPREQUEST_SUPPORT):(e.message=jt.INIT.ERRORS.NO_SOCKET_IO,e.fulfilled=!1,e.readyStateChangeErrorCode=nt.NO_SOCKET_IO),e.fulfilled||Ji.log.ERROR(["Validating Dependencies",null,null,e.message]),e};var tr=e=>{const{forceTURNSSL:t,CONSTANTS:n,serverConfig:r}=e,{AdapterJS:s}=window,i={tcp:r.iceServerPorts.tcp,udp:r.iceServerPorts.udp,both:r.iceServerPorts.both,iceServerProtocol:r.iceServerProtocol,iceServerPorts:r.iceServerPorts};return"edge"===s.webrtcDetectedBrowser?(i.tcp=[],i.udp=[3478],i.iceServerPorts.both=[],i.iceServerProtocol=n.TURN):t?"firefox"===s.webrtcDetectedBrowser&&s.webrtcDetectedVersion<53?(i.udp=[],i.tcp=[443],i.both=[],i.iceServerProtocol=n.TURN):(i.iceServerPorts.udp=[],i.iceServerProtocol="turns"):"firefox"===s.webrtcDetectedBrowser&&(i.udp=[3478],i.tcp=[443,80],i.both=[]),i};var nr=e=>{const{getSenders:t,removeTrack:n}=e;return e=>{const{getTracks:r}=e,s=t();for(let e=0;e<s.length;e+=1){const t=r();for(let r=0;r<t.length;r+=1)t[r]===s[e].track&&n(s[e])}}};const rr={udp:[3478,19302,19303,19304],tcp:[80,443],both:[19305,19306,19307,19308]},sr={STUN:"stun",TURN:"turn",TEMASYS:"temasys",DEFAULT_TURN_SERVER:"turn.temasys.io",TCP:"TCP",UDP:"UDP"},ir=(e,t)=>{const{urls:n}=e;return[{urls:n,username:t.iceServers[1].username||null,credential:t.iceServers[1].credential||null}]};var or=e=>{const t=jo.getInitOptions(),n={iceServerName:null,iceServerPorts:rr,iceServerProtocol:sr.STUN,iceServers:[{urls:[]},{urls:[]}]},{iceServer:r,enableTURNServer:s,forceTURNSSL:i,TURNServerTransport:o,enableSTUNServer:a,usePublicSTUN:d}=t;if(e.forEach(e=>{if(0===e.url.indexOf(sr.STUN+":"))e.url.indexOf(""+sr.TEMASYS)>0?n.iceServerName=(e.url.split(":")[1]||"").split("?")[0]||null:n.iceServers[0].urls.push(e.url);else if(0===e.url.indexOf("turn:")&&e.url.indexOf("@")>0&&e.credential&&!n.iceServers[1].username&&!n.iceServers[1].credential){const t=(e.url.split(":")[1]||"").split("@");n.iceServerName=(t[1]||"").split("?")[0],n.iceServers[1].username=t[0],n.iceServers[1].credential=e.credential,n.iceServerProtocol=sr.TURN}}),r)return{iceServers:ir(r,n)};if(n.iceServerName=n.iceServerName||sr.DEFAULT_TURN_SERVER,n.iceServerProtocol!==sr.TURN||s||i){const e=tr({forceTURNSSL:i,enableTURNServer:s,CONSTANTS:sr,serverConfig:n});n.iceServerPorts.tcp=e.tcp,n.iceServerPorts.udp=e.udp,n.iceServerPorts.both=e.both,n.iceServerProtocol=e.iceServerProtocol}else n.iceServerProtocol=sr.STUN;const c=(e=>{const{TURNServerTransport:t,forceTURNSSL:n,udp:r,tcp:s,both:i}=e,o={udp:[],tcp:[],both:[]};return t!==We.UDP||n?t===We.TCP?(o.tcp=s.concat(i),o.udp=[],o.both=[]):t===We.NONE?(o.tcp=[],o.udp=[]):(o.tcp=s,o.udp=r,o.both=i):(o.udp=r.concat(i),o.tcp=[],o.both=[]),o})({forceTURNSSL:i,TURNServerTransport:o,udp:n.iceServerPorts.udp,tcp:n.iceServerPorts.tcp,both:n.iceServerPorts.both});return n.iceServerPorts.tcp=c.tcp,n.iceServerPorts.udp=c.udp,n.iceServerPorts.both=c.both,n.iceServerProtocol===sr.STUN&&(n.iceServerPorts.tcp=[]),n.iceServerProtocol!==sr.STUN||a?(n.iceServerPorts.tcp.forEach(e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}?transport=tcp`)}),n.iceServerPorts.udp.forEach(e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}?transport=udp`)}),n.iceServerPorts.both.forEach(e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}`)}),d||n.iceServers.splice(0,1),{iceServers:n.iceServers}):(n.iceServers=[],null)};var ar=(e,t)=>{const n=jo.getSkylinkState(t.id),r=n.peerCandidatesQueue[e]||[],i=n.peerConnections[e],{AdapterJS:o}=window,{TAGS:a,PEER_CONNECTION_STATE:d}=s;for(let t=0;t<r.length;t+=1){const s=r[t];if(s){const t=s[1],r=s[0],i=t.candidate.split(" ")[7];Ji.log.DEBUG([e,a.CANDIDATE_HANDLER,`${r}:${i}`,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.ADD_BUFFERED_CANDIDATE]),pr.addIceCandidate(e,r,i,t,n)}else if(i&&i.signalingState!==d.CLOSED&&o&&Di(o.VERSION,"0.14.0"))try{i.addIceCandidate(null),Ji.log.DEBUG([e,a.CANDIDATE_HANDLER,null,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.END_OF_CANDIDATES_SUCCESS])}catch(t){Ji.log.DEBUG([e,a.CANDIDATE_HANDLER,null,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.END_OF_CANDIDATES_FAILURE])}}delete n.peerCandidatesQueue[e],oo.signalingEndOfCandidates(e,n)};var dr=class extends Nn{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:!1,candidate_id:null,candidate_sdp_mid:null,candidate_sdp_mindex:null,candidate_candidate:null,error:null}}send(e,t,n,r,s,i){const o=jo.getSkylinkState(e);this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.peer_id=n,this.model.client_id=o.clientId,this.model.state=t,this.model.is_remote=!!r,this.model.candidate_id=r||null,this.model.candidate_sdp_mid=s.sdpMid,this.model.candidate_sdp_mindex=s.sdpMLineIndex,this.model.candidate_candidate=s.candidate,this.model.appKey=jo.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.error=("string"==typeof i?i:i&&i.message)||null,this.addToStatsBuffer("iceCandidate",this.model,this.endpoints.iceCandidate),this.manageStatsBuffer()}};const cr=new dr,lr=(e,t,n,r,i,o)=>{const{STATS_MODULE:a,ICE_CANDIDATE:d}=jt,{CANDIDATE_PROCESSING_STATE:c,TAGS:l}=s;Ji.log.ERROR([t,l.CANDIDATE_HANDLER,`${n}:${r}`,d.CANDIDATE_HANDLER.FAILED_ADDING_CANDIDATE],o),xi(me({room:e,state:c.PROCESS_ERROR,peerId:t,candidateId:n,candidateType:r,candidate:i,error:o})),cr.send(e.id,a.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,t,n,i,o)};var Sr=(e,t,n,r,i)=>{const o=jo.getSkylinkState(i.room.id),{peerConnections:a,room:d}=o,c=a[e],l={candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex},{STATS_MODULE:S,ICE_CANDIDATE:E,PEER_CONNECTION:u}=jt,{CANDIDATE_PROCESSING_STATE:p,PEER_CONNECTION_STATE:g,TAGS:R}=s;Ji.log.DEBUG([e,R.CANDIDATE_HANDLER,`${t}:${n}`,E.CANDIDATE_HANDLER.ADDING_CANDIDATE]),xi(me({peerId:e,room:d,candidateType:n,candidate:l,candidateId:t,state:p.PROCESSING,error:null})),cr.send(d.id,S.HANDLE_ICE_GATHERING_STATS.PROCESSING,e,t,l),c&&c.signalingState!==g.CLOSED&&c.remoteDescription&&c.remoteDescription.sdp&&c.remoteDescription.sdp.indexOf(`\r\na=mid:${l.sdpMid}\r\n`)>-1||(Ji.log.WARN([e,R.CANDIDATE_HANDLER,`${t}:${n}`,`${E.CANDIDATE_HANDLER.DROPPING_CANDIDATE} - ${u.NO_PEER_CONNECTION}`]),xi(me({peerId:e,room:i.room,candidateType:n,candidate:l,candidateId:t,state:xe.DROPPED,error:new Error(u.NO_PEER_CONNECTION)})),cr.send(d.id,S.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,e,t,l,u.NO_PEER_CONNECTION));try{c.addIceCandidate(l).then(()=>{((e,t,n,r,i)=>{const{STATS_MODULE:o,ICE_CANDIDATE:a}=jt,{CANDIDATE_PROCESSING_STATE:d,TAGS:c}=s;Ji.log.INFO([t,c.CANDIDATE_HANDLER,`${n}:${r}`,a.CANDIDATE_HANDLER.CANDIDATE_ADDED]),xi(me({room:e,state:d.PROCESS_SUCCESS,peerId:t,candidateId:n,candidateType:r,candidate:i,error:null})),cr.send(e.id,o.HANDLE_ICE_GATHERING_STATS.PROCESS_SUCCESS,t,n,i)})(d,e,t,n,l)}).catch(r=>{lr(d,e,t,n,l,r)})}catch(r){lr.bind(c,d,e,t,n,l,r)}};var Er=new class extends Nn{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,bundlePolicy:null,rtcpMuxPolicy:null}}send(e,t,n,r){const s=jo.getSkylinkState(e);this.model.client_id=s.clientId,this.model.appKey=jo.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=n,this.model.state=t,this.model.is_remote=r,this.model.bundlePolicy=s.peerConnectionConfig.bundlePolicy,this.model.rtcpMuxPolicy=s.peerConnectionConfig.rtcpMuxPolicy,this.addToStatsBuffer("iceGathering",this.model,this.endpoints.iceGathering),this.manageStatsBuffer()}};var ur={setIceServers:or,addIceCandidateFromQueue:ar,addIceCandidate:Sr,onIceCandidate:(e,t,n)=>{const r=jo.getSkylinkState(n.id),i=jo.getInitOptions(),o=r.peerConnections[e],a=new Js;let d=r.gatheredCandidates[e];const{CANDIDATE_GENERATION_STATE:c,TAGS:l}=s;if(!o)return Ji.log.WARN([e,l.CANDIDATE_HANDLER,null,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.no_peer_connection],t),null;if(t.candidate){o.gathering||(Ji.log.WARN([e,l.CANDIDATE_HANDLER,null,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.ICE_GATHERING_STARTED],t),o.gathering=!0,o.gathered=!1,xi(Ie({room:n,peerId:e,state:Ve.GATHERING})),Er.send(n.id,c.GATHERING,e,!1));const s=t.candidate.split(" ")[7];if(Ji.log.DEBUG([e,l.CANDIDATE_HANDLER,s,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.CANDIDATE_GENERATED],t),"endOfCandidates"===s||!(o&&o.localDescription&&o.localDescription.sdp&&o.localDescription.sdp.indexOf(`\r\na=mid:${t.sdpMid}\r\n`)>-1))return Ji.log.WARN([e,l.CANDIDATE_HANDLER,s,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.DROP_EOC],t),null;if(i.filterCandidatesType[s]){if(!r.hasMCU||!i.forceTURN)return Ji.log.WARN([e,l.CANDIDATE_HANDLER,s,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.FILTERED_CANDIDATE],t),null;Ji.log.WARN([e,l.CANDIDATE_HANDLER,s,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.FILTERING_FLAG_NOT_HONOURED],t)}d||(d={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),d.sending[s].push({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}),r.gatheredCandidates[e]=d,jo.setSkylinkState(r,n.id),Ji.log.DEBUG([e,l.CANDIDATE_HANDLER,s,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.SENDING_CANDIDATE],t),a.sendCandidate(e,r,t)}else{if(Ji.log.INFO([e,l.CANDIDATE_HANDLER,null,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.ICE_GATHERING_COMPLETED]),o.gathered)return null;if(o.gathering=!1,o.gathered=!0,xi(Ie({peerId:e,state:Ve.COMPLETED,room:n})),Er.send(n.id,c.COMPLETED,e,!1),r.gatheredCandidates[e]){setTimeout(()=>{if(!r.gatheredCandidates[e])return;jo.getSkylinkState(n.id)?a.sendMessage({type:At.END_OF_CANDIDATES,noOfExpectedCandidates:r.gatheredCandidates[e].sending.srflx.length+r.gatheredCandidates[e].sending.host.length+r.gatheredCandidates[e].sending.relay.length,mid:r.user.sid,target:e,rid:n.id}):Ji.log.WARN([e,l.CANDIDATE_HANDLER,null,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.DROP_EOC+" peer has left the room"])},6e3)}}return null},addIceCandidateToQueue:(e,t,n,r,s)=>{const{STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:i}}=jt,o=s,{room:a}=o,d=new dr;Ji.log.DEBUG([e,Mt.CANDIDATE_HANDLER,`${t}:${n}`,jt.ICE_CANDIDATE.CANDIDATE_HANDLER.ADD_CANDIDATE_TO_BUFFER]),d.send(a.id,i.BUFFERED,e,t,r),xi(me({room:a,state:xe.BUFFERED,peerId:e,candidateId:t,candidateType:n,candidate:r.candidate,error:null})),o.peerCandidatesQueue[e]=o.peerCandidatesQueue[e]||[],o.peerCandidatesQueue[e].push([t,r]),jo.setSkylinkState(o,a.id)}};var pr=class{static setIceServers(e){return ur.setIceServers(e)}static addIceCandidateFromQueue(e,t){return ur.addIceCandidateFromQueue(e,t)}static addIceCandidateToQueue(e,t,n,r,s){return ur.addIceCandidateToQueue(e,t,n,r,s)}static addIceCandidate(e,t,n,r,s){return ur.addIceCandidate(e,t,n,r,s)}static onIceCandidate(e,t,n){return ur.onIceCandidate(e,t,n)}};var gr=e=>{const{pc_config:{iceServers:t},sid:n,rid:r,tieBreaker:s}=e,i=jo.getSkylinkState(r),o=jo.getInitOptions(),{priorityWeightScheme:a}=o,d=new Js;let c=0;if(i.room.connection.peerConfig=pr.setIceServers(t),i.room.inRoom=!0,c=a===st.AUTO?0:a===st.ENFORCE_OFFERER?2e15:-2e15,i.peerPriorityWeight=s+c,i.user.sid=n,i.inRoom=!0,Qs.updatePeerMediaWithUserSid(i.room,n),jo.setSkylinkState(i,r),xi(Ae({peerId:i.user.sid,peerInfo:fn.getCurrentSessionInfo(i.room),isSelf:!0,room:i.room})),i.streams.userMedia){Object.keys(i.streams.userMedia).forEach(e=>{const t=i.streams.userMedia[e].stream;xi(ce({stream:t,streamId:t.id,peerId:i.user.sid,room:i.room,isSelf:!0,peerInfo:fn.getCurrentSessionInfo(i.room),isVideo:bi(t),isAudio:wi(t)}))})}d.enterRoom(i)};var Rr={enterAndWelcome:e=>{const t=jo.getSkylinkState(e.rid),n={},{hasMCU:r}=t,{rid:s,mid:i,enableIceRestart:o,enableDataChannel:a,weight:d,receiveOnly:c,publishOnly:l,agent:S,os:E,temasysPluginVersion:u,SMProtocolVersion:p,DTProtocolVersion:g,version:R,parentId:m,publisherId:I}=e;return n.publisherId=I||null,n.rid=s,n.mid=i,n.agent=S&&Ai(S)?S:"other",n.version=(e=>{if(!e||"string"!=typeof e)return 0;if(e.indexOf(".")>-1){const t=e.split(".");if(t.length>2){const e=t[0]||"0";return t.splice(0,1),parseFloat(`${e}.${t.join("0")}`,10)}return parseFloat(e||"0",10)}return parseInt(e||"0",10)})(R),n.SMProtocolVersion=Ai(p)?p:dt,n.DTProtocolVersion=Ai(g)?g:r||i===Bt.MCU?Le:"0.1.0",n.weight=Ii(d)?d:0,n.receiveOnly=c&&!1!==c,n.enableDataChannel=!Ti(a)||a,n.enableIceRestart=!!Ti(o)&&o,n.os=E&&Ai(E)?E:null,n.temasysPluginVersion=u&&Ai(u)?u:null,n.publishOnly=!!l,n.parentId=l&&m&&Ai(m)?m:null,n.userInfo=Rr.parseUserInfo(t,e,n),r&&(n.peersInRoom=e.peersInRoom),Yt()(n)},parseUserInfo:(e,t,n)=>{const r=Object.assign({},t.userInfo);return r.config=r.config?r.config:{enableDataChannel:n.enableDataChannel,enableIceRestart:n.enableIceRestart,priorityWeight:n.weight,receiveOnly:n.receiveOnly,publishOnly:n.publishOnly},r.agent=r.agent?r.agent:{name:n.agent,version:n.version,os:n.os,pluginVersion:n.temasysPluginVersion,SMProtocolVersion:n.SMProtocolVersion,DTProtocolVersion:n.DTProtocolVersion},r.settings=r.settings?r.settings:{},r.mediaStatus=r.mediaStatus?r.mediaStatus:{},r}};const mr=(e,t,n)=>{const{room:r}=e;e.peerInformations[t]=oo.buildPeerInformations(n,e),jo.setSkylinkState(e,r.id)};var Ir=e=>{const{currentRoom:t,targetMid:n,cert:r,userInfo:s,message:i,caller:o}=e;let a=!1;const d=jo.getSkylinkState(t.id),{hasMCU:c}=d,{peerInformations:l}=d;if(!l[n]&&!c||c&&n===Bt.MCU&&!l.MCU){const e=!!s.screenshare;a=!0,d.peerInformations[n]=oo.buildPeerInformations(i.userInfo,d);const o={agent:s.agent.name,version:s.agent.version,os:s.agent.os};jo.setSkylinkState(d,t.id),oo.addPeer({currentRoom:t,targetMid:n,peerBrowser:o,cert:r,receiveOnly:i.receiveOnly,hasScreenshare:e}),n===Bt.MCU?(Ji.log.INFO([n,"RTCPeerConnection",null,"MCU feature has been enabled"]),d.hasMCU=!0,xi(((e={})=>new de(T,{detail:e}))({peerId:n,serverPeerType:$e.MCU,room:t}))):xi(Ae({peerId:n,peerInfo:fn.getPeerInfo(n,t),isSelf:!1,room:t}))}if(d.peerMessagesStamps[n]=d.peerMessagesStamps[n]||{userData:0,audioMuted:0,videoMuted:0},o===Tr.WELCOME&&(d.peerMessagesStamps[n].hasWelcome=!1),o===Tr.WELCOME&&c&&Array.isArray(i.peersInRoom)&&i.peersInRoom.length){const e=d.user.sid;for(let n=0;n<i.peersInRoom.length;n+=1){const r=i.peersInRoom[n].mid;if(r!==e){const e=Rr.enterAndWelcome(i.peersInRoom[n]).userInfo;mr(d,r,e),xi(Ae({peerId:r,peerInfo:fn.getPeerInfo(r,t),isSelf:!1,room:t}))}}}else c&&n!==d.user.sid&&n!==Bt.MCU&&(mr(d,n,s),xi(Ae({peerId:n,peerInfo:fn.getPeerInfo(n,t),isSelf:!1,room:t})));jo.setSkylinkState(d,t.id),a&&xi(ge({peerId:n,state:Qe.WELCOME,error:null,room:t}))};var hr=new class extends Nn{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,weight:null,sdp_type:null,sdp_sdp:null,error:null}}send(e,t,n,r,s,i){const o=jo.getSkylinkState(e);this.model.client_id=o.clientId,this.model.appKey=jo.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.peer_id=n,this.model.state=t,this.model.is_remote=s,this.model.weight=r.weight||null,this.model.error=("string"==typeof i?i:i&&i.msg)||null,this.model.sdp_type=null,this.model.sdp_sdp=null,-1===["enter","welcome"].indexOf(this.model.state)&&(this.model.weight=this.model.is_remote&&fn.getPeerInfo(this.model.peer_id,o.room).config&&fn.getPeerInfo(this.model.peer_id,o.room).config.priorityWeight?fn.getPeerInfo(this.model.peer_id,o.room).config.priorityWeight:fn.getCurrentSessionInfo(o.room).config.priorityWeight,this.model.sdp_type=r&&r.type||null,this.model.sdp_sdp=r&&r.sdp||null),this.addToStatsBuffer("negotiation",this.model,this.endpoints.negotiation),this.manageStatsBuffer()}};const Tr={ENTER:"enterHandler",WELCOME:"welcomeHander"},Ar=e=>{const{currentRoom:t,targetMid:n,message:r}=e,s=jo.getSkylinkState(t.id),{peerConnections:i,hasMCU:o}=s,{STATS_MODULE:a,NEGOTIATION_PROGRESS:d}=jt,c=new Js,l=(e=>{let t="welcome";if(e.caller===Tr.WELCOME){const n=jo.getSkylinkState(e.currentRoom.id),{peerMessagesStamps:r,peerPriorityWeight:s,hasMCU:i}=n;(i||s>e.message.weight)&&(r[e.targetMid].hasWelcome?(t="noop",Ji.log.WARN([e.targetMid,"RTCPeerConnection",null,'Discarding extra "welcome" received.'])):(t="offer",n.peerMessagesStamps[e.targetMid].hasWelcome=!0,jo.setSkylinkState(n,e.currentRoom.id)))}return t})(e);if("offer"===l){if(!i[n])return Ji.log.WARN([n,"RTCSessionDescription","offer",d.ERRORS.no_peer_connection]),hr.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,n,r,!1,d.ERRORS.no_peer_connection),null;const{signalingState:s}=i[n];if(s!==je.STABLE)return Ji.log.WARN([n,"RTCSessionDescription","offer",d.ERRORS.NOT_STABLE],s),hr.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,n,r,!1,d.ERRORS.NOT_STABLE),null;c[l](e.currentRoom,e.targetMid)}else o||c[l](e.currentRoom,e.targetMid)},Or=(e,t)=>{const n=Rr.enterAndWelcome(e),{rid:r,mid:s,userInfo:i,publisherId:o}=n,a=jo.getSkylinkState(r),{hasMCU:d}=a,c=d&&o?o:s,{RTCPeerConnection:l}=window;((e,t,n,r)=>{const{room:s}=n;let i="enter";e===Tr.WELCOME&&(i="welcome"),Ji.log.INFO([t,"RTCPeerConnection",null,`Peer ${i} received ->`],r),hr.send(s.id,i,t,r,!0)})(t,c,a,n);let S="enter";if(t===Tr.WELCOME&&(S="welcome"),c!==Bt.MCU&&d&&a.publishOnly)return void Ji.log.WARN([c,"RTCPeerConnection",null,`Discarding ${S} for publishOnly case -> `],e);const E={currentRoom:a.room,targetMid:c,userInfo:i,message:n,caller:t};if(a.peerConnectionConfig.certificate!==Xe.AUTO&&"function"==typeof l.generateCertificate){let e={};e=a.peerConnectionConfig.certificate===Xe.ECDSA?{name:"ECDSA",namedCurve:"P-256"}:{name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},l.generateCertificate(e).then(e=>{E.cert=e,Ir(E),Ar(E)})}else Ir(E),Ar(E)};var fr=e=>{Or(e,Tr.ENTER)};const Cr=(e,t,n,r)=>{const{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:s}}=jt,{peerConnections:i,bufferedLocalOffer:o,room:a}=e,d=i[t],c="offer"===n.type?"OFFER":"ANSWER";hr.send(a.id,s[c].set,t,n,r),r&&xi(ge({state:Qe[c],peerId:t,room:a})),r?("offer"===n.type?d.setOffer="remote":d.setAnswer="remote",pr.addIceCandidateFromQueue(t,a)):(o[t]=null,"offer"===n.type?d.setOffer="local":d.setAnswer="local"),jo.setSkylinkState(e,a.id)},_r=(e,t,n,r,s)=>{const{room:i,user:o}=e,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:a}}=jt,d="offer"===n.type?"OFFER":"ANSWER";hr.send(i.id,a[d].set_error,t,n,r,s),xi(ge({state:Qe.ERROR,peerId:r?t:o.sid,error:s,room:i}))},Dr=(e,t,n)=>{const r=jo.getSkylinkState(e.id),{peerConnections:s}=r,{type:i}=n,o=s[t],{STATS_MODULE:a}=jt,d="offer"===i?"OFFER":"ANSWER";return o.processingLocalSDP=!0,hr.send(e.id,a.HANDLE_NEGOTIATION_STATS[d][i],t,n,!1),o.setLocalDescription(n).then(()=>o)},Nr=(e,t,n,r)=>{const s=jo.getSkylinkState(t.id),{peerConnections:i}=s,{NEGOTIATION_PROGRESS:o}=jt,a=i[n]=e;Ji.log.DEBUG([n,Mt.SESSION_DESCRIPTION,r.type,o.SET_LOCAL_DESCRIPTION],r),a.processingLocalSDP=!1,Cr(s,n,r,!1)},Mr=(e,t,n,r)=>{const s=jo.getSkylinkState(e.id),{peerConnections:i}=s,o=i[t],{NEGOTIATION_PROGRESS:a}=jt;Ji.log.ERROR([t,Mt.SESSION_DESCRIPTION,n.type,a.FAILED_SET_LOCAL_DESCRIPTION],r),o.processingLocalSDP=!1,o.negotiating=!1,_r(s,t,n,!1,r)},Pr=(e,t,n)=>{const r=jo.getSkylinkState(e.id),{peerConnections:s}=r,{type:i}=n,{STATS_MODULE:o,NEGOTIATION_PROGRESS:a}=jt,d=s[t],c="offer"===i?"OFFER":"ANSWER";d.processingRemoteSDP=!0,hr.send(e.id,o.HANDLE_NEGOTIATION_STATS[c][i],t,n,!0);const l=((e,t,n)=>{const r=t;return r.sdp=Zi.setSDPBitrate(e,r,n),r})(t,n,e.id);return d.setRemoteDescription(l).then(()=>d)},vr=(e,t,n)=>{const r=e;r.peerConnections[t].negotiating=!1,jo.setSkylinkState(r,t),(new Js).answerAck(e,t,n)},yr=(e,t,n,r)=>{const s=new Js,{type:i}=r,{NEGOTIATION_PROGRESS:o,DATA_CHANNEL:a}=jt,d=jo.getSkylinkState(t.id),{peerConnections:c}=d,l=c[n]=e;return Ji.log.DEBUG([n,Mt.SESSION_DESCRIPTION,i,o.SET_REMOTE_DESCRIPTION],r),l.processingRemoteSDP=!1,"offer"===i?(Cr(d,n,r,!0),s.answer(d,n)):(d.peerMessagesStamps[n]&&(d.peerMessagesStamps[n].hasRestart=!1),d.dataChannels[n]&&(-1===l.remoteDescription.sdp.indexOf("m=application")||l.remoteDescription.sdp.indexOf("m=application 0")>0)&&(Ji.log.WARN([n,Mt.PEER_CONNECTION,null,`${a.CLOSING} - ${a.NO_REMOTE_DATA_CHANNEL}`]),oo.closeDataChannel(d,n)),Cr(d,n,r,!0),vr(d,n,!0),!0)},wr=(e,t,n,r)=>{const s=jo.getSkylinkState(e.id),{peerConnections:i}=s,o=i[t],{type:a}=n;Ji.log.ERROR([t,Mt.SESSION_DESCRIPTION,a,jt.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_DESCRIPTION+" ->"],{error:r,state:o.signalingState,[a]:n}),o.processingRemoteSDP=!1,o.negotiating=!1,_r(s,t,n,!0,r),"answer"===a&&vr(s,t,!1)},br=e=>{const{rid:t,mid:n,type:r,sdp:s,mediaInfoList:i}=e,o=jo.getSkylinkState(t),{hasMCU:a,room:d,bufferedLocalOffer:c}=o,l=n,S="offer"===r?"OFFER":"ANSWER",{NEGOTIATION_PROGRESS:E}=jt;if(Ji.log.INFO([l,null,r,`Received ${r} from peer. ${S}:`],e),((e,t)=>{const{weight:n,type:r,mid:s,sdp:i,resend:o}=t,{peerPriorityWeight:a,bufferedLocalOffer:d,room:c,peerConnections:l}=e,S=s,{processingRemoteSDP:E,processingLocalSDP:u,negotiating:p}=l[S],{STATS_MODULE:g,NEGOTIATION_PROGRESS:R,NO_PEER_CONNECTION:m}=jt,I="offer"===r?"OFFER":"ANSWER";let h=null;if(l[S]||(Ji.log.ERROR([S,null,r,`${m.NO_PEER_CONNECTION}. Unable to set${"offer"===r?"Remote":"Local"}Offer.`]),h=m.NO_PEER_CONNECTION),"offer"===r&&l[S].signalingState!==je.STABLE&&(Ji.log.WARN([S,null,r,R.ERRORS.NOT_STABLE],{signalingState:l[S].signalingState,isRestart:!!o}),h=`Peer connection state is ${l[S].signalingState}.`),"offer"===r&&d[S]&&a>n&&(Ji.log.WARN([S,null,r,R.ERRORS.OFFER_TIEBREAKER],{selfWeight:a,messageWeight:n}),h=R.ERRORS.OFFER_TIEBREAKER),E)Ji.log.WARN([S,Mt.SESSION_DESCRIPTION,r,R.ERRORS.PROCESSING_EXISTING_SDP],i),h=R.ERRORS.PROCESSING_EXISTING_SDP;else if(!u&&!E&&p&&"offer"===r){const n=e;Ji.log.DEBUG([S,Mt.SESSION_DESCRIPTION,r,R.ERRORS.ADDING_REMOTE_OFFER_TO_BUFFER],t),n.bufferedRemoteOffers[S]=n.bufferedRemoteOffers[S]?n.bufferedRemoteOffers[S]:[],n.bufferedRemoteOffers[S].push(t),jo.setSkylinkState(n,c.id)}return h&&hr.send(c.id,g.HANDLE_NEGOTIATION_STATS[I].dropped,S,t,!0,h),!h})(o,e))try{if(((e,t)=>{const n=e,{userInfo:r,rid:s,mid:i}=t,o=r,a=i;r&&"object"==typeof r&&(o.settings.data=!!(n.dataChannels[a]&&n.dataChannels[a].main&&n.dataChannels[a].main.channel&&n.dataChannels[a].main.channel.readyState===ye.OPEN),n.peerInformations[a].settings=o.settings||{},n.peerInformations[a].mediaStatus=o.mediaStatus||{},n.peerInformations[a].userData=o.userData),n.peerConnections[a].negotiating=!0,jo.setSkylinkState(n,s)})(o,e),Qs.setPeerMediaInfo(d,l,i),Qs.deleteUnavailableMedia(d,l),"offer"===r){let e=null;const t={type:r,sdp:a?s.replace(/\r\n/g,"\n").split("\n").join("\r\n"):s};Pr(d,l,t).then(e=>yr(e,d,l,t)).catch(e=>wr(d,l,t,e)).then(t=>(e={type:t.type,sdp:t.sdp},Dr(d,l,e))).then(t=>Nr(t,d,l,e)).catch(t=>Mr(d,l,e,t))}else if(c[l]){const e=c[l],t={type:r,sdp:a?s.replace(/\r\n/g,"\n").split("\n").join("\r\n"):s};Dr(d,l,e).then(t=>Nr(t,d,l,e)).catch(t=>Mr(d,l,e,t)).then(()=>Pr(d,l,t)).then(e=>yr(e,d,l,t)).catch(e=>wr(d,l,t,e))}else Ji.log.ERROR([l,Mt.PEER_CONNECTION,null,E.ERRORS.NO_LOCAL_BUFFERED_OFFER])}catch(e){Ji.log.ERROR([l,Mt.SESSION_DESCRIPTION,r,`Failed processing ${S} ->`],e)}return null};var kr=e=>{br(e)};var Lr=e=>{br(e)};var Ur=(e,t)=>{const{peerConnections:n,currentRTCRTPSenders:r}=e;return new Promise(e=>{const s=n[t],i=s.getSenders()?s.getSenders():[],o=[],a=r[t]||[];let d=!1;i.forEach(e=>{o.push(e.getStats())});const c={};Promise.all(o).then(t=>{t.forEach((e,t)=>{e.forEach(e=>{e&&e.ssrc?c[e.ssrc]=i[t]:e&&"ssrc"===e.type&&e.id.indexOf("send")>1&&e.values.forEach(e=>{e.ssrc&&(c[e.ssrc]=i[t])})})});const n=Object.keys(c);if(n.length!==a.length)d=!0;else{let e=0;for(let t=0;t<n.length;t+=1){const r=c[n[t]];for(let t=0;t<a.length;t+=1){if(r===a[t]){e+=1;break}}}d=e!==n.length}e(d)})})};var Gr=(e,t,n,r)=>{const s=jo.getSkylinkState(t.id),{hasMCU:i,peerInformations:o,enableIceRestart:a}=s,d=fn.getPeersCustomSettings(s),c={};return c[e]={iceRestart:!i&&o[e]&&o[e].config&&o[e].config.enableIceRestart&&a&&n,customSettings:d[e]||{}},r&&(c.errors=r),c};const Fr=(e,t,n)=>{const r={};return r.listOfPeers=e,r.refreshErrors=t,r.refreshSettings=n,r},Br=(e,t,n)=>{const r=[];return Object.keys(e).forEach(s=>{r.push(Gr(e[s],t,n))}),r},Vr=(e,t)=>{const n={};return n[e]=t,n};var xr=(e,t,n,r)=>new Promise((s,i)=>{e||i(new Error(jt.ROOM_STATE.NO_ROOM_NAME));const{peerConnections:o,hasMCU:a,room:d}=e,c=jo.getInitOptions(),{mcuUseRenegoRestart:l}=c,{PEER_CONNECTION:S}=jt,E=((e,t,n,r)=>{let s=!1,i={},o=Object.keys(r);return Array.isArray(e)?o=e:Ai(e)?o=[e]:Ti(e)?s=e:e&&Ri(e)&&(i=e),Ti(t)?s=t:t&&Ri(t)&&(i=t),n&&Ri(n)&&(i=n),{listOfPeers:o,doIceRestart:s,bwOptions:i}})(t,n,r,o),{listOfPeers:u,doIceRestart:p,bwOptions:g}=E;try{!pi(u)||a&&!l||(Ji.log.ERROR(S.refresh_no_peer_connection),i({refreshErrors:{self:S.refresh_no_peer_connection},listOfPeers:u})),Ji.log.INFO([null,"PeerConnection",null,S.refresh_start]),oo.refreshPeerConnection(u,e,p,g).then(e=>{const t=a?[e]:e,n=[];for(let e=0;e<t.length;e+=1)if(Array.isArray(t[e])){const r=t[e];n.push(Vr(r[0],r[1])),Ji.log.WARN([u,"PeerConnection",null,S.refresh_peer_failed],r[0])}else"string"==typeof t[e]&&Ji.log.INFO([u,"PeerConnection",null,S.refresh_peer_success],t[e]);n.length===u.length?i(Fr(u,n,Br(u,d,p))):s(Fr(u,n,Br(u,d,p)))}).catch(e=>Ji.log.ERROR([null,"RTCPeerConnection",null,S.refresh_failed],e)).finally(()=>Ji.log.INFO(S.refresh_completed))}catch(e){i(e)}});var Hr=e=>{const{mid:t,rid:n,success:r}=e,s=jo.getSkylinkState(n),i=t;xi(ge({state:Qe.ANSWER_ACK,peerId:i,room:s.room})),s.peerConnections[i].negotiating=!1,jo.setSkylinkState(s,n),r?((e,t)=>{if(e.bufferedRemoteOffers[t]&&!pi(e.bufferedRemoteOffers[t])){const n=e.bufferedRemoteOffers[t].shift();return Ji.log.DEBUG([t,"RTCSessionDescription",n.type,jt.NEGOTIATION_PROGRESS.APPLYING_BUFFERED_REMOTE_OFFER],n),br(n),jo.setSkylinkState(e,e.room.id),!0}return!1})(s,i)||Ur(s,i).then(e=>{e&&xr(s,i).catch(e=>{Ji.log.ERROR([t,Mt.SESSION_DESCRIPTION,Qe.ANSWER_ACK,jt.NEGOTIATION_PROGRESS.ERRORS.FAILED_RENEGOTIATION],e)})}):Ji.log.ERROR([i,Mt.SESSION_DESCRIPTION,Qe.ANSWER,jt.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_ANSWER])};var Wr=e=>{Or(e,Tr.WELCOME)};var jr=e=>{const{candidate:t,mid:n,rid:r}=e,s=jo.getSkylinkState(r),{room:i}=s,o=jo.getInitOptions(),a=s.peerConnections[n],d=s.peerEndOfCandidatesCounter[n]||{},{RTCIceCandidate:c}=window,{ICE_CANDIDATE:{CANDIDATE_HANDLER:l},PEER_CONNECTION:S,STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:E}}=jt,u=new dr;if(!t&&!e.id)return Ji.log.WARN([n,l.tag,null,l.INVALID_CANDIDATE],e),null;const p=new c({sdpMLineIndex:e.label,candidate:t,sdpMid:e.id}),g="can-"+p.foundation,R=p.candidate.split(" ")[7]||"";Ji.log.DEBUG([n,l.tag,`${g}:${R}`,l.VALID_CANDIDATE],p),d.len=d.len||0,d.hasSet=!1,d.len+=1,jo.setSkylinkState(s,r);const m={candidate:{candidate:p.candidate,sdpMid:p.sdpMid,sdpMLineIndex:p.sdpMLineIndex},error:null};if(xi(me({room:i,state:xe.RECEIVED,peerId:n,candidateId:g,candidateType:R,candidate:m.candidate,error:m.error})),!a||a.signalingState===je.CLOSED)return Ji.log.WARN([n,l.tag,`${g}:${R}`,S.NO_PEER_CONNECTION]),m.error=new Error(S.NO_PEER_CONNECTION),u.send(i.id,E.PROCESS_FAILED,n,g,m.candidate,m.error),xi(me({room:i,state:xe.DROPPED,peerId:n,candidateId:g,candidateType:R,candidate:m.candidate,error:m.error})),oo.signalingEndOfCandidates(n,s),null;if(o.filterCandidatesType[R]){if(!s.hasMCU||!o.forceTURN)return Ji.log.WARN([n,l.tag,`${g}:${R}`,l.FILTERED_CANDIDATE],p),m.error=new Error(l.FILTERED_CANDIDATE),u.send(i.id,E.DROPPED,n,g,m.candidate,m.error),xi(me({room:i,state:xe.DROPPED,peerId:n,candidateId:g,candidateType:R,candidate:m.candidate,error:m.error})),oo.signalingEndOfCandidates(n,s),null;Ji.log.WARN([n,l.tag,`${g}:${R}`,l.FILTERING_FLAG_NOT_HONOURED],p)}a.remoteDescription&&a.remoteDescription.sdp&&a.localDescription&&a.localDescription.sdp?pr.addIceCandidate(n,g,R,p,s):pr.addIceCandidateToQueue(n,g,R,p,s),oo.signalingEndOfCandidates(n,s);let I=s.gatheredCandidates[n];return I||(I={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),I.receiving[R].push({sdpMid:p.sdpMid,sdpMLineIndex:p.sdpMLineIndex,candidate:p.candidate}),s.gatheredCandidates[n]=I,jo.setSkylinkState(s,r),null};var Kr=e=>{const{result:t,type:n}=e,r=t;Ji.log.INFO(["Server",null,n,"Received list of peers"],r),xi(Ce({state:qe.DISPATCHED,privilegePeerId:null,peerList:r}))};var $r=class extends Nn{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,state:null,contents:null}}send(e,t){const n=jo.getSkylinkState(e);this.model.room_id=e,this.model.user_id=n&&n.user&&n.user.sid||null,this.model.client_id=n.clientId,this.model.state=t.type,this.model.contents=t,this.model.appKey=jo.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.session,this.model)}};var Yr=e=>{const t=jo.getSkylinkState(),{room:n,user:r}=t;Ji.log.WARN(["Server",null,e.type,"Introduce failed. Reason: "+e.reason]),(new $r).send(n.id,e),xi(((e={})=>new de(Z,{detail:e}))({state:Z.ERROR,privilegedPeerId:r.sid,receivingPeerId:e.receivingPeerId,sendingPeerId:e.sendingPeerId,reason:e.reason}))};var Jr=class extends Nn{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,local_candidate:{},remote_candidate:{}}}send(e,t,n){try{const r=jo.getSkylinkState(e);if(!r)return;this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.peer_id=n,this.model.client_id=r.clientId,this.model.state=t,this.model.appKey=jo.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),oo.retrieveStatistics(e,n,jo.getInitOptions().beSilentOnStatsLogs).then(e=>{e&&["local","remote"].forEach(t=>{const n=e.selectedCandidatePair[t];if(n){const e=this.model[t+"_candidate"];e.ip_address=n.ipAddress||null,e.port_number=n.portNumber||null,e.candidate_type=n.candidateType||null,e.protocol=n.transport||null,e.priority=n.priority||null,"local"===t&&(this.model.local_candidate.network_type=n.networkType||null)}}),this.postStats(this.endpoints.iceConnection,this.model)}).catch(e=>{Ji.log.DEBUG(jt.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.RETRIEVE_FAILED,e)})}catch(e){Ji.log.DEBUG(jt.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.SEND_FAILED,e)}}};const Xr=(e,t)=>{const n=jo.getSkylinkState(e);n.peerConnections[t].signalingState!==je.CLOSED&&(n.peerConnections[t].close(),ki(Ft.SAFARI)&&Li(11)&&(((e,t)=>{const n=e;n.peerConnections[t].signalingStateClosed||(n.peerConnections[t].signalingStateClosed=!0,xi(_e({peerId:t,state:je.CLOSED})))})(n,t),((e,t)=>{const n=e;n.peerConnections[t].iceConnectionStateClosed||(n.peerConnections[t].iceConnectionStateClosed=!0,(new Jr).send(n.room.id,t,e),xi(he({peerId:t,state:He.CLOSED})))})(n,t)))},Qr=(e,t)=>{const n=jo.getSkylinkState(e);if(!((e,t)=>{const n=e;return!!n&&(!(!n.peerConnections[t]&&!n.peerInformations[t])||(Ji.log.DEBUG([t,Mt.PEER_CONNECTION,null,`${jt.ROOM.LEAVE_ROOM.DROPPING_HANGUP} - ${jt.PEER_CONNECTION.NO_PEER_CONNECTION}`]),!1))})(n,t))return;const{room:r}=n,s=fn.getPeerInfo(t,r);if(t===Bt.MCU){const e=n;return xi(fe({peerId:t,serverPeerType:$e.MCU,room:r})),e.hasMCU=!1,void jo.setSkylinkState(e,r.id)}xi(Oe({peerId:t,peerInfo:s,isSelf:!1,room:r}))};var qr=e=>{const{mid:t,rid:n,publisherId:r}=e,s=n;let i=t;jo.getSkylinkState(s).hasMCU&&(i=r),Ji.log.INFO([i,Mt.PEER_CONNECTION,null,jt.ROOM.LEAVE_ROOM.PEER_LEFT.START]);try{Qr(s,i),((e,t)=>{jo.getSkylinkState(e).peerConnections[t]&&Xr(e,t)})(s,i),((e,t)=>{const n=jo.getSkylinkState(e);setTimeout(()=>{delete n.peerConnections[t],jo.setSkylinkState(n,n.room.id),Ji.log.INFO([t,Mt.PEER_CONNECTION,null,jt.ROOM.LEAVE_ROOM.PEER_LEFT.SUCCESS])},500),delete n.peerInformations[t],delete n.peerMedias[t],delete n.remoteStreams[t],delete n.peerMessagesStamps[t],delete n.peerEndOfCandidatesCounter[t],delete n.peerCandidatesQueue[t],delete n.sdpSessions[t],delete n.peerStats[t],delete n.peerBandwidth[t],delete n.gatheredCandidates[t],delete n.peerCustomConfigs[t],delete n.peerConnStatus[t]})(s,i),((e,t)=>{const n=jo.getSkylinkState(e);oo.closeDataChannel(n,t)})(s,i)}catch(e){Ji.log.DEBUG([i,Mt.ROOM,null,jt.ROOM.LEAVE_ROOM.PEER_LEFT.ERROR],e)}};var zr=(e,t,n,r,s)=>{const i=jo.getSkylinkState(n.room.id),{peerConnections:o,peerConnectionConfig:a,bufferedLocalOffer:d,peerPriorityWeight:c,room:l}=i,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:S}}=jt,{AdapterJS:E}=window,u=o[t],p={type:r.type,sdp:r.sdp};if(u.processingLocalSDP=!0,"firefox"===E.webrtcDetectedBrowser&&(Zi.setOriginalDTLSRole(i,p,!1),p.sdp=Zi.modifyDTLSRole(i,r)),a.disableBundle&&(p.sdp=p.sdp.replace(/a=group:BUNDLE.*\r\n/gi,"")),Ji.log.INFO([t,"RTCSessionDescription",r.type,"Local session description updated ->"],p.sdp),r.type===Qe.OFFER){hr.send(l.id,S.OFFER.offer,t,r,!1),Ji.log.INFO([t,"RTCSessionDescription",r.type,"Local offer saved."]),d[t]=r;const o={type:p.type,sdp:p.sdp,mid:i.user.sid,target:t,rid:n.room.id,userInfo:fn.getUserInfo(n.room),weight:c,mediaInfoList:Qs.retrieveMediaInfoForOfferAnswer(l,p)};if(s&&Object.keys(s).length){const e=Object.keys(s),t=Object.keys(o);for(let n=0;n<e.length;n+=1){const r=e[n];-1===t.indexOf(r)&&(o[r]=s[r])}}e(o)}else{hr.send(l.id,S.ANSWER.answer,t,r,!1),e({type:p.type,sdp:p.sdp,mid:i.user.sid,target:t,rid:n.room.id,userInfo:fn.getUserInfo(n.room),mediaInfoList:Qs.retrieveMediaInfoForOfferAnswer(l,p)})}};const{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:Zr}}=jt;var es=(e,t,n=!1,r)=>{const s=jo.getSkylinkState(e.id),i=jo.getInitOptions(),{enableDataChannel:o}=i,{peerConnections:a,hasMCU:d,enableIceRestart:c,peerInformations:l,voiceActivityDetection:S,peerConnStatus:E,dataChannels:u}=s,{AdapterJS:p}=window,g=a[t],R={offerToReceiveAudio:!(!s.sdpSettings.connection.audio&&t!==Bt.MCU)&&Zi.getSDPCommonSupports(t,null,e.id).video,offerToReceiveVideo:!(!s.sdpSettings.connection.video&&t!==Bt.MCU)&&Zi.getSDPCommonSupports(t,null,e.id).audio,iceRestart:!!((l[t]||{}).config||{}).enableIceRestart&&n&&c,voiceActivityDetection:S};return d&&"function"!=typeof g.addTransceiver&&(R.offerToReceiveVideo=!0),d&&t!==Bt.MCU||hn.addLocalMediaStreams(t,s),o&&l[t].config.enableDataChannel&&(u[t]&&u[t].main||(oo.createDataChannel({peerId:t,roomState:s,createAsMessagingChannel:!0}),s.peerConnections[t].hasMainChannel=!0)),Ji.log.DEBUG([t,null,null,"Creating offer with config:"],R),g.endOfCandidates=!1,g.negotiating=!0,E[t]&&(s.peerConnStatus[t].sdpConstraints=R),jo.setSkylinkState(s,e.id),new Promise((e,n)=>{g.createOffer("plugin"===p.webrtcDetectedType?{mandatory:{OfferToReceiveAudio:R.offerToReceiveAudio,OfferToReceiveVideo:R.offerToReceiveVideo,iceRestart:R.iceRestart,voiceActivityDetection:R.voiceActivityDetection}}:R).then(n=>((e,t,n,r,s)=>{const{room:i}=n;Ji.log.DEBUG([t,null,null,"Created offer"],s),hr.send(i.id,Zr.OFFER.create,t,s,!1),zr(e,t,n,s,r)})(e,t,s,r,n)).catch(e=>((e,t,n,r)=>{const{room:s}=n;Ji.log.ERROR([t,null,null,"Failed creating an offer:"],r),hr.send(s.id,Zr.OFFER.create_error,t,null,!1,r),xi(ge({state:Qe.ERROR,peerId:t,error:r,room:n.room})),e(r)})(n,t,s,e))})};var ts=e=>{let t=null;const{currentRoom:n,targetMid:r,cert:s,hasScreenShare:i}=e,o=jo.getInitOptions(),{filterCandidatesType:a}=o,d=jo.getSkylinkState(n.id),{peerConnectionConfig:c,room:l}=d,S={iceServers:d.room.connection.peerConfig.iceServers,iceTransportPolicy:a.host&&a.srflx&&!a.relay?"relay":"all",bundlePolicy:c.bundlePolicy===Ye.NONE?Ye.BALANCED:c.bundlePolicy,rtcpMuxPolicy:c.rtcpMuxPolicy,iceCandidatePoolSize:c.iceCandidatePoolSize},E={optional:[{DtlsSrtpKeyAgreement:!0},{googIPv6:!0}]};s&&(S.certificates=[s]),d.peerConnStatus[r]&&(d.peerConnStatus[r].constraints=S,d.peerConnStatus[r].optional=E),jo.setSkylinkState(d,n.id);try{t=((e,t,n,r,s)=>{const i=jo.getInitOptions(),o=jo.getSkylinkState(s.id),{AdapterJS:a}=window;Ji.log.DEBUG([e,"RTCPeerConnection",null,"Creating peer connection ->"],{constraints:t,optional:n});const{RTCPeerConnection:d,msRTCPeerConnection:c}=window,l=new(i.useEdgeWebRTC&&c?window.msRTCPeerConnection:d)(t,n),S=[l,e,o];return l.setOffer="",l.setAnswer="",l.negotiating=!1,l.hasStream=!1,l.hasMainChannel=!1,l.firefoxStreamId="",l.processingLocalSDP=!1,l.processingRemoteSDP=!1,l.gathered=!1,l.gathering=!1,l.localStream=null,l.localStreamId=null,l.iceConnectionStateClosed=!1,l.signalingStateClosed=!1,o.gatheredCandidates[e]={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}},o.peerEndOfCandidatesCounter[e]=o.peerEndOfCandidatesCounter[e]||{},o.sdpSessions[e]={local:{},remote:{}},o.peerBandwidth[e]={},e===Bt.MCU&&(Ji.log.INFO("Creating an empty transceiver of kind video with MCU"),"function"==typeof l.addTransceiver&&l.addTransceiver("video")),jo.setSkylinkState(o,s.id),"firefox"===a.webrtcDetectedBrowser&&(l.removeStream=nr(l)),l.ontrack=_s.ontrack.bind(l,...S),l.ondatachannel=_s.ondatachannel.bind(l,...S),l.onicecandidate=_s.onicecandidate.bind(l,...S),l.oniceconnectionstatechange=_s.oniceconnectionstatechange.bind(l,...S),l.onsignalingstatechange=_s.onsignalingstatechange.bind(l,...S),l.onicegatheringstatechange=_s.onicegatheringstatechange.bind(l,...S),a.webrtcDetectedBrowser===Ft.REACT_NATIVE&&(l.onsenderadded=_s.onsenderadded.bind(l,...S),l.onremovetrack=_s.onremovetrack.bind(l,e,o.room,!1)),l})(r,S,E,0,n)}catch(e){Ji.log.ERROR([r,null,null,"Failed creating peer connection:"],e),t=null,xi(ge({state:Qe.ERROR,peerId:r,error:e,room:l}))}return t};var ns=e=>{let t=null;const{currentRoom:n,targetMid:r,peerBrowser:s,cert:i,receiveOnly:o,hasScreenShare:a}=e,d=jo.getInitOptions(),c=jo.getSkylinkState(n.id),{peerConnections:l,room:S}=c,E=new Jr;if(l[r])Ji.log.WARN([r,null,null,"Connection to peer has already been made."]);else{c.peerConnStatus[r]={connected:!1,init:!1},Ji.log.INFO([r,null,null,"Starting the connection to peer. Options provided:"],{peerBrowser:s,receiveOnly:o,enableDataChannel:d.enableDataChannel}),t=ts({currentRoom:n,targetMid:r,hasScreenShare:a,cert:i,sdpSemantics:_t.UNIFIED});try{const e=t.getConfiguration();e.sdpSemantics===_t.UNIFIED?Ji.log.INFO([r,"SDP Semantics",null,"Peer Connection has Unified plan."]):e.sdpSemantics===_t.PLAN_B?Ji.log.INFO([r,"SDP Semantics",null,"Peer Connection has Plan-B."]):Ji.log.INFO([r,"SDP Semantics",null,"The sdpSemantics parameter is not supported by this browser version."])}catch(e){Ji.log.INFO([r,"SDP Semantics",null,"getConfiguration() is not available in this browser version. Ex : "],e)}c.peerConnections[r]=t,jo.setSkylinkState(c,n.id),E.send(S.id,t.iceConnectionState,r),Er.send(S.id,"new",r,!1)}return t};const{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:rs}}=jt;var ss=(e,t)=>{const n=jo.getSkylinkState(e.room.id),{peerConnections:r,hasMCU:s,peerConnStatus:i,voiceActivityDetection:o}=n,a=r[t],{AdapterJS:d}=window;Ji.log.INFO([t,null,null,"Creating answer with config:"],e.room.connection.sdpConstraints);const c="edge"===d.webrtcDetectedBrowser?{offerToReceiveVideo:!(!n.sdpSettings.connection.audio&&t!==Bt.MCU)&&Zi.getSDPCommonSupports(t,a.remoteDescription,e.room.id).video,offerToReceiveAudio:!(!n.sdpSettings.connection.video&&t!==Bt.MCU)&&Zi.getSDPCommonSupports(t,a.remoteDescription,e.room.id).audio,voiceActivityDetection:o}:void 0;return s&&t!==Bt.MCU||hn.addLocalMediaStreams(t,e),i[t]&&(n.peerConnStatus[t].sdpConstraints=c),new Promise((n,r)=>a.createAnswer(c).then(r=>((e,t,n,r)=>{const{room:s}=n;Ji.log.DEBUG([t,null,null,"Created answer"],r),hr.send(s.id,rs.ANSWER.create,t,r,!1),zr(e,t,n,r)})(n,t,e,r)).catch(n=>((e,t,n,r)=>{const{room:s}=n;Ji.log.ERROR([t,null,null,"Failed creating an answer:"],r),hr.send(s.id,rs.ANSWER.create_error,t,null,!1,r),xi(ge({state:Qe.ERROR,peerId:t,error:r,room:n.room})),e(r)})(r,t,e,n)))};var is=(e,t,n,r,s)=>{const i=jo.getSkylinkState(e.room.id),o=i.peerConnections[t],a=i.dataChannels[t];let d=r;if(d&&d!==t||(d="main"),!("object"==typeof n&&n||n&&"string"==typeof n))return Ji.log.WARN([t,"RTCDataChannel",d,"Dropping invalid data ->"],n),null;if(!o||o.signalingState===je.CLOSED)return Ji.log.WARN([t,"RTCDataChannel",d,"Dropping for sending message as Peer connection does not exists or is closed ->"],n),null;if(!a||!a[d])return Ji.log.WARN([t,"RTCDataChannel",d,"Dropping for sending message as Datachannel connection does not exists ->"],n),null;const c=a[d].channelName,l=a[d].channelType,S=a[d].channel.readyState,E="object"==typeof n&&n.type===Tt.MESSAGE?be.MESSAGE:be.TRANSFER;if(S!==ye.OPEN){const e=new Error("Failed sending message as Datachannel connection state is not opened. Current readyState is "+S);throw Ji.log.ERROR([t,"RTCDataChannel",d,e],n),xi(ue({peerId:t,channelName:c,channelType:l,messageType:E,error:e,state:ye.SEND_MESSAGE_ERROR,bufferAmount:oo.getDataChannelBuffer(a[d].channel)})),e}try{s||"object"!=typeof n?(Ji.log.DEBUG([t,"RTCDataChannel",d,"Sending data with size ->"],n.size||n.length||n.byteLength),a[d].channel.send(n)):(Ji.log.DEBUG([t,"RTCDataChannel",d,`Sending ${n.type} protocol message ->`],n),a[d].channel.send(JSON.stringify(n)))}catch(e){throw Ji.log.ERROR([t,"RTCDataChannel",d,"Failed sending data)"],{error:e,data:n}),xi(ue({peerId:t,channelName:c,channelType:l,messageType:E,error:e,state:ye.SEND_MESSAGE_ERROR,bufferAmount:oo.getDataChannelBuffer(a[d].channel)})),e}return null};var os=(e,t,n,r,s)=>{const i=jo.getSkylinkState(e.room.id);let o=null,a=null,d=!1;const c=s===we.MESSAGING?"main":r,l=i.dataChannels[n]||{};if(!l.hasOwnProperty(c)||"object"!=typeof l[c])return null;if(o=l[c].transferId,a=l[c].streamId,a&&i.dataStreams[a]&&(d="string"===i.dataStreams[a].sessionChunkType?"string"==typeof t:"object"==typeof t),!i.peerConnections[n])return Ji.log.WARN([n,"RTCDataChannel",c,"Dropping data received from Peer as connection is not present ->"],t),null;if(!i.dataChannels[n]||!i.dataChannels[n][c])return Ji.log.WARN([n,"RTCDataChannel",c,"Dropping data received from Peer as Datachannel connection is not present ->"],t),null;if("string"==typeof t)try{const r=JSON.parse(t);if(d=!1,Ji.log.DEBUG([n,"RTCDataChannel",c,`Received protocol ${r.type} message ->`],r),[Tt.ACK,Tt.ERROR,Tt.CANCEL].indexOf(r.type)>-1&&!(o&&i.dataTransfers[o]&&i.dataTransfers[o].sessions[n]))return Ji.log.WARN([n,"RTCDataChannel",c,"Discarded protocol message as data transfer session is not present ->"],r),null;switch(r.type){case Tt.WRQ:if(o&&i.dataTransfers[o]&&i.dataTransfers[o].sessions[n]){Ji.log.WARN([n,"RTCDataChannel",c,"Rejecting bidirectional data transfer request as it is currently not supported in the SDK ->"],r),is(e,n,{type:Tt.ACK,ackN:-1,sender:i.user.sid},c);break}break;case Tt.MESSAGE:((e,t,n,r)=>{const s=n.sender||t;Ji.log.INFO([s,"RTCDataChannel",r,"Received P2P message from peer:"],n),xi(pe({room:e.room,message:{targetPeerId:n.target,content:n.data,senderPeerId:s,isDataChannel:!0,isPrivate:n.isPrivate},isSelf:!1,peerId:s,peerInfo:fn.getPeerInfo(s,e.room)}))})(i,n,r,c);break;default:Ji.log.WARN([n,"RTCDataChannel",c,`Discarded unknown ${r.type} message ->`],r)}}catch(e){xi(ue({peerId:n,channelName:r,channelType:s,error:e,state:ye.ERROR,bufferAmount:oo.getDataChannelBuffer(i.dataChannels[n][c].channel)}))}return null};var as=(e,t)=>{const{peerId:n,channelName:r,channelType:s,roomState:i}=e;os(i,t.data,n,r,s)};var ds=class extends Nn{constructor(){super();const{AdapterJS:e}=window;this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,channel_id:null,channel_label:null,channel_type:null,channel_binary_type:null,error:null,agent_name:e.webrtcDetectedBrowser,agent_type:e.webrtcDetectedType,agent_version:e.webrtcDetectedVersion}}send(e,t,n,r,s,i){const o=jo.getSkylinkState(e);this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.uid||null,this.model.peer_id=n,this.model.client_id=o.clientId,this.model.state=t,this.model.channel=r,this.model.channel_id=r.id,this.model.channel_label=r.label,this.model.channel_type="main"===s?"persistent":"temporal",this.model.channel_binary_type=r.binaryType,this.model.appKey=jo.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.error=("string"==typeof i?i:i&&i.message)||null,"plugin"===this.model.agent_name&&(this.model.channel_binary_type="int8Array","IE"===this.model.agent_name&&this.model.agent_version<11&&(this.model.channel_binary_type="none")),this.postStats(this.endpoints.dataChannel,this.model)}};var cs={onopen:e=>{const{dataChannel:t,channelProp:n,channelName:r,channelType:s,peerId:i,roomState:o,bufferThreshold:a}=e,d=new ds,{room:c}=o,{STATS_MODULE:l}=jt;Ji.log.DEBUG([i,"RTCDataChannel",n,"Datachannel has opened"]),t.bufferedAmountLowThreshold=a||0,d.send(c.id,l.HANDLE_DATA_CHANNEL_STATS.closed,i,t,n),xi(ue({state:ye.OPEN,peerId:i,channelName:r,channelType:s,bufferAmount:oo.getDataChannelBuffer(t)}))},onmessage:as,onerror:(e,t)=>{const{dataChannel:n,peerId:r,channelName:s,channelProp:i,channelType:o,roomState:a}=e;if("NONE"!==t.error.errorDetail){const e=jo.getSkylinkState(a.room.id),{room:d}=e,c=new ds;Ji.log.ERROR([r,"RTCDataChannel",i,"Datachannel has an exception ->"],t),c.send(d.id,ye.ERROR,r,n,i,t),xi(ue({state:ye.ERROR,room:d,peerId:r,channelName:s,channelType:o,bufferAmount:oo.getDataChannelBuffer(n),error:t}))}else Ji.log.DEBUG([r,"RTCDataChannel",i,"Datachannel state ->"],t.error.message)},onbufferedamountlow:e=>{const{dataChannel:t,peerId:n,channelName:r,channelProp:s,channelType:i,roomState:o}=e,a=jo.getSkylinkState(o.room.id),{room:d}=a;Ji.log.DEBUG([n,"RTCDataChannel",s,"Datachannel buffering data transfer low"]),xi(ue({state:ye.BUFFERED_AMOUNT_LOW,room:d,peerId:n,channelName:r,channelType:i,bufferAmount:oo.getDataChannelBuffer(t)}))},onclose:e=>{const{dataChannel:t,peerId:n,channelName:r,channelProp:s,channelType:i,roomState:o}=e,{DATA_CHANNEL:a,STATS_MODULE:d}=jt,c=jo.getSkylinkState(o.room.id)||Object.values(jo.getSkylinkState())[0];if(!c)return;const{room:l,peerConnections:S}=c,E=((e,t)=>{const{dataTransfers:n}=t,r=Object.keys(n);for(let t=0;t<r.length;t+=1)if(-1!==r[t].indexOf(e))return r[t];return null})(n,c),u=new ds;Ji.log.DEBUG([n,"RTCDataChannel",s,a.closed]);try{if(u.send(l.id,d.HANDLE_DATA_CHANNEL_STATS.closed,n,t,s),xi(ue({state:ye.CLOSED,peerId:n,room:l,channelName:r,channelType:i,bufferAmount:oo.getDataChannelBuffer(t)})),E&&xi((p={state:ye.ERROR,transferId:E,peerId:n,transferInfo:null,error:new Error(a.closed)},new de(D,{detail:p}))),S[n]&&S[n].remoteDescription&&S[n].remoteDescription.sdp&&(-1===S[n].remoteDescription.sdp.indexOf("m=application")||S[n].remoteDescription.sdp.indexOf("m=application 0")>0))return;i===we.MESSAGING&&setTimeout(()=>{S[n]&&S[n].signalingState!==je.CLOSED&&S[n].localDescription&&S[n].localDescription.type===Qe.OFFER&&(Ji.log.DEBUG([n,"RTCDataChannel",s,a.reviving_dataChannel]),oo.createDataChannel({peerId:n,dataChannel:t,bufferThreshold:oo.getDataChannelBuffer(t),createAsMessagingChannel:!0,roomState:c}),u.send(l.id,d.HANDLE_DATA_CHANNEL_STATS.reconnecting,n,{label:r},"main"))},100)}catch(e){Ji.log.WARN([n,"RTCDataChannel",s,a.closed])}var p}};const ls=(e,t,n)=>{const r=jo.getInitOptions(),{dataChannels:s,inRoom:i,user:o,hasMCU:a}=e;let d=Object.keys(s),c=!1;if(Array.isArray(n)&&n.length?(d=n,c=!0):n&&"string"==typeof n&&(d=[n],c=!0),!i||!o||!o.sid)return Ji.log.ERROR("Unable to send message as User is not in Room. ->",t),null;if(!r.enableDataChannel)return Ji.log.ERROR("Unable to send message as User does not have DataChannel enabled. ->",t),null;for(let r=0;r<d.length;r+=1){const i=d[r];s[i]||a?i===Bt.MCU?(d.splice(r,1),r-=1):a||(Ji.log.DEBUG([i,"RTCDataChannel",null,`Sending ${c?"private":""} P2P message to Peer.`]),is(e,i,{type:Tt.MESSAGE,isPrivate:c,sender:o.sid,target:n?i:null,data:t},"main")):(Ji.log.ERROR([i,"RTCDataChannel",null,"Dropping of sending message to Peer as DataChannel connection does not exist."]),d.splice(r,1),r-=1)}return 0===d.length&&Ji.log.WARN("Currently there are no Peers to send P2P message to."),a&&(Ji.log.DEBUG([Bt.MCU,"RTCDataChannel",null,`Broadcasting ${c?"private":""} P2P message to Peers.`]),is(e,Bt.MCU,{type:Tt.MESSAGE,isPrivate:c,sender:o.sid,target:d,data:t},"main")),!n&&a||xi(pe({room:e.room,message:{targetPeerId:n||null,content:t,senderPeerId:o.sid,isDataChannel:!0,isPrivate:c},isSelf:!0,peerId:o.sid,peerInfo:fn.getCurrentSessionInfo(e.room)})),null};const Ss=(e,t,n)=>{const{dataChannels:r}=e,s=r[t][n],{channelName:i,channelType:o}=s.channelName;if(s.readyState!==ye.CLOSED){const{room:a}=e,d=new ds;Ji.log.DEBUG([t,Mt.DATA_CHANNEL,n,jt.DATA_CHANNEL.CLOSING]),d.send(a.id,ye.CLOSING,t,s.channel,n),xi(ue({room:a,peerId:t,state:ye.CLOSING,channelName:i,channelType:o,bufferAmount:oo.getDataChannelBuffer(s.channel)})),s.channel.close(),delete r[t][n]}};var Es=(e,t,n)=>{const{room:r}=e,s=new Js;try{const e=s.messageBuilder.getRestartOfferMessage(r.id,t,n);return s.offer(r,t,n,e),t}catch(e){return[t,e]}};var us=(e,t,n)=>{const r=jo.getSkylinkState(t.room.id),{AdapterJS:s}=window,{peerConnections:i,peerCustomConfigs:o,peerEndOfCandidatesCounter:a,room:d,user:c}=r,{doIceRestart:l,bwOptions:S}=n,E=new Js,{PEER_CONNECTION:u}=jt,p=[];return new Promise(t=>{if(!i[e])return Ji.log.ERROR([e,null,null,u.refresh_peerId_no_match]),p.push(u.refresh_peerId_no_match),t([e,p]);const n=i[e];if("edge"===s.webrtcDetectedBrowser&&(Ji.log.WARN([e,"RTCPeerConnection",null,u.refresh_not_supported]),p.push(u.refresh_no_edge_support)),0!==p.length)return t([e,p]);if(n.signalingState===je.STABLE)return Ji.log.INFO([e,null,null,"Sending restart message to signaling server ->"],{iceRestart:l,options:S}),o[e]=o[e]||{},o[e].bandwidth=o[e].bandwidth||{},o[e].googleXBandwidth=o[e].googleXBandwidth||{},S.bandwidth&&"object"==typeof S.bandwidth&&("number"==typeof S.bandwidth.audio&&(o[e].bandwidth.audio=S.bandwidth.audio),"number"==typeof S.bandwidth.video&&(o[e].bandwidth.video=S.bandwidth.video),"number"==typeof S.bandwidth.data&&(o[e].bandwidth.data=S.bandwidth.data)),S.googleXBandwidth&&"object"==typeof S.googleXBandwidth&&("number"==typeof S.googleXBandwidth.min&&(o[e].googleXBandwidth.min=S.googleXBandwidth.min),"number"==typeof S.googleXBandwidth.max&&(o[e].googleXBandwidth.max=S.googleXBandwidth.max)),a[e]=a[e]||{},a[e].len=0,t(Es(r,e,l));const g=n.localDescription&&n.localDescription.sdp;if(n.signalingState===je.HAVE_LOCAL_OFFER&&g)return E.sendMessage({type:n.localDescription.type,sdp:n.localDescription.sdp,mid:c.sid,target:e,rid:d.id,restart:!0}),t(e);const R=`Failed restarting as peer connection state is ${n.signalingState} and there is no localDescription set to connection. There could be a handshaking step error.`;return Ji.log.DEBUG([e,"RTCPeerConnection",null,R],{localDescription:n.localDescription,remoteDescription:n.remoteDescription}),p.push(R),t([e,p]),null})};var ps=(e,t,n)=>new Promise(r=>{const s=e,i=jo.getInitOptions(),{mcuUseRenegoRestart:o}=i;try{n.bandwidth&&"object"==typeof n.bandwidth&&("number"==typeof n.bandwidth.audio&&(s.streamsBandwidthSettings.bAS.audio=n.bandwidth.audio),"number"==typeof n.bandwidth.video&&(s.streamsBandwidthSettings.bAS.video=n.bandwidth.video),"number"==typeof n.bandwidth.data&&(s.streamsBandwidthSettings.bAS.data=n.bandwidth.data)),n.googleXBandwidth&&"object"==typeof n.googleXBandwidth&&("number"==typeof n.googleXBandwidth.min&&(s.streamsBandwidthSettings.googleX.min=n.googleXBandwidth.min),"number"==typeof n.googleXBandwidth.max&&(s.streamsBandwidthSettings.googleX.max=n.googleXBandwidth.max)),o&&(s.peerEndOfCandidatesCounter.MCU=s.peerEndOfCandidatesCounter.MCU||{},s.peerEndOfCandidatesCounter.MCU.len=0,jo.setSkylinkState(s),r(Es(s,Bt.MCU,t)))}catch(e){r([Bt.MCU,e])}});const gs=(e,t,n)=>(Ji.log.INFO([e,"PeerConnection",null,"Restarting peer connection."]),us(e,t,n));var Rs={createOffer:es,createAnswer:ss,addPeer:ns,createDataChannel:e=>{let{peerId:t,dataChannel:n,bufferThreshold:r,createAsMessagingChannel:s,roomState:i}=e;const o=jo.getSkylinkState(i.room.id),{user:a,peerConnections:d,dataChannels:c}=o,l=d[t];let S="-_"+t,E=!0===s?we.MESSAGING:we.DATA,u=E===we.MESSAGING?"main":S;if(!a||!a.sid)return Ji.log.ERROR([t,"RTCDataChannel",u,"Aborting of creating or initializing DataChannel as User does not have Room session"]),null;if(S=`${a.sid}_${t}`,!l||l.signalingState===je.CLOSED)return Ji.log.ERROR([t,"RTCDataChannel",u,"Aborting of creating or initializing Datachannel as Peer connection does not exists"]),null;if(n&&"object"==typeof n?S=n.label:"string"==typeof n&&(S=n,n=null),c[t]?c[t].main&&c[t].main.channel.label===S&&(u="main",E=we.MESSAGING):(u="main",E=we.MESSAGING,c[t]={},Ji.log.DEBUG([t,"RTCDataChannel",u,"initializing main DataChannel"])),!n)try{n=l.createDataChannel(S,{reliable:!0,ordered:!0})}catch(e){Ji.log.ERROR([t,"RTCDataChannel",u,"Failed creating Datachannel ->"],e);const r=new ds,{room:s}=i;return r.send(s.id,ye.ERROR,t,{label:S},u,e),xi(ue({state:ye.CREATE_ERROR,peerId:t,error:e,channelName:S,channelType:E,buferAmount:oo.getDataChannelBuffer(n)})),null}const p={dataChannel:n,peerId:t,channelName:S,channelProp:u,channelType:E,roomState:i,bufferThreshold:r};n.onopen=cs.onopen.bind(n,p),n.onmessage=cs.onmessage.bind(n,p),n.onerror=cs.onerror.bind(n,p),n.onbufferedamountlow=cs.onbufferedamountlow.bind(n,p),n.onclose=cs.onclose.bind(n,p);const g=E===we.MESSAGING?"main":S;return o.dataChannels[t][g]={channelName:S,channelType:E,transferId:null,streamId:null,channel:n},jo.setSkylinkState(o,i.room.id),null},sendP2PMessage:(e,t,n)=>{const r=_i(e);if(r)ls(r,t,n);else{const e=jo.getSkylinkState(),r=Object.keys(e);for(let s=0;s<r.length;s+=1){const i=e[r[s]];ls(i,t,n)}}},getPeersInRoom:e=>{const t=_i(e);if(t){const e={},n=Object.keys(t.peerInformations);for(let r=0;r<n.length;r+=1)e[n[r]]=Object.assign({},fn.getPeerInfo(n[r],t.room)),e[n[r]].isSelf=!1;return t.user&&t.user.sid&&(e[t.user.sid]=Object.assign({},fn.getCurrentSessionInfo(t.room)),e[t.user.sid].isSelf=!0),e}return null},signalingEndOfCandidates:(e,t)=>{const n=jo.getSkylinkState(t.room.id),r=n.peerEndOfCandidatesCounter[e],i=n.peerConnections[e],o=n.peerCandidatesQueue[e],a=n.peerConnectionConfig[e],d=n.gatheredCandidates[e],{AdapterJS:c,RTCIceCandidate:l}=window,{TAGS:S}=s,{PEER_CONNECTION:E}=jt;if(!r)return null;if(i&&i.signalingState!==je.CLOSED&&i.remoteDescription&&i.remoteDescription.sdp&&"number"==typeof r.expectedLen&&r.len>=r.expectedLen&&(!o||0===o.length)&&!r.hasSet){Ji.log.DEBUG([e,S.PEER_CONNECTION,null,E.end_of_candidates]),r.hasSet=!0;try{if("edge"===c.webrtcDetectedBrowser){let t=-1;const r=[],s=i.remoteDescription.sdp.split("\r\n");let o=!1;for(let i=0;i<s.length;i+=1)if(0===s[i].indexOf("m="))o="0"===s[i].split(" ")[1],t+=1;else if(0===s[i].indexOf("a=mid:")&&!o){const o=s[i].split("a=mid:")[1]||"";if(o&&-1===r.indexOf(o)&&(r.push(o),pr.addIceCandidate(e,"endofcan-"+(new Date).getTime(),"endOfCandidates",new l({sdpMid:o,sdpMLineIndex:t,candidate:"candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"}),n),a.bundlePolicy===Ye.MAX_BUNDLE))break}}else c&&!Di(c.VERSION,"0.14.0")&&i.addIceCandidate(null);if(d){const t={expected:r.expectedLen||0,received:r.len||0,processed:d.receiving.srflx.length+d.receiving.relay.length+d.receiving.host.length};xi((u={room:n.room,peerId:e,candidatesLength:t},new de(C,{detail:u})))}n.peerEndOfCandidatesCounter[e]=r,jo.setSkylinkState(n,t.room.id)}catch(t){Ji.log.ERROR([e,S.PEER_CONNECTION,null,E.end_of_candidate_failure],t)}}var u;return null},getDataChannelBuffer:e=>({bufferedAmountLow:parseInt(e.bufferedAmountLow,10)||0,bufferedAmountLowThreshold:parseInt(e.bufferedAmountLowThreshold,10)||0}),refreshDataChannel:(e,t)=>{const{dataChannels:n,peerConnections:r}=e;if((e=>!ui(e))(n)&&Object.hasOwnProperty.call(n,t)){if(Object.hasOwnProperty.call(n[t],"main")){const s=n[t].main,{channelName:i,channelType:o}=s,a=s.channel.bufferedAmountLowThreshold||0;o===we.MESSAGING&&setTimeout(()=>{Object.hasOwnProperty.call(r,t)&&r[t].signalingState!==je.CLOSED&&r[t].localDescription.type===Qe.OFFER&&(oo.closeDataChannel(e,t),Ji.log.DEBUG([t,"RTCDataChannel","main",jt.DATA_CHANNEL.reviving_dataChannel]),oo.createDataChannel({roomState:e,peerId:t,dataChannel:i,bufferThreshold:a,createAsMessagingChannel:!0}))},100)}}else Ji.log.DEBUG([t,"RTCDataChannel",jt.DATA_CHANNEL.refresh_error])},closeDataChannel:(e,t,n="main")=>{try{const r=jo.getSkylinkState(e.room.id),{dataChannels:s,room:i}=r;if(!s[t]||!s[t][n])return void Ji.log.WARN([t,Mt.DATA_CHANNEL,n||null,jt.DATA_CHANNEL.ERRORS.NO_SESSIONS]);if("main"===n)return void((e,t)=>{const{dataChannels:n}=e,r=Object.keys(n[t]);for(let s=0;s<r.length;s+=1)Object.hasOwnProperty.call(n[t],r[s])&&Ss(e,t,r[s]);delete n[t]})(r,t);Ss(r,t,n),jo.setSkylinkState(r,i.id)}catch(e){Ji.log.ERROR([t,Mt.DATA_CHANNEL,n||null,jt.DATA_CHANNEL.ERRORS.FAILED_CLOSING],e)}},refreshConnection:xr,refreshPeerConnection:(e,t,n=!1,r={})=>{const s=jo.getSkylinkState(t.room.id),{hasMCU:i}=s;try{if(!i){const t=[];for(let i=0;i<e.length;i+=1){const o=e[i],a=gs(o,s,{doIceRestart:n,bwOptions:r});t.push(a)}return Promise.all(t)}return ps(t,n,r)}catch(e){return Ji.log.ERROR([null,"RTCPeerConnection",null,"Failed restarting."],e),null}},restartPeerConnection:us,buildPeerInformations:(e,t)=>{const n=e,r=n.sid;return n.room=t.room.roomName,n.settings.data=!!(t.dataChannels[r]&&t.dataChannels[r].main&&t.dataChannels[r].main.channel&&t.dataChannels[r].main.channel.readyState===ye.OPEN),delete n.publishOnly,n},getConnectionStatus:(e,t=null)=>{const{ROOM_STATE:n}=jt;if(!e)return Ji.log.WARN(n.NO_ROOM_NAME),vi(n.NO_ROOM_NAME);const{room:r}=e,s=((e,t)=>{const{peerConnections:n,room:r}=e,{PEER_CONNECTION:s}=jt;let i=null,o=null;return pi(Object.keys(n))?o=s.not_initialised:Array.isArray(t)?(i=t,i.forEach(e=>{yi(r,e)||(o=`${s.peerId_does_not_exist} ${e}`)})):Ai(t)?(yi(r,t)||(o=`${s.peerId_does_not_exist} ${t}`),i=[t]):i=Object.keys(n),{peerIds:i,errorMsg:o}})(e,t);if(s.errorMsg)return Ji.log.WARN(s.errorMsg),vi(s.errorMsg);const{peerIds:i}=s,o=[];for(let e=0;e<i.length;e+=1){const t=new no(r.id,i[e]);o.push(t.getConnectionStatus())}return Promise.all(o)},closePeerConnection:(e,t)=>{const n=jo.getSkylinkState(e.room.id),{peerConnections:r,room:s}=n,{AdapterJS:i}=window;r[t].close(),"AppleWebKit"===i.webrtcDetectedType&&(n.peerConnections[t].signalingStateClosed||(n.peerConnections[t].signalingStateClosed=!0),n.peerConnections[t].iceConnectionStateClosed||(n.peerConnections[t].iceConnectionStateClosed=!0)),jo.setSkylinkState(n,s.id)},updatePeerInformationsMediaStatus:(e,t,n,r)=>{const s=jo.getSkylinkState(e.id);s.peerInformations[t].mediaStatus=((e,t,n,r)=>{const{peerMedias:s,peerInformations:i}=e,o=s[t],a=i[t].mediaStatus||{};return Object.values(o).forEach(e=>{e.transceiverMid===n.mid&&(a[r.id]={audioMuted:wi(r)?e.mediaState===wt.MUTED?0:1:-1,videoMuted:bi(r)?e.mediaState===wt.MUTED?0:1:-1})}),delete a.audioMuted,delete a.videoMuted,a})(s,t,n,r),jo.setSkylinkState(s,e.id)},processNewSender:(e,t,n)=>{const r=e;r.currentRTCRTPSenders[t]||(r.currentRTCRTPSenders[t]=[]),r.currentRTCRTPSenders[t].push(n),jo.setSkylinkState(r,r.room.id)}};var ms=(e,t,n,r)=>{const s=r.channel||r,i=jo.getInitOptions(),o=jo.getSkylinkState(n.room.id),{peerInformations:a}=o,{enableDataChannel:d}=i;Ji.log.DEBUG([t,"RTCDataChannel",s.label,"Received datachannel ->"],s),d&&a[t].config.enableDataChannel?(e.hasMainChannel||(e.hasMainChannel=!0),Rs.createDataChannel({peerId:t,dataChannel:s,roomState:n})):Ji.log.WARN([t,"RTCDataChannel",s.label,"Not adding datachannel as enable datachannel is set to false"])};var Is=(e,t,n,r)=>{pr.onIceCandidate(t,r.candidate||r,n.room)};const hs=(e,t,n,r)=>{const s=e[t]["send"===n?"sending":"receiving"][r];return["number","string","boolean"].indexOf(typeof s)>-1?s:null};var Ts=class extends Nn{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,audio_send:{tracks:[]},audio_recv:{},video_send:{tracks:[]},video_recv:{},error:null},this.stats=null}gatherSendAudioPacketsStats(){this.model.audio_send.bytes=hs(this.stats,"audio","send","bytes"),this.model.audio_send.packets=hs(this.stats,"audio","send","packets"),this.model.audio_send.echo_return_loss=hs(this.stats,"audio","send","echoReturnLoss"),this.model.audio_send.echo_return_loss_enhancement=hs(this.stats,"audio","send","echoReturnLossEnhancement"),this.model.audio_send.round_trip_time=hs(this.stats,"audio","send","roundTripTime"),this.model.audio_send.audio_level=hs(this.stats,"audio","send","audioLevel"),this.model.audio_send.jitter=hs(this.stats,"audio","send","jitter")}gatherReceiveAudioPacketsStats(){this.model.audio_recv.bytes=hs(this.stats,"audio","recv","bytes"),this.model.audio_recv.packets=hs(this.stats,"audio","recv","packets"),this.model.audio_recv.packets_lost=hs(this.stats,"audio","recv","packetsLost"),this.model.audio_recv.jitter=hs(this.stats,"audio","recv","jitter"),this.model.audio_recv.audio_level=hs(this.stats,"audio","recv","audioLevel")}gatherSendVideoPacketsStats(){this.model.video_send.bytes=hs(this.stats,"video","send","bytes"),this.model.video_send.packets=hs(this.stats,"video","send","packets"),this.model.video_send.nack_count=hs(this.stats,"video","send","nacks"),this.model.video_send.firs_count=hs(this.stats,"video","send","firs"),this.model.video_send.plis_count=hs(this.stats,"video","send","plis"),this.model.video_send.frames_encoded=hs(this.stats,"video","send","framesEncoded"),this.model.video_send.frame_width=hs(this.stats,"video","send","frameWidth"),this.model.video_send.frame_height=hs(this.stats,"video","send","frameHeight"),this.model.video_send.round_trip_time=hs(this.stats,"video","send","roundTripTime"),this.model.video_send.qp_sum=hs(this.stats,"video","send","qpSum"),this.model.video_send.jitter=hs(this.stats,"video","send","jitter"),this.model.video_send.frames=hs(this.stats,"video","send","frames"),this.model.video_send.hugeFrames=hs(this.stats,"video","send","hugeFramesSent"),this.model.video_send.framesPerSecond=hs(this.stats,"video","send","framesPerSecond")}gatherReceiveVideoPacketsStats(){this.model.video_recv.bytes=hs(this.stats,"video","recv","bytes"),this.model.video_recv.packets=hs(this.stats,"video","recv","packets"),this.model.video_recv.packets_lost=hs(this.stats,"video","recv","packetsLost"),this.model.video_recv.nack_count=hs(this.stats,"video","recv","nacks"),this.model.video_recv.firs_count=hs(this.stats,"video","recv","firs"),this.model.video_recv.plis_count=hs(this.stats,"video","recv","plis"),this.model.video_recv.frames_decoded=hs(this.stats,"video","recv","framesDecoded"),this.model.video_recv.qp_sum=hs(this.stats,"video","recv","qpSum"),this.model.video_recv.frames_decoded=hs(this.stats,"video","recv","framesDecoded"),this.model.video_recv.frames_dropped=hs(this.stats,"video","recv","framesDropped"),this.model.video_recv.decoderImplementation=hs(this.stats,"video","recv","decoderImplementation")}buildTrackInfo(e){const t=jo.getSkylinkState(e),{streams:n}=t;let r=[];n.userMedia&&(r=Object.values(Object.values(n.userMedia))),n.screenshare&&r.push(n.screenshare),r.forEach(e=>{if(e){const t=e.stream?e.stream:e[Object.keys(e)[0]].stream,n=e.settings?e.settings:e[Object.keys(e)[0]].settings,r=t.getAudioTracks(),s=t.getVideoTracks();r.forEach(e=>{const n=((e,t)=>({stream_id:e.id,id:t.id,label:t.label,muted:!t.enabled}))(t,e);this.model.audio_send.tracks.push(n)}),s.forEach(e=>{const r=((e,t,n)=>({stream_id:e.id,id:t.id,label:t.label,height:n.video.resolution.height,width:n.video.resolution.width,muted:!t.enabled}))(t,e,n);this.model.video_send.tracks.push(r)})}})}send(e,t,n){const{STATS_MODULE:r}=jt,s=jo.getSkylinkState(e);s?(s.streams.userMedia||s.streams.screenshare)&&(this.model.client_id=s.clientId,this.model.appKey=jo.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=n,oo.retrieveStatistics(e,n,jo.getInitOptions().beSilentOnStatsLogs).then(t=>{t&&(this.stats=t,this.gatherSendAudioPacketsStats(),this.gatherReceiveAudioPacketsStats(),this.gatherSendVideoPacketsStats(),this.gatherReceiveVideoPacketsStats(),this.buildTrackInfo(e),this.postStats(this.endpoints.bandwidth,this.model))}).catch(e=>{this.model.error=e?e.message:null,Ji.log.DEBUG(r.HANDLE_BANDWIDTH_STATS.RETRIEVE_FAILED,e)})):Ji.log.DEBUG([n,"Statistics","Bandwidth_Stats",r.HANDLE_BANDWIDTH_STATS.NO_STATE])}};const As={};class Os{constructor(e){const{peerConnection:t,state:n,targetMid:r}=e;if(As[r])return As[r];this.peerId=r,this.state=n,this.peerConnection=t,this.bandwidth=null,As[this.peerId]=this}static formatTotalFn(e){let t=0;for(let n=0;n<e.length;n+=1)t+=e[n];return t/e.length}setAdjustmentInterval(){const{bandwidthAdjuster:e,peerBandwidth:t,room:n}=this.state,{PEER_CONNECTION_STATE:r}=s;if(this.bandwidth)return;const i={audio:{send:[],recv:[]},video:{send:[],recv:[]}};let o=0;const a=setInterval(()=>{this.peerConnection&&this.peerConnection.signalingState!==r.CLOSED&&e&&t[this.peerId]?oo.retrieveStatistics(n.id,this.peerId,jo.getIniOptions().beSilentOnStatsLogs,!0).then(t=>{if(this.peerConnection&&this.peerConnection.signalingState!==r.CLOSED&&e||clearInterval(a),i.audio.send.push(8*t.audio.sending.bytes),i.audio.recv.push(8*t.audio.receiving.bytes),i.video.send.push(8*t.video.sending.bytes),i.video.recv.push(8*t.video.receiving.bytes),o+=1,o===e.interval){o=0;let t=Os.formatTotalFn(i.audio.send),n=Os.formatTotalFn(i.video.send);e.useUploadBwOnly||(t+=Os.formatTotalFn(i.audio.recv),n+=Os.formatTotalFn(i.video.recv),t/=2,n/=2),t=parseInt(t*(e.limitAtPercentage/100)/1e3,10),n=parseInt(n*(e.limitAtPercentage/100)/1e3,10),oo.refreshConnection(this.state,this.peerId,!1,{bandwidth:{audio:t,video:n}})}}).catch(()=>{i.audio.send.push(0),i.audio.recv.push(0),i.video.send.push(0),i.video.recv.push(0)}):clearInterval(a)},1e3);this.bandwidth=i}}var fs=Os;const Cs=e=>{const{ICE_CONNECTION_STATE:t}=s;return[t.COMPLETED,t.CONNECTED].indexOf(e)>-1};var _s={ontrack:(e,t,n,r)=>{const s=jo.getSkylinkState(n.room.id),{peerConnections:i,room:o,hasMCU:a}=s,{receiver:d}=r,{AdapterJS:c}=window,l=r.streams[0];let{transceiver:S,track:E}=r,u=t;if(!l)return Ji.log.WARN("ontrack stream is null"),null;if("safari"===c.webrtcDetectedBrowser){i[t].getTransceivers().forEach(e=>{e.receiver.track.id===d.track.id&&(S=e)})}if(null===S.mid&&Ji.log.WARN("Transceiver mid is null",S),!i[u])return null;a&&(u=((e,t)=>{const{peerMedias:n,user:r}=e,s=Object.keys(n);for(let e=0;e<s.length;e+=1)if(s[e]!==r.sid){const r=Object.values(n[s[e]]);for(let n=0;n<r.length;n+=1)if(r[n].transceiverMid===t.mid)return s[e]}return null})(s,S));const p=Qs.isVideoScreenTrack(s,u,S.mid),g=[u,o,p];return l.onremovetrack=_s.onremovetrack.bind(void 0,...g),Qs.updateStreamIdFromOntrack(s.room,u,S.mid,l.id),oo.updatePeerInformationsMediaStatus(s.room,u,S,l),hn.updateRemoteStreams(s.room,u,l),hn.onRemoteTrackAdded(l,n,u,p,E.kind===yt.VIDEO,E.kind===yt.AUDIO),null},ondatachannel:ms,onicecandidate:Is,oniceconnectionstatechange:(e,t,n)=>{const{PEER_CONNECTION:r}=jt,{ICE_CONNECTION_STATE:i,PEER_CONNECTION_STATE:o,BROWSER_AGENT:a}=s,{AdapterJS:d}=window,{webrtcDetectedBrowser:c,webrtcDetectedType:l}=d,S=jo.getSkylinkState(n.room.id),{streams:E}=S;if(!S)return void Ji.log.DEBUG([t,"RTCIceConnectionState",null,r.no_room_state]);const{hasMCU:u,bandwidthAdjuster:p,peerInformations:g,peerConnStatus:R,peerStats:m}=S,I=new Jr;let h=null,T=e.iceConnectionState;if(Ji.log.DEBUG([t,"RTCIceConnectionState",null,r.ice_connection_state],T),"edge"===c&&("connecting"===T?T=i.CHECKING:"new"===T&&(T=i.FAILED)),"AppleWebKit"!==l||T!==i.CLOSED){if(S&&e.iceConnectionState!==i.CONNECTED&&I.send(n.room.id,e.iceConnectionState,t),xi(he({state:T,peerId:t})),T===i.FAILED){if(d.webrtcDetectedBrowser===a.FIREFOX&&!E.userMedia)return;xi(he({state:i.TRICKLE_FAILED,peerId:t}))}R&&R[t]&&(R[t].connected=Cs(T)),h||!Cs(T)||m[t]||(h=!0,m[t]={},Ji.log.DEBUG([t,"RTCStatsReport",null,"Retrieving first report to tabulate results"]),oo.getConnectionStatus(S,t).then(()=>{I.send(n.room.id,e.iceConnectionState,t),h=setInterval(()=>{e.signalingState===o.CLOSED||e.iceConnectionState===o.CLOSED?clearInterval(h):(new Ts).send(S.room.id,e,t)},2e4)})),!u&&Cs(T)&&p&&"edge"!==d.webrtcDetectedBrowser&&"edge"!==(((g[t]||{}).agent||{}).name||"edge")&&new fs({targetMid:t,state:S,peerConnection:e}).setAdjustmentInterval()}else setTimeout(()=>{e.iceConnectionStateClosed||(I.send(n.room.id,i.CLOSED,t),xi(he({state:i.CLOSED,peerId:t})))},10)},onicegatheringstatechange:(e,t,n)=>{const{PEER_CONNECTION:r}=jt,{iceGatheringState:s}=e;Ji.log.INFO([t,"RTCIceGatheringState",null,r.ice_gathering_state],s),xi(Ie({state:s,room:n.room,peerId:t}))},onsignalingstatechange:(e,t)=>{const{AdapterJS:n}=window,{PEER_CONNECTION:r}=jt,{PEER_CONNECTION_STATE:i}=s,{signalingState:o,signalingStateClosed:a}=e;Ji.log.DEBUG([t,"RTCSignalingState",null,r.peer_connection_state],o),"AppleWebKit"!==n.webrtcDetectedType||o!==i.CLOSED?xi(_e({state:o,peerId:t})):setTimeout(()=>{a||xi(_e({state:i.CLOSED,peerId:t}))},10)},onremovetrack:(e,t,n,r)=>{const{AdapterJS:s}=window,i=Ci(t.id),{peerInformations:o}=i,{MEDIA_STREAM:a,PEER_INFORMATIONS:d}=jt,c=s.webrtcDetectedBrowser===Ft.REACT_NATIVE?r.stream:r.target;Ji.log.INFO([e,Mt.MEDIA_STREAM,null,a.REMOTE_TRACK_REMOVED],{peerId:e,isSelf:!1,isScreensharing:n,track:r.track}),o[e]?c?(((e,t,n)=>{const r=e;delete r.peerInformations[t].mediaStatus[n],jo.setSkylinkState(r,r.room.id)})(i,e,c.id),((e,t,n,r,s)=>{xi(Se({room:e.room,peerId:t,peerInfo:fn.getPeerInfo(t,e.room),isSelf:!1,isScreensharing:n,streamId:s.id,isVideo:r.track.kind===yt.VIDEO,isAudio:r.track.kind===yt.AUDIO}))})(i,e,n,r,c),n&&(e=>{const{streams:t,room:n,user:r}=e;(t.userMedia?Object.values(t.userMedia):[]).forEach(e=>{bi(e.stream)&&xi(ce({stream:e.stream,streamId:e.id,peerId:r.sid,room:n,isSelf:!0,peerInfo:fn.getCurrentSessionInfo(n),isVideo:!0,isAudio:!1}))})})(i),((e,t)=>{xi(Te({peerId:t,peerInfo:fn.getPeerInfo(t,e.room),isSelf:!1}))})(i,e)):Ji.log.DEBUG([e,Mt.MEDIA_STREAM,null,""+a.ERRORS.DROPPING_ONREMOVETRACK-(""+a.NO_STREAM)]):Ji.log.DEBUG([e,Mt.MEDIA_STREAM,null,""+a.ERRORS.DROPPING_ONREMOVETRACK-`${d.NO_PEER_INFO} ${e}`])},onsenderadded:(e,t,n,r)=>{const s=jo.getSkylinkState(n.room.id),{sender:i}=r;Rs.processNewSender(s,t,i)}};var Ds=e=>{const{mid:t,rid:n,status:r,streamId:s,settings:i}=e,o=fi(n),{room:a,peerInformations:d}=o;if(r===Ot.SCREENSHARE_REPLACE_START&&(d[t].screenshare=!0,jo.setSkylinkState(o,a.id),xi(le({room:a,peerId:t,isSelf:!1,peerInfo:fn.getPeerInfo(t,a),stream:null,isReplace:!0,streamId:s,isVideo:!!i.audio,isAudio:!!i.video}))),r===Ot.USER_MEDIA_REPLACE_START&&xi(ce({room:a,peerId:t,isSelf:!1,peerInfo:fn.getPeerInfo(t,a),stream:null,streamId:s,isReplace:!0,replacedStreamId:i.replacedStreamId,isVideo:!!i.audio,isAudio:!!i.video})),r===Ot.ENDED&&(i.isScreensharing&&(d[t].screenshare=!1,jo.setSkylinkState(o,a.id)),xi(Se({room:a,peerId:t,peerInfo:fn.getPeerInfo(t,a),streamId:s,isSelf:!1,isScreensharing:i.isScreensharing,options:i,isVideo:!!i.audio,isAudio:!!i.video}))),r===Ot.REPLACED_STREAM_ENDED){const e=hn.retrieveRemoteStreams(o,t);if(!e)return null;const n=Object.values(e);let r=null;for(let t=0;t<n.length;t+=1)if(e[t].id===s){r=n[t];break}if(!r)return null;r.getTracks().forEach(e=>{_s.onremovetrack(t,a,s,e,!1)})}return null};var Ns=class extends Nn{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,state:null,recording_id:null,recordings:null,error:null}}send(e,t,n,r,s){const i=jo.getSkylinkState(e);this.model.client_id=i.clientId,this.model.appKey=jo.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.sid||null,this.model.state=t,this.model.recording_id=n,this.model.recordings=r,this.error=("string"==typeof s?s:s&&s.message)||null,this.postStats(this.endpoints.recording,this.model)}};const Ms=new Ns,Ps=(e,t,n)=>{const r={state:e,recordingId:t};n&&(r.error=n),xi(((e={})=>new de(Y,{detail:e}))(r))};const vs="startSuccess",ys="stopSuccess";var ws=(e,t,n,r,s)=>{const i=fn.getPeerInfo(n,e.room);xi(Ee({isSelf:!1,peerId:n,peerInfo:i,streamId:t,isAudio:r===yt.AUDIO,isVideo:r===yt.VIDEO,isScreensharing:s})),xi(Te({isSelf:!1,peerId:n,peerInfo:i}))};var bs={dispatchMediaStateChangeEvents:ws};var ks=(e,t)=>{const{type:n,rid:r,mediaId:s,mediaState:i,transceiverMid:o}=t,a=jo.getSkylinkState(r),{room:d}=a,c=Qs.retrieveStreamId(d,e,s,o),l=(new Date).toISOString();if(Ji.log.INFO([e,Mt.SIG_SERVER,n,jt.MEDIA_INFO.AUDIO_STATE_CHANGE,i,c],t),a.peerInformations[e]){if(a.peerMessagesStamps[e]){if(l<a.peerMessagesStamps[e].audioMuted)return void Ji.log.WARN([e,Mt.SIG_SERVER,n,jt.SIGNALING.OUTDATED_MSG],t);a.peerMessagesStamps[e].audioMuted=l}a.peerInformations[e].mediaStatus[c]||(a.peerInformations[e].mediaStatus[c]={}),a.peerInformations[e].mediaStatus[c].audioMuted=i===wt.MUTED||i===wt.STOPPED?Nt.MUTED:Nt.ACTIVE,jo.setSkylinkState(a,d.id),bs.dispatchMediaStateChangeEvents(a,c,e,yt.AUDIO,!1)}else Ji.log.WARN([e,Mt.PEER_INFORMATION,n,`${jt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`])};var Ls=(e,t)=>{const{type:n,rid:r,mediaId:s,mediaState:i,transceiverMid:o,mediaType:a}=t,d=jo.getSkylinkState(r),{room:c}=d,l=Qs.retrieveStreamId(c,e,s,o),S=(new Date).toISOString();if(Ji.log.INFO([e,Mt.SIG_SERVER,n,jt.MEDIA_INFO.VIDEO_STATE_CHANGE,i,l],t),d.peerInformations[e]){if(d.peerMessagesStamps[e]){if(S<d.peerMessagesStamps[e].videoMuted)return void Ji.log.WARN([e,Mt.SIG_SERVER,n,jt.SIGNALING.OUTDATED_MSG],t);d.peerMessagesStamps[e].videoMuted=S}d.peerInformations[e].mediaStatus[l]||(d.peerInformations[e].mediaStatus[l]={}),d.peerInformations[e].mediaStatus[l].videoMuted=i===wt.MUTED||i===wt.STOPPED?Nt.MUTED:Nt.ACTIVE,jo.setSkylinkState(d,c.id),bs.dispatchMediaStateChangeEvents(d,l,e,yt.VIDEO,a===Pt.VIDEO_SCREEN)}else Ji.log.WARN([e,Mt.PEER_INFORMATION,n,`${jt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`])};const Us=(e,t,n)=>{Ji.log.WARN([e,Mt.SIG_SERVER,`${jt.MEDIA_INFO.WARN.READ_ONLY_VALUE} ${n}`],t)},Gs=(e,t)=>{const{rid:n,mediaId:r,transceiverMid:s}=t,i=jo.getSkylinkState(n);Qs.updatePeerMediaInfo(i.room,e,r,bt.TRANSCEIVER_MID,s)},Fs=(e,t,n,r)=>{if(r.mediaState===wt.UNAVAILABLE)((e,t,n,r)=>{const{mediaId:s}=r;Qs.setMediaStateToUnavailable(e,n,s),Qs.deleteUnavailableMedia(e,n,s)})(e,0,n,r);else switch(t){case Pt.VIDEO_SCREEN:case Pt.VIDEO_CAMERA:case Pt.VIDEO_OTHER:case Pt.VIDEO:Ls(n,r);break;case Pt.AUDIO_MIC:case Pt.AUDIO:ks(n,r);break;default:Ji.log.ERROR([n,Mt.SIG_SERVER,`${jt.MEDIA_INFO.WARN.INVALID_MEDIA_TYPE} ${t}`],r)}},Bs=(e,t,n,r,s)=>{const i=jo.getSkylinkState(e),{peerMedias:o}=i,a=o[t][n];return a[r]&&a[r]!==s};var Vs={dispatchMuteEvents:ws,shouldDropMessage:(e,t)=>{const n=fn.getPeerInfo(t,e.room);return!(!n.agent.SDKVersion||n.agent.SDKVersion!==kt)&&(Ji.log.INFO([t,Mt.SIG_SERVER,null,jt.SIGNALING.DROPPING_MUTE_EVENT]),!0)}};var xs={userMessageHandler:Zn,answer:Lr,answerAck:Hr,inRoom:gr,enter:fr,offer:kr,welcome:Wr,candidate:jr,getPeerList:Kr,introduceError:Yr,stream:Ds,bye:qr,recording:e=>{const{action:t,rid:n,recordingId:r,error:s}=e,i=fi(n);"on"===t?((e,t)=>{const n=Object.assign({},e),{room:r}=n;Ji.log.DEBUG([Bt.MCU,Mt.RECORDING,t,jt.RECORDING.START_SUCCESS]),Ms.send(r.id,jt.STATS_MODULE.HANDLE_RECORDING_STATS.START,t,null,null),n.currentRecordingId=t,n.recordings[t]={active:!0,state:pt.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,error:null},n.recordingStartInterval=setTimeout(()=>{Ji.log.INFO([Bt.MCU,Mt.RECORDING,t,jt.RECORDING.MIN_RECORDING_TIME_REACHED]),n.recordingStartInterval=null},4e3),jo.setSkylinkState(n,r.id),Ps(pt.START,t)})(i,r):"off"===t?((e,t)=>{const n=Object.assign({},e),{room:r,recordings:s}=n;Ms.send(r.id,jt.STATS_MODULE.HANDLE_RECORDING_STATS.STOP,t,null,null),s[t]?(n.currentRecordingId=null,n.recordingStartInterval&&(clearTimeout(n.recordingStartInterval),Ji.log.WARN([Bt.MCU,Mt.RECORDING,t,jt.RECORDING.ERRORS.STOP_ABRUPT]),n.recordingStartInterval=null),Ji.log.DEBUG([Bt.MCU,Mt.RECORDING,t,jt.RECORDING.STOP_SUCCESS]),n.recordings[t].active=!1,n.recordings[t].state=pt.STOP,n.recordings[t].endedDateTime=(new Date).toISOString(),jo.setSkylinkState(n,r.id),Ps(pt.STOP,t)):Ji.log.ERROR([Bt.MCU,Mt.RECORDING,t,jt.RECORDING.ERRORS.SESSION_EMPTY])})(i,r):"error"===t&&(Ps(null,r,s),Ji.log.ERROR([Bt.MCU,Mt.RECORDING,r,jt.RECORDING.ERRORS.MCU_RECORDING_ERROR],s),Ms.send(i.room.id,jt.STATS_MODULE.HANDLE_RECORDING_STATS.MCU_RECORDING_ERROR,r,null,s))},redirect:e=>{var t;Ji.log.INFO(["Server",null,e.type,"System action warning:"],e),Object.keys((new So).getAllStates()).length>1&&e.action===Ze.REJECT&&Ni(),"toClose"===e.reason&&(e.reason="toclose"),jo.removeSkylinkState(jo.getSkylinkState(e.rid)),xi((t={action:e.action,info:e.info,reason:e.reason,rid:e.rid},new de(H,{detail:t})))},rtmp:e=>{const{action:t,rid:n}=e,r=fi(n);Ji.log.DEBUG([Bt.MCU,"RTMP",null,jt.RTMP.message_received_from_sig]),t===vs?((e,t)=>{const{rtmpSessions:n}=e,{rtmpId:r,peerId:s,streamId:i}=t;if(!n[r]){const t=Object.assign({},e);Ji.log.DEBUG([Bt.MCU,"RTMP",jt.RTMP.started_success]),t.rtmpSessions[r]={active:!0,state:Dt.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,peerId:s,streamId:i},xi(Pe({state:Dt.START,rtmpId:r,error:null})),jo.setSkylinkState(t,t.room.id)}})(r,e):t===ys?((e,t)=>{const{rtmpSessions:n}=e,{rtmpId:r}=t,s=Object.assign({},e);n[r]?(Ji.log.DEBUG([Bt.MCU,"RTMP",jt.RTMP.stopped_success]),s.rtmpSessions[r].active=!1,s.rtmpSessions[r].state=Dt.STOP,s.rtmpSessions[r].endedDateTime=(new Date).toISOString(),xi(Pe({state:Dt.STOP,rtmpId:r,error:null})),jo.setSkylinkState(s,s.room.id)):Ji.log.DEBUG([Bt.MCU,"RTMP",jt.RTMP.stop_session_empty])})(r,e):((e,t)=>{const{error:n,rtmpId:r}=t,{rtmpSessions:s}=e,i=new Error(n||"Unkown Error"),o=Object.assign({},e);s[r]?(Ji.log.DEBUG([Bt.MCU,"RTMP",jt.RTMP.error_session]),o.rtmpSessions[r].state=Dt.ERROR,o.rtmpSessions[r].error=i,s[r].active&&(Ji.log.DEBUG([Bt.MCU,"RTMP",jt.RTMP.error_Session_abrupt]),o.rtmpSessions[r].active=!1),xi(Pe({state:Dt.ERROR,rtmpId:r,error:i})),jo.setSkylinkState(o,o.room.id)):Ji.log.DEBUG([Bt.MCU,"RTMP",jt.RTMP.error_session_empty])})(r,e)},muteVideoEvent:e=>{const{type:t,mid:n,muted:r,rid:s,stamp:i,streamId:o}=e,a=n,d=jo.getSkylinkState(s),{room:c}=d;if(!Vs.shouldDropMessage(d,a))if(Ji.log.INFO([a,null,t,jt.MEDIA_STREAM.VIDEO_MUTED,r,o],e),d.peerInformations[a]){if(d.peerMessagesStamps[a]){if(i<d.peerMessagesStamps[a].videoMuted)return void Ji.log.WARN([a,Mt.SIG_SERVER,t,jt.SIGNALING.OUTDATED_MSG],e);d.peerMessagesStamps[a].videoMuted=i}d.peerInformations[a].mediaStatus[o]||(d.peerInformations[a].mediaStatus[o]={}),d.peerInformations[a].mediaStatus[o].videoMuted=r?Nt.MUTED:Nt.ACTIVE,jo.setSkylinkState(d,c.id),Vs.dispatchMuteEvents(d,o,a)}else Ji.log.WARN([a,Mt.PEER_INFORMATION,t,`${jt.PEER_INFORMATIONS.NO_PEER_INFO} ${a}`])},muteAudioEvent:e=>{const{type:t,mid:n,rid:r,muted:s,stamp:i,streamId:o}=e,a=n,d=jo.getSkylinkState(r),{room:c}=d;if(!Vs.shouldDropMessage(d,a))if(Ji.log.INFO([a,Mt.SIG_SERVER,t,jt.MEDIA_STREAM.AUDIO_MUTED,s,o],e),d.peerInformations[a]){if(d.peerMessagesStamps[a]){if(i<d.peerMessagesStamps[a].audioMuted)return void Ji.log.WARN([a,Mt.SIG_SERVER,t,jt.SIGNALING.OUTDATED_MSG],e);d.peerMessagesStamps[a].audioMuted=i}d.peerInformations[a].mediaStatus[o]||(d.peerInformations[a].mediaStatus[o]={}),d.peerInformations[a].mediaStatus[o].audioMuted=s?Nt.MUTED:Nt.ACTIVE,jo.setSkylinkState(d,c.id),Vs.dispatchMuteEvents(d,o,a)}else Ji.log.WARN([a,Mt.PEER_INFORMATION,t,`${jt.PEER_INFORMATIONS.NO_PEER_INFO} ${a}`])},setUserData:e=>{const{type:t,mid:n,rid:r,userData:s,stamp:i}=e,o=jo.getSkylinkState(r),{peerInformations:a,peerMessagesStamps:d}=o,c=n,{PEER_INFORMATIONS:l}=jt;let S=s.replace(/&quot;/g,'"');try{S=JSON.parse(S)}catch(e){Ji.log.INFO([c,null,t,""+l.USER_DATA_NOT_JSON],S)}finally{Ji.log.INFO([c,null,t,""+l.UPDATE_USER_DATA],S)}if(a[c]){if(d[c]&&Ii(i)){if(i<d[c].userData)return void Ji.log.WARN([c,null,t,""+l.OUTDATED_MSG],e);d[c].userData=i}a[c].userData=S||{},xi(Te({peerId:c,peerInfo:fn.getPeerInfo(c,o.room),isSelf:!1}))}else Ji.log.INFO([c,null,t,`${l.NO_PEER_INFO} ${c}`])},mediaInfoEvent:e=>{const{mid:t,rid:n,mediaType:r,mediaId:s,publisherId:i}=e,o=jo.getSkylinkState(n),{hasMCU:a,room:d}=o,c=a?i:t;try{if(!((e,t)=>{const n=e,{mediaId:r,publisherId:s}=t;return n.peerMedias[s]=n.peerMedias[s]||{},!n.peerMedias[s][r]&&(n.peerMedias[s][r]=t,jo.setSkylinkState(n,n.room.id),!0)})(o,e)){const t=Object.values(bt);for(let i=0;i<t.length;i+=1)if(Bs(n,c,s,t[i],e[t[i]])){if(Qs.updatePeerMediaInfo(o.room,c,s,t[i],e[t[i]]),t[i]===bt.MEDIA_STATE)return void Fs(d,r,c,e);if(t[i]===bt.TRANSCEIVER_MID)return void Gs(c,e);Us(c,e,t[i])}}}catch(e){Ji.log.ERROR([c,Mt.SIG_SERVER,jt.MEDIA_INFO.FAILED_PROCESSING_MEDIA_INFO_EVENT],e)}},storedMessages:e=>{qn.processStoredMessages(e)}};var Hs=class{userMessageHandler(...e){xs.userMessageHandler(...e)}answerHandler(...e){xs.answer(...e)}answerAckHandler(...e){xs.answerAck(...e)}inRoomHandler(...e){xs.inRoom(...e)}enterRoomHandler(...e){xs.enter(...e)}offerHandler(...e){xs.offer(...e)}welcomeHandler(...e){xs.welcome(...e)}candidateHandler(...e){xs.candidate(...e)}getPeerListHandler(...e){xs.getPeerList(...e)}introduceErrorHandler(...e){xs.introduceError(...e)}byeHandler(...e){xs.bye(...e)}streamHandler(...e){xs.stream(...e)}recordingHandler(...e){xs.recording(...e)}redirectHandler(...e){xs.redirect(...e)}rtmpHandler(...e){xs.rtmp(...e)}setUserDataHandler(...e){xs.setUserData(...e)}mediaInfoEventHandler(...e){xs.mediaInfoEvent(...e)}muteAudioEventHandler(...e){xs.muteAudioEvent(...e)}muteVideoEventHandler(...e){xs.muteVideoEvent(...e)}storedMessagesHandler(...e){xs.storedMessages(...e)}};var Ws={joinRoom:e=>{const{room:t}=e,n=jo.getSkylinkState(t.id),r=jo.getInitOptions();return{type:At.JOIN_ROOM,uid:n.user.uid,cid:n.key,rid:t.id,userCred:n.user.token,timeStamp:n.user.timeStamp,apiOwner:n.appKeyOwner,roomCred:t.token,start:t.startDateTime,len:t.duration,isPrivileged:n.isPrivileged,autoIntroduce:n.autoIntroduce,key:r.appKey}},enterRoom:e=>{const{room:t}=e,n=jo.getSkylinkState(t.id),r=jo.getInitOptions(),{user:s,peerPriorityWeight:i,enableIceRestart:o,hasMCU:a}=n,{enableDataChannel:d}=r,{AdapterJS:c}=window,l=fn.getUserInfo(t),S={type:At.ENTER,mid:s.sid,rid:t.id,agent:c.webrtcDetectedBrowser,version:(c.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:l,receiveOnly:fn.getCurrentSessionInfo(t).config.receiveOnly,weight:i,temasysPluginVersion:c.WebRTCPlugin.plugin?c.WebRTCPlugin.plugin.VERSION:null,enableDataChannel:d,enableIceRestart:o,SMProtocolVersion:dt,DTProtocolVersion:Le};return a&&(S.target=Bt.MCU,S.publisherId=s.sid),S},welcome:(e,t)=>{const n=jo.getSkylinkState(e.id),r=jo.getInitOptions(),{user:s,peerPriorityWeight:i,enableIceRestart:o,room:a}=n,{enableDataChannel:d}=r,{AdapterJS:c}=window,l=fn.getUserInfo(a);return{type:At.WELCOME,mid:s.sid,rid:a.id,agent:c.webrtcDetectedBrowser,version:(c.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:l,receiveOnly:fn.getCurrentSessionInfo(a).config.receiveOnly,weight:i,temasysPluginVersion:c.WebRTCPlugin.plugin?c.WebRTCPlugin.plugin.VERSION:null,enableDataChannel:d,enableIceRestart:o,SMProtocolVersion:dt,DTProtocolVersion:Le,target:t}},offer:(...e)=>oo.createOffer(...e),answer:(...e)=>oo.createAnswer(...e),answerAck:(e,t,n)=>{const{room:r,user:s}=e;return{type:At.ANSWER_ACK,rid:r.id,mid:s.sid,target:t,success:n}},candidate:(e,t,n)=>{const r=t.room.id,s=jo.getSkylinkState(r);return{type:At.CANDIDATE,label:n.sdpMLineIndex,id:n.sdpMid,candidate:n.candidate,mid:s.user.sid,target:e,rid:r}},setUserData:e=>({type:At.UPDATE_USER,mid:e.user.sid,rid:e.room.id,userData:Ai(e.userData)?e.userData:JSON.stringify(e.userData),stamp:(new Date).getTime()}),getPeerList:e=>({type:At.GET_PEERS,showAll:e}),restartOffer:(e,t,n)=>{const r=jo.getSkylinkState(e),{AdapterJS:s}=window,i=jo.getInitOptions(),{user:o,room:a,enableIceRestart:d,peerInformations:c,peerPriorityWeight:l}=r;return{type:At.RESTART,mid:o.sid,rid:a.id,agent:s.webrtcDetectedBrowser,version:(s.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:fn.getUserInfo(a),target:t,weight:l,receiveOnly:fn.getCurrentSessionInfo(a).config.receiveOnly,publishOnly:fn.getCurrentSessionInfo(a).config.publishOnly,enableDataChannel:i.enableDataChannel,enableIceRestart:d,doIceRestart:!0===n&&d&&c[t]&&c[t].config.enableIceRestart,isRestartResend:!1,temasysPluginVersion:s.WebRTCPlugin.plugin?s.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:dt,DTProtocolVersion:Le}},stream:(e,t,n,r,s)=>({type:At.STREAM,mid:t.sid,rid:e,status:r,streamId:n.id,settings:s}),recording:(e,t)=>({type:t,rid:e,target:Bt.MCU}),rtmp:(e,t,n,r,s=null,i=null)=>{const o={type:e,rid:t,rtmpId:r,streamId:s,endpoint:i,mid:n,target:Bt.MCU};return e===At.STOP_RTMP&&(delete o.endpoint,delete o.streamId),o},bye:(e,t)=>{const{room:n,user:r,hasMCU:s}=e,i={type:At.BYE,rid:n.id,mid:r.sid,target:t};return s&&(i.publisherId=r.sid),i},roomLock:e=>{const{user:t,room:n,roomLocked:r}=e;return{type:At.ROOM_LOCK,mid:t.sid,rid:n.id,lock:r}},mediaInfoEvent:(e,t,n)=>({type:At.MEDIA_INFO_EVENT,rid:e.room.id,mid:n.publisherId,target:t,publisherId:n.publisherId,mediaId:n.mediaId,mediaType:n.mediaType,mediaState:n.mediaState,transceiverMid:n.transceiverMid}),muteAudioEvent:(e,t)=>{const n=jo.getSkylinkState(e.id),{user:r,streamsMutedSettings:s}=n;return{type:At.MUTE_AUDIO_EVENT,mid:r.sid,rid:e.id,muted:s[t].audioMuted,stamp:(new Date).getTime(),streamId:t}},muteVideoEvent:(e,t)=>{const n=jo.getSkylinkState(e.id),{user:r,streamsMutedSettings:s}=n;return{type:At.MUTE_VIDEO_EVENT,mid:r.sid,rid:e.id,muted:s[t].videoMuted,stamp:(new Date).getTime(),streamId:t}},getStoredMessages:e=>{const{user:t,room:n}=e;return{mid:t.sid,rid:n.id,target:t.sid,type:At.GET_STORED_MESSAGES}},userMessages:(e,t,n)=>{const r=[],{user:s,room:i}=e,{listOfPeers:o,isPrivate:a,isPersistent:d,secretId:c}=t,l={data:n,mid:s.sid,rid:i.id,msgId:Mi(),type:At.MESSAGE};if(c&&(l.secretId=c),a)for(let e=0;e<o.length;e+=1){const t=o[e],s=Object.assign({},l);s.target=t,r.push(s),Ji.log.DEBUG([t,Mt.MESSAGING,null,jt.MESSAGING.PRIVATE_MESSAGE],{message:n})}else d&&(l.isPersistent=d),r.push(l),Ji.log.DEBUG([null,Mt.MESSAGING,null,jt.MESSAGING.BROADCAST_MESSAGE],{message:n});return r}};var js=class{constructor(){this.messageBuilders=Ws}getJoinRoomMessage(...e){return this.messageBuilders.joinRoom(...e)}getWelcomeMessage(...e){return this.messageBuilders.welcome(...e)}getEnterRoomMessage(...e){return this.messageBuilders.enterRoom(...e)}getAnswerMessage(...e){return this.messageBuilders.answer(...e)}getAnswerAckMessage(...e){return this.messageBuilders.answerAck(...e)}getOfferMessage(...e){return this.messageBuilders.offer(...e)}getCandidateMessage(...e){return this.messageBuilders.candidate(...e)}getSetUserDataMessage(e){return this.messageBuilders.setUserData(e)}getPeerListMessage(...e){return this.messageBuilders.getPeerList(...e)}getRestartOfferMessage(...e){return this.messageBuilders.restartOffer(...e)}getStreamMessage(...e){return this.messageBuilders.stream(...e)}getRecordingMessage(...e){return this.messageBuilders.recording(...e)}getPeerMessagesForSignaling(...e){return this.messageBuilders.signalingMessages(...e)}getMuteAudioMessage(...e){return this.messageBuilders.muteAudioEvent(...e)}getMuteVideoMessage(...e){return this.messageBuilders.muteVideoEvent(...e)}getRTMPMessage(...e){return this.messageBuilders.rtmp(...e)}getByeMessage(...e){return this.messageBuilders.bye(...e)}getRoomLockMessage(...e){return this.messageBuilders.roomLock(...e)}getMediaInfoEventMessage(...e){return this.messageBuilders.mediaInfoEvent(...e)}getGetStoredMessagesMessage(...e){return this.messageBuilders.getStoredMessages(...e)}getUserMessages(...e){return this.messageBuilders.userMessages(...e)}};const Ks="Polling",$s="WebSocket";let Ys=null;var Js=class{constructor(){return Ys||(Ys=this),this.socket=null,this.attempts=0,this.timestamp=(new Date).valueOf(),this.messageHandler=new Hs,this.messageBuilder=new js,this.config=null,Ys}resetSocketConfig(e){return{protocol:e,socketType:window.WebSocket?$s:Ks,signalingServerProtocol:e,socketSession:{finalAttempts:0,attempts:0},fallbackType:null,signalingServerPort:null,socketTimeout:!1}}createSocket(e){const t=jo.getSkylinkState(e);return t.socketSession=this.resetSocketConfig(t.signalingServerProtocol),jo.setSkylinkState(t,e),new Promise((t,n)=>{try{null!==this.socket&&this.socket instanceof window.io.Socket&&this.socket.connected?t():this.tryCreateSocket(e,t,n)}catch(r){this.handleCreateSocketFailure(e,t,n,r)}})}tryCreateSocket(e,t,n){const r=jo.getSkylinkState(e),{socketSession:s}=r;this.socket=an({config:s,roomKey:e}),((...e)=>{vn(...e)})(e,this,t,n)}handleCreateSocketFailure(e,t,n,r){const s=jo.getSkylinkState(e),{socketSession:i}=s;Ji.log.ERROR(jt.INIT.SOCKET_CREATE_FAILED,r),xi(Ne({session:Yt()(i),errorCode:ot.CONNECTION_FAILED,type:i.fallbackType,error:r})),n(r)}dispatchHandshakeProgress(e,t){xi(ge({peerId:e.user.sid,state:Qe[t],error:null,room:e.room}))}answer(...e){return this.messageBuilder.getAnswerMessage(...e).then(t=>{const n=e[0];return this.sendMessage(t),this.dispatchHandshakeProgress(n,"ANSWER"),t})}answerAck(...e){const t=this.messageBuilder.getAnswerAckMessage(...e),n=e[0];this.sendMessage(t),this.dispatchHandshakeProgress(n,"ANSWER_ACK")}enterRoom(...e){const t=this.messageBuilder.getEnterRoomMessage(...e);this.sendMessage(t),this.dispatchHandshakeProgress(...e,"ENTER")}joinRoom(...e){const t=this.messageBuilder.getJoinRoomMessage(...e);this.sendMessage(t)}offer(...e){const t=e[0],n=e[1],r=jo.getSkylinkState(t.id);r.peerConnections[n].negotiating?Ji.log.DEBUG([n,Mt.SIG_SERVER,null,""+jt.SIGNALING.ABORTING_OFFER]):this.messageBuilder.getOfferMessage(...e).then(e=>{this.sendMessage(e),this.dispatchHandshakeProgress(r,"OFFER")})}welcome(...e){const t=this.messageBuilder.getWelcomeMessage(...e);this.sendMessage(t)}noop(){return null}sendCandidate(...e){const t=this.messageBuilder.getCandidateMessage(...e);t&&this.sendMessage(t)}setUserData(e){const t=this.messageBuilder.getSetUserDataMessage(e);t&&this.sendMessage(t)}getPeerList(e){const t=this.messageBuilder.getPeerListMessage(e);t&&this.sendMessage(t)}stream(...e){const t=this.messageBuilder.getStreamMessage(...e);t&&this.sendMessage(t)}recording(...e){const t=this.messageBuilder.getRecordingMessage(...e);this.sendMessage(t)}rtmp(...e){const t=this.messageBuilder.getRTMPMessage(...e);this.sendMessage(t)}muteAudioEvent(e,t){const n=this.messageBuilder.getMuteAudioMessage(e,t);n&&this.sendMessage(n)}muteVideoEvent(e,t){const n=this.messageBuilder.getMuteVideoMessage(e,t);n&&this.sendMessage(n)}roomLock(e){const t=this.messageBuilder.getRoomLockMessage(e);t&&this.sendMessage(t)}bye(...e){const t=this.messageBuilder.getByeMessage(...e);this.sendMessage(t)}mediaInfoEvent(e,t,n){const r=this.messageBuilder.getMediaInfoEventMessage(e,t,n);r&&this.sendMessage(r)}getStoredMessages(e){const t=this.messageBuilder.getGetStoredMessagesMessage(e);t&&this.sendMessage(t)}onMessage(e){const t=jo.getSkylinkState(JSON.parse(e).rid);if(!t)return;const{socketSession:n}=t;var r;xi((r={message:e,socketSession:Yt()(n)},new de(F,{detail:r}))),((...e)=>{dn(...e)})(this.messageHandler,JSON.parse(e))}sendMessage(e){((...e)=>bn(...e))(e)||(Ji.log.INFO(["SIG SERVER",null,e.type,"sent"]),((e,t)=>{e.send(JSON.stringify(t))})(this.socket,e))}sendUserMessage(e,t,n){const r=this.messageBuilder.getUserMessages(e,t,n);Array.isArray(r)&&r.length&&r.map(e=>(this.sendMessage(e),null))}updateAttempts(e,t,n){this.attempts=n;const r=jo.getSkylinkState(e),{socketSession:s}=r;s.socketSession[t]=n,jo.setSkylinkState(r,e)}getAttempts(){return this.attempts}};var Xs={retrieveTransceiverMid:Jt,retrieveMediaState:Xt,retrieveMediaId:Qt,buildPeerMediaInfo:qt,retrieveStreamIdOfTrack:Zt,retrieveTracks:en,updatePeerMediaInfo:tn,sendMediaInfoMsg:(e,t)=>{const n=new Js,r=jo.getSkylinkState(e.id),{user:s,hasMCU:i,peerConnections:o}=r;(i?[Bt.MCU]:Object.keys(o).filter(e=>e!==s.sid&&e!==Bt.MCU)).forEach(e=>{n.mediaInfoEvent(r,e,t)})},parseSDPForTransceiverMid:(e,t,n)=>{const r=jo.getSkylinkState(e.id),{peerMedias:s}=r,{beSilentOnParseLogs:i}=jo.getInitOptions(),o=Object.values(s[t]),a=Zi.getTransceiverMid(n,i),d=a.audio,c=a.video;for(let n=0;n<o.length;n+=1){const r=o[n];r.transceiverMid=r.mediaState===wt.UNAVAILABLE?r.transceiverMid:null;for(let n=0;n<d.length;n+=1)if(d[n].streamId===r.streamId&&("sendonly"===d[n].direction||"sendrecv"===d[n].direction)){Xs.updatePeerMediaInfo(e,t,!1,r.mediaId,bt.TRANSCEIVER_MID,d[n].transceiverMid);break}for(let n=0;n<c.length;n+=1)if(c[n].streamId===r.streamId&&("sendonly"===c[n].direction||"sendrecv"===c[n].direction)){Xs.updatePeerMediaInfo(e,t,!1,r.mediaId,bt.TRANSCEIVER_MID,c[n].transceiverMid);break}}},retrieveValueGivenTransceiverMid:(e,t,n,r)=>{const{peerMedias:s}=e,i=Object.values(s[t]);for(let e=0;e<i.length;e+=1)if(i[e].transceiverMid===n)return i[e][r];return null},retrieveFormattedMediaInfo:(e,t)=>{const n=jo.getSkylinkState(e.id),{peerMedias:r}=n,s=Object.values(r[t]),i=[];for(let e=0;e<s.length;e+=1){const t=s[e],n=Yt()(t);delete n.trackId,delete n.streamId,i.push(n)}return i},resetPeerMedia:(e,t)=>{const n=jo.getSkylinkState(e.id);return n.peerMedias[t]&&(n.peerMedias[t]={}),n},populatePeerMediaInfo:(e,t,n)=>{const r=e.peerMedias[n.publisherId]||{};return r[n.mediaId]=n,((e,t)=>!ui(e)&&e[t])(t,n.mediaId)&&(r[n.mediaId].streamId=n.transceiverMid===t[n.mediaId].transceiverMid?t[n.mediaId].streamId:""),r},processOnRemoveTrack:(e,t,n)=>{const{AdapterJS:r}=window;if(r.webrtcDetectedBrowser===Ft.REACT_NATIVE&&n){const{room:r}=e,s={track:{id:null,kind:null}},i={id:null};if(s.track.id=n.trackId,s.track.kind=n.mediaType===Pt.AUDIO||n.mediaType===Pt.AUDIO_MIC?yt.AUDIO:yt.VIDEO,i.id=n.streamId,s.stream=i,!(s.track.id||s.track.kind||i.id))return void Ji.log.DEBUG([t,Mt.MEDIA_STREAM,null,""+jt.BROWSER_AGENT.REACT_NATIVE.ERRORS.DROPPING_ONREMOVETRACK],s);_s.onremovetrack(t,r,n.mediaType===Pt.VIDEO_SCREEN,s)}}};var Qs=class{static updatePeerMediaWithUserSid(e,t){const n=jo.getSkylinkState(e.id);n.peerMedias[t]=Object.assign({},n.peerMedias.null),delete n.peerMedias.null,jo.setSkylinkState(n,e.id),Object.keys(n.peerMedias[t]).forEach(n=>{Xs.updatePeerMediaInfo(e,t,!1,n,bt.PUBLISHER_ID,t)})}static updateStreamIdFromOntrack(e,t,n,r){const s=jo.getSkylinkState(e.id),i=Xs.retrieveValueGivenTransceiverMid(s,t,n,bt.MEDIA_ID);Xs.updatePeerMediaInfo(e,t,!1,i,bt.STREAM_ID,r)}static isVideoScreenTrack(e,t,n){const{peerMedias:r}=e,s=Object.values(r[t]);for(let e=0;e<s.length;e+=1)if(s[e].transceiverMid===n)return s[e].mediaType===Pt.VIDEO_SCREEN;return!1}static setMediaStateToUnavailable(e,t,n){Xs.updatePeerMediaInfo(e,t,!1,n,bt.MEDIA_STATE,wt.UNAVAILABLE)}static deleteUnavailableMedia(e,t,n=null){const r=jo.getSkylinkState(e.id);if(t===Bt.MCU||!r.peerMedias[t])return;let s;if(n)s=Yt()(r.peerMedias[t][n]),delete r.peerMedias[t][n];else{const e=r.peerMedias[t];Object.values(e).forEach(e=>{e.mediaState===wt.UNAVAILABLE&&(s=Yt()(e),delete r.peerMedias[t][e.mediaId])})}jo.setSkylinkState(r,e.id),Xs.processOnRemoveTrack(r,t,s),s&&xi(((e={})=>new de(se,{detail:e}))({mediaInfo:s}))}static updatePeerMediaInfo(e,t,n,r,s){Xs.updatePeerMediaInfo(e,t,!0,n,r,s)}static updateTransceiverMid(e,t){try{Xs.retrieveTracks(e).forEach(n=>{const r=Xs.retrieveTransceiverMid(e,n),s=Xs.retrieveStreamIdOfTrack(e,n),i=Xs.retrieveMediaId(n.kind,s);Xs.updatePeerMediaInfo(e,t,!1,i,bt.TRANSCEIVER_MID,r)})}catch(e){Ji.log.ERROR([t,Mt.PEER_MEDIA,null,jt.MEDIA_INFO.ERRORS.FAILED_UPDATING_TRANSCEIVER_MID],e)}}static setPeerMediaInfo(e,t,n=[]){try{const r=jo.getSkylinkState(e.id);if(t!==Bt.MCU||pi(n)){if(t!==Bt.MCU){const s=Yt()(r.peerMedias[t])||{},i=Xs.resetPeerMedia(e,t);n.forEach(e=>{i.peerMedias[e.publisherId]=Xs.populatePeerMediaInfo(i,s,e)}),jo.setSkylinkState(i,e.id)}}else{const t=[];n.forEach(e=>{-1===t.indexOf(e.publisherId)&&t.push(e.publisherId)}),t.forEach(t=>this.setPeerMediaInfo(e,t,n))}}catch(e){Ji.log.ERROR([t,Mt.PEER_MEDIA,null,jt.MEDIA_INFO.ERRORS.FAILED_SETTING_PEER_MEDIA_INFO])}}static retrieveStreamId(e,t,n,r){const s=jo.getSkylinkState(e.id),{peerMedias:i}=s,o=i[t][n],a=o.transceiverMid===r?o.streamId:null;return a||Ji.log.ERROR([t,Mt.PEER_MEDIA,null,jt.MEDIA_INFO.ERRORS.NO_ASSOCIATED_STREAM_ID]),a}static retrieveMediaId(e,t){return Xs.retrieveMediaId(e,t)}static retrieveMediaInfoForOfferAnswer(e,t){const n=jo.getSkylinkState(e.id).user.sid;return Xs.parseSDPForTransceiverMid(e,n,t),Xs.retrieveFormattedMediaInfo(e,n)}static processPeerMedia(e,t,n,r,s=!1){const i=jo.getSkylinkState(e.id).peerMedias[t]||{},o=n.getTracks();let a=null;try{o.forEach(o=>{a=Xs.retrieveMediaId(o.kind,n.id),i[a]=Xs.buildPeerMediaInfo(e,t,o,n.id,o.kind===yt.AUDIO?Pt.AUDIO_MIC:r?Pt.VIDEO_SCREEN:Pt.VIDEO_CAMERA),Xs.updatePeerMediaInfo(e,t,s,a,null,null,i[a])})}catch(e){Ji.log.ERROR([t,Mt.MEDIA_INFO,jt.MEDIA_INFO.ERRORS.FAILED_PROCESSING_PEER_MEDIA],e)}}};const qs=(e,t,n,r,s=!1)=>{const i=jo.getSkylinkState(r);return(bi(n)&&e||wi(n)&&t)&&xi(((e={})=>new de(J,{detail:e}))({streamId:n.id,isScreensharing:s,mediaStatus:i.streamsMediaStatus[n.id]})),!0},zs=(e,t,n)=>{let r=t;const{streams:{userMedia:s}}=e,i=n||Object.keys(s).filter(e=>s[e].isReplaced);if(0===i.length)return r;if(i.indexOf(r)>-1&&i.splice(i.indexOf(r),1),i.length>1)for(let t=0;t<i.length;t+=1)if(s[i[t]].newStream&&s[i[t]].newStream.id===r){r=i[t],zs(e,r,i);break}return i[0]},Zs=(e,t,n,r)=>{const s=jo.getSkylinkState(n.id),i=zs(s,r),{streamsMutedSettings:o}=s;if(e){const e=Qs.retrieveMediaId(yt.VIDEO,i);Qs.updatePeerMediaInfo(n,s.user.sid,e,bt.MEDIA_STATE,o[i].videoMuted?wt.MUTED:wt.ACTIVE)}if(t){const t=Qs.retrieveMediaId(yt.AUDIO,i);setTimeout(()=>Qs.updatePeerMediaInfo(n,s.user.sid,t,bt.MEDIA_STATE,o[i].audioMuted?wt.MUTED:wt.ACTIVE),e?1050:0)}},ei=(e,t,n)=>{const{streams:r,streamsMutedSettings:s}=e;let i=!1,o=!1;return r.screenshare&&r.screenshare.id===n&&s[n].videoMuted!==t.videoMuted?o=!0:r.userMedia&&r.userMedia[n]&&(wi(r.userMedia[n].stream)&&s[n].audioMuted!==t.audioMuted&&(i=!0),bi(r.userMedia[n].stream)&&s[n].videoMuted!==t.videoMuted&&(o=!0)),{hasToggledAudio:i,hasToggledVideo:o}},ti=(e,t,n)=>{const r=jo.getSkylinkState(e),{streams:s,room:i,peerConnections:o,peerInformations:a}=r,d=ei(r,n,t),{hasToggledAudio:c,hasToggledVideo:l}=d;let S=null,E=!1;if(s.userMedia&&s.userMedia[t]?S=s.userMedia[t].stream:s.screenshare&&s.screenshare.id===t&&(S=s.screenshare.stream,E=!0),S)if(((e,t,n)=>{const r=e,{room:s}=r;t.hasToggledAudio&&(r.streamsMutedSettings[n].audioMuted=!r.streamsMutedSettings[n].audioMuted),t.hasToggledVideo&&(r.streamsMutedSettings[n].videoMuted=!r.streamsMutedSettings[n].videoMuted),Ji.log.DEBUG(jt.MEDIA_STREAM.UPDATE_MUTED_SETTINGS,r.streamsMutedSettings,n),jo.setSkylinkState(r,s.id)})(r,d,t),((e,t)=>{const n=t,{room:r}=n,s=(e=>e.getAudioTracks())(e),i=(e=>e.getVideoTracks())(e);n.streamsMediaStatus[e.id].audioMuted=Nt.UNAVAILABLE,n.streamsMediaStatus[e.id].videoMuted=Nt.UNAVAILABLE,s.forEach(t=>{t.enabled=!n.streamsMutedSettings[e.id].audioMuted,n.streamsMediaStatus[e.id].audioMuted=n.streamsMutedSettings[e.id].audioMuted?Nt.MUTED:Nt.ACTIVE}),i.forEach(t=>{t.enabled=!n.streamsMutedSettings[e.id].videoMuted,n.streamsMediaStatus[e.id].videoMuted=n.streamsMutedSettings[e.id].videoMuted?Nt.MUTED:Nt.ACTIVE}),jo.setSkylinkState(n,r.id),Ji.log.DEBUG(jt.MEDIA_STREAM.UPDATE_MEDIA_STATUS,n.streamsMediaStatus,e.id)})(S,r),qs(l,c,S,i.id,E),(e=>{const t=jo.getSkylinkState(e.id).user.sid,n=fn.getCurrentSessionInfo(e);xi(Te({isSelf:!0,peerId:t,peerInfo:n}))})(i),((e,t,n)=>{const r=jo.getSkylinkState(e.id);xi(Ee({isSelf:!0,peerId:r.user.sid,peerInfo:fn.getUserInfo(e),streamId:t.id,isScreensharing:n,isAudio:wi(t),isVideo:bi(t)}))})(i,S,E),!o[Bt.MCU]&&pi(Object.keys(o))||o[Bt.MCU]&&pi(Object.keys(a))){const e=n=>{const{state:r}=n.detail;r===Qe.ANSWER_ACK&&(Zs(l,c,i,t),Vi(Wt.HANDSHAKE_PROGRESS,e))};Bi(Wt.HANDSHAKE_PROGRESS,e)}else setTimeout(()=>{Zs(l,c,i,t)},500)},ni=e=>{switch(e){case 1:return!1;case 0:default:return!0}};var ri=(e,t,n=null)=>{const{streams:r,room:s}=e;if(!Ri(t))return void Ji.log.ERROR(jt.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);if(!r.userMedia&&!r.screenshare)return void Ji.log.WARN(jt.MEDIA_STREAM.ERRORS.NO_STREAM);if(n&&!((e,t)=>{const{streams:n}=t;let r=!1;return Object.keys(n.userMedia).forEach(t=>{t===e&&(r=!0)}),n.screenshare&&n.screenshare.id===e&&(r=!0),r})(n,e))return void Ji.log.ERROR(jt.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);const i={audioMuted:Ti(t.audioMuted)?t.audioMuted:!Ii(t.audioMuted)||ni(t.audioMuted),videoMuted:Ti(t.videoMuted)?t.videoMuted:!Ii(t.videoMuted)||ni(t.videoMuted)};let o=[];if(n&&(r.userMedia[n]&&!r.userMedia[n].isReplaced||r.screenshare.id===n&&!r.screenshare.isReplaced)?o.push(n):(o=Object.keys(r.userMedia).filter(e=>!r.userMedia[e].isReplaced),r.screenshare&&!r.screenshare.isReplaced&&o.push(r.screenshare.id)),pi(o))return void Ji.log.ERROR(jt.MEDIA_STREAM.ERRORS.NO_STREAMS_MUTED,t);Object.values(o).filter(t=>ei(e,i,t).hasToggledAudio||ei(e,i,t).hasToggledVideo).forEach((e,t)=>{setTimeout(()=>ti(s.id,e,i),0===t?0:1050)})};const si=(e,t)=>{for(let n=0;n<t.length;n+=1)if(e.id===t[n].id)return!0;return!1},ii=(e,t)=>{const n=e.getTransceivers?e.getTransceivers():[],r=t.getTracks();if(pi(n))return!1;for(let e=0;e<n.length;e+=1)if(n[e].sender.track&&si(n[e].sender.track,r))return!0;return!1},oi=(e,t,n,r)=>{const s=e,i=n.getTracks();for(let e=0;e<i.length;e+=1){const o=r.addTrack(i[e],n);o&&Rs.processNewSender(s,t,o)}jo.setSkylinkState(s,s.room.id)};const ai=(e,t,n,r)=>{const{peerConnections:s}=e,i=s[t].getSenders();let o=null;return n?(i.forEach(e=>{e.track&&e.track.id===n&&e.track.kind===r&&(o=e)}),o):o};const di=(e,t)=>{const{user:n,room:r}=e,s=n.sid,i=fn.getCurrentSessionInfo(r);xi(ce({room:r,stream:t,streamId:t.id,isSelf:!0,peerId:s,peerInfo:i,isScreensharing:!1,isVideo:bi(t),isAudio:wi(t)})),xi(Te({isSelf:!0,peerId:s,peerInfo:i}))},ci=(e,t,n,r)=>{const{AdapterJS:s}=window,{peerConnections:i,hasMCU:o}=e;"edge"===s.webrtcDetectedBrowser&&r(new Error(jt.PEER_CONNECTION.refresh_no_edge_support));try{if(((e,t)=>{for(let n=0;n<t.length;n+=1)if(t[n])if(Array.isArray(t[n]))for(let r=0;r<t[n].length;r+=1)t[n][r]&&di(e,t[n][r]);else di(e,t[n])})(e,t),Object.keys(i).length>0||o){oo.refreshPeerConnection(Object.keys(i),e,!1,{}).then(()=>{n(t)}).catch(e=>{Ji.log.ERROR(jt.PEER_CONNECTION.ERRORS.REFRESH),r(e)})}else Ji.log.WARN(jt.ROOM.ERRORS.NO_PEERS),n(t)}catch(e){Ji.log.ERROR(e)}};const li=e=>{const t={audio:{input:[],output:[]},video:{input:[]}};return e.forEach(e=>{const n={deviceId:e.deviceId||e.sourceId||"default",label:e.label,groupId:e.groupId||null};n.label=n.label||"Source for "+n.deviceId,["audio","audioinput"].indexOf(e.kind)>-1?t.audio.input.push(n):["video","videoinput"].indexOf(e.kind)>-1?t.video.input.push(n):"audiooutput"===e.kind&&t.audio.output.push(n)}),t};const Si=(e,t,n,r)=>({id:n.id,stream:n,isReplaced:!1,settings:r.settings,constraints:r.getUserMediaSettings});var Ei={parseMediaOptions:Kt,processStreamInState:(e=null,t={},n,r=!1,s=!1)=>{if(!e)return;const i=jo.getSkylinkState(n);((e,t)=>{const{streams:n}=e;return!(!n.userMedia&&!n.screenshare)&&(!!(n.userMedia?Object.values(n.userMedia):[]).some(e=>e.id===t.id)||n.screenshare&&n.screenshare.id===t.id)})(i,e)||(Ei.processNewStream(i.room,e,t,r),Qs.processPeerMedia(i.room,i.user.sid,e,r),s&&Ji.log.DEBUG([i.user.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.FALLBACK_SUCCESS]),r&&Ji.log.DEBUG([i.user.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.START_SCREEN_SUCCESS]),xi(((e={})=>new de($,{detail:e}))({stream:e,isScreensharing:r,isAudioFallback:s,streamId:e.id,isAudio:wi(e),isVideo:bi(e)})))},parseStreamSettings:(e,t=null)=>{const{AdapterJS:n}=window,r={settings:{audio:!1,video:!1},mutedSettings:{shouldAudioMuted:!1,shouldVideoMuted:!1},getUserMediaSettings:{audio:!1,video:!1}};return(e.audio&&!t||e.audio&&t===yt.AUDIO)&&(r.settings.audio={stereo:!1,exactConstraints:!!e.useExactConstraints,echoCancellation:!0},r.getUserMediaSettings.audio={echoCancellation:!0},"object"==typeof e.audio&&("boolean"==typeof e.audio.stereo&&(r.settings.audio.stereo=e.audio.stereo),"boolean"==typeof e.audio.useinbandfec&&(r.settings.audio.useinbandfec=e.audio.useinbandfec),"boolean"==typeof e.audio.usedtx&&(r.settings.audio.usedtx=e.audio.usedtx),"number"==typeof e.audio.maxplaybackrate&&e.audio.maxplaybackrate>=8e3&&e.audio.maxplaybackrate<=48e3&&(r.settings.audio.maxplaybackrate=e.audio.maxplaybackrate),"boolean"==typeof e.audio.mute&&(r.mutedSettings.shouldAudioMuted=e.audio.mute),"edge"!==n.webrtcDetectedBrowser&&("boolean"==typeof e.audio.echoCancellation&&(r.settings.audio.echoCancellation=e.audio.echoCancellation,r.getUserMediaSettings.audio.echoCancellation=e.audio.echoCancellation),Array.isArray(e.audio.optional)&&(r.settings.audio.optional=Yt()(e.audio.optional),r.getUserMediaSettings.audio.optional=Yt()(e.audio.optional)),e.audio.deviceId&&"string"==typeof e.audio.deviceId&&"firefox"!==n.webrtcDetectedBrowser&&(r.settings.audio.deviceId=e.audio.deviceId,r.getUserMediaSettings.audio.deviceId=e.useExactConstraints?{exact:e.audio.deviceId}:{ideal:e.audio.deviceId}))),"edge"===n.webrtcDetectedBrowser&&(r.getUserMediaSettings.audio=!0)),(e.video&&!t||e.video&&t===yt.VIDEO)&&(r.settings.video={resolution:Yt()(Et.VGA),exactConstraints:!!e.useExactConstraints},r.getUserMediaSettings.video={},"object"==typeof e.video?("boolean"==typeof e.video.mute&&(r.mutedSettings.shouldVideoMuted=e.video.mute),Array.isArray(e.video.optional)&&(r.settings.video.optional=Yt()(e.video.optional),r.getUserMediaSettings.video.optional=Yt()(e.video.optional)),e.video.deviceId&&"string"==typeof e.video.deviceId&&(r.settings.video.deviceId=e.video.deviceId,r.getUserMediaSettings.video.deviceId=e.useExactConstraints?{exact:e.video.deviceId}:{ideal:e.video.deviceId}),e.video.resolution&&"object"==typeof e.video.resolution&&((e.video.resolution.width&&"object"==typeof e.video.resolution.width||"number"==typeof e.video.resolution.width)&&(r.settings.video.resolution.width=e.video.resolution.width),(e.video.resolution.height&&"object"==typeof e.video.resolution.height||"number"==typeof e.video.resolution.height)&&(r.settings.video.resolution.height=e.video.resolution.height)),r.getUserMediaSettings.video.width="object"==typeof r.settings.video.resolution.width?r.settings.video.resolution.width:e.useExactConstraints?{exact:r.settings.video.resolution.width}:{max:r.settings.video.resolution.width},r.getUserMediaSettings.video.height="object"==typeof r.settings.video.resolution.height?r.settings.video.resolution.height:e.useExactConstraints?{exact:r.settings.video.resolution.height}:{max:r.settings.video.resolution.height},(e.video.frameRate&&"object"==typeof e.video.frameRate||"number"==typeof e.video.frameRate&&"plugin"!==n.webrtcDetectedType)&&(r.settings.video.frameRate=e.video.frameRate,r.getUserMediaSettings.video.frameRate="object"==typeof r.settings.video.frameRate?r.settings.video.frameRate:e.useExactConstraints?{exact:r.settings.video.frameRate}:{max:r.settings.video.frameRate}),e.video.facingMode&&["string","object"].indexOf(typeof e.video.facingMode)>-1&&"plugin"===n.webrtcDetectedType&&(r.settings.video.facingMode=e.video.facingMode,r.getUserMediaSettings.video.facingMode="object"==typeof r.settings.video.facingMode?r.settings.video.facingMode:e.useExactConstraints?{exact:r.settings.video.facingMode}:{max:r.settings.video.facingMode})):r.getUserMediaSettings.video={width:e.useExactConstraints?{exact:r.settings.video.resolution.width}:{max:r.settings.video.resolution.width},height:e.useExactConstraints?{exact:r.settings.video.resolution.height}:{max:r.settings.video.resolution.height}},"edge"===n.webrtcDetectedBrowser&&(r.settings.video={exactConstraints:!!e.useExactConstraints},r.getUserMediaSettings.video=!0)),r},prepMediaAccessRequest:e=>new Promise((t,n)=>{const{roomKey:r,...s}=e,i=Ei.parseStreamSettings(s,yt.AUDIO),o=Ei.parseStreamSettings(s,yt.VIDEO),{AdapterJS:a}=window;i.getUserMediaSettings.audio||o.getUserMediaSettings.video||n(jt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),a.webRTCReady(()=>{window.navigator.mediaDevices.getUserMedia({audio:i.getUserMediaSettings.audio,video:o.getUserMediaSettings.video}).then(e=>{const n=Ei.onStreamAccessSuccess(r,e,i,o,!1),s=jo.getSkylinkState(r);n[0]&&i.mutedSettings.shouldAudioMuted&&ri(s,{audioMuted:i.mutedSettings.shouldAudioMuted,videoMuted:o.mutedSettings.shouldVideoMuted},n[0].id),n[1]&&o.mutedSettings.shouldVideoMuted&&ri(s,{audioMuted:i.mutedSettings.shouldAudioMuted,videoMuted:o.mutedSettings.shouldVideoMuted},n[1].id),t(n)}).catch(e=>Ei.onStreamAccessError(e,n,t,r,i,o))})}),addLocalMediaStreams:(e,t)=>{const n=jo.getSkylinkState(t.room.id),{peerConnections:r,streams:s}=n,i=r[e];s.userMedia&&((e,t,n,r)=>{const s=Object.keys(n);for(let i=0;i<s.length;i+=1){const{stream:o}=n[s[i]];ii(r,o)||oi(e,t,o,r)}})(n,e,s.userMedia,i),s.screenshare&&((e,t,n,r)=>{const{stream:s}=n;ii(r,s)||oi(e,t,s,r)})(n,e,s.screenshare,i)},onRemoteTrackAdded:(e,t,n,r,s,i)=>{const{user:o,hasMCU:a,room:d}=t,c={dispatchOnIncomingStream:e=>{xi(ce(e))},dispatchOnIncomingScreenStream:e=>{e.isReplace=!1,xi(le(e))}},l=r?"dispatchOnIncomingScreenStream":"dispatchOnIncomingStream",S={stream:e,peerId:n,room:d,isSelf:a&&n===o.sid||!1,peerInfo:fn.getPeerInfo(n,d),streamId:e.id,isVideo:s,isAudio:i};c[l](S),xi(Te({peerId:n,peerInfo:fn.getPeerInfo(n,d),isSelf:a&&n===o.sid||!1,room:d}))},onStreamAccessError:(e,t,n,r,s,i)=>{const o=jo.getInitOptions(),a=jo.getSkylinkState(r),{audioFallback:d}=o;if(s.settings.audio&&i.settings.video&&d){const o=!0;return Ji.log.DEBUG([a.user.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.START_FALLBACK]),xi(Me({error:e,state:ut.FALLBACKING,isAudioFallback:o})),window.navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>Ei.onStreamAccessSuccess(r,e,s,i,o,n)).catch(n=>{Ji.log.ERROR([a.user.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.ERRORS.FALLBACK,n]),xi(ve({error:n,isAudioFallbackError:!0})),xi(Me({error:e,state:ut.ERROR,isAudioFallback:o})),t(n)})}Ji.log.ERROR([a.user.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.ERRORS.GET_USER_MEDIA],e),xi(ve({error:e,isAudioFallbackError:!1})),t(e)},replaceTrack:(e,t,n,r)=>{const s=e.getVideoTracks()[0],i=e.getAudioTracks()[0],o=ai(r,n,s?s.id:null,"video"),a=ai(r,n,i?i.id:null,"audio"),d=t.getVideoTracks()[0],c=t.getAudioTracks()[0];try{s&&d&&o&&o.replaceTrack(d),i&&c&&a&&a.replaceTrack(c)}catch(e){Ji.log.ERROR([n,Mt.PEER_CONNECTION,null,jt.PEER_CONNECTION.ERRORS.REPLACE_TRACK],e)}},muteStreams:ri,sendStream:(e,t=null)=>new Promise((n,r)=>{if(!e)return r(new Error(jt.ROOM_STATE.NO_ROOM_NAME));const{inRoom:s}=e,{AdapterJS:i}=window,o=!(Ri(t)&&null!==t||i&&i.WebRTCPlugin&&i.WebRTCPlugin.plugin);if(!s)return Ji.log.WARN(jt.ROOM.ERRORS.NOT_IN_ROOM),r(new Error(""+jt.ROOM.ERRORS.NOT_IN_ROOM));if(o)return r(new Error(`${jt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${t}`));let a=!1;try{if(Array.isArray(t)){let s=!0;return t.forEach(e=>{hi(e.getAudioTracks)&&hi(e.getVideoTracks)||(s=!1)}),s?((e,t,n,r)=>{const s=[];return t.forEach(t=>{s.push(hn.usePrefetchedStream(e.room.id,t))}),Promise.all(s).then(t=>{ci(e,t,n,r)}).catch(e=>{r(e)})})(e,t,n,r):r(new Error(jt.MEDIA_STREAM.ERRORS.INVALID_MEDIA_STREAM_ARRAY))}return a=!!t&&(hi(t.getAudioTracks)||hi(t.getVideoTracks)),a?((e,t,n,r)=>hn.usePrefetchedStream(e.room.id,t).then(t=>{ci(e,t,n,r)}).catch(e=>{r(e)}))(e,t,n,r):((e,t,n,r)=>hn.getUserMedia(e,t).then(t=>{ci(e,t,n,r)}).catch(e=>{r(e)}))(e,t,n,r)}catch(e){Ji.log.ERROR(jt.MEDIA_STREAM.ERRORS.SEND_STREAM,e)}}),getStreamSources:()=>{const{navigator:e}=window;return new Promise((t,n)=>{e.mediaDevices&&hi(e.mediaDevices.enumerateDevices)?e.mediaDevices.enumerateDevices().then(e=>{t(li(e))}):n(li([]))})},getStreams:e=>{const{streams:{userMedia:t,screenshare:n}}=e,r={userMedia:null,screenshare:null};if(!t&&!n)return r;if(t){const e=Object.keys(t);r.userMedia={},e.forEach(e=>{r.userMedia[e]=t[e].stream})}return n&&(r.screenshare=n.stream),r},getScreenSources:()=>new Promise(e=>{const{navigator:t,AdapterJS:n}=window,r={mediaSource:[],mediaSourceInput:[]};return t.userAgent.toLowerCase().indexOf("android")>-1?("chrome"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=59&&(r.mediaSource=["screen"]),e(r),null):(("chrome"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=34||"firefox"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=38||"opera"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=21)&&("opera"!==n.webrtcDetectedBrowser||n.extensionInfo&&n.extensionInfo.opera&&n.extensionInfo.opera.extensionId||Ji.log.WARN("Please ensure that your application allows Opera screensharing!"),r.mediaSource=["window","screen"],"chrome"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=52||"opera"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=39?r.mediaSource.push("tab","audio"):"firefox"===n.webrtcDetectedBrowser&&r.mediaSource.push("browser","camera","application")),e(r),null)}),updateStreamsMediaStatus:(e,t,n)=>{const r=jo.getSkylinkState(e),{room:s,streamsMediaStatus:i}=r,{mutedSettings:{shouldAudioMuted:o},settings:{audio:a,video:d}}=t;i[n.id]={},i[n.id].audioMuted=a?o?Nt.MUTED:Nt.ACTIVE:Nt.UNAVAILABLE,i[n.id].videoMuted=d?o?Nt.MUTED:Nt.ACTIVE:Nt.UNAVAILABLE,jo.setSkylinkState(r,s.id)},updateRemoteStreams:(e,t,n)=>{const r=jo.getSkylinkState(e.id);r.remoteStreams[t]=r.remoteStreams[t]||{},r.remoteStreams[t][n.id]=n,jo.setSkylinkState(r,e.id)},retrieveVideoStreams:e=>{const t=jo.getSkylinkState(e.id),{streams:n}=t,r=[];return Object.values(n.userMedia).forEach(e=>{e.stream.getVideoTracks().length>0&&r.push(e.stream)}),r},splitAudioAndVideoStream:e=>{const{MediaStream:t}=window,n=[],r=e.getAudioTracks(),s=e.getVideoTracks();return wi(e)?n.push(new t(r)):n.push(null),bi(e)?n.push(new t(s)):n.push(null),n},processNewStream:(e,t,n,r)=>{((e,t,n,r)=>{const s=jo.getSkylinkState(e.id),i=r?"screenshare":"userMedia";r?s.streams[i]=Si(s.room,s.user,t,n):(s.streams[i]=s.streams[i]?s.streams[i]:{},s.streams[i][t.id]=Si(s.room,s.user,t,n)),jo.setSkylinkState(s,e.id)})(e,t,n,r),Ei.updateStreamsMutedSettings(e.id,n,t),Ei.updateStreamsMediaStatus(e.id,n,t)},updateStreamsMutedSettings:(e,t,n)=>{const r=jo.getSkylinkState(e),{room:s,streamsMutedSettings:i}=r,{audio:o,video:a}=t.settings;i[n.id]={},i[n.id].audioMuted=!o,i[n.id].videoMuted=!a,jo.setSkylinkState(r,s.id)},onStreamAccessSuccess:(e,t,n,r,s)=>{const i=Ei.splitAudioAndVideoStream(t);return i.forEach(t=>{t&&Ei.processStreamInState(t,wi(t)?n:r,e,!1,s)}),i}};const ui=e=>0===Object.keys(e).length,pi=e=>0===e.length,gi=e=>""===e,Ri=e=>"object"==typeof e&&null!==e,mi=e=>"object"==typeof e&&null==e,Ii=e=>"number"==typeof e,hi=e=>"function"==typeof e,Ti=e=>void 0!==e&&"boolean"==typeof e,Ai=e=>"string"==typeof e,Oi=(e,t,n)=>{let r=!0;return null!=e&&Ai(e)||(Ji.log.ERROR(`${n}: ${t} is null, undefined or not a string.`),r=!1),r},fi=e=>{if(Oi(e,"roomId","getStateByRid")){const t=jo.getSkylinkState(),n=Object.keys(t);let r=null;for(let s=0;s<n.length;s+=1){const i=n[s];if(i===e){r=t[i];break}}return r}return Ji.log.ERROR(`getRoomStateByRid: ${jt.ROOM_STATE.NOT_FOUND} - ${e}`),null},Ci=e=>fi(e),_i=e=>{let t=null;if(Oi(e,"roomName","getRoomStateByName")){const n=jo.getSkylinkState(),r=Object.keys(n);for(let s=0;s<r.length;s+=1){const i=n[r[s]];if(i.room.roomName.toLowerCase()===e.toLowerCase()){t=i;break}}}return t||Ji.log.ERROR(`getRoomStateByName: ${jt.ROOM_STATE.NOT_FOUND} - ${e}`),t},Di=(e,t)=>{const n=(e||"").split("."),r=(t||"").split(".");for(let e=0;e<r.length;e+=1)if((n[e]||"0")<(r[e]||"0"))return!0;return!1},Ni=()=>{try{(new Js).socket.disconnect()}catch(e){Ji.log.ERROR(e)}},Mi=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:n&&15).toString(16)})},Pi=e=>new Promise((t,n)=>{const{navigator:r}=window;e&&Ri(e)||n(new Error(`${jt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${e}`)),r.mediaDevices.getUserMedia(e).then(e=>{const n=Ei.splitAudioAndVideoStream(e);t(n)}).catch(e=>{n(e)})}),vi=e=>new Promise((t,n)=>{n(new Error(e))}),yi=(e,t)=>{const n=jo.getSkylinkState(e.id),{peerConnections:r}=n,s=Object.keys(r);let i=!1;return s.forEach(e=>{e===t&&(i=!0)}),i},wi=e=>e.getAudioTracks().length>0,bi=e=>e.getVideoTracks().length>0,ki=e=>{const{AdapterJS:t}=window;switch(e){case Ft.CHROME:return t.webrtcDetectedBrowser===Ft.CHROME;case Ft.SAFARI:return t.webrtcDetectedBrowser===Ft.SAFARI;case Ft.FIREFOX:return t.webrtcDetectedBrowser===Ft.FIREFOX;default:return Ji.log.DEBUG(jt.UTILS.INVALID_BROWSER_AGENT),!1}},Li=e=>{const{AdapterJS:t}=window;return t.webrtcDetectedVersion===e},Ui=e=>new Date(e).toISOString(),Gi=()=>(new Date).toISOString();const Fi=new class{constructor(){this.events={},this.privateEvents={}}addPrivateEventListener(e,t){this.addListener(e,t,!0)}addEventListener(e,t){this.addListener(e,t,!1)}addListener(e,t,n){try{const r=n?"privateEvents":"events";if(!hi(t))return void Ji.log.DEBUG([null,Mt.SKYLINK_EVENT,e,jt.LOGGER.INVALID_CB]);this[r][e]||(this[r][e]={}),this[r][e].callbacks||(this[r][e].callbacks=[]),this[r][e].callbacks.push(t),n||Ji.log.DEBUG([null,Mt.SKYLINK_EVENT,e,jt.LOGGER.EVENT_REGISTERED])}catch(t){Ji.log.ERROR([null,Mt.SKYLINK_EVENT,e,jt.LOGGER.EVENT_REGISTER_ERROR],t)}}dispatchEvent(e){if(e.name===Wt.LOGGED_ON_CONSOLE)return;let t=[];if(this.events[e.name]){const n=this.events[e.name].callbacks;t=t.concat(n)}else Ji.log.DEBUG([null,Mt.SKYLINK_EVENT,e.name,jt.LOGGER.EVENT_DISPATCHED]);if(this.privateEvents[e.name]){const n=this.privateEvents[e.name]?this.privateEvents[e.name].callbacks:[];t=t.concat(n)}t.forEach(t=>{try{t(e.detail)}catch(t){Ji.log.ERROR([null,Mt.SKYLINK_EVENT,e.name,jt.LOGGER.EVENT_DISPATCH_ERROR],t)}})}removeEventListener(e,t){this.removeListener(e,t,!1)}removePrivateEventListener(e,t){this.removeListener(e,t,!0)}removeListener(e,t,n){const r=n?"privateEvents":"events";if(n||this.events[e]&&this.events[e].callbacks)try{this[r][e].callbacks.forEach((s,i)=>{s===t&&(delete this[r][e].callbacks[i],n||Ji.log.DEBUG([null,Mt.SKYLINK_EVENT,e,jt.LOGGER.EVENT_UNREGISTERED]))})}catch(t){Ji.log.ERROR([null,Mt.SKYLINK_EVENT,e,jt.LOGGER.EVENT_DISPATCH_ERROR],t)}else Ji.log.WARN([null,Mt.SKYLINK_EVENT,e,jt.LOGGER.EVENT_UNREGISTERED])}},Bi=Fi.addPrivateEventListener.bind(Fi),Vi=Fi.removePrivateEventListener.bind(Fi),xi=Fi.dispatchEvent.bind(Fi);var Hi=Fi;const Wi=["trace","debug","info","warn","error"],ji=e=>{let t=!0;return("undefined"==typeof console||void 0===console[e])&&(t=!1),t},Ki=(e,t,n,r=null)=>{const s=`[${(new Date).toISOString()}]`,i=e.level,{logLevels:o}=e;if(i<=t&&i!==o.SILENT){const e=Wi[t];if(!ji(e))return;const i=(e=>{let t="SkylinkJS -";if(Array.isArray(e)){const[n,r,s,i]=e;if(t+=n?` [${n}]`:" -",t+=r?` <<${r}>>`:n?"":" <<Method>>",s)if(Array.isArray(s))for(let e=0;e<s.length;e+=1)t+=` (${s[e]})`;else t+=` (${s})`;t+=" "+i}else t+=" "+e;return t})(n);if(ji(e)&&(console[e](s,i,r||""),xi(((e={})=>new de(re,{detail:e}))({level:e,message:i,debugObject:r}))),Ji.storeLogs){const t=[s,e.toUpperCase(),i];r&&t.push(r),Ji.storedLogs.push(t)}}};class $i{constructor(){this.logLevels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},this.level=(e=>{const t=window.localStorage.getItem("loglevel:skylinkjs");return null===t||Number.isNaN(+t)?e.ERROR:+t})(this.logLevels),this.storeLogs=!1,this.storedLogs=[]}setLevel(e=this.levels.ERROR,t){"number"==typeof e?(this.level=e,(e=>{window.localStorage.setItem("loglevel:skylinkjs",e)})(this.level)):this.level=this.levels.ERROR,t&&(this.storeLogs=t)}enableAll(){this.setLevel(this.logLevels.TRACE)}disableAll(){this.setLevel(this.logLevels.SILENT)}getLogs(){return this.storeLogs?this.storedLogs:(this.log.WARN(jt.LOGGER.LOGS_NOT_STORED),null)}clearLogs(){this.log.INFO(jt.LOGGER.LOGS_CLEARED),this.storedLogs=[]}}const Yi=new $i;$i.prototype.log={TRACE:(...e)=>{Ki(Yi,Yi.logLevels.TRACE,...e)},DEBUG:(...e)=>{Ki(Yi,Yi.logLevels.DEBUG,...e)},INFO:(...e)=>{Ki(Yi,Yi.logLevels.INFO,...e)},WARN:(...e)=>{Ki(Yi,Yi.logLevels.WARN,...e)},ERROR:(...e)=>{Ki(Yi,Yi.logLevels.ERROR,...e)}};var Ji=Yi;const Xi=(e,t,n,r,s)=>{const i=e.sdp.match(new RegExp("m="+t+" .*\r\n","gi"));if(Array.isArray(i)&&i.length>0){const i=e.sdp.match(new RegExp("a=rtpmap:.* "+n+"/"+(r?r+("audio"===t?"[/]*.*":".*"):".*")+"\r\n","gi"));if(Array.isArray(i)&&i.length>0)for(let t=0;t<i.length;t+=1){const n=(i[t].split("a=rtpmap:")[1]||"").split(" ")[0];if(!n)continue;const r=e.sdp.match(new RegExp("a=fmtp:"+n+" .*\r\n","gi"));let o="a=fmtp:"+n+" ";const a=[];if(Array.isArray(r)&&r.length>0){const t=(r[0].split("a=fmtp:"+n+" ")[1]||"").replace(/ /g,"").replace(/\r\n/g,"").split(";");for(let e=0;e<t.length;e+=1){if(!t[e])continue;const n=t[e].split("=");s.hasOwnProperty(n[0])?o+="boolean"==typeof s[n[0]]?s[n[0]]?n[0]+"=1;":"":n[0]+"="+s[n[0]]+";":o+=t[e]+";",a.push(n[0])}e.sdp=e.sdp.replace(r[0],"")}for(const e in s)s.hasOwnProperty(e)&&-1===a.indexOf(e)&&(o+="boolean"==typeof s[e]?s[e]?e+"=1;":"":e+"="+s[e]+";",a.push(e));o!=="a=fmtp:"+n+" "&&(e.sdp=e.sdp.replace(i[t],i[t]+o+"\r\n"))}}};const Qi=e=>((e.match(/a=rtpmap:.*\ rtx\/.*\r\n/gi)||[]).forEach(t=>{const n=(t.split("a=rtpmap:")[1]||"").split(" ")[0]||"",r=(e.match(new RegExp("a=fmtp:"+n+" .*\r\n","gi"))||[])[0];if(!r)return void(e=e.replace(new RegExp(t,"g"),""));const s=(r.split(" apt=")[1]||"").replace(/\r\n/gi,"");e.match(new RegExp("a=rtpmap:"+s+" .*\r\n","gi"))||(e=(e=e.replace(new RegExp(t,"g"),"")).replace(new RegExp(r,"g"),""))}),e),qi=e=>((e.match(/a=(fmtp|rtcp-fb):.*\ rtx\/.*\r\n/gi)||[]).forEach(t=>{const n=(t.split("a="+(t.indexOf("rtcp")>0?"rtcp-fb":"fmtp"))[1]||"").split(" ")[0]||"";e.match(new RegExp("a=rtpmap:"+n+" .*\r\n","gi"))||(e=e.replace(new RegExp(t,"g"),""))}),e);var zi={getSDPCommonSupports:c,getSDPCodecsSupport:(e,t,n)=>{const r={audio:{},video:{}};if(!t||!t.sdp)return r;const s=t.sdp.split("\r\n");let i="";for(let e=0;e<s.length;e+=1)if(0!==s[e].indexOf("m=")){if(0===s[e].indexOf("a=rtpmap:")){const t=(s[e].split(" ")[1]||"").split("/"),n=(t[0]||"").toLowerCase(),o=t[1]+(t[2]?"/"+t[2]:"");if(["ulpfec","red","telephone-event","cn","rtx"].indexOf(n)>-1)continue;r[i][n]=r[i][n]||[],-1===r[i][n].indexOf(o)&&r[i][n].push(o)}}else i=(s[e].split("m=")[1]||"").split(" ")[0];return n||Ji.log.INFO([e||null,"RTCSessionDescription",t.type,"Parsed codecs support ->"],r),r},getCodecsSupport:e=>new Promise((t,n)=>{const r=jo.getSkylinkState(e),{beSilentOnParseLogs:s}=jo.getInitOptions(),i=r,{AdapterJS:o,RTCRtpSender:a,RTCPeerConnection:d}=window;r.currentCodecSupport&&t(r.currentCodecSupport),i.currentCodecSupport={audio:{},video:{}},"AppleWebKit"===o.webrtcDetectedType&&(i.currentCodecSupport.audio={opus:["48000/2"]},i.currentCodecSupport.video={h264:["48000"]},t(i.currentCodecSupport));try{if("edge"===window.webrtcDetectedBrowser){const{codecs:e}=a.getCapabilities();for(let t=0;t<e.length;t+=1)if(["audio","video"].indexOf(e[t].kind)>-1&&e[t].name){const n=e[t].name.toLowerCase();i.currentCodecSupport[e[t].kind][n]=e[t].clockRate+(e[t].numChannels>1?"/"+e[t].numChannels:"")}t(i.currentCodecSupport)}else{const e=new d(null),a="plugin"!==o.webrtcDetectedType?{offerToReceiveAudio:!0,offerToReceiveVideo:!0}:{mandatory:{OfferToReceiveVideo:!0,OfferToReceiveAudio:!0}};try{const t=e.createDataChannel("test");i.binaryChunkType=t.binaryType||r.binaryChunkType,i.binaryChunkType=r.binaryChunkType.toLowerCase().indexOf("array")>-1?ke.ARRAY_BUFFER:r.binaryChunkType;const n=Object.keys(ke);for(let e=0;e<n.length;e+=1)if(ke.hasOwnProperty(n)&&r.binaryChunkType.toLowerCase()===ke[n].toLowerCase()){i.binaryChunkType=ke[n];break}}catch(e){}e.createOffer(a).then(e=>{i.currentCodecSupport=Zi.getSDPCodecsSupport(null,e,s),t(i.currentCodecSupport)}).catch(e=>{n(e)})}}catch(e){n(e)}}),setSDPCodecParams:(e,t,n)=>{const r=jo.getSkylinkState(n),s=jo.getInitOptions();return Xi(t,"audio",lt.OPUS,48e3,(()=>{const e={},t=Object.keys(r.streams.userMedia);let n=r.streams.userMedia?r.streams.userMedia[t[0]].settings.audio:{};return n=n&&"object"==typeof n?n:{},"boolean"==typeof s.codecParams.audio.opus.stereo?e.stereo=s.codecParams.audio.opus.stereo:"boolean"==typeof n.stereo&&(e.stereo=n.stereo),"boolean"==typeof s.codecParams.audio.opus["sprop-stereo"]?e["sprop-stereo"]=s.codecParams.audio.opus["sprop-stereo"]:"boolean"==typeof n.stereo&&(e["sprop-stereo"]=n.stereo),"boolean"==typeof s.codecParams.audio.opus.usedtx?e.usedtx=s.codecParams.audio.opus.usedtx:"boolean"==typeof n.usedtx&&(e.usedtx=n.usedtx),"boolean"==typeof s.codecParams.audio.opus.useinbandfec?e.useinbandfec=s.codecParams.audio.opus.useinbandfec:"boolean"==typeof n.useinbandfec&&(e.useinbandfec=n.useinbandfec),"number"==typeof s.codecParams.audio.opus.maxplaybackrate?e.maxplaybackrate=s.codecParams.audio.opus.maxplaybackrate:"number"==typeof n.maxplaybackrate&&(e.maxplaybackrate=n.maxplaybackrate),"number"==typeof s.codecParams.audio.opus.minptime?e.minptime=s.codecParams.audio.opus.minptime:"number"==typeof n.minptime&&(e.minptime=n.minptime),e})()),Xi(t,"video",ct.VP8,null,(()=>{const e={};return"number"==typeof s.codecParams.video.vp8.maxFr&&(e["max-fr"]=s.codecParams.video.vp8.maxFr),"number"==typeof s.codecParams.video.vp8.maxFs&&(e["max-fs"]=s.codecParams.video.vp8.maxFs),e})()),Xi(t,"video",ct.VP9,null,(()=>{const e={};return"number"==typeof s.codecParams.video.vp9.maxFr&&(e["max-fr"]=s.codecParams.video.vp9.maxFr),"number"==typeof s.codecParams.video.vp9.maxFs&&(e["max-fs"]=s.codecParams.video.vp9.maxFs),e})()),Xi(t,"video",ct.H264,null,(()=>{const e={};return"string"==typeof s.codecParams.video.h264.levelAsymmetryAllowed&&(e["profile-level-id"]=s.codecParams.video.h264.profileLevelId),"boolean"==typeof s.codecParams.video.h264.levelAsymmetryAllowed&&(e["level-asymmetry-allowed"]=s.codecParams.video.h264.levelAsymmetryAllowed),"boolean"==typeof s.codecParams.video.h264.packetizationMode&&(e["packetization-mode"]=s.codecParams.video.h264.packetizationMode),e})()),t.sdp},removeSDPFilteredCandidates:(e,t,n)=>{const r=jo.getInitOptions(),s=jo.getSkylinkState(n);return e===Bt.MCU&&t.type===Qe.ANSWER&&"firefox"===window.webrtcDetectedBrowser&&(t.sdp=t.sdp.replace(/ generation 0/g,""),t.sdp=t.sdp.replace(/ udp /g," UDP ")),r.forceTURN&&s.hasMCU?(Ji.log.WARN([e,"RTCSessionDesription",t.type,"Not filtering ICE candidates as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured"]),t.sdp):(r.filterCandidatesType.host&&(Ji.log.INFO([e,"RTCSessionDesription",t.type,'Removing "host" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*host.*\r\n/g,"")),r.filterCandidatesType.srflx&&(Ji.log.INFO([e,"RTCSessionDesription",t.type,'Removing "srflx" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*srflx.*\r\n/g,"")),r.filterCandidatesType.relay&&(Ji.log.INFO([e,"RTCSessionDesription",t.type,'Removing "relay" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*relay.*\r\n/g,"")),t.sdp)},setSDPCodec:(e,t,n,r)=>{const i=jo.getInitOptions(n),o=(n,r)=>{const i="object"==typeof r?r.codec:r;let o="object"==typeof r?r.samplingRate:null,a="object"==typeof r?r.channels:null;if(i===s["audio"===n?"AUDIO_CODEC":"VIDEO_CODEC"].AUTO)return void Ji.log.WARN([e,"RTCSessionDesription",t.type,`Not preferring any codec for ${n} streaming. Using browser selection.`]);const d=t.sdp.match(new RegExp("m="+n+" .*\r\n","gi"));if(!(Array.isArray(d)&&d.length>0))return void Ji.log.ERROR([e,"RTCSessionDesription",t.type,`Not preferring any codec for ${n} streaming as m= line is not found.`]);const c=(r,s,c)=>{if(Array.isArray(r)&&r.length>0){s||(o=null),c||(a=null),Ji.log.INFO([e,"RTCSessionDesription",t.type,'Preferring "'+i+'" (samplingRate: '+(o||"n/a")+", channels: "+(a||"n/a")+') for "'+n+'" streaming.']);let l=d[0];const S=l.replace("\r\n","").split(" ");l=S[0]+" "+S[1]+" "+S[2]+" ",S.splice(0,3);for(let e=0;e<r.length;e+=1){const t=(r[e].split("a=rtpmap:")[1]||"").split(" ");t.length<2||(l+=t[0]+" ")}for(let e=0;e<S.length;e+=1)l.indexOf(" "+S[e])>0?(S.splice(e,1),e-=1):t.sdp.match(new RegExp("a=rtpmap:"+S[e]+" "+i+"/.*\r\n","gi"))&&(l+=S[e]+" ",S.splice(e,1),e-=1);return l+=S.join(" ")+"\r\n",t.sdp=t.sdp.replace(d[0],l),!0}};if(o){if("audio"===n&&a&&c(t.sdp.match(new RegExp("a=rtpmap:.* "+i+"/"+o+(1===a?"[/1]*":"/"+a)+"\r\n","gi")),!0,!0))return;if(c(t.sdp.match(new RegExp("a=rtpmap:.* "+i+"/"+o+"[/]*.*\r\n","gi")),!0))return}"audio"===n&&a&&c(t.sdp.match(new RegExp("a=rtpmap:.* "+i+"/.*/"+a+"\r\n","gi")),!1,!0)||c(t.sdp.match(new RegExp("a=rtpmap:.* "+i+"/.*\r\n","gi")))};return o("audio",r?r.audio:i.audioCodec),o("video",r?r.video:i.videoCodec),t.sdp},setSDPBitrate:(e,t,n)=>{const r=jo.getSkylinkState(n),s=t.sdp.split("\r\n"),i=function(n,r){let i=n,o=-1,a=-1;"data"===n&&(i="application");for(let e=0;e<s.length;e+=1)if(0===s[e].indexOf("m="+i))o=e;else if(o>0){if(0===s[e].indexOf("m="))break;0===s[e].indexOf("c=")?a=e:0!==s[e].indexOf("b=AS:")&&0!==s[e].indexOf("b:TIAS:")||(s.splice(e,1),e-=1)}"number"==typeof r&&r>0?-1!==a?(Ji.log.INFO([e,"RTCSessionDesription",t.type,`Limiting maximum sending ${n} bandwidth ->`],r),s.splice(a+1,0,"firefox"===window.webrtcDetectedBrowser?"b=TIAS:"+(1e3*r*(window.webrtcDetectedVersion>52&&window.webrtcDetectedVersion<55?1e3:1)).toFixed(0):"b=AS:"+r)):Ji.log.ERROR([e,"RTCSessionDesription",t.type,`Failed setting ${n} bandwidth as c-line is missing.`]):Ji.log.WARN([e,"RTCSessionDesription",t.type,`Not limiting ${n} bandwidth`])};let o=r.streamsBandwidthSettings.bAS.audio,a=r.streamsBandwidthSettings.bAS.video,d=r.streamsBandwidthSettings.bAS.data,c=r.streamsBandwidthSettings.googleX.min,l=r.streamsBandwidthSettings.googleX.max;if(r.peerCustomConfigs[e]&&(r.peerCustomConfigs[e].bandwidth&&"object"==typeof r.peerCustomConfigs[e].bandwidth&&("number"==typeof r.peerCustomConfigs[e].bandwidth.audio&&(o=r.peerCustomConfigs[e].bandwidth.audio),"number"==typeof r.peerCustomConfigs[e].bandwidth.video&&(a=r.peerCustomConfigs[e].bandwidth.video),"number"==typeof r.peerCustomConfigs[e].bandwidth.data&&(d=r.peerCustomConfigs[e].bandwidth.data)),r.peerCustomConfigs[e].googleXBandwidth&&"object"==typeof r.peerCustomConfigs[e].googleXBandwidth&&("number"==typeof r.peerCustomConfigs[e].googleXBandwidth.min&&(c=r.peerCustomConfigs[e].googleXBandwidth.min),"number"==typeof r.peerCustomConfigs[e].googleXBandwidth.max&&(l=r.peerCustomConfigs[e].googleXBandwidth.max))),i("audio",o),i("video",a),i("data",d),"number"==typeof c||"number"==typeof l){let n=null,r=-1,i=-1;for(let e=0;e<s.length;e+=1)if(0===s[e].indexOf("m=video"))n=s[e].split(" ")[3];else if(n){if(0===s[e].indexOf("m="))break;if(0===s[e].indexOf("a=rtpmap:"+n+" "))r=e;else if(0===s[e].indexOf("a=fmtp:"+n+" ")){s[e]=s[e].replace(/x-google-(min|max)-bitrate=[0-9]*[;]*/gi,""),i=e;break}}if(r>-1){let o="";"number"==typeof c&&(o+="x-google-min-bitrate="+c+";"),"number"==typeof l&&(o+="x-google-max-bitrate="+l+";"),Ji.log.INFO([e,"RTCSessionDesription",t.type,"Limiting x-google-bitrate ->"],o),i>-1?s[i]+=(s[i].split(" ")[1]?";":"")+o:s.splice(r+1,0,"a=fmtp:"+n+" "+o)}}return s.join("\r\n")},removeSDPCodecs:(e,t,n)=>{const r=jo.getSkylinkState(n),s=fn.getCurrentSessionInfo(r.room).settings.audio,i=jo.getInitOptions(),o=(n,r)=>{const s=t.sdp.match(new RegExp("a=rtpmap:(\\d*)\\ "+r+".*","gi"));if(Array.isArray(s)&&s.length>0)for(let i=0;i<s.length;i+=1){const o=s[i].split(" ")[0].split(":")[1];Ji.log.INFO([e,"RTCSessionDesription",t.type,'Removing "'+r+'" payload ->'],o),t.sdp=t.sdp.replace(new RegExp("a=rtpmap:"+o+"\\ .*\\r\\n","g"),""),t.sdp=t.sdp.replace(new RegExp("a=fmtp:"+o+"\\ .*\\r\\n","g"),""),t.sdp=t.sdp.replace(new RegExp("a=rtpmap:\\d+ rtx\\/\\d+\\r\\na=fmtp:\\d+ apt="+o+"\\r\\n","g"),"");const a=t.sdp.split("\r\n");for(let e=0;e<a.length;e+=1)if(0===a[e].indexOf("m="+n)){const t=a[e].split(" ");t.indexOf(o)>=3&&t.splice(t.indexOf(o),1),a[e]=t.join(" ");break}t.sdp=a.join("\r\n")}else Ji.log.WARN([e,"RTCSessionDesription",t.type,`Not removing ${r} as it does not exists.`])};return i.disableVideoFecCodecs&&(r.hasMCU?Ji.log.WARN([e,"RTCSessionDesription",t.type,'Not removing "ulpfec" or "red" codecs as connected to MCU to prevent connectivity issues.']):(o("video","red"),o("video","ulpfec"))),i.disableComfortNoiseCodec&&s&&"object"==typeof s&&s.stereo&&o("audio","CN"),"edge"===window.webrtcDetectedBrowser&&"edge"!==(((r.peerInformations[e]||{}).agent||{}).name||"unknown").name&&(t.sdp=t.sdp.replace(/a=rtcp-fb:.*\ x-message\ .*\r\n/gi,"")),t.sdp},removeSDPREMBPackets:(e,t)=>jo.getInitOptions().disableREMB?(Ji.log.INFO([e,"RTCSessionDesription",t.type,"Removing REMB packets."]),t.sdp.replace(/a=rtcp-fb:\d+ goog-remb\r\n/g,"")):t.sdp,handleSDPConnectionSettings:(e,t,n,r)=>{const s=jo.getSkylinkState(n);if(!s.sdpSessions[e])return t.sdp;const i=t.sdp.split("\r\n"),o=((s.peerInformations[e]||{}).agent||{}).name||"",a=[],d=Yt()(s.sdpSettings);let c="",l=-1,S=-1;if(e===Bt.MCU&&(d.connection.audio=!0,d.connection.video=!0,d.connection.data=!0),s.hasMCU){const t=Yt()(fn.getPeerInfo(e,s.room)).settings||{};d.direction.audio.receive=e===Bt.MCU||!!t.audio,d.direction.audio.send=e===Bt.MCU,d.direction.video.receive=e===Bt.MCU||!!t.video,d.direction.video.send=e===Bt.MCU}if("remote"===r){const r=Zi.getSDPCommonSupports(e,t,n);r.audio||(d.connection.audio=!1),r.video||(d.connection.video=!1)}s.sdpSessions[e][r].mLines=[],s.sdpSessions[e][r].bundleLine="",s.sdpSessions[e][r].connection={audio:null,video:null,data:null};for(let n=0;n<i.length;n+=1){if(0===i[n].indexOf("a=group:BUNDLE"))s.sdpSessions[e][r].bundleLine=i[n],l=n;else if(0===i[n].indexOf("m=")&&(c=(i[n].split("m=")[1]||"").split(" ")[0]||"",c="application"===c?"data":c,S+=1,s.sdpSessions[e][r].mLines[S]=i[n],!d.connection[c])){if(Ji.log.INFO([e,"RTCSessionDesription",t.type,`Removing rejected m=${c} line ->`],i[n]),s.peerConnectionConfig.bundlePolicy===Ye.MAX_BUNDLE&&l>-1&&0===S&&("remote"===r?t.type===Qe.OFFER:t.type===Qe.ANSWER)){Ji.log.WARN([e,"RTCSessionDesription",t.type,`Not removing rejected m='${c} line ->`],i[n]),d.connection[c]=!0,["audio","video"].indexOf(c)>-1&&(d.direction[c].send=!1,d.direction[c].receive=!1);continue}if("edge"===window.webrtcDetectedBrowser){i.splice(n,1),n-=1;continue}if("remote"===r||t.type===Qe.ANSWER){const e=i[n].split(" ");e[1]=0,i[n]=e.join(" ");continue}}if(c)if(d.connection[c]){if(0===i[n].indexOf("a=mid:"))a.push(i[n].split("a=mid:")[1]||"");else if(c&&["a=sendrecv","a=sendonly","a=recvonly"].indexOf(i[n])>-1){if(-1===["audio","video"].indexOf(c)){s.sdpSessions[e][r].connection.data=i[n];continue}if("local"===r)d.direction[c].send&&!d.direction[c].receive?i[n]=i[n].indexOf("send")>-1?"a=sendonly":"a=inactive":!d.direction[c].send&&d.direction[c].receive?i[n]=i[n].indexOf("recv")>-1?"a=recvonly":"a=inactive":d.direction[c].send||d.direction[c].receive||(i[n]="a=inactive"),s.hasMCU||"firefox"===window.webrtcDetectedBrowser||"firefox"!==o||t.type!==Qe.OFFER||"a=recvonly"!==i[n]||(Ji.log.WARN([e,"RTCSessionDesription",t.type,"Overriding any original settings to receive only to send and receive to resolve chrome BUNDLE errors."]),i[n]="a=sendrecv",d.direction[c].send=!0,d.direction[c].receive=!0);else if(t.type===Qe.ANSWER){const t=s.sdpSessions[e].local.connection[c];"a=sendonly"===t?i[n]=-1===["a=inactive","a=recvonly"].indexOf(i[n])?"a=sendonly"===i[n]?"a=inactive":"a=recvonly":i[n]:"a=recvonly"===t?i[n]=-1===["a=inactive","a=sendonly"].indexOf(i[n])?"a=recvonly"===i[n]?"a=inactive":"a=sendonly":i[n]:"a=inactive"===t&&(i[n]="a=inactive")}s.sdpSessions[e][r].connection[c]=i[n]}}else i.splice(n,1),n-=1;(i[n]||"").replace(/\n|\r|\s|\ /gi,"")||(i.splice(n,1),n-=1)}return l>-1&&(s.peerConnectionConfig.bundlePolicy===Ye.MAX_BUNDLE?i[l]="a=group:BUNDLE "+a.join(" "):s.peerConnectionConfig.bundlePolicy===Ye.NONE&&i.splice(l,1)),"edge"!==window.webrtcDetectedBrowser&&(i[i.length-1].replace(/\n|\r|\s/gi,"")?i.push(""):i[i.length-1]=""),Ji.log.INFO([e,"RTCSessionDesription",t.type,"Handling connection lines and direction ->"],d),i.join("\r\n")},removeSDPUnknownAptRtx:(e,t)=>{const n=t.sdp.split("m=");for(let e=0;e<n.length;e+=1)n[e]=Qi(n[e]),n[e]=qi(n[e]);return n.join("m=")},removeSDPFirefoxH264Pref:(e,t)=>(Ji.log.INFO([e,"RTCSessionDesription",t.type,"Removing Firefox experimental H264 flag to ensure interopability reliability"]),t.sdp.replace(/a=fmtp:0 profile-level-id=0x42e00c;packetization-mode=1\r\n/g,"")),renderSDPOutput:(e,t,n)=>{const r=jo.getSkylinkState(n);let s=null,i=null;if(!t||!t.sdp)return;if(!r.peerConnections[e])return t.sdp;r.peerConnections[e].localStream&&(s=r.peerConnections[e].localStream,i=r.peerConnections[e].localStreamId||r.peerConnections[e].localStream.id);const o=t.sdp.split("\r\n");if(s){let e="";for(let t=0;t<o.length;t+=1)if(0===o[t].indexOf("m="))e=(o[t].split("m=")[1]||"").split(" ")[0]||"",e=-1===["audio","video"].indexOf(e)?"":e;else if(e)if(0===o[t].indexOf("a=msid:")){const e=o[t].split(" ");e[0]="a=msid:"+i,o[t]=e.join(" ")}else if(0===o[t].indexOf("a=ssrc:")){let e=null;if(o[t].indexOf(" msid:")>0?e=o[t].split(" msid:"):o[t].indexOf(" mslabel:")>0&&(e=o[t].split(" mslabel:")),e){const n=(e[1]||"").split(" ");n[0]=i,e[1]=n.join(" "),o[t].indexOf(" msid:")>0?o[t]=e.join(" msid:"):o[t].indexOf(" mslabel:")>0&&(o[t]=e.join(" mslabel:"))}}}if(t.type===Qe.ANSWER&&r.sdpSessions[e]){let n=-1;for(let s=0;s<o.length;s+=1)if(0===o[s].indexOf("a=group:BUNDLE")&&r.sdpSessions[e].remote.bundleLine&&r.peerConnectionConfig.bundlePolicy===Ye.MAX_BUNDLE)o[s]=r.sdpSessions[e].remote.bundleLine;else if(0===o[s].indexOf("m=")){n+=1;const i=o[s].split(" "),a=(r.sdpSessions[e].remote.mLines[n]||"").split(" ");i[0]&&a[0]&&i[0]!==a[0]&&(a[1]=0,Ji.log.INFO([e,"RTCSessionDesription",t.type,"Appending middle rejected m= line ->"],a.join(" ")),o.splice(s,0,a.join(" ")),s+=1,n+=1)}for(;r.sdpSessions[e].remote.mLines[n+1];){n+=1;let s=o.length;o[s-1].replace(/\s/gi,"")||(s-=1);const i=(r.sdpSessions[e].remote.mLines[n]||"").split(" ");i[1]=0,Ji.log.INFO([e,"RTCSessionDesription",t.type,"Appending later rejected m= line ->"],i.join(" ")),o.splice(s,0,i.join(" "))}}return"edge"!==window.webrtcDetectedBrowser||t.type!==Qe.OFFER||o[o.length-1].replace(/\s/gi,"")||(Ji.log.INFO([e,"RTCSessionDesription",t.type,"Removing last empty space for Edge browsers"]),o.splice(o.length-1,1)),Ji.log.INFO([e,"RTCSessionDescription",t.type,"Formatted output ->"],o.join("\r\n")),o.join("\r\n")},getSDPICECandidates:(e,t,n)=>{const{RTCIceCandidate:r}=window,s={host:[],srflx:[],relay:[]};return t&&t.sdp?(t.sdp.split("m=").forEach((e,t)=>{if(0===t)return;const n=((e.match(/a=mid:.*\r\n/gi)||[])[0]||"").replace(/a=mid:/gi,"").replace(/\r\n/,""),i=t-1;(e.match(/a=candidate:.*\r\n/gi)||[]).forEach(e=>{const t=(e.split(" ")[7]||"host").replace(/\r\n/g,"");s[t]=s[t]||[],s[t].push(new r({sdpMid:n,sdpMLineIndex:i,candidate:(e.split("a=")[1]||"").replace(/\r\n/g,"")}))})}),n||Ji.log.INFO([e,"RTCSessionDesription",t.type,"Parsing session description ICE candidates ->"],s),s):s},getSDPSelectedCodec:(e,t,n,r)=>{const s={name:null,implementation:null,clockRate:null,channels:null,payloadType:null,params:null};return t&&t.sdp?(t.sdp.split("m=").forEach((e,t)=>{if(0===t||0!==e.indexOf(n+" "))return;const r=(e.split("\r\n")[0]||"").split(" ");r.splice(0,3);for(let t=0;t<r.length;t+=1){const n=e.match(new RegExp(`a=rtpmap:${r[t]}.*\r\n`,"gi"));if(!n)continue;const i=((n[0]||"").replace(/\r\n/g,"").split(" ")[1]||"").split("/");if(!(["red","ulpfec","telephone-event","cn","rtx"].indexOf(i[0].toLowerCase())>-1)){s.name=i[0],s.clockRate=parseInt(i[1],10)||0,s.channels=parseInt(i[2]||"1",10)||1,s.payloadType=parseInt(r[t],10),s.params="",(e.match(new RegExp(`a=fmtp:${r[t]}.*\r\n`,"gi"))||[]).forEach(e=>{s.params+=e.replace(new RegExp("a=fmtp:"+r[t],"gi"),"").replace(/ /g,"").replace(/\r\n/g,"")});break}}}),r||Ji.log.INFO([e,"RTCSessionDesription",t.type,`Parsing session description "${n}" codecs ->`],s),s):s},setOriginalDTLSRole:(e,t,n)=>{const{room:r}=e,{type:s}=t,i=t.sdp.match(/a=setup:([a-z]+)/);if(null!==e.originalDTLSRole||"offer"===s)return;if(!i)return;const o=i[1];e.originalDTLSRole=n?{active:"passive",passive:"active"}[o]:o,jo.setSkylinkState(e,r.id)},modifyDTLSRole:(e,t)=>{const{originalDTLSRole:n}=e,{type:r}=t;return null===n||"offer"===r||(t.sdp=t.sdp.replace(/a=setup:[a-z]+/g,"a=setup:"+n)),t.sdp},getTransceiverMid:(e,t)=>{const n={audio:[],video:[]};return e.sdp.split("m=").forEach((e,t)=>{const r=e.split(/\n/),s=r[0].split(" ")[0];if("application"===s||0===t)return;let i={};for(let e=0;e<r.length;e+=1){if(r[e].match(/a=recvonly|a=sendonly|a=sendrecv|a=inactive/)){const t=r[e].split("=");i.direction=t[1].trim()}if(r[e].match(/a=mid:*/)&&(i.transceiverMid=r[e].split(/:/)[1].trim()),r[e].match(/a=msid:([\w|-|{]+)/)){const t=r[e].split(" "),n=t[0].split(/:/)[1].trim();i.streamId="-"===n?"":n,i.trackId=t[1].trim()}i.transceiverMid&&i.streamId&&i.trackId&&(n[s].push(i),i={})}}),t||Ji.log.INFO([null,"RTCSessionDesription",e.type,`Parsing session description "${e.type}" transceivers ->`],n),n}};var Zi=class{static getSDPCommonSupports(...e){return zi.getSDPCommonSupports(...e)}static getCodecsSupport(...e){return zi.getCodecsSupport(...e)}static setSDPCodecParams(...e){return zi.setSDPCodecParams(...e)}static removeSDPFilteredCandidates(...e){return zi.removeSDPFilteredCandidates(...e)}static setSDPCodec(...e){return zi.setSDPCodec(...e)}static setSDPBitrate(...e){return zi.setSDPBitrate(...e)}static removeSDPCodecs(...e){return zi.removeSDPCodecs(...e)}static removeSDPREMBPackets(...e){return zi.removeSDPREMBPackets(...e)}static handleSDPConnectionSettings(...e){return zi.handleSDPConnectionSettings(...e)}static removeSDPUnknownAptRtx(...e){return zi.removeSDPUnknownAptRtx(...e)}static getSDPCodecsSupport(...e){return zi.getSDPCodecsSupport(...e)}static removeSDPFirefoxH264Pref(...e){return zi.removeSDPFirefoxH264Pref(...e)}static renderSDPOutput(...e){return zi.renderSDPOutput(...e)}static getSDPICECandidates(...e){return zi.getSDPICECandidates(...e)}static getSDPSelectedCodec(...e){return zi.getSDPSelectedCodec(...e)}static setOriginalDTLSRole(...e){return zi.setOriginalDTLSRole(...e)}static modifyDTLSRole(...e){return zi.modifyDTLSRole(...e)}static getTransceiverMid(...e){return zi.getTransceiverMid(...e)}};const eo=e=>"relay"===e?"relayed":"host"===e||e.indexOf("host")>-1?"local":"srflx"===e?"serverreflexive":"prflx"===e?"peerreflexive":e;var to={parseSelectedCandidatePair:(e,t,n,r,s,i,o)=>{const{peerBandwidth:a,peerStats:d}=e,{raw:c,selectedCandidatePair:l}=t,{AdapterJS:S}=window,E=Object.keys(t.raw);let u=null,p=null,g=null;if(S.webrtcDetectedBrowser===Ft.CHROME)for(let e=0;e<E.length;e+=1)"transport"===c[E[e]].type&&(u=c[E[e]]);else S.webrtcDetectedBrowser===Ft.FIREFOX&&(u={});if(u)for(let e=0;e<E.length;e+=1){const t=c[E[e]];if("candidate-pair"===t.type&&t.id===u.selectedCandidatePairId||"candidate-pair"===t.type&&t.selected){const e=t;p=e.localCandidateId,g=e.remoteCandidateId,l.id=e.id,l.writable=e.writable,l.priority=e.priority,l.nominated=e.nominated;const n=o?a[i][t.id]:d[i][t.id],r=parseInt(t.totalRoundTripTime||"0",10);l.totalRoundTripTime=r,l.roundTripTime=to.tabulateStats(n,t,"totalRoundTripTime");const s=parseInt(t.consentRequestsSent||"0",10);l.consentRequests.totalSent=s,l.consentRequests.sent=to.tabulateStats(n,t,"consentRequestsSent");const c=parseInt(t.requestsReceived||"0",10);l.requests.totalReceived=c,l.requests.received=to.tabulateStats(n,t,"requestsReceived");const S=parseInt(t.requestsSent||"0",10);l.requests.totalSent=S,l.requests.sent=to.tabulateStats(n,t,"requestsSent");const E=parseInt(t.responsesSent||"0",10);l.responses.totalSent=E,l.responses.sent=to.tabulateStats(n,t,"responsesSent");const u=parseInt(t.responsesReceived||"0",10);l.responses.totalReceived=u,l.responses.received=to.tabulateStats(n,t,"responsesReceived")}}if(p&&g){if("remote-candidate"===n){const e=r;e.id===g&&(l.remote.ipAddress=e.ip?e.ip:e.address,l.remote.portNumber=e.port,l.remote.transport=e.protocol,l.remote.priority=e.priority,l.remote.candidateType=eo(e.candidateType))}if("local-candidate"===n){const e=r;e.id===p&&(l.local.ipAddress=e.ip?e.ip:e.address,l.local.portNumber=e.port,l.local.transport=e.protocol,l.local.priority=e.priority,l.local.networkType=e.networkType,l.local.candidateType=eo(e.candidateType))}}},parseCertificates:(e,t)=>{const{certificate:n,raw:r}=e,s=Object.keys(e.raw);let i=null;for(let e=0;e<s.length;e+=1)"transport"===r[s[e]].type&&(i=r[s[e]]);if(i){n.srtpCipher=i.srtpCipher,n.dtlsCipher=i.dtlsCipher,n.tlsVersion=i.tlsVersion;const{localCertificateId:e,remoteCertificateId:r}=i;t.id===e?(n.local={},n.local.base64Certificate=t.base64Certificate,n.local.fingerprintAlgorithm=t.fingerprintAlgorithm):t.id===r&&(n.remote={},n.remote.base64Certificate=t.base64Certificate,n.remote.fingerprintAlgorithm=t.fingerprintAlgorithm)}},tabulateStats:(e=null,t,n)=>{const r=t.timestamp,s=e&&e.timestamp||0,i=parseFloat(t[n]||"0",10),o=parseFloat(e&&e[n]||"0",10);return new Date(r).getTime()===new Date(s).getTime()?i:parseFloat(((i-o)/(r-s)*1e3).toFixed(3)||"0",10)},parseAudio:(e,t,n,r,s,i,o)=>{const{peerBandwidth:a,peerStats:d}=e,c=i?a[s][r.id]:d[s][r.id];switch(o){case"receiving":((e,t,n)=>{const r=e.audio.receiving,s=parseInt(t.packetsReceived||"0",10);r.totalPackets=s,r.packets=to.tabulateStats(n,t,"packetsReceived");const i=parseInt(t.bytesReceived||"0",10);r.totalBytes=i,r.bytes=to.tabulateStats(n,t,"bytesReceived");const o=parseInt(t.packetsLost||"0",10);r.totalPacketsLost=o,r.packetsLost=to.tabulateStats(n,t,"packetsLost"),r.jitter=parseInt(t.jitter||"0",10),r.ssrc=t.ssrc;const{trackId:a}=t,d=e.raw[a];d&&(r.audioLevel=parseFloat(d.audioLevel).toFixed(5),r.totalSamplesReceived=parseInt(d.totalSamplesReceived||"0",10),r.totalSamplesDuration=parseInt(d.totalSamplesDuration||"0",10))})(t,r,c);break;case"sending":((e,t,n)=>{const r=e.audio.sending;if(t.bytesSent){const e=parseInt(t.bytesSent||"0",10);r.totalBytes=e,r.bytes=to.tabulateStats(n,t,"bytesSent")}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);r.totalPackets=e,r.packets=to.tabulateStats(n,t,"packetsSent")}if(t.retransmittedBytesSent||Ii(t.retransmittedBytesSent)){const e=parseInt(t.retransmittedBytesSent||"0",10);r.totalRetransmittedBytesSent=e,r.retransmittedBytesSent=to.tabulateStats(n,t,"retransmittedBytesSent")}if(t.retransmittedPacketsSent||Ii(t.retransmittedPacketsSent)){const e=parseInt(t.retransmittedPacketsSent||"0",10);r.totalRetransmittedPacketsSent=e,r.retransmittedPacketsSent=to.tabulateStats(n,t,"retransmittedPacketsSent")}r.ssrc=t.ssrc,t.jitter&&(r.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(r.roundTripTime=parseInt(t.roundTripTime||"0",10));const{trackId:s,mediaSourceId:i}=t,o=e.raw[s];o&&(r.echoReturnLoss=parseInt(o.echoReturnLoss||"0",10),r.echoReturnLossEnhancement=parseInt(o.echoReturnLossEnhancement||"0",10));const a=e.raw[i];a&&(r.audioLevel=parseFloat(a.audioLevel).toFixed(5),r.totalSamplesDuration=parseInt(a.totalSamplesDuration||"0",10))})(t,r,c);break;default:Ji.log.DEBUG([s,Mt.STATS_MODULE,null,jt.STATS_MODULE.ERRORS.PARSE_FAILED])}},parseVideo:(e,t,n,r,s,i,o)=>{const{peerBandwidth:a,peerStats:d}=e,c=i?a[s][r.id]:d[s][r.id];switch(o){case"receiving":((e,t,n)=>{const r=e.video.receiving;if(t.bytesReceived){const e=parseInt(t.bytesReceived||"0",10);r.totalBytes=e,r.bytes=to.tabulateStats(n,t,"bytesReceived")}if(t.packetsReceived){const e=parseInt(t.packetsReceived||"0",10);r.totalPackets=e,r.packets=to.tabulateStats(n,t,"packetsReceived")}if(Number.isInteger(t.packetsLost)){const e=parseInt(t.packetsLost||"0",10);r.totalPacketsLost=e,r.packetsLost=to.tabulateStats(n,t,"packetsLost")}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);r.totalFirs=e,r.firs=to.tabulateStats(n,t,"firCount")}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);r.totalNacks=e,r.nacks=to.tabulateStats(n,t,"nackCount")}if(t.pliCount||Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);r.totalPlis=e,r.plis=to.tabulateStats(n,t,"pliCount")}r.ssrc=t.ssrc,r.qpSum=parseInt(t.qpSum||"0",10),r.decoderImplementation=t.decoderImplementation;const{trackId:s}=t,i=e.raw[s];i&&(r.framesDropped=parseFloat(i.framesDropped||"0"),r.frames=parseInt(i.framesReceived||"0",10),r.framesDecoded=parseInt(i.framesDecoded||"0",10),r.frameWidth=parseInt(i.frameWidth||"0",10),r.frameHeight=parseInt(i.frameHeight||"0",10))})(t,r,c);break;case"sending":((e,t,n)=>{const r=e.video.sending;if(t.bytesSent){const e=parseInt(t.bytesSent||"0",10);r.totalBytes=e,r.bytes=to.tabulateStats(n,t,"bytesSent")}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);r.totalPackets=e,r.packets=to.tabulateStats(n,t,"packetsSent")}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);r.totalFirs=e,r.firs=to.tabulateStats(n,t,"firCount")}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);r.totalNacks=e,r.nacks=to.tabulateStats(n,t,"nackCount")}if(Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);r.totalPlis=e,r.plis=to.tabulateStats(n,t,"pliCount")}t.jitter&&(r.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(r.roundTripTime=parseInt(t.roundTripTime||"0",10)),Number.isInteger(t.framesEncoded)&&(r.framesEncoded=parseInt(t.framesEncoded||"0",10)),r.ssrc=t.ssrc,r.qpSum=parseInt(t.qpSum||"0",10);const{trackId:s,mediaSourceId:i}=t,o=e.raw[s];o&&(r.frameWidth=parseInt(o.frameWidth||"0",10),r.frameHeight=parseInt(o.frameHeight||"0",10),r.frames=parseInt(o.framesSent||"0",10),r.hugeFramesSent=parseInt(o.hugeFramesSent||"0",10));const a=e.raw[i];a&&(r.framesPerSecond=parseInt(a.framesPerSecond||"0",10))})(t,r,c);break;default:Ji.log.DEBUG([s,Mt.STATS_MODULE,null,jt.STATS_MODULE.ERRORS.PARSE_FAILED])}},parseMedia:(e,t,n,r,s,i,o,a)=>{const d=r.kind||r.mediaType;d===yt.AUDIO?to.parseAudio(e,t,n,r,i,o,a):d===yt.VIDEO?to.parseVideo(e,t,n,r,i,o,a):Ji.log.DEBUG([(void 0).peerId,Mt.STATS_MODULE,null,jt.STATS_MODULE.INVALID_TRACK_KIND],r)}};var no=class{constructor(e,t){this.roomState=jo.getSkylinkState(e),this.peerConnection=this.roomState.peerConnections[t]||null,this.peerConnStatus=this.roomState.peerConnStatus[t]||null,this.dataChannel=this.roomState.dataChannels[t]||null,this.peerId=t,this.roomKey=e,this.output={peerId:t,raw:{},connection:{},audio:{sending:{},receiving:{}},video:{sending:{},receiving:{}},selectedCandidatePair:{id:null,local:{},remote:{},consentRequests:{},responses:{},requests:{}},certificate:{}},this.beSilentOnLogs=jo.getInitOptions().beSilentOnStatsLogs,this.beSilentOnParseLogs=jo.getInitOptions().beSilentOnParseLogs,this.isAutoBwStats=!1,this.bandwidth=null}getConnectionStatus(){return this.getStatistics(!1,!1)}getStatsSuccess(e,t,n){const{AdapterJS:r}=window;if(!n&&r.webrtcDetectedBrowser===Ft.REACT_NATIVE)return void e(this.output);const{peerBandwidth:s,peerStats:i,room:o}=this.roomState;"function"==typeof n.forEach?n.forEach((e,t)=>{this.output.raw[t]=e}):this.output.raw=n;try{if(ui(i))return void Ji.log.DEBUG([this.peerId,Mt.STATS_MODULE,null,jt.STATS_MODULE.STATS_DISCARDED]);Object.entries(this.output.raw).forEach(e=>{const t=e[0],n=e[1],{type:r}=n;switch(r){case"remote-inbound-rtp":case"outbound-rtp":case"inbound-rtp":"inbound-rtp"===r?to.parseMedia(this.roomState,this.output,r,n,this.peerConnection,this.peerId,this.isAutoBwStats,"receiving"):to.parseMedia(this.roomState,this.output,r,n,this.peerConnection,this.peerId,this.isAutoBwStats,"sending");break;case"certificate":to.parseCertificates(this.output,n);break;case"local-candidate":case"remote-candidate":case"media-source":to.parseSelectedCandidatePair(this.roomState,this.output,r,n,this.peerConnection,this.peerId,this.isAutoBwStats)}this.isAutoBwStats&&!s[this.peerId][t]?s[this.peerId][t]=this.output.raw[t]:this.isAutoBwStats||i[this.peerId][t]||(i[this.peerId][t]=this.output.raw[t]),jo.setSkylinkState(this.roomState,o.id)})}catch(e){this.getStatsFailure(t,jt.STATS_MODULE.ERRORS.PARSE_FAILED,e)}xi(De({state:Ke.RETRIEVE_SUCCESS,peerId:this.peerId,stats:this.output})),e(this.output)}getStatsFailure(e,t,n){const r=t||jt.STATS_MODULE.RETRIEVE_STATS_FAILED;this.beSilentOnLogs||(Ji.log.ERROR([this.peerId,Mt.STATS_MODULE,null,r],n),xi(De({state:Ke.RETRIEVE_ERROR,peerId:this.peerId,error:n}))),e(n)}getStatistics(e=!1,t=!1){const{STATS_MODULE:n}=jt;return new Promise((r,s)=>{if(this.roomState.peerStats[this.peerId]||t){this.beSilentOnLogs=e,this.isAutoBwStats=t;try{this.gatherRTCPeerConnectionDetails(),this.gatherSDPIceCandidates(),this.gatherSDPCodecs(),this.gatherRTCDataChannelDetails()}catch(e){Ji.log.WARN([this.peerId,Mt.STATS_MODULE,null,jt.STATS_MODULE.ERRORS.PARSE_FAILED],e)}"function"!=typeof this.peerConnection.getStats&&this.getStatsFailure(s,jt.PEER_CONNECTION.getstats_api_not_available),xi(De({state:Ke.RETRIEVING,peerId:this.peerId})),this.peerConnection.getStats().then(e=>{this.getStatsSuccess(r,s,e)}).catch(e=>{e.message!==jt.STATS_MODULE.ERRORS.STATS_IS_NULL?this.getStatsFailure(s,null,e):Ji.log.WARN([this.peerId,Mt.STATS_MODULE,null,jt.STATS_MODULE.ERRORS.RETRIEVE_STATS_FAILED],e.message)})}else Ji.log.WARN(n.NOT_INITIATED),r(null)})}gatherRTCPeerConnectionDetails(){const{peerConnection:e}=this;this.output.connection.iceConnectionState=e.iceConnectionState,this.output.connection.iceGatheringState=e.iceGatheringState,this.output.connection.signalingState=e.signalingState,this.output.connection.remoteDescription={type:e.remoteDescription&&e.remoteDescription.type||"",sdp:e.remoteDescription&&e.remoteDescription.sdp||""},this.output.connection.localDescription={type:e.localDescription&&e.localDescription.type||"",sdp:e.localDescription&&e.localDescription.sdp||""},this.output.connection.constraints=this.peerConnStatus?this.peerConnStatus.constraints:null,this.output.connection.optional=this.peerConnStatus?this.peerConnStatus.optional:null,this.output.connection.sdpConstraints=this.peerConnStatus?this.peerConnStatus.sdpConstraints:null}gatherSDPIceCandidates(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.connection.candidates={sending:Zi.getSDPICECandidates(this.peerId,e.localDescription,t),receiving:Zi.getSDPICECandidates(this.peerId,e.remoteDescription,t)}}gatherSDPCodecs(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.audio.sending.codec=Zi.getSDPSelectedCodec(this.peerId,e.remoteDescription,"audio",t),this.output.video.sending.codec=Zi.getSDPSelectedCodec(this.peerId,e.remoteDescription,"video",t),this.output.audio.receiving.codec=Zi.getSDPSelectedCodec(this.peerId,e.localDescription,"audio",t),this.output.video.receiving.codec=Zi.getSDPSelectedCodec(this.peerId,e.localDescription,"video",t)}gatherRTCDataChannelDetails(){const{dataChannel:e}=this;if(e){const t=Object.keys(e);this.output.connection.dataChannels={},t.forEach(t=>{const n=e[t];this.output.connection.dataChannels[n.channel.label]={label:n.channel.label,readyState:n.channel.readyState,channelType:we["main"===t?"MESSAGING":"DATA"],currentTransferId:n.transferId||null,currentStreamId:n.streamId||null}})}}};const ro=e=>{const{peerMedias:t,user:n}=e,r={},s=Object.keys(t).filter(e=>e!==n.sid);for(let e=0;e<s.length;e+=1){const n=s[e];Object.values(t[n]).forEach(e=>{e.mediaType===Pt.VIDEO_SCREEN&&(r[n]=e.streamId)})}return r},so=(e,t,n,r=!1)=>{mn.prepStopStreams(e.id,t.id,r,!0).then(()=>Ji.log.DEBUG([n,Mt.MEDIA_STREAM,null,""+jt.MEDIA_STREAM.STOP_SCREEN_SUCCESS])).catch(e=>Ji.log.DEBUG([n,Mt.MEDIA_STREAM,null,""+jt.MEDIA_STREAM.ERRORS.STOP_SCREEN],e))};var io={handleScreenStreamStates:{addScreenStreamToState:(e,t)=>{const{room:n,user:r}=e,s=Ei.parseStreamSettings({video:!0});Ei.processStreamInState(t,s,n.id,!0,!1),xi(le({stream:t,peerId:r.sid,room:n,isSelf:!0,peerInfo:fn.getCurrentSessionInfo(n),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0}))},removeScreenStreamFromState:e=>{const{room:t,streams:n}=e;n.screenshare=null,jo.setSkylinkState(e,t.id)},setScreenStateToUnavailable:(e,t)=>{const{user:n,room:r}=e,s=Qs.retrieveMediaId(yt.VIDEO,t.id);Qs.setMediaStateToUnavailable(r,n.sid,s)}},addScreenStreamCallbacks:(e,t)=>{t.getTracks().forEach(n=>{n.onended=()=>so(e.room,t,e.user.sid)})},retrievePeersScreenStreamId:ro,retrievePeerScreenStream:e=>{const{remoteStreams:t}=e,n=ro(e);if(ui(n))return null;const r={};return Object.keys(n).forEach(e=>{const s=Object.values(t[e]);r[e]=s.filter(t=>t.id===n[e].id)}),r},stopScreenStream:so};var oo=class{static addPeer(e){Rs.addPeer(e)}static createOffer(...e){return Rs.createOffer(...e)}static createAnswer(...e){return Rs.createAnswer(...e)}static createDataChannel(...e){return Rs.createDataChannel(...e)}static sendP2PMessage(...e){return Rs.sendP2PMessage(...e)}static getPeersInRoom(...e){return Rs.getPeersInRoom(...e)}static retrieveStatistics(e,t,n,r){return new no(e,t).getStatistics(n,r)}static signalingEndOfCandidates(...e){return Rs.signalingEndOfCandidates(...e)}static getConnectionStatus(e,t){return Rs.getConnectionStatus(e,t)}static getDataChannelBuffer(e){return Rs.getDataChannelBuffer(e)}static refreshDataChannel(e,t){return Rs.refreshDataChannel(e,t)}static closeDataChannel(e,t){return Rs.closeDataChannel(e,t)}static refreshConnection(e,t,n,r,s){return Rs.refreshConnection(e,t,n,r,s)}static refreshPeerConnection(e,t,n,r){return Rs.refreshPeerConnection(e,t,n,r)}static getPeerScreenshare(e){return io.retrievePeerScreenStream(e)}static buildPeerInformations(...e){return Rs.buildPeerInformations(...e)}static closePeerConnection(e,t){return Rs.closePeerConnection(e,t)}static updatePeerInformationsMediaStatus(e,t,n,r){return Rs.updatePeerInformationsMediaStatus(e,t,n,r)}};const ao={};var co=class{constructor(e){const{room:t}=e;if(ao[t.id])return ao[t.id];this.roomState=e,this.stream=null,this.signaling=new Js,this.isReplace=null,this.streamId=null,ao[t.id]=this}streamExists(){const e=Ei.getStreams(this.roomState,this.roomState.room.name),t=Object.keys(e.userMedia);for(let e=0;e<t.length;e+=1)if(t[e]===this.streamId)return!0;return!1}hasMoreThanOneVideoStream(){return Ei.retrieveVideoStreams(this.roomState.room).length>1}hasUserMediaStream(){const{streams:e}=this.roomState;return e.userMedia}async start(e,t=null){this.isReplace=!1,this.streamId=t;try{if(this.checkForExistingScreenStreams(),this.checksForReplaceScreen(),this.stream=await this.startScreenCapture(),!this.stream)return this.deleteScreensharingInstance(this.roomState.room),null;io.handleScreenStreamStates.addScreenStreamToState(this.roomState,this.stream,this.isReplace),io.addScreenStreamCallbacks(this.roomState,this.stream),this.isReplace?this.replaceUserMediaStream():this.addScreenshareStream()}catch(e){Ji.log.ERROR([this.roomState.user.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.ERRORS.REPLACE_SCREEN],e)}return this.stream}stop(e=!1){if(!this.stream)return Ji.log.DEBUG([this.roomState.user.sid,Mt.MEDIA_STREAM,null,`${jt.MEDIA_STREAM.ERRORS.STOP_SCREEN} - ${jt.MEDIA_STREAM.ERRORS.NO_STREAM}`]),null;try{io.stopScreenStream(this.roomState.room,this.stream,this.roomState.user.sid,e),this.isReplace=null,this.streamId=null,this.stream=null}catch(e){Ji.log.ERROR([this.roomState.user.sid,Mt.MEDIA_STREAM,null,""+jt.MEDIA_STREAM.ERRORS.STOP_SCREEN],e)}return null}startScreenCapture(){const{navigator:e}=window;return e.mediaDevices.getDisplayMedia?e.mediaDevices.getDisplayMedia({video:!0}).then(e=>e).catch(e=>("NotAllowedError"===e.name?Ji.log.WARN(e):Ji.log.ERROR(e),null)):e.mediaDevices.getUserMedia({video:{mediaSource:"screen"}}).then(e=>e).catch(e=>(Ji.log.ERROR(e),null))}checksForReplaceScreen(){if(this.isReplace){if(!this.hasUserMediaStream())throw new Error(jt.MEDIA_STREAM.ERRORS.NO_USER_MEDIA_STREAMS);if(this.hasMoreThanOneVideoStream()&&!this.streamId)throw new Error(jt.MEDIA_STREAM.ERRORS.NO_STREAM_ID);if(this.streamId&&!Ai(this.streamId))throw new Error(jt.MEDIA_STREAM.ERRORS.INVALID_STREAM_ID_TYPE);if(this.streamId&&!this.streamExists())throw new Error(`${jt.MEDIA_STREAM.ERRORS.INVALID_STREAM_ID} - ${this.streamId}`)}}checkForExistingScreenStreams(){const e=io.retrievePeersScreenStreamId(this.roomState);ui(e)||Ji.log.WARN([this.roomState.user.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.ERRORS.PEER_SCREEN_ACTIVE])}replaceUserMediaStream(){const{peerConnections:e,streams:t}=this.roomState,n=Object.keys(e),r=this.streamId?t.userMedia[this.streamId].stream:Ei.retrieveVideoStreams(this.roomState.room)[0],s=this.stream;this.streamId=r.id,((e,t,n,r)=>{const{streams:s,room:i}=n,o=Object.values(s.userMedia);for(let n=0;n<o.length;n+=1)o[n].id===e.id&&(o[n].isReplaced=r,o[n].newStream=t);jo.setSkylinkState(n,i.id)})(r,s,this.roomState,!0),n.forEach(e=>{Ei.replaceTrack(r,s,e,this.roomState)})}addScreenshareStream(){const{peerConnections:e}=this.roomState;ui(e)||oo.refreshConnection(this.roomState).catch(e=>Ji.log.ERROR([this.roomState.user.sid,Mt.MEDIA_STREAM,null,jt.MEDIA_STREAM.ERRORS.START_SCREEN],e))}deleteScreensharingInstance(e){delete ao[e.id]}isReplaceScreenStream(){return this.isReplace}};let lo=null;var So=class{constructor(){return lo||(lo=this),this.states={},lo}setState(e){this.states[e.room.id]=e}getAllStates(){return this.states}getState(e){return this.states[e]}removeStateByRoomId(e){return delete this.states[e]}clearRoomStateFromSingletons(e){const t=this.getState(e);new co(t).deleteScreensharingInstance(t.room),qn.deleteAsyncInstance(t.room),Jn.deleteEncryptedInstance(t.room)}};var Eo=class{static shouldProceed(e,t,n){let r=null;return e.isPrivileged||(r=jt.PEER_PRIVILEGED.not_privileged),t||(r=jt.PEER_PRIVILEGED.no_appkey),r&&(Ji.log.DEBUG(r),n(new Error(r))),!r}static getPeerList(e,t){return new Promise((n,r)=>{try{const i=jo.getSkylinkState(e.id),o=jo.getInitOptions(),a=t||!1,d=e=>{const t=e.detail;t.state===qe.DISPATCHED&&(Vi(s.EVENTS.GET_PEERS_STATE_CHANGE,d),xi(Ce({state:qe.RECEIVED,privilegePeerId:i.user.sid,peerList:t.peerList})),n(t.peerList))};this.shouldProceed(i,o.appKey,r)&&((new Js).getPeerList(a),xi(Ce({state:qe.ENQUIRED,privilegePeerId:i.user.sid,peerList:null})),Ji.log.INFO(jt.PEER_PRIVILEGED.getPeerListFromServer),Bi(s.EVENTS.GET_PEERS_STATE_CHANGE,d))}catch(e){Ji.log.ERROR(e),r(e)}})}};var uo={defaultRoom:(new Date).valueOf(),appKey:null,roomServer:"//api.temasys.io",enableDataChannel:!0,enableSTUNServer:!0,enableTURNServer:!0,socketServerPath:null,enableStatsGathering:!0,audioFallback:!0,socketTimeout:7e3,apiTimeout:4e3,forceTURNSSL:!1,forceTURN:!1,forceSSL:!0,usePublicSTUN:!1,disableVideoFecCodecs:!1,disableComfortNoiseCodec:!1,disableREMB:!1,throttleShouldThrowError:!1,mcuUseRenegoRestart:!0,useEdgeWebRTC:!1,enableSimultaneousTransfers:!0,TURNServerTransport:We.ANY,credentials:null,filterCandidatesType:{host:!1,srflx:!1,relay:!1},throttleIntervals:{shareScreen:1e4,refreshConnection:5e3,getUserMedia:0},iceServer:null,socketServer:null,audioCodec:lt.AUTO,videoCodec:ct.AUTO,codecParams:{audio:{opus:{stereo:null,"sprop-stereo":null,usedtx:null,useinbandfec:null,maxplaybackrate:null,minptime:null}},video:{h264:{profileLevelId:null,levelAsymmetryAllowed:null,packetizationMode:null},vp8:{maxFs:null,maxFr:null},vp9:{maxFs:null,maxFr:null}}},beSilentOnStatsLogs:!1,beSilentOnParseLogs:!1};var po=class{constructor(e){this.id=e.room_key,this.token=e.roomCred,this.startDateTime=e.start,this.duration=e.len,this.roomName=e.roomName,this.connection={peerConstraints:JSON.parse(e.pc_constraints),offerConstraints:JSON.parse(e.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},peerConfig:{iceServers:[]},mediaConstraints:JSON.parse(e.media_constraints)}}getRoomKey(){return this.id}getRoomName(){return this.roomName}};var go=class{constructor(e){this.uid=e.username,this.token=e.userCred,this.timeStamp=e.timeStamp,this.info={},this.sid=null,this.bufferMessage=null}};var Ro=class{constructor(e){const{offer_constraints:t,pc_constraints:n,cid:r,apiOwner:s,ipSigserver:i,isPrivileged:o,autoIntroduce:a,httpPortList:d,httpsPortList:c,hasMCU:l,ipSigserverPath:S,hasPersistentMessage:E}=e;t||n||Ji.log.ERROR(["API",null,"init","pc_constraints or offer_constraints are null"]),Ji.log.DEBUG(["API",null,"init","Parsed Peer Connection constraints:"],JSON.parse(n)),Ji.log.DEBUG(["API",null,"init","Parsed Offer constraints"],JSON.parse(t)),this.key=r,this.appKeyOwner=s,this.isPrivileged=o,this.autoIntroduce=a,this.room=new po(e),this.user=new go(e),this.hasMCU=l,this.socketServer=i,this.socketServerPath=S,this.socketPorts={"http:":Array.isArray(d)&&d.length>0?d:[80,3e3],"https:":Array.isArray(c)&&c.length>0?c:[443,3443]},this.hasPersistentMessage=E}};const mo=e=>{const{appKey:t}=e,n={isValid:!0,message:""};return Ji.log.INFO(["API",null,"init","API initialised with options:"],e),t||(n.isValid=!1,n.message=jt.INIT.ERRORS.NO_APP_KEY,xi(Re({readyState:tt.ERROR,error:{status:-2,content:new Error(jt.INIT.ERRORS.NO_APP_KEY),errorCode:nt.NO_PATH},room:null}))),n.isValid||Ji.log.ERROR(["API",null,"init",n.message]),n},Io=e=>{const{ok:t}=e;return(e=>{const{status:t,ok:n}=e,r=n?"INFO":"ERROR";let s=jt.INIT.INFO.API_SUCCESS;n||(s=jt.INIT.ERRORS.AUTH_GENERAL,403===t&&(s=jt.INIT.ERRORS.AUTH_CORS)),Ji.log[r](["API",null,"auth",s],e)})(e),t},ho=e=>{const t=e;return!0===t.forceTURN&&(t.enableTURNServer=!0,t.enableSTUNServer=!1,t.filterCandidatesType.host=!0,t.filterCandidatesType.srflx=!0,t.filterCandidatesType.relay=!1),t},To=async e=>{const{fetch:t}=window,n=(e=>{const{roomServer:t,appKey:n,defaultRoom:r,credentials:s,forceSSL:i}=e;let o=`${t}/api/${n}/${r}`,a="?";if(o=i?"https:"+o:`${window.location.protocol}${o}`,s){const{startDateTime:e,duration:t}=s;o+=`/${e}/${t}?cred=${s.credentials}`,a="&"}return o+=`${a}rand=${Date.now()}`,o})(e);return{endpoint:n,response:await t(n,{headers:{Skylink_SDK_type:Lt.WEB,Skylink_SDK_version:kt,Skylink_API_version:Ut,"X-Server-Select":Gt}})}},Ao=()=>{const{AdapterJS:e}=window,t={ready:!0,message:""};return(()=>{try{const e=new window.RTCPeerConnection(null);return["object","function"].indexOf(typeof e.createOffer)>-1&&null!==e.createOffer}catch(e){return!1}})()||(window.RTCPeerConnection&&"plugin"===e.webrtcDetectedType?t.message="Plugin is not available. Please check plugin status.":t.message="WebRTC not supported. Please upgrade your browser",t.ready=!1,xi(Re({readyState:tt.ERROR,error:{status:-2,content:new Error("plugin"===e.webrtcDetectedType&&window.RTCPeerConnection?"Plugin is not available":"WebRTC not available"),errorCode:nt.NO_WEBRTC_SUPPORT},room:null}))),t};let Oo=null;var fo=class{constructor(){return Oo||(Oo=this),this.options={},Oo}init(e=uo){e&&(e.socketServer&&(e.socketServerPath=""),jo.setUserInitOptions(e)),xi(Re({readyState:tt.INIT,error:null,room:null}));const t=er(),{AdapterJS:n}=window;if(!t.fulfilled)throw xi(Re({readyState:tt.ERROR,error:{status:-2,content:new Error(t.message),errorCode:t.readyStateChangeErrorCode},room:null})),new Error(t.message);let r=Object.assign({},uo,e);const s=mo(r);if(!s.isValid)throw new Error(s.message);return n.webRTCReady(()=>{const e=Ao();if(!e.ready)throw new Error(e.message)}),r=ho(r),r}createRoom(e){return new Promise((t,n)=>{const r=jo.getInitOptions();r.defaultRoom=e,To(r).then(r=>{const{endpoint:s,response:i}=r;Io(i)?(xi(Re({readyState:tt.COMPLETED,error:null,room:e})),i.json().then(e=>{t({endpoint:s,response:e})})):(xi(Re({readyState:tt.ERROR,error:{status:i.status,content:new Error(i.info||"XMLHttpRequest status not OK\nStatus was: "+i.status),errorCode:i.error||i.status},room:e})),n(i.json()))}).catch(t=>{xi(Re({readyState:tt.ERROR,error:{status:t.status||-1,content:new Error(t.message||"Network error occurred"),errorCode:nt.XML_HTTP_REQUEST_ERROR},room:e}))})})}checkCodecSupport(e){return(e=>new Promise((t,n)=>{Zi.getCodecsSupport(e).then(r=>{const s=jo.getSkylinkState(e),{room:i}=s;0===Object.keys(r.audio).length&&0===Object.keys(r.video).length?(Ji.log.ERROR(jt.JOIN_ROOM.ERRORS.CODEC_SUPPORT),xi(Re({readyState:tt.ERROR,error:{status:-2,content:new Error(jt.JOIN_ROOM.ERRORS.CODEC_SUPPORT),errorCode:nt.PARSE_CODECS},room:i.roomName})),n(new Error(jt.JOIN_ROOM.ERRORS.CODEC_SUPPORT))):t(!0),s.currentCodecSupport=r,jo.setSkylinkState(s)}).catch(t=>{const r=jo.getSkylinkState(e),{room:s}=r;Ji.log.ERROR(t),xi(Re({readyState:tt.ERROR,error:{status:-2,content:new Error(t.message||t.toString()),errorCode:nt.PARSE_CODECS},room:s.roomName})),n(new Error(t.message||t.toString()))})}))(e)}static parseAPIResponseBody(e){return new Ro(e)}enforceUserInitOptions(e){return(e=>{const t=jo.getUserInitOptions(),n=jo.getInitOptions();let r=Object.assign(n,e,t);const s=mo(r);if(!s.isValid)throw new Error(s.message);return r=ho(r),jo.setInitOptions(r),r})(e)}static getRoomNameFromParams(e){const t=jo.getInitOptions(),{roomName:n}=e,{defaultRoom:r}=t;let s=null;return s=void 0!==n&&""!==n&&r!==n?n:r,s}static getStateByKey(e){return Ci(e)}};const Co=e=>new Promise(t=>{const n=jo.getSkylinkState(e.room.id),{room:r,peerConnections:i}=n,{ROOM:{LEAVE_ROOM:o}}=jt,a=new Js,d=Object.keys(jo.getSkylinkState()).length>1;if(n.inRoom=!1,jo.setSkylinkState(n,r.id),d)Ji.log.INFO([r.roomName,null,null,o.SENDING_BYE]),Object.keys(i).forEach(e=>{a.bye(n,e)}),t(n);else{a.config=a.resetSocketConfig(window.location.protocol);const e=()=>{Ji.log.INFO([r.roomName,null,null,o.DISCONNECT_SOCKET.SUCCESS]),Vi(s.EVENTS.CHANNEL_CLOSE,e),t(n)};Bi(s.EVENTS.CHANNEL_CLOSE,e),a.socket.connected?a.socket.disconnect():t(n)}}),_o=e=>{const{room:t,streams:n}=e;n.userMedia&&mn.prepStopStreams(t.id,null,!0),n.screenshare&&new co(e).stop(!0)},Do=e=>{jo.clearRoomStateFromSingletons(e),jo.removeSkylinkState(e)},No=e=>new Promise((t,n)=>{const{peerConnections:r,peerInformations:i,room:o,hasMCU:a,user:d}=e,{ROOM:{LEAVE_ROOM:c}}=jt;try{const n=a?[Bt.MCU]:Array.from(new Set([...Object.keys(r),...Object.keys(i)]));if(pi(n))Ji.log.DEBUG([o.roomName,null,null,c.NO_PEERS]),_o(e),Co(e).then(e=>{Ji.log.INFO([o.roomName,null,null,c.REMOVE_STATE.SUCCESS]),xi(Oe({peerId:d.sid,peerInfo:fn.getCurrentSessionInfo(o),isSelf:!0,room:o})),Do(e.room.id),t(e.room.roomName)});else{const r=[];n.forEach(t=>{r.push(((e,t)=>new Promise(n=>{const{room:r,peerConnections:i}=e,{ROOM:{LEAVE_ROOM:o}}=jt,{enableDataChannel:a}=jo.getInitOptions();Ji.log.INFO([t,r.roomName,null,o.PEER_LEFT.START]),t===Bt.MCU?xi(fe({peerId:t,serverPeerType:$e.MCU,room:r})):xi(Oe({peerId:t,peerInfo:fn.getCurrentSessionInfo(r),isSelf:!1,room:r})),i[t]&&i[t].signalingState!==je.CLOSED&&oo.closePeerConnection(e,t),a?(Bi(s.EVENTS.DATA_CHANNEL_STATE,e=>{const{detail:t}=e;t.state!==ye.CLOSED&&t.state!==ye.CLOSING||(Ji.log.INFO([t.peerId,r.roomName,null,o.PEER_LEFT.SUCCESS]),n(t.peerId))}),oo.closeDataChannel(e,t)):n(t)}))(e,t))}),Promise.all(r).then(()=>(_o(e),Co(e))).then(e=>{Ji.log.INFO([o.roomName,null,null,c.REMOVE_STATE.SUCCESS]),xi(Oe({peerId:d.sid,peerInfo:fn.getCurrentSessionInfo(o),isSelf:!0,room:o})),Do(e.room.id),t(e.room.roomName)})}}catch(e){Ji.log.ERROR([o.roomName,null,null,c.ERROR],e),n(e)}}),Mo=(e=[],t=[])=>new Promise((n,r)=>{const{ROOM:{LEAVE_ROOM:s}}=jt;try{const r=jo.getSkylinkState(),i=Object.values(r);i[0]?No(i[0]).then(r=>{e.push(r),t.push(n),Mo(e,t)}):(Ji.log.INFO([e,"Room",null,s.LEAVE_ALL_ROOMS.SUCCESS]),t.forEach(t=>t(e)))}catch(e){Ji.log.ERROR([null,"Room",null,s.LEAVE_ALL_ROOMS.ERROR],e),r(e)}});var Po=class extends Nn{constructor(){super();const{AdapterJS:e,navigator:t}=window;this.model={client_id:null,appKey:null,timestamp:null,username:null,sdk_name:Lt.WEB,sdk_version:null,agent_name:e.webrtcDetectedBrowser,agent_version:e.webrtcDetectedVersion,agent_platform:t.platform,agent_plugin_version:e.WebRTCPlugin.plugin&&e.WebRTCPlugin.plugin.VERSION||null,device_version:null,enumerated_devices:null,device_muted:null,network_type:t.connection?t.connection.type:"-",language:t.language}}send(e){const t=jo.getSkylinkState(e);this.model.username=t.user&&t.user.uid||null,this.model.sdk_version=t.VERSION,this.model.client_id=t.clientId,this.model.appKey=jo.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.client,this.model)}};var vo=class{constructor(e){this.dataChannels={},this.dataTransfers={},this.dataStreams={},this.peerCandidatesQueue={},this.peerEndOfCandidatesCounter={},this.gatheredCandidates={},this.retryCounters={},this.peerConnections={},this.peerStats={},this.peerBandwidth={},this.peerCustomConfigs={},this.peerInformations={},this.user=e.user,this.userData="",this.peerPriorityWeight=0,this.autoIntroduce=e.autoIntroduce,this.isPrivileged=e.isPrivileged,this.selectedRoom=null,this.roomLocked=!1,this.inRoom=!1,this.timestamp={socketMessage:null,shareScreen:null,refreshConnection:null,getUserMedia:null,lastRestart:null},this.socketSession={},this.socketMessageQueue=[],this.socketMessageTimeout=null,this.socketPorts=e.socketPorts,this.channelOpen=!1,this.socketServer=e.socketServer,this.signalingServerProtocol=e.forceSSL?"https:":window.location.protocol,this.signalingServerPort=null,this.socket=null,this.socketUseXDR=!1,this.enableIceRestart=!1,this.hasMCU=e.hasMCU,this.path=null,this.key=e.key,this.appKeyOwner=e.appKeyOwner,this.room=e.room,this.peerMessagesStamps={},this.streams={userMedia:null,screenshare:null},this.streamsDefaultSettings={userMedia:{audio:{stereo:!1},video:{resolution:{width:640,height:480},frameRate:50}},screenshare:{video:!0}},this.streamsMutedSettings={},this.streamsBandwidthSettings={googleX:{},bAS:{}},this.sdpSettings={connection:{audio:!0,video:!0,data:!0},direction:{audio:{send:!0,receive:!0},video:{send:!0,receive:!0}}},this.publishOnly=!1,this.recordings={},this.currentRecordingId=!1,this.recordingStartInterval=null,this.currentCodecSupport=null,this.sdpSessions={},this.voiceActivityDetection=!0,this.binaryChunkType=ke.ARRAY_BUFFER,this.peerConnectionConfig={},this.bandwidthAdjuster=null,this.peerConnStatus={},this.joinRoomManager={timestamp:0,socketsFn:[]},this.statIdRandom=Date.now()+Math.floor(1e8*Math.random()),this.rtmpSessions={},this.SMProtocolVersion=dt,this.DTProtocolVersion=Le,this.originalDTLSRole=null,this.bufferedLocalOffer={},this.bufferedRemoteOffers={},this.currentRTCRTPSenders={},this.clientId=Mi(),this.streamsMediaStatus={},this.peerMedias={},this.remoteStreams={},this.hasPersistentMessage=e.hasPersistentMessage}};var yo=(e={},t)=>new Promise((n,r)=>{const{navigator:s,AdapterJS:i}=window,o=new fo,a=new Js;let d=jo.getInitOptions();const c=new Po,l=fo.getRoomNameFromParams(e)?fo.getRoomNameFromParams(e):d.defaultRoom;xi(Re({readyState:tt.LOADING,error:null,room:l})),o.createRoom(l).then(S=>{const{endpoint:E,response:u}=S;u.roomName=l;const p=new Ro(u);d=o.enforceUserInitOptions(p);const g=new vo(d);g.userData=e.userData||"",g.path=E,jo.setSkylinkState(g,l),o.checkCodecSupport(g.room.id).then(()=>(c.send(g.room.id),a.createSocket(u.room_key).then(()=>{const o=fo.getStateByKey(u.room_key),d=Object.assign({},e);d.room=o,t||e.id&&e.active?hn.usePrefetchedStream(u.room_key,t,e).then(()=>{a.joinRoom(o),n(null)}).catch(e=>{r(e)}):e.audio||e.video?hn.getUserMedia(g,d).then(e=>{a.joinRoom(o),n(e)}).catch(e=>{r(e)}):(i.webrtcDetectedBrowser===Ft.SAFARI?s.mediaDevices.getUserMedia({audio:!0}).then(()=>a.joinRoom(o)):a.joinRoom(o),n(null))}))).catch(e=>{r(e)})}).catch(e=>{r(e)})});const wo=(e,t=!0)=>{const n=e,{room:r,user:s}=n,i=new Js;n.roomLocked=t,jo.setSkylinkState(n,r.id),i.roomLock(n),xi(((e={})=>new de(z,{detail:e}))({isLocked:n.roomLocked,peerInfo:fn.getCurrentSessionInfo(r),peerId:s.sid,isSelf:!0}))};var bo=class{static leaveRoom(e){return No(e)}static leaveAllRooms(){return Mo()}static lockRoom(e){return(e=>wo(e,!0))(e)}static unlockRoom(e){return(e=>wo(e,!1))(e)}static joinRoom(e){return yo(e)}};const ko=(e,t,n,r=null,s=null)=>{const i=new Ns;return Ji.log.ERROR(t),i.send(e.room.id,n,r,s,t),new Error(t)},Lo=(e,t)=>new Promise((n,r)=>{const{hasMCU:i,currentRecordingId:o,recordingStartInterval:a}=e;let d=t?jt.RECORDING.START_FAILED:jt.RECORDING.STOP_FAILED;if(!i){d=`${d} - ${jt.RECORDING.ERRORS.MCU_NOT_CONNECTED}`;const n=t?jt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_START:jt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_STOP;r(ko(e,d,n,null,null))}if(t&&o){r(ko(e,`${d} - ${jt.RECORDING.ERRORS.EXISTING_RECORDING_IN_PROGRESS}`,jt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_START_ACTIVE,o,null))}if(!t&&!o){r(ko(e,`${d} - ${jt.RECORDING.ERRORS.NO_RECORDING_IN_PROGRESS}`,jt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_STOP_ACTIVE,o,null))}if(!t&&a){r(ko(e,`${d} - ${jt.RECORDING.ERRORS.MIN_RECORDING_TIME}`,jt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_MIN_STOP,o,null))}((e,t)=>{const n=r=>{const i=r.detail,o=t?s.RECORDING_STATE.START:s.RECORDING_STATE.STOP;i.state===o&&(Vi(s.EVENTS.RECORDING_STATE,n),e(i.recordingId))};Bi(s.EVENTS.RECORDING_STATE,n)})(n,t),((e,t,n=null)=>{const r=new Js,i=new Ns;r.recording(e.room.id,t?s.SIG_MESSAGE_TYPE.START_RECORDING:s.SIG_MESSAGE_TYPE.STOP_RECORDING),i.send(e.room.id,t?jt.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_START:jt.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_STOP,n,null,null)})(e,t,o)});var Uo=class{static start(...e){return(e=>Lo(e,!0))(...e)}static stop(...e){return(e=>Lo(e,!1))(...e)}static getRecordings(e){const{recordings:t}=e;return Object.assign({},t)}};var Go={checkRTMPDependencies:(e,t,n=null,r=null)=>{const s={shouldProceed:!0,errorMessage:""},{hasMCU:i}=t;return i?e&&!n?(s.errorMessage=jt.RTMP.start_no_stream_id,s.shouldProceed=!1,s):e&&!r?(s.errorMessage=jt.RTMP.start_no_endpoint,s.shouldProceed=!1,s):s:(s.errorMessage=e?jt.RTMP.start_no_mcu:jt.RTMP.stop_no_mcu,s.shouldProceed=!1,s)},registerRTMPEventListenersAndResolve:(e,t)=>{const n=r=>{const i=r.detail,o=e?s.RTMP_STATE.START:s.RTMP_STATE.STOP;i.state===o&&(Vi(s.EVENTS.RTMP_STATE,n),t(i.rtmpId))};Bi(s.EVENTS.RTMP_STATE,n)},sendRTMPMessageViaSig:(e,t,n,r=null,s=null)=>{const{room:i,user:o}=e,a=new Js,d=t?At.START_RTMP:At.STOP_RTMP;a.rtmp(d,i.id,o.sid,n,r,s)}};var Fo=class{static startSession(e,t,n){return this.commonRTMPOperations(e,t,null,n,!0,jt.RTMP.starting_rtmp)}static stopSession(e,t){return this.commonRTMPOperations(e,null,t,null,!1,jt.RTMP.stopping_rtmp)}static logErrorAndReject(e,t){Ji.log.ERROR(e),t(e)}static commonRTMPOperations(e,t,n,r,s,i){return new Promise((o,a)=>{try{const d=Go.checkRTMPDependencies(s,e,t,r),c=n||Mi();d.shouldProceed?(Go.registerRTMPEventListenersAndResolve(s,o),Go.sendRTMPMessageViaSig(e,s,c,t,r),Ji.log.INFO([Bt.MCU,"RTMP",i])):this.logErrorAndReject(new Error(d.errorMessage),a)}catch(e){this.logErrorAndReject(e,a)}})}};var Bo=class{async joinRoom(e={},t){return bo.joinRoom(e,t)}sendP2PMessage(e="",t="",n=""){oo.sendP2PMessage(e,t,n)}sendMessage(e="",t="",n=""){zn.sendMessage(e,t,n)}getStoredMessages(e){const t=_i(e);t&&new qn(t).getStoredMessages()}getPeersInRoom(e){return Oi(e,"roomName","getPeersInRoom")?oo.getPeersInRoom(e):null}getPeerInfo(e,t=null){const n=_i(e);return t&&n?fn.getPeerInfo(t,n.room):!t&&n?fn.getCurrentSessionInfo(n.room):null}getUserData(e,t){const n=_i(e);return n&&n.room?fn.getUserData(n,t):null}setUserData(e,t){const n=_i(e);return n&&n.room?fn.setUserData(n.room,t):null}getConnectionStatus(e,t){const n=_i(e);return oo.getConnectionStatus(n,t)}getPeers(e,t=!1){const n=_i(e);return n?Eo.getPeerList(n.room,t):null}getPeersStreams(e,t=!0){const n=_i(e);return n?fn.getPeersStreams(n,t):null}getPeersDataChannels(e){const t=_i(e);return t?fn.getPeersDataChannels(t):null}getPeersCustomSettings(e){const t=_i(e);return t?fn.getPeersCustomSettings(t):null}refreshDatachannel(e,t){const n=_i(e);return n?oo.refreshDataChannel(n,t):null}refreshConnection(e,t,n,r){const s=_i(e);return oo.refreshConnection(s,t,n,r)}shareScreen(e,t){const n=_i(e);if(n){return new co(n).start(!1,t)}return null}getPeersScreenshare(e){const t=_i(e);return t?oo.getPeerScreenshare(t):null}getUserMedia(e=null,t){if(!e)return Pi(t);if(Ai(e)){const n=_i(e);if(n)return hn.getUserMediaLayer(n,t)}else if(Ri(e))return Pi(e)}stopPrefetchedStream(e){return e&&(e.getTracks().forEach(e=>{e.stop()}),xi(Se({room:null,peerId:null,peerInfo:null,isSelf:!0,isScreensharing:!1,streamId:e.id}))),null}stopScreen(e){const t=_i(e);if(t){new co(t).stop()}return null}stopStreams(e,t){const n=_i(e);return n?hn.stopStreams(n,t):null}leaveRoom(e){const t=_i(e);return t?bo.leaveRoom(t):null}leaveAllRooms(){return bo.leaveAllRooms()}startRecording(e){const t=_i(e);return t?Uo.start(t):null}stopRecording(e){const t=_i(e);return t?Uo.stop(t):null}lockRoom(e){const t=_i(e);return t?bo.lockRoom(t):null}unlockRoom(e){const t=_i(e);return t?bo.unlockRoom(t):null}getRecordings(e){const t=_i(e);return t?Uo.getRecordings(t):null}muteStreams(e,t={audioMuted:!0,videoMuted:!0},n){const r=_i(e);return r?hn.muteStreams(r,t,n):null}startRTMPSession(e,t,n){const r=_i(e);return r?Fo.startSession(r,t,n):null}stopRTMPSession(e,t){const n=_i(e);return n?Fo.stopSession(n,t):null}getStreamSources(){return hn.getStreamSources()}sendStream(e,t){const n=_i(e);return hn.sendStream(n,t)}getScreenSources(){return hn.getScreenSources()}getStreams(e){const t=_i(e);return t?hn.getStreams(t):null}generateUUID(){return Mi()}setEncryptSecret(e="",t="",n=""){const r=_i(e);return new Jn(r).setEncryptSecret(t,n)}getEncryptSecrets(e=""){const t=_i(e);return new Jn(t).getEncryptSecrets()}deleteEncryptSecrets(e="",t=""){const n=_i(e);return new Jn(n).deleteEncryptSecrets(t)}setSelectedSecret(e="",t=""){const n=_i(e);new Jn(n).setSelectedSecretId(t)}getSelectedSecret(e,t){const n=_i(e);return new Jn(n).getSelectedSecretId(t)}setMessagePersistence(e,t){const n=_i(e);return new qn(n).setMessagePersistence(t)}getMessagePersistence(e){const t=_i(e);return new qn(t).getMessagePersistence()}};window.AdapterJS=d,window.io=o.a;const Vo=new So;let xo={},Ho={};class Wo extends Bo{constructor(e){super();const t=(new fo).init(e);Wo.setInitOptions(t)}static getSkylinkState(e=null){return e?Vo.getState(e):Vo.getAllStates()}static setSkylinkState(e,t){t&&Vo.setState(e)}static removeSkylinkState(e){if(e)return Vo.removeStateByRoomId(e)}static clearRoomStateFromSingletons(e){if(e)return Vo.clearRoomStateFromSingletons(e)}static getInitOptions(){return xo}static setInitOptions(e){xo=e}static setUserInitOptions(e){Ho=e}static getUserInitOptions(){return Ho}static logNoRoomState(e){Ji.log.ERROR(`${jt.ROOM_STATE.NOT_FOUND} - ${e}`)}}var jo=t.c=Wo}}]);
//# sourceMappingURL=skylink.chunk.bee75dcc25caddcb63f0.js.map