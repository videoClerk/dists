/*! For license information please see skylink.chunk.c9b8ec9db1c6591d6b8e.js.LICENSE.txt */
(window.webpackJsonpVClerkWidget=window.webpackJsonpVClerkWidget||[]).push([[1],{100:function(e,t){e.exports=Object.keys||function(e){var t=[],n=Object.prototype.hasOwnProperty;for(var r in e)n.call(e,r)&&t.push(r);return t}},101:function(e,t){var n,r,s,o=String.fromCharCode;function i(e){for(var t,n,r=[],s=0,o=e.length;s<o;)(t=e.charCodeAt(s++))>=55296&&t<=56319&&s<o?56320==(64512&(n=e.charCodeAt(s++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),s--):r.push(t);return r}function a(e,t){if(e>=55296&&e<=57343){if(t)throw Error("Lone surrogate U+"+e.toString(16).toUpperCase()+" is not a scalar value");return!1}return!0}function d(e,t){return o(e>>t&63|128)}function c(e,t){if(0==(4294967168&e))return o(e);var n="";return 0==(4294965248&e)?n=o(e>>6&31|192):0==(4294901760&e)?(a(e,t)||(e=65533),n=o(e>>12&15|224),n+=d(e,6)):0==(4292870144&e)&&(n=o(e>>18&7|240),n+=d(e,12),n+=d(e,6)),n+=o(63&e|128)}function l(){if(s>=r)throw Error("Invalid byte index");var e=255&n[s];if(s++,128==(192&e))return 63&e;throw Error("Invalid continuation byte")}function u(e){var t,o;if(s>r)throw Error("Invalid byte index");if(s==r)return!1;if(t=255&n[s],s++,0==(128&t))return t;if(192==(224&t)){if((o=(31&t)<<6|l())>=128)return o;throw Error("Invalid continuation byte")}if(224==(240&t)){if((o=(15&t)<<12|l()<<6|l())>=2048)return a(o,e)?o:65533;throw Error("Invalid continuation byte")}if(240==(248&t)&&(o=(7&t)<<18|l()<<12|l()<<6|l())>=65536&&o<=1114111)return o;throw Error("Invalid UTF-8 detected")}e.exports={version:"2.1.2",encode:function(e,t){for(var n=!1!==(t=t||{}).strict,r=i(e),s=r.length,o=-1,a="";++o<s;)a+=c(r[o],n);return a},decode:function(e,t){var a=!1!==(t=t||{}).strict;n=i(e),r=n.length,s=0;for(var d,c=[];!1!==(d=u(a));)c.push(d);return function(e){for(var t,n=e.length,r=-1,s="";++r<n;)(t=e[r])>65535&&(s+=o((t-=65536)>>>10&1023|55296),t=56320|1023&t),s+=o(t);return s}(c)}}},102:function(e,t,n){(function(t){var r=n(57),s=n(21);e.exports=l;var o,i=/\n/g,a=/\\n/g;function d(){}function c(){return"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==t?t:{}}function l(e){if(r.call(this,e),this.query=this.query||{},!o){var t=c();o=t.___eio=t.___eio||[]}this.index=o.length;var n=this;o.push((function(e){n.onData(e)})),this.query.j=this.index,"function"==typeof addEventListener&&addEventListener("beforeunload",(function(){n.script&&(n.script.onerror=d)}),!1)}s(l,r),l.prototype.supportsBinary=!1,l.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),r.prototype.doClose.call(this)},l.prototype.doPoll=function(){var e=this,t=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),t.async=!0,t.src=this.uri(),t.onerror=function(t){e.onError("jsonp poll error",t)};var n=document.getElementsByTagName("script")[0];n?n.parentNode.insertBefore(t,n):(document.head||document.body).appendChild(t),this.script=t,"undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent)&&setTimeout((function(){var e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)}),100)},l.prototype.doWrite=function(e,t){var n=this;if(!this.form){var r,s=document.createElement("form"),o=document.createElement("textarea"),d=this.iframeId="eio_iframe_"+this.index;s.className="socketio",s.style.position="absolute",s.style.top="-1000px",s.style.left="-1000px",s.target=d,s.method="POST",s.setAttribute("accept-charset","utf-8"),o.name="d",s.appendChild(o),document.body.appendChild(s),this.form=s,this.area=o}function c(){l(),t()}function l(){if(n.iframe)try{n.form.removeChild(n.iframe)}catch(e){n.onError("jsonp polling iframe removal error",e)}try{var e='<iframe src="javascript:0" name="'+n.iframeId+'">';r=document.createElement(e)}catch(e){(r=document.createElement("iframe")).name=n.iframeId,r.src="javascript:0"}r.id=n.iframeId,n.form.appendChild(r),n.iframe=r}this.form.action=this.uri(),l(),e=e.replace(a,"\\\n"),this.area.value=e.replace(i,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===n.iframe.readyState&&c()}:this.iframe.onload=c}}).call(this,n(35))},103:function(e,t,n){(function(t){var r,s,o=n(45),i=n(25),a=n(20),d=n(21),c=n(37),l=n(18)("engine.io-client:websocket");if("undefined"!=typeof WebSocket)r=WebSocket;else if("undefined"!=typeof self)r=self.WebSocket||self.MozWebSocket;else try{s=n(104)}catch(e){}var u=r||s;function E(e){e&&e.forceBase64&&(this.supportsBinary=!1),this.perMessageDeflate=e.perMessageDeflate,this.usingBrowserWebSocket=r&&!e.forceNode,this.protocols=e.protocols,this.usingBrowserWebSocket||(u=s),o.call(this,e)}e.exports=E,d(E,o),E.prototype.name="websocket",E.prototype.supportsBinary=!0,E.prototype.doOpen=function(){if(this.check()){var e=this.uri(),t=this.protocols,n={agent:this.agent,perMessageDeflate:this.perMessageDeflate};n.pfx=this.pfx,n.key=this.key,n.passphrase=this.passphrase,n.cert=this.cert,n.ca=this.ca,n.ciphers=this.ciphers,n.rejectUnauthorized=this.rejectUnauthorized,this.extraHeaders&&(n.headers=this.extraHeaders),this.localAddress&&(n.localAddress=this.localAddress);try{this.ws=this.usingBrowserWebSocket&&!this.isReactNative?t?new u(e,t):new u(e):new u(e,t,n)}catch(e){return this.emit("error",e)}void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.supports&&this.ws.supports.binary?(this.supportsBinary=!0,this.ws.binaryType="nodebuffer"):this.ws.binaryType="arraybuffer",this.addEventListeners()}},E.prototype.addEventListeners=function(){var e=this;this.ws.onopen=function(){e.onOpen()},this.ws.onclose=function(){e.onClose()},this.ws.onmessage=function(t){e.onData(t.data)},this.ws.onerror=function(t){e.onError("websocket error",t)}},E.prototype.write=function(e){var n=this;this.writable=!1;for(var r=e.length,s=0,o=r;s<o;s++)!function(e){i.encodePacket(e,n.supportsBinary,(function(s){if(!n.usingBrowserWebSocket){var o={};if(e.options&&(o.compress=e.options.compress),n.perMessageDeflate)("string"==typeof s?t.byteLength(s):s.length)<n.perMessageDeflate.threshold&&(o.compress=!1)}try{n.usingBrowserWebSocket?n.ws.send(s):n.ws.send(s,o)}catch(e){l("websocket closed before onclose event")}--r||a()}))}(e[s]);function a(){n.emit("flush"),setTimeout((function(){n.writable=!0,n.emit("drain")}),0)}},E.prototype.onClose=function(){o.prototype.onClose.call(this)},E.prototype.doClose=function(){void 0!==this.ws&&this.ws.close()},E.prototype.uri=function(){var e=this.query||{},t=this.secure?"wss":"ws",n="";return this.port&&("wss"===t&&443!==Number(this.port)||"ws"===t&&80!==Number(this.port))&&(n=":"+this.port),this.timestampRequests&&(e[this.timestampParam]=c()),this.supportsBinary||(e.b64=1),(e=a.encode(e)).length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e},E.prototype.check=function(){return!(!u||"__initialize"in u&&this.name===E.prototype.name)}}).call(this,n(31).Buffer)},18:function(e,t,n){(function(r){function s(){var e;try{e=t.storage.debug}catch(e){}return!e&&void 0!==r&&"env"in r&&(e=r.env.DEBUG),e}(t=e.exports=n(88)).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(e){var n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return;var r="color: "+this.color;e.splice(1,0,r,"color: inherit");var s=0,o=0;e[0].replace(/%[a-zA-Z%]/g,(function(e){"%%"!==e&&(s++,"%c"===e&&(o=s))})),e.splice(o,0,r)},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=s,t.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(s())}).call(this,n(34))},25:function(e,t,n){var r,s=n(100),o=n(36),i=n(58),a=n(59),d=n(101);"undefined"!=typeof ArrayBuffer&&(r=n(60));var c="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),l="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),u=c||l;t.protocol=3;var E=t.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},S=s(E),p={type:"error",data:"parser error"},h=n(61);function R(e,t,n){for(var r=new Array(e.length),s=a(e.length,n),o=function(e,n,s){t(n,(function(t,n){r[e]=n,s(t,r)}))},i=0;i<e.length;i++)o(i,e[i],s)}t.encodePacket=function(e,n,r,s){"function"==typeof n&&(s=n,n=!1),"function"==typeof r&&(s=r,r=null);var o=void 0===e.data?void 0:e.data.buffer||e.data;if("undefined"!=typeof ArrayBuffer&&o instanceof ArrayBuffer)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);var s=e.data,o=new Uint8Array(s),i=new Uint8Array(1+s.byteLength);i[0]=E[e.type];for(var a=0;a<o.length;a++)i[a+1]=o[a];return r(i.buffer)}(e,n,s);if(void 0!==h&&o instanceof h)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);if(u)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);var s=new FileReader;return s.onload=function(){t.encodePacket({type:e.type,data:s.result},n,!0,r)},s.readAsArrayBuffer(e.data)}(e,n,r);var s=new Uint8Array(1);s[0]=E[e.type];var o=new h([s.buffer,e.data]);return r(o)}(e,n,s);if(o&&o.base64)return function(e,n){var r="b"+t.packets[e.type]+e.data.data;return n(r)}(e,s);var i=E[e.type];return void 0!==e.data&&(i+=r?d.encode(String(e.data),{strict:!1}):String(e.data)),s(""+i)},t.encodeBase64Packet=function(e,n){var r,s="b"+t.packets[e.type];if(void 0!==h&&e.data instanceof h){var o=new FileReader;return o.onload=function(){var e=o.result.split(",")[1];n(s+e)},o.readAsDataURL(e.data)}try{r=String.fromCharCode.apply(null,new Uint8Array(e.data))}catch(t){for(var i=new Uint8Array(e.data),a=new Array(i.length),d=0;d<i.length;d++)a[d]=i[d];r=String.fromCharCode.apply(null,a)}return s+=btoa(r),n(s)},t.decodePacket=function(e,n,r){if(void 0===e)return p;if("string"==typeof e){if("b"===e.charAt(0))return t.decodeBase64Packet(e.substr(1),n);if(r&&!1===(e=function(e){try{e=d.decode(e,{strict:!1})}catch(e){return!1}return e}(e)))return p;var s=e.charAt(0);return Number(s)==s&&S[s]?e.length>1?{type:S[s],data:e.substring(1)}:{type:S[s]}:p}s=new Uint8Array(e)[0];var o=i(e,1);return h&&"blob"===n&&(o=new h([o])),{type:S[s],data:o}},t.decodeBase64Packet=function(e,t){var n=S[e.charAt(0)];if(!r)return{type:n,data:{base64:!0,data:e.substr(1)}};var s=r.decode(e.substr(1));return"blob"===t&&h&&(s=new h([s])),{type:n,data:s}},t.encodePayload=function(e,n,r){"function"==typeof n&&(r=n,n=null);var s=o(e);if(n&&s)return h&&!u?t.encodePayloadAsBlob(e,r):t.encodePayloadAsArrayBuffer(e,r);if(!e.length)return r("0:");R(e,(function(e,r){t.encodePacket(e,!!s&&n,!1,(function(e){r(null,function(e){return e.length+":"+e}(e))}))}),(function(e,t){return r(t.join(""))}))},t.decodePayload=function(e,n,r){if("string"!=typeof e)return t.decodePayloadAsBinary(e,n,r);var s;if("function"==typeof n&&(r=n,n=null),""===e)return r(p,0,1);for(var o,i,a="",d=0,c=e.length;d<c;d++){var l=e.charAt(d);if(":"===l){if(""===a||a!=(o=Number(a)))return r(p,0,1);if(a!=(i=e.substr(d+1,o)).length)return r(p,0,1);if(i.length){if(s=t.decodePacket(i,n,!1),p.type===s.type&&p.data===s.data)return r(p,0,1);if(!1===r(s,d+o,c))return}d+=o,a=""}else a+=l}return""!==a?r(p,0,1):void 0},t.encodePayloadAsArrayBuffer=function(e,n){if(!e.length)return n(new ArrayBuffer(0));R(e,(function(e,n){t.encodePacket(e,!0,!0,(function(e){return n(null,e)}))}),(function(e,t){var r=t.reduce((function(e,t){var n;return e+(n="string"==typeof t?t.length:t.byteLength).toString().length+n+2}),0),s=new Uint8Array(r),o=0;return t.forEach((function(e){var t="string"==typeof e,n=e;if(t){for(var r=new Uint8Array(e.length),i=0;i<e.length;i++)r[i]=e.charCodeAt(i);n=r.buffer}s[o++]=t?0:1;var a=n.byteLength.toString();for(i=0;i<a.length;i++)s[o++]=parseInt(a[i]);s[o++]=255;for(r=new Uint8Array(n),i=0;i<r.length;i++)s[o++]=r[i]})),n(s.buffer)}))},t.encodePayloadAsBlob=function(e,n){R(e,(function(e,n){t.encodePacket(e,!0,!0,(function(e){var t=new Uint8Array(1);if(t[0]=1,"string"==typeof e){for(var r=new Uint8Array(e.length),s=0;s<e.length;s++)r[s]=e.charCodeAt(s);e=r.buffer,t[0]=0}var o=(e instanceof ArrayBuffer?e.byteLength:e.size).toString(),i=new Uint8Array(o.length+1);for(s=0;s<o.length;s++)i[s]=parseInt(o[s]);if(i[o.length]=255,h){var a=new h([t.buffer,i.buffer,e]);n(null,a)}}))}),(function(e,t){return n(new h(t))}))},t.decodePayloadAsBinary=function(e,n,r){"function"==typeof n&&(r=n,n=null);for(var s=e,o=[];s.byteLength>0;){for(var a=new Uint8Array(s),d=0===a[0],c="",l=1;255!==a[l];l++){if(c.length>310)return r(p,0,1);c+=a[l]}s=i(s,2+c.length),c=parseInt(c);var u=i(s,0,c);if(d)try{u=String.fromCharCode.apply(null,new Uint8Array(u))}catch(e){var E=new Uint8Array(u);u="";for(l=0;l<E.length;l++)u+=String.fromCharCode(E[l])}o.push(u),s=i(s,c)}var S=o.length;o.forEach((function(e,s){r(t.decodePacket(e,n,!0),s,S)}))}},42:function(e,t,n){"use strict";n.d(t,"b",(function(){return Jt})),n.d(t,"a",(function(){return s}));var r={};n.r(r),n.d(r,"ON_INCOMING_STREAM",(function(){return c})),n.d(r,"ON_INCOMING_SCREEN_STREAM",(function(){return l})),n.d(r,"STREAM_ENDED",(function(){return u})),n.d(r,"PEER_UPDATED",(function(){return E})),n.d(r,"PEER_JOINED",(function(){return S})),n.d(r,"PEER_LEFT",(function(){return p})),n.d(r,"PEER_CONNECTION_STATE",(function(){return h})),n.d(r,"DATA_CHANNEL_STATE",(function(){return R})),n.d(r,"ON_INCOMING_MESSAGE",(function(){return g})),n.d(r,"HANDSHAKE_PROGRESS",(function(){return m})),n.d(r,"SERVER_PEER_JOINED",(function(){return I})),n.d(r,"SERVER_PEER_LEFT",(function(){return f})),n.d(r,"CANDIDATE_PROCESSING_STATE",(function(){return T})),n.d(r,"CANDIDATE_GENERATION_STATE",(function(){return O})),n.d(r,"CANDIDATES_GATHERED",(function(){return A})),n.d(r,"DATA_STREAM_STATE",(function(){return C})),n.d(r,"DATA_TRANSFER_STATE",(function(){return _})),n.d(r,"ON_INCOMING_DATA",(function(){return N})),n.d(r,"ON_INCOMING_DATA_REQUEST",(function(){return D})),n.d(r,"ON_INCOMING_DATA_STREAM",(function(){return y})),n.d(r,"ON_INCOMING_DATA_STREAM_STARTED",(function(){return v})),n.d(r,"ON_INCOMING_DATA_STREAM_STOPPED",(function(){return M})),n.d(r,"GET_PEERS_STATE_CHANGE",(function(){return P})),n.d(r,"SESSION_DISCONNECT",(function(){return k})),n.d(r,"STREAM_MUTED",(function(){return w})),n.d(r,"CHANNEL_OPEN",(function(){return b})),n.d(r,"CHANNEL_REOPEN",(function(){return L})),n.d(r,"CHANNEL_CLOSE",(function(){return G})),n.d(r,"CHANNEL_MESSAGE",(function(){return U})),n.d(r,"CHANNEL_ERROR",(function(){return F})),n.d(r,"CHANNEL_RETRY",(function(){return B})),n.d(r,"SOCKET_ERROR",(function(){return V})),n.d(r,"SYSTEM_ACTION",(function(){return x})),n.d(r,"MEDIA_ACCESS_FALLBACK",(function(){return H})),n.d(r,"MEDIA_ACCESS_REQUIRED",(function(){return j})),n.d(r,"MEDIA_ACCESS_STOPPED",(function(){return W})),n.d(r,"MEDIA_ACCESS_SUCCESS",(function(){return K})),n.d(r,"RECORDING_STATE",(function(){return $})),n.d(r,"LOCAL_MEDIA_MUTED",(function(){return Y})),n.d(r,"MEDIA_ACCESS_ERROR",(function(){return q})),n.d(r,"GET_CONNECTION_STATUS_STATE_CHANGE",(function(){return J})),n.d(r,"READY_STATE_CHANGE",(function(){return X})),n.d(r,"ROOM_LOCK",(function(){return Q})),n.d(r,"INTRODUCE_STATE_CHANGE",(function(){return z})),n.d(r,"ICE_CONNECTION_STATE",(function(){return Z})),n.d(r,"BYE",(function(){return ee})),n.d(r,"RTMP_STATE",(function(){return te})),n.d(r,"LOGGED_ON_CONSOLE",(function(){return ne})),n.d(r,"MEDIA_INFO_DELETED",(function(){return re})),n.d(r,"STORED_MESSAGES",(function(){return se})),n.d(r,"ENCRYPT_SECRETS_UPDATED",(function(){return oe})),n.d(r,"PERSISTENT_MESSAGE_STATE",(function(){return ie})),n.d(r,"ROOM_REJOIN",(function(){return ae}));var s={};n.r(s),n.d(s,"DATA_CHANNEL_STATE",(function(){return Pe})),n.d(s,"DATA_CHANNEL_TYPE",(function(){return ke})),n.d(s,"DATA_CHANNEL_MESSAGE_ERROR",(function(){return we})),n.d(s,"DATA_TRANSFER_DATA_TYPE",(function(){return be})),n.d(s,"DT_PROTOCOL_VERSION",(function(){return Le})),n.d(s,"DATA_TRANSFER_TYPE",(function(){return Ge})),n.d(s,"DATA_TRANSFER_SESSION_TYPE",(function(){return Ue})),n.d(s,"DATA_TRANSFER_STATE",(function(){return Fe})),n.d(s,"AUTH_STATE",(function(){return Be})),n.d(s,"DATA_STREAM_STATE",(function(){return Ve})),n.d(s,"CANDIDATE_GENERATION_STATE",(function(){return xe})),n.d(s,"CANDIDATE_PROCESSING_STATE",(function(){return He})),n.d(s,"ICE_CONNECTION_STATE",(function(){return je})),n.d(s,"TURN_TRANSPORT",(function(){return We})),n.d(s,"PEER_CONNECTION_STATE",(function(){return Ke})),n.d(s,"GET_CONNECTION_STATUS_STATE",(function(){return $e})),n.d(s,"SERVER_PEER_TYPE",(function(){return Ye})),n.d(s,"BUNDLE_POLICY",(function(){return qe})),n.d(s,"RTCP_MUX_POLICY",(function(){return Je})),n.d(s,"PEER_CERTIFICATE",(function(){return Xe})),n.d(s,"HANDSHAKE_PROGRESS",(function(){return Qe})),n.d(s,"GET_PEERS_STATE",(function(){return ze})),n.d(s,"INTRODUCE_STATE",(function(){return Ze})),n.d(s,"SYSTEM_ACTION",(function(){return et})),n.d(s,"SYSTEM_ACTION_REASON",(function(){return tt})),n.d(s,"READY_STATE_CHANGE",(function(){return nt})),n.d(s,"READY_STATE_CHANGE_ERROR",(function(){return rt})),n.d(s,"REGIONAL_SERVER",(function(){return st})),n.d(s,"LOG_LEVEL",(function(){return ot})),n.d(s,"SOCKET_ERROR",(function(){return it})),n.d(s,"SOCKET_FALLBACK",(function(){return at})),n.d(s,"SM_PROTOCOL_VERSION",(function(){return dt})),n.d(s,"VIDEO_CODEC",(function(){return ct})),n.d(s,"AUDIO_CODEC",(function(){return lt})),n.d(s,"MEDIA_SOURCE",(function(){return ut})),n.d(s,"VIDEO_RESOLUTION",(function(){return Et})),n.d(s,"MEDIA_ACCESS_FALLBACK_STATE",(function(){return St})),n.d(s,"RECORDING_STATE",(function(){return pt})),n.d(s,"CHUNK_FILE_SIZE",(function(){return ht})),n.d(s,"MOZ_CHUNK_FILE_SIZE",(function(){return Rt})),n.d(s,"BINARY_FILE_SIZE",(function(){return gt})),n.d(s,"MOZ_BINARY_FILE_SIZE",(function(){return mt})),n.d(s,"CHUNK_DATAURL_SIZE",(function(){return It})),n.d(s,"DC_PROTOCOL_TYPE",(function(){return ft})),n.d(s,"SIG_MESSAGE_TYPE",(function(){return Tt})),n.d(s,"STREAM_STATUS",(function(){return Ot})),n.d(s,"GROUP_MESSAGE_LIST",(function(){return At})),n.d(s,"VIDEO_QUALITY",(function(){return Ct})),n.d(s,"SDP_SEMANTICS",(function(){return _t})),n.d(s,"RTMP_STATE",(function(){return Nt})),n.d(s,"MEDIA_STATUS",(function(){return Dt})),n.d(s,"TAGS",(function(){return yt})),n.d(s,"MEDIA_TYPE",(function(){return vt})),n.d(s,"TRACK_READY_STATE",(function(){return Mt})),n.d(s,"TRACK_KIND",(function(){return Pt})),n.d(s,"MEDIA_STATE",(function(){return kt})),n.d(s,"MEDIA_INFO",(function(){return wt})),n.d(s,"SDK_VERSION",(function(){return bt})),n.d(s,"SDK_NAME",(function(){return Lt})),n.d(s,"API_VERSION",(function(){return Gt})),n.d(s,"SIGNALING_VERSION",(function(){return Ut})),n.d(s,"BROWSER_AGENT",(function(){return Ft})),n.d(s,"PEER_TYPE",(function(){return Bt})),n.d(s,"SOCKET_EVENTS",(function(){return Vt})),n.d(s,"SOCKET_TYPE",(function(){return xt})),n.d(s,"STATES",(function(){return Ht})),n.d(s,"EVENTS",(function(){return jt}));var o=n(86),i=n.n(o),a=n(172);a.a.options=a.a.options||{},a.a.onwebrtcreadyDone=!1,a.a.WebRTCPlugin={plugin:null},a.a._onwebrtcreadies=[],a.a.webRTCReady=function(e){if("function"!=typeof e)throw new Error("Callback provided is not a function");var t=function(){"function"==typeof window.require&&"function"==typeof a.a._defineMediaSourcePolyfill&&a.a._defineMediaSourcePolyfill(),e(null!==a.a.WebRTCPlugin.plugin)};!0===a.a.onwebrtcreadyDone?t():a.a._onwebrtcreadies.push(t)},a.a.maybeThroughWebRTCReady=function(){a.a.onwebrtcreadyDone||(a.a.onwebrtcreadyDone=!0,a.a._onwebrtcreadies.length?a.a._onwebrtcreadies.forEach((function(e){"function"==typeof e&&e(null!==a.a.WebRTCPlugin.plugin)})):"function"==typeof a.a.onwebrtcready&&a.a.onwebrtcready(null!==a.a.WebRTCPlugin.plugin))},window.webrtcDetectedBrowser=null,window.webrtcDetectedVersion=null,window.webrtcMinimumVersion=null,window.webrtcDetectedDCSupport=null,a.a.parseWebrtcDetectedBrowser=function(){var e=null;if(window.navigator.userAgent.match(/React-Native/gi)||navigator.userAgent.match(/React-Native/gi))window.webrtcDetectedBrowser="react-native",window.webrtcDetectedVersion="",window.webrtcMinimumVersion=0,window.webrtcDetectedType="react-native",window.webrtcDetectedDCSupport=null;else if(window.opr&&opr.addons||window.opera||navigator.userAgent.indexOf(" OPR/")>=0)e=navigator.userAgent.match(/OPR\/(\d+)/i)||[],window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=26,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport="SCTP";else if(navigator.userAgent.match(/Bowser\/[0-9.]*/g)){e=navigator.userAgent.match(/Bowser\/[0-9.]*/g)||[];var t=parseInt((navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[])[2]||"0",10);window.webrtcDetectedBrowser="bowser",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=0,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=t>30?"SCTP":"RTP"}else if(navigator.userAgent.indexOf("OPiOS")>0)e=navigator.userAgent.match(/OPiOS\/([0-9]+)\./),window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("CriOS")>0)e=navigator.userAgent.match(/CriOS\/([0-9]+)\./)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedBrowser="chrome",window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("FxiOS")>0)e=navigator.userAgent.match(/FxiOS\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(document.documentMode)e=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedBrowser="IE",window.webrtcDetectedVersion=parseInt(e[1],10),window.webrtcMinimumVersion=9,window.webrtcDetectedType="plugin",window.webrtcDetectedDCSupport="SCTP",webrtcDetectedVersion||(e=/\bMSIE[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10));else if(window.StyleMedia||navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e=navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)||[],window.webrtcDetectedBrowser="edge",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=13.10547,window.webrtcDetectedType="ms",window.webrtcDetectedDCSupport=null;else if("undefined"!=typeof InstallTrigger||navigator.userAgent.indexOf("irefox")>0)e=navigator.userAgent.match(/Firefox\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=33,window.webrtcDetectedType="moz",window.webrtcDetectedDCSupport="SCTP";else if(window.chrome&&window.chrome.webstore||navigator.userAgent.indexOf("Chrom")>0)e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[],window.webrtcDetectedBrowser="chrome",window.webrtcDetectedVersion=parseInt(e[2]||"0",10),window.webrtcMinimumVersion=38,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=window.webrtcDetectedVersion>30?"SCTP":"RTP";else if(/constructor/i.test(window.HTMLElement)||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString()||navigator.userAgent.match(/AppleWebKit\/(\d+)\./)||navigator.userAgent.match(/Version\/(\d+).(\d+)/)){e=navigator.userAgent.match(/version\/(\d+)\.(\d+)/i)||[];var n=navigator.userAgent.match(/AppleWebKit\/(\d+)/i)||[],r=navigator.userAgent.match(/(iPhone|iPad)/gi),s=n.length>=1&&n[1]>=604;if(window.webrtcDetectedBrowser="safari",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=7,r)window.webrtcDetectedType=s?"AppleWebKit":null;else{var o=window.webrtcDetectedVersion,i=parseInt(e[2]||"0",10),d=11==o&&i<2;window.webrtcDetectedType=!s||a.a.options.forceSafariPlugin&&d?"plugin":"AppleWebKit"}window.webrtcDetectedDCSupport="SCTP"}a.a.webrtcDetectedBrowser=window.webrtcDetectedBrowser,a.a.webrtcDetectedVersion=window.webrtcDetectedVersion,a.a.webrtcMinimumVersion=window.webrtcMinimumVersion,a.a.webrtcDetectedType=window.webrtcDetectedType,a.a.webrtcDetectedDCSupport=window.webrtcDetectedDCSupport},a.a.addExtensions=function(){var e=null,t=null;navigator.mozGetUserMedia?(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}):navigator.webkitGetUserMedia?(e=function(e,t){return a.a.webrtcDetectedVersion>=43?e.srcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):console.error("Error attaching stream to element."),e},t=function(e,t){return a.a.webrtcDetectedVersion>=43?e.srcObject=t.srcObject:e.src=t.src,e}):"AppleWebKit"===a.a.webrtcDetectedType&&(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}),window.attachMediaStream=e,window.reattachMediaStream=t,a.a.attachMediaStream=e,a.a.reattachMediaStream=t},a.a.parseWebrtcDetectedBrowser(),a.a.addExtensions(),a.a.maybeThroughWebRTCReady();var d=a.a;const c="onIncomingStream",l="onIncomingScreenStream",u="streamEnded",E="peerUpdated",S="peerJoined",p="peerLeft",h="peerConnectionState",R="dataChannelState",g="onIncomingMessage",m="handshakeProgress",I="serverPeerJoined",f="serverPeerLeft",T="candidateProcessingState",O="candidateGenerationState",A="candidatesGathered",C="dataStreamState",_="dataTransferState",N="onIncomingData",D="onIncomingDataRequest",y="onIncomingDataStream",v="onIncomingDataStreamStarted",M="onIncomingDataStreamStopped",P="getPeersStateChange",k="sessionDisconnect",w="streamMuted",b="channelOpen",L="channelReopen",G="channelClose",U="channelMessage",F="channelError",B="channelRetry",V="socketError",x="systemAction",H="mediaAccessFallback",j="mediaAccessRequired",W="mediaAccessStopped",K="mediaAccessSuccess",$="recordingState",Y="localMediaMuted",q="mediaAccessError",J="getConnectionStatusStateChange",X="readyStateChange",Q="roomLock",z="introduceStateChange",Z="iceConnectionState",ee="bye",te="rtmpState",ne="loggedOnConsole",re="mediaInfoDeleted",se="storedMessages",oe="encryptSecretsUpdated",ie="persistentMessageState",ae="roomRejoin";var de=class{constructor(e,t){this.name=e,this.detail=t}};const ce=(e={})=>new de(c,{detail:e}),le=(e={})=>new de(l,{detail:e}),ue=(e={})=>new de(u,{detail:e}),Ee=(e={})=>new de(w,{detail:e}),Se=(e={})=>new de(R,{detail:e}),pe=(e={})=>new de(g,{detail:e}),he=(e={})=>new de(m,{detail:e}),Re=(e={})=>new de(X,{detail:e}),ge=e=>new de(T,{detail:e}),me=e=>new de(O,{detail:e}),Ie=e=>new de(Z,{detail:e}),fe=(e={})=>new de(E,{detail:e}),Te=(e={})=>new de(S,{detail:e}),Oe=(e={})=>new de(p,{detail:e}),Ae=(e={})=>new de(f,{detail:e}),Ce=(e={})=>new de(P,{detail:e}),_e=(e={})=>new de(h,{detail:e}),Ne=(e={})=>new de(J,{detail:e}),De=e=>new de(V,{detail:e}),ye=(e={})=>new de(H,{detail:e}),ve=(e={})=>new de(te,{detail:e}),Me=(e={})=>new de(q,{detail:e}),Pe={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error",CREATE_ERROR:"createError",BUFFERED_AMOUNT_LOW:"bufferedAmountLow",SEND_MESSAGE_ERROR:"sendMessageError"},ke={MESSAGING:"messaging",DATA:"data"},we={MESSAGE:"message",TRANSFER:"transfer"},be={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob",STRING:"string"},Le="0.1.3",Ge={UPLOAD:"upload",DOWNLOAD:"download"},Ue={BLOB:"blob",DATA_URL:"dataURL"},Fe={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted",USER_REJECTED:"userRejected",USER_UPLOAD_REQUEST:"userRequest",START_ERROR:"startError"},Be={REQUEST:"request",SUCCESS:"success",ERROR:"error"},Ve={SENDING_STARTED:"sendStart",SENDING_STOPPED:"sendStop",RECEIVING_STARTED:"receiveStart",RECEIVING_STOPPED:"receiveStop",RECEIVED:"received",SENT:"sent",ERROR:"error",START_ERROR:"startError"},xe={NEW:"new",GATHERING:"gathering",COMPLETED:"complete"},He={RECEIVED:"received",DROPPED:"dropped",BUFFERED:"buffered",PROCESSING:"processing",PROCESS_SUCCESS:"processSuccess",PROCESS_ERROR:"processError"},je={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},We={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none",ALL:"all"},Ke={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",CLOSED:"closed",CONNECTING:"connecting",FAILED:"failed",DISCONNECTED:"disconnected",CONNECTED:"connected"},$e={RETRIEVING:0,RETRIEVE_SUCCESS:1,RETRIEVE_ERROR:-1},Ye={MCU:"mcu"},qe={MAX_COMPAT:"max-compat",BALANCED:"balanced",MAX_BUNDLE:"max-bundle",NONE:"none"},Je={REQUIRE:"require",NEGOTIATE:"negotiate"},Xe={RSA:"RSA",ECDSA:"ECDSA",AUTO:"AUTO"},Qe={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",ERROR:"error"},ze={ENQUIRED:"enquired",DISPATCHED:"dispatched",RECEIVED:"received"},Ze={INTRODUCING:"introducing",ERROR:"error"},et={WARNING:"warning",REJECT:"reject",LOCKED:"locked"},tt={CREDENTIALS_EXPIRED:"oldTimeStamp",CREDENTIALS_ERROR:"credentialError",DUPLICATED_LOGIN:"duplicatedLogin",ROOM_NOT_STARTED:"notStart",EXPIRED:"expired",ROOM_LOCKED:"locked",FAST_MESSAGE:"fastmsg",ROOM_CLOSING:"toclose",ROOM_CLOSED:"roomclose",SERVER_ERROR:"serverError",KEY_ERROR:"keyFailed"},nt={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},rt={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NO_MEETING_RECORD_FOUND:4010,API_OVER_SEAT_LIMIT:4020,API_RETRIEVAL_FAILED:4021,API_WRONG_ACCESS_DOMAIN:5005,XML_HTTP_REQUEST_ERROR:-1,XML_HTTP_NO_REPONSE_ERROR:-2,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,ADAPTER_NO_LOADED:7,PARSE_CODECS:8},st={APAC1:"",US1:""},ot={DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0,NONE:-1},it={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},at={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},dt="2.1.0",ct={AUTO:"auto",VP8:"VP8",H264:"H264",VP9:"VP9"},lt={AUTO:"auto",ISAC:"ISAC",OPUS:"opus",ILBC:"ILBC",G722:"G722",PCMU:"PCMU",PCMA:"PCMA"},ut={SCREEN:"screen",WINDOW:"window",TAB:"tab",TAB_AUDIO:"audio",APPLICATION:"application",BROWSER:"browser",CAMERA:"camera"},Et={QQVGA:{width:160,height:120},HQVGA:{width:240,height:160},QVGA:{width:320,height:240},WQVGA:{width:384,height:240},HVGA:{width:480,height:320},VGA:{width:640,height:480},WVGA:{width:768,height:480},FWVGA:{width:854,height:480},SVGA:{width:800,height:600},DVGA:{width:960,height:640},WSVGA:{width:1024,height:576},HD:{width:1280,height:720},HDPLUS:{width:1600,height:900},FHD:{width:1920,height:1080},QHD:{width:2560,height:1440},WQXGAPLUS:{width:3200,height:1800},UHD:{width:3840,height:2160},UHDPLUS:{width:5120,height:2880},FUHD:{width:7680,height:4320},QUHD:{width:15360,height:8640}},St={FALLBACKING:0,FALLBACKED:1,ERROR:-1},pt={START:0,STOP:1,LINK:2,ERROR:-1},ht=49152,Rt=12288,gt=65456,mt=16384,It=1212,ft={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},Tt={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",CANDIDATE:"candidate",BYE:"bye",REDIRECT:"redirect",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",PUBLIC_MESSAGE:"public",PRIVATE_MESSAGE:"private",STREAM:"stream",GROUP:"group",GET_PEERS:"getPeers",PEER_LIST:"peerList",INTRODUCE:"introduce",INTRODUCE_ERROR:"introduceError",APPROACH:"approach",START_RECORDING:"startRecordingRoom",STOP_RECORDING:"stopRecordingRoom",RECORDING:"recordingEvent",END_OF_CANDIDATES:"endOfCandidates",START_SCREENSHARE:"startScreenshare",START_RTMP:"startRTMP",STOP_RTMP:"stopRTMP",RTMP:"rtmpEvent",MEDIA_INFO_EVENT:"mediaInfoEvent",MESSAGE:"message",GET_STORED_MESSAGES:"getStoredMessages",STORED_MESSAGES:"storedMessages",RESTART:"restart"},Ot={ENDED:"ended"},At=[Tt.STREAM,Tt.UPDATE_USER,Tt.PUBLIC_MESSAGE],Ct={HD:{video:3200,audio:150},HQ:{video:1200,audio:80},SQ:{video:800,audio:30},LQ:{video:400,audio:20}},_t={PLAN_B:"plan-b",UNIFIED:"unified-plan"},Nt={START:0,STOP:1,ERROR:-1},Dt={MUTED:0,ACTIVE:1,UNAVAILABLE:-1},yt={SKYLINK_EVENT:"SKYLINK EVENT",SKYLINK_ERROR:"SKYLINK ERROR",STATS_MODULE:"RTCStatsReport",SESSION_DESCRIPTION:"RTCSessionDescription",PEER_CONNECTION:"RTCPeerConnection",CANDIDATE_HANDLER:"RTCIceCandidate",DATA_CHANNEL:"RTCDataChannel",SIG_SERVER:"SIG SERVER",PEER_MEDIA:"PEER MEDIA",PEER_INFORMATION:"PEER INFORMATION",ROOM:"ROOM",RECORDING:"RECORDING",MEDIA_STREAM:"MEDIA STREAM",MESSAGING:"MESSAGING",ASYNC_MESSAGING:"ASYNC MESSAGING",ENCRYPTED_MESSAGING:"ENCRYPTED MESSAGING",STATS:"STATS"},vt={AUDIO_MIC:"audioMic",VIDEO_CAMERA:"videoCamera",VIDEO_SCREEN:"videoScreen",VIDEO_OTHER:"videoOther",AUDIO:"audio",VIDEO:"video"},Mt={LIVE:"live",ENDED:"ended"},Pt={AUDIO:"audio",VIDEO:"video"},kt={MUTED:"muted",ACTIVE:"active",STOPPED:"stopped",UNAVAILABLE:"unavailable"},wt={PUBLISHER_ID:"publisherId",MEDIA_ID:"mediaId",MEDIA_TYPE:"mediaType",MEDIA_STATE:"mediaState",TRANSCEIVER_MID:"transceiverMid",MEDIA_META_DATA:"mediaMetaData",SIMULCAST:"simulcast",STREAM_ID:"streamId"},bt="2.x.x",Lt={WEB:"Web SDK",ANDROID:"Android SDK",IOS:"iOS SDK",CPP:"C++ SDK"},Gt="9.0.0",Ut="sig-v2",Ft={CHROME:"chrome",FIREFOX:"firefox",SAFARI:"safari",REACT_NATIVE:"react-native"},Bt={MCU:"MCU"},Vt={CONNECT:"connect",DISCONNECT:"disconnect",RECONNECT_ATTEMPT:"reconnect_attempt",RECONNECT_SUCCESS:"reconnect_success",RECONNECT_FAILED:"reconnect_failed",RECONNECT_ERROR:"reconnect_error",MESSAGE:"message",ERROR:"error"},xt={POLLING:"Polling",WEBSOCKET:"WebSocket",XHR_POLLING:"xhr-polling",JSONP_POLLING:"jsonp-polling"},Ht={SIGNALING:Vt},jt=r;var Wt={INIT:{ERRORS:{NO_ADAPTER:"AdapterJS dependency is not loaded or incorrect AdapterJS dependency is used",NO_SOCKET_IO:"Socket.io not loaded - Please load socket.io",NO_FETCH_SUPPORT:"Fetch API is not supported in your browser. Please make sure you are using a modern browser: https://caniuse.com/#search=fetch",NO_APP_KEY:"Please provide an App Key - Get one at console.temasys.io!",AUTH_CORS:"Promise rejected due to CORS forbidden request - Please visit: http://support.temasys.com.sg/support/solutions/articles/12000006761-i-get-a-403-forbidden-access-is-denied-when-i-load-the-application-why-",AUTH_GENERAL:"Promise rejected due to network issue",SOCKET_CREATE_FAILED:"Failed creating socket connection object ->",SOCKET_ERROR_ABORT:"Reconnection aborted as the connection timed out or there no more available ports, transports and final attempts left"},INCOMPATIBLE_BROWSER:"Incompatible browser agent detected",INFO:{API_SUCCESS:"Promise resolved: APP Authenticated Successfully!"}},SOCKET:{ABORT_RECONNECT:"Aborting socket reconnect"},JOIN_ROOM:{ERRORS:{CODEC_SUPPORT:"No audio/video codecs available to start connection"}},ROOM:{ERRORS:{STOP:{SCREEN_SHARE:"Error stopping screenshare"},NOT_IN_ROOM:"User is not in room",NO_PEERS:"No peers in room"},LEAVE_ROOM:{ERROR:"Leave room error --\x3e",NO_PEERS:"No peers in room",DROPPING_HANGUP:"Dropping hang-up from remote peer",LEAVE_ALL_ROOMS:{SUCCESS:"Successfully left all rooms",ERROR:"Leave all rooms error --\x3e"},PEER_LEFT:{START:"Initiating peer left process",SUCCESS:"Successfully completed peer left process",ERROR:"Failed peer left process"},SENDING_BYE:"Sending bye message to all peers",DISCONNECT_SOCKET:{SUCCESS:"Successfully disconnected socket"},REMOVE_STATE:{SUCCESS:"Successfully removed room state"}}},ROOM_STATE:{NOT_FOUND:"Could not retrieve room state for room name/key",LEFT:"Peer left room",NO_ROOM_NAME:"No room name specified"},PEER_INFORMATIONS:{NO_PEER_INFO:"Not able to retrieve Peer Information for peerId:",UPDATE_USER_DATA:"Peer updated userData: ",OUTDATED_MSG:"Dropping outdated status ->",USER_DATA_NOT_JSON:"UserData is not JSON",SET_PEER_PRIORITY_WEIGHT:"Setting peerPriorityWeight with tiebreaker value from inRoom signalling message"},PEER_CONNECTION:{NOT_INITIALISED:"Peer Connection not initialised",CREATE_NEW:"Creating new Peer Connection",NO_PEER_CONNECTION:"No Peer Connection detected",PEER_ID_NOT_FOUND:"Peer Id not found",STATE_CHANGE:"Peer connection state changed ->",STATS_API_UNAVAILABLE:"getStats() API is not available",MCU:"MCU connected",FAILED_STATE:"Peer Connection state: failed",ADD_TRANSCEIVER:"Adding empty transceiver",ERRORS:{REMOVE_TRACK:"Error removing track from peer connection",NOT_FOUND:"Peer Connection not found"},REFRESH_CONNECTION:{START:"Refreshing peer connections",SUCCESS:"Peer Connection refreshed successfully",FAILED:"Peer Connection failed to refresh",COMPLETED:"All Peer Connections refreshed with resolve or errors",RESTART_ICE_UNAVAILABLE:"Dropping iceRestart option as it is not available on the peer connection",NOT_SUPPORTED:"Refresh connection not supported by browser",SEND_RESTART_OFFER:"Sending restart offer message to signaling server",NO_LOCAL_DESCRIPTION:"No localDescription set to connection. There could be a handshaking step error."}},PEER_PRIVILEGED:{not_privileged:"Please upgrade your key to privileged to use this function",no_appkey:"App key is not defined - Please authenticate again",getPeerListFromServer:"Enquired server for peers within the App space"},ICE_CONNECTION:{END_OF_CANDIDATES_SUCCESS:"Signaling of end-of-candidates remote ICE gathering",END_OF_CANDIDATES_FAILURE:"Failed signaling of end-of-candidates remote ICE gathering",ICE_GATHERING_STARTED:"ICE gathering has started",ICE_GATHERING_COMPLETED:"ICE gathering has completed",DROP_EOC:"Dropping of sending ICE candidate end-of-candidates signal or unused ICE candidates ->",STATE_CHANGE:"Ice connection state changed ->"},ICE_CANDIDATE:{DROPPING_CANDIDATE:"Dropping ICE candidate",INVALID_CANDIDATE:"Received invalid ICE candidate message ->",VALID_CANDIDATE:"Received ICE candidate ->",FILTERED_CANDIDATE:"Dropping received ICE candidate as it matches ICE candidate filtering flag ->",FILTERING_FLAG_NOT_HONOURED:"Not dropping received ICE candidate as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured ->",CANDIDATE_ADDED:"Added ICE candidate successfully",ADDING_CANDIDATE:"Adding ICE Candidate",FAILED_ADDING_CANDIDATE:"Failed adding ICE candidate ->",ADD_BUFFERED_CANDIDATE:"Adding buffered ICE candidate",ADD_CANDIDATE_TO_BUFFER:"Adding ICE candidate to buffer",CANDIDATE_GENERATED:"Generated ICE candidate ->",SENDING_CANDIDATE:"Sending ICE candidate ->"},SESSION_DESCRIPTION:{parsing_media_ssrc:"Parsing session description media SSRCs ->"},DATA_CHANNEL:{reviving_dataChannel:"Reviving Datachannel connection",refresh_error:"Not a valid Datachannel connection",CLOSING:"Closing DataChannel",closed:"Datachannel has closed",onclose_error:"Error in data-channel onclose callback",NO_REMOTE_DATA_CHANNEL:"Remote peer does not have data channel",ERRORS:{FAILED_CLOSING:"Failed closing DataChannels --\x3e ",NO_SESSIONS:"Peer Connection does not have DataChannel sessions"}},NEGOTIATION_PROGRESS:{SET_LOCAL_DESCRIPTION:"Successfully set local description --\x3e",SET_REMOTE_DESCRIPTION:"Successfully set remote description --\x3e",APPLYING_BUFFERED_REMOTE_OFFER:"Applying buffered remote offer",ERRORS:{FAILED_SET_LOCAL_DESCRIPTION:"Failed setting local description --\x3e",FAILED_SET_REMOTE_DESCRIPTION:"Failed setting remote description",FAILED_SET_REMOTE_ANSWER:"Peer failed to set remote answer.",FAILED_RENEGOTIATION:"Failed renegotiation after answerAck",NOT_STABLE:"Dropping of message as signaling state is not stable",PROCESSING_EXISTING_SDP:"Dropping message as there is another sessionDescription being processed --\x3e",OFFER_TIEBREAKER:"Dropping the received offer: self weight is greater than incoming offer weight --\x3e",NO_LOCAL_BUFFERED_OFFER:"FATAL: No buffered local offer found - Unable to setLocalDescription",ADDING_REMOTE_OFFER_TO_BUFFER:"Adding remote offer received to buffer as current negotiation has not completed"}},SIGNALING:{MESSAGE_ADDED_TO_BUFFER:"Message buffered as enter message has not been sent",ENTER_LISTENER:"Enter listener initialized",BUFFERED_MESSAGES_SENT:"Buffered messages sent",BUFFERED_MESSAGES_DROPPED:"Buffered messages dropped - no mid",OUTDATED_MSG:"Dropping outdated status ->",DROPPING_MUTE_EVENT:"Dropping mute audio / video event message as it is processed by mediaInfoEvent",BUFFER_NOT_NEEDED:"Enter message sent. Messages do not need to be buffered",ABORTING_OFFER:"Aborting offer as current negotiation has not completed"},MESSAGING:{PRIVATE_MESSAGE:"Sending private message to Peer",BROADCAST_MESSAGE:"Broadcasting message to Peers",RECEIVED_MESSAGE:"Received message from Peer",PERSISTENCE:{SEND_MESSAGE:"Sending persisted message",NOT_PERSISTED:"Message will not be persisted as persistent flag is set to false",STORED_MESSAGES:"Received stored messages for room",IS_PERSISTENT_CONFIG:"Persistent message flag is set to",ERRORS:{FAILED_SETTING_PERSISTENCE:"Failed setting persistent message flag",INVALID_TYPE:"Persistent message flag must be of type boolean",PRIVATE_MESSAGE:"Cannot persist private messages",PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED:"Persistent Message feature is not enabled. Enable this feature on the key under 'Advanced Settings' in the Temasys Console"}},ENCRYPTION:{SEND_MESSAGE:"Sending encrypted message",DELETE_ALL:"Deleting all stored secrets",ERRORS:{FAILED_DECRYPTING_MESSAGE:"Failed decrypting message",ENCRYPT_SECRET:"Incorrect secret provided",INVALID_SECRETS:"No or invalid secret and secret id provided",SET_SELECTED_SECRET:"Failed setting selected secret",DELETE_ENCRYPT_SECRETS:"Failed deleting secret",SET_ENCRYPT_SECRET:"Failed setting secret",SECRET_ID_NOT_FOUND:"Secret id not found",NO_SECRET_OR_SECRET_ID:"Secret and / or secret id not provided",INVALID_TYPE:"Secret and secret id must be of type string and not empty",SECRET_ID_NOT_UNIQUE:"Secret id provided is not unique",SECRET_ID_NOT_SELECTED:"Secret id not selected",SECRET_ID_NOT_PROVIDED:"Secret id not provided",SECRETS_NOT_PROVIDED:"Secrets not provided"}},ERRORS:{DROPPING_MESSAGE:"Dropping message",FAILED_SENDING_MESSAGE:"Failed to send user message"}},MEDIA_INFO:{UPDATE_SUCCESS:"Successfully updated media info",ERRORS:{NO_ASSOCIATED_STREAM_ID:"There is no streamId associated with the mediaId and transceiverMid pair",FAILED_PROCESSING_MEDIA_INFO_EVENT:"Failed to process mediaInfoEvent message",FAILED_UPDATING:"Failed to update media info",FAILED_PROCESSING_PEER_MEDIA:"Failed to process media info",FAILED_UPDATING_TRANSCEIVER_MID:"Failed updating media info transceiverMid after setLocalDescription",FAILED_SETTING_PEER_MEDIA_INFO:"Failed setting peer media at offer / answer",STREAM_ID_NOT_MATCHED:"There is no mediaInfo associated with the streamId"},WARN:{READ_ONLY_VALUE:"Attempting to change media info read only value: ",INVALID_MEDIA_TYPE:"Invalid media info media type: "},VIDEO_STATE_CHANGE:"Peers's video state changed to ->",AUDIO_STATE_CHANGE:"Peers's audio state changed to ->",VIDEO_SCREEN_STATE_CHANGE:"Peers's video screen state changed to ->"},MEDIA_STREAM:{STOP_SETTINGS:"Stopped streams with settings:",STOP_SUCCESS:"Successfully stopped stream",REMOTE_TRACK_REMOVED:"Remote MediaStreamTrack removed",START_FALLBACK:"Fall back to retrieve audio only stream",NO_OPTIONS:"No user media options provided",DEFAULT_OPTIONS:"Using default options",FALLBACK_SUCCESS:"Successfully retrieved audio fallback stream",START_SCREEN_SUCCESS:"Successfully retrieved screen share stream",STOP_SCREEN_SUCCESS:"Successfully stopped screen share stream",UPDATE_MUTED_SETTINGS:"Updated stream muted setting",UPDATE_MEDIA_STATUS:"Updated stream media status",AUDIO_MUTED:"Peers's audio muted: ",VIDEO_MUTED:"Peers's video muted: ",ERRORS:{STOP_SCREEN:"Error stopping screen share stream",START_SCREEN:"Error starting screen share stream",STOP_ADDED_STREAM:"Error stopping added stream",STOP_USER_MEDIA:"Error stopping user media",STOP_AUDIO_TRACK:"Error stopping audio tracks in stream",STOP_VIDEO_TRACK:"Error stopping video tracks in stream",STOP_MEDIA_TRACK:"Error stopping MediaTrack",STOP_SCREEN_TRACK:"Error stopping screen track in stream",DROPPING_ONREMOVETRACK:"Dropping onremovetrack",NO_STREAM:"No stream to process",INVALID_STREAM_ID:"No stream detected with stream id",NO_USER_MEDIA_STREAMS:"No user media streams detected",INVALID_STREAM_ID_TYPE:"Stream id is not a string",NO_STREAM_ID:"No stream id provided",PEER_SCREEN_ACTIVE:"Peer has existing screen share",FALLBACK:"Error retrieving fallback audio stream",INVALID_GUM_OPTIONS:"Invalid user media options",GET_USER_MEDIA:"Error retrieving stream from 'getUserMedia' method",INVALID_MUTE_OPTIONS:"Invalid muteStreams options provided",NO_STREAMS_MUTED:"No streams to mute",SEND_STREAM:"Error sending stream",INVALID_MEDIA_STREAM_ARRAY:"Array is not of type MediaStream",ACTIVE_STREAMS:"There are currently active streams being sent to remote peers. Please stop streams."}},STATS_MODULE:{NOT_INITIATED:"Stats Module is not initiated",STATS_DISCARDED:"Stats report discarded as peer has left the room",ERRORS:{RETRIEVE_STATS_FAILED:"Failed retrieving stats",POST_FAILED:"Failed posting to stats api",PARSE_FAILED:"Failed parsing stats report",STATS_IS_NULL:"Stats object is null",INVALID_TRACK_KIND:"Media kind is not audio or video"},HANDLE_ICE_GATHERING_STATS:{PROCESS_FAILED:"process_failed",PROCESS_SUCCESS:"process_success",PROCESSING:"processing",DROPPED:"dropped",BUFFERED:"buffered"},HANDLE_NEGOTIATION_STATS:{OFFER:{create:"create_offer",create_error:"error_create_offer",set:"set_offer",set_error:"error_set_offer",offer:"offer",dropped:"dropped_offer"},ANSWER:{create:"create_answer",create_error:"error_create_answer",set:"set_answer",set_error:"error_set_ANSWER",answer:"answer",dropped:"dropped_answer"}},HANDLE_DATA_CHANNEL_STATS:{open:"open",closed:"closed",reconnecting:"reconnecting"},HANDLE_CONNECTION_STATS:{},HANDLE_BANDWIDTH_STATS:{RETRIEVE_FAILED:"Failed posting bandwidth stats: ",NO_STATE:"No room state"},HANDLE_ICE_CONNECTION_STATS:{RETRIEVE_FAILED:"Failed retrieving stats: ",SEND_FAILED:"Failed sending ice connection stats: "},HANDLE_RECORDING_STATS:{START:"start",STOP:"stop",REQUEST_START:"request-start",REQUEST_STOP:"request-stop",ERROR_NO_MCU_START:"error-no-mcu-start",ERROR_NO_MCU_STOP:"error-no-mcu-stop",ERROR_START_ACTIVE:"error-start-when-active",ERROR_STOP_ACTIVE:"error-stop-when-active",ERROR_MIN_STOP:"error-min-stop",MCU_RECORDING_ERROR:"mcu-recording-error"}},RECORDING:{START_SUCCESS:"Started recording",STOP_SUCCESS:"Stopped recording",START_FAILED:"Failed to start recording",STOP_FAILED:"Failed to stop recording",MIN_RECORDING_TIME_REACHED:"4 seconds has been recorded - Recording can be stopped now",ERRORS:{MCU_NOT_CONNECTED:"MCU is not connected",EXISTING_RECORDING_IN_PROGRESS:"There is an existing recording in-progress",NO_RECORDING_IN_PROGRESS:"There is no existing recording in-progress",MIN_RECORDING_TIME:"4 seconds has not been recorded yet",STOP_ABRUPT:"Recording stopped abruptly before 4 seconds",SESSION_EMPTY:'Received request of "off" but the session is empty',MCU_RECORDING_ERROR:"Recording error received from MCU"}},RTMP:{start_no_mcu:"Unable to start RTMP session as MCU is not connected",stop_no_mcu:"Unable to stop RTMP as MCU is not connected",start_no_stream_id:"Unable to start RTMP Session stream id is missing",start_no_endpoint:"Unable to start RTMP Session as Endpoint is missing",starting_rtmp:"Starting RTMP Session",stopping_rtmp:"Stopping RTMP Session",message_received_from_sig:"Received RTMP Session message ->",stop_session_empty:'Received request of "off" but the session is empty',stopped_success:"Stopped RTMP Session",started_success:"Started RTMP Session",error_session_empty:"Received error but the session is empty ->",error_session:"RTMP session failure ->",error_Session_abrupt:"Stopped RTMP session abruptly"},PERSISTENT_MESSAGE:{ERRORS:{NO_DEPENDENCY:"CryptoJS is not available"}},UTILS:{INVALID_BROWSER_AGENT:"Invalid browser agent"},LOGGER:{EVENT_DISPATCHED:"Event dispatched",EVENT_REGISTERED:"Event successfully registered",EVENT_UNREGISTERED:"Event successfully unregistered",EVENT_DISPATCH_ERROR:"Error dispatching event",EVENT_REGISTER_ERROR:"Error registering event",EVENT_UNREGISTER_ERROR:"Error unregistering event",LOGS_NOT_STORED:"Store logs feature is not enabled. Enable it via SkylinkLogger.setLevel(logLevel, storeLogs)",LOGS_CLEARED:"Stored logs cleared",INVALID_CB:"Dropping listener as it is not a function"},BROWSER_AGENT:{REACT_NATIVE:{ERRORS:{DROPPING_ONREMOVETRACK:"Dropping onremovetrack as trackInfo is malformed"}}}};const Kt=new class{constructor(){this.events={},this.privateEvents={}}addPrivateEventListener(e,t){this.addListener(e,t,!0)}addEventListener(e,t){this.addListener(e,t,!1)}addListener(e,t,n){try{const r=n?"privateEvents":"events";if(!si(t))return void tn.log.DEBUG([null,yt.SKYLINK_EVENT,e,Wt.LOGGER.INVALID_CB]);this[r][e]||(this[r][e]={}),this[r][e].callbacks||(this[r][e].callbacks=[]),this[r][e].callbacks.push(t),n||tn.log.DEBUG([null,yt.SKYLINK_EVENT,e,Wt.LOGGER.EVENT_REGISTERED])}catch(t){tn.log.ERROR([null,yt.SKYLINK_EVENT,e,Wt.LOGGER.EVENT_REGISTER_ERROR],t)}}dispatchEvent(e){if(e.name===jt.LOGGED_ON_CONSOLE)return;let t=[];if(this.events[e.name]){const n=this.events[e.name].callbacks;t=t.concat(n)}else tn.log.DEBUG([null,yt.SKYLINK_EVENT,e.name,Wt.LOGGER.EVENT_DISPATCHED]);if(this.privateEvents[e.name]){const n=this.privateEvents[e.name]?this.privateEvents[e.name].callbacks:[];t=t.concat(n)}t.forEach(t=>{try{t(e.detail)}catch(t){tn.log.ERROR([null,yt.SKYLINK_EVENT,e.name,Wt.LOGGER.EVENT_DISPATCH_ERROR],t)}})}removeEventListener(e,t){this.removeListener(e,t,!1)}removePrivateEventListener(e,t){this.removeListener(e,t,!0)}removeListener(e,t,n){const r=n?"privateEvents":"events";if(n||this.events[e]&&this.events[e].callbacks)try{this[r][e].callbacks.forEach((s,o)=>{s===t&&(delete this[r][e].callbacks[o],n||tn.log.DEBUG([null,yt.SKYLINK_EVENT,e,Wt.LOGGER.EVENT_UNREGISTERED]))})}catch(t){tn.log.ERROR([null,yt.SKYLINK_EVENT,e,Wt.LOGGER.EVENT_DISPATCH_ERROR],t)}else tn.log.WARN([null,yt.SKYLINK_EVENT,e,Wt.LOGGER.EVENT_UNREGISTERED])}},$t=Kt.addPrivateEventListener.bind(Kt),Yt=Kt.removePrivateEventListener.bind(Kt),qt=Kt.dispatchEvent.bind(Kt);var Jt=Kt;const Xt=["trace","debug","info","warn","error"],Qt=e=>{let t=!0;return("undefined"==typeof console||void 0===console[e])&&(t=!1),t},zt=(e,t,n,r=null)=>{const s=`[${(new Date).toISOString()}]`,o=e.level,{logLevels:i}=e;if(o<=t&&o!==i.SILENT){const e=Xt[t];if(!Qt(e))return;const o=(e=>{let t="SkylinkJS -";if(Array.isArray(e)){const[n,r,s,o]=e;if(t+=n?` [${n}]`:" -",t+=r?` <<${r}>>`:n?"":" <<Method>>",s)if(Array.isArray(s))for(let e=0;e<s.length;e+=1)t+=` (${s[e]})`;else t+=` (${s})`;t+=" "+o}else t+=" "+e;return t})(n);if(Qt(e)&&(console[e](s,o,r||""),qt(((e={})=>new de(ne,{detail:e}))({level:e,message:o,debugObject:r}))),tn.storeLogs){const t=[s,e.toUpperCase(),o];r&&t.push(r),tn.storedLogs.push(t)}}};class Zt{constructor(){this.logLevels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},this.level=(e=>{const t=window.localStorage.getItem("loglevel:skylinkjs");return null===t||Number.isNaN(+t)?e.ERROR:+t})(this.logLevels),this.storeLogs=!1,this.storedLogs=[]}setLevel(e=this.levels.ERROR,t){ri(e)?(this.level=e,(e=>{window.localStorage.setItem("loglevel:skylinkjs",e)})(this.level)):this.level=this.levels.ERROR,t&&(this.storeLogs=t)}enableAll(){this.setLevel(this.logLevels.TRACE)}disableAll(){this.setLevel(this.logLevels.SILENT)}getLogs(){return this.storeLogs?this.storedLogs:(this.log.WARN(Wt.LOGGER.LOGS_NOT_STORED),null)}clearLogs(){this.log.INFO(Wt.LOGGER.LOGS_CLEARED),this.storedLogs=[]}}const en=new Zt;Zt.prototype.log={TRACE:(...e)=>{zt(en,en.logLevels.TRACE,...e)},DEBUG:(...e)=>{zt(en,en.logLevels.DEBUG,...e)},INFO:(...e)=>{zt(en,en.logLevels.INFO,...e)},WARN:(...e)=>{zt(en,en.logLevels.WARN,...e)},ERROR:(...e)=>{zt(en,en.logLevels.ERROR,...e)}};var tn=en;var nn=(e,t)=>{const n=Ki.getSkylinkState(t.room.id),r=e||{};return n.streamsBandwidthSettings={bAS:{}},n.voiceActivityDetection="boolean"!=typeof r.voiceActivityDetection||r.voiceActivityDetection,r.bandwidth&&("number"==typeof r.bandwidth.audio&&(n.streamsBandwidthSettings.bAS.audio=r.bandwidth.audio),"number"==typeof r.bandwidth.video&&(n.streamsBandwidthSettings.bAS.video=r.bandwidth.video),"number"==typeof r.bandwidth.data&&(n.streamsBandwidthSettings.bAS.data=r.bandwidth.data)),r.autoBandwidthAdjustment&&(n.bandwidthAdjuster={interval:10,limitAtPercentage:100,useUploadBwOnly:!1},"object"==typeof r.autoBandwidthAdjustment&&("number"==typeof r.autoBandwidthAdjustment.interval&&r.autoBandwidthAdjustment.interval>=10&&(n.bandwidthAdjuster.interval=r.autoBandwidthAdjustment.interval),"number"==typeof r.autoBandwidthAdjustment.limitAtPercentage&&r.autoBandwidthAdjustment.limitAtPercentage>=0&&r.autoBandwidthAdjustment.limitAtPercentage<=100&&(n.bandwidthAdjuster.limitAtPercentage=r.autoBandwidthAdjustment.limitAtPercentage),"boolean"==typeof r.autoBandwidthAdjustment.useUploadBwOnly&&(n.bandwidthAdjuster.useUploadBwOnly=r.autoBandwidthAdjustment.useUploadBwOnly))),n},rn=n(14),sn=n.n(rn);const on={RECONNECTION_ATTEMPTS:{WEBSOCKET:5,POLLING:4},RECONNECTION_DELAY_MAX:5e3,RECONNECTION_DELAY:1e3,RECONNECTION_FINAL_ATTEMPTS:10};const an={SOCKET:e=>({forceNew:!0,reconnection:!0,timeout:e.socketTimeout,path:e.socketServerPath,reconnectionAttempts:on.RECONNECTION_ATTEMPTS.WEBSOCKET,reconnectionDelayMax:on.RECONNECTION_DELAY_MAX,reconnectionDelay:on.RECONNECTION_DELAY,transports:[xt.WEBSOCKET.toLowerCase()],query:{Skylink_SDK_type:Lt.WEB,Skylink_SDK_version:bt,Skylink_API_version:Gt,"X-Server-Select":Ut},extraHeaders:{Skylink_SDK_type:Lt.WEB,Skylink_SDK_version:bt,Skylink_API_version:Gt,"X-Server-Select":Ut}}),PEER_CONNECTION:{bundlePolicy:qe.BALANCED,rtcpMuxPolicy:Je.REQUIRE,iceTransportPolicy:"all",iceCandidatePoolSize:0}},dn={SOCKET:on,MEDIA_OPTIONS:{AUDIO:{stereo:!1,echoCancellation:!0,exactConstraints:!1},VIDEO:{resolution:Et.VGA,frameRate:30,exactConstraints:!1},SCREENSHARE:{video:!0}}};var cn=(e,t)=>t?an[e](t):an[e];var ln=(e,t="")=>{const n=((e,t="")=>{const n={audio:!1,video:!1};return(e.audio&&!t||e.audio&&t===Pt.AUDIO)&&(n.audio=sn()(dn.MEDIA_OPTIONS.AUDIO),ti(e.audio)&&(oi(e.audio.stereo)&&(n.audio.stereo=e.audio.stereo),oi(e.audio.echoCancellation)&&(n.audio.echoCancellation=e.audio.echoCancellation),mi(Ft.FIREFOX)||e.audio.deviceId&&ii(e.audio.deviceId)&&(n.audio.deviceId=e.audio.deviceId),e.useExactConstraints&&oi(e.useExactConstraints)&&(n.audio.exactConstraints=e.useExactConstraints))),(e.video&&!t||e.video&&t===Pt.VIDEO)&&(n.video=sn()(dn.MEDIA_OPTIONS.VIDEO),ti(e.video)&&(e.video.deviceId&&ii(e.video.deviceId)&&(n.video.deviceId=e.video.deviceId),e.video.resolution&&ti(e.video.resolution)&&((e.video.resolution.width&&ii(e.video.resolution.width)||ri(e.video.resolution.width))&&(n.video.resolution.width=e.video.resolution.width),(e.video.resolution.height&&ii(e.video.resolution.height)||ri(e.video.resolution.height))&&(n.video.resolution.height=e.video.resolution.height)),(e.video.frameRate&&ii(e.video.frameRate)||ri(e.video.frameRate))&&(n.video.frameRate=e.video.frameRate),e.useExactConstraints&&oi(e.useExactConstraints)&&(n.video.exactConstraints=e.useExactConstraints))),n})(e,t);return{settings:n,mutedSettings:{shouldAudioMuted:!(!e.audio||!oi(e.audio.mute))&&e.audio.mute,shouldVideoMuted:!(!e.video||!oi(e.video.mute))&&e.video.mute},getUserMediaSettings:((e,t)=>{const n={audio:!1,video:!1};return(e.audio&&!t||e.audio&&t===Pt.AUDIO)&&e.audio&&ti(e.audio)&&(n.audio={},n.audio.echoCancellation=!0,oi(e.audio.echoCancellation)&&(n.audio.echoCancellation=e.audio.echoCancellation),mi(Ft.FIREFOX)||e.audio.deviceId&&ii(e.audio.deviceId)&&(n.audio.deviceId=e.audio.exactConstraints?{exact:e.audio.deviceId}:{ideal:e.audio.deviceId})),(e.video&&!t||e.video&&t===Pt.VIDEO)&&(e.video&&ti(e.video)?(n.video={},e.video.deviceId&&ii(e.video.deviceId)&&(n.video.deviceId=e.video.exactConstraints?{exact:e.video.deviceId}:{ideal:e.video.deviceId}),n.video.width=ti(e.video.resolution.width)?e.video.resolution.width:e.video.exactConstraints?{exact:e.video.resolution.width}:{max:e.video.resolution.width},n.video.height=ti(e.video.resolution.height)?e.video.resolution.height:e.video.exactConstraints?{exact:e.video.resolution.height}:{max:e.video.resolution.height},(e.video.frameRate&&ti(e.video.frameRate)||ri(e.video.frameRate))&&(n.video.frameRate=ti(e.video.frameRate)?e.video.frameRate:e.video.exactConstraints?{exact:e.video.frameRate}:{max:e.video.frameRate})):e.video&&(n.video={width:e.video.exactConstraints?{exact:e.video.resolution.width}:{max:e.video.resolution.width},height:e.video.exactConstraints?{exact:e.video.resolution.height}:{max:e.video.resolution.height}})),n})(n,t)}};var un=(e,t)=>{let n=null;if(!e)return null;const r=Ki.getSkylinkState(t.id);return r?((e,t)=>{const{user:n}=t;return e===n.sid})(e,r)?Uo.getCurrentSessionInfo(t):(n=sn()(r.peerInformations[e]),n?(n.room=t.roomName,n.settings.data=!!(r.dataChannels[e]&&r.dataChannels[e].main&&r.dataChannels[e].main.channel&&r.dataChannels[e].main.channel.readyState===Pe.OPEN),n):(tn.log.ERROR(`${Wt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`),n)):(tn.log.ERROR(`${Wt.ROOM_STATE.NOT_FOUND} ${t.id}`),n)};var En={defaultRoom:(new Date).valueOf(),appKey:null,roomServer:"//api.temasys.io",enableDataChannel:!0,enableSTUNServer:!0,enableTURNServer:!0,socketServerPath:null,enableStatsGathering:!0,audioFallback:!0,socketTimeout:7e3,forceTURNSSL:!1,forceTURN:!1,forceSSL:!0,usePublicSTUN:!1,mcuUseRenegoRestart:!0,useEdgeWebRTC:!1,enableSimultaneousTransfers:!0,TURNServerTransport:We.ANY,credentials:null,iceServer:null,socketServer:null,audioCodec:lt.AUTO,videoCodec:ct.AUTO,codecParams:{audio:{opus:{stereo:null,"sprop-stereo":null,usedtx:null,useinbandfec:null,maxplaybackrate:null,minptime:null}},video:{h264:{profileLevelId:null,levelAsymmetryAllowed:null,packetizationMode:null},vp8:{maxFs:null,maxFr:null},vp9:{maxFs:null,maxFr:null}}},beSilentOnStatsLogs:!1,beSilentOnParseLogs:!1};var Sn=()=>{const e={fulfilled:!0,message:""},{AdapterJS:t,io:n,fetch:r}=window,s="Validating Dependencies";return"function"!=typeof(t||window.AdapterJS||window.AdapterJS||{}).webRTCReady?(e.message=Wt.INIT.ERRORS.NO_ADAPTER,e.fulfilled=!1,e.readyStateChangeErrorCode=rt.ADAPTER_NO_LOADED):n||window.io?r&&window.fetch||(e.message=Wt.INIT.ERRORS.NO_FETCH_SUPPORT,e.fulfilled=!1,e.readyStateChangeErrorCode=rt.NO_XMLHTTPREQUEST_SUPPORT):(e.message=Wt.INIT.ERRORS.NO_SOCKET_IO,e.fulfilled=!1,e.readyStateChangeErrorCode=rt.NO_SOCKET_IO),mi(Ft.FIREFOX)&&"moz"===t.webrtcDetectedType||mi(Ft.SAFARI)||mi(Ft.CHROME)&&"webkit"===t.webrtcDetectedType||mi(Ft.REACT_NATIVE)||tn.log.WARN([s,null,null,Wt.INIT.INCOMPATIBLE_BROWSER]),e.fulfilled||tn.log.ERROR([s,null,null,e.message]),e};var pn=e=>{const{forceTURNSSL:t,serverConfig:n}=e,r={tcp:n.iceServerPorts.tcp,udp:n.iceServerPorts.udp,both:n.iceServerPorts.both,iceServerProtocol:n.iceServerProtocol,iceServerPorts:n.iceServerPorts};return t?(r.iceServerPorts.udp=[],r.iceServerProtocol="turns"):mi(Ft.FIREFOX)&&(r.udp=[3478],r.both=[]),r};var hn=class{constructor(e){this.id=e.room_key,this.token=e.roomCred,this.startDateTime=e.start,this.duration=e.len,this.roomName=e.roomName,this.connection={peerConstraints:JSON.parse(e.pc_constraints),offerConstraints:JSON.parse(e.offer_constraints),sdpConstraints:{},peerConfig:{iceServers:[]},mediaConstraints:JSON.parse(e.media_constraints)},this.isLocked=!1}};var Rn=class{constructor(e){this.uid=e.username,this.token=e.userCred,this.timeStamp=e.timeStamp,this.sid=null,this.bufferMessage=null}};const gn={};var mn=class{constructor(e,t){if(ii(t)&&gn[t])return gn[t];const{offer_constraints:n,pc_constraints:r,cid:s,apiOwner:o,ipSigserver:i,isPrivileged:a,autoIntroduce:d,httpPortList:c,httpsPortList:l,hasMCU:u,ipSigserverPath:E,hasPersistentMessage:S,room_key:p}=e;n||r||tn.log.ERROR(["API",null,"init","pc_constraints or offer_constraints are null"]),tn.log.DEBUG(["API",null,"init","Parsed Peer Connection constraints:"],JSON.parse(r)),tn.log.DEBUG(["API",null,"init","Parsed Offer constraints"],JSON.parse(n)),this.key=s,this.appKeyOwner=o,this.isPrivileged=a,this.autoIntroduce=d,this.room=new hn(e),this.user=new Rn(e),this.hasMCU=u,this.socketServer=i,this.socketServerPath=E,this.socketPorts={"http:":Array.isArray(c)&&c.length>0?c:[80,3e3],"https:":Array.isArray(l)&&l.length>0?l:[443,3443]},this.hasPersistentMessage=S,gn[p]=this}deleteApiResponseInstance(e){delete gn[e]}};const In={apiBase:"https://api.temasys.io",stats:{endPoints:{client:"/client",session:"/session",auth:"/auth",signaling:"/signaling",iceConnection:"/client/iceconnection",iceCandidate:"/client/icecandidate",iceGathering:"/client/icegathering",negotiation:"/client/negotiation",bandwidth:"/client/bandwidth",recording:"/client/recording",dataChannel:"/client/datachannel"}}};In.stats.statsBase=In.apiBase+"/rest/stats";var fn=In;var Tn=class{constructor(){this.endpoints=fn.stats.endPoints,this.stats_buffer={},this.bufferTimeout=!1}postStats(e,t){const{STATS_MODULE:n}=Wt,r=Ki.getInitOptions().beSilentOnStatsLogs;try{const n=Ki.getInitOptions(),{enableStatsGathering:s}=n;if(s){const n=this.processData(t);this.postStatObj(e,r,n)}}catch(e){tn.log.WARN(n.ERRORS.POST_FAILED,e)}}processData(e){return Array.isArray(e)?{client_id:e[0].client_id,data:e}:e}async postStatObj(e,t,n){const{fetch:r}=window,s=await r(`${fn.stats.statsBase}${e}`,{method:"POST",mode:"cors",headers:{"Content-type":"application/json"},body:JSON.stringify(n)});t||s.json().then(t=>{tn.log.INFO([null,yt.STATS,null,""+e],t)})}addToStatsBuffer(e,t,n){this.stats_buffer[e]||(this.stats_buffer[e]={},this.stats_buffer[e].url=n,this.stats_buffer[e].data=[]);const r=Object.assign({},t);this.stats_buffer[e].data.push(r)}manageStatsBuffer(){this.bufferTimeout||(this.bufferTimeout=!0,setInterval(()=>{const e=Object.keys(this.stats_buffer);for(let t=0;t<e.length;t+=1)this.stats_buffer[e[t]].data.length>0&&(this.postStats(this.stats_buffer[e[t]].url,this.stats_buffer[e[t]].data),this.stats_buffer[e[t]].data=[])},5e3))}};var On=class extends Tn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,state:null,http_status:null,http_error:null,api_url:null,api_result:null}}send(e,t,n,r){this.model.room_id=e,this.model.http_status=r?-1:n&&n.status?n.status:null,this.model.http_error=("string"==typeof r?r:r&&r.message)||null,this.model.api_url=n&&n.endpoint?n.endpoint:n.url,this.model.client_id=Ki.getInitOptions().clientId,this.model.app_key=Ki.getInitOptions().appKey,this.model.state=t,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.auth,this.model)}};const An=e=>{const{appKey:t}=e,n={isValid:!0,message:""};return tn.log.INFO(["API",null,"init","API initialised with options:"],e),t||(n.isValid=!1,n.message=Wt.INIT.ERRORS.NO_APP_KEY,qt(Re({readyState:nt.ERROR,error:{status:-2,content:new Error(Wt.INIT.ERRORS.NO_APP_KEY),errorCode:rt.NO_PATH},room:null}))),n.isValid||tn.log.ERROR(["API",null,"init",n.message]),n},Cn=e=>{const{ok:t}=e;return(e=>{const{status:t,ok:n}=e,r=n?"INFO":"ERROR";let s=Wt.INIT.INFO.API_SUCCESS;n||(s=Wt.INIT.ERRORS.AUTH_GENERAL,403===t&&(s=Wt.INIT.ERRORS.AUTH_CORS)),tn.log[r](["API",null,"auth",s],e)})(e),t},_n=e=>{const t=e;return!0===t.forceTURN&&(t.enableTURNServer=!0,t.enableSTUNServer=!1),t},Nn=async e=>{const{fetch:t}=window,n=(e=>{const{roomServer:t,appKey:n,defaultRoom:r,credentials:s,forceSSL:o}=e;let i=`${t}/api/${n}/${r}`,a="?";if(i=o?"https:"+i:`${window.location.protocol}${i}`,s){const{startDateTime:e,duration:t}=s;i+=`/${e}/${t}?cred=${s.credentials}`,a="&"}return i+=`${a}rand=${Date.now()}`,i})(e);(new On).send(e.defaultRoom,Be.REQUEST,{endpoint:n});return{endpoint:n,response:await t(n,{headers:{Skylink_SDK_type:Lt.WEB,Skylink_SDK_version:bt,Skylink_API_version:Gt,"X-Server-Select":Ut}})}},Dn=()=>{const e={ready:!0,message:""};return(()=>{try{const e=new window.RTCPeerConnection(null);return["object","function"].indexOf(typeof e.createOffer)>-1&&null!==e.createOffer}catch(e){return!1}})()||(e.message="WebRTC not supported. Please upgrade your browser",e.ready=!1,qt(Re({readyState:nt.ERROR,error:{status:-2,content:new Error(e.message),errorCode:rt.NO_WEBRTC_SUPPORT},room:null}))),e};let yn=null;var vn=class{constructor(){return yn||(yn=this),this.options={},yn}init(e=En){e&&(e.socketServer&&!e.socketServerPath&&(e.socketServerPath=""),e.clientId=Ei(),Ki.setUserInitOptions(e)),qt(Re({readyState:nt.INIT,error:null,room:null}));const t=Sn(),{AdapterJS:n}=window;if(!t.fulfilled)throw qt(Re({readyState:nt.ERROR,error:{status:-2,content:new Error(t.message),errorCode:t.readyStateChangeErrorCode},room:null})),new Error(t.message);let r=Object.assign({},En,e);const s=An(r);if(!s.isValid)throw new Error(s.message);return n.webRTCReady(()=>{const e=Dn();if(!e.ready)throw new Error(e.message)}),r=_n(r),r}createRoom(e){return new Promise((t,n)=>{const r=Ki.getInitOptions();r.defaultRoom=e,Nn(r).then(r=>{const{endpoint:s,response:o}=r;Cn(o)?(qt(Re({readyState:nt.COMPLETED,error:null,room:e})),o.json().then(e=>{(new On).send(e.room_key,Be.SUCCESS,o),t({endpoint:s,response:e})})):(qt(Re({readyState:nt.ERROR,error:{status:o.status,content:new Error(o.info||"XMLHttpRequest status not OK\nStatus was: "+o.status),errorCode:o.error||o.status},room:e})),o.json().then(t=>{(new On).send(e,Be.ERROR,o,t.info),n(t)}))}).catch(t=>{qt(Re({readyState:nt.ERROR,error:{status:t.status||-1,content:new Error(t.message||"Network error occurred"),errorCode:rt.XML_HTTP_REQUEST_ERROR},room:e}))})})}checkCodecSupport(e){return(e=>new Promise((t,n)=>{Ai.getCodecsSupport(e).then(r=>{const s=Ki.getSkylinkState(e),{room:o}=s;0===Object.keys(r.audio).length&&0===Object.keys(r.video).length?(tn.log.ERROR(Wt.JOIN_ROOM.ERRORS.CODEC_SUPPORT),qt(Re({readyState:nt.ERROR,error:{status:-2,content:new Error(Wt.JOIN_ROOM.ERRORS.CODEC_SUPPORT),errorCode:rt.PARSE_CODECS},room:wo.getRoomInfo(o.id)})),n(new Error(Wt.JOIN_ROOM.ERRORS.CODEC_SUPPORT))):t(!0),s.currentCodecSupport=r,Ki.setSkylinkState(s)}).catch(t=>{const r=Ki.getSkylinkState(e),{room:s}=r;tn.log.ERROR(t),qt(Re({readyState:nt.ERROR,error:{status:-2,content:new Error(t.message||t.toString()),errorCode:rt.PARSE_CODECS},room:wo.getRoomInfo(s.id)})),n(new Error(t.message||t.toString()))})}))(e)}static parseAPIResponseBody(e){return new mn(e)}enforceUserInitOptions(e){return(e=>{const t=Ki.getUserInitOptions(),n=Ki.getInitOptions();let r=Object.assign(n,e,t);const s=An(r);if(!s.isValid)throw new Error(s.message);return r=_n(r),Ki.setInitOptions(r),r})(e)}static getRoomNameFromParams(e){const t=Ki.getInitOptions(),{roomName:n}=e,{defaultRoom:r}=t;let s=null;return s=void 0!==n&&""!==n&&r!==n?n:r,s}static getStateByKey(e){return ci(e)}};var Mn=e=>{const t=Ki.getSkylinkState(e.roomKey),n=Ki.getInitOptions(),{config:r}=e,{socketServer:s,socketTimeout:o,socketServerPath:i}=n,{socketPorts:a}=new mn(null,e.roomKey),d=cn("SOCKET",{socketTimeout:o,socketServerPath:i});let c=[];s&&ti(s)&&Array.isArray(s.ports)&&s.ports.length?({ports:c}=s):c=a[r.signalingServerProtocol],(e=>!e.signalingServerPort)(r)?(r.signalingServerPort=c[0],r.fallbackType=at.NON_FALLBACK):((e,t)=>e.indexOf(t.signalingServerPort)===e.length-1)(c,r)||ii(n.socketServer)?r.socketType===xt.WEBSOCKET?(r.socketType=xt.POLLING,r.signalingServerPort=c[0]):(r.socketSession.finalAttempts+=1,r.signalingServerPort=c[0]):r.signalingServerPort=c[c.indexOf(r.signalingServerPort)+1],r.socketType===xt.POLLING&&(d.reconnectionDelayMax=dn.SOCKET.RECONNECTION_DELAY_MAX,d.reconnectionAttempts=dn.SOCKET.RECONNECTION_ATTEMPTS.POLLING,d.transports=[xt.XHR_POLLING,xt.JSONP_POLLING,xt.POLLING.toLowerCase()]);const l=(e=>{const{signalingServerProtocol:t,signalingServer:n,signalingServerPort:r,socketServer:s}=e;let o="";return o=ii(n)?`${t}//${n}`:n&&ti(n)&&n.protocol?`${n.protocol}//${s.url}:${r}?rand=${Date.now()}`:`${t}//${n}:${r}?rand=${Date.now()}`,o})({signalingServerProtocol:r.signalingServerProtocol,signalingServer:t.socketServer,signalingServerPort:r.signalingServerPort,socketServer:s});return r.socketServer=s,r.socketServerPath=i,t.socketSession=r,Ki.setSkylinkState(t,e.roomKey),window.io(l,d)};var Pn=(e,t)=>{const{type:n}=t;switch(tn.log.INFO(["SIG SERVER",null,n,"received"]),n){case Tt.IN_ROOM:e.inRoomHandler(t);break;case Tt.ENTER:e.enterRoomHandler(t);break;case Tt.OFFER:e.offerHandler(t);break;case Tt.WELCOME:e.welcomeHandler(t);break;case Tt.ANSWER:e.answerHandler(t);break;case Tt.ANSWER_ACK:e.answerAckHandler(t);break;case Tt.CANDIDATE:e.candidateHandler(t);break;case Tt.PEER_LIST:e.getPeerListHandler(t);break;case Tt.INTRODUCE_ERROR:e.introduceError(t);break;case Tt.BYE:e.byeHandler(t);break;case Tt.STREAM:e.streamHandler(t);break;case Tt.RECORDING:e.recordingHandler(t);break;case Tt.REDIRECT:e.redirectHandler(t);break;case Tt.RTMP:e.rtmpHandler(t);break;case Tt.UPDATE_USER:e.setUserDataHandler(t);break;case Tt.MEDIA_INFO_EVENT:e.mediaInfoEventHandler(t);break;case Tt.MESSAGE:e.userMessageHandler(t,null);break;case Tt.STORED_MESSAGES:e.storedMessagesHandler(t);break;case Tt.PUBLIC_MESSAGE:e.userMessageHandler(t,!0);break;case Tt.PRIVATE_MESSAGE:e.userMessageHandler(t,!1)}};var kn=(e,t)=>{const n=Ki.getSkylinkState(e)||Object.values(Ki.getSkylinkState())[0],{socketSession:r,room:s,user:o}=n;var i;tn.log.INFO([null,"Socket",null,"Channel closed. Reason - "+t]),n.channelOpen=!1,Ki.setSkylinkState(n,e),qt((i={socketSession:sn()(r)},new de(G,{detail:i}))),s.inRoom&&o&&o.sid&&qt(((e={})=>new de(k,{detail:e}))({peerId:o.sid,peerInfo:Uo.getCurrentSessionInfo(s)}))};var wn=class extends Tn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,signaling_url:null,signaling_transport:null,attempts:null,error:null}}send(e,t,n){const r=Ki.getSkylinkState(e),{socketSession:s}=r;this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.client_id=r.clientId,this.model.state=t,this.model.signaling_url=r.socketSession.socketServer,this.model.signaling_transport=r.socketSession.socketType.toLowerCase(),this.model.attempts=0===s.socketSession.finalAttempts?s.socketSession.attempts:2*s.socketSession.finalAttempts+s.socketSession.attempts,this.model.app_key=Ki.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.attempts="number"==typeof n?n:null,this.model.error=("string"==typeof n?n:n&&n.message)||null,this.postStats(this.endpoints.signaling,this.model)}};const bn=e=>{const{peerConnections:t}=e,n=Object.keys(t);let r=!0;return n.forEach(e=>{t[e].connectionState===Ke.FAILED&&(r=!1)}),r};var Ln={onConnection:(e,t)=>{const n=Ki.getSkylinkState(t),{socketSession:r}=n;var s;(new wn).send(t,Ht.SIGNALING.CONNECT,null),n.channelOpen||(n.channelOpen=!0,Ki.setSkylinkState(n,t)),0!==r.socketSession.finalAttempts||0!==r.socketSession.attempts?(qt((s={socketSession:sn()(r)},new de(L,{detail:s}))),(new wn).send(t,Ht.SIGNALING.RECONNECT_SUCCESS)):qt((e=>new de(b,{detail:e}))({socketSession:sn()(r)})),e()},onDisconnect:(e,t)=>{const n=Ki.getSkylinkState(e)||Object.values(Ki.getSkylinkState())[0],r=n.channelOpen,{room:s}=n;(new wn).send(s.id,Ht.SIGNALING.DISCONNECT,null),(r||!r&&e!==s.roomName)&&Vn(s.id,t)},onError:(e,t)=>{const n=Ki.getSkylinkState(e),{socketSession:r}=n;var s;(new wn).send(e,Ht.SIGNALING.ERROR,t),tn.log.ERROR([null,"Socket",null,"Exception occurred ->"],t),qt((s={error:t,socketSession:sn()(r)},new de(F,{detail:s})))},onReconnectAttempt:(e,t)=>{const n=Ki.getSkylinkState(e);if(!n)return;const{socketSession:r}=n;let s=0;var o;(new fo).updateAttempts(e,"attempts",t),s=0===r.socketSession.finalAttempts?t:2*r.socketSession.finalAttempts+r.socketSession.attempts,(new wn).send(e,Ht.SIGNALING.RECONNECT_ATTEMPT,s),qt((o={fallbackType:r.fallbackType,currentAttempt:s,session:sn()(Ki.getSkylinkState(e).socketSession)},new de(B,{detail:o})))},onReconnectFailed:(e,t,n)=>{const r=Ki.getSkylinkState(n),{socketSession:s}=r,o=new fo;bn(r)&&s.socketSession.attempts===dn.SOCKET.RECONNECTION_ATTEMPTS.WEBSOCKET&&s.socketSession.finalAttempts<dn.SOCKET.RECONNECTION_FINAL_ATTEMPTS&&!s.socketTimeout?(o.socket.connect(),o.updateAttempts(n,"attempts",s.socketSession.attempts===dn.SOCKET.RECONNECTION_ATTEMPTS.WEBSOCKET?0:s.socketSession.attempts+=1),o.updateAttempts(n,"finalAttempts",s.socketSession.finalAttempts+=1)):bn(r)?((new wn).send(n,Ht.SIGNALING.RECONNECT_FAILED,Wt.INIT.ERRORS.SOCKET_ERROR_ABORT),qt(De({session:sn()(s),errorCode:it.RECONNECTION_ABORTED,type:s.fallbackType,error:new Error(Wt.INIT.ERRORS.SOCKET_ERROR_ABORT)})),t(new Error(Wt.INIT.ERRORS.SOCKET_ERROR_ABORT))):tn.log.WARN([null,"Socket",null,`${Wt.SOCKET.ABORT_RECONNECT} - ${Wt.PEER_CONNECTION.FAILED_STATE}`])},onReconnectError:(e,t)=>{const n=Ki.getSkylinkState(e),{socketSession:r}=n;(new wn).send(e,Ht.SIGNALING.RECONNECT_ERROR,t),!r.socketTimeout&&t&&"timeout"===t&&(tn.log.ERROR([null,"Socket",null,r.socketType+" connection timed out."]),r.socketTimeout=!0,Ki.setSkylinkState(n,e))}};var Gn=(e,t,n,r)=>{t.socket.on(Vt.CONNECT,Ln.onConnection.bind(t,n,e)),t.socket.on(Vt.MESSAGE,t.onMessage.bind(t)),t.socket.on(Vt.DISCONNECT,Ln.onDisconnect.bind(t,e)),t.socket.on(Vt.ERROR,Ln.onError.bind(t,e)),t.socket.on(Vt.RECONNECT_ATTEMPT,Ln.onReconnectAttempt.bind(t,e)),t.socket.on(Vt.RECONNECT_ERROR,Ln.onReconnectError.bind(t,e)),t.socket.on(Vt.RECONNECT_FAILED,Ln.onReconnectFailed.bind(t,n,r,e))};const Un=e=>oi(e)&&e,Fn=(e,t)=>{const n=Ki.getSkylinkState(e),{detail:r}=t;if(r.state===Qe.ENTER){const e=sn()(n.socketMessageQueue);n.user.bufferMessage=!1,n.socketMessageQueue=[],Ki.setSkylinkState(n,n.room.id),tn.log.DEBUG([n.user.sid,yt.SIG_SERVER,null,`${Wt.SIGNALING.BUFFERED_MESSAGES_SENT}: ${e.length}`]),((e,t)=>{const n=new fo;for(let r=t.length-1;r>=0;r-=1){const s=t[r];if(!s.mid){if(!e.user.sid)return void tn.log.DEBUG([e.user.sid,yt.SIG_SERVER,null,""+Wt.SIGNALING.BUFFERED_MESSAGES_DROPPED]);s.mid=e.user.sid}n.sendMessage(s),t.splice(r,1)}})(n,e),Jt.removeEventListener(jt.HANDSHAKE_PROGRESS,Fn)}};var Bn=e=>{const{rid:t}=e,n=Ki.getSkylinkState(t),{user:r,room:s}=n;return!ni(r.bufferMessage)&&!Un(r.bufferMessage)||(e=>{const{JOIN_ROOM:t,ENTER:n,WELCOME:r,OFFER:s,ANSWER:o,ANSWER_ACK:i,CANDIDATE:a,END_OF_CANDIDATES:d}=Tt;return[t,n,r,s,o,i,a,d].indexOf(e.type)>-1})(e)?(e.type===Qe.ENTER&&ni(r.bufferMessage)&&(tn.log.DEBUG([r.sid,yt.SIG_SERVER,null,Wt.SIGNALING.BUFFER_NOT_NEEDED]),n.user.bufferMessage=!1,n.socketMessageQueue=[],Ki.setSkylinkState(n,n.room.id)),!1):(tn.log.DEBUG([r.sid,yt.SIG_SERVER,null,Wt.SIGNALING.MESSAGE_ADDED_TO_BUFFER]),n.socketMessageQueue.unshift(e),Un(r.bufferMessage)||(n.user.bufferMessage=!0,tn.log.DEBUG([r.sid,yt.SIG_SERVER,null,Wt.SIGNALING.ENTER_LISTENER]),Jt.addEventListener(jt.HANDSHAKE_PROGRESS,Fn.bind(void 0,t))),Ki.setSkylinkState(n,s.id),!0)};const Vn=(...e)=>{kn(...e)};var xn=(e,t,n)=>{const r={encryptSecrets:e,selectedSecretId:t};if(n){if(!r.encryptSecrets[n])throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);r.selectedSecretId===n&&(r.selectedSecretId=zn.setSelectedSecretId()),delete r.encryptSecrets[n]}else tn.log.DEBUG([null,yt.ENCRYPTED_MESSAGING,null,""+Wt.MESSAGING.ENCRYPTION.DELETE_ALL]),r.selectedSecretId=zn.setSelectedSecretId(),r.encryptSecrets={};return r};var Hn=(e,t,n)=>{const r=e;if((e=>{if(!e)throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!zn.utils.isValidString(e))throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return!0})(t)&&((e,t)=>{if(!e)throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!zn.utils.isValidString(e))throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);if(zn.utils.isExisting(e,t))throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_UNIQUE);return!0})(n,r))return r[n]=t,r},jn=n(67),Wn=n.n(jn);var Kn={isExisting:(e,t)=>Object.keys(t).filter(t=>t===e).length>0,isValidString:e=>{if(!ii(e)||!ii(e)||ei(e))throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return!0},hasCrypto:()=>Wn.a?Wn.a:(tn.log.ERROR([null,yt.ASYNC_MESSAGING,null,Wt.PERSISTENT_MESSAGE.ERRORS.NO_DEPENDENCY]),!1),canEncrypt:(e,t)=>{if(zo(t)&&ei(e))throw new Error(`${Wt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED}, ${Wt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_PROVIDED}`);if(ei(e))throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_SELECTED);if(zo(t))throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return!0},canDecrypt:e=>{if(zo(e))throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return!0}};var $n=(e,t)=>{if(!t)return"";if(!zn.utils.isValidString(t))throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);if(!e[t])throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return t};var Yn=(e,t)=>{const{peerInformations:n,room:r,user:s}=e;let o,i=!1;if(!r.inRoom||!s)throw Error(Wt.ROOM.ERRORS.NOT_IN_ROOM);return Array.isArray(t)&&!Zo(t)?(o=t,i=!0):t&&ii(t)?(o=[t],i=!0):o=Object.keys(n),o.forEach((e,t)=>{n[e]?e===Bt.MCU&&o.splice(t,1):(tn.log.WARN([e,yt.MESSAGING,null,`${Wt.MESSAGING.ERRORS.DROPPING_MESSAGE} - ${Wt.PEER_CONNECTION.NO_PEER_CONNECTION}`]),o.splice(t,1))}),0===o.length&&tn.log.WARN([null,yt.MESSAGING,null,Wt.PEER_CONNECTION.NO_PEER_CONNECTION]),{listOfPeers:o,isPrivate:i}};var qn=(e,t,n,r="",s)=>{(new fo).sendUserMessage(e,t,r||n),Qn.dispatchOnIncomingMessage(e,t,n,!0,s)};var Jn=(e,t,n,r,s)=>{const{room:o,user:i}=e;tn.log.DEBUG([r?null:s,yt.MESSAGING,null,`${Wt.MESSAGING.RECEIVED_MESSAGE} - isPrivate: ${t.isPrivate}`]);const a={targetPeerId:r?t.isPrivate?s:null:i.sid,content:n,senderPeerId:r?i.sid:s,isDataChannel:!1,isPrivate:t.isPrivate,timeStamp:fi()};r&&(a.listOfPeers=t.listOfPeers),qt(pe({room:wo.getRoomInfo(o.id),message:a,isSelf:r,peerId:r?i.sid:s,peerInfo:r?Uo.getCurrentSessionInfo(o):Uo.getPeerInfo(s,o)}))};var Xn=class{static throwError(e="",t=""){throw tn.log.ERROR([null,yt.SKYLINK_ERROR,null,`${e}${t?" - "+t:""}`]),new Error(`${e}${t?" - "+t:""}`)}};var Qn={getMessageConfig:Yn,sendMessageToSig:qn,dispatchOnIncomingMessage:Jn,trySendMessage:(e,t,n)=>{try{const r=Qn.getMessageConfig(e,n);Qn.sendMessageToSig(e,r,t,null,n)}catch(e){Xn.throwError(Wt.MESSAGING.ERRORS.FAILED_SENDING_MESSAGE)}}};var zn={deleteEncryptSecrets:xn,setEncryptSecret:Hn,setSelectedSecretId:$n,utils:Kn,getMessageConfig:(e,t,n,r,s)=>{const o=Qn.getMessageConfig(e,t);return zn.utils.hasCrypto()&&zn.utils.canEncrypt(r,n)&&(o.secretId=r),s&&(o.isPersistent=s),o},encryptMessage:(e,t,n=!1)=>{if(n)try{return Wn.a.AES.decrypt(e,t).toString(Wn.a.enc.Utf8)}catch(e){throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET)}return Wn.a.AES.encrypt(e,t).toString()},tryDecryptMessage:(e,t,n)=>{const r=zn.encryptMessage(e,n[t],!0);if(ei(r))throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET);return r}};var Zn=e=>{const t=Go.getCurrentSessionInfo(e);return delete t.room,t};const er={};var tr=class{constructor(e){const{room:t,user:n}=e;return er[t.id]||(er[t.id]=this),this.room=t,this.peerId=n.sid,this.encryptSecrets={},this.selectedSecretId="",er[t.id]}setEncryptSecret(e,t){try{this.encryptSecrets=zn.setEncryptSecret(this.encryptSecrets,e,t),this.dispatchEncryptSecretEvent()}catch(e){Xn.throwError(Wt.MESSAGING.ENCRYPTION.ERRORS.SET_ENCRYPT_SECRET,e.message)}}getEncryptSecrets(){return this.encryptSecrets}deleteEncryptSecrets(e){try{const t=zn.deleteEncryptSecrets(this.encryptSecrets,this.selectedSecretId,e);this.encryptSecrets=t.encryptSecrets,this.selectedSecretId=t.selectedSecretId,this.dispatchEncryptSecretEvent()}catch(e){Xn.throwError(Wt.MESSAGING.ENCRYPTION.ERRORS.DELETE_ENCRYPT_SECRETS,e.message)}}setSelectedSecretId(e){try{this.selectedSecretId=zn.setSelectedSecretId(this.encryptSecrets,e),this.dispatchEncryptSecretEvent()}catch(e){Xn.throwError(Wt.MESSAGING.ENCRYPTION.ERRORS.SET_SELECTED_SECRET,e.message)}}getSelectedSecretId(){return this.selectedSecretId}dispatchEncryptSecretEvent(){qt(((e={})=>new de(oe,{detail:e}))({room:wo.getRoomInfo(this.room.id),encryptSecrets:this.encryptSecrets,selectedSecretId:this.selectedSecretId,peerInfo:Zn(this.room),peerId:this.peerId}))}canEncrypt(e){try{return!!zn.utils.canEncrypt(this.selectedSecretId,this.encryptSecrets)&&(zn.utils.isValidString(this.selectedSecretId)&&zn.utils.isValidString(this.encryptSecrets[this.selectedSecretId]))}catch(t){if(e)throw new Error(t.message);return!1}}decryptStoredMessages(e,t){if(zn.utils.canEncrypt(t,this.encryptSecrets)&&!Object.keys(this.encryptSecrets).filter(e=>e===t).length)throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return this.decryptMessage(e,t)}decryptMessage(e,t=""){if(t&&zn.utils.canDecrypt(this.encryptSecrets))return zn.tryDecryptMessage(e,t,this.encryptSecrets);throw new Error(Wt.MESSAGING.ENCRYPTION.ERRORS.INVALID_SECRETS)}sendMessage(e,t,n,r=!1){const s=li(e);if(ai(t,"message","sendMessage")&&s)try{tn.log.DEBUG([null,yt.ASYNC_MESSAGING,null,Wt.MESSAGING.ENCRYPTION.SEND_MESSAGE]);const e=zn.getMessageConfig(s,n,this.encryptSecrets,this.selectedSecretId,r),o=zn.encryptMessage(t,this.encryptSecrets[this.selectedSecretId]);Qn.sendMessageToSig(s,e,t,o,n)}catch(e){Xn.throwError(Wt.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message)}}static deleteEncryptedInstance(e){delete er[e.id]}};var nr={getMessageConfig:(e,t)=>{const n=zn.getMessageConfig(e,t);return n.isPersistent=!0,n},parseDecryptedMessageData:(e,t)=>({targetPeerId:t,senderPeerId:e.mid,content:e.data,timeStamp:Ii(e.timeStamp),isPrivate:!1,isDataChannel:!1})};const rr={};var sr=class{constructor(e){const{user:t,room:n,hasPersistentMessage:r}=e;return rr[n.id]||(rr[n.id]=this),this.room=n,this.peerId=t.sid,this.isPersistent=r,this.hasPersistentMessage=r,rr[n.id]}setMessagePersistence(e){if(!oi(e))throw Xn.throwError(Wt.MESSAGING.PERSISTENCE.ERRORS.FAILED_SETTING_PERSISTENCE,Wt.MESSAGING.PERSISTENCE.ERRORS.INVALID_TYPE);if(!this.hasPersistentMessage)throw this.isPersistent=e,Xn.throwError(Wt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);this.isPersistent=e,qt(((e={})=>new de(ie,{detail:e}))({room:wo.getRoomInfo(this.room.id),isPersistent:this.isPersistent,peerInfo:Zn(this.room),peerId:this.peerId}))}getMessagePersistence(){return this.isPersistent}sendMessage(e,t,n){const r=li(e),s=!n||Array.isArray(n)&&Zo(n);if(ai(t,"message","sendMessage")&&r)try{tn.log.DEBUG([null,yt.ASYNC_MESSAGING,null,Wt.MESSAGING.PERSISTENCE.SEND_MESSAGE]);const o=new tr(r);if(!s)throw new Error(Wt.MESSAGING.PERSISTENCE.ERRORS.PRIVATE_MESSAGE);o.canEncrypt(!0)&&o.sendMessage(e,t,n,this.isPersistent)}catch(e){Xn.throwError(Wt.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message)}}getStoredMessages(){const e=Ki.getSkylinkState(this.room.id);this.hasPersistentMessage?(new fo).getStoredMessages(e):tn.log.WARN([this.peerId,yt.ASYNC_MESSAGING,null,""+Wt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED])}canPersist(){if(this.hasPersistentMessage)return!!this.isPersistent||(tn.log.DEBUG([null,yt.ASYNC_MESSAGING,null,Wt.MESSAGING.PERSISTENCE.NOT_PERSISTED]),!1);if(this.isPersistent)throw tn.log.DEBUG([null,yt.ASYNC_MESSAGING,null,`${Wt.MESSAGING.PERSISTENCE.IS_PERSISTENT_CONFIG} ${this.isPersistent}`]),new Error(Wt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);return!1}static processStoredMessages(e){const t=Ki.getSkylinkState(e.rid),{room:n}=t,r=e.mid,s=JSON.parse(e.data),o=new tr(t),i=[];tn.log.DEBUG([r,yt.ASYNC_MESSAGING,null,Wt.MESSAGING.PERSISTENCE.STORED_MESSAGES],s);try{for(let e=0;e<s.length;e+=1)s[e].data=o.decryptStoredMessages(s[e].data,s[e].secretId),i.push(nr.parseDecryptedMessageData(s[e],r))}catch(e){throw Xn.throwError(Wt.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message)}qt(((e={})=>new de(se,{detail:e}))({room:wo.getRoomInfo(n.id),storedMessages:i,isSelf:!1,peerId:r,peerInfo:Uo.getPeerInfo(r,n)}))}static deleteAsyncInstance(e){delete rr[e.id]}};var or=class{static sendMessage(e,t,n){const r=li(e);if(ai(t,"message","sendMessage")&&r){const s=new tr(r),o=new sr(r);o.canPersist()?o.sendMessage(e,t,n):s.canEncrypt()?s.sendMessage(e,t,n):Qn.trySendMessage(r,t,n)}}static sendP2PMessage(e,t,n){const r=li(e);ai(t,"message","sendP2PMessage")&&r&&Di.sendP2PMessage(e,t,n)}static processMessage(e,t){const{mid:n,target:r,rid:s,secretId:o,data:i}=e,a=Ki.getSkylinkState(s),d=n;let c=i;if(o)try{c=new tr(a).decryptMessage(i,o)}catch(e){Xn.throwError(Wt.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message)}Qn.dispatchOnIncomingMessage(a,{isPrivate:oi(t)?!t:!!r},c,!1,d)}};var ir=(e,t)=>{or.processMessage(e,t)};const ar={udp:[3478,19302,19303,19304],tcp:[80,443],both:[19305,19306,19307,19308]},dr={STUN:"stun",TURN:"turn",TEMASYS:"temasys",DEFAULT_TURN_SERVER:"turn.temasys.io",TCP:"TCP",UDP:"UDP"},cr=(e,t)=>{const{urls:n}=e;return[{urls:n,username:t.iceServers[1].username||null,credential:t.iceServers[1].credential||null}]};var lr=e=>{const t=Ki.getInitOptions(),n={iceServerName:null,iceServerPorts:ar,iceServerProtocol:dr.STUN,iceServers:[{urls:[]},{urls:[]}]},{iceServer:r,enableTURNServer:s,forceTURNSSL:o,TURNServerTransport:i,enableSTUNServer:a,usePublicSTUN:d}=t;if(e.forEach(e=>{if(0===e.url.indexOf(dr.STUN+":"))e.url.indexOf(""+dr.TEMASYS)>0?n.iceServerName=(e.url.split(":")[1]||"").split("?")[0]||null:n.iceServers[0].urls.push(e.url);else if(0===e.url.indexOf("turn:")&&e.url.indexOf("@")>0&&e.credential&&!n.iceServers[1].username&&!n.iceServers[1].credential){const t=(e.url.split(":")[1]||"").split("@");n.iceServerName=(t[1]||"").split("?")[0],n.iceServers[1].username=t[0],n.iceServers[1].credential=e.credential,n.iceServerProtocol=dr.TURN}}),r)return{iceServers:cr(r,n)};if(n.iceServerName=n.iceServerName||dr.DEFAULT_TURN_SERVER,n.iceServerProtocol!==dr.TURN||s||o){const e=pn({forceTURNSSL:o,enableTURNServer:s,CONSTANTS:dr,serverConfig:n});n.iceServerPorts.tcp=e.tcp,n.iceServerPorts.udp=e.udp,n.iceServerPorts.both=e.both,n.iceServerProtocol=e.iceServerProtocol}else n.iceServerProtocol=dr.STUN;const c=(e=>{const{TURNServerTransport:t,forceTURNSSL:n,udp:r,tcp:s,both:o}=e,i={udp:[],tcp:[],both:[]};return t!==We.UDP||n?t===We.TCP?(i.tcp=s.concat(o),i.udp=[],i.both=[]):t===We.NONE?(i.tcp=[],i.udp=[]):(i.tcp=s,i.udp=r,i.both=o):(i.udp=r.concat(o),i.tcp=[],i.both=[]),i})({forceTURNSSL:o,TURNServerTransport:i,udp:n.iceServerPorts.udp,tcp:n.iceServerPorts.tcp,both:n.iceServerPorts.both});return n.iceServerPorts.tcp=c.tcp,n.iceServerPorts.udp=c.udp,n.iceServerPorts.both=c.both,n.iceServerProtocol===dr.STUN&&(n.iceServerPorts.tcp=[]),n.iceServerProtocol!==dr.STUN||a?(n.iceServerPorts.tcp.forEach(e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}?transport=tcp`)}),n.iceServerPorts.udp.forEach(e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}?transport=udp`)}),n.iceServerPorts.both.forEach(e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}`)}),d||n.iceServers.splice(0,1),{iceServers:n.iceServers}):(n.iceServers=[],null)};var ur=(e,t)=>{const n=Ki.getSkylinkState(t.id),r=n.peerCandidatesQueue[e]||[],o=n.peerConnections[e],{TAGS:i,PEER_CONNECTION_STATE:a}=s;for(let t=0;t<r.length;t+=1){const s=r[t];if(s){const t=s[1],r=s[0],o=t.candidate.split(" ")[7];tn.log.DEBUG([e,i.CANDIDATE_HANDLER,`${r}:${o}`,Wt.ICE_CANDIDATE.ADD_BUFFERED_CANDIDATE]),mr.addIceCandidate(e,r,o,t,n)}else if(o&&o.signalingState!==a.CLOSED)try{o.addIceCandidate(null),tn.log.DEBUG([e,i.CANDIDATE_HANDLER,null,Wt.ICE_CANDIDATE.CANDIDATE_ADDED])}catch(t){tn.log.DEBUG([e,i.CANDIDATE_HANDLER,null,Wt.ICE_CANDIDATE.FAILED_ADDING_CANDIDATE])}}delete n.peerCandidatesQueue[e],Di.signalingEndOfCandidates(e,n)};var Er=class extends Tn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:!1,candidate_id:null,candidate_sdp_mid:null,candidate_sdp_mindex:null,candidate_candidate:null,error:null}}send(e,t,n,r,s,o){const i=Ki.getSkylinkState(e);this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.sid||null,this.model.peer_id=n,this.model.client_id=i.clientId,this.model.state=t,this.model.is_remote=!!r,this.model.candidate_id=r||null,this.model.candidate_sdp_mid=s.sdpMid,this.model.candidate_sdp_mindex=s.sdpMLineIndex,this.model.candidate_candidate=s.candidate,this.model.app_key=Ki.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.error=("string"==typeof o?o:o&&o.message)||null,this.addToStatsBuffer("iceCandidate",this.model,this.endpoints.iceCandidate),this.manageStatsBuffer()}};const Sr=new Er,pr=(e,t,n,r,o,i)=>{const{STATS_MODULE:a,ICE_CANDIDATE:d}=Wt,{CANDIDATE_PROCESSING_STATE:c,TAGS:l}=s;tn.log.ERROR([t,l.CANDIDATE_HANDLER,`${n}:${r}`,d.FAILED_ADDING_CANDIDATE],i),qt(ge({room:wo.getRoomInfo(e.id),state:c.PROCESS_ERROR,peerId:t,candidateId:n,candidateType:r,candidate:o,error:i})),Sr.send(e.id,a.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,t,n,o,i)};var hr=(e,t,n,r,o)=>{const i=Ki.getSkylinkState(o.room.id),{peerConnections:a,room:d}=i,c=a[e],l={candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex},{STATS_MODULE:u,ICE_CANDIDATE:E,PEER_CONNECTION:S}=Wt,{CANDIDATE_PROCESSING_STATE:p,PEER_CONNECTION_STATE:h,TAGS:R}=s;tn.log.DEBUG([e,R.CANDIDATE_HANDLER,`${t}:${n}`,E.ADDING_CANDIDATE]),qt(ge({peerId:e,room:wo.getRoomInfo(d.id),candidateType:n,candidate:l,candidateId:t,state:p.PROCESSING,error:null})),Sr.send(d.id,u.HANDLE_ICE_GATHERING_STATS.PROCESSING,e,t,l),c&&c.signalingState!==h.CLOSED&&c.remoteDescription&&c.remoteDescription.sdp&&c.remoteDescription.sdp.indexOf(`\r\na=mid:${l.sdpMid}\r\n`)>-1||(tn.log.WARN([e,R.CANDIDATE_HANDLER,`${t}:${n}`,`${E.DROPPING_CANDIDATE} - ${S.NO_PEER_CONNECTION}`]),qt(ge({peerId:e,room:wo.getRoomInfo(d.id),candidateType:n,candidate:l,candidateId:t,state:He.DROPPED,error:new Error(S.NO_PEER_CONNECTION)})),Sr.send(d.id,u.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,e,t,l,S.NO_PEER_CONNECTION));try{c.addIceCandidate(l).then(()=>{((e,t,n,r,o)=>{const{STATS_MODULE:i,ICE_CANDIDATE:a}=Wt,{CANDIDATE_PROCESSING_STATE:d,TAGS:c}=s;tn.log.INFO([t,c.CANDIDATE_HANDLER,`${n}:${r}`,a.CANDIDATE_ADDED]),qt(ge({room:wo.getRoomInfo(e.id),state:d.PROCESS_SUCCESS,peerId:t,candidateId:n,candidateType:r,candidate:o,error:null})),Sr.send(e.id,i.HANDLE_ICE_GATHERING_STATS.PROCESS_SUCCESS,t,n,o)})(d,e,t,n,l)}).catch(r=>{pr(d,e,t,n,l,r)})}catch(r){pr.bind(c,d,e,t,n,l,r)}};var Rr=new class extends Tn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,bundlePolicy:null,rtcpMuxPolicy:null}}send(e,t,n,r){const s=Ki.getSkylinkState(e);this.model.client_id=s.clientId,this.model.app_key=Ki.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=n,this.model.state=t,this.model.is_remote=r,this.model.bundlePolicy=cn("PEER_CONNECTION").bundlePolicy,this.model.rtcpMuxPolicy=cn("PEER_CONNECTION").rtcpMuxPolicy,this.addToStatsBuffer("iceGathering",this.model,this.endpoints.iceGathering),this.manageStatsBuffer()}};var gr={setIceServers:lr,addIceCandidateFromQueue:ur,addIceCandidate:hr,onIceCandidate:(e,t,n)=>{const r=Ki.getSkylinkState(n.id),o=r.peerConnections[e],i=new fo;let a=r.gatheredCandidates[e];const{CANDIDATE_GENERATION_STATE:d,TAGS:c}=s;if(!o)return tn.log.WARN([e,c.CANDIDATE_HANDLER,null,Wt.PEER_CONNECTION.NO_PEER_CONNECTION],t),null;if(t.candidate){o.gathering||(tn.log.WARN([e,c.CANDIDATE_HANDLER,null,Wt.ICE_CONNECTION.ICE_GATHERING_STARTED],t),o.gathering=!0,o.gathered=!1,qt(me({room:wo.getRoomInfo(n.id),peerId:e,state:xe.GATHERING})),Rr.send(n.id,d.GATHERING,e,!1));const s=t.candidate.split(" ")[7];if(tn.log.DEBUG([e,c.CANDIDATE_HANDLER,s,Wt.ICE_CANDIDATE.CANDIDATE_GENERATED],t),"endOfCandidates"===s||!(o&&o.localDescription&&o.localDescription.sdp&&o.localDescription.sdp.indexOf(`\r\na=mid:${t.sdpMid}\r\n`)>-1))return tn.log.WARN([e,c.CANDIDATE_HANDLER,s,Wt.ICE_CONNECTION.DROP_EOC],t),null;a||(a={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),a.sending[s].push({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}),r.gatheredCandidates[e]=a,Ki.setSkylinkState(r,n.id),tn.log.DEBUG([e,c.CANDIDATE_HANDLER,s,Wt.ICE_CANDIDATE.SENDING_CANDIDATE],t),i.sendCandidate(e,r,t)}else{if(tn.log.INFO([e,c.CANDIDATE_HANDLER,null,Wt.ICE_CONNECTION.ICE_GATHERING_COMPLETED]),o.gathered)return null;if(o.gathering=!1,o.gathered=!0,qt(me({peerId:e,state:xe.COMPLETED,room:n})),Rr.send(n.id,d.COMPLETED,e,!1),r.gatheredCandidates[e]){setTimeout(()=>{if(!r.gatheredCandidates[e])return;Ki.getSkylinkState(n.id)?i.sendMessage({type:Tt.END_OF_CANDIDATES,noOfExpectedCandidates:r.gatheredCandidates[e].sending.srflx.length+r.gatheredCandidates[e].sending.host.length+r.gatheredCandidates[e].sending.relay.length,mid:r.user.sid,target:e,rid:n.id}):tn.log.WARN([e,c.CANDIDATE_HANDLER,null,Wt.ICE_CONNECTION.DROP_EOC+" peer has left the room"])},6e3)}}return null},addIceCandidateToQueue:(e,t,n,r,s)=>{const{STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:o}}=Wt,i=s,{room:a}=i,d=new Er;tn.log.DEBUG([e,yt.CANDIDATE_HANDLER,`${t}:${n}`,Wt.ICE_CANDIDATE.ADD_CANDIDATE_TO_BUFFER]),d.send(a.id,o.BUFFERED,e,t,r),qt(ge({room:wo.getRoomInfo(a.id),state:He.BUFFERED,peerId:e,candidateId:t,candidateType:n,candidate:r.candidate,error:null})),i.peerCandidatesQueue[e]=i.peerCandidatesQueue[e]||[],i.peerCandidatesQueue[e].push([t,r]),Ki.setSkylinkState(i,a.id)}};var mr=class{static setIceServers(e){return gr.setIceServers(e)}static addIceCandidateFromQueue(e,t){return gr.addIceCandidateFromQueue(e,t)}static addIceCandidateToQueue(e,t,n,r,s){return gr.addIceCandidateToQueue(e,t,n,r,s)}static addIceCandidate(e,t,n,r,s){return gr.addIceCandidate(e,t,n,r,s)}static onIceCandidate(e,t,n){return gr.onIceCandidate(e,t,n)}};var Ir=(e,t)=>{const n=Ki.getSkylinkState(e.id),{peerConnections:r}=n,s=Object.values(r);let o=null;for(let e=0;e<s.length;e+=1){const n=s[e].getTransceivers();for(let e=0;e<n.length;e+=1)if(n[e].sender.track&&n[e].sender.track.id===t.id){o=n[e].mid;break}}return o};var fr=e=>e.readyState===Mt.ENDED?kt.UNAVAILABLE:e.muted?kt.MUTED:kt.ACTIVE;var Tr=(e,t)=>`${e===Pt.AUDIO?"AUDIO":"VIDEO"}_${t}`;var Or=(e,t,n,r,s)=>({publisherId:t,mediaId:Ts.retrieveMediaId(n.kind,r),mediaType:s,mediaState:Ts.retrieveMediaState(n),transceiverMid:Ts.retrieveTransceiverMid(e,n),streamId:r,trackId:n.id,mediaMetaData:"",simulcast:""});const Ar=(e,t)=>e.id===t.id;var Cr=(e,t)=>{const n=Ki.getSkylinkState(e.id),{peerStreams:r,user:s}=n,o=Object.values(r[s.sid]);let i=null;for(let e=0;e<o.length;e+=1){const n=o[e].getTracks();for(let r=0;r<n.length;r+=1)if(Ar(n[r],t)){i=o[e].id;break}}return i};var _r=(e,t,n,r,s=!1,o=!1,i=!1)=>{try{((e,t,n,r,s=!1,o=!1,i=!1)=>{const a=Ki.getSkylinkState(e.id);!i&&s&&o?(a.peerMedias[t][r][s]=o,tn.log.INFO([t,yt.PEER_MEDIA,null,`${Wt.MEDIA_INFO.UPDATE_SUCCESS} -- ${r} - ${s}: ${o}`])):!i||s||o||(a.peerMedias[t]=a.peerMedias[t]||{},a.peerMedias[t][r]=i),Ki.setSkylinkState(a,e.id)})(e,t,0,r,s,o,i),((e,t,n,r)=>{const s=Ki.getSkylinkState(e.id);s.user.sid===t&&n&&Ts.sendMediaInfoMsg(e,s.peerMedias[t][r])})(e,t,n,r)}catch(e){const n=i?JSON.stringify(i):`${r} - ${s}: ${o}`;tn.log.ERROR([t,yt.PEER_MEDIA,null,`${Wt.MEDIA_INFO.ERRORS.FAILED_UPDATING} -- ${n}`],e)}};var Nr=(e,t)=>{const n=new fo,r=Ki.getSkylinkState(e.id),{user:s,hasMCU:o,peerConnections:i}=r;(o?[Bt.MCU]:Object.keys(i).filter(e=>e!==s.sid&&e!==Bt.MCU)).forEach(e=>{n.mediaInfoEvent(r,e,t)})};var Dr=(e,t,n)=>{const r=Ki.getSkylinkState(e.id),{peerMedias:s}=r,{beSilentOnParseLogs:o}=Ki.getInitOptions(),i=Object.values(s[t]),a=Ai.getTransceiverMid(n,o),d=a.audio,c=a.video;for(let n=0;n<i.length;n+=1){const r=i[n];r.transceiverMid=r.mediaState===kt.UNAVAILABLE?r.transceiverMid:null;for(let n=0;n<d.length;n+=1)if(d[n].streamId===r.streamId&&("sendonly"===d[n].direction||"sendrecv"===d[n].direction)){Ts.updatePeerMediaInfo(e,t,!1,r.mediaId,wt.TRANSCEIVER_MID,d[n].transceiverMid);break}for(let n=0;n<c.length;n+=1)if(c[n].streamId===r.streamId&&("sendonly"===c[n].direction||"sendrecv"===c[n].direction)){Ts.updatePeerMediaInfo(e,t,!1,r.mediaId,wt.TRANSCEIVER_MID,c[n].transceiverMid);break}}};var yr=(e,t,n,r)=>{const{peerMedias:s}=e,o=Object.values(s[t]);for(let e=0;e<o.length;e+=1)if(o[e].transceiverMid===n)return o[e][r];return null};var vr=(e,t)=>{const n=Ki.getSkylinkState(e.id),{peerMedias:r}=n,s=Object.values(r[t]),o=[];for(let e=0;e<s.length;e+=1){const t=s[e],n=sn()(t);delete n.trackId,delete n.streamId,o.push(n)}return o};var Mr=(e,t)=>{const n=Ki.getSkylinkState(e.id);return n.peerMedias[t]&&(n.peerMedias[t]={}),n};var Pr=(e,t,n)=>{const r=e.peerMedias[n.publisherId]||{};return r[n.mediaId]=n,((e,t)=>!zo(e)&&e[t])(t,n.mediaId)&&(r[n.mediaId].streamId=n.transceiverMid===t[n.mediaId].transceiverMid?t[n.mediaId].streamId:""),r};var kr=(e,t,n=!1,r=!1)=>new Promise((s,o)=>{const i=Ki.getSkylinkState(e),{user:a,peerStreams:d}=i;i||o(new Error(`${Wt.ROOM_STATE.NOT_FOUND} - ${e}`)),(!d[a.sid]||t&&!d[a.sid][t])&&o(new Error(`${Wt.MEDIA_STREAM.ERRORS.NO_STREAM} - ${t}`)),r?Ur.prepStopScreenStream(i.room,t,n).then(()=>s()).catch(e=>o(e)):Ur.prepStopUserMediaStreams(i,t,n).then(()=>s()).catch(e=>o(e))});var wr=(e,t,n)=>new Promise((r,s)=>{const{user:o,peerStreams:i}=e,a=(e=>{const{peerStreams:t,user:n,room:r}=e;return Object.keys(t[n.sid]).map(e=>Os.retrieveScreenMediaInfo(r,n.sid,{streamId:e})?null:t[n.sid][e]).filter(e=>null!==e)})(e);try{if(t){const r=i[o.sid][t];Ur.stopAddedStream(e,r,!1,n)}else Ur.stopAddedStreams(e,a,!1,n);return Ur.initRefreshConnectionAndResolve(e.room,n,r,s)}catch(e){tn.log.DEBUG([o.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA],e),s(Wt.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA)}});var br=class{static updatePeerStreamWithUserSid(e,t){const n=Ki.getSkylinkState(e.id);n.peerStreams.null&&(n.peerStreams[t]=Object.assign({},n.peerStreams.null),delete n.peerStreams.null,Ki.setSkylinkState(n,e.id))}static addStream(e,t=null,n){if(!t)return;const r=Ki.getSkylinkState(n),{peerStreams:s}=r;s[e]&&s[e][t.id]||(s[e]=s[e]||{},s[e][t.id]=t,Ki.setSkylinkState(r,n))}static deleteStream(e,t){const n=Ki.getSkylinkState(e.id),{user:r}=n,s=t.id;delete n.peerStreams[r.sid][s],zo(n.peerStreams[r.sid])&&delete n.peerStreams[r.sid],Ki.setSkylinkState(n,n.room.id)}static dispatchStreamEvent(e,t){switch(e){case c:qt(ce(t));break;case l:qt(le(t));break;case u:qt(ue(t));break;case w:qt(Ee(t))}}};const Lr=(e,t)=>!(!e||!e[0])&&(e.forEach(e=>{try{e.stop()}catch(n){tn.log.ERROR([t,yt.MEDIA_STREAM,null,`${Wt.MEDIA_STREAM.ERRORS.STOP_MEDIA_TRACK} - track id: ${e.id}`],n)}}),!0);var Gr=(e,t,n)=>{const{room:r}=e,s=e;let o=-1;if(!s.currentRTCRTPSenders[t])return;const i=s.currentRTCRTPSenders[t];for(let e=0;e<i.length;e+=1)if(n===i[e]){o=e;break}-1!==o?(i.splice(o,1),s.currentRTCRTPSenders[t]=i,Ki.setSkylinkState(s,r.id)):tn.log.WARN([t,null,null,"No matching sender was found for the peer."],n)};var Ur={prepStopStreams:kr,prepStopUserMediaStreams:wr,stopAddedStream:(e,t,n=!1,r=!1)=>{const{room:s,user:o}=e;try{Ur.tryStopStream(t,o.sid),r||(Ur.removeTracks(s,t),Os.setMediaStateToUnavailable(s,o.sid,Os.retrieveMediaId(t.getTracks()[0].kind,t.id)),br.deleteStream(s,t),Ur.listenForEventAndDeleteMediaInfo(s,t),Ur.dispatchEvents(s,t,n),n&&new Pi(e).deleteScreensharingInstance(s)),tn.log.INFO([o.sid,yt.MEDIA_STREAM,null,`${Wt.MEDIA_STREAM.STOP_SUCCESS} - stream id: ${t.id} ${n?"(screenshare)":""}`])}catch(e){tn.log.ERROR([o.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.ERRORS.STOP_ADDED_STREAM],e)}},tryStopStream:(e,t)=>{if(e){try{Lr(e.getAudioTracks())}catch(n){tn.log.ERROR([t,yt.MEDIA_STREAM,null,`${Wt.MEDIA_STREAM.ERRORS.STOP_AUDIO_TRACK} - stream id: ${e.id}`],n)}try{Lr(e.getVideoTracks())}catch(n){tn.log.ERROR([t,yt.MEDIA_STREAM,null,`${Wt.MEDIA_STREAM.ERRORS.STOP_VIDEO_TRACK} - stream id: ${e.id}`],n)}}},removeTracks:(e,t)=>{const n=Ki.getSkylinkState(e.id),{peerConnections:r,user:s}=n,o=t.getTracks();try{o.forEach(e=>{((e,t,n)=>{const r=n.id,s=Object.keys(t);for(let n=0;n<s.length;n+=1)try{const o=s[n],i=t[o];if(i.connectionState===Ke.CLOSED)break;const a=i.getSenders();let d=null;for(let t=0;t<a.length;t+=1)a[t].track&&a[t].track.id===r&&(d=a[t],i.removeTrack(d),Gr(e,o,d))}catch(e){tn.log.ERROR([s[n],yt.PEER_CONNECTION,null,Wt.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e)}})(n,r,e)})}catch(e){tn.log.ERROR([s.sid,yt.PEER_CONNECTION,null,Wt.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e)}},listenForEventAndDeleteMediaInfo:(e,t)=>{const n=Ki.getSkylinkState(e.id),r=r=>{const s=t,{user:o}=n,{detail:i}=r;if(i.state===Qe.OFFER){const t=Os.retrieveMediaId(Ri(s)?Pt.AUDIO:Pt.VIDEO,s.id);Os.deleteUnavailableMedia(e,o.sid,t)}},s=()=>{Yt(jt.HANDSHAKE_PROGRESS,r),Yt(jt.MEDIA_INFO_DELETED,s)};$t(jt.HANDSHAKE_PROGRESS,r),$t(jt.MEDIA_INFO_DELETED,s)},stopAddedStreams:(e,t,n,r)=>{t.forEach(t=>{Ur.stopAddedStream(e,t,n,r)})},updateMediaInfoMediaState:(e,t)=>{const n=Ki.getSkylinkState(e.id),{user:r}=n,s=t.id,o=Os.retrieveMediaId(t.getTracks()[0].kind,s);Os.setMediaStateToUnavailable(e,r.sid,o)},dispatchEvents:(e,t,n=!1)=>{const r=Ki.getSkylinkState(e.id),{MEDIA_STREAM:s}=Wt,{user:o}=r;tn.log.INFO([o.sid,yt.MEDIA_STREAM,null,s.STOP_SETTINGS],{peerId:o.sid,isSelf:!0,isScreensharing:n,stream:t}),br.dispatchStreamEvent(u,{room:wo.getRoomInfo(e.id),peerId:o.sid,peerInfo:Uo.getCurrentSessionInfo(e),isSelf:!0,isScreensharing:n,streamId:t.id,isVideo:gi(t),isAudio:Ri(t)}),qt(((e={})=>new de(W,{detail:e}))({isScreensharing:n,streamId:t.id})),qt(fe({peerId:o.sid,peerInfo:Go.getCurrentSessionInfo(e),isSelf:!0}))},prepStopScreenStream:(e,t,n=!1)=>new Promise((r,s)=>{const o=Ki.getSkylinkState(e.id),{user:i,peerStreams:a}=o,d=a[i.sid][t];try{Ur.stopAddedStream(o,d,!0,n),Ur.initRefreshConnectionAndResolve(o.room,n,r,s)}catch(e){tn.log.DEBUG([i.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.ERRORS.STOP_SCREEN],e),s(new Error(Wt.MEDIA_STREAM.ERRORS.STOP_SCREEN))}}),initRefreshConnectionAndResolve:(e,t,n,r)=>{const s=Ki.getSkylinkState(e.id),{peerConnections:o}=s;try{if(!t){if(Zo(Object.keys(o)))return(e=>{const{room:t,user:n}=e;qt(fe({peerId:n.sid,isSelf:!0,peerInfo:Uo.getCurrentSessionInfo(t)}))})(s),Os.deleteUnavailableMedia(s.room,s.user.sid),n();{const e=e=>{const{detail:t}=e;if(t.state===Qe.ANSWER_ACK)return n()};$t(jt.HANDSHAKE_PROGRESS,e),Di.refreshConnection(s)}}}catch(e){r(e)}}};class Fr{static getUserMedia(e,t={}){const{room:n}=e,r=Qo.parseMediaOptions(t,e),{audio:s,video:o}=t,i=!!t.useExactConstraints;return Ki.setSkylinkState(r,n.id),Qo.prepMediaAccessRequest({useExactConstraints:i,audio:s,video:o,roomKey:n.id})}static processUserMediaOptions(e,t=null){return new Promise((n,r)=>{let s={audio:!0,video:!0};t||tn.log.WARN([e.user.sid,yt.MEDIA_STREAM,null,`${Wt.MEDIA_STREAM.NO_OPTIONS} - ${Wt.MEDIA_STREAM.DEFAULT_OPTIONS}`],s),ti(t)||(tn.log.ERROR([e.user.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS],t),r(new Error(Wt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),null)),s=t;Fr.getUserMedia(e,s).then(e=>{n(e)}).catch(e=>{r(e)})})}static stopStreams(e,t){return Ur.prepStopStreams(e.room.id,t)}static addLocalMediaStreams(e,t){Qo.addLocalMediaStreams(e,t)}static onRemoteTrackAdded(e,t,n,r,s,o){Qo.onRemoteTrackAdded(e,t,n,r,s,o)}static muteStreams(e,t,n){return Qo.muteStreams(e,t,n)}static sendStream(e,t){return Qo.sendStream(e,t)}static getStreamSources(){return Qo.getStreamSources()}static getStreams(e,t){return Qo.getStreams(e,t)}static usePrefetchedStream(e,t,n=null){return new Promise(r=>{!t&&n.id&&n.active&&(t=n);const s={audio:0!==t.getAudioTracks().length,video:0!==t.getVideoTracks().length},o=Qo.parseStreamSettings(s,Pt.AUDIO),i=Qo.parseStreamSettings(s,Pt.VIDEO);r(Qo.onStreamAccessSuccess(e,t,o,i,!1,r))})}static buildStreamSettings(e,t,n){return Qo.buildStreamSettings(e,t,n)}}var Br=Fr;var Vr=new class extends Tn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,weight:null,sdp_type:null,sdp_sdp:null,error:null}}send(e,t,n,r,s,o){const i=Ki.getSkylinkState(e);this.model.client_id=i.clientId,this.model.app_key=Ki.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.sid||null,this.model.peer_id=n,this.model.state=t,this.model.is_remote=s,this.model.weight=r.weight||null,this.model.error=("string"==typeof o?o:o&&o.msg)||null,this.model.sdp_type=null,this.model.sdp_sdp=null,-1===["enter","welcome"].indexOf(this.model.state)&&(this.model.weight=this.model.is_remote&&Uo.getPeerInfo(this.model.peer_id,i.room).config&&Uo.getPeerInfo(this.model.peer_id,i.room).config.priorityWeight?Uo.getPeerInfo(this.model.peer_id,i.room).config.priorityWeight:Uo.getCurrentSessionInfo(i.room).config.priorityWeight,this.model.sdp_type=r&&r.type||null,this.model.sdp_sdp=r&&r.sdp||null),this.addToStatsBuffer("negotiation",this.model,this.endpoints.negotiation),this.manageStatsBuffer()}};var xr=(e,t,n,r,s)=>{const o=Ki.getSkylinkState(n.room.id),{peerConnections:i,bufferedLocalOffer:a,peerPriorityWeight:d,room:c}=o,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:l}}=Wt,u=i[t],E={type:r.type,sdp:r.sdp};if(u.processingLocalSDP=!0,tn.log.INFO([t,"RTCSessionDescription",r.type,"Local session description updated ->"],E.sdp),r.type===Qe.OFFER){Vr.send(c.id,l.OFFER.offer,t,r,!1),tn.log.INFO([t,"RTCSessionDescription",r.type,"Local offer saved."]),a[t]=r;const i={type:E.type,sdp:E.sdp,mid:o.user.sid,target:t,rid:n.room.id,userInfo:Uo.getUserInfo(n.room),weight:d,mediaInfoList:Os.retrieveMediaInfoForOfferAnswer(c,E)};if(s&&Object.keys(s).length){const e=Object.keys(s),t=Object.keys(i);for(let n=0;n<e.length;n+=1){const r=e[n];-1===t.indexOf(r)&&(i[r]=s[r])}}e(i)}else{Vr.send(c.id,l.ANSWER.answer,t,r,!1);e({type:E.type,sdp:E.sdp,mid:o.user.sid,target:t,rid:n.room.id,userInfo:Uo.getUserInfo(n.room),mediaInfoList:Os.retrieveMediaInfoForOfferAnswer(c,E)})}};const{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:Hr}}=Wt;var jr=(e,t,n=!1,r)=>{const s=Ki.getSkylinkState(e.id),o=Ki.getInitOptions(),{enableDataChannel:i}=o,{peerConnections:a,hasMCU:d,enableIceRestart:c,peerInformations:l,voiceActivityDetection:u,dataChannels:E}=s,S=a[t],p={iceRestart:!!((l[t]||{}).config||{}).enableIceRestart&&n&&c,voiceActivityDetection:u};return d&&"function"!=typeof S.addTransceiver&&(p.offerToReceiveVideo=!0),d&&t!==Bt.MCU||Br.addLocalMediaStreams(t,s),i&&l[t].config.enableDataChannel&&(E[t]&&E[t].main||(Di.createDataChannel({peerId:t,roomState:s,createAsMessagingChannel:!0}),s.peerConnections[t].hasMainChannel=!0)),tn.log.DEBUG([t,null,null,"Creating offer with config:"],p),S.endOfCandidates=!1,S.negotiating=!0,S.sdpConstraints=p,Ki.setSkylinkState(s,e.id),new Promise((e,n)=>{S.createOffer(p).then(n=>((e,t,n,r,s)=>{const{room:o}=n;tn.log.DEBUG([t,null,null,"Created offer"],s),Vr.send(o.id,Hr.OFFER.create,t,s,!1),xr(e,t,n,s,r)})(e,t,s,r,n)).catch(e=>((e,t,n,r)=>{const{room:s}=n;tn.log.ERROR([t,null,null,"Failed creating an offer:"],r),Vr.send(s.id,Hr.OFFER.create_error,t,null,!1,r),qt(he({state:Qe.ERROR,peerId:t,error:r,room:wo.getRoomInfo(n.room.id)})),e(r)})(n,t,s,e))})};var Wr=e=>{let t=null;const{currentRoom:n,targetMid:r,cert:s,hasScreenShare:o}=e,i=Ki.getSkylinkState(n.id),{room:a}=i,d=Object.assign({iceServers:a.connection.peerConfig.iceServers},cn("PEER_CONNECTION"));s&&(d.certificates=[s]),Ki.setSkylinkState(i,n.id);try{t=((e,t,n,r)=>{const s=Ki.getInitOptions(),o=Ki.getSkylinkState(r.id);tn.log.DEBUG([e,yt.PEER_CONNECTION,null,Wt.PEER_CONNECTION.CREATE_NEW],{constraints:t});const{RTCPeerConnection:i,msRTCPeerConnection:a}=window,d=new(s.useEdgeWebRTC&&a?window.msRTCPeerConnection:i)(t),c=[d,e,o];return d.setOffer="",d.setAnswer="",d.negotiating=!1,d.hasMainChannel=!1,d.processingLocalSDP=!1,d.processingRemoteSDP=!1,d.gathered=!1,d.gathering=!1,o.gatheredCandidates[e]={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}},o.peerEndOfCandidatesCounter[e]=o.peerEndOfCandidatesCounter[e]||{},e===Bt.MCU&&(tn.log.INFO("Creating an empty transceiver of kind video with MCU"),"function"==typeof d.addTransceiver&&d.addTransceiver("video")),d.restartIce&&(o.enableIceRestart=!0),Ki.setSkylinkState(o,r.id),d.ontrack=fs.ontrack.bind(d,...c),d.ondatachannel=fs.ondatachannel.bind(d,...c),d.onicecandidate=fs.onicecandidate.bind(d,...c),d.oniceconnectionstatechange=fs.oniceconnectionstatechange.bind(d,...c),d.onconnectionstatechange=fs.onconnectionstatechange.bind(d,...c),d.onsignalingstatechange=fs.onsignalingstatechange.bind(d,...c),d.onicegatheringstatechange=fs.onicegatheringstatechange.bind(d,...c),mi(Ft.REACT_NATIVE)&&(d.onsenderadded=fs.onsenderadded.bind(d,...c),d.onremovetrack=fs.onremovetrack.bind(d,e,o.room,!1)),d})(r,d,0,n),t.constraints=d}catch(e){tn.log.ERROR([r,null,null,"Failed creating peer connection:"],e),t=null,qt(he({state:Qe.ERROR,peerId:r,error:e,room:wo.getRoomInfo(a.id)}))}return t};var Kr=e=>{let t=null;const{currentRoom:n,targetMid:r,peerBrowser:s,cert:o,hasScreenShare:i}=e,a=Ki.getInitOptions(),d=Ki.getSkylinkState(n.id),{peerConnections:c,room:l}=d;if(c[r])tn.log.WARN([r,null,null,"Connection to peer has already been made."]);else{tn.log.INFO([r,null,null,"Starting the connection to peer. Options provided:"],{peerBrowser:s,enableDataChannel:a.enableDataChannel}),t=Wr({currentRoom:n,targetMid:r,hasScreenShare:i,cert:o,sdpSemantics:_t.UNIFIED});try{const e=t.getConfiguration();e.sdpSemantics===_t.UNIFIED?tn.log.INFO([r,"SDP Semantics",null,"Peer Connection has Unified plan."]):e.sdpSemantics===_t.PLAN_B?tn.log.INFO([r,"SDP Semantics",null,"Peer Connection has Plan-B."]):tn.log.INFO([r,"SDP Semantics",null,"The sdpSemantics parameter is not supported by this browser version."])}catch(e){tn.log.INFO([r,"SDP Semantics",null,"getConfiguration() is not available in this browser version. Ex : "],e)}d.peerConnections[r]=t,Ki.setSkylinkState(d,n.id),Rr.send(l.id,"new",r,!1)}return t};const{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:$r}}=Wt;var Yr=(e,t)=>{const n=Ki.getSkylinkState(e.room.id),{peerConnections:r,hasMCU:s,voiceActivityDetection:o}=n,i=r[t],a={voiceActivityDetection:o};return tn.log.INFO([t,null,null,"Creating answer with config:"],a),s&&t!==Bt.MCU||Br.addLocalMediaStreams(t,e),new Promise((n,r)=>i.createAnswer(a).then(r=>((e,t,n,r)=>{const{room:s}=n;tn.log.DEBUG([t,null,null,"Created answer"],r),Vr.send(s.id,$r.ANSWER.create,t,r,!1),xr(e,t,n,r)})(n,t,e,r)).catch(n=>((e,t,n,r)=>{const{room:s}=n;tn.log.ERROR([t,null,null,"Failed creating an answer:"],r),Vr.send(s.id,$r.ANSWER.create_error,t,null,!1,r),qt(he({state:Qe.ERROR,peerId:t,error:r,room:wo.getRoomInfo(n.room.id)})),e(r)})(r,t,e,n)))};var qr=(e,t,n,r,s)=>{const o=Ki.getSkylinkState(e.room.id),i=o.peerConnections[t],a=o.dataChannels[t];let d=r;if(d&&d!==t||(d="main"),!("object"==typeof n&&n||n&&"string"==typeof n))return tn.log.WARN([t,"RTCDataChannel",d,"Dropping invalid data ->"],n),null;if(!i||i.signalingState===Ke.CLOSED)return tn.log.WARN([t,"RTCDataChannel",d,"Dropping for sending message as Peer connection does not exists or is closed ->"],n),null;if(!a||!a[d])return tn.log.WARN([t,"RTCDataChannel",d,"Dropping for sending message as Datachannel connection does not exists ->"],n),null;const c=a[d].channelName,l=a[d].channelType,u=a[d].channel.readyState,E="object"==typeof n&&n.type===ft.MESSAGE?we.MESSAGE:we.TRANSFER;if(u!==Pe.OPEN){const e=new Error("Failed sending message as Datachannel connection state is not opened. Current readyState is "+u);throw tn.log.ERROR([t,"RTCDataChannel",d,e],n),qt(Se({peerId:t,channelName:c,channelType:l,messageType:E,error:e,state:Pe.SEND_MESSAGE_ERROR,bufferAmount:Di.getDataChannelBuffer(a[d].channel)})),e}try{s||"object"!=typeof n?(tn.log.DEBUG([t,"RTCDataChannel",d,"Sending data with size ->"],n.size||n.length||n.byteLength),a[d].channel.send(n)):(tn.log.DEBUG([t,"RTCDataChannel",d,`Sending ${n.type} protocol message ->`],n),a[d].channel.send(JSON.stringify(n)))}catch(e){throw tn.log.ERROR([t,"RTCDataChannel",d,"Failed sending data)"],{error:e,data:n}),qt(Se({peerId:t,channelName:c,channelType:l,messageType:E,error:e,state:Pe.SEND_MESSAGE_ERROR,bufferAmount:Di.getDataChannelBuffer(a[d].channel)})),e}return null};var Jr=(e,t,n,r,s)=>{const o=Ki.getSkylinkState(e.room.id);let i=null,a=null,d=!1;const c=s===ke.MESSAGING?"main":r,l=o.dataChannels[n]||{};if(!l.hasOwnProperty(c)||"object"!=typeof l[c])return null;if(i=l[c].transferId,a=l[c].streamId,a&&o.dataStreams&&o.dataStreams[a]&&(d="string"===o.dataStreams[a].sessionChunkType?"string"==typeof t:"object"==typeof t),!o.peerConnections[n])return tn.log.WARN([n,"RTCDataChannel",c,"Dropping data received from Peer as connection is not present ->"],t),null;if(!o.dataChannels[n]||!o.dataChannels[n][c])return tn.log.WARN([n,"RTCDataChannel",c,"Dropping data received from Peer as Datachannel connection is not present ->"],t),null;if("string"==typeof t)try{const r=JSON.parse(t);if(d=!1,tn.log.DEBUG([n,"RTCDataChannel",c,`Received protocol ${r.type} message ->`],r),[ft.ACK,ft.ERROR,ft.CANCEL].indexOf(r.type)>-1&&!(i&&o.dataTransfers[i]&&o.dataTransfers[i].sessions[n]))return tn.log.WARN([n,"RTCDataChannel",c,"Discarded protocol message as data transfer session is not present ->"],r),null;switch(r.type){case ft.WRQ:if(i&&o.dataTransfers[i]&&o.dataTransfers[i].sessions[n]){tn.log.WARN([n,"RTCDataChannel",c,"Rejecting bidirectional data transfer request as it is currently not supported in the SDK ->"],r),qr(e,n,{type:ft.ACK,ackN:-1,sender:o.user.sid},c);break}break;case ft.MESSAGE:((e,t,n,r)=>{const s=n.sender||t;tn.log.INFO([s,"RTCDataChannel",r,"Received P2P message from peer:"],n),qt(pe({room:e.room,message:{targetPeerId:n.target,content:n.data,senderPeerId:s,isDataChannel:!0,isPrivate:n.isPrivate},isSelf:!1,peerId:s,peerInfo:Uo.getPeerInfo(s,e.room)}))})(o,n,r,c);break;default:tn.log.WARN([n,"RTCDataChannel",c,`Discarded unknown ${r.type} message ->`],r)}}catch(e){qt(Se({peerId:n,channelName:r,channelType:s,error:e,state:Pe.ERROR,bufferAmount:Di.getDataChannelBuffer(o.dataChannels[n][c].channel)}))}return null};var Xr=(e,t)=>{const{peerId:n,channelName:r,channelType:s,roomState:o}=e;Jr(o,t.data,n,r,s)};var Qr=class extends Tn{constructor(){super();const{AdapterJS:e}=window;this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,channel_id:null,channel_label:null,channel_type:null,channel_binary_type:null,error:null,agent_name:e.webrtcDetectedBrowser,agent_type:e.webrtcDetectedType,agent_version:e.webrtcDetectedVersion}}send(e,t,n,r,s,o){const i=Ki.getSkylinkState(e);this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.uid||null,this.model.peer_id=n,this.model.client_id=i.clientId,this.model.state=t,this.model.channel=r,this.model.channel_id=r.id,this.model.channel_label=r.label,this.model.channel_type="main"===s?"persistent":"temporal",this.model.channel_binary_type=r.binaryType,this.model.app_key=Ki.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.error=("string"==typeof o?o:o&&o.message)||null,"plugin"===this.model.agent_name&&(this.model.channel_binary_type="int8Array","IE"===this.model.agent_name&&this.model.agent_version<11&&(this.model.channel_binary_type="none")),this.postStats(this.endpoints.dataChannel,this.model)}};var zr={onopen:e=>{const{dataChannel:t,channelProp:n,channelName:r,channelType:s,peerId:o,roomState:i,bufferThreshold:a}=e,d=new Qr,{room:c}=i,{STATS_MODULE:l}=Wt;tn.log.DEBUG([o,"RTCDataChannel",n,"Datachannel has opened"]),t.bufferedAmountLowThreshold=a||0,d.send(c.id,l.HANDLE_DATA_CHANNEL_STATS.closed,o,t,n),qt(Se({state:Pe.OPEN,peerId:o,channelName:r,channelType:s,bufferAmount:Di.getDataChannelBuffer(t)}))},onmessage:Xr,onerror:(e,t)=>{const{dataChannel:n,peerId:r,channelName:s,channelProp:o,channelType:i,roomState:a}=e;if("NONE"!==t.error.errorDetail){const e=Ki.getSkylinkState(a.room.id),{room:d}=e,c=new Qr;tn.log.ERROR([r,"RTCDataChannel",o,"Datachannel has an exception ->"],t),c.send(d.id,Pe.ERROR,r,n,o,t),qt(Se({state:Pe.ERROR,peerId:r,channelName:s,channelType:i,bufferAmount:Di.getDataChannelBuffer(n),error:t}))}else tn.log.DEBUG([r,"RTCDataChannel",o,"Datachannel state ->"],t.error.message)},onbufferedamountlow:e=>{const{dataChannel:t,peerId:n,channelName:r,channelProp:s,channelType:o,roomState:i}=e,a=Ki.getSkylinkState(i.room.id),{room:d}=a;tn.log.DEBUG([n,"RTCDataChannel",s,"Datachannel buffering data transfer low"]),qt(Se({state:Pe.BUFFERED_AMOUNT_LOW,room:wo.getRoomInfo(d.id),peerId:n,channelName:r,channelType:o,bufferAmount:Di.getDataChannelBuffer(t)}))},onclose:e=>{const{dataChannel:t,peerId:n,channelName:r,channelProp:s,channelType:o,roomState:i}=e,{DATA_CHANNEL:a,STATS_MODULE:d}=Wt,c=Ki.getSkylinkState(i.room.id)||Object.values(Ki.getSkylinkState())[0];if(!c)return;const{room:l,peerConnections:u}=c,E=new Qr;tn.log.DEBUG([n,"RTCDataChannel",s,a.closed]);try{if(E.send(l.id,d.HANDLE_DATA_CHANNEL_STATS.closed,n,t,s),qt(Se({state:Pe.CLOSED,peerId:n,room:wo.getRoomInfo(l.id),channelName:r,channelType:o,bufferAmount:Di.getDataChannelBuffer(t)})),u[n]&&u[n].remoteDescription&&u[n].remoteDescription.sdp&&(-1===u[n].remoteDescription.sdp.indexOf("m=application")||u[n].remoteDescription.sdp.indexOf("m=application 0")>0))return;o===ke.MESSAGING&&setTimeout(()=>{u[n]&&u[n].signalingState!==Ke.CLOSED&&u[n].localDescription&&u[n].localDescription.type===Qe.OFFER&&(tn.log.DEBUG([n,"RTCDataChannel",s,a.reviving_dataChannel]),Di.createDataChannel({peerId:n,dataChannel:t,bufferThreshold:Di.getDataChannelBuffer(t),createAsMessagingChannel:!0,roomState:c}),E.send(l.id,d.HANDLE_DATA_CHANNEL_STATS.reconnecting,n,{label:r},"main"))},100)}catch(e){tn.log.WARN([n,"RTCDataChannel",s,a.closed])}}};const Zr=(e,t,n)=>{const r=Ki.getInitOptions(),{dataChannels:s,room:o,user:i,hasMCU:a}=e;let d=Object.keys(s),c=!1;if(Array.isArray(n)&&n.length?(d=n,c=!0):n&&"string"==typeof n&&(d=[n],c=!0),!o.inRoom||!i||!i.sid)return tn.log.ERROR("Unable to send message as User is not in Room. ->",t),null;if(!r.enableDataChannel)return tn.log.ERROR("Unable to send message as User does not have DataChannel enabled. ->",t),null;for(let r=0;r<d.length;r+=1){const o=d[r];s[o]||a?o===Bt.MCU?(d.splice(r,1),r-=1):a||(tn.log.DEBUG([o,"RTCDataChannel",null,`Sending ${c?"private":""} P2P message to Peer.`]),qr(e,o,{type:ft.MESSAGE,isPrivate:c,sender:i.sid,target:n?o:null,data:t},"main")):(tn.log.ERROR([o,"RTCDataChannel",null,"Dropping of sending message to Peer as DataChannel connection does not exist."]),d.splice(r,1),r-=1)}return 0===d.length&&tn.log.WARN("Currently there are no Peers to send P2P message to."),a&&(tn.log.DEBUG([Bt.MCU,"RTCDataChannel",null,`Broadcasting ${c?"private":""} P2P message to Peers.`]),qr(e,Bt.MCU,{type:ft.MESSAGE,isPrivate:c,sender:i.sid,target:d,data:t},"main")),!n&&a||qt(pe({room:wo.getRoomInfo(e.room.id),message:{targetPeerId:n||null,content:t,senderPeerId:i.sid,isDataChannel:!0,isPrivate:c},isSelf:!0,peerId:i.sid,peerInfo:Uo.getCurrentSessionInfo(e.room)})),null};const es=(e,t,n)=>{const{dataChannels:r}=e,s=r[t][n],{channelName:o,channelType:i}=s.channelName;if(s.readyState!==Pe.CLOSED){const{room:a}=e,d=new Qr;tn.log.DEBUG([t,yt.DATA_CHANNEL,n,Wt.DATA_CHANNEL.CLOSING]),d.send(a.id,Pe.CLOSING,t,s.channel,n),qt(Se({room:a,peerId:t,state:Pe.CLOSING,channelName:o,channelType:i,bufferAmount:Di.getDataChannelBuffer(s.channel)})),s.channel.close(),delete r[t][n]}};var ts=(e,t,n,r)=>{const s=Ki.getSkylinkState(t.id),{hasMCU:o,peerInformations:i,enableIceRestart:a}=s,d=Uo.getPeersCustomSettings(s),c={};return c[e]={iceRestart:!o&&i[e]&&i[e].config&&i[e].config.enableIceRestart&&a&&n,customSettings:d[e]||{}},r&&(c.errors=r),c};const ns=(e,t,n)=>{const r={};return r.listOfPeers=e,r.refreshErrors=t,r.refreshSettings=n,r},rs=(e,t,n)=>{const r=[];return Object.keys(e).forEach(s=>{r.push(ts(e[s],t,n))}),r},ss=(e,t)=>{const n={};return n[e]=t,n};var os=(e,t,n,r)=>new Promise((s,o)=>{e||o(new Error(Wt.ROOM_STATE.NO_ROOM_NAME));const{peerConnections:i,hasMCU:a,room:d}=e,c=Ki.getInitOptions(),{mcuUseRenegoRestart:l}=c,{PEER_CONNECTION:u}=Wt,E=((e,t,n,r)=>{let s=!1,o={},i=Object.keys(r);return Array.isArray(e)?i=e:ii(e)?i=[e]:oi(e)?s=e:e&&ti(e)&&(o=e),oi(t)?s=t:t&&ti(t)&&(o=t),n&&ti(n)&&(o=n),{listOfPeers:i,doIceRestart:s,bwOptions:o}})(t,n,r,i),{listOfPeers:S,doIceRestart:p,bwOptions:h}=E;try{!Zo(S)||a&&!l||(tn.log.ERROR(u.NO_PEER_CONNECTION),o({refreshErrors:{self:u.NO_PEER_CONNECTION},listOfPeers:S})),tn.log.INFO([null,yt.PEER_CONNECTION,null,u.REFRESH_CONNECTION.START]);Di.refreshPeerConnection(S,e,p,h).then(e=>{const t=a?[e]:e,n=[];for(let e=0;e<t.length;e+=1)if(Array.isArray(t[e])){const r=t[e];n.push(ss(r[0],r[1])),tn.log.WARN([S,yt.PEER_CONNECTION,null,u.REFRESH_CONNECTION.FAILED],r[0])}else ii(t[e])&&tn.log.INFO([S,yt.PEER_CONNECTION,null,u.REFRESH_CONNECTION.SUCCESS],t[e]);n.length===S.length?o(ns(S,n,rs(S,d,p))):s(ns(S,n,rs(S,d,p)))}).catch(e=>tn.log.ERROR([null,yt.PEER_CONNECTION,null,u.REFRESH_CONNECTION.FAILED],e)).finally(()=>tn.log.INFO(u.REFRESH_CONNECTION.COMPLETED))}catch(e){o(e)}});var is=(e,t,n)=>{const{room:r}=e,s=new fo;try{const e=s.messageBuilder.getRestartOfferMessage(r.id,t,n);return s.offer(r,t,n,e),t}catch(e){return[t,e]}};var as=(e,t,n)=>{const r=Ki.getSkylinkState(t.room.id),{peerConnections:s,streamsBandwidthSettings:o,peerEndOfCandidatesCounter:i,room:a,user:d}=r,{doIceRestart:c,bwOptions:l}=n,u=new fo,E=[];return new Promise(t=>{if(!s[e])return tn.log.ERROR([e,null,null,Wt.PEER_CONNECTION.ERRORS.NOT_FOUND]),E.push(Wt.PEER_CONNECTION.ERRORS.NOT_FOUND),t([e,E]);const n=s[e];if(0!==E.length)return t([e,E]);if(n.signalingState===Ke.STABLE)return tn.log.INFO([e,null,null,Wt.PEER_CONNECTION.REFRESH_CONNECTION.SEND_RESTART_OFFER],{iceRestart:c,options:l}),r.streamsBandwidthSettings.bAS=l.bandwidth||o.bAS,r.peerEndOfCandidatesCounter[e]=i[e]||{},r.peerEndOfCandidatesCounter[e].len=0,Ki.setSkylinkState(r,r.room.id),t(is(r,e,c));const S=n.localDescription&&n.localDescription.sdp;return n.signalingState===Ke.HAVE_LOCAL_OFFER&&S?(u.sendMessage({type:n.localDescription.type,sdp:n.localDescription.sdp,mid:d.sid,target:e,rid:a.id,restart:!0}),t(e)):(tn.log.DEBUG([e,yt.PEER_CONNECTION,null,Wt.PEER_CONNECTION.REFRESH_CONNECTION.NO_LOCAL_DESCRIPTION],{localDescription:n.localDescription,remoteDescription:n.remoteDescription,signalingState:n.signalingState}),E.push(Wt.PEER_CONNECTION.REFRESH_CONNECTION.NO_LOCAL_DESCRIPTION),t([e,E]),null)})};var ds=(e,t,n)=>new Promise(r=>{const s=e,o=Ki.getInitOptions(),{mcuUseRenegoRestart:i}=o;try{s.streamsBandwidthSettings.bAS=n.bandwidth||s.streamsBandwidthSettings.bAS,i&&(s.peerEndOfCandidatesCounter.MCU=s.peerEndOfCandidatesCounter.MCU||{},s.peerEndOfCandidatesCounter.MCU.len=0,Ki.setSkylinkState(s),r(is(s,Bt.MCU,t)))}catch(e){r([Bt.MCU,e])}});const cs=(e,t,n)=>as(e,t,n);var ls={createOffer:jr,createAnswer:Yr,addPeer:Kr,createDataChannel:e=>{let{peerId:t,dataChannel:n,bufferThreshold:r,createAsMessagingChannel:s,roomState:o}=e;const i=Ki.getSkylinkState(o.room.id),{user:a,peerConnections:d,dataChannels:c}=i,l=d[t];let u="-_"+t,E=!0===s?ke.MESSAGING:ke.DATA,S=E===ke.MESSAGING?"main":u;if(!a||!a.sid)return tn.log.ERROR([t,"RTCDataChannel",S,"Aborting of creating or initializing DataChannel as User does not have Room session"]),null;if(u=`${a.sid}_${t}`,!l||l.signalingState===Ke.CLOSED)return tn.log.ERROR([t,"RTCDataChannel",S,"Aborting of creating or initializing Datachannel as Peer connection does not exists"]),null;if(n&&"object"==typeof n?u=n.label:"string"==typeof n&&(u=n,n=null),c[t]?c[t].main&&c[t].main.channel.label===u&&(S="main",E=ke.MESSAGING):(S="main",E=ke.MESSAGING,c[t]={},tn.log.DEBUG([t,"RTCDataChannel",S,"initializing main DataChannel"])),!n)try{n=l.createDataChannel(u,{reliable:!0,ordered:!0})}catch(e){tn.log.ERROR([t,"RTCDataChannel",S,"Failed creating Datachannel ->"],e);const r=new Qr,{room:s}=o;return r.send(s.id,Pe.ERROR,t,{label:u},S,e),qt(Se({state:Pe.CREATE_ERROR,peerId:t,error:e,channelName:u,channelType:E,buferAmount:Di.getDataChannelBuffer(n)})),null}const p={dataChannel:n,peerId:t,channelName:u,channelProp:S,channelType:E,roomState:o,bufferThreshold:r};n.onopen=zr.onopen.bind(n,p),n.onmessage=zr.onmessage.bind(n,p),n.onerror=zr.onerror.bind(n,p),n.onbufferedamountlow=zr.onbufferedamountlow.bind(n,p),n.onclose=zr.onclose.bind(n,p);const h=E===ke.MESSAGING?"main":u;return i.dataChannels[t][h]={channelName:u,channelType:E,transferId:null,streamId:null,channel:n},Ki.setSkylinkState(i,o.room.id),null},sendP2PMessage:(e,t,n)=>{const r=li(e);if(r)Zr(r,t,n);else{const e=Ki.getSkylinkState(),r=Object.keys(e);for(let s=0;s<r.length;s+=1){const o=e[r[s]];Zr(o,t,n)}}},getPeersInRoom:e=>{const t=li(e);if(t){const e={},n=Object.keys(t.peerInformations);for(let r=0;r<n.length;r+=1)n[r]!==Bt.MCU&&(e[n[r]]=Object.assign({},Uo.getPeerInfo(n[r],t.room)),e[n[r]].isSelf=!1);return t.user&&t.user.sid&&(e[t.user.sid]=Object.assign({},Uo.getCurrentSessionInfo(t.room)),e[t.user.sid].isSelf=!0),e}return null},signalingEndOfCandidates:(e,t)=>{const n=Ki.getSkylinkState(t.room.id),r=n.peerEndOfCandidatesCounter[e],o=n.peerConnections[e],i=n.peerCandidatesQueue[e],a=n.gatheredCandidates[e],{TAGS:d}=s,{ICE_CONNECTION:c}=Wt;if(!r)return null;if(o&&o.signalingState!==Ke.CLOSED&&o.remoteDescription&&o.remoteDescription.sdp&&"number"==typeof r.expectedLen&&r.len>=r.expectedLen&&(!i||0===i.length)&&!r.hasSet){tn.log.DEBUG([e,d.PEER_CONNECTION,null,c.END_OF_CANDIDATES_SUCCESS]),r.hasSet=!0;try{if(a){const t={expected:r.expectedLen||0,received:r.len||0,processed:a.receiving.srflx.length+a.receiving.relay.length+a.receiving.host.length};qt((l={room:n.room,peerId:e,candidatesLength:t},new de(A,{detail:l})))}n.peerEndOfCandidatesCounter[e]=r,Ki.setSkylinkState(n,t.room.id)}catch(t){tn.log.ERROR([e,d.PEER_CONNECTION,null,c.END_OF_CANDIDATES_FAILURE],t)}}var l;return null},getDataChannelBuffer:e=>({bufferedAmountLow:parseInt(e.bufferedAmountLow,10)||0,bufferedAmountLowThreshold:parseInt(e.bufferedAmountLowThreshold,10)||0}),refreshDataChannel:(e,t)=>{const{dataChannels:n,peerConnections:r}=e;if((e=>!zo(e))(n)&&Object.hasOwnProperty.call(n,t)){if(Object.hasOwnProperty.call(n[t],"main")){const s=n[t].main,{channelName:o,channelType:i}=s,a=s.channel.bufferedAmountLowThreshold||0;i===ke.MESSAGING&&setTimeout(()=>{Object.hasOwnProperty.call(r,t)&&r[t].signalingState!==Ke.CLOSED&&r[t].localDescription.type===Qe.OFFER&&(Di.closeDataChannel(e,t),tn.log.DEBUG([t,"RTCDataChannel","main",Wt.DATA_CHANNEL.reviving_dataChannel]),Di.createDataChannel({roomState:e,peerId:t,dataChannel:o,bufferThreshold:a,createAsMessagingChannel:!0}))},100)}}else tn.log.DEBUG([t,"RTCDataChannel",Wt.DATA_CHANNEL.refresh_error])},closeDataChannel:(e,t,n="main")=>{try{const r=Ki.getSkylinkState(e.room.id),{dataChannels:s,room:o}=r;if(!s[t]||!s[t][n])return void tn.log.WARN([t,yt.DATA_CHANNEL,n||null,Wt.DATA_CHANNEL.ERRORS.NO_SESSIONS]);if("main"===n)return void((e,t)=>{const{dataChannels:n}=e,r=Object.keys(n[t]);for(let s=0;s<r.length;s+=1)Object.hasOwnProperty.call(n[t],r[s])&&es(e,t,r[s]);delete n[t]})(r,t);es(r,t,n),Ki.setSkylinkState(r,o.id)}catch(e){tn.log.ERROR([t,yt.DATA_CHANNEL,n||null,Wt.DATA_CHANNEL.ERRORS.FAILED_CLOSING],e)}},refreshConnection:os,refreshPeerConnection:(e,t,n=!1,r={})=>{const s=Ki.getSkylinkState(t.room.id),{hasMCU:o}=s;try{if(!o){const t=[];for(let o=0;o<e.length;o+=1){const i=e[o],a=cs(i,s,{doIceRestart:n,bwOptions:r});t.push(a)}return Promise.all(t)}return ds(t,n,r)}catch(e){return tn.log.ERROR([null,yt.PEER_CONNECTION,null,Wt.PEER_CONNECTION.REFRESH_CONNECTION.FAILED],e),null}},restartPeerConnection:as,buildPeerInformations:(e,t)=>{const n=e,r=n.sid;return n.room=t.room.roomName,n.settings.data=!!(t.dataChannels[r]&&t.dataChannels[r].main&&t.dataChannels[r].main.channel&&t.dataChannels[r].main.channel.readyState===Pe.OPEN),n},getConnectionStatus:(e,t=null)=>{const{ROOM_STATE:n}=Wt;if(!e)return tn.log.WARN(n.NO_ROOM_NAME),pi(n.NO_ROOM_NAME);const{room:r}=e,s=((e,t)=>{const{peerConnections:n,room:r}=e,{PEER_CONNECTION:s}=Wt;let o=null,i=null;return Zo(Object.keys(n))?i=s.NOT_INITIALISED:Array.isArray(t)?(o=t,o.forEach(e=>{hi(r,e)||(i=`${s.PEER_ID_NOT_FOUND} ${e}`)})):ii(t)?(hi(r,t)||(i=`${s.PEER_ID_NOT_FOUND} ${t}`),o=[t]):o=Object.keys(n),{peerIds:o,errorMsg:i}})(e,t);if(s.errorMsg)return tn.log.WARN(s.errorMsg),pi(s.errorMsg);const{peerIds:o}=s,i=[];for(let e=0;e<o.length;e+=1){const t=new Ni(r.id,o[e]);i.push(t.getConnectionStatus())}return Promise.all(i)},closePeerConnection:(e,t)=>{const n=Ki.getSkylinkState(e.room.id),{peerConnections:r,room:s}=n;r[t].close(),Ki.setSkylinkState(n,s.id)},updatePeerInformationsMediaStatus:(e,t,n,r)=>{const s=Ki.getSkylinkState(e.id);s.peerInformations[t].mediaStatus=((e,t,n,r)=>{const{peerMedias:s,peerInformations:o}=e,i=s[t],a=o[t].mediaStatus||{};return Object.values(i).forEach(e=>{e.transceiverMid===n.mid&&(a[r.id]={audioMuted:Ri(r)?e.mediaState===kt.MUTED?0:1:-1,videoMuted:gi(r)?e.mediaState===kt.MUTED?0:1:-1})}),delete a.audioMuted,delete a.videoMuted,a})(s,t,n,r),Ki.setSkylinkState(s,e.id)},processNewSender:(e,t,n)=>{const r=e;r.currentRTCRTPSenders[t]||(r.currentRTCRTPSenders[t]=[]),r.currentRTCRTPSenders[t].push(n),Ki.setSkylinkState(r,r.room.id)}};var us=(e,t,n,r)=>{const s=r.channel||r,o=Ki.getInitOptions(),i=Ki.getSkylinkState(n.room.id),{peerInformations:a}=i,{enableDataChannel:d}=o;tn.log.DEBUG([t,"RTCDataChannel",s.label,"Received datachannel ->"],s),d&&a[t].config.enableDataChannel?(e.hasMainChannel||(e.hasMainChannel=!0),ls.createDataChannel({peerId:t,dataChannel:s,roomState:n})):tn.log.WARN([t,"RTCDataChannel",s.label,"Not adding datachannel as enable datachannel is set to false"])};var Es=(e,t,n,r)=>{mr.onIceCandidate(t,r.candidate||r,n.room)};var Ss=class extends Tn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,local_candidate:{},remote_candidate:{}}}send(e,t,n){try{const r=Ki.getSkylinkState(e);if(!r)return;this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.peer_id=n,this.model.client_id=r.clientId,this.model.state=t,this.model.app_key=Ki.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),Di.retrieveStatistics(e,n,Ki.getInitOptions().beSilentOnStatsLogs).then(e=>{e&&["local","remote"].forEach(t=>{const n=e.selectedCandidatePair[t];if(n){const e=this.model[t+"_candidate"];e.ip_address=n.ipAddress||null,e.port_number=n.portNumber||null,e.candidate_type=n.candidateType||null,e.protocol=n.transport||null,e.priority=n.priority||null,"local"===t&&(this.model.local_candidate.network_type=n.networkType||null)}}),this.postStats(this.endpoints.iceConnection,this.model)}).catch(e=>{tn.log.DEBUG(Wt.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.RETRIEVE_FAILED,e)})}catch(e){tn.log.DEBUG(Wt.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.SEND_FAILED,e)}}};const ps=(e,t,n,r)=>{const s=e[t]["send"===n?"sending":"receiving"][r];return["number","string","boolean"].indexOf(typeof s)>-1?s:null};var hs=class extends Tn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,audio_send:{tracks:[]},audio_recv:{},video_send:{tracks:[]},video_recv:{},error:null},this.stats=null}gatherSendAudioPacketsStats(){this.model.audio_send.bytes=ps(this.stats,"audio","send","bytes"),this.model.audio_send.packets=ps(this.stats,"audio","send","packets"),this.model.audio_send.echo_return_loss=ps(this.stats,"audio","send","echoReturnLoss"),this.model.audio_send.echo_return_loss_enhancement=ps(this.stats,"audio","send","echoReturnLossEnhancement"),this.model.audio_send.round_trip_time=ps(this.stats,"audio","send","roundTripTime"),this.model.audio_send.audio_level=ps(this.stats,"audio","send","audioLevel"),this.model.audio_send.jitter=ps(this.stats,"audio","send","jitter")}gatherReceiveAudioPacketsStats(){this.model.audio_recv.bytes=ps(this.stats,"audio","recv","bytes"),this.model.audio_recv.packets=ps(this.stats,"audio","recv","packets"),this.model.audio_recv.packets_lost=ps(this.stats,"audio","recv","packetsLost"),this.model.audio_recv.jitter=ps(this.stats,"audio","recv","jitter"),this.model.audio_recv.audio_level=ps(this.stats,"audio","recv","audioLevel")}gatherSendVideoPacketsStats(){this.model.video_send.bytes=ps(this.stats,"video","send","bytes"),this.model.video_send.packets=ps(this.stats,"video","send","packets"),this.model.video_send.nack_count=ps(this.stats,"video","send","nacks"),this.model.video_send.firs_count=ps(this.stats,"video","send","firs"),this.model.video_send.plis_count=ps(this.stats,"video","send","plis"),this.model.video_send.frames_encoded=ps(this.stats,"video","send","framesEncoded"),this.model.video_send.frame_width=ps(this.stats,"video","send","frameWidth"),this.model.video_send.frame_height=ps(this.stats,"video","send","frameHeight"),this.model.video_send.round_trip_time=ps(this.stats,"video","send","roundTripTime"),this.model.video_send.qp_sum=ps(this.stats,"video","send","qpSum"),this.model.video_send.jitter=ps(this.stats,"video","send","jitter"),this.model.video_send.frames=ps(this.stats,"video","send","frames"),this.model.video_send.hugeFrames=ps(this.stats,"video","send","hugeFramesSent"),this.model.video_send.framesPerSecond=ps(this.stats,"video","send","framesPerSecond")}gatherReceiveVideoPacketsStats(){this.model.video_recv.bytes=ps(this.stats,"video","recv","bytes"),this.model.video_recv.packets=ps(this.stats,"video","recv","packets"),this.model.video_recv.packets_lost=ps(this.stats,"video","recv","packetsLost"),this.model.video_recv.nack_count=ps(this.stats,"video","recv","nacks"),this.model.video_recv.firs_count=ps(this.stats,"video","recv","firs"),this.model.video_recv.plis_count=ps(this.stats,"video","recv","plis"),this.model.video_recv.frames_decoded=ps(this.stats,"video","recv","framesDecoded"),this.model.video_recv.qp_sum=ps(this.stats,"video","recv","qpSum"),this.model.video_recv.frames_decoded=ps(this.stats,"video","recv","framesDecoded"),this.model.video_recv.frames_dropped=ps(this.stats,"video","recv","framesDropped"),this.model.video_recv.decoderImplementation=ps(this.stats,"video","recv","decoderImplementation")}buildTrackInfo(e){const t=Ki.getSkylinkState(e),{peerStreams:n,user:r,streamsSettings:s}=t;Object.values(n[r.sid]).forEach(e=>{if(e){const t=e,{settings:n}=s[e.id],r=t.getAudioTracks(),o=t.getVideoTracks();r.forEach(e=>{const n=((e,t)=>({stream_id:e.id,id:t.id,label:t.label,muted:!t.enabled}))(t,e);this.model.audio_send.tracks.push(n)}),o.forEach(e=>{const r=((e,t,n)=>({stream_id:e.id,id:t.id,label:t.label,height:n.video.resolution.height,width:n.video.resolution.width,muted:!t.enabled}))(t,e,n);this.model.video_send.tracks.push(r)})}})}send(e,t,n){const{STATS_MODULE:r}=Wt,s=Ki.getSkylinkState(e);s?s.peerStreams[s.user.sid]&&(this.model.client_id=s.clientId,this.model.app_key=Ki.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=n,Di.retrieveStatistics(e,n,Ki.getInitOptions().beSilentOnStatsLogs).then(t=>{t&&(this.stats=t,this.gatherSendAudioPacketsStats(),this.gatherReceiveAudioPacketsStats(),this.gatherSendVideoPacketsStats(),this.gatherReceiveVideoPacketsStats(),this.buildTrackInfo(e),this.postStats(this.endpoints.bandwidth,this.model))}).catch(e=>{this.model.error=e?e.message:null,tn.log.DEBUG(r.HANDLE_BANDWIDTH_STATS.RETRIEVE_FAILED,e)})):tn.log.DEBUG([n,"Statistics","Bandwidth_Stats",r.HANDLE_BANDWIDTH_STATS.NO_STATE])}};let Rs={};class gs{constructor(e){if(e.roomKey)return this.resetBandwidthAdjusterInstance(e.roomKey,e.peerId),null;const{peerConnection:t,state:n,targetMid:r}=e;if(Rs[r])return Rs[r];this.peerId=r,this.state=n,this.peerConnection=t,this.bandwidth=null,Rs[this.peerId]=this}static formatTotalFn(e){let t=0;for(let n=0;n<e.length;n+=1)t+=e[n];return t/e.length}setAdjustmentInterval(){const{bandwidthAdjuster:e,peerStats:t,room:n}=this.state,{PEER_CONNECTION_STATE:r}=s;if(this.bandwidth)return;const o={audio:{send:[],recv:[]},video:{send:[],recv:[]}};let i=0;const a=setInterval(()=>{this.peerConnection&&this.peerConnection.signalingState!==r.CLOSED&&e&&t[this.peerId]?Di.retrieveStatistics(n.id,this.peerId,Ki.getInitOptions().beSilentOnStatsLogs,!0).then(t=>{if(this.peerConnection&&this.peerConnection.signalingState!==r.CLOSED&&e||clearInterval(a),o.audio.send.push(t.audio.sending.bytes?8*t.audio.sending.bytes:0),o.audio.recv.push(t.audio.receiving.bytes?8*t.audio.receiving.bytes:0),o.video.send.push(t.video.sending.bytes?8*t.video.sending.bytes:0),o.video.recv.push(t.video.receiving.bytes?8*t.video.receiving.bytes:0),i+=1,i===e.interval){i=0;let t=gs.formatTotalFn(o.audio.send),n=gs.formatTotalFn(o.video.send);e.useUploadBwOnly||(t+=gs.formatTotalFn(o.audio.recv),n+=gs.formatTotalFn(o.video.recv),t/=2,n/=2),t=parseInt(t*(e.limitAtPercentage/100)/1e3,10),n=parseInt(n*(e.limitAtPercentage/100)/1e3,10),Di.refreshConnection(this.state,this.peerId,!1,{bandwidth:{audio:t,video:n}})}}).catch(()=>{o.audio.send.push(0),o.audio.recv.push(0),o.video.send.push(0),o.video.recv.push(0)}):clearInterval(a)},1e3);this.bandwidth=o}resetBandwidthAdjusterInstance(e,t=null){const n=Ki.getSkylinkState(e);n.streamsBandwidthSettings.bAS={},Ki.setSkylinkState(n,e),t?delete Rs[t]:Rs={}}}var ms=gs;const Is=e=>{const{ICE_CONNECTION_STATE:t}=s;return[t.COMPLETED,t.CONNECTED].indexOf(e)>-1};var fs={ontrack:(e,t,n,r)=>{const s=Ki.getSkylinkState(n.room.id),{peerConnections:o,room:i,hasMCU:a}=s,d=r.streams[0],{transceiver:c,track:l}=r;let u=t;if(!d)return tn.log.WARN("ontrack stream is null"),null;if(null===c.mid&&tn.log.WARN("Transceiver mid is null",c),!o[u])return null;a&&(u=((e,t)=>{const{peerMedias:n,user:r}=e,s=Object.keys(n);for(let e=0;e<s.length;e+=1)if(s[e]!==r.sid){const r=Object.values(n[s[e]]);for(let n=0;n<r.length;n+=1)if(r[n].transceiverMid===t.mid)return s[e]}return null})(s,c));const E=Os.retrieveScreenMediaInfo(s.room,u,{transceiverMid:c.mid}),S=[u,i,E];return d.onremovetrack=fs.onremovetrack.bind(void 0,...S),Os.updateStreamIdFromOntrack(s.room,u,c.mid,d.id),Di.updatePeerInformationsMediaStatus(s.room,u,c,d),br.addStream(u,d,i.id),Br.onRemoteTrackAdded(d,n,u,E,l.kind===Pt.VIDEO,l.kind===Pt.AUDIO),null},ondatachannel:us,onicecandidate:Es,oniceconnectionstatechange:(e,t,n)=>{const{ROOM_STATE:r,ICE_CONNECTION:o,PEER_CONNECTION:i}=Wt,{ICE_CONNECTION_STATE:a,PEER_CONNECTION_STATE:d,BROWSER_AGENT:c}=s,l=Ki.getSkylinkState(n.room.id),{peerStreams:u,user:E}=l;let S=null;const p=e.iceConnectionState;if(mi(c.REACT_NATIVE)&&!l&&p===a.CLOSED)return;if(!l)return void tn.log.DEBUG([t,"RTCIceConnectionState",null,r.NOT_FOUND]);const{hasMCU:h,bandwidthAdjuster:R,peerStats:g,streamsBandwidthSettings:m}=l;if(p===a.FAILED&&mi(c.FIREFOX)&&!u[E.sid])return;tn.log.DEBUG([t,"RTCIceConnectionState",null,o.STATE_CHANGE],p);const I=new Ss;I.send(n.room.id,e.iceConnectionState,t),qt(Ie({state:p,peerId:t})),S||!Is(p)||g[t]||(S=!0,g[t]={},tn.log.DEBUG([t,"RTCStatsReport",null,"Retrieving first report to tabulate results"]),Di.getConnectionStatus(l,t).then(()=>{S=setInterval(()=>{const r=Ki.getSkylinkState(l.room.id);r&&r.room.inRoom&&(e.connectionState===d.CLOSED||e.iceConnectionState===a.CLOSED?(e.connectionState===d.CLOSED&&(tn.log.DEBUG([t,"RTCPeerConnectionState",null,i.STATE_CHANGE],e.connectionState),qt(_e({state:d.CLOSED,peerId:t}))),e.iceConnectionState===a.CLOSED&&(tn.log.DEBUG([t,"RTCIceConnectionState",null,o.STATE_CHANGE],e.iceConnectionState),I.send(n.room.id,e.iceConnectionState,t),qt(Ie({state:a.CLOSED,peerId:t}))),clearInterval(S)):(new hs).send(l.room.id,e,t))},2e4)})),!h&&Is(p)&&R&&zo(m.bAS)&&new ms({targetMid:t,state:l,peerConnection:e}).setAdjustmentInterval()},onicegatheringstatechange:(e,t,n)=>{const{ICE_CONNECTION:r}=Wt,{iceGatheringState:s}=e;tn.log.INFO([t,"RTCIceGatheringState",null,r.STATE_CHANGE],s),qt(me({state:s,room:wo.getRoomInfo(n.room.id),peerId:t}))},onsignalingstatechange:(e,t)=>{const{PEER_CONNECTION:n}=Wt;tn.log.DEBUG([t,"RTCPeerConnectionSignalingState",null,n.STATE_CHANGE],e.signalingState),qt(_e({state:e.signalingState,peerId:t}))},onremovetrack:(e,t,n,r)=>{const s=ci(t.id),{peerInformations:o}=s,{MEDIA_STREAM:i,PEER_INFORMATIONS:a}=Wt,d=mi(Ft.REACT_NATIVE)?r.stream:r.target;tn.log.INFO([e,yt.MEDIA_STREAM,null,i.REMOTE_TRACK_REMOVED],{peerId:e,isSelf:!1,isScreensharing:n,track:r.track}),o[e]?d?(((e,t,n)=>{const r=e;delete r.peerInformations[t].mediaStatus[n],Ki.setSkylinkState(r,r.room.id)})(s,e,d.id),((e,t,n,r,s)=>{br.dispatchStreamEvent(u,{room:e.room,peerId:t,peerInfo:Uo.getPeerInfo(t,e.room),isSelf:!1,isScreensharing:n,streamId:s.id,isVideo:r.track.kind===Pt.VIDEO,isAudio:r.track.kind===Pt.AUDIO})})(s,e,n,r,d),((e,t)=>{qt(fe({peerId:t,peerInfo:Uo.getPeerInfo(t,e.room),isSelf:!1}))})(s,e)):tn.log.DEBUG([e,yt.MEDIA_STREAM,null,""+i.ERRORS.DROPPING_ONREMOVETRACK-(""+i.NO_STREAM)]):tn.log.DEBUG([e,yt.MEDIA_STREAM,null,""+i.ERRORS.DROPPING_ONREMOVETRACK-`${a.NO_PEER_INFO} ${e}`])},onsenderadded:(e,t,n,r)=>{const s=Ki.getSkylinkState(n.room.id),{sender:o}=r;ls.processNewSender(s,t,o)},onconnectionstatechange:(e,t,n)=>{const{room:r,user:s}=n,{connectionState:o,iceConnectionState:i}=e,{hasMCU:a}=new mn(null,r.id);if((new Ss).send(r.id,o===Ke.FAILED?je.FAILED:i,t),tn.log.DEBUG([t,"RTCPeerConnectionState",null,Wt.PEER_CONNECTION.STATE_CHANGE],e.connectionState),qt(_e({state:o,peerId:t})),e.connectionState===Ke.FAILED&&!a){const e=sn()(wo.getRoomInfo(r.id));wo.leaveRoom(n).then(()=>{qt(((e={})=>new de(ae,{detail:e}))({room:e,peerId:s.sid}))})}}};var Ts={retrieveTransceiverMid:Ir,retrieveMediaState:fr,retrieveMediaId:Tr,buildPeerMediaInfo:Or,retrieveStreamIdOfTrack:Cr,updatePeerMediaInfo:_r,sendMediaInfoMsg:Nr,parseSDPForTransceiverMid:Dr,retrieveValueGivenTransceiverMid:yr,retrieveFormattedMediaInfo:vr,resetPeerMedia:Mr,populatePeerMediaInfo:Pr,processOnRemoveTrack:(e,t,n)=>{if(mi(Ft.REACT_NATIVE)&&n){const{room:r}=e,s={track:{id:null,kind:null}},o={id:null};if(s.track.id=n.trackId,s.track.kind=n.mediaType===vt.AUDIO||n.mediaType===vt.AUDIO_MIC?Pt.AUDIO:Pt.VIDEO,o.id=n.streamId,s.stream=o,!(s.track.id||s.track.kind||o.id))return void tn.log.DEBUG([t,yt.MEDIA_STREAM,null,""+Wt.BROWSER_AGENT.REACT_NATIVE.ERRORS.DROPPING_ONREMOVETRACK],s);fs.onremovetrack(t,r,n.mediaType===vt.VIDEO_SCREEN,s)}}};var Os=class{static updatePeerMediaWithUserSid(e,t){const n=Ki.getSkylinkState(e.id);n.peerMedias[t]=Object.assign({},n.peerMedias.null),delete n.peerMedias.null,Ki.setSkylinkState(n,e.id),Object.keys(n.peerMedias[t]).forEach(n=>{Ts.updatePeerMediaInfo(e,t,!1,n,wt.PUBLISHER_ID,t)})}static updateStreamIdFromOntrack(e,t,n,r){const s=Ki.getSkylinkState(e.id),o=Ts.retrieveValueGivenTransceiverMid(s,t,n,wt.MEDIA_ID);Ts.updatePeerMediaInfo(e,t,!1,o,wt.STREAM_ID,r)}static isVideoScreenTrack(e,t,n){const{peerMedias:r}=e,s=Object.values(r[t]);for(let e=0;e<s.length;e+=1)if(s[e].transceiverMid===n)return s[e].mediaType===vt.VIDEO_SCREEN;return!1}static setMediaStateToUnavailable(e,t,n){Ts.updatePeerMediaInfo(e,t,!1,n,wt.MEDIA_STATE,kt.UNAVAILABLE)}static deleteUnavailableMedia(e,t,n=null){const r=Ki.getSkylinkState(e.id);if(t===Bt.MCU||!r.peerMedias[t])return;let s;if(n)s=sn()(r.peerMedias[t][n]),delete r.peerMedias[t][n];else{const e=r.peerMedias[t];Object.values(e).forEach(e=>{e.mediaState===kt.UNAVAILABLE&&(s=sn()(e),delete r.peerMedias[t][e.mediaId])})}Ki.setSkylinkState(r,e.id),Ts.processOnRemoveTrack(r,t,s),s&&qt(((e={})=>new de(re,{detail:e}))({mediaInfo:s}))}static updatePeerMediaInfo(e,t,n,r,s){Ts.updatePeerMediaInfo(e,t,!0,n,r,s)}static setPeerMediaInfo(e,t,n=[]){try{const r=Ki.getSkylinkState(e.id);if(t!==Bt.MCU||Zo(n)){if(t!==Bt.MCU){const s=sn()(r.peerMedias[t])||{},o=Ts.resetPeerMedia(e,t);n.forEach(e=>{o.peerMedias[e.publisherId]=Ts.populatePeerMediaInfo(o,s,e)}),Ki.setSkylinkState(o,e.id)}}else{const t=[];n.forEach(e=>{-1===t.indexOf(e.publisherId)&&t.push(e.publisherId)}),t.forEach(t=>{const r=n.filter(e=>{if(e.publisherId===t)return e});this.setPeerMediaInfo(e,t,r)})}}catch(e){tn.log.ERROR([t,yt.PEER_MEDIA,null,Wt.MEDIA_INFO.ERRORS.FAILED_SETTING_PEER_MEDIA_INFO])}}static retrieveStreamId(e,t,n,r){const s=Ki.getSkylinkState(e.id),{peerMedias:o}=s,i=o[t][n],a=i.transceiverMid===r?i.streamId:null;return a||tn.log.ERROR([t,yt.PEER_MEDIA,null,Wt.MEDIA_INFO.ERRORS.NO_ASSOCIATED_STREAM_ID]),a}static retrieveMediaId(e,t){return Ts.retrieveMediaId(e,t)}static retrieveMediaInfoForOfferAnswer(e,t){const n=Ki.getSkylinkState(e.id).user.sid;return Ts.parseSDPForTransceiverMid(e,n,t),Ts.retrieveFormattedMediaInfo(e,n)}static processPeerMedia(e,t,n,r,s=!1){const o=Ki.getSkylinkState(e.id).peerMedias[t]||{},i=n.getTracks();let a=null;try{i.forEach(i=>{a=Ts.retrieveMediaId(i.kind,n.id),o[a]=Ts.buildPeerMediaInfo(e,t,i,n.id,i.kind===Pt.AUDIO?vt.AUDIO_MIC:r?vt.VIDEO_SCREEN:vt.VIDEO_CAMERA),Ts.updatePeerMediaInfo(e,t,s,a,null,null,o[a])})}catch(e){tn.log.ERROR([t,yt.MEDIA_INFO,Wt.MEDIA_INFO.ERRORS.FAILED_PROCESSING_PEER_MEDIA],e)}}static retrieveScreenMediaInfo(e,t,n){const r=Ki.getSkylinkState(e.id),{peerMedias:s}=r,o=Object.values(s[t]);for(let e=0;e<o.length;e+=1){if(n.streamId&&o[e].streamId===n.streamId)return o[e].mediaType===vt.VIDEO_SCREEN&&o[e];if(n.transceiverMid&&o[e].transceiverMid===n.transceiverMid)return o[e].mediaType===vt.VIDEO_SCREEN;if(!n)return o[e].mediaType===vt.VIDEO_SCREEN}return tn.log.ERROR([t,yt.PEER_MEDIA,null,Wt.MEDIA_INFO.ERRORS.STREAM_ID_NOT_MATCHED]),!1}};var As=e=>{const{pc_config:{iceServers:t},sid:n,rid:r,tieBreaker:s}=e,o=Ki.getSkylinkState(r),i=new fo;o.room.connection.peerConfig=mr.setIceServers(t),o.room.inRoom=!0,o.user.sid=n,tn.log.INFO([null,yt.SIG_SERVER,null,Wt.PEER_INFORMATIONS.SET_PEER_PRIORITY_WEIGHT+": "],s),o.peerPriorityWeight=s,Os.updatePeerMediaWithUserSid(o.room,n),br.updatePeerStreamWithUserSid(o.room,n),Ki.setSkylinkState(o,r),qt(Te({peerId:o.user.sid,peerInfo:Uo.getCurrentSessionInfo(o.room),isSelf:!0,room:o.room})),((e,t)=>{const n=Ki.getSkylinkState(e.id);n.peerStreams[t]&&Object.values(n.peerStreams[t]).forEach(n=>{br.dispatchStreamEvent(c,{stream:n,peerId:t,room:wo.getRoomInfo(e.id),isSelf:!0,peerInfo:Uo.getCurrentSessionInfo(e),streamId:n.id,isVideo:n.getVideoTracks().length>0,isAudio:n.getAudioTracks().length>0})})})(o.room,n),i.enterRoom(o)};var Cs={enterAndWelcome:e=>{const t=Ki.getSkylinkState(e.rid),n={},{hasMCU:r}=t,{rid:s,mid:o,enableIceRestart:i,enableDataChannel:a,weight:d,agent:c,os:l,temasysPluginVersion:u,SMProtocolVersion:E,DTProtocolVersion:S,version:p,publisherId:h}=e;return n.publisherId=h||null,n.rid=s,n.mid=o,n.agent=c&&ii(c)?c:"other",n.version=(e=>{if(!e||"string"!=typeof e)return 0;if(e.indexOf(".")>-1){const t=e.split(".");if(t.length>2){const e=t[0]||"0";return t.splice(0,1),parseFloat(`${e}.${t.join("0")}`,10)}return parseFloat(e||"0",10)}return parseInt(e||"0",10)})(p),n.SMProtocolVersion=ii(E)?E:dt,n.DTProtocolVersion=ii(S)?S:r||o===Bt.MCU?Le:"0.1.0",n.weight=ri(d)?d:0,n.enableDataChannel=!oi(a)||a,n.enableIceRestart=!!oi(i)&&i,n.os=l&&ii(l)?l:null,n.temasysPluginVersion=u&&ii(u)?u:null,n.userInfo=Cs.parseUserInfo(t,e,n),r&&(n.peersInRoom=e.peersInRoom),sn()(n)},parseUserInfo:(e,t,n)=>{const r=Object.assign({},t.userInfo);return r.config=r.config?r.config:{enableDataChannel:n.enableDataChannel,enableIceRestart:n.enableIceRestart,priorityWeight:n.weight},r.agent=r.agent?r.agent:{name:n.agent,version:n.version,os:n.os,pluginVersion:n.temasysPluginVersion,SMProtocolVersion:n.SMProtocolVersion,DTProtocolVersion:n.DTProtocolVersion},r.settings=r.settings?r.settings:{},r.mediaStatus=r.mediaStatus?r.mediaStatus:{},r}};const _s=(e,t,n)=>{const{room:r}=e;e.peerInformations[t]=Di.buildPeerInformations(n,e),Ki.setSkylinkState(e,r.id)};var Ns=e=>{const{currentRoom:t,targetMid:n,cert:r,userInfo:s,message:o,caller:i}=e;let a=!1;const d=Ki.getSkylinkState(t.id),{hasMCU:c}=d,{peerInformations:l}=d;if(!l[n]&&!c||c&&n===Bt.MCU&&!l.MCU){const e=!!s.screenshare;a=!0,d.peerInformations[n]=Di.buildPeerInformations(o.userInfo,d);const i={agent:s.agent.name,version:s.agent.version,os:s.agent.os};Ki.setSkylinkState(d,t.id),Di.addPeer({currentRoom:t,targetMid:n,peerBrowser:i,cert:r,hasScreenshare:e}),n===Bt.MCU?(tn.log.INFO([n,yt.PEER_CONNECTION,null,Wt.PEER_CONNECTION.MCU]),d.hasMCU=!0,qt(((e={})=>new de(I,{detail:e}))({peerId:n,serverPeerType:Ye.MCU,room:wo.getRoomInfo(t.id)}))):qt(Te({peerId:n,peerInfo:Uo.getPeerInfo(n,t),isSelf:!1,room:wo.getRoomInfo(t.id)}))}if(d.peerMessagesStamps[n]=d.peerMessagesStamps[n]||{userData:0,audioMuted:0,videoMuted:0},i===Ds.WELCOME&&(d.peerMessagesStamps[n].hasWelcome=!1),i===Ds.WELCOME&&c&&Array.isArray(o.peersInRoom)&&o.peersInRoom.length){const e=d.user.sid;for(let n=0;n<o.peersInRoom.length;n+=1){const r=o.peersInRoom[n].mid;if(r!==e){const e=Cs.enterAndWelcome(o.peersInRoom[n]).userInfo;_s(d,r,e),qt(Te({peerId:r,peerInfo:Uo.getPeerInfo(r,t),isSelf:!1,room:wo.getRoomInfo(t.id)}))}}}else c&&n!==d.user.sid&&n!==Bt.MCU&&(_s(d,n,s),qt(Te({peerId:n,peerInfo:Uo.getPeerInfo(n,t),isSelf:!1,room:wo.getRoomInfo(t.id)})));Ki.setSkylinkState(d,t.id),a&&qt(he({peerId:n,state:Qe.WELCOME,error:null,room:wo.getRoomInfo(t.id)}))};const Ds={ENTER:"enterHandler",WELCOME:"welcomeHander"},ys=e=>{const{currentRoom:t,targetMid:n,message:r}=e,s=Ki.getSkylinkState(t.id),{peerConnections:o,hasMCU:i}=s,{STATS_MODULE:a,NEGOTIATION_PROGRESS:d,PEER_CONNECTION:c}=Wt,l=new fo,u=(e=>{let t="welcome";if(e.caller===Ds.WELCOME){const n=Ki.getSkylinkState(e.currentRoom.id),{peerMessagesStamps:r,peerPriorityWeight:s,hasMCU:o}=n;(o||s>e.message.weight)&&(r[e.targetMid].hasWelcome?(t="noop",tn.log.WARN([e.targetMid,yt.PEER_CONNECTION,null,'Discarding extra "welcome" received.'])):(t="offer",n.peerMessagesStamps[e.targetMid].hasWelcome=!0,Ki.setSkylinkState(n,e.currentRoom.id)))}return t})(e);if("offer"===u){if(!o[n])return tn.log.WARN([n,"RTCSessionDescription","offer",c.NO_PEER_CONNECTION]),Vr.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,n,r,!1,c.NO_PEER_CONNECTION),null;const{signalingState:s}=o[n];if(s!==Ke.STABLE)return tn.log.WARN([n,"RTCSessionDescription","offer",d.ERRORS.NOT_STABLE],s),Vr.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,n,r,!1,d.ERRORS.NOT_STABLE),null;l[u](e.currentRoom,e.targetMid)}else i||l[u](e.currentRoom,e.targetMid)},vs=(e,t)=>{const n=Cs.enterAndWelcome(e),{rid:r,mid:s,userInfo:o,publisherId:i}=n,a=Ki.getSkylinkState(r),{hasMCU:d}=a,c=d&&i?i:s;((e,t,n,r)=>{const{room:s}=n;let o="enter";e===Ds.WELCOME&&(o="welcome"),tn.log.INFO([t,yt.PEER_CONNECTION,null,`Peer ${o} received ->`],r),Vr.send(s.id,o,t,r,!0)})(t,c,a,n);const l={currentRoom:a.room,targetMid:c,userInfo:o,message:n,caller:t};Ns(l),ys(l)};var Ms=e=>{vs(e,Ds.ENTER)};const Ps=(e,t,n,r)=>{const{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:s}}=Wt,{peerConnections:o,bufferedLocalOffer:i,room:a}=e,d=o[t],c="offer"===n.type?"OFFER":"ANSWER";Vr.send(a.id,s[c].set,t,n,r),r&&qt(he({state:Qe[c],peerId:t,room:wo.getRoomInfo(a.id)})),r?("offer"===n.type?d.setOffer="remote":d.setAnswer="remote",mr.addIceCandidateFromQueue(t,a)):(i[t]=null,"offer"===n.type?d.setOffer="local":d.setAnswer="local"),Ki.setSkylinkState(e,a.id)},ks=(e,t,n,r,s)=>{const{room:o,user:i}=e,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:a}}=Wt,d="offer"===n.type?"OFFER":"ANSWER";Vr.send(o.id,a[d].set_error,t,n,r,s),qt(he({state:Qe.ERROR,peerId:r?t:i.sid,error:s,room:wo.getRoomInfo(o.id)}))},ws=(e,t,n)=>{const r=Ki.getSkylinkState(e.id),{peerConnections:s}=r,{type:o}=n,i=s[t],{STATS_MODULE:a}=Wt,d="offer"===o?"OFFER":"ANSWER";return i.processingLocalSDP=!0,Vr.send(e.id,a.HANDLE_NEGOTIATION_STATS[d][o],t,n,!1),i.setLocalDescription(n).then(()=>i)},bs=(e,t,n,r)=>{const s=Ki.getSkylinkState(t.id),{peerConnections:o}=s,{NEGOTIATION_PROGRESS:i}=Wt,a=o[n]=e;tn.log.DEBUG([n,yt.SESSION_DESCRIPTION,r.type,i.SET_LOCAL_DESCRIPTION],r),a.processingLocalSDP=!1,Ps(s,n,r,!1)},Ls=(e,t,n,r)=>{const s=Ki.getSkylinkState(e.id),{peerConnections:o}=s,i=o[t],{NEGOTIATION_PROGRESS:a}=Wt;tn.log.ERROR([t,yt.SESSION_DESCRIPTION,n.type,a.FAILED_SET_LOCAL_DESCRIPTION],r),i.processingLocalSDP=!1,i.negotiating=!1,ks(s,t,n,!1,r)},Gs=(e,t,n)=>{const r=Ki.getSkylinkState(e.id),{peerConnections:s}=r,{type:o}=n,{STATS_MODULE:i}=Wt,a=s[t],d="offer"===o?"OFFER":"ANSWER";a.processingRemoteSDP=!0,Vr.send(e.id,i.HANDLE_NEGOTIATION_STATS[d][o],t,n,!0);const c=((e,t,n)=>{const r=t;return r.sdp=Ai.setSDPBitrate(e,r,n),r})(t,n,e.id);return a.setRemoteDescription(c).then(()=>a)},Us=(e,t,n)=>{const r=e;r.peerConnections[t].negotiating=!1,Ki.setSkylinkState(r,t);(new fo).answerAck(e,t,n)},Fs=(e,t,n,r)=>{const s=new fo,{type:o}=r,{NEGOTIATION_PROGRESS:i,DATA_CHANNEL:a}=Wt,d=Ki.getSkylinkState(t.id),{peerConnections:c}=d,l=c[n]=e;return tn.log.DEBUG([n,yt.SESSION_DESCRIPTION,o,i.SET_REMOTE_DESCRIPTION],r),l.processingRemoteSDP=!1,"offer"===o?(Ps(d,n,r,!0),s.answer(d,n)):(d.peerMessagesStamps[n]&&(d.peerMessagesStamps[n].hasRestart=!1),d.dataChannels[n]&&(-1===l.remoteDescription.sdp.indexOf("m=application")||l.remoteDescription.sdp.indexOf("m=application 0")>0)&&(tn.log.WARN([n,yt.PEER_CONNECTION,null,`${a.CLOSING} - ${a.NO_REMOTE_DATA_CHANNEL}`]),Di.closeDataChannel(d,n)),Ps(d,n,r,!0),Us(d,n,!0),!0)},Bs=(e,t,n,r)=>{const s=Ki.getSkylinkState(e.id),{peerConnections:o}=s,i=o[t],{type:a}=n;tn.log.ERROR([t,yt.SESSION_DESCRIPTION,a,Wt.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_DESCRIPTION+" ->"],{error:r,state:i.signalingState,[a]:n}),i.processingRemoteSDP=!1,i.negotiating=!1,ks(s,t,n,!0,r),"answer"===a&&Us(s,t,!1)},Vs=e=>{const{rid:t,mid:n,type:r,sdp:s,mediaInfoList:o}=e,i=Ki.getSkylinkState(t),{hasMCU:a,room:d,bufferedLocalOffer:c}=i,l=n,u="offer"===r?"OFFER":"ANSWER",{NEGOTIATION_PROGRESS:E}=Wt;if(tn.log.INFO([l,null,r,`Received ${r} from peer. ${u}:`],e),((e,t)=>{const{weight:n,type:r,mid:s,sdp:o,resend:i}=t,{peerPriorityWeight:a,bufferedLocalOffer:d,room:c,peerConnections:l}=e,{STATS_MODULE:u,NEGOTIATION_PROGRESS:E,PEER_CONNECTION:S}=Wt,p=s,h=l[p],R="offer"===r?"OFFER":"ANSWER";let g=null;if(!h)return tn.log.ERROR([p,null,r,`${S.NO_PEER_CONNECTION}. Unable to set${"offer"===r?"Remote":"Local"}Offer.`]),g=S.NO_PEER_CONNECTION,Vr.send(c.id,u.HANDLE_NEGOTIATION_STATS[R].dropped,p,t,!0,g),!1;const{processingRemoteSDP:m,processingLocalSDP:I,negotiating:f}=h;if("offer"===r&&l[p].signalingState!==Ke.STABLE&&(tn.log.WARN([p,null,r,E.ERRORS.NOT_STABLE],{signalingState:l[p].signalingState,isRestart:!!i}),g=`Peer connection state is ${l[p].signalingState}.`),"offer"===r&&d[p]&&a>n&&(tn.log.WARN([p,null,r,E.ERRORS.OFFER_TIEBREAKER],{selfWeight:a,messageWeight:n}),g=E.ERRORS.OFFER_TIEBREAKER),m)tn.log.WARN([p,yt.SESSION_DESCRIPTION,r,E.ERRORS.PROCESSING_EXISTING_SDP],o),g=E.ERRORS.PROCESSING_EXISTING_SDP;else if(!I&&!m&&f&&"offer"===r){const n=e;tn.log.DEBUG([p,yt.SESSION_DESCRIPTION,r,E.ERRORS.ADDING_REMOTE_OFFER_TO_BUFFER],t),n.bufferedRemoteOffers[p]=n.bufferedRemoteOffers[p]?n.bufferedRemoteOffers[p]:[],n.bufferedRemoteOffers[p].push(t),Ki.setSkylinkState(n,c.id)}return g&&Vr.send(c.id,u.HANDLE_NEGOTIATION_STATS[R].dropped,p,t,!0,g),!g})(i,e))try{if(((e,t)=>{const n=e,{userInfo:r,rid:s,mid:o}=t,i=r,a=o;r&&"object"==typeof r&&(i.settings.data=!!(n.dataChannels[a]&&n.dataChannels[a].main&&n.dataChannels[a].main.channel&&n.dataChannels[a].main.channel.readyState===Pe.OPEN),n.peerInformations[a].settings=i.settings||{},n.peerInformations[a].mediaStatus=i.mediaStatus||{},n.peerInformations[a].userData=i.userData),n.peerConnections[a].negotiating=!0,Ki.setSkylinkState(n,s)})(i,e),Os.setPeerMediaInfo(d,l,o),Os.deleteUnavailableMedia(d,l),"offer"===r){let e=null;const t={type:r,sdp:a?s.replace(/\r\n/g,"\n").split("\n").join("\r\n"):s};Gs(d,l,t).then(e=>Fs(e,d,l,t)).catch(e=>Bs(d,l,t,e)).then(t=>(e={type:t.type,sdp:t.sdp},ws(d,l,e))).then(t=>bs(t,d,l,e)).catch(t=>Ls(d,l,e,t))}else if(c[l]){const e=c[l],t={type:r,sdp:a?s.replace(/\r\n/g,"\n").split("\n").join("\r\n"):s};ws(d,l,e).then(t=>bs(t,d,l,e)).catch(t=>Ls(d,l,e,t)).then(()=>Gs(d,l,t)).then(e=>Fs(e,d,l,t)).catch(e=>Bs(d,l,t,e))}else tn.log.ERROR([l,yt.PEER_CONNECTION,null,E.ERRORS.NO_LOCAL_BUFFERED_OFFER])}catch(e){tn.log.ERROR([l,yt.SESSION_DESCRIPTION,r,`Failed processing ${u} ->`],e)}return null};var xs=e=>{Vs(e)};var Hs=e=>{Vs(e)};var js=(e,t)=>{const{peerConnections:n,currentRTCRTPSenders:r}=e;return new Promise(e=>{const s=n[t],o=s.getSenders()?s.getSenders():[],i=[],a=r[t]||[];let d=!1;o.forEach(e=>{i.push(e.getStats())});const c={};Promise.all(i).then(t=>{t.forEach((e,t)=>{e.forEach(e=>{e&&e.ssrc&&0!==e.bytesSent?c[e.ssrc]=o[t]:e&&"ssrc"===e.type&&e.id.indexOf("send")>1&&e.values.forEach(e=>{e.ssrc&&(c[e.ssrc]=o[t])})})});const n=Object.keys(c);if(n.length!==a.length)d=!0;else{let e=0;for(let t=0;t<n.length;t+=1){const r=c[n[t]];for(let t=0;t<a.length;t+=1){if(r===a[t]){e+=1;break}}}d=e!==n.length}e(d)})})};var Ws=e=>{const{mid:t,rid:n,success:r}=e,s=Ki.getSkylinkState(n),o=t;qt(he({state:Qe.ANSWER_ACK,peerId:o,room:s.room})),s.peerConnections[o].negotiating=!1,Ki.setSkylinkState(s,n),r?((e,t)=>{if(e.bufferedRemoteOffers[t]&&!Zo(e.bufferedRemoteOffers[t])){const n=e.bufferedRemoteOffers[t].shift();return tn.log.DEBUG([t,"RTCSessionDescription",n.type,Wt.NEGOTIATION_PROGRESS.APPLYING_BUFFERED_REMOTE_OFFER],n),Vs(n),Ki.setSkylinkState(e,e.room.id),!0}return!1})(s,o)||js(s,o).then(e=>{e&&os(s,o).catch(e=>{tn.log.ERROR([t,yt.SESSION_DESCRIPTION,Qe.ANSWER_ACK,Wt.NEGOTIATION_PROGRESS.ERRORS.FAILED_RENEGOTIATION],e)})}):tn.log.ERROR([o,yt.SESSION_DESCRIPTION,Qe.ANSWER,Wt.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_ANSWER])};var Ks=e=>{vs(e,Ds.WELCOME)};var $s=e=>{const{candidate:t,mid:n,rid:r}=e,s=Ki.getSkylinkState(r),{room:o}=s,i=s.peerConnections[n],a=s.peerEndOfCandidatesCounter[n]||{},{RTCIceCandidate:d}=window,{ICE_CANDIDATE:c,PEER_CONNECTION:l,STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:u}}=Wt,E=new Er;if(!t&&!e.id)return tn.log.WARN([n,yt.CANDIDATE_HANDLER,null,c.INVALID_CANDIDATE],e),null;const S=new d({sdpMLineIndex:e.label,candidate:t,sdpMid:e.id}),p="can-"+S.foundation,h=S.candidate.split(" ")[7]||"";tn.log.DEBUG([n,yt.CANDIDATE_HANDLER,`${p}:${h}`,c.VALID_CANDIDATE],S),a.len=a.len||0,a.hasSet=!1,a.len+=1,Ki.setSkylinkState(s,r);const R={candidate:{candidate:S.candidate,sdpMid:S.sdpMid,sdpMLineIndex:S.sdpMLineIndex},error:null};if(qt(ge({room:o,state:He.RECEIVED,peerId:n,candidateId:p,candidateType:h,candidate:R.candidate,error:R.error})),!i||i.signalingState===Ke.CLOSED)return tn.log.WARN([n,yt.CANDIDATE_HANDLER,`${p}:${h}`,l.NO_PEER_CONNECTION]),R.error=new Error(l.NO_PEER_CONNECTION),E.send(o.id,u.PROCESS_FAILED,n,p,R.candidate,R.error),qt(ge({room:o,state:He.DROPPED,peerId:n,candidateId:p,candidateType:h,candidate:R.candidate,error:R.error})),Di.signalingEndOfCandidates(n,s),null;i.remoteDescription&&i.remoteDescription.sdp&&i.localDescription&&i.localDescription.sdp?mr.addIceCandidate(n,p,h,S,s):mr.addIceCandidateToQueue(n,p,h,S,s),Di.signalingEndOfCandidates(n,s);let g=s.gatheredCandidates[n];return g||(g={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),g.receiving[h].push({sdpMid:S.sdpMid,sdpMLineIndex:S.sdpMLineIndex,candidate:S.candidate}),s.gatheredCandidates[n]=g,Ki.setSkylinkState(s,r),null};var Ys=e=>{const{result:t,type:n}=e,r=t;tn.log.INFO(["Server",null,n,"Received list of peers"],r),qt(Ce({state:ze.DISPATCHED,privilegePeerId:null,peerList:r}))};var qs=class extends Tn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,contents:null}}send(e,t){const n=Ki.getSkylinkState(e);this.model.room_id=e,this.model.user_id=n&&n.user&&n.user.sid||null,this.model.client_id=n.clientId,this.model.state=t.type,this.model.contents=t,this.model.app_key=Ki.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.session,this.model)}};var Js=e=>{const t=Ki.getSkylinkState(),{room:n,user:r}=t;tn.log.WARN(["Server",null,e.type,"Introduce failed. Reason: "+e.reason]);(new qs).send(n.id,e),qt(((e={})=>new de(z,{detail:e}))({state:z.ERROR,privilegedPeerId:r.sid,receivingPeerId:e.receivingPeerId,sendingPeerId:e.sendingPeerId,reason:e.reason}))};const Xs=(e,t)=>{Ki.getSkylinkState(e).peerConnections[t]&&((e,t)=>{const n=Ki.getSkylinkState(e);n.peerConnections[t].signalingState!==Ke.CLOSED&&n.peerConnections[t].close()})(e,t)},Qs=(e,t)=>{const n=Ki.getSkylinkState(e);if(!((e,t)=>{const n=e;return!!n&&(!(!n.peerConnections[t]&&!n.peerInformations[t])||(tn.log.DEBUG([t,yt.PEER_CONNECTION,null,`${Wt.ROOM.LEAVE_ROOM.DROPPING_HANGUP} - ${Wt.PEER_CONNECTION.NO_PEER_CONNECTION}`]),!1))})(n,t))return;const{room:r}=n,s=Uo.getPeerInfo(t,r);if(t===Bt.MCU){const e=n;return qt(Ae({peerId:t,serverPeerType:Ye.MCU,room:r})),e.hasMCU=!1,void Ki.setSkylinkState(e,r.id)}qt(Oe({peerId:t,peerInfo:s,isSelf:!1,room:r}))};var zs=e=>{const{mid:t,rid:n,publisherId:r}=e,s=n;let o=t;Ki.getSkylinkState(s).hasMCU&&(o=r),tn.log.INFO([o,yt.PEER_CONNECTION,null,Wt.ROOM.LEAVE_ROOM.PEER_LEFT.START]);try{Qs(s,o),Xs(s,o),((e,t)=>{const n=Ki.getSkylinkState(e);setTimeout(()=>{delete n.peerConnections[t],Ki.setSkylinkState(n,n.room.id),tn.log.INFO([t,yt.PEER_CONNECTION,null,Wt.ROOM.LEAVE_ROOM.PEER_LEFT.SUCCESS])},500),n.bandwidthAdjuster&&!n.hasMCU&&new ms({roomKey:n.room.id,peerId:t}),delete n.peerInformations[t],delete n.peerMedias[t],delete n.peerMessagesStamps[t],delete n.peerEndOfCandidatesCounter[t],delete n.peerCandidatesQueue[t],delete n.peerStats[t],delete n.gatheredCandidates[t],delete n.peerStreams[t]})(s,o),((e,t)=>{const n=Ki.getSkylinkState(e);Di.closeDataChannel(n,t)})(s,o)}catch(e){tn.log.DEBUG([o,yt.ROOM,null,Wt.ROOM.LEAVE_ROOM.PEER_LEFT.ERROR],e)}};var Zs=e=>{const{mid:t,rid:n,status:r,streamId:s,settings:o}=e,i=di(n),{room:a,peerInformations:d}=i;return r===Ot.ENDED&&(o.isScreensharing&&(d[t].screenshare=!1,Ki.setSkylinkState(i,a.id)),qt(ue({room:a,peerId:t,peerInfo:Uo.getPeerInfo(t,a),streamId:s,isSelf:!1,isScreensharing:o.isScreensharing,options:o,isVideo:!!o.audio,isAudio:!!o.video}))),null};var eo=class extends Tn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,recording_id:null,recordings:null,error:null}}send(e,t,n,r,s){const o=Ki.getSkylinkState(e);this.model.client_id=o.clientId,this.model.app_key=Ki.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.state=t,this.model.recording_id=n,this.model.recordings=r,this.error=("string"==typeof s?s:s&&s.message)||null,this.postStats(this.endpoints.recording,this.model)}};const to=new eo,no=(e,t,n)=>{const r={state:e,recordingId:t};n&&(r.error=n),qt(((e={})=>new de($,{detail:e}))(r))};const ro="startSuccess",so="stopSuccess";var oo={dispatchMediaStateChangeEvents:(e,t,n,r,s)=>{const o=Uo.getPeerInfo(n,e.room);qt(Ee({isSelf:!1,peerId:n,peerInfo:o,streamId:t,isAudio:r===Pt.AUDIO,isVideo:r===Pt.VIDEO,isScreensharing:s})),qt(fe({isSelf:!1,peerId:n,peerInfo:o}))}};var io=(e,t)=>{const{type:n,rid:r,mediaId:s,mediaState:o,transceiverMid:i}=t,a=Ki.getSkylinkState(r),{room:d}=a,c=Os.retrieveStreamId(d,e,s,i),l=(new Date).toISOString();if(tn.log.INFO([e,yt.SIG_SERVER,n,Wt.MEDIA_INFO.AUDIO_STATE_CHANGE,o,c],t),a.peerInformations[e]){if(a.peerMessagesStamps[e]){if(l<a.peerMessagesStamps[e].audioMuted)return void tn.log.WARN([e,yt.SIG_SERVER,n,Wt.SIGNALING.OUTDATED_MSG],t);a.peerMessagesStamps[e].audioMuted=l}a.peerInformations[e].mediaStatus[c]||(a.peerInformations[e].mediaStatus[c]={}),a.peerInformations[e].mediaStatus[c].audioMuted=o===kt.MUTED||o===kt.STOPPED?Dt.MUTED:Dt.ACTIVE,Ki.setSkylinkState(a,d.id),oo.dispatchMediaStateChangeEvents(a,c,e,Pt.AUDIO,!1)}else tn.log.WARN([e,yt.PEER_INFORMATION,n,`${Wt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`])};var ao=(e,t)=>{const{type:n,rid:r,mediaId:s,mediaState:o,transceiverMid:i,mediaType:a}=t,d=Ki.getSkylinkState(r),{room:c}=d,l=Os.retrieveStreamId(c,e,s,i),u=(new Date).toISOString();if(tn.log.INFO([e,yt.SIG_SERVER,n,Wt.MEDIA_INFO.VIDEO_STATE_CHANGE,o,l],t),d.peerInformations[e]){if(d.peerMessagesStamps[e]){if(u<d.peerMessagesStamps[e].videoMuted)return void tn.log.WARN([e,yt.SIG_SERVER,n,Wt.SIGNALING.OUTDATED_MSG],t);d.peerMessagesStamps[e].videoMuted=u}d.peerInformations[e].mediaStatus[l]||(d.peerInformations[e].mediaStatus[l]={}),d.peerInformations[e].mediaStatus[l].videoMuted=o===kt.MUTED||o===kt.STOPPED?Dt.MUTED:Dt.ACTIVE,Ki.setSkylinkState(d,c.id),oo.dispatchMediaStateChangeEvents(d,l,e,Pt.VIDEO,a===vt.VIDEO_SCREEN)}else tn.log.WARN([e,yt.PEER_INFORMATION,n,`${Wt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`])};const co=(e,t,n)=>{tn.log.WARN([e,yt.SIG_SERVER,`${Wt.MEDIA_INFO.WARN.READ_ONLY_VALUE} ${n}`],t)},lo=(e,t)=>{const{rid:n,mediaId:r,transceiverMid:s}=t,o=Ki.getSkylinkState(n);Os.updatePeerMediaInfo(o.room,e,r,wt.TRANSCEIVER_MID,s)},uo=(e,t,n,r)=>{if(r.mediaState===kt.UNAVAILABLE)((e,t,n,r)=>{const{mediaId:s}=r;Os.setMediaStateToUnavailable(e,n,s),Os.deleteUnavailableMedia(e,n,s)})(e,0,n,r);else switch(t){case vt.VIDEO_SCREEN:case vt.VIDEO_CAMERA:case vt.VIDEO_OTHER:case vt.VIDEO:ao(n,r);break;case vt.AUDIO_MIC:case vt.AUDIO:io(n,r);break;default:tn.log.ERROR([n,yt.SIG_SERVER,`${Wt.MEDIA_INFO.WARN.INVALID_MEDIA_TYPE} ${t}`],r)}},Eo=(e,t,n,r,s)=>{const o=Ki.getSkylinkState(e),{peerMedias:i}=o,a=i[t][n];return a[r]&&a[r]!==s};var So={userMessageHandler:ir,answer:Hs,answerAck:Ws,inRoom:As,enter:Ms,offer:xs,welcome:Ks,candidate:$s,getPeerList:Ys,introduceError:Js,stream:Zs,bye:zs,recording:e=>{const{action:t,rid:n,recordingId:r,error:s}=e,o=di(n);"on"===t?((e,t)=>{const n=Object.assign({},e),{room:r}=n;tn.log.DEBUG([Bt.MCU,yt.RECORDING,t,Wt.RECORDING.START_SUCCESS]),to.send(r.id,Wt.STATS_MODULE.HANDLE_RECORDING_STATS.START,t,null,null),n.currentRecordingId=t,n.recordings[t]={active:!0,state:pt.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,error:null},n.recordingStartInterval=setTimeout(()=>{tn.log.INFO([Bt.MCU,yt.RECORDING,t,Wt.RECORDING.MIN_RECORDING_TIME_REACHED]),n.recordingStartInterval=null},4e3),Ki.setSkylinkState(n,r.id),no(pt.START,t)})(o,r):"off"===t?((e,t)=>{const n=Object.assign({},e),{room:r,recordings:s}=n;to.send(r.id,Wt.STATS_MODULE.HANDLE_RECORDING_STATS.STOP,t,null,null),s[t]?(n.currentRecordingId=null,n.recordingStartInterval&&(clearTimeout(n.recordingStartInterval),tn.log.WARN([Bt.MCU,yt.RECORDING,t,Wt.RECORDING.ERRORS.STOP_ABRUPT]),n.recordingStartInterval=null),tn.log.DEBUG([Bt.MCU,yt.RECORDING,t,Wt.RECORDING.STOP_SUCCESS]),n.recordings[t].active=!1,n.recordings[t].state=pt.STOP,n.recordings[t].endedDateTime=(new Date).toISOString(),Ki.setSkylinkState(n,r.id),no(pt.STOP,t)):tn.log.ERROR([Bt.MCU,yt.RECORDING,t,Wt.RECORDING.ERRORS.SESSION_EMPTY])})(o,r):"error"===t&&(no(null,r,s),tn.log.ERROR([Bt.MCU,yt.RECORDING,r,Wt.RECORDING.ERRORS.MCU_RECORDING_ERROR],s),to.send(o.room.id,Wt.STATS_MODULE.HANDLE_RECORDING_STATS.MCU_RECORDING_ERROR,r,null,s))},redirect:e=>{var t;tn.log.INFO(["Server",null,e.type,"System action warning:"],e),Object.keys((new wi).getAllStates()).length>1&&e.action===et.REJECT&&ui(),"toClose"===e.reason&&(e.reason="toclose"),Ki.removeSkylinkState(Ki.getSkylinkState(e.rid)),qt((t={action:e.action,info:e.info,reason:e.reason,rid:e.rid},new de(x,{detail:t})))},rtmp:e=>{const{action:t,rid:n}=e,r=di(n);tn.log.DEBUG([Bt.MCU,"RTMP",null,Wt.RTMP.message_received_from_sig]),t===ro?((e,t)=>{const{rtmpSessions:n}=e,{rtmpId:r,peerId:s,streamId:o}=t;if(!n[r]){const t=Object.assign({},e);tn.log.DEBUG([Bt.MCU,"RTMP",Wt.RTMP.started_success]),t.rtmpSessions[r]={active:!0,state:Nt.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,peerId:s,streamId:o},qt(ve({state:Nt.START,rtmpId:r,error:null})),Ki.setSkylinkState(t,t.room.id)}})(r,e):t===so?((e,t)=>{const{rtmpSessions:n}=e,{rtmpId:r}=t,s=Object.assign({},e);n[r]?(tn.log.DEBUG([Bt.MCU,"RTMP",Wt.RTMP.stopped_success]),s.rtmpSessions[r].active=!1,s.rtmpSessions[r].state=Nt.STOP,s.rtmpSessions[r].endedDateTime=(new Date).toISOString(),qt(ve({state:Nt.STOP,rtmpId:r,error:null})),Ki.setSkylinkState(s,s.room.id)):tn.log.DEBUG([Bt.MCU,"RTMP",Wt.RTMP.stop_session_empty])})(r,e):((e,t)=>{const{error:n,rtmpId:r}=t,{rtmpSessions:s}=e,o=new Error(n||"Unkown Error"),i=Object.assign({},e);s[r]?(tn.log.DEBUG([Bt.MCU,"RTMP",Wt.RTMP.error_session]),i.rtmpSessions[r].state=Nt.ERROR,i.rtmpSessions[r].error=o,s[r].active&&(tn.log.DEBUG([Bt.MCU,"RTMP",Wt.RTMP.error_Session_abrupt]),i.rtmpSessions[r].active=!1),qt(ve({state:Nt.ERROR,rtmpId:r,error:o})),Ki.setSkylinkState(i,i.room.id)):tn.log.DEBUG([Bt.MCU,"RTMP",Wt.RTMP.error_session_empty])})(r,e)},setUserData:e=>{const{type:t,mid:n,rid:r,userData:s,stamp:o}=e,i=Ki.getSkylinkState(r),{peerInformations:a,peerMessagesStamps:d}=i,c=n,{PEER_INFORMATIONS:l}=Wt;let u=s.replace(/&quot;/g,'"');try{u=JSON.parse(u)}catch(e){tn.log.INFO([c,null,t,""+l.USER_DATA_NOT_JSON],u)}finally{tn.log.INFO([c,null,t,""+l.UPDATE_USER_DATA],u)}if(a[c]){if(d[c]&&ri(o)){if(o<d[c].userData)return void tn.log.WARN([c,null,t,""+l.OUTDATED_MSG],e);d[c].userData=o}a[c].userData=u||{},qt(fe({peerId:c,peerInfo:Uo.getPeerInfo(c,i.room),isSelf:!1}))}else tn.log.INFO([c,null,t,`${l.NO_PEER_INFO} ${c}`])},mediaInfoEvent:e=>{const{mid:t,rid:n,mediaType:r,mediaId:s,publisherId:o}=e,i=Ki.getSkylinkState(n),{hasMCU:a,room:d}=i,c=a?o:t;try{if(!((e,t)=>{const n=e,{mediaId:r,publisherId:s}=t;return n.peerMedias[s]=n.peerMedias[s]||{},!n.peerMedias[s][r]&&(n.peerMedias[s][r]=t,Ki.setSkylinkState(n,n.room.id),!0)})(i,e)){const t=Object.values(wt);for(let o=0;o<t.length;o+=1)if(Eo(n,c,s,t[o],e[t[o]])){if(Os.updatePeerMediaInfo(i.room,c,s,t[o],e[t[o]]),t[o]===wt.MEDIA_STATE)return void uo(d,r,c,e);if(t[o]===wt.TRANSCEIVER_MID)return void lo(c,e);co(c,e,t[o])}}}catch(e){tn.log.ERROR([c,yt.SIG_SERVER,Wt.MEDIA_INFO.FAILED_PROCESSING_MEDIA_INFO_EVENT],e)}},storedMessages:e=>{sr.processStoredMessages(e)}};var po=class{userMessageHandler(...e){So.userMessageHandler(...e)}answerHandler(...e){So.answer(...e)}answerAckHandler(...e){So.answerAck(...e)}inRoomHandler(...e){So.inRoom(...e)}enterRoomHandler(...e){So.enter(...e)}offerHandler(...e){So.offer(...e)}welcomeHandler(...e){So.welcome(...e)}candidateHandler(...e){So.candidate(...e)}getPeerListHandler(...e){So.getPeerList(...e)}introduceErrorHandler(...e){So.introduceError(...e)}byeHandler(...e){So.bye(...e)}streamHandler(...e){So.stream(...e)}recordingHandler(...e){So.recording(...e)}redirectHandler(...e){So.redirect(...e)}rtmpHandler(...e){So.rtmp(...e)}setUserDataHandler(...e){So.setUserData(...e)}mediaInfoEventHandler(...e){So.mediaInfoEvent(...e)}storedMessagesHandler(...e){So.storedMessages(...e)}};var ho={joinRoom:e=>{const{room:t,user:n}=e,r=Ki.getSkylinkState(t.id),s=Ki.getInitOptions(),o=new mn(null,t.id);return{type:Tt.JOIN_ROOM,uid:r.user.uid,cid:o.key,rid:t.id,userCred:n.token,timeStamp:n.timeStamp,apiOwner:o.appKeyOwner,roomCred:t.token,start:t.startDateTime,len:t.duration,isPrivileged:o.isPrivileged,autoIntroduce:o.autoIntroduce,key:s.appKey}},enterRoom:e=>{const{room:t}=e,n=Ki.getSkylinkState(t.id),r=Ki.getInitOptions(),{user:s,peerPriorityWeight:o,enableIceRestart:i,hasMCU:a}=n,{enableDataChannel:d}=r,{AdapterJS:c,navigator:l}=window,u=Uo.getUserInfo(t),E={type:Tt.ENTER,mid:s.sid,rid:t.id,agent:c.webrtcDetectedBrowser,version:(c.webrtcDetectedVersion||0).toString(),os:l.platform,userInfo:u,weight:o,temasysPluginVersion:null,enableDataChannel:d,enableIceRestart:i,SMProtocolVersion:dt,DTProtocolVersion:Le};return a&&(E.target=Bt.MCU,E.publisherId=s.sid),E},welcome:(e,t)=>{const n=Ki.getSkylinkState(e.id),r=Ki.getInitOptions(),{user:s,peerPriorityWeight:o,enableIceRestart:i,room:a}=n,{enableDataChannel:d}=r,{AdapterJS:c}=window,l=Uo.getUserInfo(a);return{type:Tt.WELCOME,mid:s.sid,rid:a.id,agent:c.webrtcDetectedBrowser,version:(c.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:l,weight:o,temasysPluginVersion:null,enableDataChannel:d,enableIceRestart:i,SMProtocolVersion:dt,DTProtocolVersion:Le,target:t}},offer:(...e)=>Di.createOffer(...e),answer:(...e)=>Di.createAnswer(...e),answerAck:(e,t,n)=>{const{room:r,user:s}=e;return{type:Tt.ANSWER_ACK,rid:r.id,mid:s.sid,target:t,success:n}},candidate:(e,t,n)=>{const r=t.room.id,s=Ki.getSkylinkState(r);return{type:Tt.CANDIDATE,label:n.sdpMLineIndex,id:n.sdpMid,candidate:n.candidate,mid:s.user.sid,target:e,rid:r}},setUserData:e=>({type:Tt.UPDATE_USER,mid:e.user.sid,rid:e.room.id,userData:ii(e.user.userData)?e.user.userData:JSON.stringify(e.user.userData),stamp:(new Date).getTime()}),getPeerList:e=>({type:Tt.GET_PEERS,showAll:e}),restartOffer:(e,t,n)=>{const r=Ki.getSkylinkState(e),{AdapterJS:s}=window,o=Ki.getInitOptions(),{user:i,room:a,enableIceRestart:d,peerInformations:c,peerPriorityWeight:l}=r;return{type:Tt.RESTART,mid:i.sid,rid:a.id,agent:s.webrtcDetectedBrowser,version:(s.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:Uo.getUserInfo(a),target:t,weight:l,enableDataChannel:o.enableDataChannel,enableIceRestart:d,doIceRestart:!0===n&&d&&c[t]&&c[t].config.enableIceRestart,isRestartResend:!1,temasysPluginVersion:null,SMProtocolVersion:dt,DTProtocolVersion:Le}},stream:(e,t,n,r,s)=>({type:Tt.STREAM,mid:t.sid,rid:e,status:r,streamId:n.id,settings:s}),recording:(e,t)=>({type:t,rid:e,target:Bt.MCU}),rtmp:(e,t,n,r,s=null,o=null)=>{const i={type:e,rid:t,rtmpId:r,streamId:s,endpoint:o,mid:n,target:Bt.MCU};return e===Tt.STOP_RTMP&&(delete i.endpoint,delete i.streamId),i},bye:(e,t)=>{const{room:n,user:r,hasMCU:s}=e,o={type:Tt.BYE,rid:n.id,mid:r.sid,target:t};return s&&(o.publisherId=r.sid),o},roomLock:e=>{const{user:t,room:n}=e;return{type:Tt.ROOM_LOCK,mid:t.sid,rid:n.id,lock:n.isLocked}},mediaInfoEvent:(e,t,n)=>({type:Tt.MEDIA_INFO_EVENT,rid:e.room.id,mid:n.publisherId,target:t,publisherId:n.publisherId,mediaId:n.mediaId,mediaType:n.mediaType,mediaState:n.mediaState,transceiverMid:n.transceiverMid}),getStoredMessages:e=>{const{user:t,room:n}=e;return{mid:t.sid,rid:n.id,target:t.sid,type:Tt.GET_STORED_MESSAGES}},userMessages:(e,t,n)=>{const r=[],{user:s,room:o}=e,{listOfPeers:i,isPrivate:a,isPersistent:d,secretId:c}=t,l={data:n,mid:s.sid,rid:o.id,msgId:Ei(),type:Tt.MESSAGE};if(c&&(l.secretId=c),a)for(let e=0;e<i.length;e+=1){const t=i[e],s=Object.assign({},l);s.target=t,r.push(s),tn.log.DEBUG([t,yt.MESSAGING,null,Wt.MESSAGING.PRIVATE_MESSAGE],{message:n})}else d&&(l.isPersistent=d),r.push(l),tn.log.DEBUG([null,yt.MESSAGING,null,Wt.MESSAGING.BROADCAST_MESSAGE],{message:n});return r}};var Ro=class{constructor(){this.messageBuilders=ho}getJoinRoomMessage(...e){return this.messageBuilders.joinRoom(...e)}getWelcomeMessage(...e){return this.messageBuilders.welcome(...e)}getEnterRoomMessage(...e){return this.messageBuilders.enterRoom(...e)}getAnswerMessage(...e){return this.messageBuilders.answer(...e)}getAnswerAckMessage(...e){return this.messageBuilders.answerAck(...e)}getOfferMessage(...e){return this.messageBuilders.offer(...e)}getCandidateMessage(...e){return this.messageBuilders.candidate(...e)}getSetUserDataMessage(e){return this.messageBuilders.setUserData(e)}getPeerListMessage(...e){return this.messageBuilders.getPeerList(...e)}getRestartOfferMessage(...e){return this.messageBuilders.restartOffer(...e)}getStreamMessage(...e){return this.messageBuilders.stream(...e)}getRecordingMessage(...e){return this.messageBuilders.recording(...e)}getPeerMessagesForSignaling(...e){return this.messageBuilders.signalingMessages(...e)}getRTMPMessage(...e){return this.messageBuilders.rtmp(...e)}getByeMessage(...e){return this.messageBuilders.bye(...e)}getRoomLockMessage(...e){return this.messageBuilders.roomLock(...e)}getMediaInfoEventMessage(...e){return this.messageBuilders.mediaInfoEvent(...e)}getGetStoredMessagesMessage(...e){return this.messageBuilders.getStoredMessages(...e)}getUserMessages(...e){return this.messageBuilders.userMessages(...e)}};const go="Polling",mo="WebSocket";let Io=null;var fo=class{constructor(){return Io||(Io=this),this.socket=null,this.attempts=0,this.timestamp=(new Date).valueOf(),this.messageHandler=new po,this.messageBuilder=new Ro,this.config=null,Io}resetSocketConfig(e){return{protocol:e,socketType:window.WebSocket?mo:go,signalingServerProtocol:e,socketSession:{finalAttempts:0,attempts:0},fallbackType:null,signalingServerPort:null,socketTimeout:!1}}createSocket(e){const t=Ki.getSkylinkState(e);return t.socketSession=this.resetSocketConfig(t.signalingServerProtocol),Ki.setSkylinkState(t,e),new Promise((t,n)=>{try{null!==this.socket&&this.socket instanceof window.io.Socket&&this.socket.connected?t():this.tryCreateSocket(e,t,n)}catch(r){this.handleCreateSocketFailure(e,t,n,r)}})}tryCreateSocket(e,t,n){const r=Ki.getSkylinkState(e),{socketSession:s}=r;this.socket=Mn({config:s,roomKey:e}),((...e)=>{Gn(...e)})(e,this,t,n)}handleCreateSocketFailure(e,t,n,r){const s=Ki.getSkylinkState(e),{socketSession:o}=s;tn.log.ERROR(Wt.INIT.SOCKET_CREATE_FAILED,r),qt(De({session:sn()(o),errorCode:it.CONNECTION_FAILED,type:o.fallbackType,error:r})),n(r)}dispatchHandshakeProgress(e,t){qt(he({peerId:e.user.sid,state:Qe[t],error:null,room:wo.getRoomInfo(e.room.id)}))}answer(...e){return this.messageBuilder.getAnswerMessage(...e).then(t=>{const n=e[0];return this.sendMessage(t),this.dispatchHandshakeProgress(n,"ANSWER"),t})}answerAck(...e){const t=this.messageBuilder.getAnswerAckMessage(...e),n=e[0];this.sendMessage(t),this.dispatchHandshakeProgress(n,"ANSWER_ACK")}enterRoom(...e){const t=this.messageBuilder.getEnterRoomMessage(...e);this.sendMessage(t),this.dispatchHandshakeProgress(...e,"ENTER")}joinRoom(...e){const t=this.messageBuilder.getJoinRoomMessage(...e);this.sendMessage(t)}offer(...e){const t=e[0],n=e[1],r=Ki.getSkylinkState(t.id);r.peerConnections[n].negotiating?tn.log.DEBUG([n,yt.SIG_SERVER,null,""+Wt.SIGNALING.ABORTING_OFFER]):this.messageBuilder.getOfferMessage(...e).then(e=>{this.sendMessage(e),this.dispatchHandshakeProgress(r,"OFFER")})}welcome(...e){const t=this.messageBuilder.getWelcomeMessage(...e);this.sendMessage(t)}noop(){return null}sendCandidate(...e){const t=this.messageBuilder.getCandidateMessage(...e);t&&this.sendMessage(t)}setUserData(e){const t=this.messageBuilder.getSetUserDataMessage(e);t&&this.sendMessage(t)}getPeerList(e){const t=this.messageBuilder.getPeerListMessage(e);t&&this.sendMessage(t)}stream(...e){const t=this.messageBuilder.getStreamMessage(...e);t&&this.sendMessage(t)}recording(...e){const t=this.messageBuilder.getRecordingMessage(...e);this.sendMessage(t)}rtmp(...e){const t=this.messageBuilder.getRTMPMessage(...e);this.sendMessage(t)}roomLock(e){const t=this.messageBuilder.getRoomLockMessage(e);t&&this.sendMessage(t)}bye(...e){const t=this.messageBuilder.getByeMessage(...e);this.sendMessage(t)}mediaInfoEvent(e,t,n){const r=this.messageBuilder.getMediaInfoEventMessage(e,t,n);r&&this.sendMessage(r)}getStoredMessages(e){const t=this.messageBuilder.getGetStoredMessagesMessage(e);t&&this.sendMessage(t)}onMessage(e){const t=Ki.getSkylinkState(JSON.parse(e).rid);if(!t)return;const{socketSession:n}=t;var r;qt((r={message:e,socketSession:sn()(n)},new de(U,{detail:r}))),((...e)=>{Pn(...e)})(this.messageHandler,JSON.parse(e))}sendMessage(e){((...e)=>Bn(...e))(e)||(tn.log.INFO(["SIG SERVER",null,e.type,"sent"]),((e,t)=>{e.send(JSON.stringify(t))})(this.socket,e))}sendUserMessage(e,t,n){const r=this.messageBuilder.getUserMessages(e,t,n);Array.isArray(r)&&r.length&&r.map(e=>(this.sendMessage(e),null))}updateAttempts(e,t,n){this.attempts=n;const r=Ki.getSkylinkState(e),{socketSession:s}=r;s.socketSession[t]=n,Ki.setSkylinkState(r,e)}getAttempts(){return this.attempts}};const To=e=>new Promise(t=>{const n=Ki.getSkylinkState(e.room.id),{room:r,peerConnections:o}=n,{ROOM:{LEAVE_ROOM:i}}=Wt,a=new fo,d=Object.keys(Ki.getSkylinkState()).length>1;if(r.inRoom=!1,Ki.setSkylinkState(n,r.id),d)tn.log.INFO([r.roomName,null,null,i.SENDING_BYE]),Object.keys(o).forEach(e=>{a.bye(n,e)}),t(n);else{a.config=a.resetSocketConfig(window.location.protocol);const e=()=>{tn.log.INFO([r.roomName,null,null,i.DISCONNECT_SOCKET.SUCCESS]),Yt(s.EVENTS.CHANNEL_CLOSE,e),t(n)};$t(s.EVENTS.CHANNEL_CLOSE,e),a.socket.connected?a.socket.disconnect():t(n)}}),Oo=e=>{const{room:t,peerStreams:n,user:r}=e;n[r.sid]&&Ur.prepStopStreams(t.id,null,!0),new Pi(e).stop(!0)},Ao=e=>{Ki.clearRoomStateFromSingletons(e),Ki.removeSkylinkState(e)},Co=e=>{const t=Ki.getSkylinkState(e);t.bandwidthAdjuster&&!t.hasMCU&&new ms({roomKey:e})},_o=e=>new Promise((t,n)=>{const{peerConnections:r,peerInformations:o,room:i,hasMCU:a,user:d}=e,{ROOM:{LEAVE_ROOM:c}}=Wt;try{const n=a?r.MCU?[Bt.MCU]:[]:Array.from(new Set([...Object.keys(r),...Object.keys(o)]));if(Zo(n))tn.log.DEBUG([i.roomName,null,null,c.NO_PEERS]),Oo(e),To(e).then(e=>{tn.log.INFO([i.roomName,null,null,c.REMOVE_STATE.SUCCESS]),qt(Oe({peerId:d.sid,peerInfo:Uo.getCurrentSessionInfo(i),isSelf:!0,room:wo.getRoomInfo(i.id)})),Co(e.room.id),Ao(e.room.id),t(e.room.roomName)});else{const r=[];n.forEach(t=>{r.push(((e,t)=>new Promise(n=>{const{room:r,peerConnections:o}=e,{ROOM:{LEAVE_ROOM:i}}=Wt,{enableDataChannel:a}=Ki.getInitOptions();tn.log.INFO([t,r.roomName,null,i.PEER_LEFT.START]),t===Bt.MCU?qt(Ae({peerId:t,serverPeerType:Ye.MCU,room:wo.getRoomInfo(r.id)})):qt(Oe({peerId:t,peerInfo:Uo.getCurrentSessionInfo(r),isSelf:!1,room:wo.getRoomInfo(r.id)})),o[t]&&o[t].signalingState!==Ke.CLOSED&&Di.closePeerConnection(e,t),a?($t(s.EVENTS.DATA_CHANNEL_STATE,e=>{const{detail:t}=e;t.state!==Pe.CLOSED&&t.state!==Pe.CLOSING||(tn.log.INFO([t.peerId,r.roomName,null,i.PEER_LEFT.SUCCESS]),n(t.peerId))}),Di.closeDataChannel(e,t)):n(t)}))(e,t))}),Promise.all(r).then(()=>(Oo(e),To(e))).then(e=>{tn.log.INFO([i.roomName,null,null,c.REMOVE_STATE.SUCCESS]),qt(Oe({peerId:d.sid,peerInfo:Uo.getCurrentSessionInfo(i),isSelf:!0,room:wo.getRoomInfo(i.id)})),Co(e.room.id),Ao(e.room.id),t(e.room.roomName)})}}catch(e){tn.log.ERROR([i.roomName,null,null,c.ERROR],e),n(e)}}),No=(e=[],t=[])=>new Promise((n,r)=>{const{ROOM:{LEAVE_ROOM:s}}=Wt;try{const r=Ki.getSkylinkState(),o=Object.values(r);o[0]?_o(o[0]).then(r=>{e.push(r),t.push(n),No(e,t)}):(tn.log.INFO([e,"Room",null,s.LEAVE_ALL_ROOMS.SUCCESS]),t.forEach(t=>t(e)))}catch(e){tn.log.ERROR([null,"Room",null,s.LEAVE_ALL_ROOMS.ERROR],e),r(e)}});var Do=class extends Tn{constructor(){super();const{AdapterJS:e,navigator:t}=window;this.model={client_id:null,app_key:null,timestamp:null,username:null,sdk_name:Lt.WEB,sdk_version:null,agent_name:e.webrtcDetectedBrowser,agent_version:e.webrtcDetectedVersion,agent_platform:t.platform,agent_plugin_version:null,device_version:null,enumerated_devices:null,device_muted:null,network_type:t.connection?t.connection.type:"-",language:t.language}}send(e){const t=Ki.getSkylinkState(e);this.model.username=t.user&&t.user.uid||null,this.model.sdk_version=t.VERSION,this.model.client_id=t.clientId,this.model.app_key=Ki.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.client,this.model)}};var yo=class{constructor(e){this.apiResponse={},this.dataChannels={},this.peerCandidatesQueue={},this.peerEndOfCandidatesCounter={},this.gatheredCandidates={},this.retryCounters={},this.peerConnections={},this.peerStats={},this.peerInformations={},this.user=e.user,this.peerPriorityWeight=0,this.isPrivileged=e.isPrivileged,this.socketSession={},this.socketMessageQueue=[],this.channelOpen=!1,this.socketServer=e.socketServer,this.signalingServerProtocol=e.forceSSL?"https:":window.location.protocol,this.enableIceRestart=!1,this.hasMCU=e.hasMCU,this.room=e.room,this.peerMessagesStamps={},this.streamsMutedSettings={},this.streamsBandwidthSettings={bAS:{}},this.recordings={},this.currentRecordingId=!1,this.recordingStartInterval=null,this.currentCodecSupport=null,this.voiceActivityDetection=!0,this.bandwidthAdjuster=null,this.rtmpSessions={},this.bufferedLocalOffer={},this.bufferedRemoteOffers={},this.currentRTCRTPSenders={},this.clientId=e.clientId,this.streamsMediaStatus={},this.peerMedias={},this.hasPersistentMessage=e.hasPersistentMessage,this.peerStreams={},this.streamsSettings={}}};const vo=(e,t)=>{const n=new vn,r=new mn(e),s=n.enforceUserInitOptions(r),o=new yo(s);return o.user.userData=t.userData,o.apiResponse=Object.freeze((e=>{const t=sn()(e);return delete t.room,delete t.user,t})(r)),Ki.setSkylinkState(o,e.roomName),o};var Mo=(e={},t)=>new Promise((n,r)=>{const{navigator:s}=window,o=new vn,i=new fo,a=Ki.getInitOptions(),d=new Do,c=vn.getRoomNameFromParams(e)?vn.getRoomNameFromParams(e):a.defaultRoom;qt(Re({readyState:nt.LOADING,error:null,room:{roomName:c}})),o.createRoom(c).then(a=>{const{response:l}=a;l.roomName=c;const u=vo(l,e);o.checkCodecSupport(u.room.id).then(()=>(d.send(u.room.id),i.createSocket(l.room_key).then(()=>{const o=vn.getStateByKey(l.room_key),a=Object.assign({},e);a.room=o,t||e.id&&e.active?Br.usePrefetchedStream(l.room_key,t,e).then(()=>{i.joinRoom(o),n(null)}).catch(e=>{r(e)}):e.audio||e.video?Br.getUserMedia(u,a).then(e=>{i.joinRoom(o),n(e)}).catch(e=>{r(e)}):(mi(Ft.SAFARI)?s.mediaDevices.getUserMedia({audio:!0}).then(()=>i.joinRoom(o)):i.joinRoom(o),n(null))}))).catch(e=>{r(e)})}).catch(e=>{r(e)})});const Po=(e,t=!0)=>{const n=e,{room:r,user:s}=n,o=new fo;n.room.isLocked=t,Ki.setSkylinkState(n,r.id),o.roomLock(n),qt(((e={})=>new de(Q,{detail:e}))({isLocked:n.room.isLocked,peerInfo:Uo.getCurrentSessionInfo(r),peerId:s.sid,isSelf:!0}))};var ko=e=>{const t=Ki.getSkylinkState(e),{room:n}=t,r=Object.assign({},n);return delete r.connection,delete r.token,delete r.startDateTime,r};var wo=class{static leaveRoom(e){return _o(e)}static leaveAllRooms(){return No()}static lockRoom(e){return(e=>Po(e,!0))(e)}static unlockRoom(e){return(e=>Po(e,!1))(e)}static joinRoom(e){return Mo(e)}static getRoomInfo(e){return ko(e)}};const bo=e=>!zo(e);const Lo=(e,t)=>{const n=e.hasMCU?Bt.MCU:t;let r={};if(e.peerConnections[n].connectionState!==Ke.CLOSED){const n=Uo.getPeerInfo(t,e.room);r=sn()(n.settings)}else tn.log.WARN([t,yt.PEER_CONNECTION,null,Wt.PEER_CONNECTION.NO_PEER_CONNECTION]);return r};var Go={getPeerInfo:un,getCurrentSessionInfo:e=>{const t=Ki.getSkylinkState(e.id),n=Ki.getInitOptions(),{AdapterJS:r,navigator:s}=window,{enableDataChannel:o}=n,{streamsMediaStatus:i,peerPriorityWeight:a,enableIceRestart:d,peerStreams:c,streamsBandwidthSettings:l,streamsSettings:u,user:E}=t,S={userData:"",settings:{audio:!1,video:!1},mediaStatus:{},agent:{name:r.webrtcDetectedBrowser,version:r.webrtcDetectedVersion,os:s.platform,pluginVersion:null,SMProtocolVersion:dt,DTProtocolVersion:Le,SDKVersion:bt},room:wo.getRoomInfo(e.id),config:{enableDataChannel:o,enableIceRestart:d,priorityWeight:a},sid:E.sid};if(c[E.sid]){Object.keys(c[E.sid]).forEach(e=>{u[e].settings.audio?(S.settings.audio={},S.settings.audio[e]=sn()(u[e].settings.audio)):u[e].settings.video&&(S.settings.video={},S.settings.video[e]=sn()(u[e].settings.video))})}return S.mediaStatus=i,S.userData=E.userData||null,S.settings.maxBandwidth=sn()(l.bAS),S.settings.data=o,sn()(S)},getUserInfo:Zn,getUserData:(e,t)=>{if(t&&e.peerInformations[t]){let n=e.peerInformations[t].userData;return n||(n=""),n}return e.user.userData},setUserData:(e,t)=>{const n=Ki.getSkylinkState(e.id),{PEER_INFORMATIONS:{UPDATE_USER_DATA:r}}=Wt,s=t||"";n.user.userData=s,Ki.setSkylinkState(n,n.room.id),(new fo).setUserData(n),qt(fe({peerId:n.user.sid,peerInfo:Go.getCurrentSessionInfo(e),isSelf:!0})),tn.log.INFO(r,s)},getPeersDataChannels:e=>{const{dataChannels:t}=e,n={},r=Object.keys(t);for(let e=0;e<r.length;e+=1){const o=r[e];if(n[o]={},bo(t)){const e=Object.keys(t[o]);for(let r=0;r<e.length;r+=1){const i=t[o][e[r]],{channelName:a,channelType:d,transferId:c,streamId:l}=i;let u=null;u=Di.getDataChannelBuffer(i),u.channelProp=e[r],u.channelName=a,u.channelType=d,u.currentTransferId=c,u.currentStreamId=l,u.readyState=i.channel?i.channel.readyState:s.DATA_CHANNEL_STATE.CREATE_ERROR,n[o][a]=u}}}return n},getPeersCustomSettings:e=>{const{peerInformations:t}=e,n={};if((e=>!zo(e))(t)){const r=Object.keys(t);for(let t=0;t<r.length;t+=1)r[t]!==Bt.MCU&&(n[r[t]]=Lo(e,r[t]));return n}return n}};var Uo=class{static getPeerInfo(e,t){return Go.getPeerInfo(e,t)}static getCurrentSessionInfo(e){return Go.getCurrentSessionInfo(e)}static getUserInfo(e){return Go.getUserInfo(e)}static getUserData(e,t){return Go.getUserData(e,t)}static setUserData(e,t){Go.setUserData(e,t)}static getPeersStreams(e,t){return Go.getPeersStreams(e,t)}static getPeersDataChannels(e){return Go.getPeersDataChannels(e)}static getPeersCustomSettings(e){return Go.getPeersCustomSettings(e)}};const Fo=(e,t,n,r,s=!1)=>{const o=Ki.getSkylinkState(r);return(gi(n)&&e||Ri(n)&&t)&&qt(((e={})=>new de(Y,{detail:e}))({streamId:n.id,isScreensharing:s,mediaStatus:o.streamsMediaStatus[n.id]})),!0},Bo=(e,t,n,r)=>{const s=Ki.getSkylinkState(n.id),o=r,{streamsMutedSettings:i}=s;if(e){const e=Os.retrieveMediaId(Pt.VIDEO,o);Os.updatePeerMediaInfo(n,s.user.sid,e,wt.MEDIA_STATE,i[o].videoMuted?kt.MUTED:kt.ACTIVE)}if(t){const t=Os.retrieveMediaId(Pt.AUDIO,o);setTimeout(()=>Os.updatePeerMediaInfo(n,s.user.sid,t,wt.MEDIA_STATE,i[o].audioMuted?kt.MUTED:kt.ACTIVE),e?1050:0)}},Vo=(e,t,n)=>{const{peerStreams:r,streamsMutedSettings:s,user:o}=e;let i=!1,a=!1;return r[o.sid]&&r[o.sid][n]&&(Ri(r[o.sid][n])&&s[n].audioMuted!==t.audioMuted&&(i=!0),gi(r[o.sid][n])&&s[n].videoMuted!==t.videoMuted&&(a=!0)),{hasToggledAudio:i,hasToggledVideo:a}},xo=(e,t,n)=>{const r=Ki.getSkylinkState(e),{room:s,peerConnections:o,peerInformations:i,peerStreams:a,user:d}=r,c=Vo(r,n,t),{hasToggledAudio:l,hasToggledVideo:u}=c;let E=null;a[d.sid]&&a[d.sid][t]&&(E=a[d.sid][t]);const S=!!Os.retrieveScreenMediaInfo(s,d.sid,{streamId:t});if(E)if(((e,t,n)=>{const r=e,{room:s}=r;t.hasToggledAudio&&(r.streamsMutedSettings[n].audioMuted=!r.streamsMutedSettings[n].audioMuted),t.hasToggledVideo&&(r.streamsMutedSettings[n].videoMuted=!r.streamsMutedSettings[n].videoMuted),tn.log.DEBUG(Wt.MEDIA_STREAM.UPDATE_MUTED_SETTINGS,r.streamsMutedSettings,n),Ki.setSkylinkState(r,s.id)})(r,c,t),((e,t)=>{const n=t,{room:r}=n,s=(e=>e.getAudioTracks())(e),o=(e=>e.getVideoTracks())(e);n.streamsMediaStatus[e.id].audioMuted=Dt.UNAVAILABLE,n.streamsMediaStatus[e.id].videoMuted=Dt.UNAVAILABLE,s.forEach(t=>{t.enabled=!n.streamsMutedSettings[e.id].audioMuted,n.streamsMediaStatus[e.id].audioMuted=n.streamsMutedSettings[e.id].audioMuted?Dt.MUTED:Dt.ACTIVE}),o.forEach(t=>{t.enabled=!n.streamsMutedSettings[e.id].videoMuted,n.streamsMediaStatus[e.id].videoMuted=n.streamsMutedSettings[e.id].videoMuted?Dt.MUTED:Dt.ACTIVE}),Ki.setSkylinkState(n,r.id),tn.log.DEBUG(Wt.MEDIA_STREAM.UPDATE_MEDIA_STATUS,n.streamsMediaStatus,e.id)})(E,r),Fo(u,l,E,s.id,S),(e=>{const t=Ki.getSkylinkState(e.id).user.sid,n=Uo.getCurrentSessionInfo(e);qt(fe({isSelf:!0,peerId:t,peerInfo:n}))})(s),((e,t,n)=>{const r=Ki.getSkylinkState(e.id);br.dispatchStreamEvent(w,{isSelf:!0,peerId:r.user.sid,peerInfo:Uo.getUserInfo(e),streamId:t.id,isScreensharing:n,isAudio:Ri(t),isVideo:gi(t)})})(s,E,S),!o[Bt.MCU]&&Zo(Object.keys(o))||o[Bt.MCU]&&Zo(Object.keys(i))){const e=n=>{const{state:r}=n.detail;r===Qe.ANSWER_ACK&&(Bo(u,l,s,t),Yt(jt.HANDSHAKE_PROGRESS,e))};$t(jt.HANDSHAKE_PROGRESS,e)}else setTimeout(()=>{Bo(u,l,s,t)},500)},Ho=e=>{switch(e){case 1:return!1;case 0:default:return!0}};var jo=(e,t,n=null)=>{const{peerStreams:r,room:s,user:o}=e;if(!ti(t))return void tn.log.ERROR(Wt.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);if(!r[o.sid])return void tn.log.WARN(Wt.MEDIA_STREAM.ERRORS.NO_STREAM);if(n&&!r[o.sid][n])return void tn.log.ERROR(Wt.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);const i={audioMuted:oi(t.audioMuted)?t.audioMuted:!ri(t.audioMuted)||Ho(t.audioMuted),videoMuted:oi(t.videoMuted)?t.videoMuted:!ri(t.videoMuted)||Ho(t.videoMuted)},a=Object.keys(r[o.sid])||[];if(Zo(a))return void tn.log.ERROR(Wt.MEDIA_STREAM.ERRORS.NO_STREAMS_MUTED,t);Object.values(a).filter(t=>Vo(e,i,t).hasToggledAudio||Vo(e,i,t).hasToggledVideo).forEach((e,t)=>{setTimeout(()=>xo(s.id,e,i),0===t?0:1050)})};const Wo=(e,t)=>{for(let n=0;n<t.length;n+=1)if(e.id===t[n].id)return!0;return!1},Ko=(e,t)=>{const n=e.getTransceivers?e.getTransceivers():[],r=t.getTracks();if(Zo(n))return!1;for(let e=0;e<n.length;e+=1)if(n[e].sender.track&&Wo(n[e].sender.track,r))return!0;return!1},$o=(e,t,n,r)=>{const s=e,o=n.getTracks();for(let e=0;e<o.length;e+=1){const i=r.addTrack(o[e],n);i&&ls.processNewSender(s,t,i)}Ki.setSkylinkState(s,s.room.id)};const Yo=(e,t,n)=>{const{user:r,room:s}=e,o=r.sid,i=Uo.getCurrentSessionInfo(s);n&&br.dispatchStreamEvent(c,{room:wo.getRoomInfo(s.id),stream:t,streamId:t.id,isSelf:!0,peerId:o,peerInfo:i,isScreensharing:!1,isVideo:gi(t),isAudio:Ri(t)}),qt(fe({isSelf:!0,peerId:o,peerInfo:i}))},qo=(e,t,n,r,s)=>{const{peerConnections:o,hasMCU:i}=e;try{if(((e,t,n)=>{for(let r=0;r<t.length;r+=1)if(t[r])if(Array.isArray(t[r]))for(let s=0;s<t[r].length;s+=1)t[r][s]&&Yo(e,t[r][s],n);else Yo(e,t[r],n)})(e,t,n),Object.keys(o).length>0||i){Di.refreshPeerConnection(Object.keys(o),e,!1,{}).then(()=>{r(t)}).catch(e=>{tn.log.ERROR(Wt.PEER_CONNECTION.REFRESH_CONNECTION.FAILED),s(e)})}else tn.log.WARN(Wt.ROOM.ERRORS.NO_PEERS),r(t)}catch(e){tn.log.ERROR(e)}};const Jo=e=>{const t={audio:{input:[],output:[]},video:{input:[]}};return e.forEach(e=>{const n={deviceId:e.deviceId||e.sourceId||"default",label:e.label,groupId:e.groupId||null};n.label=n.label||"Source for "+n.deviceId,["audio","audioinput"].indexOf(e.kind)>-1?t.audio.input.push(n):["video","videoinput"].indexOf(e.kind)>-1?t.video.input.push(n):"audiooutput"===e.kind&&t.audio.output.push(n)}),t};const Xo=(e,t,n)=>{const r={streams:{video:null,audio:null,screenShare:null}};return Object.keys(n[t]).forEach(s=>{Ri(n[t][s])?(r.streams.audio=r.streams.audio||{},r.streams.audio[s]=n[t][s]):gi(n[t][s])&&Os.retrieveScreenMediaInfo(e.room,t,{streamId:s})?(r.streams.screenShare=r.streams.screenShare||{},r.streams.screenShare[s]=n[t][s]):(r.streams.video=r.streams.video||{},r.streams.video[s]=n[t][s])}),r};var Qo={parseMediaOptions:nn,parseStreamSettings:ln,prepMediaAccessRequest:e=>new Promise((t,n)=>{const{roomKey:r,...s}=e,o=Qo.parseStreamSettings(s,Pt.AUDIO),i=Qo.parseStreamSettings(s,Pt.VIDEO),{AdapterJS:a}=window;o.getUserMediaSettings.audio||i.getUserMediaSettings.video||n(Wt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),a.webRTCReady(()=>{window.navigator.mediaDevices.getUserMedia({audio:o.getUserMediaSettings.audio,video:i.getUserMediaSettings.video}).then(e=>{const n=Qo.onStreamAccessSuccess(r,e,o,i,!1),s=Ki.getSkylinkState(r);n[0]&&o.mutedSettings.shouldAudioMuted&&jo(s,{audioMuted:o.mutedSettings.shouldAudioMuted,videoMuted:i.mutedSettings.shouldVideoMuted},n[0].id),n[1]&&i.mutedSettings.shouldVideoMuted&&jo(s,{audioMuted:o.mutedSettings.shouldAudioMuted,videoMuted:i.mutedSettings.shouldVideoMuted},n[1].id),t(n)}).catch(e=>Qo.onStreamAccessError(e,n,t,r,o,i))})}),addLocalMediaStreams:(e,t)=>{const n=Ki.getSkylinkState(t.room.id),{peerConnections:r,user:s,peerStreams:o}=n,i=r[e];o[s.sid]&&!zo(o[s.sid])&&((e,t,n,r)=>{const s=Object.values(n);for(let n=0;n<s.length;n+=1)Ko(r,s[n])||$o(e,t,s[n],r)})(n,e,o[s.sid],i)},onRemoteTrackAdded:(e,t,n,r,s,o)=>{const{user:i,hasMCU:a,room:d}=t,c={dispatchOnIncomingStream:e=>{qt(ce(e))},dispatchOnIncomingScreenStream:e=>{qt(le(e))}},l=r?"dispatchOnIncomingScreenStream":"dispatchOnIncomingStream",u={stream:e,peerId:n,room:wo.getRoomInfo(d.id),isSelf:a&&n===i.sid||!1,peerInfo:Uo.getPeerInfo(n,d),streamId:e.id,isVideo:s,isAudio:o};c[l](u),qt(fe({peerId:n,peerInfo:Uo.getPeerInfo(n,d),isSelf:a&&n===i.sid||!1,room:d}))},onStreamAccessError:(e,t,n,r,s,o)=>{const i=Ki.getInitOptions(),a=Ki.getSkylinkState(r),{audioFallback:d}=i;if(s.settings.audio&&o.settings.video&&d){const i=!0;return tn.log.DEBUG([a.user.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.START_FALLBACK]),qt(ye({error:e,state:St.FALLBACKING,isAudioFallback:i})),window.navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{const t=Qo.onStreamAccessSuccess(r,e,s,o,i);n(t)}).catch(n=>{tn.log.ERROR([a.user.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.ERRORS.FALLBACK,n]),qt(Me({error:n,isAudioFallbackError:!0})),qt(ye({error:e,state:St.ERROR,isAudioFallback:i})),t(n)})}tn.log.ERROR([a.user.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.ERRORS.GET_USER_MEDIA],e),qt(Me({error:e,isAudioFallbackError:!1})),t(e)},muteStreams:jo,sendStream:(e,t=null)=>new Promise((n,r)=>{if(!e)return r(new Error(Wt.ROOM_STATE.NO_ROOM_NAME));const{room:s}=e,o=!ti(t)||null===t;if(!s.inRoom)return tn.log.WARN(Wt.ROOM.ERRORS.NOT_IN_ROOM),r(new Error(""+Wt.ROOM.ERRORS.NOT_IN_ROOM));if(o)return r(new Error(`${Wt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${t}`));let i=!1;try{if(Array.isArray(t)){let s=!0;return t.forEach(e=>{si(e.getAudioTracks)&&si(e.getVideoTracks)||(s=!1)}),s?((e,t,n,r)=>{const s=[];return t.forEach(t=>{s.push(Br.usePrefetchedStream(e.room.id,t))}),Promise.all(s).then(t=>{qo(e,t,!0,n,r)}).catch(e=>{r(e)})})(e,t,n,r):r(new Error(Wt.MEDIA_STREAM.ERRORS.INVALID_MEDIA_STREAM_ARRAY))}return i=!!t&&(si(t.getAudioTracks)||si(t.getVideoTracks)),i?((e,t,n,r)=>Br.usePrefetchedStream(e.room.id,t).then(t=>{qo(e,t,!0,n,r)}).catch(e=>{r(e)}))(e,t,n,r):((e,t,n,r)=>Br.getUserMedia(e,t).then(t=>{qo(e,t,!1,n,r)}).catch(e=>{r(e)}))(e,t,n,r)}catch(e){tn.log.ERROR(Wt.MEDIA_STREAM.ERRORS.SEND_STREAM,e)}}),getStreamSources:()=>{const{navigator:e}=window;return new Promise((t,n)=>{e.mediaDevices&&si(e.mediaDevices.enumerateDevices)?e.mediaDevices.enumerateDevices().then(e=>{t(Jo(e))}):n(Jo([]))})},getStreams:(e,t=!0)=>{const n=Ki.getSkylinkState(e.room.id),{peerStreams:r,user:s}=n,o={},i=Object.keys(r);for(let e=0;e<i.length;e+=1){const a=i[e];t&&a===s.sid?(o[a]=Xo(n,a,r),o[a].isSelf=!0):a!==s.sid&&(o[a]=Xo(n,a,r))}return o},updateStreamsMediaStatus:(e,t,n)=>{const r=Ki.getSkylinkState(e),{room:s,streamsMediaStatus:o}=r,{mutedSettings:{shouldAudioMuted:i},settings:{audio:a,video:d}}=t;o[n.id]={},o[n.id].audioMuted=a?i?Dt.MUTED:Dt.ACTIVE:Dt.UNAVAILABLE,o[n.id].videoMuted=d?i?Dt.MUTED:Dt.ACTIVE:Dt.UNAVAILABLE,Ki.setSkylinkState(r,s.id)},splitAudioAndVideoStream:e=>{const{MediaStream:t}=window,n=[],r=e.getAudioTracks(),s=e.getVideoTracks();return Ri(e)?n.push(new t(r)):n.push(null),gi(e)?n.push(new t(s)):n.push(null),n},updateStreamsMutedSettings:(e,t,n)=>{const r=Ki.getSkylinkState(e),{room:s,streamsMutedSettings:o}=r,{audio:i,video:a}=t.settings;o[n.id]={},o[n.id].audioMuted=!i,o[n.id].videoMuted=!a,Ki.setSkylinkState(r,s.id)},onStreamAccessSuccess:(e,t,n,r,s,o=!1)=>{const i=o?[t]:Qo.splitAudioAndVideoStream(t),a=Ki.getSkylinkState(e),{room:d,user:u}=a;return i.forEach(t=>{t&&(br.addStream(u.sid,t,e),Br.buildStreamSettings(d,t,Ri(t)?n:r),Qo.updateStreamsMutedSettings(d.id,Ri(t)?n:r,t),Qo.updateStreamsMediaStatus(d.id,Ri(t)?n:r,t),Os.processPeerMedia(d,u.sid,t,o),s&&tn.log.DEBUG([u.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.FALLBACK_SUCCESS]),o?(tn.log.DEBUG([u.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.START_SCREEN_SUCCESS]),br.dispatchStreamEvent(l,{stream:t,peerId:u.sid,room:wo.getRoomInfo(d.id),isSelf:!0,peerInfo:Uo.getCurrentSessionInfo(d),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0})):u.sid&&br.dispatchStreamEvent(c,{stream:t,peerId:u.sid,room:wo.getRoomInfo(d.id),isSelf:!0,peerInfo:Uo.getCurrentSessionInfo(d),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0}),qt(((e={})=>new de(K,{detail:e}))({stream:t,isScreensharing:o,isAudioFallback:s,streamId:t.id,isAudio:Ri(t),isVideo:gi(t)})))}),i},buildStreamSettings:(e,t,n)=>{const r=Ki.getSkylinkState(e.id);r.streamsSettings[t.id]={settings:n.settings,constraints:n.getUserMediaSettings},Ki.setSkylinkState(r,e.id)}};const zo=e=>0===Object.keys(e).length,Zo=e=>0===e.length,ei=e=>""===e,ti=e=>"object"==typeof e&&null!==e,ni=e=>"object"==typeof e&&null==e,ri=e=>"number"==typeof e,si=e=>"function"==typeof e,oi=e=>void 0!==e&&"boolean"==typeof e,ii=e=>"string"==typeof e,ai=(e,t,n)=>{let r=!0;return null!=e&&ii(e)||(tn.log.ERROR(`${n}: ${t} is null, undefined or not a string.`),r=!1),r},di=e=>{if(ai(e,"roomId","getStateByRid")){const t=Ki.getSkylinkState(),n=Object.keys(t);let r=null;for(let s=0;s<n.length;s+=1){const o=n[s];if(o===e){r=t[o];break}}return r}return tn.log.ERROR(`getRoomStateByRid: ${Wt.ROOM_STATE.NOT_FOUND} - ${e}`),null},ci=e=>di(e),li=e=>{let t=null;if(ai(e,"roomName","getRoomStateByName")){const n=Ki.getSkylinkState(),r=Object.keys(n);for(let s=0;s<r.length;s+=1){const o=n[r[s]];if(o.room.roomName.toLowerCase()===e.toLowerCase()){t=o;break}}}return t||tn.log.ERROR(`getRoomStateByName: ${Wt.ROOM_STATE.NOT_FOUND} - ${e}`),t},ui=()=>{try{(new fo).socket.disconnect()}catch(e){tn.log.ERROR(e)}},Ei=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:n&&15).toString(16)})},Si=e=>new Promise((t,n)=>{const{navigator:r}=window;e&&ti(e)||n(new Error(`${Wt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${e}`)),r.mediaDevices.getUserMedia(e).then(e=>{const n=Qo.splitAudioAndVideoStream(e);t(n)}).catch(e=>{n(e)})}),pi=e=>new Promise((t,n)=>{n(new Error(e))}),hi=(e,t)=>{const n=Ki.getSkylinkState(e.id),{peerConnections:r}=n,s=Object.keys(r);let o=!1;return s.forEach(e=>{e===t&&(o=!0)}),o},Ri=e=>e.getAudioTracks().length>0,gi=e=>e.getVideoTracks().length>0,mi=e=>{const{AdapterJS:t}=window;switch(e){case Ft.CHROME:return t.webrtcDetectedBrowser===Ft.CHROME;case Ft.SAFARI:return t.webrtcDetectedBrowser===Ft.SAFARI;case Ft.FIREFOX:return t.webrtcDetectedBrowser===Ft.FIREFOX;case Ft.REACT_NATIVE:return t.webrtcDetectedBrowser===Ft.REACT_NATIVE;default:return tn.log.DEBUG(Wt.UTILS.INVALID_BROWSER_AGENT),!1}},Ii=e=>new Date(e).toISOString(),fi=()=>(new Date).toISOString();const Ti=(e,t,n,r,s)=>{const o="data"===r?"application":r;let i=-1,a=-1;for(let e=0;e<t.length;e+=1)if(0===t[e].indexOf("m="+o))i=e;else if(i>0){if(0===t[e].indexOf("m="))break;0===t[e].indexOf("c=")?a=e:0!==t[e].indexOf("b=AS:")&&0!==t[e].indexOf("b:TIAS:")||(t.splice(e,1),e-=1)}"number"==typeof s&&s>0?-1!==i&&-1!==a?(tn.log.INFO([e,"RTCSessionDesription",n,`Limiting maximum sending ${r} bandwidth ->`],s),t.splice(a+1,0,"firefox"===window.webrtcDetectedBrowser?"b=TIAS:"+(1e3*s).toFixed(0):"b=AS:"+s)):tn.log.WARN([e,"RTCSessionDesription",n,`Not limiting ${r} bandwidth as ${r} is not being sent`]):tn.log.WARN([e,"RTCSessionDesription",n,`Not limiting ${r} bandwidth`])};var Oi={getSDPCommonSupports:(e,t=null,n)=>{const r=Ki.getSkylinkState(n),s={audio:!1,video:!1},{currentCodecSupport:o,peerInformations:i}=r,{beSilentOnParseLogs:a}=Ki.getInitOptions();if(!e||!t||!t.sdp){if(s.video=!(!o.video.h264&&!o.video.vp8),s.audio=!!o.audio.opus,e){const t=((i[e]||{}).agent||{}).name||"";mi(t)&&(s.video=Object.keys(o.video).length>0,s.audio=Object.keys(o.audio).length>0)}return s}const d=Oi.getSDPCodecsSupport(e,t,a),c=o;for(const e in c.audio)if(c.audio.hasOwnProperty(e)&&c.audio[e]&&d.audio[e]){s.audio=!0;break}for(const e in c.video)if(c.video.hasOwnProperty(e)&&c.video[e]&&d.video[e]){s.video=!0;break}return s},getSDPCodecsSupport:(e,t,n)=>{const r={audio:{},video:{}};if(!t||!t.sdp)return r;const s=t.sdp.split("\r\n");let o="";for(let e=0;e<s.length;e+=1)if(0!==s[e].indexOf("m=")){if(0===s[e].indexOf("a=rtpmap:")){const t=(s[e].split(" ")[1]||"").split("/"),n=(t[0]||"").toLowerCase(),i=t[1]+(t[2]?"/"+t[2]:"");if(["ulpfec","red","telephone-event","cn","rtx"].indexOf(n)>-1)continue;r[o][n]=r[o][n]||[],-1===r[o][n].indexOf(i)&&r[o][n].push(i)}}else o=(s[e].split("m=")[1]||"").split(" ")[0];return n||tn.log.INFO([e||null,"RTCSessionDescription",t.type,"Parsed codecs support ->"],r),r},getCodecsSupport:e=>new Promise((t,n)=>{const r=Ki.getSkylinkState(e),{beSilentOnParseLogs:s}=Ki.getInitOptions(),o=r,{RTCPeerConnection:i}=window;r.currentCodecSupport&&t(r.currentCodecSupport),o.currentCodecSupport={audio:{},video:{}},mi(Ft.SAFARI)&&(o.currentCodecSupport.audio={opus:["48000/2"]},o.currentCodecSupport.video={h264:["48000"]},t(o.currentCodecSupport));try{const e=new i(null);e.addTransceiver(Pt.VIDEO),e.addTransceiver(Pt.AUDIO),e.createOffer().then(e=>{o.currentCodecSupport=Ai.getSDPCodecsSupport(null,e,s),t(o.currentCodecSupport)}).catch(e=>{n(e)})}catch(e){n(e)}}),setSDPBitrate:(e,t,n)=>{const r=Ki.getSkylinkState(n),s=t.sdp.split("\r\n"),o=t.type;let i,a,d;const c=Uo.getPeersCustomSettings(r)[e];return r.streamsBandwidthSettings.bAS?(i=r.streamsBandwidthSettings.bAS.audio,a=r.streamsBandwidthSettings.bAS.video,d=r.streamsBandwidthSettings.bAS.data):c[e]&&c[e].maxBandwidth&&"object"==typeof c[e].maxBandwidth&&("number"==typeof c[e].maxBandwidth.audio&&(i=c[e].maxBandwidth.audio),"number"==typeof c[e].maxBandwidth.video&&(a=c[e].maxBandwidth.video),"number"==typeof c[e].maxBandwidth.data&&(d=c[e].maxBandwidth.data)),Ti(e,s,o,"audio",i),Ti(e,s,o,"video",a),Ti(e,s,o,"data",d),s.join("\r\n")},getSDPICECandidates:(e,t,n)=>{const{RTCIceCandidate:r}=window,s={host:[],srflx:[],relay:[]};return t&&t.sdp?(t.sdp.split("m=").forEach((e,t)=>{if(0===t)return;const n=((e.match(/a=mid:.*\r\n/gi)||[])[0]||"").replace(/a=mid:/gi,"").replace(/\r\n/,""),o=t-1;(e.match(/a=candidate:.*\r\n/gi)||[]).forEach(e=>{const t=(e.split(" ")[7]||"host").replace(/\r\n/g,"");s[t]=s[t]||[],s[t].push(new r({sdpMid:n,sdpMLineIndex:o,candidate:(e.split("a=")[1]||"").replace(/\r\n/g,"")}))})}),n||tn.log.INFO([e,"RTCSessionDesription",t.type,"Parsing session description ICE candidates ->"],s),s):s},getSDPSelectedCodec:(e,t,n,r)=>{const s={name:null,implementation:null,clockRate:null,channels:null,payloadType:null,params:null};return t&&t.sdp?(t.sdp.split("m=").forEach((e,t)=>{if(0===t||0!==e.indexOf(n+" "))return;const r=(e.split("\r\n")[0]||"").split(" ");r.splice(0,3);for(let t=0;t<r.length;t+=1){const n=e.match(new RegExp(`a=rtpmap:${r[t]}.*\r\n`,"gi"));if(!n)continue;const o=((n[0]||"").replace(/\r\n/g,"").split(" ")[1]||"").split("/");if(["red","ulpfec","telephone-event","cn","rtx"].indexOf(o[0].toLowerCase())>-1)continue;s.name=o[0],s.clockRate=parseInt(o[1],10)||0,s.channels=parseInt(o[2]||"1",10)||1,s.payloadType=parseInt(r[t],10),s.params="";(e.match(new RegExp(`a=fmtp:${r[t]}.*\r\n`,"gi"))||[]).forEach(e=>{s.params+=e.replace(new RegExp("a=fmtp:"+r[t],"gi"),"").replace(/ /g,"").replace(/\r\n/g,"")});break}}),r||tn.log.INFO([e,"RTCSessionDesription",t.type,`Parsing session description "${n}" codecs ->`],s),s):s},getTransceiverMid:(e,t)=>{const n={audio:[],video:[]};return e.sdp.split("m=").forEach((e,t)=>{const r=e.split(/\n/),s=r[0].split(" ")[0];if("application"===s||0===t)return;let o={};for(let e=0;e<r.length;e+=1){if(r[e].match(/a=recvonly|a=sendonly|a=sendrecv|a=inactive/)){const t=r[e].split("=");o.direction=t[1].trim()}if(r[e].match(/a=mid:*/)&&(o.transceiverMid=r[e].split(/:/)[1].trim()),r[e].match(/a=msid:([\w|-|{]+)/)){const t=r[e].split(" "),n=t[0].split(/:/)[1].trim();o.streamId="-"===n?"":n,o.trackId=t[1].trim()}o.transceiverMid&&o.streamId&&o.trackId&&(n[s].push(o),o={})}}),t||tn.log.INFO([null,"RTCSessionDesription",e.type,`Parsing session description "${e.type}" transceivers ->`],n),n}};var Ai=class{static getSDPCommonSupports(...e){return Oi.getSDPCommonSupports(...e)}static getCodecsSupport(...e){return Oi.getCodecsSupport(...e)}static setSDPBitrate(...e){return Oi.setSDPBitrate(...e)}static getSDPCodecsSupport(...e){return Oi.getSDPCodecsSupport(...e)}static getSDPICECandidates(...e){return Oi.getSDPICECandidates(...e)}static getSDPSelectedCodec(...e){return Oi.getSDPSelectedCodec(...e)}static getTransceiverMid(...e){return Oi.getTransceiverMid(...e)}};const Ci=e=>"relay"===e?"relayed":"host"===e||e.indexOf("host")>-1?"local":"srflx"===e?"serverreflexive":"prflx"===e?"peerreflexive":e;var _i={parseSelectedCandidatePair:(e,t,n,r,s,o)=>{const{peerStats:i}=e,{raw:a,selectedCandidatePair:d}=t,c=Object.keys(t.raw);let l=null,u=null,E=null;if(mi(Ft.CHROME))for(let e=0;e<c.length;e+=1)"transport"===a[c[e]].type&&(l=a[c[e]]);else mi(Ft.FIREFOX)&&(l={});if(l)for(let e=0;e<c.length;e+=1){const t=a[c[e]];if("candidate-pair"===t.type&&t.id===l.selectedCandidatePairId||"candidate-pair"===t.type&&t.selected){const e=t;u=e.localCandidateId,E=e.remoteCandidateId,d.id=e.id,d.writable=e.writable,d.priority=e.priority,d.nominated=e.nominated;const n=i[o][t.id],r=parseInt(t.totalRoundTripTime||"0",10);d.totalRoundTripTime=r,d.roundTripTime=_i.tabulateStats(n,t,"totalRoundTripTime");const s=parseInt(t.consentRequestsSent||"0",10);d.consentRequests.totalSent=s,d.consentRequests.sent=_i.tabulateStats(n,t,"consentRequestsSent");const a=parseInt(t.requestsReceived||"0",10);d.requests.totalReceived=a,d.requests.received=_i.tabulateStats(n,t,"requestsReceived");const c=parseInt(t.requestsSent||"0",10);d.requests.totalSent=c,d.requests.sent=_i.tabulateStats(n,t,"requestsSent");const l=parseInt(t.responsesSent||"0",10);d.responses.totalSent=l,d.responses.sent=_i.tabulateStats(n,t,"responsesSent");const S=parseInt(t.responsesReceived||"0",10);d.responses.totalReceived=S,d.responses.received=_i.tabulateStats(n,t,"responsesReceived")}}if(u&&E){if("remote-candidate"===n){const e=r;e.id===E&&(d.remote.ipAddress=e.ip?e.ip:e.address,d.remote.portNumber=e.port,d.remote.transport=e.protocol,d.remote.priority=e.priority,d.remote.candidateType=Ci(e.candidateType))}if("local-candidate"===n){const e=r;e.id===u&&(d.local.ipAddress=e.ip?e.ip:e.address,d.local.portNumber=e.port,d.local.transport=e.protocol,d.local.priority=e.priority,d.local.networkType=e.networkType,d.local.candidateType=Ci(e.candidateType))}}},parseCertificates:(e,t)=>{const{certificate:n,raw:r}=e,s=Object.keys(e.raw);let o=null;for(let e=0;e<s.length;e+=1)"transport"===r[s[e]].type&&(o=r[s[e]]);if(o){n.srtpCipher=o.srtpCipher,n.dtlsCipher=o.dtlsCipher,n.tlsVersion=o.tlsVersion;const{localCertificateId:e,remoteCertificateId:r}=o;t.id===e?(n.local={},n.local.base64Certificate=t.base64Certificate,n.local.fingerprintAlgorithm=t.fingerprintAlgorithm):t.id===r&&(n.remote={},n.remote.base64Certificate=t.base64Certificate,n.remote.fingerprintAlgorithm=t.fingerprintAlgorithm)}},tabulateStats:(e=null,t,n)=>{const r=t.timestamp,s=e&&e.timestamp||0,o=parseFloat(t[n]||"0",10),i=parseFloat(e&&e[n]||"0",10);return new Date(r).getTime()===new Date(s).getTime()?o:parseFloat(((o-i)/(r-s)*1e3).toFixed(3)||"0",10)},parseAudio:(e,t,n,r,s,o)=>{const{peerStats:i}=e,a=i[s][r.id];switch(o){case"receiving":((e,t,n)=>{const r=e.audio.receiving,s=parseInt(t.packetsReceived||"0",10);r.totalPackets=s,r.packets=_i.tabulateStats(n,t,"packetsReceived");const o=parseInt(t.bytesReceived||"0",10);r.totalBytes=o,r.bytes=_i.tabulateStats(n,t,"bytesReceived");const i=parseInt(t.packetsLost||"0",10);r.totalPacketsLost=i,r.packetsLost=_i.tabulateStats(n,t,"packetsLost"),r.jitter=parseInt(t.jitter||"0",10),r.ssrc=t.ssrc;const{trackId:a}=t,d=e.raw[a];d&&(r.audioLevel=parseFloat(d.audioLevel).toFixed(5),r.totalSamplesReceived=parseInt(d.totalSamplesReceived||"0",10),r.totalSamplesDuration=parseInt(d.totalSamplesDuration||"0",10))})(t,r,a);break;case"sending":((e,t,n)=>{const r=e.audio.sending;if(t.bytesSent){const e=parseInt(t.bytesSent||"0",10);r.totalBytes=e,r.bytes=_i.tabulateStats(n,t,"bytesSent")}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);r.totalPackets=e,r.packets=_i.tabulateStats(n,t,"packetsSent")}if(t.retransmittedBytesSent||ri(t.retransmittedBytesSent)){const e=parseInt(t.retransmittedBytesSent||"0",10);r.totalRetransmittedBytesSent=e,r.retransmittedBytesSent=_i.tabulateStats(n,t,"retransmittedBytesSent")}if(t.retransmittedPacketsSent||ri(t.retransmittedPacketsSent)){const e=parseInt(t.retransmittedPacketsSent||"0",10);r.totalRetransmittedPacketsSent=e,r.retransmittedPacketsSent=_i.tabulateStats(n,t,"retransmittedPacketsSent")}r.ssrc=t.ssrc,t.jitter&&(r.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(r.roundTripTime=parseInt(t.roundTripTime||"0",10));const{trackId:s,mediaSourceId:o}=t,i=e.raw[s];i&&(r.echoReturnLoss=parseInt(i.echoReturnLoss||"0",10),r.echoReturnLossEnhancement=parseInt(i.echoReturnLossEnhancement||"0",10));const a=e.raw[o];a&&(r.audioLevel=parseFloat(a.audioLevel).toFixed(5),r.totalSamplesDuration=parseInt(a.totalSamplesDuration||"0",10))})(t,r,a);break;default:tn.log.DEBUG([s,yt.STATS_MODULE,null,Wt.STATS_MODULE.ERRORS.PARSE_FAILED])}},parseVideo:(e,t,n,r,s,o)=>{const{peerStats:i}=e,a=i[s][r.id];switch(o){case"receiving":((e,t,n)=>{const r=e.video.receiving;if(t.bytesReceived){const e=parseInt(t.bytesReceived||"0",10);r.totalBytes=e,r.bytes=_i.tabulateStats(n,t,"bytesReceived")}if(t.packetsReceived){const e=parseInt(t.packetsReceived||"0",10);r.totalPackets=e,r.packets=_i.tabulateStats(n,t,"packetsReceived")}if(Number.isInteger(t.packetsLost)){const e=parseInt(t.packetsLost||"0",10);r.totalPacketsLost=e,r.packetsLost=_i.tabulateStats(n,t,"packetsLost")}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);r.totalFirs=e,r.firs=_i.tabulateStats(n,t,"firCount")}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);r.totalNacks=e,r.nacks=_i.tabulateStats(n,t,"nackCount")}if(t.pliCount||Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);r.totalPlis=e,r.plis=_i.tabulateStats(n,t,"pliCount")}r.ssrc=t.ssrc,r.qpSum=parseInt(t.qpSum||"0",10),r.decoderImplementation=t.decoderImplementation;const{trackId:s}=t,o=e.raw[s];o&&(r.framesDropped=parseFloat(o.framesDropped||"0"),r.frames=parseInt(o.framesReceived||"0",10),r.framesDecoded=parseInt(o.framesDecoded||"0",10),r.frameWidth=parseInt(o.frameWidth||"0",10),r.frameHeight=parseInt(o.frameHeight||"0",10))})(t,r,a);break;case"sending":((e,t,n)=>{const r=e.video.sending;if(t.bytesSent){const e=parseInt(t.bytesSent||"0",10);r.totalBytes=e,r.bytes=_i.tabulateStats(n,t,"bytesSent")}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);r.totalPackets=e,r.packets=_i.tabulateStats(n,t,"packetsSent")}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);r.totalFirs=e,r.firs=_i.tabulateStats(n,t,"firCount")}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);r.totalNacks=e,r.nacks=_i.tabulateStats(n,t,"nackCount")}if(Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);r.totalPlis=e,r.plis=_i.tabulateStats(n,t,"pliCount")}t.jitter&&(r.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(r.roundTripTime=parseInt(t.roundTripTime||"0",10)),Number.isInteger(t.framesEncoded)&&(r.framesEncoded=parseInt(t.framesEncoded||"0",10)),r.ssrc=t.ssrc,r.qpSum=parseInt(t.qpSum||"0",10);const{trackId:s,mediaSourceId:o}=t,i=e.raw[s];i&&(r.frameWidth=parseInt(i.frameWidth||"0",10),r.frameHeight=parseInt(i.frameHeight||"0",10),r.frames=parseInt(i.framesSent||"0",10),r.hugeFramesSent=parseInt(i.hugeFramesSent||"0",10));const a=e.raw[o];a&&(r.framesPerSecond=parseInt(a.framesPerSecond||"0",10))})(t,r,a);break;default:tn.log.DEBUG([s,yt.STATS_MODULE,null,Wt.STATS_MODULE.ERRORS.PARSE_FAILED])}},parseMedia:(e,t,n,r,s,o,i)=>{const a=r.kind||r.mediaType;a===Pt.AUDIO?_i.parseAudio(e,t,n,r,o,i):a===Pt.VIDEO?_i.parseVideo(e,t,n,r,o,i):tn.log.DEBUG([(void 0).peerId,yt.STATS_MODULE,null,Wt.STATS_MODULE.INVALID_TRACK_KIND],r)}};var Ni=class{constructor(e,t){this.roomState=Ki.getSkylinkState(e),this.peerConnection=this.roomState.peerConnections[t]||null,this.dataChannel=this.roomState.dataChannels[t]||null,this.peerId=t,this.roomKey=e,this.output={peerId:t,raw:{},connection:{},audio:{sending:{},receiving:{}},video:{sending:{},receiving:{}},selectedCandidatePair:{id:null,local:{},remote:{},consentRequests:{},responses:{},requests:{}},certificate:{}},this.beSilentOnLogs=Ki.getInitOptions().beSilentOnStatsLogs,this.beSilentOnParseLogs=Ki.getInitOptions().beSilentOnParseLogs,this.bandwidth=null}getConnectionStatus(){return this.getStatistics(!1,!1)}getStatsSuccess(e,t,n){if(!n&&mi(Ft.REACT_NATIVE))return void e(this.output);const{peerStats:r,room:s}=this.roomState;"function"==typeof n.forEach?n.forEach((e,t)=>{this.output.raw[t]=e}):this.output.raw=n;try{if(zo(r))return void tn.log.DEBUG([this.peerId,yt.STATS_MODULE,null,Wt.STATS_MODULE.STATS_DISCARDED]);Object.entries(this.output.raw).forEach(e=>{const t=e[0],n=e[1],{type:o}=n;switch(o){case"remote-inbound-rtp":case"outbound-rtp":case"inbound-rtp":"inbound-rtp"===o?_i.parseMedia(this.roomState,this.output,o,n,this.peerConnection,this.peerId,"receiving"):_i.parseMedia(this.roomState,this.output,o,n,this.peerConnection,this.peerId,"sending");break;case"certificate":_i.parseCertificates(this.output,n);break;case"local-candidate":case"remote-candidate":case"media-source":_i.parseSelectedCandidatePair(this.roomState,this.output,o,n,this.peerConnection,this.peerId)}r[this.peerId][t]=this.output.raw[t],Ki.setSkylinkState(this.roomState,s.id)})}catch(e){this.getStatsFailure(t,Wt.STATS_MODULE.ERRORS.PARSE_FAILED,e)}this.beSilentOnLogs||qt(Ne({state:$e.RETRIEVE_SUCCESS,peerId:this.peerId,stats:this.output})),e(this.output)}getStatsFailure(e,t,n){const r=t||Wt.STATS_MODULE.RETRIEVE_STATS_FAILED;this.beSilentOnLogs||(tn.log.ERROR([this.peerId,yt.STATS_MODULE,null,r],n),qt(Ne({state:$e.RETRIEVE_ERROR,peerId:this.peerId,error:n}))),e(n)}getStatistics(e=!1,t=!1){const{STATS_MODULE:n}=Wt;return new Promise((r,s)=>{if(this.roomState.peerStats[this.peerId]||t){this.beSilentOnLogs=e,this.isAutoBwStats=t;try{this.gatherRTCPeerConnectionDetails(),this.gatherSDPIceCandidates(),this.gatherSDPCodecs(),this.gatherRTCDataChannelDetails()}catch(e){tn.log.WARN([this.peerId,yt.STATS_MODULE,null,Wt.STATS_MODULE.ERRORS.PARSE_FAILED],e)}"function"!=typeof this.peerConnection.getStats&&this.getStatsFailure(s,Wt.PEER_CONNECTION.STATS_API_UNAVAILABLE),this.beSilentOnLogs||qt(Ne({state:$e.RETRIEVING,peerId:this.peerId})),this.peerConnection.getStats().then(e=>{this.getStatsSuccess(r,s,e)}).catch(e=>{e.message!==Wt.STATS_MODULE.ERRORS.STATS_IS_NULL?this.getStatsFailure(s,null,e):tn.log.WARN([this.peerId,yt.STATS_MODULE,null,Wt.STATS_MODULE.ERRORS.RETRIEVE_STATS_FAILED],e.message)})}else tn.log.WARN(n.NOT_INITIATED),r(null)})}gatherRTCPeerConnectionDetails(){const{peerConnection:e}=this;this.output.connection.iceConnectionState=e.iceConnectionState,this.output.connection.iceGatheringState=e.iceGatheringState,this.output.connection.signalingState=e.signalingState,this.output.connection.remoteDescription={type:e.remoteDescription&&e.remoteDescription.type||"",sdp:e.remoteDescription&&e.remoteDescription.sdp||""},this.output.connection.localDescription={type:e.localDescription&&e.localDescription.type||"",sdp:e.localDescription&&e.localDescription.sdp||""},this.output.connection.constraints=this.peerConnection.constraints?this.peerConnection.constraints:null,this.output.connection.sdpConstraints=this.peerConnection.sdpConstraints?this.peerConnection.sdpConstraints:null}gatherSDPIceCandidates(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.connection.candidates={sending:Ai.getSDPICECandidates(this.peerId,e.localDescription,t),receiving:Ai.getSDPICECandidates(this.peerId,e.remoteDescription,t)}}gatherSDPCodecs(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.audio.sending.codec=Ai.getSDPSelectedCodec(this.peerId,e.remoteDescription,"audio",t),this.output.video.sending.codec=Ai.getSDPSelectedCodec(this.peerId,e.remoteDescription,"video",t),this.output.audio.receiving.codec=Ai.getSDPSelectedCodec(this.peerId,e.localDescription,"audio",t),this.output.video.receiving.codec=Ai.getSDPSelectedCodec(this.peerId,e.localDescription,"video",t)}gatherRTCDataChannelDetails(){const{dataChannel:e}=this;if(e){const t=Object.keys(e);this.output.connection.dataChannels={},t.forEach(t=>{const n=e[t];this.output.connection.dataChannels[n.channel.label]={label:n.channel.label,readyState:n.channel.readyState,channelType:ke["main"===t?"MESSAGING":"DATA"],currentTransferId:n.transferId||null,currentStreamId:n.streamId||null}})}}};var Di=class{static addPeer(e){ls.addPeer(e)}static createOffer(...e){return ls.createOffer(...e)}static createAnswer(...e){return ls.createAnswer(...e)}static createDataChannel(...e){return ls.createDataChannel(...e)}static sendP2PMessage(...e){return ls.sendP2PMessage(...e)}static getPeersInRoom(...e){return ls.getPeersInRoom(...e)}static retrieveStatistics(e,t,n,r){return new Ni(e,t).getStatistics(n,r)}static signalingEndOfCandidates(...e){return ls.signalingEndOfCandidates(...e)}static getConnectionStatus(e,t){return ls.getConnectionStatus(e,t)}static getDataChannelBuffer(e){return ls.getDataChannelBuffer(e)}static refreshDataChannel(e,t){return ls.refreshDataChannel(e,t)}static closeDataChannel(e,t){return ls.closeDataChannel(e,t)}static refreshConnection(e,t,n,r,s){return ls.refreshConnection(e,t,n,r,s)}static refreshPeerConnection(e,t,n,r){return ls.refreshPeerConnection(e,t,n,r)}static buildPeerInformations(...e){return ls.buildPeerInformations(...e)}static closePeerConnection(e,t){return ls.closePeerConnection(e,t)}static updatePeerInformationsMediaStatus(e,t,n,r){return ls.updatePeerInformationsMediaStatus(e,t,n,r)}};const yi=(e,t,n,r=!1)=>{Ur.prepStopStreams(e.id,t.id,r,!0).then(()=>tn.log.DEBUG([n,yt.MEDIA_STREAM,null,""+Wt.MEDIA_STREAM.STOP_SCREEN_SUCCESS])).catch(e=>tn.log.DEBUG([n,yt.MEDIA_STREAM,null,""+Wt.MEDIA_STREAM.ERRORS.STOP_SCREEN],e))};var vi={handleScreenStreamStates:{onScreenStreamAccessSuccess:(e,t)=>{const{room:n,user:r}=e,s=Qo.parseStreamSettings(dn.MEDIA_OPTIONS.SCREENSHARE);br.addStream(r.sid,t,n.id),Os.processPeerMedia(n,r.sid,t,!0),Br.buildStreamSettings(n,t,s),Qo.updateStreamsMutedSettings(n.id,s,t),Qo.updateStreamsMediaStatus(n.id,s,t),br.dispatchStreamEvent(l,{stream:t,peerId:r.sid,room:wo.getRoomInfo(n.id),isSelf:!0,peerInfo:Uo.getCurrentSessionInfo(n),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0})},setScreenStateToUnavailable:(e,t)=>{const{user:n,room:r}=e,s=Os.retrieveMediaId(Pt.VIDEO,t.id);Os.setMediaStateToUnavailable(r,n.sid,s)}},addScreenStreamCallbacks:(e,t)=>{t.getTracks().forEach(n=>{n.onended=()=>yi(e.room,t,e.user.sid)})},retrievePeersScreenStreamId:e=>{const{peerMedias:t,user:n}=e,r={},s=Object.keys(t).filter(e=>e!==n.sid);for(let e=0;e<s.length;e+=1){const n=s[e];Object.values(t[n]).forEach(e=>{e.mediaType===vt.VIDEO_SCREEN&&(r[n]=e.streamId)})}return r},stopScreenStream:yi,onScreenStreamAccessSuccess:(e,t,n,r,s,o)=>{Qo.onStreamAccessSuccess(e,t,n,r,s,o)}};const Mi={};var Pi=class{constructor(e){const{room:t}=e;if(Mi[t.id])return Mi[t.id];this.roomState=e,this.stream=null,this.signaling=new fo,this.streamId=null,Mi[t.id]=this}streamExists(){const e=Qo.getStreams(this.roomState,this.roomState.room.name),t=Object.keys(e.userMedia);for(let e=0;e<t.length;e+=1)if(t[e]===this.streamId)return!0;return!1}async start(e=null){this.streamId=e;try{if(this.checkForExistingScreenStreams(),this.stream=await this.startScreenCapture(),!this.stream)return this.deleteScreensharingInstance(this.roomState.room),null;vi.onScreenStreamAccessSuccess(this.roomState.room.id,this.stream,null,Qo.parseStreamSettings(dn.MEDIA_OPTIONS.SCREENSHARE),!1,!0),vi.addScreenStreamCallbacks(this.roomState,this.stream),this.addScreenshareStream()}catch(e){tn.log.ERROR([this.roomState.user.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.ERRORS.START_SCREEN],e)}return this.stream}stop(e=!1){if(!this.stream)return tn.log.DEBUG([this.roomState.user.sid,yt.MEDIA_STREAM,null,`${Wt.MEDIA_STREAM.ERRORS.STOP_SCREEN} - ${Wt.MEDIA_STREAM.ERRORS.NO_STREAM}`]),null;try{vi.stopScreenStream(this.roomState.room,this.stream,this.roomState.user.sid,e),this.streamId=null,this.stream=null}catch(e){tn.log.ERROR([this.roomState.user.sid,yt.MEDIA_STREAM,null,""+Wt.MEDIA_STREAM.ERRORS.STOP_SCREEN],e)}return null}startScreenCapture(){const{navigator:e}=window;return e.mediaDevices.getDisplayMedia?e.mediaDevices.getDisplayMedia(dn.MEDIA_OPTIONS.SCREENSHARE).then(e=>e).catch(e=>("NotAllowedError"===e.name?tn.log.WARN(e):tn.log.ERROR(e),null)):e.mediaDevices.getUserMedia({video:{mediaSource:"screen"}}).then(e=>e).catch(e=>(tn.log.ERROR(e),null))}checkForExistingScreenStreams(){const e=vi.retrievePeersScreenStreamId(this.roomState);zo(e)||tn.log.WARN([this.roomState.user.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.ERRORS.PEER_SCREEN_ACTIVE])}addScreenshareStream(){const{peerConnections:e}=this.roomState;zo(e)||Di.refreshConnection(this.roomState).catch(e=>tn.log.ERROR([this.roomState.user.sid,yt.MEDIA_STREAM,null,Wt.MEDIA_STREAM.ERRORS.START_SCREEN],e))}deleteScreensharingInstance(e){delete Mi[e.id]}};let ki=null;var wi=class{constructor(){return ki||(ki=this),this.states={},ki}setState(e){this.states[e.room.id]=e}getAllStates(){return this.states}getState(e){return this.states[e]}removeStateByRoomId(e){return delete this.states[e]}clearRoomStateFromSingletons(e){const t=this.getState(e);new Pi(t).deleteScreensharingInstance(t.room),sr.deleteAsyncInstance(t.room),tr.deleteEncryptedInstance(t.room),new mn(null,e).deleteApiResponseInstance(e)}};var bi=class{static shouldProceed(e,t,n){let r=null;return e.isPrivileged||(r=Wt.PEER_PRIVILEGED.not_privileged),t||(r=Wt.PEER_PRIVILEGED.no_appkey),r&&(tn.log.DEBUG(r),n(new Error(r))),!r}static getPeerList(e,t){return new Promise((n,r)=>{try{const o=Ki.getSkylinkState(e.id),i=Ki.getInitOptions(),a=t||!1,d=e=>{const t=e.detail;t.state===ze.DISPATCHED&&(Yt(s.EVENTS.GET_PEERS_STATE_CHANGE,d),qt(Ce({state:ze.RECEIVED,privilegePeerId:o.user.sid,peerList:t.peerList})),n(t.peerList))};this.shouldProceed(o,i.appKey,r)&&((new fo).getPeerList(a),qt(Ce({state:ze.ENQUIRED,privilegePeerId:o.user.sid,peerList:null})),tn.log.INFO(Wt.PEER_PRIVILEGED.getPeerListFromServer),$t(s.EVENTS.GET_PEERS_STATE_CHANGE,d))}catch(e){tn.log.ERROR(e),r(e)}})}};const Li=(e,t,n,r=null,s=null)=>{const o=new eo;return tn.log.ERROR(t),o.send(e.room.id,n,r,s,t),new Error(t)},Gi=(e,t)=>new Promise((n,r)=>{const{hasMCU:o,currentRecordingId:i,recordingStartInterval:a}=e;let d=t?Wt.RECORDING.START_FAILED:Wt.RECORDING.STOP_FAILED;if(!o){d=`${d} - ${Wt.RECORDING.ERRORS.MCU_NOT_CONNECTED}`;const n=t?Wt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_START:Wt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_STOP;r(Li(e,d,n,null,null))}if(t&&i){r(Li(e,`${d} - ${Wt.RECORDING.ERRORS.EXISTING_RECORDING_IN_PROGRESS}`,Wt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_START_ACTIVE,i,null))}if(!t&&!i){r(Li(e,`${d} - ${Wt.RECORDING.ERRORS.NO_RECORDING_IN_PROGRESS}`,Wt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_STOP_ACTIVE,i,null))}if(!t&&a){r(Li(e,`${d} - ${Wt.RECORDING.ERRORS.MIN_RECORDING_TIME}`,Wt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_MIN_STOP,i,null))}((e,t)=>{const n=r=>{const o=r.detail,i=t?s.RECORDING_STATE.START:s.RECORDING_STATE.STOP;o.state===i&&(Yt(s.EVENTS.RECORDING_STATE,n),e(o.recordingId))};$t(s.EVENTS.RECORDING_STATE,n)})(n,t),((e,t,n=null)=>{const r=new fo,o=new eo;r.recording(e.room.id,t?s.SIG_MESSAGE_TYPE.START_RECORDING:s.SIG_MESSAGE_TYPE.STOP_RECORDING),o.send(e.room.id,t?Wt.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_START:Wt.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_STOP,n,null,null)})(e,t,i)});var Ui=class{static start(...e){return(e=>Gi(e,!0))(...e)}static stop(...e){return(e=>Gi(e,!1))(...e)}static getRecordings(e){const{recordings:t}=e;return Object.assign({},t)}};var Fi={checkRTMPDependencies:(e,t,n=null,r=null)=>{const s={shouldProceed:!0,errorMessage:""},{hasMCU:o}=t;return o?e&&!n?(s.errorMessage=Wt.RTMP.start_no_stream_id,s.shouldProceed=!1,s):e&&!r?(s.errorMessage=Wt.RTMP.start_no_endpoint,s.shouldProceed=!1,s):s:(s.errorMessage=e?Wt.RTMP.start_no_mcu:Wt.RTMP.stop_no_mcu,s.shouldProceed=!1,s)},registerRTMPEventListenersAndResolve:(e,t)=>{const n=r=>{const o=r.detail,i=e?s.RTMP_STATE.START:s.RTMP_STATE.STOP;o.state===i&&(Yt(s.EVENTS.RTMP_STATE,n),t(o.rtmpId))};$t(s.EVENTS.RTMP_STATE,n)},sendRTMPMessageViaSig:(e,t,n,r=null,s=null)=>{const{room:o,user:i}=e,a=new fo,d=t?Tt.START_RTMP:Tt.STOP_RTMP;a.rtmp(d,o.id,i.sid,n,r,s)}};var Bi=class{static startSession(e,t,n){return this.commonRTMPOperations(e,t,null,n,!0,Wt.RTMP.starting_rtmp)}static stopSession(e,t){return this.commonRTMPOperations(e,null,t,null,!1,Wt.RTMP.stopping_rtmp)}static logErrorAndReject(e,t){tn.log.ERROR(e),t(e)}static commonRTMPOperations(e,t,n,r,s,o){return new Promise((i,a)=>{try{const d=Fi.checkRTMPDependencies(s,e,t,r),c=n||Ei();d.shouldProceed?(Fi.registerRTMPEventListenersAndResolve(s,i),Fi.sendRTMPMessageViaSig(e,s,c,t,r),tn.log.INFO([Bt.MCU,"RTMP",o])):this.logErrorAndReject(new Error(d.errorMessage),a)}catch(e){this.logErrorAndReject(e,a)}})}};var Vi=class{async joinRoom(e={},t){return wo.joinRoom(e,t)}sendP2PMessage(e="",t="",n=""){Di.sendP2PMessage(e,t,n)}sendMessage(e="",t="",n=""){or.sendMessage(e,t,n)}getStoredMessages(e){const t=li(e);t&&new sr(t).getStoredMessages()}getPeersInRoom(e){return ai(e,"roomName","getPeersInRoom")?Di.getPeersInRoom(e):null}getPeerInfo(e,t=null){const n=li(e);return t&&n?Uo.getPeerInfo(t,n.room):!t&&n?Uo.getCurrentSessionInfo(n.room):null}getUserData(e,t){const n=li(e);return n&&n.room?Uo.getUserData(n,t):null}setUserData(e,t){const n=li(e);return n&&n.room?Uo.setUserData(n.room,t):null}getConnectionStatus(e,t){const n=li(e);return Di.getConnectionStatus(n,t)}getPeers(e,t=!1){const n=li(e);return n?bi.getPeerList(n.room,t):null}getPeersDataChannels(e){const t=li(e);return t?Uo.getPeersDataChannels(t):null}getPeersCustomSettings(e){const t=li(e);return t?Uo.getPeersCustomSettings(t):null}refreshDatachannel(e,t){const n=li(e);return n?Di.refreshDataChannel(n,t):null}refreshConnection(e,t,n,r){const s=li(e);return Di.refreshConnection(s,t,n,r)}shareScreen(e){const t=li(e);if(t){return new Pi(t).start(null)}return null}getUserMedia(e=null,t){if(!e)return Si(t);if(ii(e)){const n=li(e);if(n)return Br.processUserMediaOptions(n,t)}else if(ti(e))return Si(e)}stopPrefetchedStream(e){return e&&(e.getTracks().forEach(e=>{e.stop()}),qt(ue({room:null,peerId:null,peerInfo:null,isSelf:!0,isScreensharing:!1,streamId:e.id}))),null}stopScreen(e){const t=li(e);if(t){new Pi(t).stop()}return null}stopStreams(e,t){const n=li(e);return n?Br.stopStreams(n,t):null}leaveRoom(e){const t=li(e);return t?wo.leaveRoom(t):null}leaveAllRooms(){return wo.leaveAllRooms()}startRecording(e){const t=li(e);return t?Ui.start(t):null}stopRecording(e){const t=li(e);return t?Ui.stop(t):null}lockRoom(e){const t=li(e);return t?wo.lockRoom(t):null}unlockRoom(e){const t=li(e);return t?wo.unlockRoom(t):null}getRecordings(e){const t=li(e);return t?Ui.getRecordings(t):null}muteStreams(e,t={audioMuted:!0,videoMuted:!0},n){const r=li(e);return r?Br.muteStreams(r,t,n):null}startRTMPSession(e,t,n){const r=li(e);return r?Bi.startSession(r,t,n):null}stopRTMPSession(e,t){const n=li(e);return n?Bi.stopSession(n,t):null}getStreamSources(){return Br.getStreamSources()}sendStream(e,t){const n=li(e);return Br.sendStream(n,t)}getStreams(e,t=!0){const n=li(e);return n?Br.getStreams(n,t):null}generateUUID(){return Ei()}setEncryptSecret(e="",t="",n=""){const r=li(e);return new tr(r).setEncryptSecret(t,n)}getEncryptSecrets(e=""){const t=li(e);return new tr(t).getEncryptSecrets()}deleteEncryptSecrets(e="",t=""){const n=li(e);return new tr(n).deleteEncryptSecrets(t)}setSelectedSecret(e="",t=""){const n=li(e);new tr(n).setSelectedSecretId(t)}getSelectedSecret(e,t){const n=li(e);return new tr(n).getSelectedSecretId(t)}setMessagePersistence(e,t){const n=li(e);return new sr(n).setMessagePersistence(t)}getMessagePersistence(e){const t=li(e);return new sr(t).getMessagePersistence()}};window.AdapterJS=d,window.io=i.a;const xi=new wi;let Hi={},ji={};class Wi extends Vi{constructor(e){super();const t=(new vn).init(e);Wi.setInitOptions(t)}static getSkylinkState(e=null){return e?xi.getState(e):xi.getAllStates()}static setSkylinkState(e,t){t&&xi.setState(e)}static removeSkylinkState(e){if(e)return xi.removeStateByRoomId(e)}static clearRoomStateFromSingletons(e){if(e)return xi.clearRoomStateFromSingletons(e)}static getInitOptions(){return Hi}static setInitOptions(e){Hi=e}static setUserInitOptions(e){ji=e}static getUserInitOptions(){return ji}}var Ki=t.c=Wi},44:function(e,t,n){var r=n(56);e.exports=function(e){var t=e.xdomain,n=e.xscheme,s=e.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!t||r))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!n&&s)return new XDomainRequest}catch(e){}if(!t)try{return new(self[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}},45:function(e,t,n){var r=n(25),s=n(19);function o(e){this.path=e.path,this.hostname=e.hostname,this.port=e.port,this.secure=e.secure,this.query=e.query,this.timestampParam=e.timestampParam,this.timestampRequests=e.timestampRequests,this.readyState="",this.agent=e.agent||!1,this.socket=e.socket,this.enablesXDR=e.enablesXDR,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.forceNode=e.forceNode,this.isReactNative=e.isReactNative,this.extraHeaders=e.extraHeaders,this.localAddress=e.localAddress}e.exports=o,s(o.prototype),o.prototype.onError=function(e,t){var n=new Error(e);return n.type="TransportError",n.description=t,this.emit("error",n),this},o.prototype.open=function(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this},o.prototype.close=function(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this},o.prototype.send=function(e){if("open"!==this.readyState)throw new Error("Transport not open");this.write(e)},o.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},o.prototype.onData=function(e){var t=r.decodePacket(e,this.socket.binaryType);this.onPacket(t)},o.prototype.onPacket=function(e){this.emit("packet",e)},o.prototype.onClose=function(){this.readyState="closed",this.emit("close")}},54:function(e,t,n){var r=n(97),s=n(62),o=n(19),i=n(24),a=n(64),d=n(39),c=n(18)("socket.io-client:manager"),l=n(38),u=n(65),E=Object.prototype.hasOwnProperty;function S(e,t){if(!(this instanceof S))return new S(e,t);e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.nsps={},this.subs=[],this.opts=t,this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new u({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this.readyState="closed",this.uri=e,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[];var n=t.parser||i;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this.autoConnect=!1!==t.autoConnect,this.autoConnect&&this.open()}e.exports=S,S.prototype.emitAll=function(){for(var e in this.emit.apply(this,arguments),this.nsps)E.call(this.nsps,e)&&this.nsps[e].emit.apply(this.nsps[e],arguments)},S.prototype.updateSocketIds=function(){for(var e in this.nsps)E.call(this.nsps,e)&&(this.nsps[e].id=this.generateId(e))},S.prototype.generateId=function(e){return("/"===e?"":e+"#")+this.engine.id},o(S.prototype),S.prototype.reconnection=function(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection},S.prototype.reconnectionAttempts=function(e){return arguments.length?(this._reconnectionAttempts=e,this):this._reconnectionAttempts},S.prototype.reconnectionDelay=function(e){return arguments.length?(this._reconnectionDelay=e,this.backoff&&this.backoff.setMin(e),this):this._reconnectionDelay},S.prototype.randomizationFactor=function(e){return arguments.length?(this._randomizationFactor=e,this.backoff&&this.backoff.setJitter(e),this):this._randomizationFactor},S.prototype.reconnectionDelayMax=function(e){return arguments.length?(this._reconnectionDelayMax=e,this.backoff&&this.backoff.setMax(e),this):this._reconnectionDelayMax},S.prototype.timeout=function(e){return arguments.length?(this._timeout=e,this):this._timeout},S.prototype.maybeReconnectOnOpen=function(){!this.reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()},S.prototype.open=S.prototype.connect=function(e,t){if(c("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;c("opening %s",this.uri),this.engine=r(this.uri,this.opts);var n=this.engine,s=this;this.readyState="opening",this.skipReconnect=!1;var o=a(n,"open",(function(){s.onopen(),e&&e()})),i=a(n,"error",(function(t){if(c("connect_error"),s.cleanup(),s.readyState="closed",s.emitAll("connect_error",t),e){var n=new Error("Connection error");n.data=t,e(n)}else s.maybeReconnectOnOpen()}));if(!1!==this._timeout){var d=this._timeout;c("connect attempt will timeout after %d",d);var l=setTimeout((function(){c("connect attempt timed out after %d",d),o.destroy(),n.close(),n.emit("error","timeout"),s.emitAll("connect_timeout",d)}),d);this.subs.push({destroy:function(){clearTimeout(l)}})}return this.subs.push(o),this.subs.push(i),this},S.prototype.onopen=function(){c("open"),this.cleanup(),this.readyState="open",this.emit("open");var e=this.engine;this.subs.push(a(e,"data",d(this,"ondata"))),this.subs.push(a(e,"ping",d(this,"onping"))),this.subs.push(a(e,"pong",d(this,"onpong"))),this.subs.push(a(e,"error",d(this,"onerror"))),this.subs.push(a(e,"close",d(this,"onclose"))),this.subs.push(a(this.decoder,"decoded",d(this,"ondecoded")))},S.prototype.onping=function(){this.lastPing=new Date,this.emitAll("ping")},S.prototype.onpong=function(){this.emitAll("pong",new Date-this.lastPing)},S.prototype.ondata=function(e){this.decoder.add(e)},S.prototype.ondecoded=function(e){this.emit("packet",e)},S.prototype.onerror=function(e){c("error",e),this.emitAll("error",e)},S.prototype.socket=function(e,t){var n=this.nsps[e];if(!n){n=new s(this,e,t),this.nsps[e]=n;var r=this;n.on("connecting",o),n.on("connect",(function(){n.id=r.generateId(e)})),this.autoConnect&&o()}function o(){~l(r.connecting,n)||r.connecting.push(n)}return n},S.prototype.destroy=function(e){var t=l(this.connecting,e);~t&&this.connecting.splice(t,1),this.connecting.length||this.close()},S.prototype.packet=function(e){c("writing packet %j",e);var t=this;e.query&&0===e.type&&(e.nsp+="?"+e.query),t.encoding?t.packetBuffer.push(e):(t.encoding=!0,this.encoder.encode(e,(function(n){for(var r=0;r<n.length;r++)t.engine.write(n[r],e.options);t.encoding=!1,t.processPacketQueue()})))},S.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var e=this.packetBuffer.shift();this.packet(e)}},S.prototype.cleanup=function(){c("cleanup");for(var e=this.subs.length,t=0;t<e;t++){this.subs.shift().destroy()}this.packetBuffer=[],this.encoding=!1,this.lastPing=null,this.decoder.destroy()},S.prototype.close=S.prototype.disconnect=function(){c("disconnect"),this.skipReconnect=!0,this.reconnecting=!1,"opening"===this.readyState&&this.cleanup(),this.backoff.reset(),this.readyState="closed",this.engine&&this.engine.close()},S.prototype.onclose=function(e){c("onclose"),this.cleanup(),this.backoff.reset(),this.readyState="closed",this.emit("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()},S.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var e=this;if(this.backoff.attempts>=this._reconnectionAttempts)c("reconnect failed"),this.backoff.reset(),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var t=this.backoff.duration();c("will wait %dms before reconnect attempt",t),this.reconnecting=!0;var n=setTimeout((function(){e.skipReconnect||(c("attempting reconnect"),e.emitAll("reconnect_attempt",e.backoff.attempts),e.emitAll("reconnecting",e.backoff.attempts),e.skipReconnect||e.open((function(t){t?(c("reconnect attempt error"),e.reconnecting=!1,e.reconnect(),e.emitAll("reconnect_error",t.data)):(c("reconnect success"),e.onreconnect())})))}),t);this.subs.push({destroy:function(){clearTimeout(n)}})}},S.prototype.onreconnect=function(){var e=this.backoff.attempts;this.reconnecting=!1,this.backoff.reset(),this.updateSocketIds(),this.emitAll("reconnect",e)}},55:function(e,t,n){var r=n(44),s=n(99),o=n(102),i=n(103);t.polling=function(e){var t=!1,n=!1,i=!1!==e.jsonp;if("undefined"!=typeof location){var a="https:"===location.protocol,d=location.port;d||(d=a?443:80),t=e.hostname!==location.hostname||d!==e.port,n=e.secure!==a}if(e.xdomain=t,e.xscheme=n,"open"in new r(e)&&!e.forceJSONP)return new s(e);if(!i)throw new Error("JSONP disabled");return new o(e)},t.websocket=i},57:function(e,t,n){var r=n(45),s=n(20),o=n(25),i=n(21),a=n(37),d=n(18)("engine.io-client:polling");e.exports=l;var c=null!=new(n(44))({xdomain:!1}).responseType;function l(e){var t=e&&e.forceBase64;c&&!t||(this.supportsBinary=!1),r.call(this,e)}i(l,r),l.prototype.name="polling",l.prototype.doOpen=function(){this.poll()},l.prototype.pause=function(e){var t=this;function n(){d("paused"),t.readyState="paused",e()}if(this.readyState="pausing",this.polling||!this.writable){var r=0;this.polling&&(d("we are currently polling - waiting to pause"),r++,this.once("pollComplete",(function(){d("pre-pause polling complete"),--r||n()}))),this.writable||(d("we are currently writing - waiting to pause"),r++,this.once("drain",(function(){d("pre-pause writing complete"),--r||n()})))}else n()},l.prototype.poll=function(){d("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},l.prototype.onData=function(e){var t=this;d("polling got data %s",e);o.decodePayload(e,this.socket.binaryType,(function(e,n,r){if("opening"===t.readyState&&t.onOpen(),"close"===e.type)return t.onClose(),!1;t.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():d('ignoring poll - transport state "%s"',this.readyState))},l.prototype.doClose=function(){var e=this;function t(){d("writing close packet"),e.write([{type:"close"}])}"open"===this.readyState?(d("transport open - closing"),t()):(d("transport not open - deferring close"),this.once("open",t))},l.prototype.write=function(e){var t=this;this.writable=!1;var n=function(){t.writable=!0,t.emit("drain")};o.encodePayload(e,this.supportsBinary,(function(e){t.doWrite(e,n)}))},l.prototype.uri=function(){var e=this.query||{},t=this.secure?"https":"http",n="";return!1!==this.timestampRequests&&(e[this.timestampParam]=a()),this.supportsBinary||e.sid||(e.b64=1),e=s.encode(e),this.port&&("https"===t&&443!==Number(this.port)||"http"===t&&80!==Number(this.port))&&(n=":"+this.port),e.length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e}},62:function(e,t,n){var r=n(24),s=n(19),o=n(63),i=n(64),a=n(39),d=n(18)("socket.io-client:socket"),c=n(20),l=n(36);e.exports=S;var u={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1},E=s.prototype.emit;function S(e,t,n){this.io=e,this.nsp=t,this.json=this,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,this.flags={},n&&n.query&&(this.query=n.query),this.io.autoConnect&&this.open()}s(S.prototype),S.prototype.subEvents=function(){if(!this.subs){var e=this.io;this.subs=[i(e,"open",a(this,"onopen")),i(e,"packet",a(this,"onpacket")),i(e,"close",a(this,"onclose"))]}},S.prototype.open=S.prototype.connect=function(){return this.connected||(this.subEvents(),this.io.open(),"open"===this.io.readyState&&this.onopen(),this.emit("connecting")),this},S.prototype.send=function(){var e=o(arguments);return e.unshift("message"),this.emit.apply(this,e),this},S.prototype.emit=function(e){if(u.hasOwnProperty(e))return E.apply(this,arguments),this;var t=o(arguments),n={type:(void 0!==this.flags.binary?this.flags.binary:l(t))?r.BINARY_EVENT:r.EVENT,data:t,options:{}};return n.options.compress=!this.flags||!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(d("emitting packet with ack id %d",this.ids),this.acks[this.ids]=t.pop(),n.id=this.ids++),this.connected?this.packet(n):this.sendBuffer.push(n),this.flags={},this},S.prototype.packet=function(e){e.nsp=this.nsp,this.io.packet(e)},S.prototype.onopen=function(){if(d("transport is open - connecting"),"/"!==this.nsp)if(this.query){var e="object"==typeof this.query?c.encode(this.query):this.query;d("sending connect packet with query %s",e),this.packet({type:r.CONNECT,query:e})}else this.packet({type:r.CONNECT})},S.prototype.onclose=function(e){d("close (%s)",e),this.connected=!1,this.disconnected=!0,delete this.id,this.emit("disconnect",e)},S.prototype.onpacket=function(e){var t=e.nsp===this.nsp,n=e.type===r.ERROR&&"/"===e.nsp;if(t||n)switch(e.type){case r.CONNECT:this.onconnect();break;case r.EVENT:case r.BINARY_EVENT:this.onevent(e);break;case r.ACK:case r.BINARY_ACK:this.onack(e);break;case r.DISCONNECT:this.ondisconnect();break;case r.ERROR:this.emit("error",e.data)}},S.prototype.onevent=function(e){var t=e.data||[];d("emitting event %j",t),null!=e.id&&(d("attaching ack callback to event"),t.push(this.ack(e.id))),this.connected?E.apply(this,t):this.receiveBuffer.push(t)},S.prototype.ack=function(e){var t=this,n=!1;return function(){if(!n){n=!0;var s=o(arguments);d("sending ack %j",s),t.packet({type:l(s)?r.BINARY_ACK:r.ACK,id:e,data:s})}}},S.prototype.onack=function(e){var t=this.acks[e.id];"function"==typeof t?(d("calling ack %s with %j",e.id,e.data),t.apply(this,e.data),delete this.acks[e.id]):d("bad ack %s",e.id)},S.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},S.prototype.emitBuffered=function(){var e;for(e=0;e<this.receiveBuffer.length;e++)E.apply(this,this.receiveBuffer[e]);for(this.receiveBuffer=[],e=0;e<this.sendBuffer.length;e++)this.packet(this.sendBuffer[e]);this.sendBuffer=[]},S.prototype.ondisconnect=function(){d("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},S.prototype.destroy=function(){if(this.subs){for(var e=0;e<this.subs.length;e++)this.subs[e].destroy();this.subs=null}this.io.destroy(this)},S.prototype.close=S.prototype.disconnect=function(){return this.connected&&(d("performing disconnect (%s)",this.nsp),this.packet({type:r.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this},S.prototype.compress=function(e){return this.flags.compress=e,this},S.prototype.binary=function(e){return this.flags.binary=e,this}},64:function(e,t){e.exports=function(e,t,n){return e.on(t,n),{destroy:function(){e.removeListener(t,n)}}}},86:function(e,t,n){var r=n(87),s=n(24),o=n(54),i=n(18)("socket.io-client");e.exports=t=d;var a=t.managers={};function d(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var n,s=r(e),d=s.source,c=s.id,l=s.path,u=a[c]&&l in a[c].nsps;return t.forceNew||t["force new connection"]||!1===t.multiplex||u?(i("ignoring socket cache for %s",d),n=o(d,t)):(a[c]||(i("new io instance for %s",d),a[c]=o(d,t)),n=a[c]),s.query&&!t.query&&(t.query=s.query),n.socket(s.path,t)}t.protocol=s.protocol,t.connect=d,t.Manager=n(54),t.Socket=n(62)},87:function(e,t,n){var r=n(33),s=n(18)("socket.io-client:url");e.exports=function(e,t){var n=e;t=t||"undefined"!=typeof location&&location,null==e&&(e=t.protocol+"//"+t.host);"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?t.protocol+e:t.host+e),/^(https?|wss?):\/\//.test(e)||(s("protocol-less url %s",e),e=void 0!==t?t.protocol+"//"+e:"https://"+e),s("parse %s",e),n=r(e));n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443"));n.path=n.path||"/";var o=-1!==n.host.indexOf(":")?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+o+":"+n.port,n.href=n.protocol+"://"+o+(t&&t.port===n.port?"":":"+n.port),n}},88:function(e,t,n){function r(e){var n;function r(){if(r.enabled){var e=r,s=+new Date,o=s-(n||s);e.diff=o,e.prev=n,e.curr=s,n=s;for(var i=new Array(arguments.length),a=0;a<i.length;a++)i[a]=arguments[a];i[0]=t.coerce(i[0]),"string"!=typeof i[0]&&i.unshift("%O");var d=0;i[0]=i[0].replace(/%([a-zA-Z%])/g,(function(n,r){if("%%"===n)return n;d++;var s=t.formatters[r];if("function"==typeof s){var o=i[d];n=s.call(e,o),i.splice(d,1),d--}return n})),t.formatArgs.call(e,i);var c=r.log||t.log||console.log.bind(console);c.apply(e,i)}}return r.namespace=e,r.enabled=t.enabled(e),r.useColors=t.useColors(),r.color=function(e){var n,r=0;for(n in e)r=(r<<5)-r+e.charCodeAt(n),r|=0;return t.colors[Math.abs(r)%t.colors.length]}(e),r.destroy=s,"function"==typeof t.init&&t.init(r),t.instances.push(r),r}function s(){var e=t.instances.indexOf(this);return-1!==e&&(t.instances.splice(e,1),!0)}(t=e.exports=r.debug=r.default=r).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){var n;t.save(e),t.names=[],t.skips=[];var r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(n=0;n<s;n++)r[n]&&("-"===(e=r[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")));for(n=0;n<t.instances.length;n++){var o=t.instances[n];o.enabled=t.enabled(o.namespace)}},t.enabled=function(e){if("*"===e[e.length-1])return!0;var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=n(89),t.instances=[],t.names=[],t.skips=[],t.formatters={}},89:function(e,t){var n=1e3,r=6e4,s=60*r,o=24*s;function i(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}e.exports=function(e,t){t=t||{};var a,d=typeof e;if("string"===d&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var i=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*i;case"days":case"day":case"d":return i*o;case"hours":case"hour":case"hrs":case"hr":case"h":return i*s;case"minutes":case"minute":case"mins":case"min":case"m":return i*r;case"seconds":case"second":case"secs":case"sec":case"s":return i*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}(e);if("number"===d&&!1===isNaN(e))return t.long?i(a=e,o,"day")||i(a,s,"hour")||i(a,r,"minute")||i(a,n,"second")||a+" ms":function(e){if(e>=o)return Math.round(e/o)+"d";if(e>=s)return Math.round(e/s)+"h";if(e>=r)return Math.round(e/r)+"m";if(e>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},97:function(e,t,n){e.exports=n(98),e.exports.parser=n(25)},98:function(e,t,n){var r=n(55),s=n(19),o=n(18)("engine.io-client:socket"),i=n(38),a=n(25),d=n(33),c=n(20);function l(e,t){if(!(this instanceof l))return new l(e,t);t=t||{},e&&"object"==typeof e&&(t=e,e=null),e?(e=d(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=d(t.host).host),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.agent=t.agent||!1,this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?443:80),this.query=t.query||{},"string"==typeof this.query&&(this.query=c.decode(this.query)),this.upgrade=!1!==t.upgrade,this.path=(t.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!t.forceJSONP,this.jsonp=!1!==t.jsonp,this.forceBase64=!!t.forceBase64,this.enablesXDR=!!t.enablesXDR,this.timestampParam=t.timestampParam||"t",this.timestampRequests=t.timestampRequests,this.transports=t.transports||["polling","websocket"],this.transportOptions=t.transportOptions||{},this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.policyPort=t.policyPort||843,this.rememberUpgrade=t.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=t.onlyBinaryUpgrades,this.perMessageDeflate=!1!==t.perMessageDeflate&&(t.perMessageDeflate||{}),!0===this.perMessageDeflate&&(this.perMessageDeflate={}),this.perMessageDeflate&&null==this.perMessageDeflate.threshold&&(this.perMessageDeflate.threshold=1024),this.pfx=t.pfx||null,this.key=t.key||null,this.passphrase=t.passphrase||null,this.cert=t.cert||null,this.ca=t.ca||null,this.ciphers=t.ciphers||null,this.rejectUnauthorized=void 0===t.rejectUnauthorized||t.rejectUnauthorized,this.forceNode=!!t.forceNode,this.isReactNative="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase(),("undefined"==typeof self||this.isReactNative)&&(t.extraHeaders&&Object.keys(t.extraHeaders).length>0&&(this.extraHeaders=t.extraHeaders),t.localAddress&&(this.localAddress=t.localAddress)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingIntervalTimer=null,this.pingTimeoutTimer=null,this.open()}e.exports=l,l.priorWebsocketSuccess=!1,s(l.prototype),l.protocol=a.protocol,l.Socket=l,l.Transport=n(45),l.transports=n(55),l.parser=n(25),l.prototype.createTransport=function(e){o('creating transport "%s"',e);var t=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}(this.query);t.EIO=a.protocol,t.transport=e;var n=this.transportOptions[e]||{};return this.id&&(t.sid=this.id),new r[e]({query:t,socket:this,agent:n.agent||this.agent,hostname:n.hostname||this.hostname,port:n.port||this.port,secure:n.secure||this.secure,path:n.path||this.path,forceJSONP:n.forceJSONP||this.forceJSONP,jsonp:n.jsonp||this.jsonp,forceBase64:n.forceBase64||this.forceBase64,enablesXDR:n.enablesXDR||this.enablesXDR,timestampRequests:n.timestampRequests||this.timestampRequests,timestampParam:n.timestampParam||this.timestampParam,policyPort:n.policyPort||this.policyPort,pfx:n.pfx||this.pfx,key:n.key||this.key,passphrase:n.passphrase||this.passphrase,cert:n.cert||this.cert,ca:n.ca||this.ca,ciphers:n.ciphers||this.ciphers,rejectUnauthorized:n.rejectUnauthorized||this.rejectUnauthorized,perMessageDeflate:n.perMessageDeflate||this.perMessageDeflate,extraHeaders:n.extraHeaders||this.extraHeaders,forceNode:n.forceNode||this.forceNode,localAddress:n.localAddress||this.localAddress,requestTimeout:n.requestTimeout||this.requestTimeout,protocols:n.protocols||void 0,isReactNative:this.isReactNative})},l.prototype.open=function(){var e;if(this.rememberUpgrade&&l.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length){var t=this;return void setTimeout((function(){t.emit("error","No transports available")}),0)}e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)},l.prototype.setTransport=function(e){o("setting transport %s",e.name);var t=this;this.transport&&(o("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=e,e.on("drain",(function(){t.onDrain()})).on("packet",(function(e){t.onPacket(e)})).on("error",(function(e){t.onError(e)})).on("close",(function(){t.onClose("transport close")}))},l.prototype.probe=function(e){o('probing transport "%s"',e);var t=this.createTransport(e,{probe:1}),n=!1,r=this;function s(){if(r.onlyBinaryUpgrades){var s=!this.supportsBinary&&r.transport.supportsBinary;n=n||s}n||(o('probe transport "%s" opened',e),t.send([{type:"ping",data:"probe"}]),t.once("packet",(function(s){if(!n)if("pong"===s.type&&"probe"===s.data){if(o('probe transport "%s" pong',e),r.upgrading=!0,r.emit("upgrading",t),!t)return;l.priorWebsocketSuccess="websocket"===t.name,o('pausing current transport "%s"',r.transport.name),r.transport.pause((function(){n||"closed"!==r.readyState&&(o("changing transport and sending upgrade packet"),E(),r.setTransport(t),t.send([{type:"upgrade"}]),r.emit("upgrade",t),t=null,r.upgrading=!1,r.flush())}))}else{o('probe transport "%s" failed',e);var i=new Error("probe error");i.transport=t.name,r.emit("upgradeError",i)}})))}function i(){n||(n=!0,E(),t.close(),t=null)}function a(n){var s=new Error("probe error: "+n);s.transport=t.name,i(),o('probe transport "%s" failed because of error: %s',e,n),r.emit("upgradeError",s)}function d(){a("transport closed")}function c(){a("socket closed")}function u(e){t&&e.name!==t.name&&(o('"%s" works - aborting "%s"',e.name,t.name),i())}function E(){t.removeListener("open",s),t.removeListener("error",a),t.removeListener("close",d),r.removeListener("close",c),r.removeListener("upgrading",u)}l.priorWebsocketSuccess=!1,t.once("open",s),t.once("error",a),t.once("close",d),this.once("close",c),this.once("upgrading",u),t.open()},l.prototype.onOpen=function(){if(o("socket open"),this.readyState="open",l.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.upgrade&&this.transport.pause){o("starting upgrade probes");for(var e=0,t=this.upgrades.length;e<t;e++)this.probe(this.upgrades[e])}},l.prototype.onPacket=function(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(o('socket receive: type "%s", data "%s"',e.type,e.data),this.emit("packet",e),this.emit("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"pong":this.setPing(),this.emit("pong");break;case"error":var t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else o('packet received with socket readyState "%s"',this.readyState)},l.prototype.onHandshake=function(e){this.emit("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.onOpen(),"closed"!==this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},l.prototype.onHeartbeat=function(e){clearTimeout(this.pingTimeoutTimer);var t=this;t.pingTimeoutTimer=setTimeout((function(){"closed"!==t.readyState&&t.onClose("ping timeout")}),e||t.pingInterval+t.pingTimeout)},l.prototype.setPing=function(){var e=this;clearTimeout(e.pingIntervalTimer),e.pingIntervalTimer=setTimeout((function(){o("writing ping packet - expecting pong within %sms",e.pingTimeout),e.ping(),e.onHeartbeat(e.pingTimeout)}),e.pingInterval)},l.prototype.ping=function(){var e=this;this.sendPacket("ping",(function(){e.emit("ping")}))},l.prototype.onDrain=function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()},l.prototype.flush=function(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(o("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},l.prototype.write=l.prototype.send=function(e,t,n){return this.sendPacket("message",e,t,n),this},l.prototype.sendPacket=function(e,t,n,r){if("function"==typeof t&&(r=t,t=void 0),"function"==typeof n&&(r=n,n=null),"closing"!==this.readyState&&"closed"!==this.readyState){(n=n||{}).compress=!1!==n.compress;var s={type:e,data:t,options:n};this.emit("packetCreate",s),this.writeBuffer.push(s),r&&this.once("flush",r),this.flush()}},l.prototype.close=function(){if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";var e=this;this.writeBuffer.length?this.once("drain",(function(){this.upgrading?r():t()})):this.upgrading?r():t()}function t(){e.onClose("forced close"),o("socket closing - telling transport to close"),e.transport.close()}function n(){e.removeListener("upgrade",n),e.removeListener("upgradeError",n),t()}function r(){e.once("upgrade",n),e.once("upgradeError",n)}return this},l.prototype.onError=function(e){o("socket error %j",e),l.priorWebsocketSuccess=!1,this.emit("error",e),this.onClose("transport error",e)},l.prototype.onClose=function(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){o('socket close with reason: "%s"',e);clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",e,t),this.writeBuffer=[],this.prevBufferLen=0}},l.prototype.filterUpgrades=function(e){for(var t=[],n=0,r=e.length;n<r;n++)~i(this.transports,e[n])&&t.push(e[n]);return t}},99:function(e,t,n){var r=n(44),s=n(57),o=n(19),i=n(21),a=n(18)("engine.io-client:polling-xhr");function d(){}function c(e){if(s.call(this,e),this.requestTimeout=e.requestTimeout,this.extraHeaders=e.extraHeaders,"undefined"!=typeof location){var t="https:"===location.protocol,n=location.port;n||(n=t?443:80),this.xd="undefined"!=typeof location&&e.hostname!==location.hostname||n!==e.port,this.xs=e.secure!==t}}function l(e){this.method=e.method||"GET",this.uri=e.uri,this.xd=!!e.xd,this.xs=!!e.xs,this.async=!1!==e.async,this.data=void 0!==e.data?e.data:null,this.agent=e.agent,this.isBinary=e.isBinary,this.supportsBinary=e.supportsBinary,this.enablesXDR=e.enablesXDR,this.requestTimeout=e.requestTimeout,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.extraHeaders=e.extraHeaders,this.create()}if(e.exports=c,e.exports.Request=l,i(c,s),c.prototype.supportsBinary=!0,c.prototype.request=function(e){return(e=e||{}).uri=this.uri(),e.xd=this.xd,e.xs=this.xs,e.agent=this.agent||!1,e.supportsBinary=this.supportsBinary,e.enablesXDR=this.enablesXDR,e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized,e.requestTimeout=this.requestTimeout,e.extraHeaders=this.extraHeaders,new l(e)},c.prototype.doWrite=function(e,t){var n="string"!=typeof e&&void 0!==e,r=this.request({method:"POST",data:e,isBinary:n}),s=this;r.on("success",t),r.on("error",(function(e){s.onError("xhr post error",e)})),this.sendXhr=r},c.prototype.doPoll=function(){a("xhr poll");var e=this.request(),t=this;e.on("data",(function(e){t.onData(e)})),e.on("error",(function(e){t.onError("xhr poll error",e)})),this.pollXhr=e},o(l.prototype),l.prototype.create=function(){var e={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized;var t=this.xhr=new r(e),n=this;try{a("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.extraHeaders)for(var s in t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0),this.extraHeaders)this.extraHeaders.hasOwnProperty(s)&&t.setRequestHeader(s,this.extraHeaders[s])}catch(e){}if("POST"===this.method)try{this.isBinary?t.setRequestHeader("Content-type","application/octet-stream"):t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=!0),this.requestTimeout&&(t.timeout=this.requestTimeout),this.hasXDR()?(t.onload=function(){n.onLoad()},t.onerror=function(){n.onError(t.responseText)}):t.onreadystatechange=function(){if(2===t.readyState)try{var e=t.getResponseHeader("Content-Type");n.supportsBinary&&"application/octet-stream"===e&&(t.responseType="arraybuffer")}catch(e){}4===t.readyState&&(200===t.status||1223===t.status?n.onLoad():setTimeout((function(){n.onError(t.status)}),0))},a("xhr data %s",this.data),t.send(this.data)}catch(e){return void setTimeout((function(){n.onError(e)}),0)}"undefined"!=typeof document&&(this.index=l.requestsCount++,l.requests[this.index]=this)},l.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},l.prototype.onData=function(e){this.emit("data",e),this.onSuccess()},l.prototype.onError=function(e){this.emit("error",e),this.cleanup(!0)},l.prototype.cleanup=function(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=d:this.xhr.onreadystatechange=d,e)try{this.xhr.abort()}catch(e){}"undefined"!=typeof document&&delete l.requests[this.index],this.xhr=null}},l.prototype.onLoad=function(){var e;try{var t;try{t=this.xhr.getResponseHeader("Content-Type")}catch(e){}e="application/octet-stream"===t&&this.xhr.response||this.xhr.responseText}catch(e){this.onError(e)}null!=e&&this.onData(e)},l.prototype.hasXDR=function(){return"undefined"!=typeof XDomainRequest&&!this.xs&&this.enablesXDR},l.prototype.abort=function(){this.cleanup()},l.requestsCount=0,l.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",E);else if("function"==typeof addEventListener){var u="onpagehide"in self?"pagehide":"unload";addEventListener(u,E,!1)}function E(){for(var e in l.requests)l.requests.hasOwnProperty(e)&&l.requests[e].abort()}}}]);
//# sourceMappingURL=skylink.chunk.c9b8ec9db1c6591d6b8e.js.map