(self.webpackChunkVClerkWidget=self.webpackChunkVClerkWidget||[]).push([[429],{8914:(e,t,n)=>{"use strict";n.d(t,{XV:()=>r,wD:()=>ft,ZP:()=>di});var s={};n.r(s),n.d(s,{BYE:()=>ee,CANDIDATES_GATHERED:()=>h,CANDIDATE_GENERATION_STATE:()=>_,CANDIDATE_PROCESSING_STATE:()=>A,CHANNEL_CLOSE:()=>G,CHANNEL_ERROR:()=>F,CHANNEL_MESSAGE:()=>U,CHANNEL_OPEN:()=>L,CHANNEL_REOPEN:()=>b,CHANNEL_RETRY:()=>B,DATA_CHANNEL_STATE:()=>g,DATA_STREAM_STATE:()=>N,DATA_TRANSFER_STATE:()=>C,ENCRYPT_SECRETS_UPDATED:()=>oe,GET_CONNECTION_STATUS_STATE_CHANGE:()=>Q,GET_PEERS_STATE_CHANGE:()=>v,HANDSHAKE_PROGRESS:()=>m,ICE_CONNECTION_STATE:()=>z,INTRODUCE_STATE_CHANGE:()=>X,LOCAL_MEDIA_MUTED:()=>Y,LOGGED_ON_CONSOLE:()=>ne,MEDIA_ACCESS_ERROR:()=>J,MEDIA_ACCESS_FALLBACK:()=>x,MEDIA_ACCESS_REQUIRED:()=>W,MEDIA_ACCESS_STOPPED:()=>$,MEDIA_ACCESS_SUCCESS:()=>K,MEDIA_INFO_DELETED:()=>se,ON_INCOMING_DATA:()=>D,ON_INCOMING_DATA_REQUEST:()=>f,ON_INCOMING_DATA_STREAM:()=>M,ON_INCOMING_DATA_STREAM_STARTED:()=>P,ON_INCOMING_DATA_STREAM_STOPPED:()=>y,ON_INCOMING_MESSAGE:()=>p,ON_INCOMING_SCREEN_STREAM:()=>c,ON_INCOMING_STREAM:()=>l,PEER_CONNECTION_STATE:()=>I,PEER_JOINED:()=>R,PEER_LEFT:()=>u,PEER_UPDATED:()=>S,PERSISTENT_MESSAGE_STATE:()=>ie,READY_STATE_CHANGE:()=>Z,RECORDING_STATE:()=>j,ROOM_LOCK:()=>q,ROOM_REJOIN:()=>ae,RTMP_STATE:()=>te,SERVER_PEER_JOINED:()=>T,SERVER_PEER_LEFT:()=>O,SESSION_DISCONNECT:()=>k,SOCKET_ERROR:()=>V,STORED_MESSAGES:()=>re,STREAM_ENDED:()=>E,STREAM_MUTED:()=>w,SYSTEM_ACTION:()=>H});var r={};n.r(r),n.d(r,{API_VERSION:()=>ut,AUDIO_CODEC:()=>xe,AUTH_STATE:()=>pe,BINARY_FILE_SIZE:()=>Qe,BROWSER_AGENT:()=>gt,BUNDLE_POLICY:()=>De,CANDIDATE_GENERATION_STATE:()=>Te,CANDIDATE_PROCESSING_STATE:()=>Oe,CHUNK_DATAURL_SIZE:()=>qe,CHUNK_FILE_SIZE:()=>Ye,DATA_CHANNEL_MESSAGE_ERROR:()=>Ee,DATA_CHANNEL_STATE:()=>le,DATA_CHANNEL_TYPE:()=>ce,DATA_STREAM_STATE:()=>me,DATA_TRANSFER_DATA_TYPE:()=>Se,DATA_TRANSFER_SESSION_TYPE:()=>Ie,DATA_TRANSFER_STATE:()=>ge,DATA_TRANSFER_TYPE:()=>ue,DC_PROTOCOL_TYPE:()=>Xe,DT_PROTOCOL_VERSION:()=>Re,EVENTS:()=>At,GET_CONNECTION_STATUS_STATE:()=>Ne,GET_PEERS_STATE:()=>ye,GROUP_MESSAGE_LIST:()=>tt,HANDSHAKE_PROGRESS:()=>Pe,ICE_CONNECTION_STATE:()=>Ae,INTRODUCE_STATE:()=>ve,LOG_LEVEL:()=>Ue,MEDIA_ACCESS_FALLBACK_STATE:()=>Ke,MEDIA_INFO:()=>Et,MEDIA_SOURCE:()=>We,MEDIA_STATE:()=>ct,MEDIA_STATUS:()=>ot,MEDIA_TYPE:()=>at,MOZ_BINARY_FILE_SIZE:()=>Ze,MOZ_CHUNK_FILE_SIZE:()=>Je,PEER_CERTIFICATE:()=>Me,PEER_CONNECTION_STATE:()=>he,PEER_TYPE:()=>pt,READY_STATE_CHANGE:()=>Le,READY_STATE_CHANGE_ERROR:()=>be,RECORDING_STATE:()=>je,REGIONAL_SERVER:()=>Ge,RTCP_MUX_POLICY:()=>fe,RTMP_STATE:()=>rt,SDK_NAME:()=>Rt,SDK_VERSION:()=>St,SDP_SEMANTICS:()=>st,SERVER_PEER_TYPE:()=>Ce,SIGNALING_VERSION:()=>It,SIG_MESSAGE_TYPE:()=>ze,SM_PROTOCOL_VERSION:()=>Ve,SOCKET_ERROR:()=>Fe,SOCKET_EVENTS:()=>mt,SOCKET_FALLBACK:()=>Be,SOCKET_TYPE:()=>Tt,STATES:()=>Ot,STREAM_STATUS:()=>et,SYSTEM_ACTION:()=>ke,SYSTEM_ACTION_REASON:()=>we,TAGS:()=>it,TRACK_KIND:()=>lt,TRACK_READY_STATE:()=>dt,TURN_TRANSPORT:()=>_e,VIDEO_CODEC:()=>He,VIDEO_QUALITY:()=>nt,VIDEO_RESOLUTION:()=>$e});var o=n(6809),i=n.n(o),a=n(8117);a.Z.options=a.Z.options||{},a.Z.onwebrtcreadyDone=!1,a.Z.WebRTCPlugin={plugin:null},a.Z._onwebrtcreadies=[],a.Z.webRTCReady=function(e){if("function"!=typeof e)throw new Error("Callback provided is not a function");var t=function(){"function"==typeof window.require&&"function"==typeof a.Z._defineMediaSourcePolyfill&&a.Z._defineMediaSourcePolyfill(),e(null!==a.Z.WebRTCPlugin.plugin)};!0===a.Z.onwebrtcreadyDone?t():a.Z._onwebrtcreadies.push(t)},a.Z.maybeThroughWebRTCReady=function(){a.Z.onwebrtcreadyDone||(a.Z.onwebrtcreadyDone=!0,a.Z._onwebrtcreadies.length?a.Z._onwebrtcreadies.forEach((function(e){"function"==typeof e&&e(null!==a.Z.WebRTCPlugin.plugin)})):"function"==typeof a.Z.onwebrtcready&&a.Z.onwebrtcready(null!==a.Z.WebRTCPlugin.plugin))},window.webrtcDetectedBrowser=null,window.webrtcDetectedVersion=null,window.webrtcMinimumVersion=null,window.webrtcDetectedDCSupport=null,a.Z.parseWebrtcDetectedBrowser=function(){var e=null;if(window.navigator.userAgent.match(/React-Native/gi)||navigator.userAgent.match(/React-Native/gi))window.webrtcDetectedBrowser="react-native",window.webrtcDetectedVersion="",window.webrtcMinimumVersion=0,window.webrtcDetectedType="react-native",window.webrtcDetectedDCSupport=null;else if(window.opr&&opr.addons||window.opera||navigator.userAgent.indexOf(" OPR/")>=0)e=navigator.userAgent.match(/OPR\/(\d+)/i)||[],window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=26,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport="SCTP";else if(navigator.userAgent.match(/Bowser\/[0-9.]*/g)){e=navigator.userAgent.match(/Bowser\/[0-9.]*/g)||[];var t=parseInt((navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[])[2]||"0",10);window.webrtcDetectedBrowser="bowser",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=0,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=t>30?"SCTP":"RTP"}else if(navigator.userAgent.indexOf("OPiOS")>0)e=navigator.userAgent.match(/OPiOS\/([0-9]+)\./),window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("CriOS")>0)e=navigator.userAgent.match(/CriOS\/([0-9]+)\./)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedBrowser="chrome",window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("FxiOS")>0)e=navigator.userAgent.match(/FxiOS\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(document.documentMode)e=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedBrowser="IE",window.webrtcDetectedVersion=parseInt(e[1],10),window.webrtcMinimumVersion=9,window.webrtcDetectedType="plugin",window.webrtcDetectedDCSupport="SCTP",webrtcDetectedVersion||(e=/\bMSIE[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10));else if(window.StyleMedia||navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e=navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)||[],window.webrtcDetectedBrowser="edge",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=13.10547,window.webrtcDetectedType="ms",window.webrtcDetectedDCSupport=null;else if("undefined"!=typeof InstallTrigger||navigator.userAgent.indexOf("irefox")>0)e=navigator.userAgent.match(/Firefox\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=33,window.webrtcDetectedType="moz",window.webrtcDetectedDCSupport="SCTP";else if(window.chrome&&window.chrome.webstore||navigator.userAgent.indexOf("Chrom")>0)e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[],window.webrtcDetectedBrowser="chrome",window.webrtcDetectedVersion=parseInt(e[2]||"0",10),window.webrtcMinimumVersion=38,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=window.webrtcDetectedVersion>30?"SCTP":"RTP";else if(/constructor/i.test(window.HTMLElement)||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString()||navigator.userAgent.match(/AppleWebKit\/(\d+)\./)||navigator.userAgent.match(/Version\/(\d+).(\d+)/)){e=navigator.userAgent.match(/version\/(\d+)\.(\d+)/i)||[];var n=navigator.userAgent.match(/AppleWebKit\/(\d+)/i)||[],s=navigator.userAgent.match(/(iPhone|iPad)/gi),r=n.length>=1&&n[1]>=604;if(window.webrtcDetectedBrowser="safari",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=7,s)window.webrtcDetectedType=r?"AppleWebKit":null;else{var o=window.webrtcDetectedVersion,i=parseInt(e[2]||"0",10),d=11==o&&i<2;window.webrtcDetectedType=!r||a.Z.options.forceSafariPlugin&&d?"plugin":"AppleWebKit"}window.webrtcDetectedDCSupport="SCTP"}a.Z.webrtcDetectedBrowser=window.webrtcDetectedBrowser,a.Z.webrtcDetectedVersion=window.webrtcDetectedVersion,a.Z.webrtcMinimumVersion=window.webrtcMinimumVersion,a.Z.webrtcDetectedType=window.webrtcDetectedType,a.Z.webrtcDetectedDCSupport=window.webrtcDetectedDCSupport},a.Z.addExtensions=function(){var e=null,t=null;navigator.mozGetUserMedia?(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}):navigator.webkitGetUserMedia?(e=function(e,t){return a.Z.webrtcDetectedVersion>=43?e.srcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):console.error("Error attaching stream to element."),e},t=function(e,t){return a.Z.webrtcDetectedVersion>=43?e.srcObject=t.srcObject:e.src=t.src,e}):"AppleWebKit"===a.Z.webrtcDetectedType&&(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}),window.attachMediaStream=e,window.reattachMediaStream=t,a.Z.attachMediaStream=e,a.Z.reattachMediaStream=t},a.Z.parseWebrtcDetectedBrowser(),a.Z.addExtensions(),a.Z.maybeThroughWebRTCReady();const d=a.Z,l="onIncomingStream",c="onIncomingScreenStream",E="streamEnded",S="peerUpdated",R="peerJoined",u="peerLeft",I="peerConnectionState",g="dataChannelState",p="onIncomingMessage",m="handshakeProgress",T="serverPeerJoined",O="serverPeerLeft",A="candidateProcessingState",_="candidateGenerationState",h="candidatesGathered",N="dataStreamState",C="dataTransferState",D="onIncomingData",f="onIncomingDataRequest",M="onIncomingDataStream",P="onIncomingDataStreamStarted",y="onIncomingDataStreamStopped",v="getPeersStateChange",k="sessionDisconnect",w="streamMuted",L="channelOpen",b="channelReopen",G="channelClose",U="channelMessage",F="channelError",B="channelRetry",V="socketError",H="systemAction",x="mediaAccessFallback",W="mediaAccessRequired",$="mediaAccessStopped",K="mediaAccessSuccess",j="recordingState",Y="localMediaMuted",J="mediaAccessError",Q="getConnectionStatusStateChange",Z="readyStateChange",q="roomLock",X="introduceStateChange",z="iceConnectionState",ee="bye",te="rtmpState",ne="loggedOnConsole",se="mediaInfoDeleted",re="storedMessages",oe="encryptSecretsUpdated",ie="persistentMessageState",ae="roomRejoin",de=class{constructor(e,t){this.name=e,this.detail=t}},le={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error",CREATE_ERROR:"createError",BUFFERED_AMOUNT_LOW:"bufferedAmountLow",SEND_MESSAGE_ERROR:"sendMessageError"},ce={MESSAGING:"messaging",DATA:"data"},Ee={MESSAGE:"message",TRANSFER:"transfer"},Se={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob",STRING:"string"},Re="0.1.3",ue={UPLOAD:"upload",DOWNLOAD:"download"},Ie={BLOB:"blob",DATA_URL:"dataURL"},ge={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted",USER_REJECTED:"userRejected",USER_UPLOAD_REQUEST:"userRequest",START_ERROR:"startError"},pe={REQUEST:"request",SUCCESS:"success",ERROR:"error"},me={SENDING_STARTED:"sendStart",SENDING_STOPPED:"sendStop",RECEIVING_STARTED:"receiveStart",RECEIVING_STOPPED:"receiveStop",RECEIVED:"received",SENT:"sent",ERROR:"error",START_ERROR:"startError"},Te={NEW:"new",GATHERING:"gathering",COMPLETED:"complete"},Oe={RECEIVED:"received",DROPPED:"dropped",BUFFERED:"buffered",PROCESSING:"processing",PROCESS_SUCCESS:"processSuccess",PROCESS_ERROR:"processError"},Ae={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},_e={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none",ALL:"all"},he={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",CLOSED:"closed",CONNECTING:"connecting",FAILED:"failed",DISCONNECTED:"disconnected",CONNECTED:"connected"},Ne={RETRIEVING:0,RETRIEVE_SUCCESS:1,RETRIEVE_ERROR:-1},Ce={MCU:"mcu"},De={MAX_COMPAT:"max-compat",BALANCED:"balanced",MAX_BUNDLE:"max-bundle",NONE:"none"},fe={REQUIRE:"require",NEGOTIATE:"negotiate"},Me={RSA:"RSA",ECDSA:"ECDSA",AUTO:"AUTO"},Pe={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",ERROR:"error"},ye={ENQUIRED:"enquired",DISPATCHED:"dispatched",RECEIVED:"received"},ve={INTRODUCING:"introducing",ERROR:"error"},ke={WARNING:"warning",REJECT:"reject",LOCKED:"locked"},we={CREDENTIALS_EXPIRED:"oldTimeStamp",CREDENTIALS_ERROR:"credentialError",DUPLICATED_LOGIN:"duplicatedLogin",ROOM_NOT_STARTED:"notStart",EXPIRED:"expired",ROOM_LOCKED:"locked",FAST_MESSAGE:"fastmsg",ROOM_CLOSING:"toclose",ROOM_CLOSED:"roomclose",SERVER_ERROR:"serverError",KEY_ERROR:"keyFailed"},Le={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},be={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NO_MEETING_RECORD_FOUND:4010,API_OVER_SEAT_LIMIT:4020,API_RETRIEVAL_FAILED:4021,API_WRONG_ACCESS_DOMAIN:5005,XML_HTTP_REQUEST_ERROR:-1,XML_HTTP_NO_REPONSE_ERROR:-2,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,ADAPTER_NO_LOADED:7,PARSE_CODECS:8},Ge={APAC1:"",US1:""},Ue={DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0,NONE:-1},Fe={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},Be={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},Ve="2.1.0",He={AUTO:"auto",VP8:"VP8",H264:"H264",VP9:"VP9"},xe={AUTO:"auto",ISAC:"ISAC",OPUS:"opus",ILBC:"ILBC",G722:"G722",PCMU:"PCMU",PCMA:"PCMA"},We={SCREEN:"screen",WINDOW:"window",TAB:"tab",TAB_AUDIO:"audio",APPLICATION:"application",BROWSER:"browser",CAMERA:"camera"},$e={QQVGA:{width:160,height:120},HQVGA:{width:240,height:160},QVGA:{width:320,height:240},WQVGA:{width:384,height:240},HVGA:{width:480,height:320},VGA:{width:640,height:480},WVGA:{width:768,height:480},FWVGA:{width:854,height:480},SVGA:{width:800,height:600},DVGA:{width:960,height:640},WSVGA:{width:1024,height:576},HD:{width:1280,height:720},HDPLUS:{width:1600,height:900},FHD:{width:1920,height:1080},QHD:{width:2560,height:1440},WQXGAPLUS:{width:3200,height:1800},UHD:{width:3840,height:2160},UHDPLUS:{width:5120,height:2880},FUHD:{width:7680,height:4320},QUHD:{width:15360,height:8640}},Ke={FALLBACKING:0,FALLBACKED:1,ERROR:-1},je={START:0,STOP:1,LINK:2,ERROR:-1},Ye=49152,Je=12288,Qe=65456,Ze=16384,qe=1212,Xe={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},ze={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",CANDIDATE:"candidate",BYE:"bye",REDIRECT:"redirect",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",PUBLIC_MESSAGE:"public",PRIVATE_MESSAGE:"private",STREAM:"stream",GROUP:"group",GET_PEERS:"getPeers",PEER_LIST:"peerList",INTRODUCE:"introduce",INTRODUCE_ERROR:"introduceError",APPROACH:"approach",START_RECORDING:"startRecordingRoom",STOP_RECORDING:"stopRecordingRoom",RECORDING:"recordingEvent",END_OF_CANDIDATES:"endOfCandidates",START_SCREENSHARE:"startScreenshare",START_RTMP:"startRTMP",STOP_RTMP:"stopRTMP",RTMP:"rtmpEvent",MEDIA_INFO_EVENT:"mediaInfoEvent",MESSAGE:"message",GET_STORED_MESSAGES:"getStoredMessages",STORED_MESSAGES:"storedMessages",RESTART:"restart"},et={ENDED:"ended"},tt=[ze.STREAM,ze.UPDATE_USER,ze.PUBLIC_MESSAGE],nt={HD:{video:3200,audio:150},HQ:{video:1200,audio:80},SQ:{video:800,audio:30},LQ:{video:400,audio:20}},st={PLAN_B:"plan-b",UNIFIED:"unified-plan"},rt={START:0,STOP:1,ERROR:-1},ot={MUTED:0,ACTIVE:1,UNAVAILABLE:-1},it={SKYLINK_EVENT:"SKYLINK EVENT",SKYLINK_ERROR:"SKYLINK ERROR",STATS_MODULE:"RTCStatsReport",SESSION_DESCRIPTION:"RTCSessionDescription",PEER_CONNECTION:"RTCPeerConnection",CANDIDATE_HANDLER:"RTCIceCandidate",DATA_CHANNEL:"RTCDataChannel",SIG_SERVER:"SIG SERVER",PEER_MEDIA:"PEER MEDIA",PEER_INFORMATION:"PEER INFORMATION",ROOM:"ROOM",RECORDING:"RECORDING",MEDIA_STREAM:"MEDIA STREAM",MESSAGING:"MESSAGING",ASYNC_MESSAGING:"ASYNC MESSAGING",ENCRYPTED_MESSAGING:"ENCRYPTED MESSAGING",STATS:"STATS"},at={AUDIO_MIC:"audioMic",VIDEO_CAMERA:"videoCamera",VIDEO_SCREEN:"videoScreen",VIDEO_OTHER:"videoOther",AUDIO:"audio",VIDEO:"video"},dt={LIVE:"live",ENDED:"ended"},lt={AUDIO:"audio",VIDEO:"video"},ct={MUTED:"muted",ACTIVE:"active",STOPPED:"stopped",UNAVAILABLE:"unavailable"},Et={PUBLISHER_ID:"publisherId",MEDIA_ID:"mediaId",MEDIA_TYPE:"mediaType",MEDIA_STATE:"mediaState",TRANSCEIVER_MID:"transceiverMid",MEDIA_META_DATA:"mediaMetaData",SIMULCAST:"simulcast",STREAM_ID:"streamId"},St="2.x.x",Rt={WEB:"Web SDK",ANDROID:"Android SDK",IOS:"iOS SDK",CPP:"C++ SDK"},ut="9.0.0",It="sig-v2",gt={CHROME:"chrome",FIREFOX:"firefox",SAFARI:"safari",REACT_NATIVE:"react-native"},pt={MCU:"MCU"},mt={CONNECT:"connect",DISCONNECT:"disconnect",RECONNECT_ATTEMPT:"reconnect_attempt",RECONNECT_SUCCESS:"reconnect_success",RECONNECT_FAILED:"reconnect_failed",RECONNECT_ERROR:"reconnect_error",MESSAGE:"message",ERROR:"error"},Tt={POLLING:"Polling",WEBSOCKET:"WebSocket",XHR_POLLING:"xhr-polling",JSONP_POLLING:"jsonp-polling"},Ot={SIGNALING:mt},At=s,_t={INIT:{ERRORS:{NO_ADAPTER:"AdapterJS dependency is not loaded or incorrect AdapterJS dependency is used",NO_SOCKET_IO:"Socket.io not loaded - Please load socket.io",NO_FETCH_SUPPORT:"Fetch API is not supported in your browser. Please make sure you are using a modern browser: https://caniuse.com/#search=fetch",NO_APP_KEY:"Please provide an App Key - Get one at console.temasys.io!",AUTH_CORS:"Promise rejected due to CORS forbidden request - Please visit: http://support.temasys.com.sg/support/solutions/articles/12000006761-i-get-a-403-forbidden-access-is-denied-when-i-load-the-application-why-",AUTH_GENERAL:"Promise rejected due to network issue",SOCKET_CREATE_FAILED:"Failed creating socket connection object ->",SOCKET_ERROR_ABORT:"Reconnection aborted as the connection timed out or there no more available ports, transports and final attempts left"},INCOMPATIBLE_BROWSER:"Incompatible browser agent detected",INFO:{API_SUCCESS:"Promise resolved: APP Authenticated Successfully!"}},SOCKET:{ABORT_RECONNECT:"Aborting socket reconnect"},JOIN_ROOM:{ERRORS:{CODEC_SUPPORT:"No audio/video codecs available to start connection"}},ROOM:{ERRORS:{STOP:{SCREEN_SHARE:"Error stopping screenshare"},NOT_IN_ROOM:"User is not in room",NO_PEERS:"No peers in room"},LEAVE_ROOM:{ERROR:"Leave room error --\x3e",NO_PEERS:"No peers in room",DROPPING_HANGUP:"Dropping hang-up from remote peer",LEAVE_ALL_ROOMS:{SUCCESS:"Successfully left all rooms",ERROR:"Leave all rooms error --\x3e"},PEER_LEFT:{START:"Initiating peer left process",SUCCESS:"Successfully completed peer left process",ERROR:"Failed peer left process"},SENDING_BYE:"Sending bye message to all peers",DISCONNECT_SOCKET:{SUCCESS:"Successfully disconnected socket"},REMOVE_STATE:{SUCCESS:"Successfully removed room state"}}},ROOM_STATE:{NOT_FOUND:"Could not retrieve room state for room name/key",LEFT:"Peer left room",NO_ROOM_NAME:"No room name specified"},PEER_INFORMATIONS:{NO_PEER_INFO:"Not able to retrieve Peer Information for peerId:",UPDATE_USER_DATA:"Peer updated userData: ",OUTDATED_MSG:"Dropping outdated status ->",USER_DATA_NOT_JSON:"UserData is not JSON",SET_PEER_PRIORITY_WEIGHT:"Setting peerPriorityWeight with tiebreaker value from inRoom signalling message"},PEER_CONNECTION:{NOT_INITIALISED:"Peer Connection not initialised",CREATE_NEW:"Creating new Peer Connection",NO_PEER_CONNECTION:"No Peer Connection detected",PEER_ID_NOT_FOUND:"Peer Id not found",STATE_CHANGE:"Peer connection state changed ->",STATS_API_UNAVAILABLE:"getStats() API is not available",MCU:"MCU connected",FAILED_STATE:"Peer Connection state: failed",ADD_TRANSCEIVER:"Adding empty transceiver",ERRORS:{REMOVE_TRACK:"Error removing track from peer connection",NOT_FOUND:"Peer Connection not found"},REFRESH_CONNECTION:{START:"Refreshing peer connections",SUCCESS:"Peer Connection refreshed successfully",FAILED:"Peer Connection failed to refresh",COMPLETED:"All Peer Connections refreshed with resolve or errors",RESTART_ICE_UNAVAILABLE:"Dropping iceRestart option as it is not available on the peer connection",NOT_SUPPORTED:"Refresh connection not supported by browser",SEND_RESTART_OFFER:"Sending restart offer message to signaling server",NO_LOCAL_DESCRIPTION:"No localDescription set to connection. There could be a handshaking step error."}},PEER_PRIVILEGED:{not_privileged:"Please upgrade your key to privileged to use this function",no_appkey:"App key is not defined - Please authenticate again",getPeerListFromServer:"Enquired server for peers within the App space"},ICE_CONNECTION:{END_OF_CANDIDATES_SUCCESS:"Signaling of end-of-candidates remote ICE gathering",END_OF_CANDIDATES_FAILURE:"Failed signaling of end-of-candidates remote ICE gathering",ICE_GATHERING_STARTED:"ICE gathering has started",ICE_GATHERING_COMPLETED:"ICE gathering has completed",DROP_EOC:"Dropping of sending ICE candidate end-of-candidates signal or unused ICE candidates ->",STATE_CHANGE:"Ice connection state changed ->"},ICE_CANDIDATE:{DROPPING_CANDIDATE:"Dropping ICE candidate",INVALID_CANDIDATE:"Received invalid ICE candidate message ->",VALID_CANDIDATE:"Received ICE candidate ->",FILTERED_CANDIDATE:"Dropping received ICE candidate as it matches ICE candidate filtering flag ->",FILTERING_FLAG_NOT_HONOURED:"Not dropping received ICE candidate as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured ->",CANDIDATE_ADDED:"Added ICE candidate successfully",ADDING_CANDIDATE:"Adding ICE Candidate",FAILED_ADDING_CANDIDATE:"Failed adding ICE candidate ->",ADD_BUFFERED_CANDIDATE:"Adding buffered ICE candidate",ADD_CANDIDATE_TO_BUFFER:"Adding ICE candidate to buffer",CANDIDATE_GENERATED:"Generated ICE candidate ->",SENDING_CANDIDATE:"Sending ICE candidate ->"},SESSION_DESCRIPTION:{parsing_media_ssrc:"Parsing session description media SSRCs ->"},DATA_CHANNEL:{reviving_dataChannel:"Reviving Datachannel connection",refresh_error:"Not a valid Datachannel connection",CLOSING:"Closing DataChannel",closed:"Datachannel has closed",onclose_error:"Error in data-channel onclose callback",NO_REMOTE_DATA_CHANNEL:"Remote peer does not have data channel",ERRORS:{FAILED_CLOSING:"Failed closing DataChannels --\x3e ",NO_SESSIONS:"Peer Connection does not have DataChannel sessions"}},NEGOTIATION_PROGRESS:{SET_LOCAL_DESCRIPTION:"Successfully set local description --\x3e",SET_REMOTE_DESCRIPTION:"Successfully set remote description --\x3e",APPLYING_BUFFERED_REMOTE_OFFER:"Applying buffered remote offer",ERRORS:{FAILED_SET_LOCAL_DESCRIPTION:"Failed setting local description --\x3e",FAILED_SET_REMOTE_DESCRIPTION:"Failed setting remote description",FAILED_SET_REMOTE_ANSWER:"Peer failed to set remote answer.",FAILED_RENEGOTIATION:"Failed renegotiation after answerAck",NOT_STABLE:"Dropping of message as signaling state is not stable",PROCESSING_EXISTING_SDP:"Dropping message as there is another sessionDescription being processed --\x3e",OFFER_TIEBREAKER:"Dropping the received offer: self weight is greater than incoming offer weight --\x3e",NO_LOCAL_BUFFERED_OFFER:"FATAL: No buffered local offer found - Unable to setLocalDescription",ADDING_REMOTE_OFFER_TO_BUFFER:"Adding remote offer received to buffer as current negotiation has not completed"}},SIGNALING:{MESSAGE_ADDED_TO_BUFFER:"Message buffered as enter message has not been sent",ENTER_LISTENER:"Enter listener initialized",BUFFERED_MESSAGES_SENT:"Buffered messages sent",BUFFERED_MESSAGES_DROPPED:"Buffered messages dropped - no mid",OUTDATED_MSG:"Dropping outdated status ->",DROPPING_MUTE_EVENT:"Dropping mute audio / video event message as it is processed by mediaInfoEvent",BUFFER_NOT_NEEDED:"Enter message sent. Messages do not need to be buffered",ABORTING_OFFER:"Aborting offer as current negotiation has not completed"},MESSAGING:{PRIVATE_MESSAGE:"Sending private message to Peer",BROADCAST_MESSAGE:"Broadcasting message to Peers",RECEIVED_MESSAGE:"Received message from Peer",PERSISTENCE:{SEND_MESSAGE:"Sending persisted message",NOT_PERSISTED:"Message will not be persisted as persistent flag is set to false",STORED_MESSAGES:"Received stored messages for room",IS_PERSISTENT_CONFIG:"Persistent message flag is set to",ERRORS:{FAILED_SETTING_PERSISTENCE:"Failed setting persistent message flag",INVALID_TYPE:"Persistent message flag must be of type boolean",PRIVATE_MESSAGE:"Cannot persist private messages",PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED:"Persistent Message feature is not enabled. Enable this feature on the key under 'Advanced Settings' in the Temasys Console"}},ENCRYPTION:{SEND_MESSAGE:"Sending encrypted message",DELETE_ALL:"Deleting all stored secrets",ERRORS:{FAILED_DECRYPTING_MESSAGE:"Failed decrypting message",ENCRYPT_SECRET:"Incorrect secret provided",INVALID_SECRETS:"No or invalid secret and secret id provided",SET_SELECTED_SECRET:"Failed setting selected secret",DELETE_ENCRYPT_SECRETS:"Failed deleting secret",SET_ENCRYPT_SECRET:"Failed setting secret",SECRET_ID_NOT_FOUND:"Secret id not found",NO_SECRET_OR_SECRET_ID:"Secret and / or secret id not provided",INVALID_TYPE:"Secret and secret id must be of type string and not empty",SECRET_ID_NOT_UNIQUE:"Secret id provided is not unique",SECRET_ID_NOT_SELECTED:"Secret id not selected",SECRET_ID_NOT_PROVIDED:"Secret id not provided",SECRETS_NOT_PROVIDED:"Secrets not provided"}},ERRORS:{DROPPING_MESSAGE:"Dropping message",FAILED_SENDING_MESSAGE:"Failed to send user message"}},MEDIA_INFO:{UPDATE_SUCCESS:"Successfully updated media info",ERRORS:{NO_ASSOCIATED_STREAM_ID:"There is no streamId associated with the mediaId and transceiverMid pair",FAILED_PROCESSING_MEDIA_INFO_EVENT:"Failed to process mediaInfoEvent message",FAILED_UPDATING:"Failed to update media info",FAILED_PROCESSING_PEER_MEDIA:"Failed to process media info",FAILED_UPDATING_TRANSCEIVER_MID:"Failed updating media info transceiverMid after setLocalDescription",FAILED_SETTING_PEER_MEDIA_INFO:"Failed setting peer media at offer / answer",STREAM_ID_NOT_MATCHED:"There is no mediaInfo associated with the streamId"},WARN:{READ_ONLY_VALUE:"Attempting to change media info read only value: ",INVALID_MEDIA_TYPE:"Invalid media info media type: "},VIDEO_STATE_CHANGE:"Peers's video state changed to ->",AUDIO_STATE_CHANGE:"Peers's audio state changed to ->",VIDEO_SCREEN_STATE_CHANGE:"Peers's video screen state changed to ->"},MEDIA_STREAM:{STOP_SETTINGS:"Stopped streams with settings:",STOP_SUCCESS:"Successfully stopped stream",REMOTE_TRACK_REMOVED:"Remote MediaStreamTrack removed",START_FALLBACK:"Fall back to retrieve audio only stream",NO_OPTIONS:"No user media options provided",DEFAULT_OPTIONS:"Using default options",FALLBACK_SUCCESS:"Successfully retrieved audio fallback stream",START_SCREEN_SUCCESS:"Successfully retrieved screen share stream",STOP_SCREEN_SUCCESS:"Successfully stopped screen share stream",UPDATE_MUTED_SETTINGS:"Updated stream muted setting",UPDATE_MEDIA_STATUS:"Updated stream media status",AUDIO_MUTED:"Peers's audio muted: ",VIDEO_MUTED:"Peers's video muted: ",ERRORS:{STOP_SCREEN:"Error stopping screen share stream",START_SCREEN:"Error starting screen share stream",STOP_ADDED_STREAM:"Error stopping added stream",STOP_USER_MEDIA:"Error stopping user media",STOP_AUDIO_TRACK:"Error stopping audio tracks in stream",STOP_VIDEO_TRACK:"Error stopping video tracks in stream",STOP_MEDIA_TRACK:"Error stopping MediaTrack",STOP_SCREEN_TRACK:"Error stopping screen track in stream",DROPPING_ONREMOVETRACK:"Dropping onremovetrack",NO_STREAM:"No stream to process",INVALID_STREAM_ID:"No stream detected with stream id",NO_USER_MEDIA_STREAMS:"No user media streams detected",INVALID_STREAM_ID_TYPE:"Stream id is not a string",NO_STREAM_ID:"No stream id provided",PEER_SCREEN_ACTIVE:"Peer has existing screen share",FALLBACK:"Error retrieving fallback audio stream",INVALID_GUM_OPTIONS:"Invalid user media options",INVALID_GDM_OPTIONS:"Invalid display media options",GET_USER_MEDIA:"Error retrieving stream from 'getUserMedia' method",INVALID_MUTE_OPTIONS:"Invalid muteStreams options provided",NO_STREAMS_MUTED:"No streams to mute",SEND_STREAM:"Error sending stream",INVALID_MEDIA_STREAM_ARRAY:"Array is not of type MediaStream",ACTIVE_STREAMS:"There are currently active streams being sent to remote peers. Please stop streams."}},STATS_MODULE:{NOT_INITIATED:"Stats Module is not initiated",STATS_DISCARDED:"Stats report discarded as peer has left the room",ERRORS:{RETRIEVE_STATS_FAILED:"Failed retrieving stats",POST_FAILED:"Failed posting to stats api",PARSE_FAILED:"Failed parsing stats report",STATS_IS_NULL:"Stats object is null",INVALID_TRACK_KIND:"Media kind is not audio or video"},HANDLE_ICE_GATHERING_STATS:{PROCESS_FAILED:"process_failed",PROCESS_SUCCESS:"process_success",PROCESSING:"processing",DROPPED:"dropped",BUFFERED:"buffered"},HANDLE_NEGOTIATION_STATS:{OFFER:{create:"create_offer",create_error:"error_create_offer",set:"set_offer",set_error:"error_set_offer",offer:"offer",dropped:"dropped_offer"},ANSWER:{create:"create_answer",create_error:"error_create_answer",set:"set_answer",set_error:"error_set_ANSWER",answer:"answer",dropped:"dropped_answer"}},HANDLE_DATA_CHANNEL_STATS:{open:"open",closed:"closed",reconnecting:"reconnecting"},HANDLE_CONNECTION_STATS:{},HANDLE_BANDWIDTH_STATS:{RETRIEVE_FAILED:"Failed posting bandwidth stats: ",NO_STATE:"No room state"},HANDLE_ICE_CONNECTION_STATS:{RETRIEVE_FAILED:"Failed retrieving stats: ",SEND_FAILED:"Failed sending ice connection stats: "},HANDLE_RECORDING_STATS:{START:"start",STOP:"stop",REQUEST_START:"request-start",REQUEST_STOP:"request-stop",ERROR_NO_MCU_START:"error-no-mcu-start",ERROR_NO_MCU_STOP:"error-no-mcu-stop",ERROR_START_ACTIVE:"error-start-when-active",ERROR_STOP_ACTIVE:"error-stop-when-active",ERROR_MIN_STOP:"error-min-stop",MCU_RECORDING_ERROR:"mcu-recording-error"}},RECORDING:{START_SUCCESS:"Started recording",STOP_SUCCESS:"Stopped recording",START_FAILED:"Failed to start recording",STOP_FAILED:"Failed to stop recording",MIN_RECORDING_TIME_REACHED:"4 seconds has been recorded - Recording can be stopped now",ERRORS:{MCU_NOT_CONNECTED:"MCU is not connected",EXISTING_RECORDING_IN_PROGRESS:"There is an existing recording in-progress",NO_RECORDING_IN_PROGRESS:"There is no existing recording in-progress",MIN_RECORDING_TIME:"4 seconds has not been recorded yet",STOP_ABRUPT:"Recording stopped abruptly before 4 seconds",SESSION_EMPTY:'Received request of "off" but the session is empty',MCU_RECORDING_ERROR:"Recording error received from MCU"}},RTMP:{start_no_mcu:"Unable to start RTMP session as MCU is not connected",stop_no_mcu:"Unable to stop RTMP as MCU is not connected",start_no_stream_id:"Unable to start RTMP Session stream id is missing",start_no_endpoint:"Unable to start RTMP Session as Endpoint is missing",starting_rtmp:"Starting RTMP Session",stopping_rtmp:"Stopping RTMP Session",message_received_from_sig:"Received RTMP Session message ->",stop_session_empty:'Received request of "off" but the session is empty',stopped_success:"Stopped RTMP Session",started_success:"Started RTMP Session",error_session_empty:"Received error but the session is empty ->",error_session:"RTMP session failure ->",error_Session_abrupt:"Stopped RTMP session abruptly"},PERSISTENT_MESSAGE:{ERRORS:{NO_DEPENDENCY:"CryptoJS is not available"}},UTILS:{INVALID_BROWSER_AGENT:"Invalid browser agent"},LOGGER:{EVENT_DISPATCHED:"Event dispatched",EVENT_REGISTERED:"Event successfully registered",EVENT_UNREGISTERED:"Event successfully unregistered",EVENT_DISPATCH_ERROR:"Error dispatching event",EVENT_REGISTER_ERROR:"Error registering event",EVENT_UNREGISTER_ERROR:"Error unregistering event",LOGS_NOT_STORED:"Store logs feature is not enabled. Enable it via SkylinkLogger.setLevel(logLevel, storeLogs)",LOGS_CLEARED:"Stored logs cleared",INVALID_CB:"Dropping listener as it is not a function"},BROWSER_AGENT:{REACT_NATIVE:{ERRORS:{DROPPING_ONREMOVETRACK:"Dropping onremovetrack as trackInfo is malformed"}}}},ht=new class{constructor(){this.events={},this.privateEvents={}}addPrivateEventListener(e,t){this.addListener(e,t,!0)}addEventListener(e,t){this.addListener(e,t,!1)}addListener(e,t,n){try{const s=n?"privateEvents":"events";if(!mo(t))return void Lt.log.DEBUG([null,it.SKYLINK_EVENT,e,_t.LOGGER.INVALID_CB]);this[s][e]||(this[s][e]={}),this[s][e].callbacks||(this[s][e].callbacks=[]),this[s][e].callbacks.push(t),n||Lt.log.DEBUG([null,it.SKYLINK_EVENT,e,_t.LOGGER.EVENT_REGISTERED])}catch(t){Lt.log.ERROR([null,it.SKYLINK_EVENT,e,_t.LOGGER.EVENT_REGISTER_ERROR],t)}}dispatchEvent(e){if(e.name===At.LOGGED_ON_CONSOLE)return;let t=[];if(this.events[e.name]){const n=this.events[e.name].callbacks;t=t.concat(n)}else Lt.log.DEBUG([null,it.SKYLINK_EVENT,e.name,_t.LOGGER.EVENT_DISPATCHED]);if(this.privateEvents[e.name]){const n=this.privateEvents[e.name]?this.privateEvents[e.name].callbacks:[];t=t.concat(n)}t.forEach((t=>{try{t(e.detail)}catch(t){Lt.log.ERROR([null,it.SKYLINK_EVENT,e.name,_t.LOGGER.EVENT_DISPATCH_ERROR],t)}}))}removeEventListener(e,t){this.removeListener(e,t,!1)}removePrivateEventListener(e,t){this.removeListener(e,t,!0)}removeListener(e,t,n){const s=n?"privateEvents":"events";if(n||this.events[e]&&this.events[e].callbacks)try{this[s][e].callbacks.forEach(((r,o)=>{r===t&&(delete this[s][e].callbacks[o],n||Lt.log.DEBUG([null,it.SKYLINK_EVENT,e,_t.LOGGER.EVENT_UNREGISTERED]))}))}catch(t){Lt.log.ERROR([null,it.SKYLINK_EVENT,e,_t.LOGGER.EVENT_DISPATCH_ERROR],t)}else Lt.log.WARN([null,it.SKYLINK_EVENT,e,_t.LOGGER.EVENT_UNREGISTERED])}},Nt=ht.addPrivateEventListener.bind(ht),Ct=ht.removePrivateEventListener.bind(ht),Dt=ht.dispatchEvent.bind(ht),ft=ht,Mt=["trace","debug","info","warn","error"],Pt="loglevel:skylinkjs",yt=e=>{let t=!0;return("undefined"==typeof console||void 0===console[e])&&(t=!1),t},vt=(e,t,n,s=null)=>{const r=`[${(new Date).toISOString()}]`,o=e.level,{logLevels:i}=e;if(o<=t&&o!==i.SILENT){const e=Mt[t];if(!yt(e))return;const o=(e=>{let t="SkylinkJS -";if(Array.isArray(e)){const[n,s,r,o]=e;if(t+=n?` [${n}]`:" -",t+=s?` <<${s}>>`:n?"":" <<Method>>",r)if(Array.isArray(r))for(let e=0;e<r.length;e+=1)t+=` (${r[e]})`;else t+=` (${r})`;t+=` ${o}`}else t+=` ${e}`;return t})(n);if(yt(e)&&(console[e](r,o,s||""),Dt(((e={})=>new de(ne,{detail:e}))({level:e,message:o,debugObject:s}))),Lt.storeLogs){const t=[r,e.toUpperCase(),o];s&&t.push(s),Lt.storedLogs.push(t)}}};class kt{constructor(){this.logLevels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},this.level=(e=>{const t=window.localStorage.getItem(Pt);return null===t||Number.isNaN(+t)?e.ERROR:+t})(this.logLevels),this.storeLogs=!1,this.storedLogs=[]}setLevel(e=this.levels.ERROR,t){po(e)?(this.level=e,(e=>{window.localStorage.setItem(Pt,e)})(this.level)):this.level=this.levels.ERROR,t&&(this.storeLogs=t)}enableAll(){this.setLevel(this.logLevels.TRACE)}disableAll(){this.setLevel(this.logLevels.SILENT)}getLogs(){return this.storeLogs?this.storedLogs:(this.log.WARN(_t.LOGGER.LOGS_NOT_STORED),null)}clearLogs(){this.log.INFO(_t.LOGGER.LOGS_CLEARED),this.storedLogs=[]}}const wt=new kt;kt.prototype.log={TRACE:(...e)=>{vt(wt,wt.logLevels.TRACE,...e)},DEBUG:(...e)=>{vt(wt,wt.logLevels.DEBUG,...e)},INFO:(...e)=>{vt(wt,wt.logLevels.INFO,...e)},WARN:(...e)=>{vt(wt,wt.logLevels.WARN,...e)},ERROR:(...e)=>{vt(wt,wt.logLevels.ERROR,...e)}};const Lt=wt;var bt=n(6313),Gt=n.n(bt);const Ut={RECONNECTION_ATTEMPTS:{WEBSOCKET:5,POLLING:4},RECONNECTION_DELAY_MAX:5e3,RECONNECTION_DELAY:1e3,RECONNECTION_FINAL_ATTEMPTS:10},Ft={SOCKET:e=>({forceNew:!0,reconnection:!0,timeout:e.socketTimeout,path:e.socketServerPath,reconnectionAttempts:Ut.RECONNECTION_ATTEMPTS.WEBSOCKET,reconnectionDelayMax:Ut.RECONNECTION_DELAY_MAX,reconnectionDelay:Ut.RECONNECTION_DELAY,transports:[Tt.WEBSOCKET.toLowerCase()],query:{Skylink_SDK_type:Rt.WEB,Skylink_SDK_version:St,Skylink_API_version:ut,"X-Server-Select":It},extraHeaders:{Skylink_SDK_type:Rt.WEB,Skylink_SDK_version:St,Skylink_API_version:ut,"X-Server-Select":It}}),PEER_CONNECTION:{bundlePolicy:De.BALANCED,rtcpMuxPolicy:fe.REQUIRE,iceTransportPolicy:"all",iceCandidatePoolSize:0}},Bt={SOCKET:Ut,MEDIA_OPTIONS:{AUDIO:{stereo:!1,echoCancellation:!0,exactConstraints:!1},VIDEO:{resolution:$e.VGA,frameRate:30,exactConstraints:!1},SCREENSHARE:{video:!0}}},Vt=(e,t)=>t?Ft[e](t):Ft[e],Ht=(e={})=>new de(S,{detail:e}),xt=(e={})=>new de(R,{detail:e}),Wt=(e={})=>new de(u,{detail:e}),$t=(e={})=>new de(O,{detail:e}),Kt=(e={})=>new de(v,{detail:e}),jt=(e={})=>new de(I,{detail:e}),Yt=(e={})=>new de(Q,{detail:e}),Jt=(e={})=>new de(x,{detail:e}),Qt=(e={})=>new de(te,{detail:e}),Zt=(e={})=>new de(J,{detail:e}),qt={defaultRoom:(new Date).valueOf(),appKey:null,roomServer:"//api.temasys.io",enableDataChannel:!0,enableSTUNServer:!0,enableTURNServer:!0,socketServerPath:null,enableStatsGathering:!0,audioFallback:!0,socketTimeout:7e3,forceTURNSSL:!1,forceTURN:!1,forceSSL:!0,usePublicSTUN:!1,mcuUseRenegoRestart:!0,useEdgeWebRTC:!1,enableSimultaneousTransfers:!0,TURNServerTransport:_e.ANY,credentials:null,iceServer:null,socketServer:null,audioCodec:xe.AUTO,videoCodec:He.AUTO,codecParams:{audio:{opus:{stereo:null,"sprop-stereo":null,usedtx:null,useinbandfec:null,maxplaybackrate:null,minptime:null}},video:{h264:{profileLevelId:null,levelAsymmetryAllowed:null,packetizationMode:null},vp8:{maxFs:null,maxFr:null},vp9:{maxFs:null,maxFr:null}}},beSilentOnStatsLogs:!1,beSilentOnParseLogs:!1},Xt={},zt=class{constructor(e,t){if(Oo(t)&&Xt[t])return Xt[t];const{offer_constraints:n,pc_constraints:s,cid:r,apiOwner:o,ipSigserver:i,isPrivileged:a,autoIntroduce:d,httpPortList:l,httpsPortList:c,hasMCU:E,ipSigserverPath:S,hasPersistentMessage:R,room_key:u,enable_stats_config:I}=e;n||s||Lt.log.ERROR(["API",null,"init","pc_constraints or offer_constraints are null"]),Lt.log.DEBUG(["API",null,"init","Parsed Peer Connection constraints:"],JSON.parse(s)),Lt.log.DEBUG(["API",null,"init","Parsed Offer constraints"],JSON.parse(n)),this.key=r,this.appKeyOwner=o,this.isPrivileged=a,this.autoIntroduce=d,this.room=new class{constructor(e){this.id=e.room_key,this.token=e.roomCred,this.startDateTime=e.start,this.duration=e.len,this.roomName=e.roomName,this.connection={peerConstraints:JSON.parse(e.pc_constraints),offerConstraints:JSON.parse(e.offer_constraints),sdpConstraints:{},peerConfig:{iceServers:[]},mediaConstraints:JSON.parse(e.media_constraints)},this.isLocked=!1}}(e),this.user=new class{constructor(e){this.uid=e.username,this.token=e.userCred,this.timeStamp=e.timeStamp,this.sid=null,this.bufferMessage=null}}(e),this.hasMCU=E,this.socketServer=i,this.socketServerPath=S,this.socketPorts={"http:":Array.isArray(l)&&l.length>0?l:[80,3e3],"https:":Array.isArray(c)&&c.length>0?c:[443,3443]},this.hasPersistentMessage=R,this.enableStatsGathering=I,Xt[u]=this}deleteApiResponseInstance(e){delete Xt[e]}},en=(e={})=>new de(Z,{detail:e}),tn={apiBase:"https://api.temasys.io",stats:{endPoints:{client:"/client",session:"/session",auth:"/auth",signaling:"/signaling",iceConnection:"/client/iceconnection",iceCandidate:"/client/icecandidate",iceGathering:"/client/icegathering",negotiation:"/client/negotiation",bandwidth:"/client/bandwidth",recording:"/client/recording",dataChannel:"/client/datachannel"}}};tn.stats.statsBase=`${tn.apiBase}/rest/stats`;const nn=tn,sn=class{constructor(){this.endpoints=nn.stats.endPoints,this.stats_buffer={},this.bufferTimeout=!1}postStats(e,t){const{STATS_MODULE:n}=_t,s=di.getInitOptions().beSilentOnStatsLogs;try{const n=this.processData(t);this.postStatObj(e,s,n)}catch(e){Lt.log.WARN(n.ERRORS.POST_FAILED,e)}}processData(e){return Array.isArray(e)?{client_id:e[0].client_id,data:e}:e}async postStatObj(e,t,n){const{fetch:s}=window,r=await s(`${nn.stats.statsBase}${e}`,{method:"POST",mode:"cors",headers:{"Content-type":"application/json"},body:JSON.stringify(n)});t||r.json().then((t=>{Lt.log.INFO([null,it.STATS,null,`${e}`],t)}))}addToStatsBuffer(e,t,n){this.stats_buffer[e]||(this.stats_buffer[e]={},this.stats_buffer[e].url=n,this.stats_buffer[e].data=[]);const s=Object.assign({},t);this.stats_buffer[e].data.push(s)}manageStatsBuffer(){this.bufferTimeout||(this.bufferTimeout=!0,setInterval((()=>{const e=Object.keys(this.stats_buffer);for(let t=0;t<e.length;t+=1)this.stats_buffer[e[t]].data.length>0&&(this.postStats(this.stats_buffer[e[t]].url,this.stats_buffer[e[t]].data),this.stats_buffer[e[t]].data=[])}),5e3))}},rn=class extends sn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,state:null,http_status:null,http_error:null,api_url:null,api_result:null}}send(e,t,n,s){this.model.room_id=e,this.model.http_status=s?-1:n&&n.status?n.status:null,this.model.http_error=("string"==typeof s?s:s&&s.message)||null,this.model.api_url=n&&n.endpoint?n.endpoint:n.url,this.model.client_id=di.getInitOptions().clientId,this.model.app_key=di.getInitOptions().appKey,this.model.state=t,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.auth,this.model)}},on=e=>{const{appKey:t}=e,n={isValid:!0,message:""};return Lt.log.INFO(["API",null,"init","API initialised with options:"],e),t||(n.isValid=!1,n.message=_t.INIT.ERRORS.NO_APP_KEY,Dt(en({readyState:Le.ERROR,error:{status:-2,content:new Error(_t.INIT.ERRORS.NO_APP_KEY),errorCode:be.NO_PATH},room:null}))),n.isValid||Lt.log.ERROR(["API",null,"init",n.message]),n},an=e=>{const t=e;return!0===t.forceTURN&&(t.enableTURNServer=!0,t.enableSTUNServer=!1),t};let dn=null;const ln=class{constructor(){return dn||(dn=this),this.options={},dn}init(e=qt){e&&(e.socketServer&&!e.socketServerPath&&(e.socketServerPath=""),e.clientId=Do(),di.setUserInitOptions(e)),Dt(en({readyState:Le.INIT,error:null,room:null}));const t=(()=>{const e={fulfilled:!0,message:""},{AdapterJS:t,io:n,fetch:s}=window,r="Validating Dependencies";return"function"!=typeof(t||window.AdapterJS||window.AdapterJS||{}).webRTCReady?(e.message=_t.INIT.ERRORS.NO_ADAPTER,e.fulfilled=!1,e.readyStateChangeErrorCode=be.ADAPTER_NO_LOADED):n||window.io?s&&window.fetch||(e.message=_t.INIT.ERRORS.NO_FETCH_SUPPORT,e.fulfilled=!1,e.readyStateChangeErrorCode=be.NO_XMLHTTPREQUEST_SUPPORT):(e.message=_t.INIT.ERRORS.NO_SOCKET_IO,e.fulfilled=!1,e.readyStateChangeErrorCode=be.NO_SOCKET_IO),ko(gt.FIREFOX)&&"moz"===t.webrtcDetectedType||ko(gt.SAFARI)||ko(gt.CHROME)&&"webkit"===t.webrtcDetectedType||ko(gt.REACT_NATIVE)||Lt.log.WARN([r,null,null,_t.INIT.INCOMPATIBLE_BROWSER]),e.fulfilled||Lt.log.ERROR([r,null,null,e.message]),e})(),{AdapterJS:n}=window;if(!t.fulfilled)throw Dt(en({readyState:Le.ERROR,error:{status:-2,content:new Error(t.message),errorCode:t.readyStateChangeErrorCode},room:null})),new Error(t.message);let s=Object.assign({},qt,e);const r=on(s);if(!r.isValid)throw new Error(r.message);return n.webRTCReady((()=>{const e=(()=>{const e={ready:!0,message:""};return(()=>{try{const e=new window.RTCPeerConnection(null);return["object","function"].indexOf(typeof e.createOffer)>-1&&null!==e.createOffer}catch(e){return!1}})()||(e.message="WebRTC not supported. Please upgrade your browser",e.ready=!1,Dt(en({readyState:Le.ERROR,error:{status:-2,content:new Error(e.message),errorCode:be.NO_WEBRTC_SUPPORT},room:null}))),e})();if(!e.ready)throw new Error(e.message)})),s=an(s),s}createRoom(e){return new Promise(((t,n)=>{const s=di.getInitOptions();s.defaultRoom=e,(async e=>{const{fetch:t}=window,n=(e=>{const{roomServer:t,appKey:n,defaultRoom:s,credentials:r,forceSSL:o}=e;let i=`${t}/api/${n}/${s}`,a="?";if(i=o?`https:${i}`:`${window.location.protocol}${i}`,r){const{startDateTime:e,duration:t}=r;i+=`/${e}/${t}?cred=${r.credentials}`,a="&"}return i+=`${a}rand=${Date.now()}`,i})(e);return(new rn).send(e.defaultRoom,pe.REQUEST,{endpoint:n}),{endpoint:n,response:await t(n,{headers:{Skylink_SDK_type:Rt.WEB,Skylink_SDK_version:St,Skylink_API_version:ut,"X-Server-Select":It}})}})(s).then((s=>{const{endpoint:r,response:o}=s;(e=>{const{ok:t}=e;return(e=>{const{status:t,ok:n}=e,s=n?"INFO":"ERROR";let r=_t.INIT.INFO.API_SUCCESS;n||(r=_t.INIT.ERRORS.AUTH_GENERAL,403===t&&(r=_t.INIT.ERRORS.AUTH_CORS)),Lt.log[s](["API",null,"auth",r],e)})(e),t})(o)?(Dt(en({readyState:Le.COMPLETED,error:null,room:e})),o.json().then((e=>{(new rn).send(e.room_key,pe.SUCCESS,o),t({endpoint:r,response:e})}))):(Dt(en({readyState:Le.ERROR,error:{status:o.status,content:new Error(o.info||`XMLHttpRequest status not OK\nStatus was: ${o.status}`),errorCode:o.error||o.status},room:e})),o.json().then((t=>{(new rn).send(e,pe.ERROR,o,t.info),n(t)})))})).catch((t=>{Dt(en({readyState:Le.ERROR,error:{status:t.status||-1,content:new Error(t.message||"Network error occurred"),errorCode:be.XML_HTTP_REQUEST_ERROR},room:e}))}))}))}checkCodecSupport(e){return(e=>new Promise(((t,n)=>{Uo.getCodecsSupport(e).then((s=>{const r=di.getSkylinkState(e),{room:o}=r;0===Object.keys(s.audio).length&&0===Object.keys(s.video).length?(Lt.log.ERROR(_t.JOIN_ROOM.ERRORS.CODEC_SUPPORT),Dt(en({readyState:Le.ERROR,error:{status:-2,content:new Error(_t.JOIN_ROOM.ERRORS.CODEC_SUPPORT),errorCode:be.PARSE_CODECS},room:Jr.getRoomInfo(o.id)})),n(new Error(_t.JOIN_ROOM.ERRORS.CODEC_SUPPORT))):t(!0),r.currentCodecSupport=s,di.setSkylinkState(r)})).catch((t=>{const s=di.getSkylinkState(e),{room:r}=s;Lt.log.ERROR(t),Dt(en({readyState:Le.ERROR,error:{status:-2,content:new Error(t.message||t.toString()),errorCode:be.PARSE_CODECS},room:Jr.getRoomInfo(r.id)})),n(new Error(t.message||t.toString()))}))})))(e)}static parseAPIResponseBody(e){return new zt(e)}enforceUserInitOptions(e){return(e=>{const t=di.getUserInitOptions(),n=di.getInitOptions();let s=Object.assign(n,e,t);const r=on(s);if(!r.isValid)throw new Error(r.message);return s=an(s),di.setInitOptions(s),s})(e)}static getRoomNameFromParams(e){const t=di.getInitOptions(),{roomName:n}=e,{defaultRoom:s}=t;let r=null;return r=void 0!==n&&""!==n&&s!==n?n:s,r}static getStateByKey(e){return ho(e)}},cn=e=>new de(V,{detail:e}),En=class extends sn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,signaling_url:null,signaling_transport:null,attempts:null,error:null}}send(e,t,n){const s=di.getSkylinkState(e),{socketSession:r}=s;this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.client_id=s.clientId,this.model.state=t,this.model.signaling_url=s.socketSession.socketServer,this.model.signaling_transport=s.socketSession.socketType.toLowerCase(),this.model.attempts=0===r.socketSession.finalAttempts?r.socketSession.attempts:2*r.socketSession.finalAttempts+r.socketSession.attempts,this.model.app_key=di.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.attempts="number"==typeof n?n:null,this.model.error=("string"==typeof n?n:n&&n.message)||null,this.postStats(this.endpoints.signaling,this.model)}},Sn=e=>{const{peerConnections:t}=e,n=Object.keys(t);let s=!0;return n.forEach((e=>{t[e].connectionState===he.FAILED&&(s=!1)})),s},Rn={onConnection:(e,t)=>{const n=di.getSkylinkState(t),{socketSession:s}=n;var r;(new En).send(t,Ot.SIGNALING.CONNECT,null),n.channelOpen||(n.channelOpen=!0,di.setSkylinkState(n,t)),0!==s.socketSession.finalAttempts||0!==s.socketSession.attempts?(Dt((r={socketSession:Gt()(s)},new de(b,{detail:r}))),(new En).send(t,Ot.SIGNALING.RECONNECT_SUCCESS)):Dt((e=>new de(L,{detail:e}))({socketSession:Gt()(s)})),e()},onDisconnect:(e,t)=>{const n=di.getSkylinkState(e)||Object.values(di.getSkylinkState())[0],s=n.channelOpen,{room:r}=n;(new En).send(r.id,Ot.SIGNALING.DISCONNECT,null),(s||!s&&e!==r.roomName)&&gn(r.id,t)},onError:(e,t)=>{const n=di.getSkylinkState(e),{socketSession:s}=n;var r;(new En).send(e,Ot.SIGNALING.ERROR,t),Lt.log.ERROR([null,"Socket",null,"Exception occurred ->"],t),Dt((r={error:t,socketSession:Gt()(s)},new de(F,{detail:r})))},onReconnectAttempt:(e,t)=>{const n=di.getSkylinkState(e);if(!n)return;const{socketSession:s}=n;let r=0;var o;(new Fr).updateAttempts(e,"attempts",t),r=0===s.socketSession.finalAttempts?t:2*s.socketSession.finalAttempts+s.socketSession.attempts,(new En).send(e,Ot.SIGNALING.RECONNECT_ATTEMPT,r),Dt((o={fallbackType:s.fallbackType,currentAttempt:r,session:Gt()(di.getSkylinkState(e).socketSession)},new de(B,{detail:o})))},onReconnectFailed:(e,t,n)=>{const s=di.getSkylinkState(n),{socketSession:r}=s,o=new Fr;Sn(s)&&r.socketSession.attempts===Bt.SOCKET.RECONNECTION_ATTEMPTS.WEBSOCKET&&r.socketSession.finalAttempts<Bt.SOCKET.RECONNECTION_FINAL_ATTEMPTS&&!r.socketTimeout?(o.socket.connect(),o.updateAttempts(n,"attempts",r.socketSession.attempts===Bt.SOCKET.RECONNECTION_ATTEMPTS.WEBSOCKET?0:r.socketSession.attempts+=1),o.updateAttempts(n,"finalAttempts",r.socketSession.finalAttempts+=1)):Sn(s)?((new En).send(n,Ot.SIGNALING.RECONNECT_FAILED,_t.INIT.ERRORS.SOCKET_ERROR_ABORT),Dt(cn({session:Gt()(r),errorCode:Fe.RECONNECTION_ABORTED,type:r.fallbackType,error:new Error(_t.INIT.ERRORS.SOCKET_ERROR_ABORT)})),t(new Error(_t.INIT.ERRORS.SOCKET_ERROR_ABORT))):Lt.log.WARN([null,"Socket",null,`${_t.SOCKET.ABORT_RECONNECT} - ${_t.PEER_CONNECTION.FAILED_STATE}`])},onReconnectError:(e,t)=>{const n=di.getSkylinkState(e),{socketSession:s}=n;(new En).send(e,Ot.SIGNALING.RECONNECT_ERROR,t),!s.socketTimeout&&t&&"timeout"===t&&(Lt.log.ERROR([null,"Socket",null,`${s.socketType} connection timed out.`]),s.socketTimeout=!0,di.setSkylinkState(n,e))}},un=e=>To(e)&&e,In=(e,t)=>{const n=di.getSkylinkState(e),{detail:s}=t;if(s.state===Pe.ENTER){const e=Gt()(n.socketMessageQueue);n.user.bufferMessage=!1,n.socketMessageQueue=[],di.setSkylinkState(n,n.room.id),Lt.log.DEBUG([n.user.sid,it.SIG_SERVER,null,`${_t.SIGNALING.BUFFERED_MESSAGES_SENT}: ${e.length}`]),((e,t)=>{const n=new Fr;for(let s=t.length-1;s>=0;s-=1){const r=t[s];if(!r.mid){if(!e.user.sid)return void Lt.log.DEBUG([e.user.sid,it.SIG_SERVER,null,`${_t.SIGNALING.BUFFERED_MESSAGES_DROPPED}`]);r.mid=e.user.sid}n.sendMessage(r),t.splice(s,1)}})(n,e),ft.removeEventListener(At.HANDSHAKE_PROGRESS,In)}},gn=(e,t)=>{((e,t)=>{const n=di.getSkylinkState(e)||Object.values(di.getSkylinkState())[0],{socketSession:s,room:r,user:o}=n;var i;Lt.log.INFO([null,"Socket",null,`Channel closed. Reason - ${t}`]),n.channelOpen=!1,di.setSkylinkState(n,e),Dt((i={socketSession:Gt()(s)},new de(G,{detail:i}))),r.inRoom&&o&&o.sid&&Dt(((e={})=>new de(k,{detail:e}))({peerId:o.sid,peerInfo:Xr.getCurrentSessionInfo(r)}))})(e,t)};var pn=n(1354),mn=n.n(pn);const Tn={isExisting:(e,t)=>Object.keys(t).filter((t=>t===e)).length>0,isValidString:e=>{if(!Oo(e)||!Oo(e)||uo(e))throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return!0},hasCrypto:()=>mn()?mn():(Lt.log.ERROR([null,it.ASYNC_MESSAGING,null,_t.PERSISTENT_MESSAGE.ERRORS.NO_DEPENDENCY]),!1),canEncrypt:(e,t)=>{if(So(t)&&uo(e))throw new Error(`${_t.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED}, ${_t.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_PROVIDED}`);if(uo(e))throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_SELECTED);if(So(t))throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return!0},canDecrypt:e=>{if(So(e))throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return!0}},On=(e={})=>new de(g,{detail:e}),An=(e={})=>new de(p,{detail:e}),_n=class{static throwError(e="",t=""){throw Lt.log.ERROR([null,it.SKYLINK_ERROR,null,`${e}${t?` - ${t}`:""}`]),new Error(`${e}${t?` - ${t}`:""}`)}},hn={getMessageConfig:(e,t)=>{const{peerInformations:n,room:s,user:r}=e;let o,i=!1;if(!s.inRoom||!r)throw Error(_t.ROOM.ERRORS.NOT_IN_ROOM);return Array.isArray(t)&&!Ro(t)?(o=t,i=!0):t&&Oo(t)?(o=[t],i=!0):o=Object.keys(n),o.forEach(((e,t)=>{n[e]?e===pt.MCU&&o.splice(t,1):(Lt.log.WARN([e,it.MESSAGING,null,`${_t.MESSAGING.ERRORS.DROPPING_MESSAGE} - ${_t.PEER_CONNECTION.NO_PEER_CONNECTION}`]),o.splice(t,1))})),0===o.length&&Lt.log.WARN([null,it.MESSAGING,null,_t.PEER_CONNECTION.NO_PEER_CONNECTION]),{listOfPeers:o,isPrivate:i}},sendMessageToSig:(e,t,n,s="",r)=>{(new Fr).sendUserMessage(e,t,s||n),hn.dispatchOnIncomingMessage(e,t,n,!0,r)},dispatchOnIncomingMessage:(e,t,n,s,r)=>{const{room:o,user:i}=e;Lt.log.DEBUG([s?null:r,it.MESSAGING,null,`${_t.MESSAGING.RECEIVED_MESSAGE} - isPrivate: ${t.isPrivate}`]);const a={targetPeerId:s?t.isPrivate?r:null:i.sid,content:n,senderPeerId:s?i.sid:r,isDataChannel:!1,isPrivate:t.isPrivate,timeStamp:Lo()};s&&(a.listOfPeers=t.listOfPeers),Dt(An({room:Jr.getRoomInfo(o.id),message:a,isSelf:s,peerId:s?i.sid:r,peerInfo:s?Xr.getCurrentSessionInfo(o):Xr.getPeerInfo(r,o)}))},trySendMessage:(e,t,n)=>{try{const s=hn.getMessageConfig(e,n);hn.sendMessageToSig(e,s,t,null,n)}catch(e){_n.throwError(_t.MESSAGING.ERRORS.FAILED_SENDING_MESSAGE)}}},Nn={deleteEncryptSecrets:(e,t,n)=>{const s={encryptSecrets:e,selectedSecretId:t};if(n){if(!s.encryptSecrets[n])throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);s.selectedSecretId===n&&(s.selectedSecretId=Nn.setSelectedSecretId()),delete s.encryptSecrets[n]}else Lt.log.DEBUG([null,it.ENCRYPTED_MESSAGING,null,`${_t.MESSAGING.ENCRYPTION.DELETE_ALL}`]),s.selectedSecretId=Nn.setSelectedSecretId(),s.encryptSecrets={};return s},setEncryptSecret:(e,t,n)=>{const s=e;if((e=>{if(!e)throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!Nn.utils.isValidString(e))throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return!0})(t)&&((e,t)=>{if(!e)throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!Nn.utils.isValidString(e))throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);if(Nn.utils.isExisting(e,t))throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_UNIQUE);return!0})(n,s))return s[n]=t,s},setSelectedSecretId:(e,t)=>{if(!t)return"";if(!Nn.utils.isValidString(t))throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);if(!e[t])throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return t},utils:Tn,getMessageConfig:(e,t,n,s,r)=>{const o=hn.getMessageConfig(e,t);return Nn.utils.hasCrypto()&&Nn.utils.canEncrypt(s,n)&&(o.secretId=s),r&&(o.isPersistent=r),o},encryptMessage:(e,t,n=!1)=>{if(n)try{return mn().AES.decrypt(e,t).toString(mn().enc.Utf8)}catch(e){throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET)}return mn().AES.encrypt(e,t).toString()},tryDecryptMessage:(e,t,n)=>{const s=Nn.encryptMessage(e,n[t],!0);if(uo(s))throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET);return s}},Cn=e=>{const t=qr.getCurrentSessionInfo(e);return delete t.room,t},Dn={},fn=class{constructor(e){const{room:t,user:n}=e;return Dn[t.id]||(Dn[t.id]=this),this.room=t,this.peerId=n.sid,this.encryptSecrets={},this.selectedSecretId="",Dn[t.id]}setEncryptSecret(e,t){try{this.encryptSecrets=Nn.setEncryptSecret(this.encryptSecrets,e,t),this.dispatchEncryptSecretEvent()}catch(e){_n.throwError(_t.MESSAGING.ENCRYPTION.ERRORS.SET_ENCRYPT_SECRET,e.message)}}getEncryptSecrets(){return this.encryptSecrets}deleteEncryptSecrets(e){try{const t=Nn.deleteEncryptSecrets(this.encryptSecrets,this.selectedSecretId,e);this.encryptSecrets=t.encryptSecrets,this.selectedSecretId=t.selectedSecretId,this.dispatchEncryptSecretEvent()}catch(e){_n.throwError(_t.MESSAGING.ENCRYPTION.ERRORS.DELETE_ENCRYPT_SECRETS,e.message)}}setSelectedSecretId(e){try{this.selectedSecretId=Nn.setSelectedSecretId(this.encryptSecrets,e),this.dispatchEncryptSecretEvent()}catch(e){_n.throwError(_t.MESSAGING.ENCRYPTION.ERRORS.SET_SELECTED_SECRET,e.message)}}getSelectedSecretId(){return this.selectedSecretId}dispatchEncryptSecretEvent(){Dt(((e={})=>new de(oe,{detail:e}))({room:Jr.getRoomInfo(this.room.id),encryptSecrets:this.encryptSecrets,selectedSecretId:this.selectedSecretId,peerInfo:Cn(this.room),peerId:this.peerId}))}canEncrypt(e){try{return!!Nn.utils.canEncrypt(this.selectedSecretId,this.encryptSecrets)&&Nn.utils.isValidString(this.selectedSecretId)&&Nn.utils.isValidString(this.encryptSecrets[this.selectedSecretId])}catch(t){if(e)throw new Error(t.message);return!1}}decryptStoredMessages(e,t){if(Nn.utils.canEncrypt(t,this.encryptSecrets)&&!Object.keys(this.encryptSecrets).filter((e=>e===t)).length)throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return this.decryptMessage(e,t)}decryptMessage(e,t=""){if(t&&Nn.utils.canDecrypt(this.encryptSecrets))return Nn.tryDecryptMessage(e,t,this.encryptSecrets);throw new Error(_t.MESSAGING.ENCRYPTION.ERRORS.INVALID_SECRETS)}sendMessage(e,t,n,s=!1){const r=No(e);if(Ao(t,"message","sendMessage")&&r)try{Lt.log.DEBUG([null,it.ASYNC_MESSAGING,null,_t.MESSAGING.ENCRYPTION.SEND_MESSAGE]);const e=Nn.getMessageConfig(r,n,this.encryptSecrets,this.selectedSecretId,s),o=Nn.encryptMessage(t,this.encryptSecrets[this.selectedSecretId]);hn.sendMessageToSig(r,e,t,o,n)}catch(e){_n.throwError(_t.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message)}}static deleteEncryptedInstance(e){delete Dn[e.id]}},Mn=(e,t)=>({targetPeerId:t,senderPeerId:e.mid,content:e.data,timeStamp:wo(e.timeStamp),isPrivate:!1,isDataChannel:!1}),Pn={},yn=class{constructor(e){const{user:t,room:n,hasPersistentMessage:s}=e;return Pn[n.id]||(Pn[n.id]=this),this.room=n,this.peerId=t.sid,this.isPersistent=s,this.hasPersistentMessage=s,Pn[n.id]}setMessagePersistence(e){if(!To(e))throw _n.throwError(_t.MESSAGING.PERSISTENCE.ERRORS.FAILED_SETTING_PERSISTENCE,_t.MESSAGING.PERSISTENCE.ERRORS.INVALID_TYPE);if(!this.hasPersistentMessage)throw this.isPersistent=e,_n.throwError(_t.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);this.isPersistent=e,Dt(((e={})=>new de(ie,{detail:e}))({room:Jr.getRoomInfo(this.room.id),isPersistent:this.isPersistent,peerInfo:Cn(this.room),peerId:this.peerId}))}getMessagePersistence(){return this.isPersistent}sendMessage(e,t,n){const s=No(e),r=!n||Array.isArray(n)&&Ro(n);if(Ao(t,"message","sendMessage")&&s)try{Lt.log.DEBUG([null,it.ASYNC_MESSAGING,null,_t.MESSAGING.PERSISTENCE.SEND_MESSAGE]);const o=new fn(s);if(!r)throw new Error(_t.MESSAGING.PERSISTENCE.ERRORS.PRIVATE_MESSAGE);o.canEncrypt(!0)&&o.sendMessage(e,t,n,this.isPersistent)}catch(e){_n.throwError(_t.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message)}}getStoredMessages(){const e=di.getSkylinkState(this.room.id);this.hasPersistentMessage?(new Fr).getStoredMessages(e):Lt.log.WARN([this.peerId,it.ASYNC_MESSAGING,null,`${_t.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED}`])}canPersist(){if(this.hasPersistentMessage)return!!this.isPersistent||(Lt.log.DEBUG([null,it.ASYNC_MESSAGING,null,_t.MESSAGING.PERSISTENCE.NOT_PERSISTED]),!1);if(this.isPersistent)throw Lt.log.DEBUG([null,it.ASYNC_MESSAGING,null,`${_t.MESSAGING.PERSISTENCE.IS_PERSISTENT_CONFIG} ${this.isPersistent}`]),new Error(_t.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);return!1}static processStoredMessages(e){const t=di.getSkylinkState(e.rid),{room:n}=t,s=e.mid,r=JSON.parse(e.data),o=new fn(t),i=[];Lt.log.DEBUG([s,it.ASYNC_MESSAGING,null,_t.MESSAGING.PERSISTENCE.STORED_MESSAGES],r);try{for(let e=0;e<r.length;e+=1)r[e].data=o.decryptStoredMessages(r[e].data,r[e].secretId),i.push(Mn(r[e],s))}catch(e){throw _n.throwError(_t.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message)}Dt(((e={})=>new de(re,{detail:e}))({room:Jr.getRoomInfo(n.id),storedMessages:i,isSelf:!1,peerId:s,peerInfo:Xr.getPeerInfo(s,n)}))}static deleteAsyncInstance(e){delete Pn[e.id]}},vn=class{static sendMessage(e,t,n){const s=No(e);if(Ao(t,"message","sendMessage")&&s){const r=new fn(s),o=new yn(s);o.canPersist()?o.sendMessage(e,t,n):r.canEncrypt()?r.sendMessage(e,t,n):hn.trySendMessage(s,t,n)}}static sendP2PMessage(e,t,n){const s=No(e);Ao(t,"message","sendP2PMessage")&&s&&Ho.sendP2PMessage(e,t,n)}static processMessage(e,t){const{mid:n,target:s,rid:r,secretId:o,data:i}=e,a=di.getSkylinkState(r),d=n;let l=i;if(o)try{l=new fn(a).decryptMessage(i,o)}catch(e){_n.throwError(_t.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message)}hn.dispatchOnIncomingMessage(a,{isPrivate:To(t)?!t:!!s},l,!1,d)}},kn={udp:[3478,19302,19303,19304],tcp:[80,443],both:[19305,19306,19307,19308]},wn={STUN:"stun",TURN:"turn",TEMASYS:"temasys",DEFAULT_TURN_SERVER:"turn.temasys.io",TCP:"TCP",UDP:"UDP"},Ln=(e,t)=>{const{urls:n}=e;return[{urls:n,username:t.iceServers[1].username||null,credential:t.iceServers[1].credential||null}]},bn=e=>new de(A,{detail:e}),Gn=e=>new de(_,{detail:e}),Un=e=>new de(z,{detail:e}),Fn=class extends sn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:!1,candidate_id:null,candidate_sdp_mid:null,candidate_sdp_mindex:null,candidate_candidate:null,error:null}}send(e,t,n,s,r,o){const i=di.getSkylinkState(e);this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.sid||null,this.model.peer_id=n,this.model.client_id=i.clientId,this.model.state=t,this.model.is_remote=!!s,this.model.candidate_id=s||null,this.model.candidate_sdp_mid=r.sdpMid,this.model.candidate_sdp_mindex=r.sdpMLineIndex,this.model.candidate_candidate=r.candidate,this.model.app_key=di.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.error=("string"==typeof o?o:o&&o.message)||null,this.addToStatsBuffer("iceCandidate",this.model,this.endpoints.iceCandidate),this.manageStatsBuffer()}},Bn=new Fn,Vn=(e,t,n,s,o,i)=>{const{STATS_MODULE:a,ICE_CANDIDATE:d}=_t,{CANDIDATE_PROCESSING_STATE:l,TAGS:c}=r;Lt.log.ERROR([t,c.CANDIDATE_HANDLER,`${n}:${s}`,d.FAILED_ADDING_CANDIDATE],i),Dt(bn({room:Jr.getRoomInfo(e.id),state:l.PROCESS_ERROR,peerId:t,candidateId:n,candidateType:s,candidate:o,error:i})),Bn.send(e.id,a.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,t,n,o,i)},Hn=new class extends sn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,bundlePolicy:null,rtcpMuxPolicy:null}}send(e,t,n,s){const r=di.getSkylinkState(e);this.model.client_id=r.clientId,this.model.app_key=di.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.peer_id=n,this.model.state=t,this.model.is_remote=s,this.model.bundlePolicy=Vt("PEER_CONNECTION").bundlePolicy,this.model.rtcpMuxPolicy=Vt("PEER_CONNECTION").rtcpMuxPolicy,this.addToStatsBuffer("iceGathering",this.model,this.endpoints.iceGathering),this.manageStatsBuffer()}},xn=e=>{const t=di.getInitOptions(),n={iceServerName:null,iceServerPorts:kn,iceServerProtocol:wn.STUN,iceServers:[{urls:[]},{urls:[]}]},{iceServer:s,enableTURNServer:r,forceTURNSSL:o,TURNServerTransport:i,enableSTUNServer:a,usePublicSTUN:d}=t;if(e.forEach((e=>{if(0===e.url.indexOf(`${wn.STUN}:`))e.url.indexOf(`${wn.TEMASYS}`)>0?n.iceServerName=(e.url.split(":")[1]||"").split("?")[0]||null:n.iceServers[0].urls.push(e.url);else if(0===e.url.indexOf("turn:")&&e.url.indexOf("@")>0&&e.credential&&!n.iceServers[1].username&&!n.iceServers[1].credential){const t=(e.url.split(":")[1]||"").split("@");n.iceServerName=(t[1]||"").split("?")[0],n.iceServers[1].username=t[0],n.iceServers[1].credential=e.credential,n.iceServerProtocol=wn.TURN}})),s)return{iceServers:Ln(s,n)};if(n.iceServerName=n.iceServerName||wn.DEFAULT_TURN_SERVER,n.iceServerProtocol!==wn.TURN||r||o){const e=(e=>{const{forceTURNSSL:t,serverConfig:n}=e,s={tcp:n.iceServerPorts.tcp,udp:n.iceServerPorts.udp,both:n.iceServerPorts.both,iceServerProtocol:n.iceServerProtocol,iceServerPorts:n.iceServerPorts};return t?(s.iceServerPorts.udp=[],s.iceServerProtocol="turns"):ko(gt.FIREFOX)&&(s.udp=[3478],s.both=[]),s})({forceTURNSSL:o,enableTURNServer:r,CONSTANTS:wn,serverConfig:n});n.iceServerPorts.tcp=e.tcp,n.iceServerPorts.udp=e.udp,n.iceServerPorts.both=e.both,n.iceServerProtocol=e.iceServerProtocol}else n.iceServerProtocol=wn.STUN;const l=(e=>{const{TURNServerTransport:t,forceTURNSSL:n,udp:s,tcp:r,both:o}=e,i={udp:[],tcp:[],both:[]};return t!==_e.UDP||n?t===_e.TCP?(i.tcp=r.concat(o),i.udp=[],i.both=[]):t===_e.NONE?(i.tcp=[],i.udp=[]):(i.tcp=r,i.udp=s,i.both=o):(i.udp=s.concat(o),i.tcp=[],i.both=[]),i})({forceTURNSSL:o,TURNServerTransport:i,udp:n.iceServerPorts.udp,tcp:n.iceServerPorts.tcp,both:n.iceServerPorts.both});return n.iceServerPorts.tcp=l.tcp,n.iceServerPorts.udp=l.udp,n.iceServerPorts.both=l.both,n.iceServerProtocol===wn.STUN&&(n.iceServerPorts.tcp=[]),n.iceServerProtocol!==wn.STUN||a?(n.iceServerPorts.tcp.forEach((e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}?transport=tcp`)})),n.iceServerPorts.udp.forEach((e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}?transport=udp`)})),n.iceServerPorts.both.forEach((e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}`)})),d||n.iceServers.splice(0,1),{iceServers:n.iceServers}):(n.iceServers=[],null)},Wn=(e,t)=>{const n=di.getSkylinkState(t.id),s=n.peerCandidatesQueue[e]||[],o=n.peerConnections[e],{TAGS:i,PEER_CONNECTION_STATE:a}=r;for(let t=0;t<s.length;t+=1){const r=s[t];if(r){const t=r[1],s=r[0],o=t.candidate.split(" ")[7];Lt.log.DEBUG([e,i.CANDIDATE_HANDLER,`${s}:${o}`,_t.ICE_CANDIDATE.ADD_BUFFERED_CANDIDATE]),Yn.addIceCandidate(e,s,o,t,n)}else if(o&&o.signalingState!==a.CLOSED)try{o.addIceCandidate(null),Lt.log.DEBUG([e,i.CANDIDATE_HANDLER,null,_t.ICE_CANDIDATE.CANDIDATE_ADDED])}catch(t){Lt.log.DEBUG([e,i.CANDIDATE_HANDLER,null,_t.ICE_CANDIDATE.FAILED_ADDING_CANDIDATE])}}delete n.peerCandidatesQueue[e],Ho.signalingEndOfCandidates(e,n)},$n=(e,t,n,s,o)=>{const i=di.getSkylinkState(o.room.id),{peerConnections:a,room:d}=i,l=a[e],c={candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex},{STATS_MODULE:E,ICE_CANDIDATE:S,PEER_CONNECTION:R}=_t,{CANDIDATE_PROCESSING_STATE:u,PEER_CONNECTION_STATE:I,TAGS:g}=r;Lt.log.DEBUG([e,g.CANDIDATE_HANDLER,`${t}:${n}`,S.ADDING_CANDIDATE]),Dt(bn({peerId:e,room:Jr.getRoomInfo(d.id),candidateType:n,candidate:c,candidateId:t,state:u.PROCESSING,error:null})),Bn.send(d.id,E.HANDLE_ICE_GATHERING_STATS.PROCESSING,e,t,c),l&&l.signalingState!==I.CLOSED&&l.remoteDescription&&l.remoteDescription.sdp&&l.remoteDescription.sdp.indexOf(`\r\na=mid:${c.sdpMid}\r\n`)>-1||(Lt.log.WARN([e,g.CANDIDATE_HANDLER,`${t}:${n}`,`${S.DROPPING_CANDIDATE} - ${R.NO_PEER_CONNECTION}`]),Dt(bn({peerId:e,room:Jr.getRoomInfo(d.id),candidateType:n,candidate:c,candidateId:t,state:Oe.DROPPED,error:new Error(R.NO_PEER_CONNECTION)})),Bn.send(d.id,E.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,e,t,c,R.NO_PEER_CONNECTION));try{l.addIceCandidate(c).then((()=>{((e,t,n,s,o)=>{const{STATS_MODULE:i,ICE_CANDIDATE:a}=_t,{CANDIDATE_PROCESSING_STATE:d,TAGS:l}=r;Lt.log.INFO([t,l.CANDIDATE_HANDLER,`${n}:${s}`,a.CANDIDATE_ADDED]),Dt(bn({room:Jr.getRoomInfo(e.id),state:d.PROCESS_SUCCESS,peerId:t,candidateId:n,candidateType:s,candidate:o,error:null})),Bn.send(e.id,i.HANDLE_ICE_GATHERING_STATS.PROCESS_SUCCESS,t,n,o)})(d,e,t,n,c)})).catch((s=>{Vn(d,e,t,n,c,s)}))}catch(s){Vn.bind(l,d,e,t,n,c,s)}},Kn=(e,t,n)=>{const s=di.getSkylinkState(n.id),o=s.peerConnections[e],i=new Fr;let a=s.gatheredCandidates[e];const{CANDIDATE_GENERATION_STATE:d,TAGS:l}=r;if(!o)return Lt.log.WARN([e,l.CANDIDATE_HANDLER,null,_t.PEER_CONNECTION.NO_PEER_CONNECTION],t),null;if(t.candidate){o.gathering||(Lt.log.WARN([e,l.CANDIDATE_HANDLER,null,_t.ICE_CONNECTION.ICE_GATHERING_STARTED],t),o.gathering=!0,o.gathered=!1,Dt(Gn({room:Jr.getRoomInfo(n.id),peerId:e,state:Te.GATHERING})),Hn.send(n.id,d.GATHERING,e,!1));const r=t.candidate.split(" ")[7];if(Lt.log.DEBUG([e,l.CANDIDATE_HANDLER,r,_t.ICE_CANDIDATE.CANDIDATE_GENERATED],t),"endOfCandidates"===r||!(o&&o.localDescription&&o.localDescription.sdp&&o.localDescription.sdp.indexOf(`\r\na=mid:${t.sdpMid}\r\n`)>-1))return Lt.log.WARN([e,l.CANDIDATE_HANDLER,r,_t.ICE_CONNECTION.DROP_EOC],t),null;a||(a={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),a.sending[r].push({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}),s.gatheredCandidates[e]=a,di.setSkylinkState(s,n.id),Lt.log.DEBUG([e,l.CANDIDATE_HANDLER,r,_t.ICE_CANDIDATE.SENDING_CANDIDATE],t),i.sendCandidate(e,s,t)}else{if(Lt.log.INFO([e,l.CANDIDATE_HANDLER,null,_t.ICE_CONNECTION.ICE_GATHERING_COMPLETED]),o.gathered)return null;o.gathering=!1,o.gathered=!0,Dt(Gn({peerId:e,state:Te.COMPLETED,room:n})),Hn.send(n.id,d.COMPLETED,e,!1),s.gatheredCandidates[e]&&setTimeout((()=>{s.gatheredCandidates[e]&&(di.getSkylinkState(n.id)?i.sendMessage({type:ze.END_OF_CANDIDATES,noOfExpectedCandidates:s.gatheredCandidates[e].sending.srflx.length+s.gatheredCandidates[e].sending.host.length+s.gatheredCandidates[e].sending.relay.length,mid:s.user.sid,target:e,rid:n.id}):Lt.log.WARN([e,l.CANDIDATE_HANDLER,null,`${_t.ICE_CONNECTION.DROP_EOC} peer has left the room`]))}),6e3)}return null},jn=(e,t,n,s,r)=>{const{STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:o}}=_t,i=r,{room:a}=i,d=new Fn;Lt.log.DEBUG([e,it.CANDIDATE_HANDLER,`${t}:${n}`,_t.ICE_CANDIDATE.ADD_CANDIDATE_TO_BUFFER]),d.send(a.id,o.BUFFERED,e,t,s),Dt(bn({room:Jr.getRoomInfo(a.id),state:Oe.BUFFERED,peerId:e,candidateId:t,candidateType:n,candidate:s.candidate,error:null})),i.peerCandidatesQueue[e]=i.peerCandidatesQueue[e]||[],i.peerCandidatesQueue[e].push([t,s]),di.setSkylinkState(i,a.id)},Yn=class{static setIceServers(e){return xn(e)}static addIceCandidateFromQueue(e,t){return Wn(e,t)}static addIceCandidateToQueue(e,t,n,s,r){return jn(e,t,n,s,r)}static addIceCandidate(e,t,n,s,r){return $n(e,t,n,s,r)}static onIceCandidate(e,t,n){return Kn(e,t,n)}},Jn=(e,t)=>e.id===t.id,Qn=(e={})=>new de(l,{detail:e}),Zn=(e={})=>new de(c,{detail:e}),qn=(e={})=>new de(E,{detail:e}),Xn=(e={})=>new de(w,{detail:e}),zn=class{static updatePeerStreamWithUserSid(e,t){const n=di.getSkylinkState(e.id);n.peerStreams.null&&(n.peerStreams[t]=Object.assign({},n.peerStreams.null),delete n.peerStreams.null,di.setSkylinkState(n,e.id))}static addStream(e,t=null,n){if(!t)return;const s=di.getSkylinkState(n),{peerStreams:r}=s;r[e]&&r[e][t.id]||(r[e]=r[e]||{},r[e][t.id]=t,di.setSkylinkState(s,n))}static deleteStream(e,t){const n=di.getSkylinkState(e.id),{user:s}=n,r=t.id;delete n.peerStreams[s.sid][r],So(n.peerStreams[s.sid])&&delete n.peerStreams[s.sid],di.setSkylinkState(n,n.room.id)}static dispatchStreamEvent(e,t){switch(e){case l:Dt(Qn(t));break;case c:Dt(Zn(t));break;case E:Dt(qn(t));break;case w:Dt(Xn(t))}}},es=(e,t)=>!(!e||!e[0]||(e.forEach((e=>{try{e.stop()}catch(n){Lt.log.ERROR([t,it.MEDIA_STREAM,null,`${_t.MEDIA_STREAM.ERRORS.STOP_MEDIA_TRACK} - track id: ${e.id}`],n)}})),0)),ts=(e,t,n)=>{const{room:s}=e,r=e;let o=-1;if(!r.currentRTCRTPSenders[t])return;const i=r.currentRTCRTPSenders[t];for(let e=0;e<i.length;e+=1)if(n===i[e]){o=e;break}-1!==o?(i.splice(o,1),r.currentRTCRTPSenders[t]=i,di.setSkylinkState(r,s.id)):Lt.log.WARN([t,null,null,"No matching sender was found for the peer."],n)},ns={prepStopStreams:(e,t,n=!1,s=!1)=>new Promise(((r,o)=>{const i=di.getSkylinkState(e),{user:a,peerStreams:d}=i;i||o(new Error(`${_t.ROOM_STATE.NOT_FOUND} - ${e}`)),(!d[a.sid]||t&&!d[a.sid][t])&&o(new Error(`${_t.MEDIA_STREAM.ERRORS.NO_STREAM} - ${t}`)),s?ns.prepStopScreenStream(i.room,t,n).then((()=>r())).catch((e=>o(e))):ns.prepStopUserMediaStreams(i,t,n).then((()=>r())).catch((e=>o(e)))})),prepStopUserMediaStreams:(e,t,n)=>new Promise(((s,r)=>{const{user:o,peerStreams:i}=e,a=(e=>{const{peerStreams:t,user:n,room:s}=e;return Object.keys(t[n.sid]).map((e=>Js.retrieveScreenMediaInfo(s,n.sid,{streamId:e})?null:t[n.sid][e])).filter((e=>null!==e))})(e);try{if(t){const s=i[o.sid][t];ns.stopAddedStream(e,s,!1,n)}else ns.stopAddedStreams(e,a,!1,n);return ns.initRefreshConnectionAndResolve(e.room,n,s,r)}catch(e){Lt.log.DEBUG([o.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA],e),r(_t.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA)}})),stopAddedStream:(e,t,n=!1,s=!1)=>{const{room:r,user:o}=e;try{ns.tryStopStream(t,o.sid),s||(ns.removeTracks(r,t),Js.setMediaStateToUnavailable(r,o.sid,Js.retrieveMediaId(t.getTracks()[0].kind,t.id)),zn.deleteStream(r,t),ns.listenForEventAndDeleteMediaInfo(r,t),ns.dispatchEvents(r,t,n),n&&new Jo(e).deleteScreensharingInstance(r)),Lt.log.INFO([o.sid,it.MEDIA_STREAM,null,`${_t.MEDIA_STREAM.STOP_SUCCESS} - stream id: ${t.id} ${n?"(screenshare)":""}`])}catch(e){Lt.log.ERROR([o.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.ERRORS.STOP_ADDED_STREAM],e)}},tryStopStream:(e,t)=>{if(e){try{es(e.getAudioTracks())}catch(n){Lt.log.ERROR([t,it.MEDIA_STREAM,null,`${_t.MEDIA_STREAM.ERRORS.STOP_AUDIO_TRACK} - stream id: ${e.id}`],n)}try{es(e.getVideoTracks())}catch(n){Lt.log.ERROR([t,it.MEDIA_STREAM,null,`${_t.MEDIA_STREAM.ERRORS.STOP_VIDEO_TRACK} - stream id: ${e.id}`],n)}}},removeTracks:(e,t)=>{const n=di.getSkylinkState(e.id),{peerConnections:s,user:r}=n,o=t.getTracks();try{o.forEach((e=>{((e,t,n)=>{const s=n.id,r=Object.keys(t);for(let n=0;n<r.length;n+=1)try{const o=r[n],i=t[o];if(i.connectionState===he.CLOSED)break;const a=i.getSenders();let d=null;for(let t=0;t<a.length;t+=1)a[t].track&&a[t].track.id===s&&(d=a[t],i.removeTrack(d),ts(e,o,d))}catch(e){Lt.log.ERROR([r[n],it.PEER_CONNECTION,null,_t.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e)}})(n,s,e)}))}catch(e){Lt.log.ERROR([r.sid,it.PEER_CONNECTION,null,_t.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e)}},listenForEventAndDeleteMediaInfo:(e,t)=>{const n=di.getSkylinkState(e.id),s=s=>{const r=t,{user:o}=n,{detail:i}=s;if(i.state===Pe.OFFER){const t=Js.retrieveMediaId(yo(r)?lt.AUDIO:lt.VIDEO,r.id);Js.deleteUnavailableMedia(e,o.sid,t)}},r=()=>{Ct(At.HANDSHAKE_PROGRESS,s),Ct(At.MEDIA_INFO_DELETED,r)};Nt(At.HANDSHAKE_PROGRESS,s),Nt(At.MEDIA_INFO_DELETED,r)},stopAddedStreams:(e,t,n,s)=>{t.forEach((t=>{ns.stopAddedStream(e,t,n,s)}))},updateMediaInfoMediaState:(e,t)=>{const n=di.getSkylinkState(e.id),{user:s}=n,r=t.id,o=Js.retrieveMediaId(t.getTracks()[0].kind,r);Js.setMediaStateToUnavailable(e,s.sid,o)},dispatchEvents:(e,t,n=!1)=>{const s=di.getSkylinkState(e.id),{MEDIA_STREAM:r}=_t,{user:o}=s;Lt.log.INFO([o.sid,it.MEDIA_STREAM,null,r.STOP_SETTINGS],{peerId:o.sid,isSelf:!0,isScreensharing:n,stream:t}),zn.dispatchStreamEvent(E,{room:Jr.getRoomInfo(e.id),peerId:o.sid,peerInfo:Xr.getCurrentSessionInfo(e),isSelf:!0,isScreensharing:n,streamId:t.id,isVideo:vo(t),isAudio:yo(t)}),Dt(((e={})=>new de($,{detail:e}))({isScreensharing:n,streamId:t.id})),Dt(Ht({peerId:o.sid,peerInfo:qr.getCurrentSessionInfo(e),isSelf:!0}))},prepStopScreenStream:(e,t,n=!1)=>new Promise(((s,r)=>{const o=di.getSkylinkState(e.id),{user:i,peerStreams:a}=o,d=a[i.sid][t];try{ns.stopAddedStream(o,d,!0,n),ns.initRefreshConnectionAndResolve(o.room,n,s,r)}catch(e){Lt.log.DEBUG([i.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.ERRORS.STOP_SCREEN],e),r(new Error(_t.MEDIA_STREAM.ERRORS.STOP_SCREEN))}})),initRefreshConnectionAndResolve:(e,t,n,s)=>{const r=di.getSkylinkState(e.id),{peerConnections:o}=r;try{if(!t){if(Ro(Object.keys(o)))return(e=>{const{room:t,user:n}=e;Dt(Ht({peerId:n.sid,isSelf:!0,peerInfo:Xr.getCurrentSessionInfo(t)}))})(r),Js.deleteUnavailableMedia(r.room,r.user.sid),n();{const e=e=>{const{detail:t}=e;if(t.state===Pe.ANSWER_ACK)return n()};Nt(At.HANDSHAKE_PROGRESS,e),Ho.refreshConnection(r)}}}catch(e){s(e)}}};class ss{static getUserMedia(e,t={}){const{room:n}=e,s=Eo.parseMediaOptions(t,e),{audio:r,video:o}=t,i=!!t.useExactConstraints;return di.setSkylinkState(s,n.id),Eo.prepMediaAccessRequest({useExactConstraints:i,audio:r,video:o,roomKey:n.id})}static processUserMediaOptions(e,t=null){return new Promise(((n,s)=>{let r={audio:!0,video:!0};t||Lt.log.WARN([e.user.sid,it.MEDIA_STREAM,null,`${_t.MEDIA_STREAM.NO_OPTIONS} - ${_t.MEDIA_STREAM.DEFAULT_OPTIONS}`],r),Io(t)||(Lt.log.ERROR([e.user.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS],t),s(new Error(_t.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),null)),r=t,ss.getUserMedia(e,r).then((e=>{n(e)})).catch((e=>{s(e)}))}))}static stopStreams(e,t){return ns.prepStopStreams(e.room.id,t)}static addLocalMediaStreams(e,t){Eo.addLocalMediaStreams(e,t)}static onRemoteTrackAdded(e,t,n,s,r,o){Eo.onRemoteTrackAdded(e,t,n,s,r,o)}static muteStreams(e,t,n){return Eo.muteStreams(e,t,n)}static sendStream(e,t){return Eo.sendStream(e,t)}static getStreamSources(){return Eo.getStreamSources()}static getStreams(e,t){return Eo.getStreams(e,t)}static usePrefetchedStream(e,t,n=null){return new Promise((s=>{!t&&n.id&&n.active&&(t=n);const r={audio:0!==t.getAudioTracks().length,video:0!==t.getVideoTracks().length},o=Eo.parseStreamSettings(r,lt.AUDIO),i=Eo.parseStreamSettings(r,lt.VIDEO);s(Eo.onStreamAccessSuccess(e,t,o,i,!1,!1,!0))}))}static buildStreamSettings(e,t,n){return Eo.buildStreamSettings(e,t,n)}}const rs=ss,os=new class extends sn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,weight:null,sdp_type:null,sdp_sdp:null,error:null}}send(e,t,n,s,r,o){const i=di.getSkylinkState(e);this.model.client_id=i.clientId,this.model.app_key=di.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.sid||null,this.model.peer_id=n,this.model.state=t,this.model.is_remote=r,this.model.weight=s.weight||null,this.model.error=("string"==typeof o?o:o&&o.msg)||null,this.model.sdp_type=null,this.model.sdp_sdp=null,-1===["enter","welcome"].indexOf(this.model.state)&&(this.model.weight=this.model.is_remote&&Xr.getPeerInfo(this.model.peer_id,i.room).config&&Xr.getPeerInfo(this.model.peer_id,i.room).config.priorityWeight?Xr.getPeerInfo(this.model.peer_id,i.room).config.priorityWeight:Xr.getCurrentSessionInfo(i.room).config.priorityWeight,this.model.sdp_type=s&&s.type||null,this.model.sdp_sdp=s&&s.sdp||null),this.addToStatsBuffer("negotiation",this.model,this.endpoints.negotiation),this.manageStatsBuffer()}},is=(e,t,n,s,r)=>{const o=di.getSkylinkState(n.room.id),{peerConnections:i,bufferedLocalOffer:a,peerPriorityWeight:d,room:l}=o,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:c}}=_t,E=i[t],S={type:s.type,sdp:s.sdp};if(E.processingLocalSDP=!0,Lt.log.INFO([t,"RTCSessionDescription",s.type,"Local session description updated ->"],S.sdp),s.type===Pe.OFFER){os.send(l.id,c.OFFER.offer,t,s,!1),Lt.log.INFO([t,"RTCSessionDescription",s.type,"Local offer saved."]),a[t]=s;const i={type:S.type,sdp:S.sdp,mid:o.user.sid,target:t,rid:n.room.id,userInfo:Xr.getUserInfo(n.room),weight:d,mediaInfoList:Js.retrieveMediaInfoForOfferAnswer(l,S)};if(r&&Object.keys(r).length){const e=Object.keys(r),t=Object.keys(i);for(let n=0;n<e.length;n+=1){const s=e[n];-1===t.indexOf(s)&&(i[s]=r[s])}}e(i)}else os.send(l.id,c.ANSWER.answer,t,s,!1),e({type:S.type,sdp:S.sdp,mid:o.user.sid,target:t,rid:n.room.id,userInfo:Xr.getUserInfo(n.room),mediaInfoList:Js.retrieveMediaInfoForOfferAnswer(l,S)})},as=(e={})=>new de(m,{detail:e}),{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:ds}}=_t,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:ls}}=_t,cs=(e,t,n,s,r)=>{const o=di.getSkylinkState(e.room.id),i=o.peerConnections[t],a=o.dataChannels[t];let d=s;if(d&&d!==t||(d="main"),!("object"==typeof n&&n||n&&"string"==typeof n))return Lt.log.WARN([t,"RTCDataChannel",d,"Dropping invalid data ->"],n),null;if(!i||i.signalingState===he.CLOSED)return Lt.log.WARN([t,"RTCDataChannel",d,"Dropping for sending message as Peer connection does not exists or is closed ->"],n),null;if(!a||!a[d])return Lt.log.WARN([t,"RTCDataChannel",d,"Dropping for sending message as Datachannel connection does not exists ->"],n),null;const l=a[d].channelName,c=a[d].channelType,E=a[d].channel.readyState,S="object"==typeof n&&n.type===Xe.MESSAGE?Ee.MESSAGE:Ee.TRANSFER;if(E!==le.OPEN){const e=new Error(`Failed sending message as Datachannel connection state is not opened. Current readyState is ${E}`);throw Lt.log.ERROR([t,"RTCDataChannel",d,e],n),Dt(On({peerId:t,channelName:l,channelType:c,messageType:S,error:e,state:le.SEND_MESSAGE_ERROR,bufferAmount:Ho.getDataChannelBuffer(a[d].channel)})),e}try{r||"object"!=typeof n?(Lt.log.DEBUG([t,"RTCDataChannel",d,"Sending data with size ->"],n.size||n.length||n.byteLength),a[d].channel.send(n)):(Lt.log.DEBUG([t,"RTCDataChannel",d,`Sending ${n.type} protocol message ->`],n),a[d].channel.send(JSON.stringify(n)))}catch(e){throw Lt.log.ERROR([t,"RTCDataChannel",d,"Failed sending data)"],{error:e,data:n}),Dt(On({peerId:t,channelName:l,channelType:c,messageType:S,error:e,state:le.SEND_MESSAGE_ERROR,bufferAmount:Ho.getDataChannelBuffer(a[d].channel)})),e}return null},Es=class extends sn{constructor(){super();const{AdapterJS:e}=window;this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,channel_id:null,channel_label:null,channel_type:null,channel_binary_type:null,error:null,agent_name:e.webrtcDetectedBrowser,agent_type:e.webrtcDetectedType,agent_version:e.webrtcDetectedVersion}}send(e,t,n,s,r,o){const i=di.getSkylinkState(e);this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.uid||null,this.model.peer_id=n,this.model.client_id=i.clientId,this.model.state=t,this.model.channel=s,this.model.channel_id=s.id,this.model.channel_label=s.label,this.model.channel_type="main"===r?"persistent":"temporal",this.model.channel_binary_type=s.binaryType,this.model.app_key=di.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.error=("string"==typeof o?o:o&&o.message)||null,"plugin"===this.model.agent_name&&(this.model.channel_binary_type="int8Array","IE"===this.model.agent_name&&this.model.agent_version<11&&(this.model.channel_binary_type="none")),this.postStats(this.endpoints.dataChannel,this.model)}},Ss={onopen:e=>{const{dataChannel:t,channelProp:n,channelName:s,channelType:r,peerId:o,roomState:i,bufferThreshold:a}=e,d=new Es,{room:l}=i,{STATS_MODULE:c}=_t;Lt.log.DEBUG([o,"RTCDataChannel",n,"Datachannel has opened"]),t.bufferedAmountLowThreshold=a||0,d.send(l.id,c.HANDLE_DATA_CHANNEL_STATS.closed,o,t,n),Dt(On({state:le.OPEN,peerId:o,channelName:s,channelType:r,bufferAmount:Ho.getDataChannelBuffer(t)}))},onmessage:(e,t)=>{const{peerId:n,channelName:s,channelType:r,roomState:o}=e;((e,t,n,s,r)=>{const o=di.getSkylinkState(e.room.id);let i=null,a=null,d=!1;const l=r===ce.MESSAGING?"main":s,c=o.dataChannels[n]||{};if(!c.hasOwnProperty(l)||"object"!=typeof c[l])return null;if(i=c[l].transferId,a=c[l].streamId,a&&o.dataStreams&&o.dataStreams[a]&&(d="string"===o.dataStreams[a].sessionChunkType?"string"==typeof t:"object"==typeof t),!o.peerConnections[n])return Lt.log.WARN([n,"RTCDataChannel",l,"Dropping data received from Peer as connection is not present ->"],t),null;if(!o.dataChannels[n]||!o.dataChannels[n][l])return Lt.log.WARN([n,"RTCDataChannel",l,"Dropping data received from Peer as Datachannel connection is not present ->"],t),null;if("string"==typeof t)try{const s=JSON.parse(t);if(d=!1,Lt.log.DEBUG([n,"RTCDataChannel",l,`Received protocol ${s.type} message ->`],s),[Xe.ACK,Xe.ERROR,Xe.CANCEL].indexOf(s.type)>-1&&!(i&&o.dataTransfers[i]&&o.dataTransfers[i].sessions[n]))return Lt.log.WARN([n,"RTCDataChannel",l,"Discarded protocol message as data transfer session is not present ->"],s),null;switch(s.type){case Xe.WRQ:if(i&&o.dataTransfers[i]&&o.dataTransfers[i].sessions[n]){Lt.log.WARN([n,"RTCDataChannel",l,"Rejecting bidirectional data transfer request as it is currently not supported in the SDK ->"],s),cs(e,n,{type:Xe.ACK,ackN:-1,sender:o.user.sid},l);break}break;case Xe.MESSAGE:((e,t,n,s)=>{const r=n.sender||t;Lt.log.INFO([r,"RTCDataChannel",s,"Received P2P message from peer:"],n),Dt(An({room:e.room,message:{targetPeerId:n.target,content:n.data,senderPeerId:r,isDataChannel:!0,isPrivate:n.isPrivate},isSelf:!1,peerId:r,peerInfo:Xr.getPeerInfo(r,e.room)}))})(o,n,s,l);break;default:Lt.log.WARN([n,"RTCDataChannel",l,`Discarded unknown ${s.type} message ->`],s)}}catch(e){Dt(On({peerId:n,channelName:s,channelType:r,error:e,state:le.ERROR,bufferAmount:Ho.getDataChannelBuffer(o.dataChannels[n][l].channel)}))}})(o,t.data,n,s,r)},onerror:(e,t)=>{const{dataChannel:n,peerId:s,channelName:r,channelProp:o,channelType:i,roomState:a}=e;if("NONE"===t.error.errorDetail||0===t.error.code)Lt.log.DEBUG([s,"RTCDataChannel",o,"Datachannel state ->"],t.error.message);else{const e=di.getSkylinkState(a.room.id),{room:d}=e,l=new Es;Lt.log.ERROR([s,"RTCDataChannel",o,"Datachannel has an exception ->"],t),l.send(d.id,le.ERROR,s,n,o,t),Dt(On({state:le.ERROR,peerId:s,channelName:r,channelType:i,bufferAmount:Ho.getDataChannelBuffer(n),error:t}))}},onbufferedamountlow:e=>{const{dataChannel:t,peerId:n,channelName:s,channelProp:r,channelType:o,roomState:i}=e,a=di.getSkylinkState(i.room.id),{room:d}=a;Lt.log.DEBUG([n,"RTCDataChannel",r,"Datachannel buffering data transfer low"]),Dt(On({state:le.BUFFERED_AMOUNT_LOW,room:Jr.getRoomInfo(d.id),peerId:n,channelName:s,channelType:o,bufferAmount:Ho.getDataChannelBuffer(t)}))},onclose:e=>{const{dataChannel:t,peerId:n,channelName:s,channelProp:r,channelType:o,roomState:i}=e,{DATA_CHANNEL:a,STATS_MODULE:d}=_t,l=di.getSkylinkState(i.room.id)||Object.values(di.getSkylinkState())[0];if(!l)return;const{room:c,peerConnections:E}=l,S=new Es;Lt.log.DEBUG([n,"RTCDataChannel",r,a.closed]);try{if(S.send(c.id,d.HANDLE_DATA_CHANNEL_STATS.closed,n,t,r),Dt(On({state:le.CLOSED,peerId:n,room:Jr.getRoomInfo(c.id),channelName:s,channelType:o,bufferAmount:Ho.getDataChannelBuffer(t)})),E[n]&&E[n].remoteDescription&&E[n].remoteDescription.sdp&&(-1===E[n].remoteDescription.sdp.indexOf("m=application")||E[n].remoteDescription.sdp.indexOf("m=application 0")>0))return;o===ce.MESSAGING&&setTimeout((()=>{E[n]&&E[n].signalingState!==he.CLOSED&&E[n].localDescription&&E[n].localDescription.type===Pe.OFFER&&(Lt.log.DEBUG([n,"RTCDataChannel",r,a.reviving_dataChannel]),Ho.createDataChannel({peerId:n,dataChannel:t,bufferThreshold:Ho.getDataChannelBuffer(t),createAsMessagingChannel:!0,roomState:l}),S.send(c.id,d.HANDLE_DATA_CHANNEL_STATS.reconnecting,n,{label:s},"main"))}),100)}catch(e){Lt.log.WARN([n,"RTCDataChannel",r,a.closed])}}},Rs=(e,t,n)=>{const s=di.getInitOptions(),{dataChannels:r,room:o,user:i,hasMCU:a}=e;let d=Object.keys(r),l=!1;if(Array.isArray(n)&&n.length?(d=n,l=!0):n&&"string"==typeof n&&(d=[n],l=!0),!o.inRoom||!i||!i.sid)return Lt.log.ERROR("Unable to send message as User is not in Room. ->",t),null;if(!s.enableDataChannel)return Lt.log.ERROR("Unable to send message as User does not have DataChannel enabled. ->",t),null;for(let s=0;s<d.length;s+=1){const o=d[s];r[o]||a?o===pt.MCU?(d.splice(s,1),s-=1):a||(Lt.log.DEBUG([o,"RTCDataChannel",null,`Sending ${l?"private":""} P2P message to Peer.`]),cs(e,o,{type:Xe.MESSAGE,isPrivate:l,sender:i.sid,target:n?o:null,data:t},"main")):(Lt.log.ERROR([o,"RTCDataChannel",null,"Dropping of sending message to Peer as DataChannel connection does not exist."]),d.splice(s,1),s-=1)}return 0===d.length&&Lt.log.WARN("Currently there are no Peers to send P2P message to."),a&&(Lt.log.DEBUG([pt.MCU,"RTCDataChannel",null,`Broadcasting ${l?"private":""} P2P message to Peers.`]),cs(e,pt.MCU,{type:Xe.MESSAGE,isPrivate:l,sender:i.sid,target:d,data:t},"main")),!n&&a||Dt(An({room:Jr.getRoomInfo(e.room.id),message:{targetPeerId:n||null,content:t,senderPeerId:i.sid,isDataChannel:!0,isPrivate:l},isSelf:!0,peerId:i.sid,peerInfo:Xr.getCurrentSessionInfo(e.room)})),null},us=(e,t,n)=>{const{dataChannels:s}=e,r=s[t][n],{channelName:o,channelType:i}=r.channelName;if(r.readyState!==le.CLOSED){const{room:a}=e,d=new Es;Lt.log.DEBUG([t,it.DATA_CHANNEL,n,_t.DATA_CHANNEL.CLOSING]),d.send(a.id,le.CLOSING,t,r.channel,n),Dt(On({room:a,peerId:t,state:le.CLOSING,channelName:o,channelType:i,bufferAmount:Ho.getDataChannelBuffer(r.channel)})),r.channel.close(),delete s[t][n]}},Is=(e,t,n)=>{const s={};return s.listOfPeers=e,s.refreshErrors=t,s.refreshSettings=n,s},gs=(e,t,n)=>{const s=[];return Object.keys(e).forEach((r=>{s.push(((e,t,n,s)=>{const r=di.getSkylinkState(t.id),{hasMCU:o,peerInformations:i,enableIceRestart:a}=r,d=Xr.getPeersCustomSettings(r),l={};return l[e]={iceRestart:!o&&i[e]&&i[e].config&&i[e].config.enableIceRestart&&a&&n,customSettings:d[e]||{}},s&&(l.errors=s),l})(e[r],t,n))})),s},ps=(e,t)=>{const n={};return n[e]=t,n},ms=(e,t,n,s)=>new Promise(((r,o)=>{e||o(new Error(_t.ROOM_STATE.NO_ROOM_NAME));const{peerConnections:i,hasMCU:a,room:d}=e,l=di.getInitOptions(),{mcuUseRenegoRestart:c}=l,{PEER_CONNECTION:E}=_t,S=((e,t,n,s)=>{let r=!1,o={},i=Object.keys(s);return Array.isArray(e)?i=e:Oo(e)?i=[e]:To(e)?r=e:e&&Io(e)&&(o=e),To(t)?r=t:t&&Io(t)&&(o=t),n&&Io(n)&&(o=n),{listOfPeers:i,doIceRestart:r,bwOptions:o}})(t,n,s,i),{listOfPeers:R,doIceRestart:u,bwOptions:I}=S;try{!Ro(R)||a&&!c||(Lt.log.ERROR(E.NO_PEER_CONNECTION),o({refreshErrors:{self:E.NO_PEER_CONNECTION},listOfPeers:R})),Lt.log.INFO([null,it.PEER_CONNECTION,null,E.REFRESH_CONNECTION.START]),Ho.refreshPeerConnection(R,e,u,I).then((e=>{const t=a?[e]:e,n=[];for(let e=0;e<t.length;e+=1)if(Array.isArray(t[e])){const s=t[e];n.push(ps(s[0],s[1])),Lt.log.WARN([R,it.PEER_CONNECTION,null,E.REFRESH_CONNECTION.FAILED],s[0])}else Oo(t[e])&&Lt.log.INFO([R,it.PEER_CONNECTION,null,E.REFRESH_CONNECTION.SUCCESS],t[e]);n.length===R.length?o(Is(R,n,gs(R,d,u))):r(Is(R,n,gs(R,d,u)))})).catch((e=>Lt.log.ERROR([null,it.PEER_CONNECTION,null,E.REFRESH_CONNECTION.FAILED],e))).finally((()=>Lt.log.INFO(E.REFRESH_CONNECTION.COMPLETED)))}catch(e){o(e)}})),Ts=(e,t,n)=>{const{room:s}=e,r=new Fr;try{const e=r.messageBuilder.getRestartOfferMessage(s.id,t,n);return r.offer(s,t,n,e),t}catch(e){return[t,e]}},Os=(e,t,n)=>{const s=di.getSkylinkState(t.room.id),{peerConnections:r,streamsBandwidthSettings:o,peerEndOfCandidatesCounter:i,room:a,user:d}=s,{doIceRestart:l,bwOptions:c}=n,E=new Fr,S=[];return new Promise((t=>{if(!r[e])return Lt.log.ERROR([e,null,null,_t.PEER_CONNECTION.ERRORS.NOT_FOUND]),S.push(_t.PEER_CONNECTION.ERRORS.NOT_FOUND),t([e,S]);const n=r[e];if(0!==S.length)return t([e,S]);if(n.signalingState===he.STABLE)return Lt.log.INFO([e,null,null,_t.PEER_CONNECTION.REFRESH_CONNECTION.SEND_RESTART_OFFER],{iceRestart:l,options:c}),s.streamsBandwidthSettings.bAS=c.bandwidth||o.bAS,s.peerEndOfCandidatesCounter[e]=i[e]||{},s.peerEndOfCandidatesCounter[e].len=0,di.setSkylinkState(s,s.room.id),t(Ts(s,e,l));const R=n.localDescription&&n.localDescription.sdp;return n.signalingState===he.HAVE_LOCAL_OFFER&&R?(E.sendMessage({type:n.localDescription.type,sdp:n.localDescription.sdp,mid:d.sid,target:e,rid:a.id,restart:!0}),t(e)):(Lt.log.DEBUG([e,it.PEER_CONNECTION,null,_t.PEER_CONNECTION.REFRESH_CONNECTION.NO_LOCAL_DESCRIPTION],{localDescription:n.localDescription,remoteDescription:n.remoteDescription,signalingState:n.signalingState}),S.push(_t.PEER_CONNECTION.REFRESH_CONNECTION.NO_LOCAL_DESCRIPTION),t([e,S]),null)}))},As=(e,t,n)=>Os(e,t,n),_s=(e,t,n=!1,s)=>{const r=di.getSkylinkState(e.id),o=di.getInitOptions(),{enableDataChannel:i}=o,{peerConnections:a,hasMCU:d,enableIceRestart:l,peerInformations:c,voiceActivityDetection:E,dataChannels:S}=r,R=a[t],u={iceRestart:!!((c[t]||{}).config||{}).enableIceRestart&&n&&l,voiceActivityDetection:E};return d&&"function"!=typeof R.addTransceiver&&(u.offerToReceiveVideo=!0),d&&t!==pt.MCU||rs.addLocalMediaStreams(t,r),i&&c[t].config.enableDataChannel&&(S[t]&&S[t].main||(Ho.createDataChannel({peerId:t,roomState:r,createAsMessagingChannel:!0}),r.peerConnections[t].hasMainChannel=!0)),Lt.log.DEBUG([t,null,null,"Creating offer with config:"],u),R.endOfCandidates=!1,R.negotiating=!0,R.sdpConstraints=u,di.setSkylinkState(r,e.id),new Promise(((e,n)=>{R.createOffer(u).then((n=>((e,t,n,s,r)=>{const{room:o}=n;Lt.log.DEBUG([t,null,null,"Created offer"],r),os.send(o.id,ds.OFFER.create,t,r,!1),is(e,t,n,r,s)})(e,t,r,s,n))).catch((e=>((e,t,n,s)=>{const{room:r}=n;Lt.log.ERROR([t,null,null,"Failed creating an offer:"],s),os.send(r.id,ds.OFFER.create_error,t,null,!1,s),Dt(as({state:Pe.ERROR,peerId:t,error:s,room:Jr.getRoomInfo(n.room.id)})),e(s)})(n,t,r,e)))}))},hs=(e,t)=>{const n=di.getSkylinkState(e.room.id),{peerConnections:s,hasMCU:r,voiceActivityDetection:o}=n,i=s[t],a={voiceActivityDetection:o};return Lt.log.INFO([t,null,null,"Creating answer with config:"],a),r&&t!==pt.MCU||rs.addLocalMediaStreams(t,e),new Promise(((n,s)=>i.createAnswer(a).then((s=>((e,t,n,s)=>{const{room:r}=n;Lt.log.DEBUG([t,null,null,"Created answer"],s),os.send(r.id,ls.ANSWER.create,t,s,!1),is(e,t,n,s)})(n,t,e,s))).catch((n=>((e,t,n,s)=>{const{room:r}=n;Lt.log.ERROR([t,null,null,"Failed creating an answer:"],s),os.send(r.id,ls.ANSWER.create_error,t,null,!1,s),Dt(as({state:Pe.ERROR,peerId:t,error:s,room:Jr.getRoomInfo(n.room.id)})),e(s)})(s,t,e,n)))))},Ns=e=>{let t=null;const{currentRoom:n,targetMid:s,peerBrowser:r,cert:o,hasScreenShare:i}=e,a=di.getInitOptions(),d=di.getSkylinkState(n.id),{peerConnections:l,room:c}=d;if(l[s])Lt.log.WARN([s,null,null,"Connection to peer has already been made."]);else{Lt.log.INFO([s,null,null,"Starting the connection to peer. Options provided:"],{peerBrowser:r,enableDataChannel:a.enableDataChannel}),t=(e=>{let t=null;const{currentRoom:n,targetMid:s,cert:r,hasScreenShare:o}=e,i=di.getSkylinkState(n.id),{room:a}=i,d=Object.assign({iceServers:a.connection.peerConfig.iceServers},Vt("PEER_CONNECTION"));r&&(d.certificates=[r]),di.setSkylinkState(i,n.id);try{t=((e,t,n,s)=>{const r=di.getInitOptions(),o=di.getSkylinkState(s.id);Lt.log.DEBUG([e,it.PEER_CONNECTION,null,_t.PEER_CONNECTION.CREATE_NEW],{constraints:t});const{RTCPeerConnection:i,msRTCPeerConnection:a}=window,d=new(r.useEdgeWebRTC&&a?window.msRTCPeerConnection:i)(t),l=[d,e,o];return d.setOffer="",d.setAnswer="",d.negotiating=!1,d.hasMainChannel=!1,d.processingLocalSDP=!1,d.processingRemoteSDP=!1,d.gathered=!1,d.gathering=!1,o.gatheredCandidates[e]={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}},o.peerEndOfCandidatesCounter[e]=o.peerEndOfCandidatesCounter[e]||{},e===pt.MCU&&(Lt.log.INFO("Creating an empty transceiver of kind video with MCU"),"function"==typeof d.addTransceiver&&d.addTransceiver("video")),d.restartIce&&(o.enableIceRestart=!0),di.setSkylinkState(o,s.id),d.ontrack=js.ontrack.bind(d,...l),d.ondatachannel=js.ondatachannel.bind(d,...l),d.onicecandidate=js.onicecandidate.bind(d,...l),d.oniceconnectionstatechange=js.oniceconnectionstatechange.bind(d,...l),d.onconnectionstatechange=js.onconnectionstatechange.bind(d,...l),d.onsignalingstatechange=js.onsignalingstatechange.bind(d,...l),d.onicegatheringstatechange=js.onicegatheringstatechange.bind(d,...l),ko(gt.REACT_NATIVE)&&(d.onsenderadded=js.onsenderadded.bind(d,...l),d.onremovetrack=js.onremovetrack.bind(d,e,o.room,!1)),d})(s,d,0,n),t.constraints=d}catch(e){Lt.log.ERROR([s,null,null,"Failed creating peer connection:"],e),t=null,Dt(as({state:Pe.ERROR,peerId:s,error:e,room:Jr.getRoomInfo(a.id)}))}return t})({currentRoom:n,targetMid:s,hasScreenShare:i,cert:o,sdpSemantics:st.UNIFIED});try{const e=t.getConfiguration();e.sdpSemantics===st.UNIFIED?Lt.log.INFO([s,"SDP Semantics",null,"Peer Connection has Unified plan."]):e.sdpSemantics===st.PLAN_B?Lt.log.INFO([s,"SDP Semantics",null,"Peer Connection has Plan-B."]):Lt.log.INFO([s,"SDP Semantics",null,"The sdpSemantics parameter is not supported by this browser version."])}catch(e){Lt.log.INFO([s,"SDP Semantics",null,"getConfiguration() is not available in this browser version. Ex : "],e)}d.peerConnections[s]=t,di.setSkylinkState(d,n.id),Hn.send(c.id,"new",s,!1)}return t},Cs=e=>{let{peerId:t,dataChannel:n,bufferThreshold:s,createAsMessagingChannel:r,roomState:o}=e;const i=di.getSkylinkState(o.room.id),{user:a,peerConnections:d,dataChannels:l}=i,c=d[t];let E=`-_${t}`,S=!0===r?ce.MESSAGING:ce.DATA,R=S===ce.MESSAGING?"main":E;if(!a||!a.sid)return Lt.log.ERROR([t,"RTCDataChannel",R,"Aborting of creating or initializing DataChannel as User does not have Room session"]),null;if(E=`${a.sid}_${t}`,!c||c.signalingState===he.CLOSED)return Lt.log.ERROR([t,"RTCDataChannel",R,"Aborting of creating or initializing Datachannel as Peer connection does not exists"]),null;if(n&&"object"==typeof n?E=n.label:"string"==typeof n&&(E=n,n=null),l[t]?l[t].main&&l[t].main.channel.label===E&&(R="main",S=ce.MESSAGING):(R="main",S=ce.MESSAGING,l[t]={},Lt.log.DEBUG([t,"RTCDataChannel",R,"initializing main DataChannel"])),!n)try{n=c.createDataChannel(E,{reliable:!0,ordered:!0})}catch(e){Lt.log.ERROR([t,"RTCDataChannel",R,"Failed creating Datachannel ->"],e);const s=new Es,{room:r}=o;return s.send(r.id,le.ERROR,t,{label:E},R,e),Dt(On({state:le.CREATE_ERROR,peerId:t,error:e,channelName:E,channelType:S,buferAmount:Ho.getDataChannelBuffer(n)})),null}const u={dataChannel:n,peerId:t,channelName:E,channelProp:R,channelType:S,roomState:o,bufferThreshold:s};n.onopen=Ss.onopen.bind(n,u),n.onmessage=Ss.onmessage.bind(n,u),n.onerror=Ss.onerror.bind(n,u),n.onbufferedamountlow=Ss.onbufferedamountlow.bind(n,u),n.onclose=Ss.onclose.bind(n,u);const I=S===ce.MESSAGING?"main":E;return i.dataChannels[t][I]={channelName:E,channelType:S,transferId:null,streamId:null,channel:n},di.setSkylinkState(i,o.room.id),null},Ds=(e,t,n)=>{const s=No(e);if(s)Rs(s,t,n);else{const e=di.getSkylinkState(),s=Object.keys(e);for(let r=0;r<s.length;r+=1){const o=e[s[r]];Rs(o,t,n)}}},fs=e=>{const t=No(e);if(t){const e={},n=Object.keys(t.peerInformations);for(let s=0;s<n.length;s+=1)n[s]!==pt.MCU&&(e[n[s]]=Object.assign({},Xr.getPeerInfo(n[s],t.room)),e[n[s]].isSelf=!1);return t.user&&t.user.sid&&(e[t.user.sid]=Object.assign({},Xr.getCurrentSessionInfo(t.room)),e[t.user.sid].isSelf=!0),e}return null},Ms=(e,t)=>{const n=di.getSkylinkState(t.room.id),s=n.peerEndOfCandidatesCounter[e],o=n.peerConnections[e],i=n.peerCandidatesQueue[e],a=n.gatheredCandidates[e],{TAGS:d}=r,{ICE_CONNECTION:l}=_t;if(!s)return null;if(o&&o.signalingState!==he.CLOSED&&o.remoteDescription&&o.remoteDescription.sdp&&"number"==typeof s.expectedLen&&s.len>=s.expectedLen&&(!i||0===i.length)&&!s.hasSet){Lt.log.DEBUG([e,d.PEER_CONNECTION,null,l.END_OF_CANDIDATES_SUCCESS]),s.hasSet=!0;try{if(a){const t={expected:s.expectedLen||0,received:s.len||0,processed:a.receiving.srflx.length+a.receiving.relay.length+a.receiving.host.length};Dt((c={room:n.room,peerId:e,candidatesLength:t},new de(h,{detail:c})))}n.peerEndOfCandidatesCounter[e]=s,di.setSkylinkState(n,t.room.id)}catch(t){Lt.log.ERROR([e,d.PEER_CONNECTION,null,l.END_OF_CANDIDATES_FAILURE],t)}}var c;return null},Ps=e=>({bufferedAmountLow:parseInt(e.bufferedAmountLow,10)||0,bufferedAmountLowThreshold:parseInt(e.bufferedAmountLowThreshold,10)||0}),ys=(e,t)=>{const{dataChannels:n,peerConnections:s}=e;if((e=>!So(e))(n)&&Object.hasOwnProperty.call(n,t)){if(Object.hasOwnProperty.call(n[t],"main")){const r=n[t].main,{channelName:o,channelType:i}=r,a=r.channel.bufferedAmountLowThreshold||0;i===ce.MESSAGING&&setTimeout((()=>{Object.hasOwnProperty.call(s,t)&&s[t].signalingState!==he.CLOSED&&s[t].localDescription.type===Pe.OFFER&&(Ho.closeDataChannel(e,t),Lt.log.DEBUG([t,"RTCDataChannel","main",_t.DATA_CHANNEL.reviving_dataChannel]),Ho.createDataChannel({roomState:e,peerId:t,dataChannel:o,bufferThreshold:a,createAsMessagingChannel:!0}))}),100)}}else Lt.log.DEBUG([t,"RTCDataChannel",_t.DATA_CHANNEL.refresh_error])},vs=(e,t,n="main")=>{try{const s=di.getSkylinkState(e.room.id),{dataChannels:r,room:o}=s;if(!r[t]||!r[t][n])return void Lt.log.WARN([t,it.DATA_CHANNEL,n||null,_t.DATA_CHANNEL.ERRORS.NO_SESSIONS]);if("main"===n)return void((e,t)=>{const{dataChannels:n}=e,s=Object.keys(n[t]);for(let r=0;r<s.length;r+=1)Object.hasOwnProperty.call(n[t],s[r])&&us(e,t,s[r]);delete n[t]})(s,t);us(s,t,n),di.setSkylinkState(s,o.id)}catch(e){Lt.log.ERROR([t,it.DATA_CHANNEL,n||null,_t.DATA_CHANNEL.ERRORS.FAILED_CLOSING],e)}},ks=ms,ws=(e,t,n=!1,s={})=>{const r=di.getSkylinkState(t.room.id),{hasMCU:o}=r;try{if(!o){const t=[];for(let o=0;o<e.length;o+=1){const i=e[o],a=As(i,r,{doIceRestart:n,bwOptions:s});t.push(a)}return Promise.all(t)}return((e,t,n)=>new Promise((s=>{const r=e,o=di.getInitOptions(),{mcuUseRenegoRestart:i}=o;try{r.streamsBandwidthSettings.bAS=n.bandwidth||r.streamsBandwidthSettings.bAS,i&&(r.peerEndOfCandidatesCounter.MCU=r.peerEndOfCandidatesCounter.MCU||{},r.peerEndOfCandidatesCounter.MCU.len=0,di.setSkylinkState(r),s(Ts(r,pt.MCU,t)))}catch(e){s([pt.MCU,e])}})))(t,n,s)}catch(e){return Lt.log.ERROR([null,it.PEER_CONNECTION,null,_t.PEER_CONNECTION.REFRESH_CONNECTION.FAILED],e),null}},Ls=(e,t)=>{const n=e,s=n.sid;return n.room=t.room.roomName,n.settings.data=!!(t.dataChannels[s]&&t.dataChannels[s].main&&t.dataChannels[s].main.channel&&t.dataChannels[s].main.channel.readyState===le.OPEN),n},bs=(e,t=null)=>{const{ROOM_STATE:n}=_t;if(!e)return Lt.log.WARN(n.NO_ROOM_NAME),Mo(n.NO_ROOM_NAME);const{room:s}=e,r=((e,t)=>{const{peerConnections:n,room:s}=e,{PEER_CONNECTION:r}=_t;let o=null,i=null;return Ro(Object.keys(n))?i=r.NOT_INITIALISED:Array.isArray(t)?(o=t,o.forEach((e=>{Po(s,e)||(i=`${r.PEER_ID_NOT_FOUND} ${e}`)}))):Oo(t)?(Po(s,t)||(i=`${r.PEER_ID_NOT_FOUND} ${t}`),o=[t]):o=Object.keys(n),{peerIds:o,errorMsg:i}})(e,t);if(r.errorMsg)return Lt.log.WARN(r.errorMsg),Mo(r.errorMsg);const{peerIds:o}=r,i=[];for(let e=0;e<o.length;e+=1){const t=new Vo(s.id,o[e]);i.push(t.getConnectionStatus())}return Promise.all(i)},Gs=(e,t)=>{const n=di.getSkylinkState(e.room.id),{peerConnections:s,room:r}=n;s[t].close(),di.setSkylinkState(n,r.id)},Us=(e,t,n,s)=>{const r=di.getSkylinkState(e.id);r.peerInformations[t].mediaStatus=((e,t,n,s)=>{const{peerMedias:r,peerInformations:o}=e,i=r[t],a=o[t].mediaStatus||{};return Object.values(i).forEach((e=>{e.transceiverMid===n.mid&&(a[s.id]={audioMuted:yo(s)?e.mediaState===ct.MUTED?0:1:-1,videoMuted:vo(s)?e.mediaState===ct.MUTED?0:1:-1})})),delete a.audioMuted,delete a.videoMuted,a})(r,t,n,s),di.setSkylinkState(r,e.id)},Fs=(e,t,n)=>{const s=e;s.currentRTCRTPSenders[t]||(s.currentRTCRTPSenders[t]=[]),s.currentRTCRTPSenders[t].push(n),di.setSkylinkState(s,s.room.id)},Bs=class extends sn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,local_candidate:{},remote_candidate:{}}}send(e,t,n){try{const s=di.getSkylinkState(e);if(!s)return;this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=n,this.model.client_id=s.clientId,this.model.state=t,this.model.app_key=di.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),Ho.retrieveStatistics(e,n,di.getInitOptions().beSilentOnStatsLogs).then((e=>{e&&["local","remote"].forEach((t=>{const n=e.selectedCandidatePair[t];if(n){const e=this.model[`${t}_candidate`];e.ip_address=n.ipAddress||null,e.port_number=n.portNumber||null,e.candidate_type=n.candidateType||null,e.protocol=n.transport||null,e.priority=n.priority||null,"local"===t&&(this.model.local_candidate.network_type=n.networkType||null)}})),this.postStats(this.endpoints.iceConnection,this.model)})).catch((e=>{Lt.log.DEBUG(_t.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.RETRIEVE_FAILED,e)}))}catch(e){Lt.log.DEBUG(_t.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.SEND_FAILED,e)}}},Vs=(e,t,n,s)=>{const r=e[t]["send"===n?"sending":"receiving"][s];return["number","string","boolean"].indexOf(typeof r)>-1?r:null},Hs=class extends sn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,audio_send:{tracks:[]},audio_recv:{},video_send:{tracks:[]},video_recv:{},error:null},this.stats=null}gatherSendAudioPacketsStats(){this.model.audio_send.bytes=Vs(this.stats,"audio","send","bytes"),this.model.audio_send.packets=Vs(this.stats,"audio","send","packets"),this.model.audio_send.echo_return_loss=Vs(this.stats,"audio","send","echoReturnLoss"),this.model.audio_send.echo_return_loss_enhancement=Vs(this.stats,"audio","send","echoReturnLossEnhancement"),this.model.audio_send.round_trip_time=Vs(this.stats,"audio","send","roundTripTime"),this.model.audio_send.audio_level=Vs(this.stats,"audio","send","audioLevel"),this.model.audio_send.jitter=Vs(this.stats,"audio","send","jitter")}gatherReceiveAudioPacketsStats(){this.model.audio_recv.bytes=Vs(this.stats,"audio","recv","bytes"),this.model.audio_recv.packets=Vs(this.stats,"audio","recv","packets"),this.model.audio_recv.packets_lost=Vs(this.stats,"audio","recv","packetsLost"),this.model.audio_recv.jitter=Vs(this.stats,"audio","recv","jitter"),this.model.audio_recv.audio_level=Vs(this.stats,"audio","recv","audioLevel")}gatherSendVideoPacketsStats(){this.model.video_send.bytes=Vs(this.stats,"video","send","bytes"),this.model.video_send.packets=Vs(this.stats,"video","send","packets"),this.model.video_send.nack_count=Vs(this.stats,"video","send","nacks"),this.model.video_send.firs_count=Vs(this.stats,"video","send","firs"),this.model.video_send.plis_count=Vs(this.stats,"video","send","plis"),this.model.video_send.frames_encoded=Vs(this.stats,"video","send","framesEncoded"),this.model.video_send.frame_width=Vs(this.stats,"video","send","frameWidth"),this.model.video_send.frame_height=Vs(this.stats,"video","send","frameHeight"),this.model.video_send.round_trip_time=Vs(this.stats,"video","send","roundTripTime"),this.model.video_send.qp_sum=Vs(this.stats,"video","send","qpSum"),this.model.video_send.jitter=Vs(this.stats,"video","send","jitter"),this.model.video_send.frames=Vs(this.stats,"video","send","frames"),this.model.video_send.hugeFrames=Vs(this.stats,"video","send","hugeFramesSent"),this.model.video_send.framesPerSecond=Vs(this.stats,"video","send","framesPerSecond")}gatherReceiveVideoPacketsStats(){this.model.video_recv.bytes=Vs(this.stats,"video","recv","bytes"),this.model.video_recv.packets=Vs(this.stats,"video","recv","packets"),this.model.video_recv.packets_lost=Vs(this.stats,"video","recv","packetsLost"),this.model.video_recv.nack_count=Vs(this.stats,"video","recv","nacks"),this.model.video_recv.firs_count=Vs(this.stats,"video","recv","firs"),this.model.video_recv.plis_count=Vs(this.stats,"video","recv","plis"),this.model.video_recv.frames_decoded=Vs(this.stats,"video","recv","framesDecoded"),this.model.video_recv.qp_sum=Vs(this.stats,"video","recv","qpSum"),this.model.video_recv.frames_decoded=Vs(this.stats,"video","recv","framesDecoded"),this.model.video_recv.frames_dropped=Vs(this.stats,"video","recv","framesDropped"),this.model.video_recv.decoderImplementation=Vs(this.stats,"video","recv","decoderImplementation")}buildTrackInfo(e){const t=di.getSkylinkState(e),{peerStreams:n,user:s,streamsSettings:r}=t;Object.values(n[s.sid]).forEach((e=>{if(e){const t=e,{settings:n}=r[e.id],s=t.getAudioTracks(),o=t.getVideoTracks();s.forEach((e=>{const n=((e,t)=>({stream_id:e.id,id:t.id,label:t.label,muted:!t.enabled}))(t,e);this.model.audio_send.tracks.push(n)})),o.forEach((e=>{const s=((e,t,n)=>({stream_id:e.id,id:t.id,label:t.label,height:n.video.resolution.height,width:n.video.resolution.width,muted:!t.enabled}))(t,e,n);this.model.video_send.tracks.push(s)}))}}))}send(e,t,n){const{STATS_MODULE:s}=_t,r=di.getSkylinkState(e);r?r.peerStreams[r.user.sid]&&(this.model.client_id=r.clientId,this.model.app_key=di.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.peer_id=n,Ho.retrieveStatistics(e,n,di.getInitOptions().beSilentOnStatsLogs).then((t=>{t&&(this.stats=t,this.gatherSendAudioPacketsStats(),this.gatherReceiveAudioPacketsStats(),this.gatherSendVideoPacketsStats(),this.gatherReceiveVideoPacketsStats(),this.buildTrackInfo(e),this.postStats(this.endpoints.bandwidth,this.model))})).catch((e=>{this.model.error=e?e.message:null,Lt.log.DEBUG(s.HANDLE_BANDWIDTH_STATS.RETRIEVE_FAILED,e)}))):Lt.log.DEBUG([n,"Statistics","Bandwidth_Stats",s.HANDLE_BANDWIDTH_STATS.NO_STATE])}};let xs={};class Ws{constructor(e){if(e.roomKey)return this.resetBandwidthAdjusterInstance(e.roomKey,e.peerId),null;const{peerConnection:t,state:n,targetMid:s}=e;if(xs[s])return xs[s];this.peerId=s,this.state=n,this.peerConnection=t,this.bandwidth=null,xs[this.peerId]=this}static formatTotalFn(e){let t=0;for(let n=0;n<e.length;n+=1)t+=e[n];return t/e.length}setAdjustmentInterval(){const{bandwidthAdjuster:e,peerStats:t,room:n}=this.state,{PEER_CONNECTION_STATE:s}=r;if(this.bandwidth)return;const o={audio:{send:[],recv:[]},video:{send:[],recv:[]}};let i=0;const a=setInterval((()=>{this.peerConnection&&this.peerConnection.signalingState!==s.CLOSED&&e&&t[this.peerId]?Ho.retrieveStatistics(n.id,this.peerId,di.getInitOptions().beSilentOnStatsLogs,!0).then((t=>{if(this.peerConnection&&this.peerConnection.signalingState!==s.CLOSED&&e||clearInterval(a),o.audio.send.push(t.audio.sending.bytes?8*t.audio.sending.bytes:0),o.audio.recv.push(t.audio.receiving.bytes?8*t.audio.receiving.bytes:0),o.video.send.push(t.video.sending.bytes?8*t.video.sending.bytes:0),o.video.recv.push(t.video.receiving.bytes?8*t.video.receiving.bytes:0),i+=1,i===e.interval){i=0;let t=Ws.formatTotalFn(o.audio.send),n=Ws.formatTotalFn(o.video.send);e.useUploadBwOnly||(t+=Ws.formatTotalFn(o.audio.recv),n+=Ws.formatTotalFn(o.video.recv),t/=2,n/=2),t=parseInt(t*(e.limitAtPercentage/100)/1e3,10),n=parseInt(n*(e.limitAtPercentage/100)/1e3,10),Ho.refreshConnection(this.state,this.peerId,!1,{bandwidth:{audio:t,video:n}})}})).catch((()=>{o.audio.send.push(0),o.audio.recv.push(0),o.video.send.push(0),o.video.recv.push(0)})):clearInterval(a)}),1e3);this.bandwidth=o}resetBandwidthAdjusterInstance(e,t=null){const n=di.getSkylinkState(e);n.streamsBandwidthSettings.bAS={},di.setSkylinkState(n,e),t?delete xs[t]:xs={}}}const $s=Ws,Ks=e=>{const{ICE_CONNECTION_STATE:t}=r;return[t.COMPLETED,t.CONNECTED].indexOf(e)>-1},js={ontrack:(e,t,n,s)=>{const r=di.getSkylinkState(n.room.id),{peerConnections:o,room:i,hasMCU:a}=r,d=s.streams[0],{transceiver:l,track:c}=s;let E=t;if(!d)return Lt.log.WARN("ontrack stream is null"),null;if(null===l.mid&&Lt.log.WARN("Transceiver mid is null",l),!o[E])return null;a&&(E=((e,t)=>{const{peerMedias:n,user:s}=e,r=Object.keys(n);for(let e=0;e<r.length;e+=1)if(r[e]!==s.sid){const s=Object.values(n[r[e]]);for(let n=0;n<s.length;n+=1)if(s[n].transceiverMid===t.mid)return r[e]}return null})(r,l));const S=Js.retrieveScreenMediaInfo(r.room,E,{transceiverMid:l.mid}),R=[E,i,S];return d.onremovetrack=js.onremovetrack.bind(void 0,...R),Js.updateStreamIdFromOntrack(r.room,E,l.mid,d.id),Ho.updatePeerInformationsMediaStatus(r.room,E,l,d),zn.addStream(E,d,i.id),rs.onRemoteTrackAdded(d,n,E,S,c.kind===lt.VIDEO,c.kind===lt.AUDIO),null},ondatachannel:(e,t,n,s)=>{const r=s.channel||s,o=di.getInitOptions(),i=di.getSkylinkState(n.room.id),{peerInformations:a}=i,{enableDataChannel:d}=o;Lt.log.DEBUG([t,"RTCDataChannel",r.label,"Received datachannel ->"],r),d&&a[t].config.enableDataChannel?(e.hasMainChannel||(e.hasMainChannel=!0),Cs({peerId:t,dataChannel:r,roomState:n})):Lt.log.WARN([t,"RTCDataChannel",r.label,"Not adding datachannel as enable datachannel is set to false"])},onicecandidate:(e,t,n,s)=>{Yn.onIceCandidate(t,s.candidate||s,n.room)},oniceconnectionstatechange:(e,t,n)=>{const{ROOM_STATE:s,ICE_CONNECTION:o,PEER_CONNECTION:i}=_t,{ICE_CONNECTION_STATE:a,PEER_CONNECTION_STATE:d,BROWSER_AGENT:l}=r,c=di.getSkylinkState(n.room.id),{peerStreams:E,user:S,enableStatsGathering:R}=c;let u=null;const I=e.iceConnectionState;if(ko(l.REACT_NATIVE)&&!c&&I===a.CLOSED)return;if(!c)return void Lt.log.DEBUG([t,"RTCIceConnectionState",null,s.NOT_FOUND]);const{hasMCU:g,bandwidthAdjuster:p,peerStats:m,streamsBandwidthSettings:T}=c;if(I===a.FAILED&&ko(l.FIREFOX)&&!E[S.sid])return;Lt.log.DEBUG([t,"RTCIceConnectionState",null,o.STATE_CHANGE],I);const O=new Bs;O.send(n.room.id,e.iceConnectionState,t),Dt(Un({state:I,peerId:t})),!u&&Ks(I)&&!m[t]&&R&&(u=!0,m[t]={},Lt.log.DEBUG([t,"RTCStatsReport",null,"Retrieving first report to tabulate results"]),Ho.getConnectionStatus(c,t).then((()=>{u=setInterval((()=>{const s=di.getSkylinkState(c.room.id);s&&s.room.inRoom&&(e.connectionState===d.CLOSED||e.iceConnectionState===a.CLOSED?(e.connectionState===d.CLOSED&&(Lt.log.DEBUG([t,"RTCPeerConnectionState",null,i.STATE_CHANGE],e.connectionState),Dt(jt({state:d.CLOSED,peerId:t}))),e.iceConnectionState===a.CLOSED&&(Lt.log.DEBUG([t,"RTCIceConnectionState",null,o.STATE_CHANGE],e.iceConnectionState),O.send(n.room.id,e.iceConnectionState,t),Dt(Un({state:a.CLOSED,peerId:t}))),clearInterval(u)):(new Hs).send(c.room.id,e,t))}),2e4)}))),!g&&Ks(I)&&p&&So(T.bAS)&&new $s({targetMid:t,state:c,peerConnection:e}).setAdjustmentInterval()},onicegatheringstatechange:(e,t,n)=>{const{ICE_CONNECTION:s}=_t,{iceGatheringState:r}=e;Lt.log.INFO([t,"RTCIceGatheringState",null,s.STATE_CHANGE],r),Dt(Gn({state:r,room:Jr.getRoomInfo(n.room.id),peerId:t}))},onsignalingstatechange:(e,t)=>{const{PEER_CONNECTION:n}=_t;Lt.log.DEBUG([t,"RTCPeerConnectionSignalingState",null,n.STATE_CHANGE],e.signalingState),Dt(jt({state:e.signalingState,peerId:t}))},onremovetrack:(e,t,n,s)=>{const r=ho(t.id),{peerInformations:o}=r,{MEDIA_STREAM:i,PEER_INFORMATIONS:a}=_t,d=ko(gt.REACT_NATIVE)?s.stream:s.target;Lt.log.INFO([e,it.MEDIA_STREAM,null,i.REMOTE_TRACK_REMOVED],{peerId:e,isSelf:!1,isScreensharing:n,track:s.track}),o[e]?d?(((e,t,n)=>{const s=e;delete s.peerInformations[t].mediaStatus[n],di.setSkylinkState(s,s.room.id)})(r,e,d.id),((e,t,n,s,r)=>{zn.dispatchStreamEvent(E,{room:e.room,peerId:t,peerInfo:Xr.getPeerInfo(t,e.room),isSelf:!1,isScreensharing:n,streamId:r.id,isVideo:s.track.kind===lt.VIDEO,isAudio:s.track.kind===lt.AUDIO})})(r,e,n,s,d),((e,t)=>{Dt(Ht({peerId:t,peerInfo:Xr.getPeerInfo(t,e.room),isSelf:!1}))})(r,e)):Lt.log.DEBUG([e,it.MEDIA_STREAM,null,`${i.ERRORS.DROPPING_ONREMOVETRACK}`-`${i.NO_STREAM}`]):Lt.log.DEBUG([e,it.MEDIA_STREAM,null,`${i.ERRORS.DROPPING_ONREMOVETRACK}`-`${a.NO_PEER_INFO} ${e}`])},onsenderadded:(e,t,n,s)=>{const r=di.getSkylinkState(n.room.id),{sender:o}=s;Fs(r,t,o)},onconnectionstatechange:(e,t,n)=>{const{room:s}=n,{connectionState:r,iceConnectionState:o}=e;(new Bs).send(s.id,r===he.FAILED?Ae.FAILED:o,t),Lt.log.DEBUG([t,"RTCPeerConnectionState",null,_t.PEER_CONNECTION.STATE_CHANGE],e.connectionState),Dt(jt({state:r,peerId:t}))}},Ys={retrieveTransceiverMid:(e,t)=>{const n=di.getSkylinkState(e.id),{peerConnections:s}=n,r=Object.values(s);let o=null;for(let e=0;e<r.length;e+=1){const n=r[e].getTransceivers();for(let e=0;e<n.length;e+=1)if(n[e].sender.track&&n[e].sender.track.id===t.id){o=n[e].mid;break}}return o},retrieveMediaState:e=>e.readyState===dt.ENDED?ct.UNAVAILABLE:e.muted?ct.MUTED:ct.ACTIVE,retrieveMediaId:(e,t)=>`${e===lt.AUDIO?"AUDIO":"VIDEO"}_${t}`,buildPeerMediaInfo:(e,t,n,s,r)=>({publisherId:t,mediaId:Ys.retrieveMediaId(n.kind,s),mediaType:r,mediaState:Ys.retrieveMediaState(n),transceiverMid:Ys.retrieveTransceiverMid(e,n),streamId:s,trackId:n.id,mediaMetaData:"",simulcast:""}),retrieveStreamIdOfTrack:(e,t)=>{const n=di.getSkylinkState(e.id),{peerStreams:s,user:r}=n,o=Object.values(s[r.sid]);let i=null;for(let e=0;e<o.length;e+=1){const n=o[e].getTracks();for(let s=0;s<n.length;s+=1)if(Jn(n[s],t)){i=o[e].id;break}}return i},updatePeerMediaInfo:(e,t,n,s,r=!1,o=!1,i=!1)=>{try{((e,t,n,s,r=!1,o=!1,i=!1)=>{const a=di.getSkylinkState(e.id);!i&&r&&o?(a.peerMedias[t][s][r]=o,Lt.log.INFO([t,it.PEER_MEDIA,null,`${_t.MEDIA_INFO.UPDATE_SUCCESS} -- ${s} - ${r}: ${o}`])):!i||r||o||(a.peerMedias[t]=a.peerMedias[t]||{},a.peerMedias[t][s]=i),di.setSkylinkState(a,e.id)})(e,t,0,s,r,o,i),((e,t,n,s)=>{const r=di.getSkylinkState(e.id);r.user.sid===t&&n&&Ys.sendMediaInfoMsg(e,r.peerMedias[t][s])})(e,t,n,s)}catch(e){const n=i?JSON.stringify(i):`${s} - ${r}: ${o}`;Lt.log.ERROR([t,it.PEER_MEDIA,null,`${_t.MEDIA_INFO.ERRORS.FAILED_UPDATING} -- ${n}`],e)}},sendMediaInfoMsg:(e,t)=>{const n=new Fr,s=di.getSkylinkState(e.id),{user:r,hasMCU:o,peerConnections:i}=s;(o?[pt.MCU]:Object.keys(i).filter((e=>e!==r.sid&&e!==pt.MCU))).forEach((e=>{n.mediaInfoEvent(s,e,t)}))},parseSDPForTransceiverMid:(e,t,n)=>{const s=di.getSkylinkState(e.id),{peerMedias:r}=s,{beSilentOnParseLogs:o}=di.getInitOptions(),i=Object.values(r[t]),a=Uo.getTransceiverMid(n,o),d=a.audio,l=a.video;for(let n=0;n<i.length;n+=1){const s=i[n];s.transceiverMid=s.mediaState===ct.UNAVAILABLE?s.transceiverMid:null;for(let n=0;n<d.length;n+=1)if(d[n].streamId===s.streamId&&("sendonly"===d[n].direction||"sendrecv"===d[n].direction)){Ys.updatePeerMediaInfo(e,t,!1,s.mediaId,Et.TRANSCEIVER_MID,d[n].transceiverMid);break}for(let n=0;n<l.length;n+=1)if(l[n].streamId===s.streamId&&("sendonly"===l[n].direction||"sendrecv"===l[n].direction)){Ys.updatePeerMediaInfo(e,t,!1,s.mediaId,Et.TRANSCEIVER_MID,l[n].transceiverMid);break}}},retrieveValueGivenTransceiverMid:(e,t,n,s)=>{const{peerMedias:r}=e,o=Object.values(r[t]);for(let e=0;e<o.length;e+=1)if(o[e].transceiverMid===n)return o[e][s];return null},retrieveFormattedMediaInfo:(e,t)=>{const n=di.getSkylinkState(e.id),{peerMedias:s}=n,r=Object.values(s[t]),o=[];for(let e=0;e<r.length;e+=1){const t=r[e],n=Gt()(t);delete n.trackId,delete n.streamId,o.push(n)}return o},resetPeerMedia:(e,t)=>{const n=di.getSkylinkState(e.id);return n.peerMedias[t]&&(n.peerMedias[t]={}),n},populatePeerMediaInfo:(e,t,n)=>{const s=e.peerMedias[n.publisherId]||{};return s[n.mediaId]=n,((e,t)=>!So(e)&&e[t])(t,n.mediaId)&&(s[n.mediaId].streamId=n.transceiverMid===t[n.mediaId].transceiverMid?t[n.mediaId].streamId:""),s},processOnRemoveTrack:(e,t,n)=>{if(ko(gt.REACT_NATIVE)&&n){const{room:s}=e,r={track:{id:null,kind:null}},o={id:null};if(r.track.id=n.trackId,r.track.kind=n.mediaType===at.AUDIO||n.mediaType===at.AUDIO_MIC?lt.AUDIO:lt.VIDEO,o.id=n.streamId,r.stream=o,!(r.track.id||r.track.kind||o.id))return void Lt.log.DEBUG([t,it.MEDIA_STREAM,null,`${_t.BROWSER_AGENT.REACT_NATIVE.ERRORS.DROPPING_ONREMOVETRACK}`],r);js.onremovetrack(t,s,n.mediaType===at.VIDEO_SCREEN,r)}}},Js=class{static updatePeerMediaWithUserSid(e,t){const n=di.getSkylinkState(e.id);n.peerMedias[t]=Object.assign({},n.peerMedias.null),delete n.peerMedias.null,di.setSkylinkState(n,e.id),Object.keys(n.peerMedias[t]).forEach((n=>{Ys.updatePeerMediaInfo(e,t,!1,n,Et.PUBLISHER_ID,t)}))}static updateStreamIdFromOntrack(e,t,n,s){const r=di.getSkylinkState(e.id),o=Ys.retrieveValueGivenTransceiverMid(r,t,n,Et.MEDIA_ID);Ys.updatePeerMediaInfo(e,t,!1,o,Et.STREAM_ID,s)}static isVideoScreenTrack(e,t,n){const{peerMedias:s}=e,r=Object.values(s[t]);for(let e=0;e<r.length;e+=1)if(r[e].transceiverMid===n)return r[e].mediaType===at.VIDEO_SCREEN;return!1}static setMediaStateToUnavailable(e,t,n){Ys.updatePeerMediaInfo(e,t,!1,n,Et.MEDIA_STATE,ct.UNAVAILABLE)}static deleteUnavailableMedia(e,t,n=null){const s=di.getSkylinkState(e.id);if(t===pt.MCU||!s.peerMedias[t])return;let r;if(n)r=Gt()(s.peerMedias[t][n]),delete s.peerMedias[t][n];else{const e=s.peerMedias[t];Object.values(e).forEach((e=>{e.mediaState===ct.UNAVAILABLE&&(r=Gt()(e),delete s.peerMedias[t][e.mediaId])}))}di.setSkylinkState(s,e.id),Ys.processOnRemoveTrack(s,t,r),r&&Dt(((e={})=>new de(se,{detail:e}))({mediaInfo:r}))}static updatePeerMediaInfo(e,t,n,s,r){Ys.updatePeerMediaInfo(e,t,!0,n,s,r)}static setPeerMediaInfo(e,t,n=[]){try{const s=di.getSkylinkState(e.id);if(t!==pt.MCU||Ro(n)){if(t!==pt.MCU){const r=Gt()(s.peerMedias[t])||{},o=Ys.resetPeerMedia(e,t);n.forEach((e=>{o.peerMedias[e.publisherId]=Ys.populatePeerMediaInfo(o,r,e)})),di.setSkylinkState(o,e.id)}}else{const t=[];n.forEach((e=>{-1===t.indexOf(e.publisherId)&&t.push(e.publisherId)})),t.forEach((t=>{const s=n.filter((e=>{if(e.publisherId===t)return e}));this.setPeerMediaInfo(e,t,s)}))}}catch(e){Lt.log.ERROR([t,it.PEER_MEDIA,null,_t.MEDIA_INFO.ERRORS.FAILED_SETTING_PEER_MEDIA_INFO])}}static retrieveStreamId(e,t,n){const s=di.getSkylinkState(e.id),{peerMedias:r}=s,o=r[t][n],{streamId:i}=o;return i||Lt.log.ERROR([t,it.PEER_MEDIA,null,_t.MEDIA_INFO.ERRORS.NO_ASSOCIATED_STREAM_ID]),i}static retrieveMediaId(e,t){return Ys.retrieveMediaId(e,t)}static retrieveMediaInfoForOfferAnswer(e,t){const n=di.getSkylinkState(e.id).user.sid;return Ys.parseSDPForTransceiverMid(e,n,t),Ys.retrieveFormattedMediaInfo(e,n)}static processPeerMedia(e,t,n,s,r=!1){const o=di.getSkylinkState(e.id).peerMedias[t]||{},i=n.getTracks();let a=null;try{i.forEach((i=>{a=Ys.retrieveMediaId(i.kind,n.id),o[a]=Ys.buildPeerMediaInfo(e,t,i,n.id,i.kind===lt.AUDIO?at.AUDIO_MIC:s?at.VIDEO_SCREEN:at.VIDEO_CAMERA),Ys.updatePeerMediaInfo(e,t,r,a,null,null,o[a])}))}catch(e){Lt.log.ERROR([t,it.MEDIA_INFO,_t.MEDIA_INFO.ERRORS.FAILED_PROCESSING_PEER_MEDIA],e)}}static retrieveScreenMediaInfo(e,t,n){const s=di.getSkylinkState(e.id),{peerMedias:r}=s,o=Object.values(r[t]);for(let e=0;e<o.length;e+=1){if(n.streamId&&o[e].streamId===n.streamId)return o[e].mediaType===at.VIDEO_SCREEN&&o[e];if(n.transceiverMid&&o[e].transceiverMid===n.transceiverMid)return o[e].mediaType===at.VIDEO_SCREEN;if(!n)return o[e].mediaType===at.VIDEO_SCREEN}return Lt.log.ERROR([t,it.PEER_MEDIA,null,_t.MEDIA_INFO.ERRORS.STREAM_ID_NOT_MATCHED]),!1}},Qs={enterAndWelcome:e=>{const t=di.getSkylinkState(e.rid),n={},{hasMCU:s}=t,{rid:r,mid:o,enableIceRestart:i,enableDataChannel:a,weight:d,agent:l,os:c,temasysPluginVersion:E,SMProtocolVersion:S,DTProtocolVersion:R,version:u,publisherId:I}=e;return n.publisherId=I||null,n.rid=r,n.mid=o,n.agent=l&&Oo(l)?l:"other",n.version=(e=>{if(!e||"string"!=typeof e)return 0;if(e.indexOf(".")>-1){const t=e.split(".");if(t.length>2){const e=t[0]||"0";return t.splice(0,1),parseFloat(`${e}.${t.join("0")}`,10)}return parseFloat(e||"0",10)}return parseInt(e||"0",10)})(u),n.SMProtocolVersion=Oo(S)?S:Ve,n.DTProtocolVersion=Oo(R)?R:s||o===pt.MCU?Re:"0.1.0",n.weight=po(d)?d:0,n.enableDataChannel=!To(a)||a,n.enableIceRestart=!!To(i)&&i,n.os=c&&Oo(c)?c:null,n.temasysPluginVersion=E&&Oo(E)?E:null,n.userInfo=Qs.parseUserInfo(t,e,n),s&&(n.peersInRoom=e.peersInRoom),Gt()(n)},parseUserInfo:(e,t,n)=>{const s=Object.assign({},t.userInfo);return s.config=s.config?s.config:{enableDataChannel:n.enableDataChannel,enableIceRestart:n.enableIceRestart,priorityWeight:n.weight},s.agent=s.agent?s.agent:{name:n.agent,version:n.version,os:n.os,pluginVersion:n.temasysPluginVersion,SMProtocolVersion:n.SMProtocolVersion,DTProtocolVersion:n.DTProtocolVersion},s.settings=s.settings?s.settings:{},s.mediaStatus=s.mediaStatus?s.mediaStatus:{},s}},Zs=(e,t,n)=>{const{room:s}=e;e.peerInformations[t]=Ho.buildPeerInformations(n,e),di.setSkylinkState(e,s.id)},qs={ENTER:"enterHandler",WELCOME:"welcomeHander"},Xs=(e,t)=>{const n=Qs.enterAndWelcome(e),{rid:s,mid:r,userInfo:o,publisherId:i}=n,a=di.getSkylinkState(s),{hasMCU:d}=a,l=d&&i?i:r;((e,t,n,s)=>{const{room:r}=n;let o="enter";e===qs.WELCOME&&(o="welcome"),Lt.log.INFO([t,it.PEER_CONNECTION,null,`Peer ${o} received ->`],s),os.send(r.id,o,t,s,!0)})(t,l,a,n);const c={currentRoom:a.room,targetMid:l,userInfo:o,message:n,caller:t};(e=>{const{currentRoom:t,targetMid:n,cert:s,userInfo:r,message:o,caller:i}=e;let a=!1;const d=di.getSkylinkState(t.id),{hasMCU:l}=d,{peerInformations:c}=d;if(!c[n]&&!l||l&&n===pt.MCU&&!c.MCU){const e=!!r.screenshare;a=!0,d.peerInformations[n]=Ho.buildPeerInformations(o.userInfo,d);const i={agent:r.agent.name,version:r.agent.version,os:r.agent.os};di.setSkylinkState(d,t.id),Ho.addPeer({currentRoom:t,targetMid:n,peerBrowser:i,cert:s,hasScreenshare:e}),n===pt.MCU?(Lt.log.INFO([n,it.PEER_CONNECTION,null,_t.PEER_CONNECTION.MCU]),d.hasMCU=!0,Dt(((e={})=>new de(T,{detail:e}))({peerId:n,serverPeerType:Ce.MCU,room:Jr.getRoomInfo(t.id)}))):Dt(xt({peerId:n,peerInfo:Xr.getPeerInfo(n,t),isSelf:!1,room:Jr.getRoomInfo(t.id)}))}if(d.peerMessagesStamps[n]=d.peerMessagesStamps[n]||{userData:0,audioMuted:0,videoMuted:0},i===qs.WELCOME&&(d.peerMessagesStamps[n].hasWelcome=!1),i===qs.WELCOME&&l&&Array.isArray(o.peersInRoom)&&o.peersInRoom.length){const e=d.user.sid;for(let n=0;n<o.peersInRoom.length;n+=1){const s=o.peersInRoom[n].mid;if(s!==e){const e=Qs.enterAndWelcome(o.peersInRoom[n]).userInfo;Zs(d,s,e),Dt(xt({peerId:s,peerInfo:Xr.getPeerInfo(s,t),isSelf:!1,room:Jr.getRoomInfo(t.id)}))}}}else l&&n!==d.user.sid&&n!==pt.MCU&&(Zs(d,n,r),Dt(xt({peerId:n,peerInfo:Xr.getPeerInfo(n,t),isSelf:!1,room:Jr.getRoomInfo(t.id)})));di.setSkylinkState(d,t.id),a&&Dt(as({peerId:n,state:Pe.WELCOME,error:null,room:Jr.getRoomInfo(t.id)}))})(c),(e=>{const{currentRoom:t,targetMid:n,message:s}=e,r=di.getSkylinkState(t.id),{peerConnections:o,hasMCU:i}=r,{STATS_MODULE:a,NEGOTIATION_PROGRESS:d,PEER_CONNECTION:l}=_t,c=new Fr,E=(e=>{let t="welcome";if(e.caller===qs.WELCOME){const n=di.getSkylinkState(e.currentRoom.id),{peerMessagesStamps:s,peerPriorityWeight:r,hasMCU:o}=n;(o||r>e.message.weight)&&(s[e.targetMid].hasWelcome?(t="noop",Lt.log.WARN([e.targetMid,it.PEER_CONNECTION,null,'Discarding extra "welcome" received.'])):(t="offer",n.peerMessagesStamps[e.targetMid].hasWelcome=!0,di.setSkylinkState(n,e.currentRoom.id)))}return t})(e);if("offer"===E){if(!o[n])return Lt.log.WARN([n,"RTCSessionDescription","offer",l.NO_PEER_CONNECTION]),os.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,n,s,!1,l.NO_PEER_CONNECTION),null;const{signalingState:r}=o[n];if(r!==he.STABLE)return Lt.log.WARN([n,"RTCSessionDescription","offer",d.ERRORS.NOT_STABLE],r),os.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,n,s,!1,d.ERRORS.NOT_STABLE),null;c[E](e.currentRoom,e.targetMid)}else i||c[E](e.currentRoom,e.targetMid)})(c)},zs=(e,t,n,s)=>{const{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:r}}=_t,{peerConnections:o,bufferedLocalOffer:i,room:a}=e,d=o[t],l="offer"===n.type?"OFFER":"ANSWER";os.send(a.id,r[l].set,t,n,s),s&&Dt(as({state:Pe[l],peerId:t,room:Jr.getRoomInfo(a.id)})),s?("offer"===n.type?d.setOffer="remote":d.setAnswer="remote",Yn.addIceCandidateFromQueue(t,a)):(i[t]=null,"offer"===n.type?d.setOffer="local":d.setAnswer="local"),di.setSkylinkState(e,a.id)},er=(e,t,n,s,r)=>{const{room:o,user:i}=e,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:a}}=_t,d="offer"===n.type?"OFFER":"ANSWER";os.send(o.id,a[d].set_error,t,n,s,r),Dt(as({state:Pe.ERROR,peerId:s?t:i.sid,error:r,room:Jr.getRoomInfo(o.id)}))},tr=(e,t,n)=>{const s=di.getSkylinkState(e.id),{peerConnections:r}=s,{type:o}=n,i=r[t],{STATS_MODULE:a}=_t,d="offer"===o?"OFFER":"ANSWER";return i.processingLocalSDP=!0,os.send(e.id,a.HANDLE_NEGOTIATION_STATS[d][o],t,n,!1),i.setLocalDescription(n).then((()=>i))},nr=(e,t,n,s)=>{const r=di.getSkylinkState(t.id),{peerConnections:o}=r,{NEGOTIATION_PROGRESS:i}=_t,a=o[n]=e;Lt.log.DEBUG([n,it.SESSION_DESCRIPTION,s.type,i.SET_LOCAL_DESCRIPTION],s),a.processingLocalSDP=!1,zs(r,n,s,!1)},sr=(e,t,n,s)=>{const r=di.getSkylinkState(e.id),{peerConnections:o}=r,i=o[t],{NEGOTIATION_PROGRESS:a}=_t;Lt.log.ERROR([t,it.SESSION_DESCRIPTION,n.type,a.FAILED_SET_LOCAL_DESCRIPTION],s),i.processingLocalSDP=!1,i.negotiating=!1,er(r,t,n,!1,s)},rr=(e,t,n)=>{const s=di.getSkylinkState(e.id),{peerConnections:r}=s,{type:o}=n,{STATS_MODULE:i}=_t,a=r[t],d="offer"===o?"OFFER":"ANSWER";a.processingRemoteSDP=!0,os.send(e.id,i.HANDLE_NEGOTIATION_STATS[d][o],t,n,!0);const l=((e,t,n)=>{const s=t;return s.sdp=Uo.setSDPBitrate(e,s,n),s})(t,n,e.id);return a.setRemoteDescription(l).then((()=>a))},or=(e,t,n)=>{const s=e;s.peerConnections[t].negotiating=!1,di.setSkylinkState(s,t),(new Fr).answerAck(e,t,n)},ir=(e,t,n,s)=>{const r=new Fr,{type:o}=s,{NEGOTIATION_PROGRESS:i,DATA_CHANNEL:a}=_t,d=di.getSkylinkState(t.id),{peerConnections:l}=d,c=l[n]=e;return Lt.log.DEBUG([n,it.SESSION_DESCRIPTION,o,i.SET_REMOTE_DESCRIPTION],s),c.processingRemoteSDP=!1,"offer"===o?(zs(d,n,s,!0),r.answer(d,n)):(d.peerMessagesStamps[n]&&(d.peerMessagesStamps[n].hasRestart=!1),d.dataChannels[n]&&(-1===c.remoteDescription.sdp.indexOf("m=application")||c.remoteDescription.sdp.indexOf("m=application 0")>0)&&(Lt.log.WARN([n,it.PEER_CONNECTION,null,`${a.CLOSING} - ${a.NO_REMOTE_DATA_CHANNEL}`]),Ho.closeDataChannel(d,n)),zs(d,n,s,!0),or(d,n,!0),!0)},ar=(e,t,n,s)=>{const r=di.getSkylinkState(e.id),{peerConnections:o}=r,i=o[t],{type:a}=n;Lt.log.ERROR([t,it.SESSION_DESCRIPTION,a,`${_t.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_DESCRIPTION} ->`],{error:s,state:i.signalingState,[a]:n}),i.processingRemoteSDP=!1,i.negotiating=!1,er(r,t,n,!0,s),"answer"===a&&or(r,t,!1)},dr=e=>{const{rid:t,mid:n,type:s,sdp:r,mediaInfoList:o}=e,i=di.getSkylinkState(t),{hasMCU:a,room:d,bufferedLocalOffer:l}=i,c=n,E="offer"===s?"OFFER":"ANSWER",{NEGOTIATION_PROGRESS:S}=_t;if(Lt.log.INFO([c,null,s,`Received ${s} from peer. ${E}:`],e),((e,t)=>{const{weight:n,type:s,mid:r,sdp:o,resend:i}=t,{peerPriorityWeight:a,bufferedLocalOffer:d,room:l,peerConnections:c}=e,{STATS_MODULE:E,NEGOTIATION_PROGRESS:S,PEER_CONNECTION:R}=_t,u=r,I=c[u],g="offer"===s?"OFFER":"ANSWER";let p=null;if(!I)return Lt.log.ERROR([u,null,s,`${R.NO_PEER_CONNECTION}. Unable to set${"offer"===s?"Remote":"Local"}Offer.`]),p=R.NO_PEER_CONNECTION,os.send(l.id,E.HANDLE_NEGOTIATION_STATS[g].dropped,u,t,!0,p),!1;const{processingRemoteSDP:m,processingLocalSDP:T,negotiating:O}=I;if("offer"===s&&c[u].signalingState!==he.STABLE&&(Lt.log.WARN([u,null,s,S.ERRORS.NOT_STABLE],{signalingState:c[u].signalingState,isRestart:!!i}),p=`Peer connection state is ${c[u].signalingState}.`),"offer"===s&&d[u]&&a>n&&(Lt.log.WARN([u,null,s,S.ERRORS.OFFER_TIEBREAKER],{selfWeight:a,messageWeight:n}),p=S.ERRORS.OFFER_TIEBREAKER),m)Lt.log.WARN([u,it.SESSION_DESCRIPTION,s,S.ERRORS.PROCESSING_EXISTING_SDP],o),p=S.ERRORS.PROCESSING_EXISTING_SDP;else if(!T&&!m&&O&&"offer"===s){const n=e;Lt.log.DEBUG([u,it.SESSION_DESCRIPTION,s,S.ERRORS.ADDING_REMOTE_OFFER_TO_BUFFER],t),n.bufferedRemoteOffers[u]=n.bufferedRemoteOffers[u]?n.bufferedRemoteOffers[u]:[],n.bufferedRemoteOffers[u].push(t),di.setSkylinkState(n,l.id)}return p&&os.send(l.id,E.HANDLE_NEGOTIATION_STATS[g].dropped,u,t,!0,p),!p})(i,e))try{if(((e,t)=>{const n=e,{userInfo:s,rid:r,mid:o}=t,i=s,a=o;s&&"object"==typeof s&&(i.settings.data=!!(n.dataChannels[a]&&n.dataChannels[a].main&&n.dataChannels[a].main.channel&&n.dataChannels[a].main.channel.readyState===le.OPEN),n.peerInformations[a].settings=i.settings||{},n.peerInformations[a].mediaStatus=i.mediaStatus||{},n.peerInformations[a].userData=i.userData),n.peerConnections[a].negotiating=!0,di.setSkylinkState(n,r)})(i,e),Js.setPeerMediaInfo(d,c,o),Js.deleteUnavailableMedia(d,c),"offer"===s){let e=null;const t={type:s,sdp:a?r.replace(/\r\n/g,"\n").split("\n").join("\r\n"):r};rr(d,c,t).then((e=>ir(e,d,c,t))).catch((e=>ar(d,c,t,e))).then((t=>(e={type:t.type,sdp:t.sdp},tr(d,c,e)))).then((t=>nr(t,d,c,e))).catch((t=>sr(d,c,e,t)))}else if(l[c]){const e=l[c],t={type:s,sdp:a?r.replace(/\r\n/g,"\n").split("\n").join("\r\n"):r};tr(d,c,e).then((t=>nr(t,d,c,e))).catch((t=>sr(d,c,e,t))).then((()=>rr(d,c,t))).then((e=>ir(e,d,c,t))).catch((e=>ar(d,c,t,e)))}else Lt.log.ERROR([c,it.PEER_CONNECTION,null,S.ERRORS.NO_LOCAL_BUFFERED_OFFER])}catch(e){Lt.log.ERROR([c,it.SESSION_DESCRIPTION,s,`Failed processing ${E} ->`],e)}return null},lr=class extends sn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,contents:null}}send(e,t){const n=di.getSkylinkState(e);this.model.room_id=e,this.model.user_id=n&&n.user&&n.user.sid||null,this.model.client_id=n.clientId,this.model.state=t.type,this.model.contents=t,this.model.app_key=di.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.session,this.model)}},cr=class extends sn{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,recording_id:null,recordings:null,error:null}}send(e,t,n,s,r){const o=di.getSkylinkState(e);this.model.client_id=o.clientId,this.model.app_key=di.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.state=t,this.model.recording_id=n,this.model.recordings=s,this.error=("string"==typeof r?r:r&&r.message)||null,this.postStats(this.endpoints.recording,this.model)}},Er=new cr,Sr=(e,t,n)=>{const s={state:e,recordingId:t};n&&(s.error=n),Dt(((e={})=>new de(j,{detail:e}))(s))},Rr=(e,t,n,s,r)=>{const o=Xr.getPeerInfo(n,e.room);Dt(Xn({isSelf:!1,peerId:n,peerInfo:o,streamId:t,isAudio:s===lt.AUDIO,isVideo:s===lt.VIDEO,isScreensharing:r})),Dt(Ht({isSelf:!1,peerId:n,peerInfo:o}))},ur=(e,t,n)=>{Lt.log.WARN([e,it.SIG_SERVER,`${_t.MEDIA_INFO.WARN.READ_ONLY_VALUE} ${n}`],t)},Ir=(e,t)=>{const{rid:n,mediaId:s,transceiverMid:r}=t,o=di.getSkylinkState(n);Js.updatePeerMediaInfo(o.room,e,s,Et.TRANSCEIVER_MID,r)},gr=(e,t,n,s)=>{if(s.mediaState===ct.UNAVAILABLE)((e,t,n,s)=>{const{mediaId:r}=s;Js.setMediaStateToUnavailable(e,n,r),Js.deleteUnavailableMedia(e,n,r)})(e,0,n,s);else switch(t){case at.VIDEO_SCREEN:case at.VIDEO_CAMERA:case at.VIDEO_OTHER:case at.VIDEO:((e,t)=>{const{type:n,rid:s,mediaId:r,mediaState:o,mediaType:i}=t,a=di.getSkylinkState(s),{room:d}=a,l=Js.retrieveStreamId(d,e,r),c=(new Date).toISOString();if(Lt.log.INFO([e,it.SIG_SERVER,n,_t.MEDIA_INFO.VIDEO_STATE_CHANGE,o,l],t),a.peerInformations[e]){if(a.peerMessagesStamps[e]){if(c<a.peerMessagesStamps[e].videoMuted)return void Lt.log.WARN([e,it.SIG_SERVER,n,_t.SIGNALING.OUTDATED_MSG],t);a.peerMessagesStamps[e].videoMuted=c}a.peerInformations[e].mediaStatus[l]||(a.peerInformations[e].mediaStatus[l]={}),a.peerInformations[e].mediaStatus[l].videoMuted=o===ct.MUTED||o===ct.STOPPED?ot.MUTED:ot.ACTIVE,di.setSkylinkState(a,d.id),Rr(a,l,e,lt.VIDEO,i===at.VIDEO_SCREEN)}else Lt.log.WARN([e,it.PEER_INFORMATION,n,`${_t.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`])})(n,s);break;case at.AUDIO_MIC:case at.AUDIO:((e,t)=>{const{type:n,rid:s,mediaId:r,mediaState:o}=t,i=di.getSkylinkState(s),{room:a}=i,d=Js.retrieveStreamId(a,e,r),l=(new Date).toISOString();if(Lt.log.INFO([e,it.SIG_SERVER,n,_t.MEDIA_INFO.AUDIO_STATE_CHANGE,o,d],t),i.peerInformations[e]){if(i.peerMessagesStamps[e]){if(l<i.peerMessagesStamps[e].audioMuted)return void Lt.log.WARN([e,it.SIG_SERVER,n,_t.SIGNALING.OUTDATED_MSG],t);i.peerMessagesStamps[e].audioMuted=l}i.peerInformations[e].mediaStatus[d]||(i.peerInformations[e].mediaStatus[d]={}),i.peerInformations[e].mediaStatus[d].audioMuted=o===ct.MUTED||o===ct.STOPPED?ot.MUTED:ot.ACTIVE,di.setSkylinkState(i,a.id),Rr(i,d,e,lt.AUDIO,!1)}else Lt.log.WARN([e,it.PEER_INFORMATION,n,`${_t.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`])})(n,s);break;default:Lt.log.ERROR([n,it.SIG_SERVER,`${_t.MEDIA_INFO.WARN.INVALID_MEDIA_TYPE} ${t}`],s)}},pr=(e,t,n,s,r)=>{const o=di.getSkylinkState(e),{peerMedias:i}=o,a=i[t][n];return a[s]&&a[s]!==r},mr=(e,t)=>{vn.processMessage(e,t)},Tr=e=>{dr(e)},Or=e=>{const{mid:t,rid:n,success:s}=e,r=di.getSkylinkState(n),o=t;Dt(as({state:Pe.ANSWER_ACK,peerId:o,room:r.room})),r.peerConnections[o].negotiating=!1,di.setSkylinkState(r,n),s?((e,t)=>{if(e.bufferedRemoteOffers[t]&&!Ro(e.bufferedRemoteOffers[t])){const n=e.bufferedRemoteOffers[t].shift();return Lt.log.DEBUG([t,"RTCSessionDescription",n.type,_t.NEGOTIATION_PROGRESS.APPLYING_BUFFERED_REMOTE_OFFER],n),dr(n),di.setSkylinkState(e,e.room.id),!0}return!1})(r,o)||((e,t)=>{const{peerConnections:n,currentRTCRTPSenders:s}=e;return new Promise((e=>{const r=n[t],o=r.getSenders()?r.getSenders():[],i=[],a=s[t]||[];let d=!1;o.forEach((e=>{i.push(e.getStats())}));const l={};Promise.all(i).then((t=>{t.forEach(((e,t)=>{e.forEach((e=>{e&&e.ssrc&&0!==e.bytesSent?l[e.ssrc]=o[t]:e&&"ssrc"===e.type&&e.id.indexOf("send")>1&&e.values.forEach((e=>{e.ssrc&&(l[e.ssrc]=o[t])}))}))}));const n=Object.keys(l);if(n.length!==a.length)d=!0;else{let e=0;for(let t=0;t<n.length;t+=1){const s=l[n[t]];for(let t=0;t<a.length;t+=1)if(s===a[t]){e+=1;break}}d=e!==n.length}e(d)}))}))})(r,o).then((e=>{e&&ms(r,o).catch((e=>{Lt.log.ERROR([t,it.SESSION_DESCRIPTION,Pe.ANSWER_ACK,_t.NEGOTIATION_PROGRESS.ERRORS.FAILED_RENEGOTIATION],e)}))})):Lt.log.ERROR([o,it.SESSION_DESCRIPTION,Pe.ANSWER,_t.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_ANSWER])},Ar=e=>{const{pc_config:{iceServers:t},sid:n,rid:s,tieBreaker:r}=e,o=di.getSkylinkState(s),i=new Fr;o.room.connection.peerConfig=Yn.setIceServers(t),o.room.inRoom=!0,o.user.sid=n,Lt.log.INFO([null,it.SIG_SERVER,null,`${_t.PEER_INFORMATIONS.SET_PEER_PRIORITY_WEIGHT}: `],r),o.peerPriorityWeight=r,Js.updatePeerMediaWithUserSid(o.room,n),zn.updatePeerStreamWithUserSid(o.room,n),di.setSkylinkState(o,s),Dt(xt({peerId:o.user.sid,peerInfo:Xr.getCurrentSessionInfo(o.room),isSelf:!0,room:o.room})),((e,t)=>{const n=di.getSkylinkState(e.id);n.peerStreams[t]&&Object.values(n.peerStreams[t]).forEach((n=>{zn.dispatchStreamEvent(l,{stream:n,peerId:t,room:Jr.getRoomInfo(e.id),isSelf:!0,peerInfo:Xr.getCurrentSessionInfo(e),streamId:n.id,isVideo:n.getVideoTracks().length>0,isAudio:n.getAudioTracks().length>0})}))})(o.room,n),i.enterRoom(o)},_r=e=>{Xs(e,qs.ENTER)},hr=e=>{dr(e)},Nr=e=>{Xs(e,qs.WELCOME)},Cr=e=>{const{candidate:t,mid:n,rid:s}=e,r=di.getSkylinkState(s),{room:o}=r,i=r.peerConnections[n],a=r.peerEndOfCandidatesCounter[n]||{},{RTCIceCandidate:d}=window,{ICE_CANDIDATE:l,PEER_CONNECTION:c,STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:E}}=_t,S=new Fn;if(!t&&!e.id)return Lt.log.WARN([n,it.CANDIDATE_HANDLER,null,l.INVALID_CANDIDATE],e),null;const R=new d({sdpMLineIndex:e.label,candidate:t,sdpMid:e.id}),u=`can-${R.foundation}`,I=R.candidate.split(" ")[7]||"";Lt.log.DEBUG([n,it.CANDIDATE_HANDLER,`${u}:${I}`,l.VALID_CANDIDATE],R),a.len=a.len||0,a.hasSet=!1,a.len+=1,di.setSkylinkState(r,s);const g={candidate:{candidate:R.candidate,sdpMid:R.sdpMid,sdpMLineIndex:R.sdpMLineIndex},error:null};if(Dt(bn({room:o,state:Oe.RECEIVED,peerId:n,candidateId:u,candidateType:I,candidate:g.candidate,error:g.error})),!i||i.signalingState===he.CLOSED)return Lt.log.WARN([n,it.CANDIDATE_HANDLER,`${u}:${I}`,c.NO_PEER_CONNECTION]),g.error=new Error(c.NO_PEER_CONNECTION),S.send(o.id,E.PROCESS_FAILED,n,u,g.candidate,g.error),Dt(bn({room:o,state:Oe.DROPPED,peerId:n,candidateId:u,candidateType:I,candidate:g.candidate,error:g.error})),Ho.signalingEndOfCandidates(n,r),null;i.remoteDescription&&i.remoteDescription.sdp&&i.localDescription&&i.localDescription.sdp?Yn.addIceCandidate(n,u,I,R,r):Yn.addIceCandidateToQueue(n,u,I,R,r),Ho.signalingEndOfCandidates(n,r);let p=r.gatheredCandidates[n];return p||(p={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),p.receiving[I].push({sdpMid:R.sdpMid,sdpMLineIndex:R.sdpMLineIndex,candidate:R.candidate}),r.gatheredCandidates[n]=p,di.setSkylinkState(r,s),null},Dr=e=>{const{result:t,type:n}=e,s=t;Lt.log.INFO(["Server",null,n,"Received list of peers"],s),Dt(Kt({state:ye.DISPATCHED,privilegePeerId:null,peerList:s}))},fr=e=>{const t=di.getSkylinkState(),{room:n,user:s}=t;Lt.log.WARN(["Server",null,e.type,`Introduce failed. Reason: ${e.reason}`]),(new lr).send(n.id,e),Dt(((e={})=>new de(X,{detail:e}))({state:X.ERROR,privilegedPeerId:s.sid,receivingPeerId:e.receivingPeerId,sendingPeerId:e.sendingPeerId,reason:e.reason}))},Mr=e=>{const{mid:t,rid:n,status:s,streamId:r,settings:o}=e,i=_o(n),{room:a,peerInformations:d}=i;return s===et.ENDED&&(o.isScreensharing&&(d[t].screenshare=!1,di.setSkylinkState(i,a.id)),Dt(qn({room:a,peerId:t,peerInfo:Xr.getPeerInfo(t,a),streamId:r,isSelf:!1,isScreensharing:o.isScreensharing,options:o,isVideo:!!o.audio,isAudio:!!o.video}))),null},Pr=e=>{const{mid:t,rid:n,publisherId:s}=e,r=n;let o=t;di.getSkylinkState(r).hasMCU&&(o=s),Lt.log.INFO([o,it.PEER_CONNECTION,null,_t.ROOM.LEAVE_ROOM.PEER_LEFT.START]);try{((e,t)=>{const n=di.getSkylinkState(e);if(!((e,t)=>{const n=e;return!(!n||!n.peerConnections[t]&&!n.peerInformations[t]&&(Lt.log.DEBUG([t,it.PEER_CONNECTION,null,`${_t.ROOM.LEAVE_ROOM.DROPPING_HANGUP} - ${_t.PEER_CONNECTION.NO_PEER_CONNECTION}`]),1))})(n,t))return;const{room:s}=n,r=Xr.getPeerInfo(t,s);if(t===pt.MCU){const e=n;return Dt($t({peerId:t,serverPeerType:Ce.MCU,room:s})),e.hasMCU=!1,void di.setSkylinkState(e,s.id)}Dt(Wt({peerId:t,peerInfo:r,isSelf:!1,room:s}))})(r,o),((e,t)=>{di.getSkylinkState(e).peerConnections[t]&&((e,t)=>{const n=di.getSkylinkState(e);n.peerConnections[t].signalingState!==he.CLOSED&&n.peerConnections[t].close()})(e,t)})(r,o),((e,t)=>{const n=di.getSkylinkState(e);setTimeout((()=>{const n=di.getSkylinkState(e);So(n)||(delete n.peerConnections[t],di.setSkylinkState(n,n.room.id)),Lt.log.INFO([t,it.PEER_CONNECTION,null,_t.ROOM.LEAVE_ROOM.PEER_LEFT.SUCCESS])}),500),n.bandwidthAdjuster&&!n.hasMCU&&new $s({roomKey:n.room.id,peerId:t}),delete n.peerInformations[t],delete n.peerMedias[t],delete n.peerMessagesStamps[t],delete n.peerEndOfCandidatesCounter[t],delete n.peerCandidatesQueue[t],delete n.peerStats[t],delete n.gatheredCandidates[t],delete n.peerStreams[t]})(r,o),((e,t)=>{const n=di.getSkylinkState(e);Ho.closeDataChannel(n,t)})(r,o)}catch(e){Lt.log.DEBUG([o,it.ROOM,null,_t.ROOM.LEAVE_ROOM.PEER_LEFT.ERROR],e)}},yr=e=>{const{action:t,rid:n,recordingId:s,error:r}=e,o=_o(n);"on"===t?((e,t)=>{const n=Object.assign({},e),{room:s}=n;Lt.log.DEBUG([pt.MCU,it.RECORDING,t,_t.RECORDING.START_SUCCESS]),Er.send(s.id,_t.STATS_MODULE.HANDLE_RECORDING_STATS.START,t,null,null),n.currentRecordingId=t,n.recordings[t]={active:!0,state:je.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,error:null},n.recordingStartInterval=setTimeout((()=>{Lt.log.INFO([pt.MCU,it.RECORDING,t,_t.RECORDING.MIN_RECORDING_TIME_REACHED]),n.recordingStartInterval=null}),4e3),di.setSkylinkState(n,s.id),Sr(je.START,t)})(o,s):"off"===t?((e,t)=>{const n=Object.assign({},e),{room:s,recordings:r}=n;Er.send(s.id,_t.STATS_MODULE.HANDLE_RECORDING_STATS.STOP,t,null,null),r[t]?(n.currentRecordingId=null,n.recordingStartInterval&&(clearTimeout(n.recordingStartInterval),Lt.log.WARN([pt.MCU,it.RECORDING,t,_t.RECORDING.ERRORS.STOP_ABRUPT]),n.recordingStartInterval=null),Lt.log.DEBUG([pt.MCU,it.RECORDING,t,_t.RECORDING.STOP_SUCCESS]),n.recordings[t].active=!1,n.recordings[t].state=je.STOP,n.recordings[t].endedDateTime=(new Date).toISOString(),di.setSkylinkState(n,s.id),Sr(je.STOP,t)):Lt.log.ERROR([pt.MCU,it.RECORDING,t,_t.RECORDING.ERRORS.SESSION_EMPTY])})(o,s):"error"===t&&(Sr(null,s,r),Lt.log.ERROR([pt.MCU,it.RECORDING,s,_t.RECORDING.ERRORS.MCU_RECORDING_ERROR],r),Er.send(o.room.id,_t.STATS_MODULE.HANDLE_RECORDING_STATS.MCU_RECORDING_ERROR,s,null,r))},vr=e=>{var t;Lt.log.INFO(["Server",null,e.type,"System action warning:"],e),Object.keys((new Zo).getAllStates()).length>1&&e.action===ke.REJECT&&Co(),"toClose"===e.reason&&(e.reason="toclose"),di.removeSkylinkState(di.getSkylinkState(e.rid)),Dt((t={action:e.action,info:e.info,reason:e.reason,rid:e.rid},new de(H,{detail:t})))},kr=e=>{const{action:t,rid:n}=e,s=_o(n);Lt.log.DEBUG([pt.MCU,"RTMP",null,_t.RTMP.message_received_from_sig]),"startSuccess"===t?((e,t)=>{const{rtmpSessions:n}=e,{rtmpId:s,peerId:r,streamId:o}=t;if(!n[s]){const t=Object.assign({},e);Lt.log.DEBUG([pt.MCU,"RTMP",_t.RTMP.started_success]),t.rtmpSessions[s]={active:!0,state:rt.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,peerId:r,streamId:o},Dt(Qt({state:rt.START,rtmpId:s,error:null})),di.setSkylinkState(t,t.room.id)}})(s,e):"stopSuccess"===t?((e,t)=>{const{rtmpSessions:n}=e,{rtmpId:s}=t,r=Object.assign({},e);n[s]?(Lt.log.DEBUG([pt.MCU,"RTMP",_t.RTMP.stopped_success]),r.rtmpSessions[s].active=!1,r.rtmpSessions[s].state=rt.STOP,r.rtmpSessions[s].endedDateTime=(new Date).toISOString(),Dt(Qt({state:rt.STOP,rtmpId:s,error:null})),di.setSkylinkState(r,r.room.id)):Lt.log.DEBUG([pt.MCU,"RTMP",_t.RTMP.stop_session_empty])})(s,e):((e,t)=>{const{error:n,rtmpId:s}=t,{rtmpSessions:r}=e,o=new Error(n||"Unkown Error"),i=Object.assign({},e);r[s]?(Lt.log.DEBUG([pt.MCU,"RTMP",_t.RTMP.error_session]),i.rtmpSessions[s].state=rt.ERROR,i.rtmpSessions[s].error=o,r[s].active&&(Lt.log.DEBUG([pt.MCU,"RTMP",_t.RTMP.error_Session_abrupt]),i.rtmpSessions[s].active=!1),Dt(Qt({state:rt.ERROR,rtmpId:s,error:o})),di.setSkylinkState(i,i.room.id)):Lt.log.DEBUG([pt.MCU,"RTMP",_t.RTMP.error_session_empty])})(s,e)},wr=e=>{const{type:t,mid:n,rid:s,userData:r,stamp:o}=e,i=di.getSkylinkState(s),{peerInformations:a,peerMessagesStamps:d}=i,l=n,{PEER_INFORMATIONS:c}=_t;let E=r.replace(/&quot;/g,'"');try{E=JSON.parse(E)}catch(e){Lt.log.INFO([l,null,t,`${c.USER_DATA_NOT_JSON}`],E)}finally{Lt.log.INFO([l,null,t,`${c.UPDATE_USER_DATA}`],E)}if(a[l]){if(d[l]&&po(o)){if(o<d[l].userData)return void Lt.log.WARN([l,null,t,`${c.OUTDATED_MSG}`],e);d[l].userData=o}a[l].userData=E||{},Dt(Ht({peerId:l,peerInfo:Xr.getPeerInfo(l,i.room),isSelf:!1}))}else Lt.log.INFO([l,null,t,`${c.NO_PEER_INFO} ${l}`])},Lr=e=>{const{mid:t,rid:n,mediaType:s,mediaId:r,publisherId:o}=e,i=di.getSkylinkState(n),{hasMCU:a,room:d}=i,l=a?o:t;try{if(!((e,t)=>{const n=e,{mediaId:s,publisherId:r}=t;return n.peerMedias[r]=n.peerMedias[r]||{},!n.peerMedias[r][s]&&(n.peerMedias[r][s]=t,di.setSkylinkState(n,n.room.id),!0)})(i,e)){const t=Object.values(Et);for(let o=0;o<t.length;o+=1)if(pr(n,l,r,t[o],e[t[o]])){if(Js.updatePeerMediaInfo(i.room,l,r,t[o],e[t[o]]),t[o]===Et.MEDIA_STATE)return void gr(d,s,l,e);if(t[o]===Et.TRANSCEIVER_MID)return void Ir(l,e);ur(l,e,t[o])}}}catch(e){Lt.log.ERROR([l,it.SIG_SERVER,_t.MEDIA_INFO.FAILED_PROCESSING_MEDIA_INFO_EVENT],e)}},br=e=>{yn.processStoredMessages(e)},Gr={joinRoom:e=>{const{room:t,user:n}=e,s=di.getSkylinkState(t.id),r=di.getInitOptions(),o=new zt(null,t.id);return{type:ze.JOIN_ROOM,uid:s.user.uid,cid:o.key,rid:t.id,userCred:n.token,timeStamp:n.timeStamp,apiOwner:o.appKeyOwner,roomCred:t.token,start:t.startDateTime,len:t.duration,isPrivileged:o.isPrivileged,autoIntroduce:o.autoIntroduce,key:r.appKey}},enterRoom:e=>{const{room:t}=e,n=di.getSkylinkState(t.id),s=di.getInitOptions(),{user:r,peerPriorityWeight:o,enableIceRestart:i,hasMCU:a}=n,{enableDataChannel:d}=s,{AdapterJS:l,navigator:c}=window,E=Xr.getUserInfo(t),S={type:ze.ENTER,mid:r.sid,rid:t.id,agent:l.webrtcDetectedBrowser,version:(l.webrtcDetectedVersion||0).toString(),os:c.platform,userInfo:E,weight:o,temasysPluginVersion:null,enableDataChannel:d,enableIceRestart:i,SMProtocolVersion:Ve,DTProtocolVersion:Re};return a&&(S.target=pt.MCU,S.publisherId=r.sid),S},welcome:(e,t)=>{const n=di.getSkylinkState(e.id),s=di.getInitOptions(),{user:r,peerPriorityWeight:o,enableIceRestart:i,room:a}=n,{enableDataChannel:d}=s,{AdapterJS:l}=window,c=Xr.getUserInfo(a);return{type:ze.WELCOME,mid:r.sid,rid:a.id,agent:l.webrtcDetectedBrowser,version:(l.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:c,weight:o,temasysPluginVersion:null,enableDataChannel:d,enableIceRestart:i,SMProtocolVersion:Ve,DTProtocolVersion:Re,target:t}},offer:(...e)=>Ho.createOffer(...e),answer:(...e)=>Ho.createAnswer(...e),answerAck:(e,t,n)=>{const{room:s,user:r}=e;return{type:ze.ANSWER_ACK,rid:s.id,mid:r.sid,target:t,success:n}},candidate:(e,t,n)=>{const s=t.room.id,r=di.getSkylinkState(s);return{type:ze.CANDIDATE,label:n.sdpMLineIndex,id:n.sdpMid,candidate:n.candidate,mid:r.user.sid,target:e,rid:s}},setUserData:e=>({type:ze.UPDATE_USER,mid:e.user.sid,rid:e.room.id,userData:Oo(e.user.userData)?e.user.userData:JSON.stringify(e.user.userData),stamp:(new Date).getTime()}),getPeerList:e=>({type:ze.GET_PEERS,showAll:e}),restartOffer:(e,t,n)=>{const s=di.getSkylinkState(e),{AdapterJS:r}=window,o=di.getInitOptions(),{user:i,room:a,enableIceRestart:d,peerInformations:l,peerPriorityWeight:c}=s;return{type:ze.RESTART,mid:i.sid,rid:a.id,agent:r.webrtcDetectedBrowser,version:(r.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:Xr.getUserInfo(a),target:t,weight:c,enableDataChannel:o.enableDataChannel,enableIceRestart:d,doIceRestart:!0===n&&d&&l[t]&&l[t].config.enableIceRestart,isRestartResend:!1,temasysPluginVersion:null,SMProtocolVersion:Ve,DTProtocolVersion:Re}},stream:(e,t,n,s,r)=>({type:ze.STREAM,mid:t.sid,rid:e,status:s,streamId:n.id,settings:r}),recording:(e,t)=>({type:t,rid:e,target:pt.MCU}),rtmp:(e,t,n,s,r=null,o=null)=>{const i={type:e,rid:t,rtmpId:s,streamId:r,endpoint:o,mid:n,target:pt.MCU};return e===ze.STOP_RTMP&&(delete i.endpoint,delete i.streamId),i},bye:(e,t)=>{const{room:n,user:s,hasMCU:r}=e,o={type:ze.BYE,rid:n.id,mid:s.sid,target:t};return r&&(o.publisherId=s.sid),o},roomLock:e=>{const{user:t,room:n}=e;return{type:ze.ROOM_LOCK,mid:t.sid,rid:n.id,lock:n.isLocked}},mediaInfoEvent:(e,t,n)=>({type:ze.MEDIA_INFO_EVENT,rid:e.room.id,mid:n.publisherId,target:t,publisherId:n.publisherId,mediaId:n.mediaId,mediaType:n.mediaType,mediaState:n.mediaState}),getStoredMessages:e=>{const{user:t,room:n}=e;return{mid:t.sid,rid:n.id,target:t.sid,type:ze.GET_STORED_MESSAGES}},userMessages:(e,t,n)=>{const s=[],{user:r,room:o}=e,{listOfPeers:i,isPrivate:a,isPersistent:d,secretId:l}=t,c={data:n,mid:r.sid,rid:o.id,msgId:Do(),type:ze.MESSAGE};if(l&&(c.secretId=l),a)for(let e=0;e<i.length;e+=1){const t=i[e],r=Object.assign({},c);r.target=t,s.push(r),Lt.log.DEBUG([t,it.MESSAGING,null,_t.MESSAGING.PRIVATE_MESSAGE],{message:n})}else d&&(c.isPersistent=d),s.push(c),Lt.log.DEBUG([null,it.MESSAGING,null,_t.MESSAGING.BROADCAST_MESSAGE],{message:n});return s}};let Ur=null;const Fr=class{constructor(){return Ur||(Ur=this),this.socket=null,this.attempts=0,this.timestamp=(new Date).valueOf(),this.messageHandler=new class{userMessageHandler(...e){mr(...e)}answerHandler(...e){Tr(...e)}answerAckHandler(...e){Or(...e)}inRoomHandler(...e){Ar(...e)}enterRoomHandler(...e){_r(...e)}offerHandler(...e){hr(...e)}welcomeHandler(...e){Nr(...e)}candidateHandler(...e){Cr(...e)}getPeerListHandler(...e){Dr(...e)}introduceErrorHandler(...e){fr(...e)}byeHandler(...e){Pr(...e)}streamHandler(...e){Mr(...e)}recordingHandler(...e){yr(...e)}redirectHandler(...e){vr(...e)}rtmpHandler(...e){kr(...e)}setUserDataHandler(...e){wr(...e)}mediaInfoEventHandler(...e){Lr(...e)}storedMessagesHandler(...e){br(...e)}},this.messageBuilder=new class{constructor(){this.messageBuilders=Gr}getJoinRoomMessage(...e){return this.messageBuilders.joinRoom(...e)}getWelcomeMessage(...e){return this.messageBuilders.welcome(...e)}getEnterRoomMessage(...e){return this.messageBuilders.enterRoom(...e)}getAnswerMessage(...e){return this.messageBuilders.answer(...e)}getAnswerAckMessage(...e){return this.messageBuilders.answerAck(...e)}getOfferMessage(...e){return this.messageBuilders.offer(...e)}getCandidateMessage(...e){return this.messageBuilders.candidate(...e)}getSetUserDataMessage(e){return this.messageBuilders.setUserData(e)}getPeerListMessage(...e){return this.messageBuilders.getPeerList(...e)}getRestartOfferMessage(...e){return this.messageBuilders.restartOffer(...e)}getStreamMessage(...e){return this.messageBuilders.stream(...e)}getRecordingMessage(...e){return this.messageBuilders.recording(...e)}getPeerMessagesForSignaling(...e){return this.messageBuilders.signalingMessages(...e)}getRTMPMessage(...e){return this.messageBuilders.rtmp(...e)}getByeMessage(...e){return this.messageBuilders.bye(...e)}getRoomLockMessage(...e){return this.messageBuilders.roomLock(...e)}getMediaInfoEventMessage(...e){return this.messageBuilders.mediaInfoEvent(...e)}getGetStoredMessagesMessage(...e){return this.messageBuilders.getStoredMessages(...e)}getUserMessages(...e){return this.messageBuilders.userMessages(...e)}},this.config=null,Ur}resetSocketConfig(e){return{protocol:e,socketType:window.WebSocket?"WebSocket":"Polling",signalingServerProtocol:e,socketSession:{finalAttempts:0,attempts:0},fallbackType:null,signalingServerPort:null,socketTimeout:!1}}createSocket(e){const t=di.getSkylinkState(e);return t.socketSession=this.resetSocketConfig(t.signalingServerProtocol),di.setSkylinkState(t,e),new Promise(((t,n)=>{try{null!==this.socket&&this.socket instanceof window.io.Socket&&this.socket.connected?t():this.tryCreateSocket(e,t,n)}catch(s){this.handleCreateSocketFailure(e,t,n,s)}}))}tryCreateSocket(e,t,n){const s=di.getSkylinkState(e),{socketSession:r}=s;this.socket=(e=>{const t=di.getSkylinkState(e.roomKey),n=di.getInitOptions(),{config:s}=e,{socketServer:r,socketTimeout:o,socketServerPath:i}=n,{socketPorts:a}=new zt(null,e.roomKey),d=Vt("SOCKET",{socketTimeout:o,socketServerPath:i});let l=[];r&&Io(r)&&Array.isArray(r.ports)&&r.ports.length?({ports:l}=r):l=a[s.signalingServerProtocol],(e=>!e.signalingServerPort)(s)?(s.signalingServerPort=l[0],s.fallbackType=Be.NON_FALLBACK):((e,t)=>e.indexOf(t.signalingServerPort)===e.length-1)(l,s)||Oo(n.socketServer)?s.socketType===Tt.WEBSOCKET?(s.socketType=Tt.POLLING,s.signalingServerPort=l[0]):(s.socketSession.finalAttempts+=1,s.signalingServerPort=l[0]):s.signalingServerPort=l[l.indexOf(s.signalingServerPort)+1],s.socketType===Tt.POLLING&&(d.reconnectionDelayMax=Bt.SOCKET.RECONNECTION_DELAY_MAX,d.reconnectionAttempts=Bt.SOCKET.RECONNECTION_ATTEMPTS.POLLING,d.transports=[Tt.XHR_POLLING,Tt.JSONP_POLLING,Tt.POLLING.toLowerCase()]);const c=(e=>{const{signalingServerProtocol:t,signalingServer:n,signalingServerPort:s,socketServer:r}=e;let o="";return o=Oo(n)?`${t}//${n}`:n&&Io(n)&&n.protocol?`${n.protocol}//${r.url}:${s}?rand=${Date.now()}`:`${t}//${n}:${s}?rand=${Date.now()}`,o})({signalingServerProtocol:s.signalingServerProtocol,signalingServer:t.socketServer,signalingServerPort:s.signalingServerPort,socketServer:r});return s.socketServer=r,s.socketServerPath=i,t.socketSession=s,di.setSkylinkState(t,e.roomKey),window.io(c,d)})({config:r,roomKey:e}),((e,t,n,s)=>{((e,t,n,s)=>{t.socket.on(mt.CONNECT,Rn.onConnection.bind(t,n,e)),t.socket.on(mt.MESSAGE,t.onMessage.bind(t)),t.socket.on(mt.DISCONNECT,Rn.onDisconnect.bind(t,e)),t.socket.on(mt.ERROR,Rn.onError.bind(t,e)),t.socket.on(mt.RECONNECT_ATTEMPT,Rn.onReconnectAttempt.bind(t,e)),t.socket.on(mt.RECONNECT_ERROR,Rn.onReconnectError.bind(t,e)),t.socket.on(mt.RECONNECT_FAILED,Rn.onReconnectFailed.bind(t,n,s,e))})(e,this,n,s)})(e,0,t,n)}handleCreateSocketFailure(e,t,n,s){const r=di.getSkylinkState(e),{socketSession:o}=r;Lt.log.ERROR(_t.INIT.SOCKET_CREATE_FAILED,s),Dt(cn({session:Gt()(o),errorCode:Fe.CONNECTION_FAILED,type:o.fallbackType,error:s})),n(s)}dispatchHandshakeProgress(e,t){Dt(as({peerId:e.user.sid,state:Pe[t],error:null,room:Jr.getRoomInfo(e.room.id)}))}answer(...e){return this.messageBuilder.getAnswerMessage(...e).then((t=>{const n=e[0];return this.sendMessage(t),this.dispatchHandshakeProgress(n,"ANSWER"),t}))}answerAck(...e){const t=this.messageBuilder.getAnswerAckMessage(...e),n=e[0];this.sendMessage(t),this.dispatchHandshakeProgress(n,"ANSWER_ACK")}enterRoom(...e){const t=this.messageBuilder.getEnterRoomMessage(...e);this.sendMessage(t),this.dispatchHandshakeProgress(...e,"ENTER")}joinRoom(...e){const t=this.messageBuilder.getJoinRoomMessage(...e);this.sendMessage(t)}offer(...e){const t=e[0],n=e[1];setTimeout((()=>{const s=di.getSkylinkState(t.id);s.peerConnections[n].negotiating?Lt.log.DEBUG([n,it.SIG_SERVER,null,`${_t.SIGNALING.ABORTING_OFFER}`]):this.messageBuilder.getOfferMessage(...e).then((e=>{this.sendMessage(e),this.dispatchHandshakeProgress(s,"OFFER")}))}),100)}welcome(...e){const t=this.messageBuilder.getWelcomeMessage(...e);this.sendMessage(t)}noop(){return null}sendCandidate(...e){const t=this.messageBuilder.getCandidateMessage(...e);t&&this.sendMessage(t)}setUserData(e){const t=this.messageBuilder.getSetUserDataMessage(e);t&&this.sendMessage(t)}getPeerList(e){const t=this.messageBuilder.getPeerListMessage(e);t&&this.sendMessage(t)}stream(...e){const t=this.messageBuilder.getStreamMessage(...e);t&&this.sendMessage(t)}recording(...e){const t=this.messageBuilder.getRecordingMessage(...e);this.sendMessage(t)}rtmp(...e){const t=this.messageBuilder.getRTMPMessage(...e);this.sendMessage(t)}roomLock(e){const t=this.messageBuilder.getRoomLockMessage(e);t&&this.sendMessage(t)}bye(...e){const t=this.messageBuilder.getByeMessage(...e);this.sendMessage(t)}mediaInfoEvent(e,t,n){const s=this.messageBuilder.getMediaInfoEventMessage(e,t,n);s&&this.sendMessage(s)}getStoredMessages(e){const t=this.messageBuilder.getGetStoredMessagesMessage(e);t&&this.sendMessage(t)}onMessage(e){const t=di.getSkylinkState(JSON.parse(e).rid);if(!t)return;const{socketSession:n}=t;var s;Dt((s={message:e,socketSession:Gt()(n)},new de(U,{detail:s}))),((e,t)=>{((e,t)=>{const{type:n}=t;switch(Lt.log.INFO(["SIG SERVER",null,n,"received"]),n){case ze.IN_ROOM:e.inRoomHandler(t);break;case ze.ENTER:e.enterRoomHandler(t);break;case ze.OFFER:e.offerHandler(t);break;case ze.WELCOME:e.welcomeHandler(t);break;case ze.ANSWER:e.answerHandler(t);break;case ze.ANSWER_ACK:e.answerAckHandler(t);break;case ze.CANDIDATE:e.candidateHandler(t);break;case ze.PEER_LIST:e.getPeerListHandler(t);break;case ze.INTRODUCE_ERROR:e.introduceError(t);break;case ze.BYE:e.byeHandler(t);break;case ze.STREAM:e.streamHandler(t);break;case ze.RECORDING:e.recordingHandler(t);break;case ze.REDIRECT:e.redirectHandler(t);break;case ze.RTMP:e.rtmpHandler(t);break;case ze.UPDATE_USER:e.setUserDataHandler(t);break;case ze.MEDIA_INFO_EVENT:e.mediaInfoEventHandler(t);break;case ze.MESSAGE:e.userMessageHandler(t,null);break;case ze.STORED_MESSAGES:e.storedMessagesHandler(t);break;case ze.PUBLIC_MESSAGE:e.userMessageHandler(t,!0);break;case ze.PRIVATE_MESSAGE:e.userMessageHandler(t,!1)}})(e,t)})(this.messageHandler,JSON.parse(e))}sendMessage(e){(e=>(e=>{const{rid:t}=e,n=di.getSkylinkState(t),{user:s,room:r}=n;return!go(s.bufferMessage)&&!un(s.bufferMessage)||(e=>{const{JOIN_ROOM:t,ENTER:n,WELCOME:s,OFFER:r,ANSWER:o,ANSWER_ACK:i,CANDIDATE:a,END_OF_CANDIDATES:d}=ze;return[t,n,s,r,o,i,a,d].indexOf(e.type)>-1})(e)?(e.type===Pe.ENTER&&go(s.bufferMessage)&&(Lt.log.DEBUG([s.sid,it.SIG_SERVER,null,_t.SIGNALING.BUFFER_NOT_NEEDED]),n.user.bufferMessage=!1,n.socketMessageQueue=[],di.setSkylinkState(n,n.room.id)),!1):(Lt.log.DEBUG([s.sid,it.SIG_SERVER,null,_t.SIGNALING.MESSAGE_ADDED_TO_BUFFER]),n.socketMessageQueue.unshift(e),un(s.bufferMessage)||(n.user.bufferMessage=!0,Lt.log.DEBUG([s.sid,it.SIG_SERVER,null,_t.SIGNALING.ENTER_LISTENER]),ft.addEventListener(At.HANDSHAKE_PROGRESS,In.bind(void 0,t))),di.setSkylinkState(n,r.id),!0)})(e))(e)||(Lt.log.INFO(["SIG SERVER",null,e.type,"sent"]),((e,t)=>{e.send(JSON.stringify(t))})(this.socket,e))}sendUserMessage(e,t,n){const s=this.messageBuilder.getUserMessages(e,t,n);Array.isArray(s)&&s.length&&s.map((e=>(this.sendMessage(e),null)))}updateAttempts(e,t,n){this.attempts=n;const s=di.getSkylinkState(e),{socketSession:r}=s;r.socketSession[t]=n,di.setSkylinkState(s,e)}getAttempts(){return this.attempts}},Br=e=>new Promise((t=>{const n=di.getSkylinkState(e.room.id),{room:s,peerConnections:r}=n,{ROOM:{LEAVE_ROOM:o}}=_t,i=new Fr,a=Object.keys(di.getSkylinkState()).length>1;if(s.inRoom=!1,di.setSkylinkState(n,s.id),a)Lt.log.INFO([s.roomName,null,null,o.SENDING_BYE]),Object.keys(r).forEach((e=>{i.bye(n,e)})),t(n);else{i.config=i.resetSocketConfig(window.location.protocol);const e=()=>{Lt.log.INFO([s.roomName,null,null,o.DISCONNECT_SOCKET.SUCCESS]),Ct(At.CHANNEL_CLOSE,e),t(n)};Nt(At.CHANNEL_CLOSE,e),i.socket.connected?i.socket.disconnect():t(n)}})),Vr=e=>{const{room:t,peerStreams:n,user:s}=e;n[s.sid]&&ns.prepStopStreams(t.id,null,!0),new Jo(e).stop(!0)},Hr=e=>{di.clearRoomStateFromSingletons(e),di.removeSkylinkState(e)},xr=e=>{const t=di.getSkylinkState(e);t.bandwidthAdjuster&&!t.hasMCU&&new $s({roomKey:e})},Wr=e=>new Promise(((t,n)=>{const{peerConnections:s,peerInformations:r,room:o,hasMCU:i,user:a}=e,{ROOM:{LEAVE_ROOM:d}}=_t;try{const n=i?s.MCU?[pt.MCU]:[]:Array.from(new Set([...Object.keys(s),...Object.keys(r)]));if(Ro(n))Lt.log.DEBUG([o.roomName,null,null,d.NO_PEERS]),Vr(e),Br(e).then((e=>{Lt.log.INFO([o.roomName,null,null,d.REMOVE_STATE.SUCCESS]),Dt(Wt({peerId:a.sid,peerInfo:Xr.getCurrentSessionInfo(o),isSelf:!0,room:Jr.getRoomInfo(o.id)})),xr(e.room.id),Hr(e.room.id),t(e.room.roomName)}));else{const s=[];n.forEach((t=>{s.push(((e,t)=>new Promise((n=>{const{room:s,peerConnections:r}=e,{ROOM:{LEAVE_ROOM:o}}=_t,{enableDataChannel:i}=di.getInitOptions();Lt.log.INFO([t,s.roomName,null,o.PEER_LEFT.START]),t===pt.MCU?Dt($t({peerId:t,serverPeerType:Ce.MCU,room:Jr.getRoomInfo(s.id)})):Dt(Wt({peerId:t,peerInfo:Xr.getPeerInfo(t,s),isSelf:!1,room:Jr.getRoomInfo(s.id)})),r[t]&&r[t].signalingState!==he.CLOSED&&Ho.closePeerConnection(e,t),i?(Nt(At.DATA_CHANNEL_STATE,(e=>{const{detail:t}=e;t.state!==le.CLOSED&&t.state!==le.CLOSING||(Lt.log.INFO([t.peerId,s.roomName,null,o.PEER_LEFT.SUCCESS]),n(t.peerId))})),Ho.closeDataChannel(e,t)):n(t)})))(e,t))})),Promise.all(s).then((()=>(Vr(e),Br(e)))).then((e=>{Lt.log.INFO([o.roomName,null,null,d.REMOVE_STATE.SUCCESS]),Dt(Wt({peerId:a.sid,peerInfo:Xr.getCurrentSessionInfo(o),isSelf:!0,room:Jr.getRoomInfo(o.id)})),xr(e.room.id),Hr(e.room.id),t(e.room.roomName)}))}}catch(e){Lt.log.ERROR([o.roomName,null,null,d.ERROR],e),n(e)}})),$r=(e=[],t=[])=>new Promise(((n,s)=>{const{ROOM:{LEAVE_ROOM:r}}=_t;try{const s=di.getSkylinkState(),o=Object.values(s);o[0]?Wr(o[0]).then((s=>{e.push(s),t.push(n),$r(e,t)})):(Lt.log.INFO([e,"Room",null,r.LEAVE_ALL_ROOMS.SUCCESS]),t.forEach((t=>t(e))))}catch(e){Lt.log.ERROR([null,"Room",null,r.LEAVE_ALL_ROOMS.ERROR],e),s(e)}})),Kr=class extends sn{constructor(){super();const{AdapterJS:e,navigator:t}=window;this.model={client_id:null,app_key:null,timestamp:null,username:null,sdk_name:Rt.WEB,sdk_version:null,agent_name:e.webrtcDetectedBrowser,agent_version:e.webrtcDetectedVersion,agent_platform:t.platform,agent_plugin_version:null,device_version:null,enumerated_devices:null,device_muted:null,network_type:t.connection?t.connection.type:"-",language:t.language}}send(e){const t=di.getSkylinkState(e);this.model.username=t.user&&t.user.uid||null,this.model.sdk_version=t.VERSION,this.model.client_id=t.clientId,this.model.app_key=di.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.client,this.model)}},jr=(e,t)=>{const n=new ln,s=new zt(e),r=n.enforceUserInitOptions(s),o=new class{constructor(e){this.apiResponse={},this.dataChannels={},this.peerCandidatesQueue={},this.peerEndOfCandidatesCounter={},this.gatheredCandidates={},this.retryCounters={},this.peerConnections={},this.peerStats={},this.peerInformations={},this.user=e.user,this.peerPriorityWeight=0,this.isPrivileged=e.isPrivileged,this.socketSession={},this.socketMessageQueue=[],this.channelOpen=!1,this.socketServer=e.socketServer,this.signalingServerProtocol=e.forceSSL?"https:":window.location.protocol,this.enableIceRestart=!1,this.hasMCU=e.hasMCU,this.room=e.room,this.peerMessagesStamps={},this.streamsMutedSettings={},this.streamsBandwidthSettings={bAS:{}},this.recordings={},this.currentRecordingId=!1,this.recordingStartInterval=null,this.currentCodecSupport=null,this.voiceActivityDetection=!0,this.bandwidthAdjuster=null,this.rtmpSessions={},this.bufferedLocalOffer={},this.bufferedRemoteOffers={},this.currentRTCRTPSenders={},this.clientId=e.clientId,this.streamsMediaStatus={},this.peerMedias={},this.hasPersistentMessage=e.hasPersistentMessage,this.peerStreams={},this.streamsSettings={},this.enableStatsGathering=e.enableStatsGathering}}(r);return o.user.userData=t.userData,o.apiResponse=Object.freeze((e=>{const t=Gt()(e);return delete t.room,delete t.user,t})(s)),di.setSkylinkState(o,e.roomName),o},Yr=(e,t=!0)=>{const n=e,{room:s,user:r}=n,o=new Fr;n.room.isLocked=t,di.setSkylinkState(n,s.id),o.roomLock(n),Dt(((e={})=>new de(q,{detail:e}))({isLocked:n.room.isLocked,peerInfo:Xr.getCurrentSessionInfo(s),peerId:r.sid,isSelf:!0}))},Jr=class{static leaveRoom(e){return Wr(e)}static leaveAllRooms(){return $r()}static lockRoom(e){return(e=>Yr(e,!0))(e)}static unlockRoom(e){return(e=>Yr(e,!1))(e)}static joinRoom(e){return((e={},t)=>new Promise(((n,s)=>{const r=new ln,o=new Fr,i=di.getInitOptions(),a=new Kr,d=ln.getRoomNameFromParams(e)?ln.getRoomNameFromParams(e):i.defaultRoom;Dt(en({readyState:Le.LOADING,error:null,room:{roomName:d}})),r.createRoom(d).then((i=>{const{response:l}=i;l.roomName=d;const c=jr(l,e);r.checkCodecSupport(c.room.id).then((()=>(a.send(c.room.id),o.createSocket(l.room_key).then((()=>{const r=ln.getStateByKey(l.room_key),i=Object.assign({},e);if(i.room=r,t||e.id&&e.active)rs.usePrefetchedStream(l.room_key,t,e).then((()=>{o.joinRoom(r),n(null)})).catch((e=>{s(e)}));else if(e.audio||e.video)rs.getUserMedia(c,i).then((e=>{o.joinRoom(r),n(e)})).catch((e=>{s(e)}));else{const t=Eo.parseMediaOptions(e,c);di.setSkylinkState(t,r.id),o.joinRoom(r),n(null)}}))))).catch((e=>{s(e)}))})).catch((e=>{s(e)}))})))(e)}static getRoomInfo(e){return(e=>{const t=di.getSkylinkState(e),{room:n}=t,s=Object.assign({},n);return delete s.connection,delete s.token,delete s.startDateTime,s})(e)}},Qr=e=>!So(e),Zr=(e,t)=>{const n=e.hasMCU?pt.MCU:t;let s={};if(e.peerConnections[n].connectionState!==he.CLOSED){const n=Xr.getPeerInfo(t,e.room);s=Gt()(n.settings)}else Lt.log.WARN([t,it.PEER_CONNECTION,null,_t.PEER_CONNECTION.NO_PEER_CONNECTION]);return s},qr={getPeerInfo:(e,t)=>{let n=null;if(!e)return null;const s=di.getSkylinkState(t.id);return s?((e,t)=>{const{user:n}=t;return e===n.sid})(e,s)?Xr.getCurrentSessionInfo(t):(n=Gt()(s.peerInformations[e]),n?(n.room=t.roomName,n.settings.data=!!(s.dataChannels[e]&&s.dataChannels[e].main&&s.dataChannels[e].main.channel&&s.dataChannels[e].main.channel.readyState===le.OPEN),n):(Lt.log.ERROR(`${_t.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`),n)):(Lt.log.ERROR(`${_t.ROOM_STATE.NOT_FOUND} ${t.id}`),n)},getCurrentSessionInfo:e=>{const t=di.getSkylinkState(e.id),n=di.getInitOptions(),{AdapterJS:s,navigator:r}=window,{enableDataChannel:o}=n,{streamsMediaStatus:i,peerPriorityWeight:a,enableIceRestart:d,peerStreams:l,streamsBandwidthSettings:c,streamsSettings:E,user:S}=t,R={userData:"",settings:{audio:!1,video:!1},mediaStatus:{},agent:{name:s.webrtcDetectedBrowser,version:s.webrtcDetectedVersion,os:r.platform,pluginVersion:null,SMProtocolVersion:Ve,DTProtocolVersion:Re,SDKVersion:St},room:Jr.getRoomInfo(e.id),config:{enableDataChannel:o,enableIceRestart:d,priorityWeight:a},sid:S.sid};return l[S.sid]&&Object.keys(l[S.sid]).forEach((e=>{E[e].settings.audio?(R.settings.audio={},R.settings.audio[e]=Gt()(E[e].settings.audio)):E[e].settings.video&&(R.settings.video={},R.settings.video[e]=Gt()(E[e].settings.video))})),R.mediaStatus=i,R.userData=S.userData||null,R.settings.maxBandwidth=Gt()(c.bAS),R.settings.data=o,Gt()(R)},getUserInfo:Cn,getUserData:(e,t)=>{if(t&&e.peerInformations[t]){let n=e.peerInformations[t].userData;return n||(n=""),n}return e.user.userData},setUserData:(e,t)=>{const n=di.getSkylinkState(e.id),{PEER_INFORMATIONS:{UPDATE_USER_DATA:s}}=_t,r=t||"";n.user.userData=r,di.setSkylinkState(n,n.room.id),(new Fr).setUserData(n),Dt(Ht({peerId:n.user.sid,peerInfo:qr.getCurrentSessionInfo(e),isSelf:!0})),Lt.log.INFO(s,r)},getPeersDataChannels:e=>{const{dataChannels:t}=e,n={},s=Object.keys(t);for(let e=0;e<s.length;e+=1){const r=s[e];if(n[r]={},Qr(t)){const e=Object.keys(t[r]);for(let s=0;s<e.length;s+=1){const o=t[r][e[s]],{channelName:i,channelType:a,transferId:d,streamId:l}=o;let c=null;c=Ho.getDataChannelBuffer(o),c.channelProp=e[s],c.channelName=i,c.channelType=a,c.currentTransferId=d,c.currentStreamId=l,c.readyState=o.channel?o.channel.readyState:le.CREATE_ERROR,n[r][i]=c}}}return n},getPeersCustomSettings:e=>{const{peerInformations:t}=e,n={};if((e=>!So(e))(t)){const s=Object.keys(t);for(let t=0;t<s.length;t+=1)s[t]!==pt.MCU&&(n[s[t]]=Zr(e,s[t]));return n}return n}},Xr=class{static getPeerInfo(e,t){return qr.getPeerInfo(e,t)}static getCurrentSessionInfo(e){return qr.getCurrentSessionInfo(e)}static getUserInfo(e){return qr.getUserInfo(e)}static getUserData(e,t){return qr.getUserData(e,t)}static setUserData(e,t){qr.setUserData(e,t)}static getPeersStreams(e,t){return qr.getPeersStreams(e,t)}static getPeersDataChannels(e){return qr.getPeersDataChannels(e)}static getPeersCustomSettings(e){return qr.getPeersCustomSettings(e)}},zr=(e,t,n,s)=>{const r=di.getSkylinkState(n.id),o=s,{streamsMutedSettings:i}=r;if(e){const e=Js.retrieveMediaId(lt.VIDEO,o);Js.updatePeerMediaInfo(n,r.user.sid,e,Et.MEDIA_STATE,i[o].videoMuted?ct.MUTED:ct.ACTIVE)}if(t){const t=Js.retrieveMediaId(lt.AUDIO,o);setTimeout((()=>Js.updatePeerMediaInfo(n,r.user.sid,t,Et.MEDIA_STATE,i[o].audioMuted?ct.MUTED:ct.ACTIVE)),e?1050:0)}},eo=(e,t,n)=>{const{peerStreams:s,streamsMutedSettings:r,user:o}=e;let i=!1,a=!1;return s[o.sid]&&s[o.sid][n]&&(yo(s[o.sid][n])&&r[n].audioMuted!==t.audioMuted&&(i=!0),vo(s[o.sid][n])&&r[n].videoMuted!==t.videoMuted&&(a=!0)),{hasToggledAudio:i,hasToggledVideo:a}},to=(e,t,n)=>{const s=di.getSkylinkState(e),{room:r,peerConnections:o,peerInformations:i,peerStreams:a,user:d}=s,l=eo(s,n,t),{hasToggledAudio:c,hasToggledVideo:E}=l;let S=null;a[d.sid]&&a[d.sid][t]&&(S=a[d.sid][t]);const R=!!Js.retrieveScreenMediaInfo(r,d.sid,{streamId:t});if(S)if(((e,t,n)=>{const s=e,{room:r}=s;t.hasToggledAudio&&(s.streamsMutedSettings[n].audioMuted=!s.streamsMutedSettings[n].audioMuted),t.hasToggledVideo&&(s.streamsMutedSettings[n].videoMuted=!s.streamsMutedSettings[n].videoMuted),Lt.log.DEBUG(_t.MEDIA_STREAM.UPDATE_MUTED_SETTINGS,s.streamsMutedSettings,n),di.setSkylinkState(s,r.id)})(s,l,t),((e,t)=>{const n=t,{room:s}=n,r=(e=>e.getAudioTracks())(e),o=(e=>e.getVideoTracks())(e);n.streamsMediaStatus[e.id].audioMuted=ot.UNAVAILABLE,n.streamsMediaStatus[e.id].videoMuted=ot.UNAVAILABLE,r.forEach((t=>{t.enabled=!n.streamsMutedSettings[e.id].audioMuted,n.streamsMediaStatus[e.id].audioMuted=n.streamsMutedSettings[e.id].audioMuted?ot.MUTED:ot.ACTIVE})),o.forEach((t=>{t.enabled=!n.streamsMutedSettings[e.id].videoMuted,n.streamsMediaStatus[e.id].videoMuted=n.streamsMutedSettings[e.id].videoMuted?ot.MUTED:ot.ACTIVE})),di.setSkylinkState(n,s.id),Lt.log.DEBUG(_t.MEDIA_STREAM.UPDATE_MEDIA_STATUS,n.streamsMediaStatus,e.id)})(S,s),((e,t,n,s,r=!1)=>{const o=di.getSkylinkState(s);(vo(n)&&e||yo(n)&&t)&&Dt(((e={})=>new de(Y,{detail:e}))({streamId:n.id,isScreensharing:r,mediaStatus:o.streamsMediaStatus[n.id]}))})(E,c,S,r.id,R),(e=>{const t=di.getSkylinkState(e.id).user.sid,n=Xr.getCurrentSessionInfo(e);Dt(Ht({isSelf:!0,peerId:t,peerInfo:n}))})(r),((e,t,n)=>{const s=di.getSkylinkState(e.id);zn.dispatchStreamEvent(w,{isSelf:!0,peerId:s.user.sid,peerInfo:Xr.getUserInfo(e),streamId:t.id,isScreensharing:n,isAudio:yo(t),isVideo:vo(t)})})(r,S,R),!o[pt.MCU]&&Ro(Object.keys(o))||o[pt.MCU]&&Ro(Object.keys(i))){const e=n=>{const{state:s}=n.detail;s===Pe.ANSWER_ACK&&(zr(E,c,r,t),Ct(At.HANDSHAKE_PROGRESS,e))};Nt(At.HANDSHAKE_PROGRESS,e)}else setTimeout((()=>{zr(E,c,r,t)}),500)},no=e=>{switch(e){case 1:return!1;case 0:default:return!0}},so=(e,t,n=null)=>{const{peerStreams:s,room:r,user:o}=e;if(!Io(t))return void Lt.log.ERROR(_t.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);if(!s[o.sid])return void Lt.log.WARN(_t.MEDIA_STREAM.ERRORS.NO_STREAM);if(n&&!s[o.sid][n])return void Lt.log.ERROR(_t.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);const i={audioMuted:To(t.audioMuted)?t.audioMuted:!po(t.audioMuted)||no(t.audioMuted),videoMuted:To(t.videoMuted)?t.videoMuted:!po(t.videoMuted)||no(t.videoMuted)},a=Object.keys(s[o.sid])||[];Ro(a)?Lt.log.ERROR(_t.MEDIA_STREAM.ERRORS.NO_STREAMS_MUTED,t):Object.values(a).filter((t=>eo(e,i,t).hasToggledAudio||eo(e,i,t).hasToggledVideo)).forEach((e=>{to(r.id,e,i)}))},ro=(e,t)=>{for(let n=0;n<t.length;n+=1)if(e.id===t[n].id)return!0;return!1},oo=(e,t)=>{const n=e.getTransceivers?e.getTransceivers():[],s=t.getTracks();if(Ro(n))return!1;for(let e=0;e<n.length;e+=1)if(n[e].sender.track&&ro(n[e].sender.track,s))return!0;return!1},io=(e,t,n,s)=>{const r=e,o=n.getTracks();for(let e=0;e<o.length;e+=1){const i=s.addTrack(o[e],n);i&&Fs(r,t,i)}di.setSkylinkState(r,r.room.id)},ao=(e,t,n,s)=>{const{peerConnections:r,hasMCU:o}=e;try{(e=>{const{user:t,room:n}=e,s=t.sid,r=Xr.getCurrentSessionInfo(n);Dt(Ht({isSelf:!0,peerId:s,peerInfo:r}))})(e),Object.keys(r).length>0||o?Ho.refreshPeerConnection(Object.keys(r),e,!1,{}).then((()=>{n(t)})).catch((e=>{Lt.log.ERROR(_t.PEER_CONNECTION.REFRESH_CONNECTION.FAILED),s(e)})):(Lt.log.WARN(_t.ROOM.ERRORS.NO_PEERS),n(t))}catch(e){Lt.log.ERROR(e)}},lo=e=>{const t={audio:{input:[],output:[]},video:{input:[]}};return e.forEach((e=>{const n={deviceId:e.deviceId||e.sourceId||"default",label:e.label,groupId:e.groupId||null};n.label=n.label||`Source for ${n.deviceId}`,["audio","audioinput"].indexOf(e.kind)>-1?t.audio.input.push(n):["video","videoinput"].indexOf(e.kind)>-1?t.video.input.push(n):"audiooutput"===e.kind&&t.audio.output.push(n)})),t},co=(e,t,n)=>{const s={streams:{video:null,audio:null,screenShare:null}};return Object.keys(n[t]).forEach((r=>{yo(n[t][r])?(s.streams.audio=s.streams.audio||{},s.streams.audio[r]=n[t][r]):vo(n[t][r])&&Js.retrieveScreenMediaInfo(e.room,t,{streamId:r})?(s.streams.screenShare=s.streams.screenShare||{},s.streams.screenShare[r]=n[t][r]):(s.streams.video=s.streams.video||{},s.streams.video[r]=n[t][r])})),s},Eo={parseMediaOptions:(e,t)=>{const n=di.getSkylinkState(t.room.id),s=e||{};return n.voiceActivityDetection="boolean"!=typeof s.voiceActivityDetection||s.voiceActivityDetection,s.bandwidth&&("number"==typeof s.bandwidth.audio&&(n.streamsBandwidthSettings.bAS.audio=s.bandwidth.audio),"number"==typeof s.bandwidth.video&&(n.streamsBandwidthSettings.bAS.video=s.bandwidth.video),"number"==typeof s.bandwidth.data&&(n.streamsBandwidthSettings.bAS.data=s.bandwidth.data)),s.autoBandwidthAdjustment&&(n.bandwidthAdjuster={interval:10,limitAtPercentage:100,useUploadBwOnly:!1},"object"==typeof s.autoBandwidthAdjustment&&("number"==typeof s.autoBandwidthAdjustment.interval&&s.autoBandwidthAdjustment.interval>=10&&(n.bandwidthAdjuster.interval=s.autoBandwidthAdjustment.interval),"number"==typeof s.autoBandwidthAdjustment.limitAtPercentage&&s.autoBandwidthAdjustment.limitAtPercentage>=0&&s.autoBandwidthAdjustment.limitAtPercentage<=100&&(n.bandwidthAdjuster.limitAtPercentage=s.autoBandwidthAdjustment.limitAtPercentage),"boolean"==typeof s.autoBandwidthAdjustment.useUploadBwOnly&&(n.bandwidthAdjuster.useUploadBwOnly=s.autoBandwidthAdjustment.useUploadBwOnly))),n},parseStreamSettings:(e,t="")=>{const n=((e,t="")=>{const n={audio:!1,video:!1};return(e.audio&&!t||e.audio&&t===lt.AUDIO)&&(n.audio=Gt()(Bt.MEDIA_OPTIONS.AUDIO),Io(e.audio)&&(To(e.audio.stereo)&&(n.audio.stereo=e.audio.stereo),To(e.audio.echoCancellation)&&(n.audio.echoCancellation=e.audio.echoCancellation),ko(gt.FIREFOX)||e.audio.deviceId&&Oo(e.audio.deviceId)&&(n.audio.deviceId=e.audio.deviceId),e.useExactConstraints&&To(e.useExactConstraints)&&(n.audio.exactConstraints=e.useExactConstraints))),(e.video&&!t||e.video&&t===lt.VIDEO)&&(n.video=Gt()(Bt.MEDIA_OPTIONS.VIDEO),Io(e.video)&&(e.video.deviceId&&Oo(e.video.deviceId)&&(n.video.deviceId=e.video.deviceId),e.video.resolution&&Io(e.video.resolution)&&((e.video.resolution.width&&Oo(e.video.resolution.width)||po(e.video.resolution.width))&&(n.video.resolution.width=e.video.resolution.width),(e.video.resolution.height&&Oo(e.video.resolution.height)||po(e.video.resolution.height))&&(n.video.resolution.height=e.video.resolution.height)),(e.video.frameRate&&Oo(e.video.frameRate)||po(e.video.frameRate))&&(n.video.frameRate=e.video.frameRate),e.useExactConstraints&&To(e.useExactConstraints)&&(n.video.exactConstraints=e.useExactConstraints))),n})(e,t);return{settings:n,mutedSettings:{shouldAudioMuted:!(!e.audio||!To(e.audio.mute))&&e.audio.mute,shouldVideoMuted:!(!e.video||!To(e.video.mute))&&e.video.mute},getUserMediaSettings:((e,t)=>{const n={audio:!1,video:!1};return(e.audio&&!t||e.audio&&t===lt.AUDIO)&&e.audio&&Io(e.audio)&&(n.audio={},n.audio.echoCancellation=!0,To(e.audio.echoCancellation)&&(n.audio.echoCancellation=e.audio.echoCancellation),ko(gt.FIREFOX)||e.audio.deviceId&&Oo(e.audio.deviceId)&&(n.audio.deviceId=e.audio.exactConstraints?{exact:e.audio.deviceId}:{ideal:e.audio.deviceId})),(e.video&&!t||e.video&&t===lt.VIDEO)&&(e.video&&Io(e.video)?(n.video={},e.video.deviceId&&Oo(e.video.deviceId)&&(n.video.deviceId=e.video.exactConstraints?{exact:e.video.deviceId}:{ideal:e.video.deviceId}),n.video.width=Io(e.video.resolution.width)?e.video.resolution.width:e.video.exactConstraints?{exact:e.video.resolution.width}:{max:e.video.resolution.width},n.video.height=Io(e.video.resolution.height)?e.video.resolution.height:e.video.exactConstraints?{exact:e.video.resolution.height}:{max:e.video.resolution.height},(e.video.frameRate&&Io(e.video.frameRate)||po(e.video.frameRate))&&(n.video.frameRate=Io(e.video.frameRate)?e.video.frameRate:e.video.exactConstraints?{exact:e.video.frameRate}:{max:e.video.frameRate})):e.video&&(n.video={width:e.video.exactConstraints?{exact:e.video.resolution.width}:{max:e.video.resolution.width},height:e.video.exactConstraints?{exact:e.video.resolution.height}:{max:e.video.resolution.height}})),n})(n,t)}},prepMediaAccessRequest:e=>new Promise(((t,n)=>{const{roomKey:s,...r}=e,o=Eo.parseStreamSettings(r,lt.AUDIO),i=Eo.parseStreamSettings(r,lt.VIDEO),{AdapterJS:a}=window;o.getUserMediaSettings.audio||i.getUserMediaSettings.video||n(_t.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),a.webRTCReady((()=>{window.navigator.mediaDevices.getUserMedia({audio:o.getUserMediaSettings.audio,video:i.getUserMediaSettings.video}).then((e=>{const n=Eo.onStreamAccessSuccess(s,e,o,i,!1),r=di.getSkylinkState(s);n[0]&&o.mutedSettings.shouldAudioMuted&&so(r,{audioMuted:o.mutedSettings.shouldAudioMuted,videoMuted:i.mutedSettings.shouldVideoMuted},n[0].id),n[1]&&i.mutedSettings.shouldVideoMuted&&so(r,{audioMuted:o.mutedSettings.shouldAudioMuted,videoMuted:i.mutedSettings.shouldVideoMuted},n[1].id),t(n)})).catch((e=>Eo.onStreamAccessError(e,n,t,s,o,i)))}))})),addLocalMediaStreams:(e,t)=>{const n=di.getSkylinkState(t.room.id),{peerConnections:s,user:r,peerStreams:o}=n,i=s[e];o[r.sid]&&!So(o[r.sid])&&((e,t,n,s)=>{const r=Object.values(n);for(let n=0;n<r.length;n+=1)oo(s,r[n])||io(e,t,r[n],s)})(n,e,o[r.sid],i)},onRemoteTrackAdded:(e,t,n,s,r,o)=>{const{user:i,hasMCU:a,room:d}=t,l={dispatchOnIncomingStream:e=>{Dt(Qn(e))},dispatchOnIncomingScreenStream:e=>{Dt(Zn(e))}},c=s?"dispatchOnIncomingScreenStream":"dispatchOnIncomingStream",E={stream:e,peerId:n,room:Jr.getRoomInfo(d.id),isSelf:a&&n===i.sid||!1,peerInfo:Xr.getPeerInfo(n,d),streamId:e.id,isVideo:r,isAudio:o};l[c](E),Dt(Ht({peerId:n,peerInfo:Xr.getPeerInfo(n,d),isSelf:a&&n===i.sid||!1,room:d}))},onStreamAccessError:(e,t,n,s,r,o)=>{const i=di.getInitOptions(),a=di.getSkylinkState(s),{audioFallback:d}=i;if(r.settings.audio&&o.settings.video&&d){const i=!0;return Lt.log.DEBUG([a.user.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.START_FALLBACK]),Dt(Jt({error:e,state:Ke.FALLBACKING,isAudioFallback:i})),window.navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{const t=Eo.onStreamAccessSuccess(s,e,r,o,i);n(t)})).catch((n=>{Lt.log.ERROR([a.user.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.ERRORS.FALLBACK,n]),Dt(Zt({error:n,isAudioFallbackError:!0})),Dt(Jt({error:e,state:Ke.ERROR,isAudioFallback:i})),t(n)}))}Lt.log.ERROR([a.user.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.ERRORS.GET_USER_MEDIA],e),Dt(Zt({error:e,isAudioFallbackError:!1})),t(e)},muteStreams:so,sendStream:(e,t=null)=>new Promise(((n,s)=>{if(!e)return s(new Error(_t.ROOM_STATE.NO_ROOM_NAME));const{room:r}=e,o=!Io(t)||null===t;if(!r.inRoom)return Lt.log.WARN(_t.ROOM.ERRORS.NOT_IN_ROOM),s(new Error(`${_t.ROOM.ERRORS.NOT_IN_ROOM}`));if(o)return s(new Error(`${_t.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${t}`));let i=!1;try{if(Array.isArray(t)){let r=!0;return t.forEach((e=>{mo(e.getAudioTracks)&&mo(e.getVideoTracks)||(r=!1)})),r?((e,t,n,s)=>{const r=[];return t.forEach((t=>{r.push(rs.usePrefetchedStream(e.room.id,t))})),Promise.all(r).then((t=>{ao(e,t,n,s)})).catch((e=>{s(e)}))})(e,t,n,s):s(new Error(_t.MEDIA_STREAM.ERRORS.INVALID_MEDIA_STREAM_ARRAY))}return i=!!t&&(mo(t.getAudioTracks)||mo(t.getVideoTracks)),i?((e,t,n,s)=>rs.usePrefetchedStream(e.room.id,t).then((t=>{ao(e,t,n,s)})).catch((e=>{s(e)})))(e,t,n,s):((e,t,n,s)=>rs.getUserMedia(e,t).then((t=>{ao(e,t,n,s)})).catch((e=>{s(e)})))(e,t,n,s)}catch(e){Lt.log.ERROR(_t.MEDIA_STREAM.ERRORS.SEND_STREAM,e)}})),getStreamSources:()=>{const{navigator:e}=window;return new Promise(((t,n)=>{e.mediaDevices&&mo(e.mediaDevices.enumerateDevices)?e.mediaDevices.enumerateDevices().then((e=>{t(lo(e))})):n(lo([]))}))},getStreams:(e,t=!0)=>{const n=di.getSkylinkState(e.room.id),{peerStreams:s,user:r}=n,o={},i=Object.keys(s);for(let e=0;e<i.length;e+=1){const a=i[e];t&&a===r.sid?(o[a]=co(n,a,s),o[a].isSelf=!0):a!==r.sid&&(o[a]=co(n,a,s))}return o},updateStreamsMediaStatus:(e,t,n)=>{const s=di.getSkylinkState(e),{room:r,streamsMediaStatus:o}=s,{mutedSettings:{shouldAudioMuted:i},settings:{audio:a,video:d}}=t;o[n.id]={},o[n.id].audioMuted=a?i?ot.MUTED:ot.ACTIVE:ot.UNAVAILABLE,o[n.id].videoMuted=d?i?ot.MUTED:ot.ACTIVE:ot.UNAVAILABLE,di.setSkylinkState(s,r.id)},splitAudioAndVideoStream:e=>{const{MediaStream:t}=window,n=[],s=e.getAudioTracks(),r=e.getVideoTracks();return yo(e)?n.push(new t(s)):n.push(null),vo(e)?n.push(new t(r)):n.push(null),n},updateStreamsMutedSettings:(e,t,n)=>{const s=di.getSkylinkState(e),{room:r,streamsMutedSettings:o}=s,{audio:i,video:a}=t.settings;o[n.id]={},o[n.id].audioMuted=!i,o[n.id].videoMuted=!a,di.setSkylinkState(s,r.id)},onStreamAccessSuccess:(e,t,n,s,r,o=!1,i)=>{const a=o?[t]:Eo.splitAudioAndVideoStream(t),d=di.getSkylinkState(e),{room:E,user:S}=d;return a.forEach((t=>{t&&(zn.addStream(S.sid,t,e),rs.buildStreamSettings(E,t,yo(t)?n:s),Eo.updateStreamsMutedSettings(E.id,yo(t)?n:s,t),Eo.updateStreamsMediaStatus(E.id,yo(t)?n:s,t),Js.processPeerMedia(E,S.sid,t,o),r&&Lt.log.DEBUG([S.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.FALLBACK_SUCCESS]),o?(Lt.log.DEBUG([S.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.START_SCREEN_SUCCESS]),zn.dispatchStreamEvent(c,{stream:t,peerId:S.sid,room:Jr.getRoomInfo(E.id),isSelf:!0,peerInfo:Xr.getCurrentSessionInfo(E),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0})):S.sid&&zn.dispatchStreamEvent(l,{stream:t,peerId:S.sid,room:Jr.getRoomInfo(E.id),isSelf:!0,peerInfo:Xr.getCurrentSessionInfo(E),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0}),i||Dt(((e={})=>new de(K,{detail:e}))({stream:t,isScreensharing:o,isAudioFallback:r,streamId:t.id,isAudio:yo(t),isVideo:vo(t)})))})),a},buildStreamSettings:(e,t,n)=>{const s=di.getSkylinkState(e.id);s.streamsSettings[t.id]={settings:n.settings,constraints:n.getUserMediaSettings},di.setSkylinkState(s,e.id)}},So=e=>0===Object.keys(e).length,Ro=e=>0===e.length,uo=e=>""===e,Io=e=>"object"==typeof e&&null!==e,go=e=>"object"==typeof e&&null==e,po=e=>"number"==typeof e,mo=e=>"function"==typeof e,To=e=>void 0!==e&&"boolean"==typeof e,Oo=e=>"string"==typeof e,Ao=(e,t,n)=>{let s=!0;return null!=e&&Oo(e)||(Lt.log.ERROR(`${n}: ${t} is null, undefined or not a string.`),s=!1),s},_o=e=>{if(Ao(e,"roomId","getStateByRid")){const t=di.getSkylinkState(),n=Object.keys(t);let s=null;for(let r=0;r<n.length;r+=1){const o=n[r];if(o===e){s=t[o];break}}return s}return Lt.log.ERROR(`getRoomStateByRid: ${_t.ROOM_STATE.NOT_FOUND} - ${e}`),null},ho=e=>_o(e),No=e=>{let t=null;if(Ao(e,"roomName","getRoomStateByName")){const n=di.getSkylinkState(),s=Object.keys(n);for(let r=0;r<s.length;r+=1){const o=n[s[r]];if(o.room.roomName.toLowerCase()===e.toLowerCase()){t=o;break}}}return t||Lt.log.ERROR(`getRoomStateByName: ${_t.ROOM_STATE.NOT_FOUND} - ${e}`),t},Co=()=>{try{(new Fr).socket.disconnect()}catch(e){Lt.log.ERROR(e)}},Do=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:n&&15).toString(16)}))},fo=e=>new Promise(((t,n)=>{const{navigator:s}=window;e&&Io(e)||n(new Error(`${_t.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${e}`)),s.mediaDevices.getUserMedia(e).then((e=>{const n=Eo.splitAudioAndVideoStream(e);t(n)})).catch((e=>{n(e)}))})),Mo=e=>new Promise(((t,n)=>{n(new Error(e))})),Po=(e,t)=>{const n=di.getSkylinkState(e.id),{peerConnections:s}=n,r=Object.keys(s);let o=!1;return r.forEach((e=>{e===t&&(o=!0)})),o},yo=e=>e.getAudioTracks().length>0,vo=e=>e.getVideoTracks().length>0,ko=e=>{const{AdapterJS:t}=window;switch(e){case gt.CHROME:return t.webrtcDetectedBrowser===gt.CHROME;case gt.SAFARI:return t.webrtcDetectedBrowser===gt.SAFARI;case gt.FIREFOX:return t.webrtcDetectedBrowser===gt.FIREFOX;case gt.REACT_NATIVE:return t.webrtcDetectedBrowser===gt.REACT_NATIVE;default:return Lt.log.DEBUG(_t.UTILS.INVALID_BROWSER_AGENT),!1}},wo=e=>new Date(e).toISOString(),Lo=()=>(new Date).toISOString(),bo=(e,t,n,s,r)=>{const o="data"===s?"application":s;let i=-1,a=-1;for(let e=0;e<t.length;e+=1)if(0===t[e].indexOf("m="+o))i=e;else if(i>0){if(0===t[e].indexOf("m="))break;0===t[e].indexOf("c=")?a=e:0!==t[e].indexOf("b=AS:")&&0!==t[e].indexOf("b:TIAS:")||(t.splice(e,1),e-=1)}"number"==typeof r&&r>0?-1!==i&&-1!==a?(Lt.log.INFO([e,"RTCSessionDesription",n,`Limiting maximum sending ${s} bandwidth ->`],r),t.splice(a+1,0,"firefox"===window.webrtcDetectedBrowser?"b=TIAS:"+(1e3*r).toFixed(0):"b=AS:"+r)):Lt.log.WARN([e,"RTCSessionDesription",n,`Not limiting ${s} bandwidth as ${s} is not being sent`]):Lt.log.WARN([e,"RTCSessionDesription",n,`Not limiting ${s} bandwidth`])},Go={getSDPCommonSupports:(e,t=null,n)=>{const s=di.getSkylinkState(n),r={audio:!1,video:!1},{currentCodecSupport:o,peerInformations:i}=s,{beSilentOnParseLogs:a}=di.getInitOptions();if(!e||!t||!t.sdp){if(r.video=!(!o.video.h264&&!o.video.vp8),r.audio=!!o.audio.opus,e){const t=((i[e]||{}).agent||{}).name||"";ko(t)&&(r.video=Object.keys(o.video).length>0,r.audio=Object.keys(o.audio).length>0)}return r}const d=Go.getSDPCodecsSupport(e,t,a),l=o;for(const e in l.audio)if(l.audio.hasOwnProperty(e)&&l.audio[e]&&d.audio[e]){r.audio=!0;break}for(const e in l.video)if(l.video.hasOwnProperty(e)&&l.video[e]&&d.video[e]){r.video=!0;break}return r},getSDPCodecsSupport:(e,t,n)=>{const s={audio:{},video:{}};if(!t||!t.sdp)return s;const r=t.sdp.split("\r\n");let o="";for(let e=0;e<r.length;e+=1)if(0!==r[e].indexOf("m=")){if(0===r[e].indexOf("a=rtpmap:")){const t=(r[e].split(" ")[1]||"").split("/"),n=(t[0]||"").toLowerCase(),i=t[1]+(t[2]?`/${t[2]}`:"");if(["ulpfec","red","telephone-event","cn","rtx"].indexOf(n)>-1)continue;s[o][n]=s[o][n]||[],-1===s[o][n].indexOf(i)&&s[o][n].push(i)}}else o=(r[e].split("m=")[1]||"").split(" ")[0];return n||Lt.log.INFO([e||null,"RTCSessionDescription",t.type,"Parsed codecs support ->"],s),s},getCodecsSupport:e=>new Promise(((t,n)=>{const s=di.getSkylinkState(e),{beSilentOnParseLogs:r}=di.getInitOptions(),o=s,{RTCPeerConnection:i}=window;s.currentCodecSupport&&t(s.currentCodecSupport),o.currentCodecSupport={audio:{},video:{}},ko(gt.SAFARI)&&(o.currentCodecSupport.audio={opus:["48000/2"]},o.currentCodecSupport.video={h264:["48000"]},t(o.currentCodecSupport));try{const e=new i(null);e.addTransceiver(lt.VIDEO),e.addTransceiver(lt.AUDIO),e.createOffer().then((e=>{o.currentCodecSupport=Uo.getSDPCodecsSupport(null,e,r),t(o.currentCodecSupport)})).catch((e=>{n(e)}))}catch(e){n(e)}})),setSDPBitrate:(e,t,n)=>{const s=di.getSkylinkState(n),r=t.sdp.split("\r\n"),o=t.type;let i,a,d;const l=Xr.getPeersCustomSettings(s);return s.streamsBandwidthSettings.bAS?(i=s.streamsBandwidthSettings.bAS.audio,a=s.streamsBandwidthSettings.bAS.video,d=s.streamsBandwidthSettings.bAS.data):l[e]&&l[e].maxBandwidth&&"object"==typeof l[e].maxBandwidth&&("number"==typeof l[e].maxBandwidth.audio&&(i=l[e].maxBandwidth.audio),"number"==typeof l[e].maxBandwidth.video&&(a=l[e].maxBandwidth.video),"number"==typeof l[e].maxBandwidth.data&&(d=l[e].maxBandwidth.data)),bo(e,r,o,"audio",i),bo(e,r,o,"video",a),bo(e,r,o,"data",d),r.join("\r\n")},getSDPICECandidates:(e,t,n)=>{const{RTCIceCandidate:s}=window,r={host:[],srflx:[],relay:[]};return t&&t.sdp?(t.sdp.split("m=").forEach(((e,t)=>{if(0===t)return;const n=((e.match(/a=mid:.*\r\n/gi)||[])[0]||"").replace(/a=mid:/gi,"").replace(/\r\n/,""),o=t-1;(e.match(/a=candidate:.*\r\n/gi)||[]).forEach((e=>{const t=(e.split(" ")[7]||"host").replace(/\r\n/g,"");r[t]=r[t]||[],r[t].push(new s({sdpMid:n,sdpMLineIndex:o,candidate:(e.split("a=")[1]||"").replace(/\r\n/g,"")}))}))})),n||Lt.log.INFO([e,"RTCSessionDesription",t.type,"Parsing session description ICE candidates ->"],r),r):r},getSDPSelectedCodec:(e,t,n,s)=>{const r={name:null,implementation:null,clockRate:null,channels:null,payloadType:null,params:null};return t&&t.sdp?(t.sdp.split("m=").forEach(((e,t)=>{if(0===t||0!==e.indexOf(`${n} `))return;const s=(e.split("\r\n")[0]||"").split(" ");s.splice(0,3);for(let t=0;t<s.length;t+=1){const n=e.match(new RegExp(`a=rtpmap:${s[t]}.*\r\n`,"gi"));if(!n)continue;const o=((n[0]||"").replace(/\r\n/g,"").split(" ")[1]||"").split("/");if(!(["red","ulpfec","telephone-event","cn","rtx"].indexOf(o[0].toLowerCase())>-1)){r.name=o[0],r.clockRate=parseInt(o[1],10)||0,r.channels=parseInt(o[2]||"1",10)||1,r.payloadType=parseInt(s[t],10),r.params="",(e.match(new RegExp(`a=fmtp:${s[t]}.*\r\n`,"gi"))||[]).forEach((e=>{r.params+=e.replace(new RegExp(`a=fmtp:${s[t]}`,"gi"),"").replace(/ /g,"").replace(/\r\n/g,"")}));break}}})),s||Lt.log.INFO([e,"RTCSessionDesription",t.type,`Parsing session description "${n}" codecs ->`],r),r):r},getTransceiverMid:(e,t)=>{const n={audio:[],video:[]};return e.sdp.split("m=").forEach(((e,t)=>{const s=e.split(/\n/),r=s[0].split(" ")[0];if("application"===r||0===t)return;let o={};for(let e=0;e<s.length;e+=1){if(s[e].match(/a=recvonly|a=sendonly|a=sendrecv|a=inactive/)){const t=s[e].split("=");o.direction=t[1].trim()}if(s[e].match(/a=mid:*/)&&(o.transceiverMid=s[e].split(/:/)[1].trim()),s[e].match(/a=msid:([\w|-|{]+)/)){const t=s[e].split(" "),n=t[0].split(/:/)[1].trim();o.streamId="-"===n?"":n,o.trackId=t[1].trim()}o.transceiverMid&&o.streamId&&o.trackId&&(n[r].push(o),o={})}})),t||Lt.log.INFO([null,"RTCSessionDesription",e.type,`Parsing session description "${e.type}" transceivers ->`],n),n}},Uo=class{static getSDPCommonSupports(...e){return Go.getSDPCommonSupports(...e)}static getCodecsSupport(...e){return Go.getCodecsSupport(...e)}static setSDPBitrate(...e){return Go.setSDPBitrate(...e)}static getSDPCodecsSupport(...e){return Go.getSDPCodecsSupport(...e)}static getSDPICECandidates(...e){return Go.getSDPICECandidates(...e)}static getSDPSelectedCodec(...e){return Go.getSDPSelectedCodec(...e)}static getTransceiverMid(...e){return Go.getTransceiverMid(...e)}},Fo=e=>"relay"===e?"relayed":"host"===e||e.indexOf("host")>-1?"local":"srflx"===e?"serverreflexive":"prflx"===e?"peerreflexive":e,Bo={parseSelectedCandidatePair:(e,t,n,s,r,o)=>{const{peerStats:i}=e,{raw:a,selectedCandidatePair:d}=t,l=Object.keys(t.raw);let c=null,E=null,S=null;if(ko(gt.CHROME))for(let e=0;e<l.length;e+=1)"transport"===a[l[e]].type&&(c=a[l[e]]);else ko(gt.FIREFOX)&&(c={});if(c)for(let e=0;e<l.length;e+=1){const t=a[l[e]];if("candidate-pair"===t.type&&t.id===c.selectedCandidatePairId||"candidate-pair"===t.type&&t.selected){const e=t;E=e.localCandidateId,S=e.remoteCandidateId,d.id=e.id,d.writable=e.writable,d.priority=e.priority,d.nominated=e.nominated;const n=i[o][t.id],s=parseInt(t.totalRoundTripTime||"0",10);d.totalRoundTripTime=s,d.roundTripTime=Bo.tabulateStats(n,t,"totalRoundTripTime");const r=parseInt(t.consentRequestsSent||"0",10);d.consentRequests.totalSent=r,d.consentRequests.sent=Bo.tabulateStats(n,t,"consentRequestsSent");const a=parseInt(t.requestsReceived||"0",10);d.requests.totalReceived=a,d.requests.received=Bo.tabulateStats(n,t,"requestsReceived");const l=parseInt(t.requestsSent||"0",10);d.requests.totalSent=l,d.requests.sent=Bo.tabulateStats(n,t,"requestsSent");const c=parseInt(t.responsesSent||"0",10);d.responses.totalSent=c,d.responses.sent=Bo.tabulateStats(n,t,"responsesSent");const R=parseInt(t.responsesReceived||"0",10);d.responses.totalReceived=R,d.responses.received=Bo.tabulateStats(n,t,"responsesReceived")}}if(E&&S){if("remote-candidate"===n){const e=s;e.id===S&&(d.remote.ipAddress=e.ip?e.ip:e.address,d.remote.portNumber=e.port,d.remote.transport=e.protocol,d.remote.priority=e.priority,d.remote.candidateType=Fo(e.candidateType))}if("local-candidate"===n){const e=s;e.id===E&&(d.local.ipAddress=e.ip?e.ip:e.address,d.local.portNumber=e.port,d.local.transport=e.protocol,d.local.priority=e.priority,d.local.networkType=e.networkType,d.local.candidateType=Fo(e.candidateType))}}},parseCertificates:(e,t)=>{const{certificate:n,raw:s}=e,r=Object.keys(e.raw);let o=null;for(let e=0;e<r.length;e+=1)"transport"===s[r[e]].type&&(o=s[r[e]]);if(o){n.srtpCipher=o.srtpCipher,n.dtlsCipher=o.dtlsCipher,n.tlsVersion=o.tlsVersion;const{localCertificateId:e,remoteCertificateId:s}=o;t.id===e?(n.local={},n.local.base64Certificate=t.base64Certificate,n.local.fingerprintAlgorithm=t.fingerprintAlgorithm):t.id===s&&(n.remote={},n.remote.base64Certificate=t.base64Certificate,n.remote.fingerprintAlgorithm=t.fingerprintAlgorithm)}},tabulateStats:(e=null,t,n)=>{const s=t.timestamp,r=e&&e.timestamp||0,o=parseFloat(t[n]||"0",10),i=parseFloat(e&&e[n]||"0",10);return new Date(s).getTime()===new Date(r).getTime()?o:parseFloat(((o-i)/(s-r)*1e3).toFixed(3)||"0",10)},parseAudio:(e,t,n,s,r,o)=>{const{peerStats:i}=e,a=i[r][s.id];switch(o){case"receiving":((e,t,n)=>{const s=e.audio.receiving,r=parseInt(t.packetsReceived||"0",10);s.totalPackets=r,s.packets=Bo.tabulateStats(n,t,"packetsReceived");const o=parseInt(t.bytesReceived||"0",10);s.totalBytes=o,s.bytes=Bo.tabulateStats(n,t,"bytesReceived");const i=parseInt(t.packetsLost||"0",10);s.totalPacketsLost=i,s.packetsLost=Bo.tabulateStats(n,t,"packetsLost"),s.jitter=parseInt(t.jitter||"0",10),s.ssrc=t.ssrc;const{trackId:a}=t,d=e.raw[a];d&&(s.audioLevel=parseFloat(d.audioLevel).toFixed(5),s.totalSamplesReceived=parseInt(d.totalSamplesReceived||"0",10),s.totalSamplesDuration=parseInt(d.totalSamplesDuration||"0",10))})(t,s,a);break;case"sending":((e,t,n)=>{const s=e.audio.sending;if(t.bytesSent){const e=parseInt(t.bytesSent||"0",10);s.totalBytes=e,s.bytes=Bo.tabulateStats(n,t,"bytesSent")}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);s.totalPackets=e,s.packets=Bo.tabulateStats(n,t,"packetsSent")}if(t.retransmittedBytesSent||po(t.retransmittedBytesSent)){const e=parseInt(t.retransmittedBytesSent||"0",10);s.totalRetransmittedBytesSent=e,s.retransmittedBytesSent=Bo.tabulateStats(n,t,"retransmittedBytesSent")}if(t.retransmittedPacketsSent||po(t.retransmittedPacketsSent)){const e=parseInt(t.retransmittedPacketsSent||"0",10);s.totalRetransmittedPacketsSent=e,s.retransmittedPacketsSent=Bo.tabulateStats(n,t,"retransmittedPacketsSent")}s.ssrc=t.ssrc,t.jitter&&(s.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(s.roundTripTime=parseInt(t.roundTripTime||"0",10));const{trackId:r,mediaSourceId:o}=t,i=e.raw[r];i&&(s.echoReturnLoss=parseInt(i.echoReturnLoss||"0",10),s.echoReturnLossEnhancement=parseInt(i.echoReturnLossEnhancement||"0",10));const a=e.raw[o];a&&(s.audioLevel=parseFloat(a.audioLevel).toFixed(5),s.totalSamplesDuration=parseInt(a.totalSamplesDuration||"0",10))})(t,s,a);break;default:Lt.log.DEBUG([r,it.STATS_MODULE,null,_t.STATS_MODULE.ERRORS.PARSE_FAILED])}},parseVideo:(e,t,n,s,r,o)=>{const{peerStats:i}=e,a=i[r][s.id];switch(o){case"receiving":((e,t,n)=>{const s=e.video.receiving;if(t.bytesReceived){const e=parseInt(t.bytesReceived||"0",10);s.totalBytes=e,s.bytes=Bo.tabulateStats(n,t,"bytesReceived")}if(t.packetsReceived){const e=parseInt(t.packetsReceived||"0",10);s.totalPackets=e,s.packets=Bo.tabulateStats(n,t,"packetsReceived")}if(Number.isInteger(t.packetsLost)){const e=parseInt(t.packetsLost||"0",10);s.totalPacketsLost=e,s.packetsLost=Bo.tabulateStats(n,t,"packetsLost")}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);s.totalFirs=e,s.firs=Bo.tabulateStats(n,t,"firCount")}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);s.totalNacks=e,s.nacks=Bo.tabulateStats(n,t,"nackCount")}if(t.pliCount||Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);s.totalPlis=e,s.plis=Bo.tabulateStats(n,t,"pliCount")}s.ssrc=t.ssrc,s.qpSum=parseInt(t.qpSum||"0",10),s.decoderImplementation=t.decoderImplementation;const{trackId:r}=t,o=e.raw[r];o&&(s.framesDropped=parseFloat(o.framesDropped||"0"),s.frames=parseInt(o.framesReceived||"0",10),s.framesDecoded=parseInt(o.framesDecoded||"0",10),s.frameWidth=parseInt(o.frameWidth||"0",10),s.frameHeight=parseInt(o.frameHeight||"0",10))})(t,s,a);break;case"sending":((e,t,n)=>{const s=e.video.sending;if(t.bytesSent){const e=parseInt(t.bytesSent||"0",10);s.totalBytes=e,s.bytes=Bo.tabulateStats(n,t,"bytesSent")}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);s.totalPackets=e,s.packets=Bo.tabulateStats(n,t,"packetsSent")}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);s.totalFirs=e,s.firs=Bo.tabulateStats(n,t,"firCount")}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);s.totalNacks=e,s.nacks=Bo.tabulateStats(n,t,"nackCount")}if(Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);s.totalPlis=e,s.plis=Bo.tabulateStats(n,t,"pliCount")}t.jitter&&(s.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(s.roundTripTime=parseInt(t.roundTripTime||"0",10)),Number.isInteger(t.framesEncoded)&&(s.framesEncoded=parseInt(t.framesEncoded||"0",10)),s.ssrc=t.ssrc,s.qpSum=parseInt(t.qpSum||"0",10);const{trackId:r,mediaSourceId:o}=t,i=e.raw[r];i&&(s.frameWidth=parseInt(i.frameWidth||"0",10),s.frameHeight=parseInt(i.frameHeight||"0",10),s.frames=parseInt(i.framesSent||"0",10),s.hugeFramesSent=parseInt(i.hugeFramesSent||"0",10));const a=e.raw[o];a&&(s.framesPerSecond=parseInt(a.framesPerSecond||"0",10))})(t,s,a);break;default:Lt.log.DEBUG([r,it.STATS_MODULE,null,_t.STATS_MODULE.ERRORS.PARSE_FAILED])}},parseMedia:(e,t,n,s,r,o,i)=>{const a=s.kind||s.mediaType;a===lt.AUDIO?Bo.parseAudio(e,t,n,s,o,i):a===lt.VIDEO?Bo.parseVideo(e,t,n,s,o,i):Lt.log.DEBUG([o,it.STATS_MODULE,null,_t.STATS_MODULE.INVALID_TRACK_KIND],s)}},Vo=class{constructor(e,t){this.roomState=di.getSkylinkState(e),this.peerConnection=this.roomState.peerConnections[t]||null,this.dataChannel=this.roomState.dataChannels[t]||null,this.peerId=t,this.roomKey=e,this.output={peerId:t,raw:{},connection:{},audio:{sending:{},receiving:{}},video:{sending:{},receiving:{}},selectedCandidatePair:{id:null,local:{},remote:{},consentRequests:{},responses:{},requests:{}},certificate:{}},this.beSilentOnLogs=di.getInitOptions().beSilentOnStatsLogs,this.beSilentOnParseLogs=di.getInitOptions().beSilentOnParseLogs,this.bandwidth=null}getConnectionStatus(){return this.getStatistics(!1,!1)}getStatsSuccess(e,t,n){if(!n&&ko(gt.REACT_NATIVE))return void e(this.output);const{peerStats:s,room:r}=this.roomState;"function"==typeof n.forEach?n.forEach(((e,t)=>{this.output.raw[t]=e})):this.output.raw=n;try{if(So(s))return void Lt.log.DEBUG([this.peerId,it.STATS_MODULE,null,_t.STATS_MODULE.STATS_DISCARDED]);Object.entries(this.output.raw).forEach((e=>{const t=e[0],n=e[1],{type:o}=n;switch(o){case"remote-inbound-rtp":case"outbound-rtp":case"inbound-rtp":"inbound-rtp"===o?Bo.parseMedia(this.roomState,this.output,o,n,this.peerConnection,this.peerId,"receiving"):Bo.parseMedia(this.roomState,this.output,o,n,this.peerConnection,this.peerId,"sending");break;case"certificate":Bo.parseCertificates(this.output,n);break;case"local-candidate":case"remote-candidate":case"media-source":Bo.parseSelectedCandidatePair(this.roomState,this.output,o,n,this.peerConnection,this.peerId)}s[this.peerId][t]=this.output.raw[t],di.setSkylinkState(this.roomState,r.id)}))}catch(e){this.getStatsFailure(t,_t.STATS_MODULE.ERRORS.PARSE_FAILED,e)}this.beSilentOnLogs||Dt(Yt({state:Ne.RETRIEVE_SUCCESS,peerId:this.peerId,stats:this.output})),e(this.output)}getStatsFailure(e,t,n){const s=t||_t.STATS_MODULE.RETRIEVE_STATS_FAILED;this.beSilentOnLogs||(Lt.log.ERROR([this.peerId,it.STATS_MODULE,null,s],n),Dt(Yt({state:Ne.RETRIEVE_ERROR,peerId:this.peerId,error:n}))),e(n)}getStatistics(e=!1,t=!1){const{STATS_MODULE:n}=_t;return new Promise(((s,r)=>{if(this.roomState.peerStats[this.peerId]||t){this.beSilentOnLogs=e,this.isAutoBwStats=t;try{this.gatherRTCPeerConnectionDetails(),this.gatherSDPIceCandidates(),this.gatherSDPCodecs(),this.gatherRTCDataChannelDetails()}catch(e){Lt.log.WARN([this.peerId,it.STATS_MODULE,null,_t.STATS_MODULE.ERRORS.PARSE_FAILED],e)}"function"!=typeof this.peerConnection.getStats&&this.getStatsFailure(r,_t.PEER_CONNECTION.STATS_API_UNAVAILABLE),this.beSilentOnLogs||Dt(Yt({state:Ne.RETRIEVING,peerId:this.peerId})),this.peerConnection.getStats().then((e=>{this.getStatsSuccess(s,r,e)})).catch((e=>{e.message!==_t.STATS_MODULE.ERRORS.STATS_IS_NULL?this.getStatsFailure(r,null,e):Lt.log.WARN([this.peerId,it.STATS_MODULE,null,_t.STATS_MODULE.ERRORS.RETRIEVE_STATS_FAILED],e.message)}))}else Lt.log.WARN(n.NOT_INITIATED),s(null)}))}gatherRTCPeerConnectionDetails(){const{peerConnection:e}=this;this.output.connection.iceConnectionState=e.iceConnectionState,this.output.connection.iceGatheringState=e.iceGatheringState,this.output.connection.signalingState=e.signalingState,this.output.connection.remoteDescription={type:e.remoteDescription&&e.remoteDescription.type||"",sdp:e.remoteDescription&&e.remoteDescription.sdp||""},this.output.connection.localDescription={type:e.localDescription&&e.localDescription.type||"",sdp:e.localDescription&&e.localDescription.sdp||""},this.output.connection.constraints=this.peerConnection.constraints?this.peerConnection.constraints:null,this.output.connection.sdpConstraints=this.peerConnection.sdpConstraints?this.peerConnection.sdpConstraints:null}gatherSDPIceCandidates(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.connection.candidates={sending:Uo.getSDPICECandidates(this.peerId,e.localDescription,t),receiving:Uo.getSDPICECandidates(this.peerId,e.remoteDescription,t)}}gatherSDPCodecs(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.audio.sending.codec=Uo.getSDPSelectedCodec(this.peerId,e.remoteDescription,"audio",t),this.output.video.sending.codec=Uo.getSDPSelectedCodec(this.peerId,e.remoteDescription,"video",t),this.output.audio.receiving.codec=Uo.getSDPSelectedCodec(this.peerId,e.localDescription,"audio",t),this.output.video.receiving.codec=Uo.getSDPSelectedCodec(this.peerId,e.localDescription,"video",t)}gatherRTCDataChannelDetails(){const{dataChannel:e}=this;if(e){const t=Object.keys(e);this.output.connection.dataChannels={},t.forEach((t=>{const n=e[t];this.output.connection.dataChannels[n.channel.label]={label:n.channel.label,readyState:n.channel.readyState,channelType:ce["main"===t?"MESSAGING":"DATA"],currentTransferId:n.transferId||null,currentStreamId:n.streamId||null}}))}}},Ho=class{static addPeer(e){Ns(e)}static createOffer(...e){return _s(...e)}static createAnswer(...e){return hs(...e)}static createDataChannel(...e){return Cs(...e)}static sendP2PMessage(...e){return Ds(...e)}static getPeersInRoom(...e){return fs(...e)}static retrieveStatistics(e,t,n,s){return new Vo(e,t).getStatistics(n,s)}static signalingEndOfCandidates(...e){return Ms(...e)}static getConnectionStatus(e,t){return bs(e,t)}static getDataChannelBuffer(e){return Ps(e)}static refreshDataChannel(e,t){return ys(e,t)}static closeDataChannel(e,t){return vs(e,t)}static refreshConnection(e,t,n,s,r){return ks(e,t,n,s,r)}static refreshPeerConnection(e,t,n,s){return ws(e,t,n,s)}static buildPeerInformations(...e){return Ls(...e)}static closePeerConnection(e,t){return Gs(e,t)}static updatePeerInformationsMediaStatus(e,t,n,s){return Us(e,t,n,s)}},xo=(e,t,n,s=!1)=>{ns.prepStopStreams(e.id,t.id,s,!0).then((()=>Lt.log.DEBUG([n,it.MEDIA_STREAM,null,`${_t.MEDIA_STREAM.STOP_SCREEN_SUCCESS}`]))).catch((e=>Lt.log.DEBUG([n,it.MEDIA_STREAM,null,`${_t.MEDIA_STREAM.ERRORS.STOP_SCREEN}`],e)))},Wo=(e,t)=>{t.getTracks().forEach((n=>{n.onended=()=>xo(e.room,t,e.user.sid)}))},$o=e=>{const{peerMedias:t,user:n}=e,s={},r=Object.keys(t).filter((e=>e!==n.sid));for(let e=0;e<r.length;e+=1){const n=r[e];Object.values(t[n]).forEach((e=>{e.mediaType===at.VIDEO_SCREEN&&(s[n]=e.streamId)}))}return s},Ko=xo,jo=(e,t,n,s,r,o)=>{Eo.onStreamAccessSuccess(e,t,n,s,r,o)},Yo={},Jo=class{constructor(e){const{room:t}=e;if(Yo[t.id])return Yo[t.id];this.roomState=e,this.stream=null,this.signaling=new Fr,this.streamId=null,this.settings=null,Yo[t.id]=this}streamExists(){const e=Eo.getStreams(this.roomState,this.roomState.room.name),t=Object.keys(e.userMedia);for(let e=0;e<t.length;e+=1)if(t[e]===this.streamId)return!0;return!1}async start(e=null,t){this.streamId=e,this.settings=this.isValidOptions(t)?Eo.parseStreamSettings(t):Eo.parseStreamSettings(Bt.MEDIA_OPTIONS.SCREENSHARE);try{if(this.checkForExistingScreenStreams(),this.stream=await this.startScreenCapture(t),!this.stream)return this.deleteScreensharingInstance(this.roomState.room),null;jo(this.roomState.room.id,this.stream,null,this.settings,!1,!0),Wo(this.roomState,this.stream),this.addScreenshareStream()}catch(e){Lt.log.ERROR([this.roomState.user.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.ERRORS.START_SCREEN],e)}return this.stream}stop(e=!1){if(!this.stream)return Lt.log.DEBUG([this.roomState.user.sid,it.MEDIA_STREAM,null,`${_t.MEDIA_STREAM.ERRORS.STOP_SCREEN} - ${_t.MEDIA_STREAM.ERRORS.NO_STREAM}`]),null;try{Ko(this.roomState.room,this.stream,this.roomState.user.sid,e),this.streamId=null,this.stream=null}catch(e){Lt.log.ERROR([this.roomState.user.sid,it.MEDIA_STREAM,null,`${_t.MEDIA_STREAM.ERRORS.STOP_SCREEN}`],e)}return null}startScreenCapture(){const{navigator:e}=window,t=this.settings.getUserMediaSettings;return e.mediaDevices.getDisplayMedia?e.mediaDevices.getDisplayMedia(t).then((e=>e)).catch((e=>("NotAllowedError"===e.name?Lt.log.WARN(e):Lt.log.ERROR(e),null))):(t.video.mediaSource="screen",e.mediaDevices.getUserMedia(t).then((e=>e)).catch((e=>(Lt.log.ERROR(e),null))))}isValidOptions(e){return!!(e&&Io(e)&&e.video)||(e&&Lt.log.WARN([this.roomState.user.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.ERRORS.INVALID_GDM_OPTIONS],e),!1)}checkForExistingScreenStreams(){const e=$o(this.roomState);So(e)||Lt.log.WARN([this.roomState.user.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.ERRORS.PEER_SCREEN_ACTIVE])}addScreenshareStream(){const{peerConnections:e}=this.roomState;So(e)||Ho.refreshConnection(this.roomState).catch((e=>Lt.log.ERROR([this.roomState.user.sid,it.MEDIA_STREAM,null,_t.MEDIA_STREAM.ERRORS.START_SCREEN],e)))}deleteScreensharingInstance(e){delete Yo[e.id]}};let Qo=null;const Zo=class{constructor(){return Qo||(Qo=this),this.states={},Qo}setState(e){this.states[e.room.id]=e}getAllStates(){return this.states}getState(e){return this.states[e]}removeStateByRoomId(e){return delete this.states[e]}clearRoomStateFromSingletons(e){const t=this.getState(e);new Jo(t).deleteScreensharingInstance(t.room),yn.deleteAsyncInstance(t.room),fn.deleteEncryptedInstance(t.room),new zt(null,e).deleteApiResponseInstance(e)}},qo=(e,t,n,s=null,r=null)=>{const o=new cr;return Lt.log.ERROR(t),o.send(e.room.id,n,s,r,t),new Error(t)},Xo=(e,t)=>new Promise(((n,s)=>{const{hasMCU:r,currentRecordingId:o,recordingStartInterval:i}=e;let a=t?_t.RECORDING.START_FAILED:_t.RECORDING.STOP_FAILED;if(!r){a=`${a} - ${_t.RECORDING.ERRORS.MCU_NOT_CONNECTED}`;const n=t?_t.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_START:_t.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_STOP;s(qo(e,a,n,null,null))}t&&o&&s(qo(e,`${a} - ${_t.RECORDING.ERRORS.EXISTING_RECORDING_IN_PROGRESS}`,_t.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_START_ACTIVE,o,null)),t||o||s(qo(e,`${a} - ${_t.RECORDING.ERRORS.NO_RECORDING_IN_PROGRESS}`,_t.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_STOP_ACTIVE,o,null)),!t&&i&&s(qo(e,`${a} - ${_t.RECORDING.ERRORS.MIN_RECORDING_TIME}`,_t.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_MIN_STOP,o,null)),((e,t)=>{const n=s=>{const r=s.detail,o=t?je.START:je.STOP;r.state===o&&(Ct(At.RECORDING_STATE,n),e(r.recordingId))};Nt(At.RECORDING_STATE,n)})(n,t),((e,t,n=null)=>{const s=new Fr,r=new cr;s.recording(e.room.id,t?ze.START_RECORDING:ze.STOP_RECORDING),r.send(e.room.id,t?_t.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_START:_t.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_STOP,n,null,null)})(e,t,o)})),zo=class{static start(...e){return(e=>Xo(e,!0))(...e)}static stop(...e){return(e=>Xo(e,!1))(...e)}static getRecordings(e){const{recordings:t}=e;return Object.assign({},t)}},ei=(e,t,n=null,s=null)=>{const r={shouldProceed:!0,errorMessage:""},{hasMCU:o}=t;return o?e&&!n?(r.errorMessage=_t.RTMP.start_no_stream_id,r.shouldProceed=!1,r):e&&!s?(r.errorMessage=_t.RTMP.start_no_endpoint,r.shouldProceed=!1,r):r:(r.errorMessage=e?_t.RTMP.start_no_mcu:_t.RTMP.stop_no_mcu,r.shouldProceed=!1,r)},ti=(e,t)=>{const n=s=>{const r=s.detail,o=e?rt.START:rt.STOP;r.state===o&&(Ct(At.RTMP_STATE,n),t(r.rtmpId))};Nt(At.RTMP_STATE,n)},ni=(e,t,n,s=null,r=null)=>{const{room:o,user:i}=e,a=new Fr,d=t?ze.START_RTMP:ze.STOP_RTMP;a.rtmp(d,o.id,i.sid,n,s,r)},si=class{static startSession(e,t,n){return this.commonRTMPOperations(e,t,null,n,!0,_t.RTMP.starting_rtmp)}static stopSession(e,t){return this.commonRTMPOperations(e,null,t,null,!1,_t.RTMP.stopping_rtmp)}static logErrorAndReject(e,t){Lt.log.ERROR(e),t(e)}static commonRTMPOperations(e,t,n,s,r,o){return new Promise(((i,a)=>{try{const d=ei(r,e,t,s),l=n||Do();d.shouldProceed?(ti(r,i),ni(e,r,l,t,s),Lt.log.INFO([pt.MCU,"RTMP",o])):this.logErrorAndReject(new Error(d.errorMessage),a)}catch(e){this.logErrorAndReject(e,a)}}))}};window.AdapterJS=d,window.io=i();const ri=new Zo;let oi={},ii={};class ai extends class{async joinRoom(e={},t){return Jr.joinRoom(e,t)}sendP2PMessage(e="",t="",n=""){Ho.sendP2PMessage(e,t,n)}sendMessage(e="",t="",n=""){vn.sendMessage(e,t,n)}getStoredMessages(e){const t=No(e);t&&new yn(t).getStoredMessages()}getPeersInRoom(e){return Ao(e,"roomName","getPeersInRoom")?Ho.getPeersInRoom(e):null}getPeerInfo(e,t=null){const n=No(e);return t&&n?Xr.getPeerInfo(t,n.room):!t&&n?Xr.getCurrentSessionInfo(n.room):null}getUserData(e,t){const n=No(e);return n&&n.room?Xr.getUserData(n,t):null}setUserData(e,t){const n=No(e);return n&&n.room?Xr.setUserData(n.room,t):null}getConnectionStatus(e,t){const n=No(e);return Ho.getConnectionStatus(n,t)}getPeers(e,t=!1){const n=No(e);return n?class{static shouldProceed(e,t,n){let s=null;return e.isPrivileged||(s=_t.PEER_PRIVILEGED.not_privileged),t||(s=_t.PEER_PRIVILEGED.no_appkey),s&&(Lt.log.DEBUG(s),n(new Error(s))),!s}static getPeerList(e,t){return new Promise(((n,s)=>{try{const r=di.getSkylinkState(e.id),o=di.getInitOptions(),i=t||!1,a=e=>{const t=e.detail;t.state===ye.DISPATCHED&&(Ct(At.GET_PEERS_STATE_CHANGE,a),Dt(Kt({state:ye.RECEIVED,privilegePeerId:r.user.sid,peerList:t.peerList})),n(t.peerList))};this.shouldProceed(r,o.appKey,s)&&((new Fr).getPeerList(i),Dt(Kt({state:ye.ENQUIRED,privilegePeerId:r.user.sid,peerList:null})),Lt.log.INFO(_t.PEER_PRIVILEGED.getPeerListFromServer),Nt(At.GET_PEERS_STATE_CHANGE,a))}catch(e){Lt.log.ERROR(e),s(e)}}))}}.getPeerList(n.room,t):null}getPeersDataChannels(e){const t=No(e);return t?Xr.getPeersDataChannels(t):null}getPeersCustomSettings(e){const t=No(e);return t?Xr.getPeersCustomSettings(t):null}refreshDatachannel(e,t){const n=No(e);return n?Ho.refreshDataChannel(n,t):null}refreshConnection(e,t,n,s){const r=No(e);return Ho.refreshConnection(r,t,n,s)}shareScreen(e,t){const n=No(e);return n?new Jo(n).start(null,t):null}getUserMedia(e=null,t){if(!e)return fo(t);if(Oo(e)){const n=No(e);if(n)return rs.processUserMediaOptions(n,t)}else if(Io(e))return fo(e)}stopPrefetchedStream(e){return e&&(e.getTracks().forEach((e=>{e.stop()})),Dt(qn({room:null,peerId:null,peerInfo:null,isSelf:!0,isScreensharing:!1,streamId:e.id}))),null}stopScreen(e){const t=No(e);return t&&new Jo(t).stop(),null}stopStreams(e,t){const n=No(e);return n?rs.stopStreams(n,t):null}leaveRoom(e){const t=No(e);return t?Jr.leaveRoom(t):null}leaveAllRooms(){return Jr.leaveAllRooms()}startRecording(e){const t=No(e);return t?zo.start(t):null}stopRecording(e){const t=No(e);return t?zo.stop(t):null}lockRoom(e){const t=No(e);return t?Jr.lockRoom(t):null}unlockRoom(e){const t=No(e);return t?Jr.unlockRoom(t):null}getRecordings(e){const t=No(e);return t?zo.getRecordings(t):null}muteStreams(e,t={audioMuted:!0,videoMuted:!0},n){const s=No(e);return s?rs.muteStreams(s,t,n):null}startRTMPSession(e,t,n){const s=No(e);return s?si.startSession(s,t,n):null}stopRTMPSession(e,t){const n=No(e);return n?si.stopSession(n,t):null}getStreamSources(){return rs.getStreamSources()}sendStream(e,t){const n=No(e);return rs.sendStream(n,t)}getStreams(e,t=!0){const n=No(e);return n?rs.getStreams(n,t):null}generateUUID(){return Do()}setEncryptSecret(e="",t="",n=""){const s=No(e);return new fn(s).setEncryptSecret(t,n)}getEncryptSecrets(e=""){const t=No(e);return new fn(t).getEncryptSecrets()}deleteEncryptSecrets(e="",t=""){const n=No(e);return new fn(n).deleteEncryptSecrets(t)}setSelectedSecret(e="",t=""){const n=No(e);new fn(n).setSelectedSecretId(t)}getSelectedSecret(e,t){const n=No(e);return new fn(n).getSelectedSecretId(t)}setMessagePersistence(e,t){const n=No(e);return new yn(n).setMessagePersistence(t)}getMessagePersistence(e){const t=No(e);return new yn(t).getMessagePersistence()}}{constructor(e){super();const t=(new ln).init(e);ai.setInitOptions(t)}static getSkylinkState(e=null){return e?ri.getState(e):ri.getAllStates()}static setSkylinkState(e,t){t&&ri.setState(e)}static removeSkylinkState(e){if(e)return ri.removeStateByRoomId(e)}static clearRoomStateFromSingletons(e){if(e)return ri.clearRoomStateFromSingletons(e)}static getInitOptions(){return oi}static setInitOptions(e){oi=e}static setUserInitOptions(e){ii=e}static getUserInitOptions(){return ii}}const di=ai}}]);